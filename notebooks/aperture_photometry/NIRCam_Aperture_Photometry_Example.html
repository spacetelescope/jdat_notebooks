<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Point Source Aperture Photometry — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html" rel="next" title="Extended Aperture Photometry"/>
  <link href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html" rel="prev" title="LRS Optimal Spectral Extraction"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../preimaging/preimaging_01_mirage.html">
            NIRCam Preimaging: MIRAGE Simulations
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../preimaging/preimaging_02_calwebb.html">
            Preimaging - Pipeline Stages 1, 2
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../preimaging/preimaging_03_association.html">
            NIRCam Preimaging: Pipeline Stage 3
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00.%20Optimal%20extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01.%20Combine%20and%20normalize%201D%20spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02.%20Cross%20correlation%20template.html">
            Part 2: Cross Correlation to Determine Redshift of NIRISS WFSS Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03.%20Spatially%20resolved%20emission%20line%20map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../niriss_ami_binary/1_niriss_ami_binary.html">
            AMI - MIRAGE
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../niriss_ami_binary/2_niriss_ami_binary.html">
            AMI - Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
            SOSS Transit Spectroscopy
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Modeling
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction_dynamic/Spectral%20Extraction.html">
            NIRSpec MOS Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/aperture_photometry/NIRCam_Aperture_Photometry_Example.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/aperture_photometry/NIRCam_Aperture_Photometry_Example.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#import-functions">
           Import Functions
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#import-plotting-functions">
           Import Plotting Functions
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#load-images-and-create-some-useful-dictionaries">
           Load Images and create some useful dictionaries
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#select-the-detectors-and-or-filters-for-the-analysis">
           Select the detectors and/or filters for the analysis
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#display-the-images">
           Display the images
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#aperture-photometry">
           Aperture Photometry
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#finding-sources">
             1. Finding sources
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id1">
             2. Aperture Photometry
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#table-with-magnitudes-and-positions">
             3. Table with magnitudes and positions
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#matched-sources-table">
             Matched sources Table
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#instrumental-color-magnitude-diagram-and-errors">
           Instrumental Color-Magnitude Diagram and Errors
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#photometric-zeropoints">
           Photometric Zeropoints
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-aperture-correction-table">
             Load aperture correction table
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#a-subsample-using-the-cmd-as-a-reference">
             1a. Subsample using the CMD as a reference
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#aperture-photometry-on-the-bright-isolated-stars">
             Aperture Photometry on the bright isolated stars
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#derive-zeropoints">
             Derive Zeropoints
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#import-input-catalog">
           Import Input catalog
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#calibrated-color-magnitude-diagram">
           Calibrated Color-Magnitude Diagram
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#comparison-between-input-and-output-photometry">
           Comparison between input and output photometry
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#about-this-notebook">
           About this Notebook
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Point Source Aperture Photometry
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#import-functions">
              Import Functions
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#import-plotting-functions">
              Import Plotting Functions
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#load-images-and-create-some-useful-dictionaries">
              Load Images and create some useful dictionaries
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#select-the-detectors-and-or-filters-for-the-analysis">
              Select the detectors and/or filters for the analysis
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#display-the-images">
              Display the images
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#aperture-photometry">
              Aperture Photometry
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#finding-sources">
                1. Finding sources
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id1">
                2. Aperture Photometry
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#table-with-magnitudes-and-positions">
                3. Table with magnitudes and positions
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#matched-sources-table">
                Matched sources Table
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#instrumental-color-magnitude-diagram-and-errors">
              Instrumental Color-Magnitude Diagram and Errors
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#photometric-zeropoints">
              Photometric Zeropoints
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#load-aperture-correction-table">
                Load aperture correction table
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#a-subsample-using-the-cmd-as-a-reference">
                1a. Subsample using the CMD as a reference
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#aperture-photometry-on-the-bright-isolated-stars">
                Aperture Photometry on the bright isolated stars
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#derive-zeropoints">
                Derive Zeropoints
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#import-input-catalog">
              Import Input catalog
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#calibrated-color-magnitude-diagram">
              Calibrated Color-Magnitude Diagram
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#comparison-between-input-and-output-photometry">
              Comparison between input and output photometry
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#about-this-notebook">
              About this Notebook
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="point-source-aperture-photometry">
          <h1>
           Point Source Aperture Photometry
           <a class="headerlink" href="#point-source-aperture-photometry" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           Photometry, cross-match catalogs, derive and apply photometric zeropoint.
           <br/>
           <strong>
            Data:
           </strong>
           NIRCam simulated images obtained using
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">
            MIRAGE
           </a>
           and run through the
           <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/">
            JWST pipeline
           </a>
           of the Large Magellanic Cloud (LMC) Astrometric Calibration Field. Simulations is obtained using a 4-pt subpixel dither for three couples of wide filters: F070W, F115W, and F200W for the SW channel, and F277W, F356W, and F444W for the LW channel. We simulated only 1 NIRCam SW detector (i.e., “NRCB1”). For this example, we use Level-3 images (calibrated and rectified) for two SW filters (i.e., F115W and F200W) and derive the aperture photometry in each one of them. The images for the other filters are also available and can be used to test the notebook and/or different filters combination.
           <br/>
           <strong>
            Tools:
           </strong>
           astropy, photutils.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           NIRSpec, NIRISS, MIRI.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <p>
           Final plots show:
          </p>
          <ul class="simple">
           <li>
            <p>
             Instrumental Color-Magnitude Diagrams and errors
            </p>
           </li>
           <li>
            <p>
             Magnitudes Zeropoints
            </p>
           </li>
           <li>
            <p>
             Calibrated Color-Magnitude Diagram (compared with Input Color-Magnitude Diagram)
            </p>
           </li>
           <li>
            <p>
             Comparison between input and output photometry
            </p>
           </li>
          </ul>
          <section id="import-functions">
           <h2>
            Import Functions
            <a class="headerlink" href="#import-functions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">glob</span> <span class="k">as</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">tarfile</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="kn">import</span> <span class="nn">jwst</span>
<span class="kn">from</span> <span class="nn">jwst.datamodels</span> <span class="kn">import</span> <span class="n">ImageModel</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ZScaleInterval</span><span class="p">,</span> <span class="n">SqrtStretch</span><span class="p">,</span> <span class="n">ImageNormalize</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">simple_norm</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

<span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">MMMBackground</span><span class="p">,</span> <span class="n">MADStdBackgroundRMS</span><span class="p">,</span> <span class="n">Background2D</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">aperture_photometry</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="import-plotting-functions">
           <h2>
            Import Plotting Functions
            <a class="headerlink" href="#import-plotting-functions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">style</span><span class="p">,</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.cmap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'viridis'</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.origin'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'lower'</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'axes.titlesize'</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'axes.labelsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'xtick.labelsize'</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'ytick.labelsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">font1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'family'</span><span class="p">:</span> <span class="s1">'helvetica'</span><span class="p">,</span> <span class="s1">'color'</span><span class="p">:</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">:</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'size'</span><span class="p">:</span> <span class="s1">'12'</span><span class="p">}</span>
<span class="n">font2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'family'</span><span class="p">:</span> <span class="s1">'helvetica'</span><span class="p">,</span> <span class="s1">'color'</span><span class="p">:</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">:</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'size'</span><span class="p">:</span> <span class="s1">'20'</span><span class="p">}</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="load-images-and-create-some-useful-dictionaries">
           <h2>
            Load Images and create some useful dictionaries
            <a class="headerlink" href="#load-images-and-create-some-useful-dictionaries" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We load all the images and we create a dictionary that contains all of them, divided by detectors and filters. This is useful to check which detectors and filters are available and to decide if we want to perform the photometry on all of them or only on a subset (for example, only on the SW filters).
           </p>
           <p>
            We also create a dictionary with some useful parameters for the analysis. The dictionary contains the photometric zeropoints (from
            <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">
             MIRAGE
            </a>
            configuration files) and the NIRCam point spread function (PSF) FWHM, from the
            <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions">
             NIRCam Point Spread Function
            </a>
            JDox page. The FWHM are calculated from the analysis of the expected NIRCam PSFs simulated with
            <a class="reference external" href="https://www.stsci.edu/jwst/science-planning/proposal-planning-toolbox/psf-simulation-tool">
             WebbPSF
            </a>
            .
           </p>
           <p>
            <strong>
             Note
            </strong>
            : this dictionary will be updated once the values for zeropoints and FWHM will be available for each detectors/filters after commissioning.
           </p>
           <p>
            Hence, we have two dictionaries:
           </p>
           <ul class="simple">
            <li>
             <p>
              dictionary for the Level-3 images
             </p>
            </li>
            <li>
             <p>
              dictionary with some other useful parameters
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_images</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'NRCA1'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA2'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA3'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA4'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA5'</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s1">'NRCB1'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB2'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB3'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB4'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB5'</span><span class="p">:</span> <span class="p">{}}</span>

<span class="n">dict_filter_short</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dict_filter_long</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">ff_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ff_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_long</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./*combined*fits'</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading images"</span><span class="p">)</span>

    <span class="n">boxlink_images_lev3</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/images_level3.tar.gz'</span>
    <span class="n">boxfile_images_lev3</span> <span class="o">=</span> <span class="s1">'./images_level3.tar.gz'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_images_lev3</span><span class="p">,</span> <span class="n">boxfile_images_lev3</span><span class="p">)</span>

    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_images_lev3</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>

    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">"*combined*fits"</span><span class="p">)))</span>

<span class="k">else</span><span class="p">:</span>

    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">"*combined*fits"</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'FILTER'</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'DETECTOR'</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">'NRCBLONG'</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">'NRCB5'</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">'NRCALONG'</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">'NRCA5'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span>

    <span class="n">wv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">wv</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">ff_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">det_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ff_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">det_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="n">detlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_short</span><span class="p">)))</span>
    <span class="n">detlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_long</span><span class="p">)))</span>

    <span class="n">unique_list_filters_short</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unique_list_filters_long</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_short</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_short</span><span class="p">:</span>

            <span class="n">dict_filter_short</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_long</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_long</span><span class="p">:</span>
            <span class="n">dict_filter_long</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">d_s</span> <span class="ow">in</span> <span class="n">detlist_short</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_short</span>

    <span class="k">for</span> <span class="n">d_l</span> <span class="ow">in</span> <span class="n">detlist_long</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_long</span>

    <span class="n">filtlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_short</span><span class="p">)))</span>
    <span class="n">filtlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_long</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'images'</span><span class="p">:</span> <span class="p">[</span><span class="n">image</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Available Detectors for SW channel:"</span><span class="p">,</span> <span class="n">detlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available Detectors for LW channel:"</span><span class="p">,</span> <span class="n">detlist_long</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available SW Filters:"</span><span class="p">,</span> <span class="n">filtlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available LW Filters:"</span><span class="p">,</span> <span class="n">filtlist_long</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Downloading images
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Available Detectors for SW channel: ['NRCB1']
Available Detectors for LW channel: ['NRCB5']
Available SW Filters: ['F070W', 'F115W', 'F200W']
Available LW Filters: ['F277W', 'F356W', 'F444W']
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>/tmp/ipykernel_2528/207740193.py:48: DeprecationWarning: `np.float` is a deprecated alias for the builtin `float`. To silence this warning, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  wv = np.float(f[1:3])
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'F070W'</span><span class="p">,</span> <span class="s1">'F090W'</span><span class="p">,</span> <span class="s1">'F115W'</span><span class="p">,</span> <span class="s1">'F140M'</span><span class="p">,</span> <span class="s1">'F150W2'</span><span class="p">,</span> <span class="s1">'F150W'</span><span class="p">,</span> <span class="s1">'F162M'</span><span class="p">,</span> <span class="s1">'F164N'</span><span class="p">,</span> <span class="s1">'F182M'</span><span class="p">,</span>
           <span class="s1">'F187N'</span><span class="p">,</span> <span class="s1">'F200W'</span><span class="p">,</span> <span class="s1">'F210M'</span><span class="p">,</span> <span class="s1">'F212N'</span><span class="p">,</span> <span class="s1">'F250M'</span><span class="p">,</span> <span class="s1">'F277W'</span><span class="p">,</span> <span class="s1">'F300M'</span><span class="p">,</span> <span class="s1">'F322W2'</span><span class="p">,</span> <span class="s1">'F323N'</span><span class="p">,</span>
           <span class="s1">'F335M'</span><span class="p">,</span> <span class="s1">'F356W'</span><span class="p">,</span> <span class="s1">'F360M'</span><span class="p">,</span> <span class="s1">'F405N'</span><span class="p">,</span> <span class="s1">'F410M'</span><span class="p">,</span> <span class="s1">'F430M'</span><span class="p">,</span> <span class="s1">'F444W'</span><span class="p">,</span> <span class="s1">'F460M'</span><span class="p">,</span> <span class="s1">'F466N'</span><span class="p">,</span> <span class="s1">'F470N'</span><span class="p">,</span> <span class="s1">'F480M'</span><span class="p">]</span>

<span class="n">psf_fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.987</span><span class="p">,</span> <span class="mf">1.103</span><span class="p">,</span> <span class="mf">1.298</span><span class="p">,</span> <span class="mf">1.553</span><span class="p">,</span> <span class="mf">1.628</span><span class="p">,</span> <span class="mf">1.770</span><span class="p">,</span> <span class="mf">1.801</span><span class="p">,</span> <span class="mf">1.494</span><span class="p">,</span> <span class="mf">1.990</span><span class="p">,</span> <span class="mf">2.060</span><span class="p">,</span> <span class="mf">2.141</span><span class="p">,</span> <span class="mf">2.304</span><span class="p">,</span> <span class="mf">2.341</span><span class="p">,</span> <span class="mf">1.340</span><span class="p">,</span>
            <span class="mf">1.444</span><span class="p">,</span> <span class="mf">1.585</span><span class="p">,</span> <span class="mf">1.547</span><span class="p">,</span> <span class="mf">1.711</span><span class="p">,</span> <span class="mf">1.760</span><span class="p">,</span> <span class="mf">1.830</span><span class="p">,</span> <span class="mf">1.901</span><span class="p">,</span> <span class="mf">2.165</span><span class="p">,</span> <span class="mf">2.179</span><span class="p">,</span> <span class="mf">2.300</span><span class="p">,</span> <span class="mf">2.302</span><span class="p">,</span> <span class="mf">2.459</span><span class="p">,</span> <span class="mf">2.507</span><span class="p">,</span> <span class="mf">2.535</span><span class="p">,</span> <span class="mf">2.574</span><span class="p">]</span>

<span class="n">zp_modA</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7977</span><span class="p">,</span> <span class="mf">25.9686</span><span class="p">,</span> <span class="mf">25.8419</span><span class="p">,</span> <span class="mf">24.8878</span><span class="p">,</span> <span class="mf">27.0048</span><span class="p">,</span> <span class="mf">25.6536</span><span class="p">,</span> <span class="mf">24.6957</span><span class="p">,</span> <span class="mf">22.3073</span><span class="p">,</span> <span class="mf">24.8258</span><span class="p">,</span> <span class="mf">22.1775</span><span class="p">,</span> <span class="mf">25.3677</span><span class="p">,</span> <span class="mf">24.3296</span><span class="p">,</span>
           <span class="mf">22.1036</span><span class="p">,</span> <span class="mf">22.7850</span><span class="p">,</span> <span class="mf">23.5964</span><span class="p">,</span> <span class="mf">24.8239</span><span class="p">,</span> <span class="mf">23.6452</span><span class="p">,</span> <span class="mf">25.3648</span><span class="p">,</span> <span class="mf">20.8604</span><span class="p">,</span> <span class="mf">23.5873</span><span class="p">,</span> <span class="mf">24.3778</span><span class="p">,</span> <span class="mf">23.4778</span><span class="p">,</span> <span class="mf">20.5588</span><span class="p">,</span>
           <span class="mf">23.2749</span><span class="p">,</span> <span class="mf">22.3584</span><span class="p">,</span> <span class="mf">23.9731</span><span class="p">,</span> <span class="mf">21.9502</span><span class="p">,</span> <span class="mf">20.0428</span><span class="p">,</span> <span class="mf">19.8869</span><span class="p">,</span> <span class="mf">21.9002</span><span class="p">]</span>

<span class="n">zp_modB</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7568</span><span class="p">,</span> <span class="mf">25.9771</span><span class="p">,</span> <span class="mf">25.8041</span><span class="p">,</span> <span class="mf">24.8738</span><span class="p">,</span> <span class="mf">26.9821</span><span class="p">,</span> <span class="mf">25.6279</span><span class="p">,</span> <span class="mf">24.6767</span><span class="p">,</span> <span class="mf">22.2903</span><span class="p">,</span> <span class="mf">24.8042</span><span class="p">,</span> <span class="mf">22.1499</span><span class="p">,</span> <span class="mf">25.3391</span><span class="p">,</span> <span class="mf">24.2909</span><span class="p">,</span>
           <span class="mf">22.0574</span><span class="p">,</span> <span class="mf">22.7596</span><span class="p">,</span> <span class="mf">23.5011</span><span class="p">,</span> <span class="mf">24.6792</span><span class="p">,</span> <span class="mf">23.5769</span><span class="p">,</span> <span class="mf">25.3455</span><span class="p">,</span> <span class="mf">20.8631</span><span class="p">,</span> <span class="mf">23.4885</span><span class="p">,</span> <span class="mf">24.3883</span><span class="p">,</span> <span class="mf">23.4555</span><span class="p">,</span> <span class="mf">20.7007</span><span class="p">,</span>
           <span class="mf">23.2763</span><span class="p">,</span> <span class="mf">22.4677</span><span class="p">,</span> <span class="mf">24.1562</span><span class="p">,</span> <span class="mf">22.0422</span><span class="p">,</span> <span class="mf">20.1430</span><span class="p">,</span> <span class="mf">20.0173</span><span class="p">,</span> <span class="mf">22.4086</span><span class="p">]</span>

<span class="n">dict_utils</span> <span class="o">=</span> <span class="p">{</span><span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="p">{</span><span class="s1">'psf fwhm'</span><span class="p">:</span> <span class="n">psf_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">'VegaMAG zp modA'</span><span class="p">:</span> <span class="n">zp_modA</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                           <span class="s1">'VegaMAG zp modB'</span><span class="p">:</span> <span class="n">zp_modB</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">))}</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="select-the-detectors-and-or-filters-for-the-analysis">
           <h2>
            Select the detectors and/or filters for the analysis
            <a class="headerlink" href="#select-the-detectors-and-or-filters-for-the-analysis" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            If we are interested only in some filters (and/or some detectors) in the analysis, as in this example, we can select the images from the dictionary for those filters (detectors) and analyze only those images.
           </p>
           <p>
            In this particular example, we analyze images for filters
            <strong>
             F115W
            </strong>
            and
            <strong>
             F200W
            </strong>
            for the detector
            <strong>
             NRCB1
            </strong>
            .
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dets_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">]</span>  <span class="c1"># detector of interest in this example</span>
<span class="n">filts_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'F115W'</span><span class="p">,</span> <span class="s1">'F200W'</span><span class="p">]</span>  <span class="c1"># filters of interest in this example</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="display-the-images">
           <h2>
            Display the images
            <a class="headerlink" href="#display-the-images" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            To check that our images do not present artifacts and can be used in the analysis, we display them.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"X [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Y [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">'sqrt'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>findfont: Font family ['helvetica'] not found. Falling back to DejaVu Sans.
</pre>
              </div>
             </div>
             <img alt="../../_images/NIRCam_Aperture_Photometry_Example_11_1.png" src="../../_images/NIRCam_Aperture_Photometry_Example_11_1.png"/>
            </div>
           </div>
          </section>
          <section id="aperture-photometry">
           <h2>
            Aperture Photometry
            <a class="headerlink" href="#aperture-photometry" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            More information on aperture photometry using Photutils can be found here:
            <a class="reference external" href="https://photutils.readthedocs.io/en/stable/aperture.html">
             Aperture Photometry
            </a>
           </p>
           <p>
            First, we create a useful dictionary that contains: the sources detected using our finding algorithm (
            <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html#photutils.detection.DAOStarFinder">
             DAOStarFinder
            </a>
            ), the table with the aperture photometry results, and a final table with positions (both x,y and RA,Dec) instrumental magnitudes ad errors for the detected sources.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_aper</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="n">dict_aper</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="finding-sources">
            <h3>
             1. Finding sources
             <a class="headerlink" href="#finding-sources" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html#photutils.detection.DAOStarFinder">
              DAOStarFinder
             </a>
             detects stars in an image using the DAOFIND (
             <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1987PASP...99..191S/abstract">
              Stetson 1987
             </a>
             ) algorithm. DAOFIND searches images for local density maxima that have a peak amplitude greater than
             <code class="docutils literal notranslate">
              <span class="pre">
               threshold
              </span>
             </code>
             (approximately; threshold is applied to a convolved image) and have a size and shape similar to the defined 2D Gaussian kernel.
            </p>
            <p>
             <strong>
              Note
             </strong>
             : we adopted as Background estimator the function
             <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.background.MMMBackground.html#photutils.background.MMMBackground">
              MMMBackground
             </a>
             , which calculates the background in an array using the DAOPHOT MMM algorithm, on the whole image.
            </p>
            <p>
             When dealing with a variable background and/or the need to mask the regions where we have no data (for example, if we are analyzing an image with all the 4 NIRCam SW detectors, i.e. containing the chip gaps), we can set
             <code class="docutils literal notranslate">
              <span class="pre">
               var_bkg
              </span>
             </code>
             = True and use a more complex algorithm that takes into account those issues.
            </p>
            <p>
             Note that the unit of the Level-2 and Level-3 Images from the pipeline is MJy/sr (hence a surface brightness). The actual unit of the image can be checked from the header keyword
             <strong>
              BUNIT
             </strong>
             . The scalar conversion constant is copied to the header keyword
             <strong>
              PHOTMJSR
             </strong>
             , which gives the conversion from DN/s to megaJy/steradian. For our analysis we revert back to DN/s.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">find_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">'NRCA1'</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">'F070W'</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Finding sources on image </span><span class="si">{number}</span><span class="s2">, filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Conversion factor from </span><span class="si">{units}</span><span class="s2"> to DN/S for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">imh</span><span class="p">[</span><span class="s1">'BUNIT'</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">])</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf fwhm'</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"FWHM for the filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">sigma_psf</span><span class="p">,</span> <span class="s2">"px"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var_bkg</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Using 2D Background"</span><span class="p">)</span>
        <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">coverage_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span> <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span>
                           <span class="n">coverage_mask</span><span class="o">=</span><span class="n">coverage_mask</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data_bkgsub</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>

    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

    <span class="n">found_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>
    <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">]</span> <span class="o">=</span> <span class="n">found_stars</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of sources found in the image:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_stars</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"-------------------------------------"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># threshold level for the two filters (length must match number of filters analyzed)</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">find_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Elapsed Time for finding stars:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Finding sources on image 1, filter F115W, detector NRCB1:

Conversion factor from MJy/sr to DN/S for filter F115W: 3.821892261505127
FWHM for the filter F115W: 1.298 px
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Number of sources found in the image: 11036
-------------------------------------

Finding sources on image 1, filter F200W, detector NRCB1:

Conversion factor from MJy/sr to DN/S for filter F200W: 2.564082860946655
FWHM for the filter F200W: 2.141 px
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Number of sources found in the image: 12016
-------------------------------------

Elapsed Time for finding stars: 6.035259098000097
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="id1">
            <h3>
             2. Aperture Photometry
             <a class="headerlink" href="#id1" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             In the function below that allows to perform aperture photometry, we need to specify 4 parameters: the filter (i.e., image) used in the analysis, the aperture radius and the inner and outer radii for the annulus used to determine the local background. Values for the aperture radius and the annulii depend on the adopted filter and the user science case.
            </p>
            <p>
             Note that Aperture object support multiple positions, allowing to perform photometry in
             <a class="reference external" href="https://photutils.readthedocs.io/en/latest/aperture.html#multiple-apertures-at-each-position">
              multiple apertures
             </a>
             at each position. For multiple apertures, the output table column names are appended with the positions index.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mf">3.5</span><span class="p">],</span> <span class="n">sky_in</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sky_out</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">],</span>
                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]))</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">table_aper</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">radius</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing aperture photometry for filter </span><span class="si">{1}</span><span class="s2">; radius r = </span><span class="si">{0}</span><span class="s2"> px"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">filt</span><span class="p">))</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">sky_in</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="n">sky_out</span><span class="p">)</span>
        <span class="n">annulus_mask</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'center'</span><span class="p">)</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bkg_stdev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">annulus_mask</span><span class="p">:</span>
            <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">)</span>
            <span class="n">bkg_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>
            <span class="n">bkg_stdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdev_sigclip</span><span class="p">)</span>
        <span class="n">bkg_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_median</span><span class="p">)</span>
        <span class="n">bkg_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_stdev</span><span class="p">)</span>

        <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'exact'</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">'annulus_median'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">]</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_'</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">)</span>
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'annulus_median'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'annulus_median_'</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">)</span>
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_bkg_'</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">)</span>
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_bkgsub_'</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">)</span>

        <span class="n">error_poisson</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aperture_sum_err'</span><span class="p">]</span>
        <span class="n">error_scatter_sky</span> <span class="o">=</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="n">bkg_stdev</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">error_mean_sky</span> <span class="o">=</span> <span class="n">bkg_stdev</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">area</span>

        <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_poisson</span> <span class="o">+</span> <span class="n">error_scatter_sky</span> <span class="o">+</span> <span class="n">error_mean_sky</span><span class="p">)</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">fluxerr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'flux_err_'</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">)</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_aper</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Time Elapsed:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>

    <span class="k">return</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">det</span> <span class="o">=</span> <span class="s1">'NRCB1'</span>
<span class="n">filt1</span> <span class="o">=</span> <span class="s1">'F115W'</span>
<span class="n">filt2</span> <span class="o">=</span> <span class="s1">'F200W'</span>

<span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mf">3.5</span><span class="p">],</span> <span class="n">sky_in</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sky_out</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mf">4.0</span><span class="p">],</span> <span class="n">sky_in</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sky_out</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Performing aperture photometry for filter F115W; radius r = 3.5 px
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/tmp/ipykernel_2528/211919994.py:23: DeprecationWarning: `np.str` is a deprecated alias for the builtin `str`. To silence this warning, use `str` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.str_` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  rr = np.str(rad)
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Time Elapsed: 3.193816780000134
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Performing aperture photometry for filter F200W; radius r = 4.0 px
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/tmp/ipykernel_2528/211919994.py:23: DeprecationWarning: `np.str` is a deprecated alias for the builtin `str`. To silence this warning, use `str` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.str_` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  rr = np.str(rad)
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Time Elapsed: 3.284084331000031
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="table-with-magnitudes-and-positions">
            <h3>
             3. Table with magnitudes and positions
             <a class="headerlink" href="#table-with-magnitudes-and-positions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We create the final tables containing positions, magnitudes and errors for each catalog
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

            <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_bkgsub_'</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">table_phot</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

            <span class="n">table_phot</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">table_phot</span><span class="p">[</span><span class="s1">'x'</span><span class="p">],</span> <span class="n">table_phot</span><span class="p">[</span><span class="s1">'y'</span><span class="p">])</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_bkgsub_'</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'flux_err_'</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span>
                                                        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_bkgsub_'</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_phot</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/tmp/ipykernel_2528/1283306049.py:7: DeprecationWarning: `np.str` is a deprecated alias for the builtin `str`. To silence this warning, use `str` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.str_` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  radius = np.str(radii[j])
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.extensions plugin from package asdf-astropy==0.2.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'), {'asdf'})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.extensions plugin from package gwcs==0.18.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'), {'asdf'})
  warnings.warn(
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.extensions plugin from package jwst==1.5.2 failed to load:

VersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'))
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package jwst==1.5.2 failed to load:

VersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'))
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package specutils==1.7.0 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'), {'asdf'})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package stpipe==0.3.3 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'), {'asdf'})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package asdf==2.12.0 failed to load:

VersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'))
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf-astropy==0.2.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'), {'asdf'})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf-coordinates-schemas==0.1.0 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'), {'asdf'})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf-wcs-schemas==0.1.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'), {'asdf'})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package jwst==1.5.2 failed to load:

VersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'))
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf==2.12.0 failed to load:

VersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse('jsonschema&gt;=4.0.1'))
  warnings.warn(
</pre>
               </div>
              </div>
              <div class="output traceback highlight-ipythontb notranslate">
               <div class="highlight">
                <pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">Input In [12],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="ne">---&gt; </span><span class="mi">12</span> <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>         <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span>         <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>         <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>         <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_bkgsub_'</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="n">table_phot</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/stdatamodels/model_base.py:174,</span> in <span class="ni">DataModel.__init__</span><span class="nt">(self, init, schema, memmap, pass_invalid_values, strict_validation, validate_on_assignment, cast_fits_arrays, validate_arrays, ignore_missing_extensions, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">171</span>         <span class="n">schema</span> <span class="o">=</span> <span class="n">_DEFAULT_SCHEMA</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">173</span>         <span class="c1"># Create an AsdfFile so we can use its resolver for loading schemas</span>
<span class="ne">--&gt; </span><span class="mi">174</span>         <span class="n">schema</span> <span class="o">=</span> <span class="n">asdf_schema</span><span class="o">.</span><span class="n">load_schema</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_url</span><span class="p">,</span> <span class="n">resolve_references</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">mschema</span><span class="o">.</span><span class="n">merge_property_trees</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span> <span class="c1"># Provide the object as context to other classes and functions</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:435,</span> in <span class="ni">load_schema</span><span class="nt">(url, resolver, resolve_references, resolve_local_refs)</span>
<span class="g g-Whitespace">    </span><span class="mi">430</span>     <span class="n">resolver</span> <span class="o">=</span> <span class="n">extension</span><span class="o">.</span><span class="n">get_default_resolver</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span> <span class="c1"># We want to cache the work that went into constructing the schema, but returning</span>
<span class="g g-Whitespace">    </span><span class="mi">433</span> <span class="c1"># the same object is treacherous, because users who mutate the result will not</span>
<span class="g g-Whitespace">    </span><span class="mi">434</span> <span class="c1"># expect that they're changing the schema everywhere.</span>
<span class="ne">--&gt; </span><span class="mi">435</span> <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_load_schema_cached</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">resolve_references</span><span class="p">,</span> <span class="n">resolve_local_refs</span><span class="p">))</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:482,</span> in <span class="ni">_load_schema_cached</span><span class="nt">(url, resolver, resolve_references, resolve_local_refs)</span>
<span class="g g-Whitespace">    </span><span class="mi">479</span> <span class="nd">@lru_cache</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">480</span> <span class="k">def</span> <span class="nf">_load_schema_cached</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">resolve_references</span><span class="p">,</span> <span class="n">resolve_local_refs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">481</span>     <span class="n">loader</span> <span class="o">=</span> <span class="n">_make_schema_loader</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">482</span>     <span class="n">schema</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">loader</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">484</span>     <span class="k">if</span> <span class="n">resolve_references</span> <span class="ow">or</span> <span class="n">resolve_local_refs</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">486</span>         <span class="k">def</span> <span class="nf">resolve_refs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">json_id</span><span class="p">):</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:359,</span> in <span class="ni">_make_schema_loader.&lt;locals&gt;.load_schema</span><span class="nt">(url)</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>     <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">url</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span> <span class="c1"># If not, this must be a URL (or missing).  Fall back to fetching</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span> <span class="c1"># the schema the old way:</span>
<span class="ne">--&gt; </span><span class="mi">359</span> <span class="k">return</span> <span class="n">_load_schema</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:323,</span> in <span class="ni">_load_schema</span><span class="nt">(url)</span>
<span class="g g-Whitespace">    </span><span class="mi">320</span> <span class="nd">@lru_cache</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">321</span> <span class="k">def</span> <span class="nf">_load_schema</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">322</span>     <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"http://"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"https://"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"asdf://"</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">323</span>         <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">"Unable to fetch schema from non-file URL: "</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span>     <span class="k">with</span> <span class="n">generic_io</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"json"</span><span class="p">):</span>

<span class="ne">FileNotFoundError</span>: Unable to fetch schema from non-file URL: http://stsci.edu/schemas/jwst_datamodel/image.schema
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="matched-sources-table">
            <h3>
             Matched sources Table
             <a class="headerlink" href="#matched-sources-table" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We cross-match the catalogs to obtain the single color-magnitude diagram.
            </p>
            <p>
             Stars from the two filters are associated if the distance between the matches is &lt; 0.5 px.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">max_sep</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>

<span class="n">idx_inst</span><span class="p">,</span> <span class="n">d2d_inst</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">],</span>
                                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">])</span>

<span class="n">sep_constraint_inst</span> <span class="o">=</span> <span class="n">d2d_inst</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">matched_sources</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

<span class="n">matched_sources</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'x'</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'y'</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'x'</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'y'</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="instrumental-color-magnitude-diagram-and-errors">
           <h2>
            Instrumental Color-Magnitude Diagram and Errors
            <a class="headerlink" href="#instrumental-color-magnitude-diagram-and-errors" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            In the error plots, the grey dots represent measures all the detections in each filter, whereas the black dots represent the detections matched between the two catalogs.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst -'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">-</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\sigma$ '</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">11</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span>
            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\sigma$ '</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span>
            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="photometric-zeropoints">
           <h2>
            Photometric Zeropoints
            <a class="headerlink" href="#photometric-zeropoints" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            To obtain the final calibrated color-magnitude diagram, we need to calculate the photometric zeropoints. Hence we need to perform aperture photometry on the images using an aperture radius correspondent to a value of the encircled energy (EE), apply the appropriate aperture correction for the finite aperture adopted (the values provided in the dictionary above are for an infinite aperture) and then compare it with the aperture photometry determined above. Hence, we can summarize the steps as follows:
           </p>
           <ul class="simple">
            <li>
             <p>
              perform aperture photometry using an appropriate radius (equivalent to a certain value of the EE)
             </p>
            </li>
            <li>
             <p>
              apply appropriate aperture correction
             </p>
            </li>
            <li>
             <p>
              apply tabulated zeropoint
             </p>
            </li>
            <li>
             <p>
              cross-match with aperture photometry
             </p>
            </li>
           </ul>
           <p>
            <strong>
             Note
            </strong>
            : to select the stars for the zeropoint calculation, we can select a subsample using the CMD as a reference, or perform aperture photometry on a sample of bright isolated stars. To change the method used we can set
            <code class="docutils literal notranslate">
             <span class="pre">
              sample
             </span>
            </code>
            = cmd or
            <code class="docutils literal notranslate">
             <span class="pre">
              sample
             </span>
            </code>
            = found, respectively.
           </p>
           <section id="load-aperture-correction-table">
            <h3>
             Load aperture correction table
             <a class="headerlink" href="#load-aperture-correction-table" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <strong>
              Note
             </strong>
             : these values are obtained from the study of the synthetic WebbPSF PSFs. They will be updated once we have in-flight measures.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">'./aperture_correction_table.txt'</span><span class="p">):</span>
    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">'./aperture_correction_table.txt'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading the aperture correction table"</span><span class="p">)</span>

    <span class="n">boxlink_apcorr_table</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/aperture_correction_table.txt'</span>
    <span class="n">boxfile_apcorr_table</span> <span class="o">=</span> <span class="s1">'./aperture_correction_table.txt'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_apcorr_table</span><span class="p">,</span> <span class="n">boxfile_apcorr_table</span><span class="p">)</span>
    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">'./aperture_correction_table.txt'</span>

<span class="n">aper_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ap_tab</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'\s+'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">'filter'</span><span class="p">,</span> <span class="s1">'pupil'</span><span class="p">,</span> <span class="s1">'wave'</span><span class="p">,</span> <span class="s1">'r10'</span><span class="p">,</span> <span class="s1">'r20'</span><span class="p">,</span> <span class="s1">'r30'</span><span class="p">,</span> <span class="s1">'r40'</span><span class="p">,</span> <span class="s1">'r50'</span><span class="p">,</span> <span class="s1">'r60'</span><span class="p">,</span> <span class="s1">'r70'</span><span class="p">,</span> <span class="s1">'r80'</span><span class="p">,</span>
                                <span class="s1">'r85'</span><span class="p">,</span> <span class="s1">'r90'</span><span class="p">,</span> <span class="s1">'sky_flux_px'</span><span class="p">,</span> <span class="s1">'apcorr10'</span><span class="p">,</span> <span class="s1">'apcorr20'</span><span class="p">,</span> <span class="s1">'apcorr30'</span><span class="p">,</span> <span class="s1">'apcorr40'</span><span class="p">,</span>
                                <span class="s1">'apcorr50'</span><span class="p">,</span> <span class="s1">'apcorr60'</span><span class="p">,</span> <span class="s1">'apcorr70'</span><span class="p">,</span> <span class="s1">'apcorr80'</span><span class="p">,</span> <span class="s1">'apcorr85'</span><span class="p">,</span> <span class="s1">'apcorr90'</span><span class="p">,</span> <span class="s1">'sky_in'</span><span class="p">,</span>
                                <span class="s1">'sky_out'</span><span class="p">],</span> <span class="n">comment</span><span class="o">=</span><span class="s1">'#'</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span>
<span class="n">aper_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="a-subsample-using-the-cmd-as-a-reference">
            <h3>
             1a. Subsample using the CMD as a reference
             <a class="headerlink" href="#a-subsample-using-the-cmd-as-a-reference" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <strong>
              Note
             </strong>
             : if the users want to impose a more stringent condition, selecting within the sub-sample of stars the ones with no neighbour closer than X pixel, where X can be fixed appropriately, it can be done setting
             <code class="docutils literal notranslate">
              <span class="pre">
               dist_sel
              </span>
             </code>
             = True.
            </p>
            <p>
             The limiting magnitudes and the maximum distance to the closest neighbour depend on the user science case (i.e.; number of stars in the field of view, crowding, number of bright sources, etc.) and must be modified accordingly.
            </p>
            <p>
             The final table
             <code class="docutils literal notranslate">
              <span class="pre">
               xy_cmd
              </span>
             </code>
             contain the positions (X,Y) of the selected stars in the two filters.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">xy_cmd</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

<span class="n">mag_lim_bright</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.0</span>
<span class="n">mag_lim_faint</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.5</span>

<span class="n">mask_xy</span> <span class="o">=</span> <span class="p">((</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mag_lim_faint</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mag_lim_bright</span><span class="p">))</span>

<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>
<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>
<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>
<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Number of stars selected from CMD:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">))</span>

<span class="n">dist_sel</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Calculating closest neigbhour distance"</span><span class="p">)</span>

    <span class="n">d_filt1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">d_filt2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">min_sep_filt1</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">min_sep_filt2</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">],</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]):</span>

        <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">d_filt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">],</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]):</span>

        <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">d_filt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

    <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'min distance '</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_filt1</span>
    <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'min distance '</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_filt2</span>

    <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'min distance '</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep_filt1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'min distance '</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep_filt2</span><span class="p">))</span>

    <span class="n">xy_cmd</span> <span class="o">=</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Minimum distance required for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt1</span><span class="p">),</span> <span class="n">min_sep_filt1</span><span class="p">,</span> <span class="s2">"px"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Minimum distance required for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt2</span><span class="p">),</span> <span class="n">min_sep_filt2</span><span class="p">,</span> <span class="s2">"px"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of stars selected from CMD including distance constraints:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">))</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             As we have done previously, we create a dictionary that contains the tables with the derived aperture photometry (for the bright stars) for each image.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">dict_zp</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="n">dict_zp</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">'NRCA1'</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">'F070W'</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Finding sources on image </span><span class="si">{number}</span><span class="s2">, filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Conversion factor from </span><span class="si">{units}</span><span class="s2"> to DN/s for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">imh</span><span class="p">[</span><span class="s1">'BUNIT'</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">])</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf fwhm'</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"FWHM for the filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">sigma_psf</span><span class="p">,</span> <span class="s2">"px"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var_bkg</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Using 2D Background"</span><span class="p">)</span>
        <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">coverage_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span>
                           <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span> <span class="n">coverage_mask</span><span class="o">=</span><span class="n">coverage_mask</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data_bkgsub</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>

    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

    <span class="n">zp_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>

    <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_stars</span>

    <span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Calculating closest neigbhour distance"</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zp_stars</span><span class="p">[</span><span class="s1">'xcentroid'</span><span class="p">],</span> <span class="n">zp_stars</span><span class="p">[</span><span class="s1">'ycentroid'</span><span class="p">]):</span>

            <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">-</span> <span class="n">xx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                           <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

        <span class="n">zp_stars</span><span class="p">[</span><span class="s1">'min distance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">zp_stars</span><span class="p">[</span><span class="s1">'min distance'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">zp_stars</span> <span class="o">=</span> <span class="n">zp_stars</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>

        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_stars</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">"Minimum distance required:"</span><span class="p">,</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">"px"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of bright isolated sources found in the image:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">zp_stars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"-----------------------------------------------------"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of bright sources found in the image:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">zp_stars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"--------------------------------------------"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             The threshold and the maximum distance to the closest neighbour depend on the user science case (i.e.; number of stars in the field of view, crowding, number of bright sources, etc.) and must be modified accordingly.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>  <span class="c1"># threshold level for the two filters (length must match number of filters analyzed)</span>
<span class="n">min_sep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># minimum separation acceptable for zp stars from closest neighbour</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Elapsed Time for finding stars:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="aperture-photometry-on-the-bright-isolated-stars">
            <h3>
             Aperture Photometry on the bright isolated stars
             <a class="headerlink" href="#aperture-photometry-on-the-bright-isolated-stars" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             To select the sample of stars that we want to use in the aperture photometry, modify the
             <code class="docutils literal notranslate">
              <span class="pre">
               sample
              </span>
             </code>
             keyword, using
             <em>
              cmd
             </em>
             or
             <em>
              found
             </em>
             .
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">aperture_phot_zp</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">'found'</span><span class="p">):</span>

    <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'r70'</span><span class="p">]]</span>

    <span class="n">ees</span> <span class="o">=</span> <span class="s1">'70'</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">ee_radii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ees</span><span class="p">,</span> <span class="n">radii</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">'found'</span><span class="p">:</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">],</span>
                                  <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">'cmd'</span><span class="p">:</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">],</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">]))</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># sky from the aperture correction table:</span>

    <span class="n">sky</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"sky_in"</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'r80'</span><span class="p">],</span> <span class="s2">"sky_out"</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'r85'</span><span class="p">]}</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">table_zp</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ee</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">ee_radii</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing aperture photometry for radius equivalent to EE = </span><span class="si">{0}% f</span><span class="s2">or filter </span><span class="si">{1}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">filt</span><span class="p">))</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">"sky_in"</span><span class="p">],</span> <span class="n">r_out</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">"sky_out"</span><span class="p">])</span>
        <span class="n">annulus_mask</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'center'</span><span class="p">)</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">annulus_mask</span><span class="p">:</span>
            <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">)</span>
            <span class="n">bkg_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>
        <span class="n">bkg_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_median</span><span class="p">)</span>

        <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'exact'</span><span class="p">)</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'annulus_median'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">]</span>

        <span class="n">apcorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'apcorr70'</span><span class="p">]]</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_corrected'</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">]</span> <span class="o">*</span> <span class="n">apcorr</span>

        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'annulus_median'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'annulus_median_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_bkg_ee_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_bkgsub_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_corrected'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_corrected_'</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">)</span>

        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Time Elapsed:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>

    <span class="k">return</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">aperture_phot_zp</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">'cmd'</span><span class="p">)</span>
<span class="n">aperture_phot_zp</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt2</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">'cmd'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">ee</span> <span class="o">=</span> <span class="s1">'70'</span>
<span class="n">sample</span> <span class="o">=</span> <span class="s1">'cmd'</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

            <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">table_zp_mag</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">'found'</span><span class="p">:</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_corrected_'</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'sources found'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'x'</span><span class="p">],</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'y'</span><span class="p">])</span>
                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>
                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_corrected_'</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">'_zp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'VegaMAG zp modB'</span><span class="p">]</span>

                <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span>

            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">'cmd'</span><span class="p">:</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_corrected_'</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'x_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">'y_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'x'</span><span class="p">],</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'y'</span><span class="p">])</span>
                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'aper_sum_corrected_'</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">'_zp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'VegaMAG zp modB'</span><span class="p">]</span>

                <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="derive-zeropoints">
            <h3>
             Derive Zeropoints
             <a class="headerlink" href="#derive-zeropoints" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_ZP'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">idx_zp_1</span><span class="p">,</span> <span class="n">d2d_zp_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">],</span>
                                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">])</span>

<span class="n">sep_constraint_zp_1</span> <span class="o">=</span> <span class="n">d2d_zp_1</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f115w_apZP_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_zp'</span><span class="p">][</span><span class="n">sep_constraint_zp_1</span><span class="p">])</span>
<span class="n">f115w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_zp_1</span><span class="p">[</span><span class="n">sep_constraint_zp_1</span><span class="p">]])</span>

<span class="n">diff_f115w</span> <span class="o">=</span> <span class="n">f115w_apZP_matched</span> <span class="o">-</span> <span class="n">f115w_ap_matched</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_sigma_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f115w_ap_matched</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.25</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f115w_ap_matched</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.35</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.35</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_ap_matched</span><span class="p">,</span> <span class="n">diff_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">' Zeropoint = </span><span class="si">%5.3f</span><span class="s1"> $\pm $ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_sigma_f115w</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_ZP'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">idx_zp_2</span><span class="p">,</span> <span class="n">d2d_zp_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">],</span>
                                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">])</span>

<span class="n">sep_constraint_zp_2</span> <span class="o">=</span> <span class="n">d2d_zp_2</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f200w_apZP_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_zp'</span><span class="p">][</span><span class="n">sep_constraint_zp_2</span><span class="p">])</span>
<span class="n">f200w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_zp_2</span><span class="p">[</span><span class="n">sep_constraint_zp_2</span><span class="p">]])</span>

<span class="n">diff_f200w</span> <span class="o">=</span> <span class="n">f200w_apZP_matched</span> <span class="o">-</span> <span class="n">f200w_ap_matched</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_sigma_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f200w_ap_matched</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.25</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f200w_ap_matched</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.35</span> 
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_ap_matched</span><span class="p">,</span> <span class="n">diff_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">' Zeropoint = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_sigma_f200w</span><span class="p">),</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="import-input-catalog">
           <h2>
            Import Input catalog
            <a class="headerlink" href="#import-input-catalog" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">'./pointsource.cat'</span><span class="p">):</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">'./pointsource.cat'</span>

<span class="k">else</span><span class="p">:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading input pointsource catalog"</span><span class="p">)</span>

    <span class="n">boxlink_input_cat</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/pointsource.cat'</span>
    <span class="n">boxfile_input_cat</span> <span class="o">=</span> <span class="s1">'./pointsource.cat'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_input_cat</span><span class="p">,</span> <span class="n">boxfile_input_cat</span><span class="p">)</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">'./pointsource.cat'</span>

<span class="n">cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_cat</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'\s+'</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">,</span> <span class="s1">'dec_in'</span><span class="p">,</span> <span class="s1">'f070w_in'</span><span class="p">,</span> <span class="s1">'f115w_in'</span><span class="p">,</span>
                                                            <span class="s1">'f200w_in'</span><span class="p">,</span> <span class="s1">'f277w_in'</span><span class="p">,</span> <span class="s1">'f356w_in'</span><span class="p">,</span> <span class="s1">'f444w_in'</span><span class="p">],</span>
                  <span class="n">comment</span><span class="o">=</span><span class="s1">'#'</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">cat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">lim_ra_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
<span class="n">lim_ra_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
<span class="n">lim_dec_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
<span class="n">lim_dec_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'final aperture phot table'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>

<span class="n">cat_sel</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_ra_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_ra_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_dec_min</span><span class="p">)</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_dec_max</span><span class="p">)]</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="calibrated-color-magnitude-diagram">
           <h2>
            Calibrated Color-Magnitude Diagram
            <a class="headerlink" href="#calibrated-color-magnitude-diagram" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">font2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'size'</span><span class="p">:</span> <span class="s1">'30'</span><span class="p">}</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">mag1_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f115w_in'</span><span class="p">])</span>
<span class="n">mag2_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f200w_in'</span><span class="p">])</span>
<span class="n">diff_in</span> <span class="o">=</span> <span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">1.75</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">15</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span><span class="p">,</span> <span class="n">mag1_in</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">' - '</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">"Input"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">f115w</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_f115w</span> 
<span class="n">f200w</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_f200w</span>

<span class="n">maglim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">mags</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">errs_mag</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">errs_col</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">err_mag1</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>
    <span class="n">err_mag2</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>
    <span class="n">err_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_mag1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">err_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err_mag1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">err_mag2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">err_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_temp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">errs_mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_mag</span><span class="p">)</span>                  
    <span class="n">errs_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_col</span><span class="p">)</span>
    <span class="n">mags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>

<span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># ax2.errorbar(col, mags, yerr=errs_mag, xerr=errs_col, fmt='o', color = 'k')</span>
    
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w</span> <span class="o">-</span> <span class="n">f200w</span><span class="p">,</span> <span class="n">f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">"Output"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">' - '</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="comparison-between-input-and-output-photometry">
           <h2>
            Comparison between input and output photometry
            <a class="headerlink" href="#comparison-between-input-and-output-photometry" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Mag'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">radec_input</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">],</span> <span class="n">cat_sel</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>

<span class="n">idx_f115w_cfr</span><span class="p">,</span> <span class="n">d2d_f115w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">])</span>

<span class="n">sep_f115w_cfr</span> <span class="o">=</span> <span class="n">d2d_f115w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f115w_in'</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>
<span class="n">f115w_ap_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f115w</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>

<span class="n">diff_f115w_cfr</span> <span class="o">=</span> <span class="n">f115w_inp_cfr</span> <span class="o">-</span> <span class="n">f115w_ap_cfr</span>
<span class="n">diff_f115w_cfr_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">f115w_inp_cfr</span> <span class="o">-</span> <span class="n">f115w_ap_cfr</span><span class="p">)[(</span><span class="n">f115w_ap_cfr</span> <span class="o">&gt;</span> <span class="mf">17.75</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w_ap_cfr</span> <span class="o">&lt;</span> <span class="mf">21.5</span><span class="p">)]</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w_cfr_sel</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_ap_cfr</span><span class="p">,</span> <span class="n">diff_f115w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">17.75</span><span class="p">,</span> <span class="mf">17.75</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">21.5</span><span class="p">,</span> <span class="mf">21.5</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">' $\Delta$ Mag = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diff_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f115w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Mag'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">idx_f200w_cfr</span><span class="p">,</span> <span class="n">d2d_f200w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">])</span>

<span class="n">sep_f200w_cfr</span> <span class="o">=</span> <span class="n">d2d_f200w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f200w_in'</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>
<span class="n">f200w_ap_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f200w</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>

<span class="n">diff_f200w_cfr</span> <span class="o">=</span> <span class="n">f200w_inp_cfr</span> <span class="o">-</span> <span class="n">f200w_ap_cfr</span>
<span class="n">diff_f200w_cfr_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">f200w_inp_cfr</span> <span class="o">-</span> <span class="n">f200w_ap_cfr</span><span class="p">)[(</span><span class="n">f200w_ap_cfr</span> <span class="o">&gt;</span> <span class="mf">16.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f200w_ap_cfr</span> <span class="o">&lt;</span> <span class="mf">20.5</span><span class="p">)]</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w_cfr_sel</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_ap_cfr</span><span class="p">,</span> <span class="n">diff_f200w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">16.5</span><span class="p">,</span> <span class="mf">16.5</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">20.5</span><span class="p">,</span> <span class="mf">20.5</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">' $\Delta$ Mag = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diff_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f200w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="about-this-notebook">
           <h2>
            About this Notebook
            <a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <strong>
             Author
            </strong>
            : Matteo Correnti, JWST/NIRCam STScI Scientist II
            <br/>
            <strong>
             Updated on
            </strong>
            : 2021-01-15
           </p>
           <p>
            <a class="reference external" href="#top">
             Top of Page
            </a>
           </p>
           <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="float: right;" width="200px"/>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/aperture_photometry"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            LRS Optimal Spectral Extraction
           </p>
          </div>
         </a>
         <a class="right-next" href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            Extended Aperture Photometry
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>