

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>BOTS Time Series Observations &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Redshift and Template Fitting" href="../galaxy_redshift/redshift_fitting.html" />
    <link rel="prev" title="MOS Spectroscopy of Extragalactic Field" href="../mos_spectroscopy_advanced/MOSspec_advanced.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">MRS Mstar - Run Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">MRS Detector Based Extraction</a></li>




<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../niriss_imaging/niriss-imaging-tutorial.html">NIRISS Imaging Tutorial</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>BOTS Time Series Observations</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">BOTS Time Series Observations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-parameters">Setup Parameters</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-load-nirspec-data">Download and Load NIRSpec data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-2d-spectral-data">Visualizing the 2D spectral data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-1d-spectra-from-2d-array-of-images">Extract 1D spectra from 2D array of images</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-1d-spectral-data">Visualizing the 1D spectral data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes">Calculate Orbital Phase and a separate fine grid model used for plotting purposes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-systematic-drift-on-the-detector">Dealing with Systematic Drift On the Detector</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-arrays-of-the-vectors-used-for-detrending">Create arrays of the vectors used for detrending.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transit-and-limb-darkening-model-functions">Transit and Limb-Darkening Model Functions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-transit-model-function">Now define the transit model function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data">Now define the function to generate the transit light curve and compare it to the data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-transit-light-curves">FIT Transit Light Curves</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-wavelengths-to-fit-over">Setup Wavelengths to fit over</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-wavelength-bins-fitting-each-lightcurve">Loop Over Wavelength Bins Fitting Each Lightcurve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin">Note this step takes considerable time to complete (~20 min, few minutes/bin)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-measured-exoplanet-transmission-spectrum-vs-injected">Plot Measured Exoplanet Transmission Spectrum vs Injected</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="bots-time-series-observations">
<h1>BOTS Time Series Observations<a class="headerlink" href="#bots-time-series-observations" title="Permalink to this heading">#</a></h1>
<p><strong>Use case:</strong> Bright Object Time Series; extracting exoplanet spectra.<br>
<strong>Data:</strong> JWST simulated NIRSpec data from ground-based campaign; GJ436b spectra from the Goyal et al. (2018).<br>
<strong>Tools:</strong>  scikit, lmfit, scipy, matplotlip, astropy, pandas.<br>
<strong>Cross-intrument:</strong> . <br>
<strong>Documentation:</strong> This notebook is part of a STScIâ€™s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br>
<strong>Author:</strong> David K. Sing (dsing&#64;jhu.edu)<br>
<strong>Last updated:</strong> 2 July 2020</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This notebook uses time series JWST NIRSpec data taken during a ground-based campaign to illustrate extracting exoplanet spectra from time-series observations.</p>
<p>The data are derived from the ISIM-CV3, the cryovacuum campaign of the JWST Integrated Science Instrument Module (ISIM), that took place at Goddard Space Flight Center during the winter 2015-2016 (Kimble et al. 2016). The data can be found at https://www.cosmos.esa.int/web/jwst-nirspec/test-data, and detailed and insightful report of the data by G. Giardino, S. Birkmann, P. Ferruit, B. Dorner, B. Rauscher can be found here: ftp://ftp.cosmos.esa.int/jwstlib/ReleasedCV3dataTimeSeries/CV3_TimeSeries_PRM.tgz</p>
<p>This NIRSpec time series dataset has had a transit light curve injected at the pixel-level, which closely mimics a bright object time series (BOTS) observation of a transiting exoplanet. In this case, a GJ436b spectra from the
<strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018MNRAS.474.5158G/">Goyal et al. (2018)</a></strong>
exoplanet grid was selected (clear atmosphere at solar metallicity).  With an actual NIRSpec dataset, the noise properties of the detector, jitter, and the effects on extracting exoplanet spectra from time-series observations can more accurately simulated.</p>
<p>Broadly the aim of this notebook is to work with these time series observations to:</p>
<ol class="arabic simple">
<li><p>Extract 1D spectra from the 2D spectral images.</p></li>
<li><p>Define a time series model to fit to the wavelength dependent transit light curve.</p></li>
<li><p>Fit each time series wavelength bin of the 1D spectra, measuring the desired quantity <span class="math notranslate nohighlight">\(R_{pl}(\lambda)/R_{star}\)</span>.</p></li>
<li><p>Produce a measured transmission spectrum that can then be compared to models.</p></li>
</ol>
<p>The example outputs the fit light curves for each spectral bin, along with fitting statistics.</p>
</section>
<section id="load-packages">
<h2>Load packages<a class="headerlink" href="#load-packages" title="Permalink to this heading">#</a></h2>
<p>This notebook uses packages (matplotlib, astropy, scipy, glob, lmfit, pickle, os, sklearn) which can all be installed in a standard fashion through pip.</p>
<p>Several routines to calculate limb-darkening and a transit model were extracted from ExoTiC-ISm
(<strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2281L/">Laginja &amp; Wakeford 2020</a></strong> ;
https://github.com/hrwakeford/ExoTiC-ISM), and slightly adapted. The full set of stellar models used for the limb-darkening calculation can also be downloaded from ExoTiC-ISM, as this notebook only downloads and loads the single stellar model used to generate the limb darkening.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span><span class="p">,</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.models</span> <span class="kn">import</span> <span class="n">custom_model</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.fitting</span> <span class="kn">import</span> <span class="n">LevMarLSQFitter</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">splev</span><span class="p">,</span> <span class="n">splrep</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">readsav</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">mkdir</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setup-parameters">
<h2>Setup Parameters<a class="headerlink" href="#setup-parameters" title="Permalink to this heading">#</a></h2>
<p>Parameters of the fit include directories where the data and limb darkening stellar models are held, along with properties of the planet and star. The stellar and planet values that have been entered here (modeled after GJ436) are the same as was used to model the injected transit.  Note, the 4500K stellar model used to inject the transit was hotter than GJ436A.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SETUP  ----------------------------------------------</span>
<span class="c1"># Setup directories</span>
<span class="n">save_directory</span> <span class="o">=</span> <span class="s1">&#39;./notebookrun2/&#39;</span>          <span class="c1"># Local directory to save files to</span>
<span class="n">data_directory</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>                       <span class="c1"># Local data to work with fits files if desired</span>

<span class="c1"># Setup Detector Properties &amp; Rednoise measurement timescale </span>
<span class="n">gain</span> <span class="o">=</span> <span class="mf">1.0</span>   <span class="c1"># 2D spectra has already converted to counts, gain of detector is 1.0</span>
<span class="n">binmeasure</span> <span class="o">=</span> <span class="mi">256</span>   <span class="c1"># Binning technique to measure rednoise, choose bin size to evaluate sigma_r</span>
<span class="n">number_of_images</span> <span class="o">=</span> <span class="mi">8192</span>  <span class="c1"># Number of images in the dataset</span>

<span class="c1"># Setup Planet Properties</span>
<span class="n">grating</span> <span class="o">=</span> <span class="s1">&#39;NIRSpecPrism&#39;</span>
<span class="n">ld_model</span> <span class="o">=</span> <span class="s1">&#39;3D&#39;</span>      <span class="c1"># 3D/1D stellar model choice (transit was injected with the 3D model)</span>

<span class="c1"># Setup Stellar Properties for Limb-Darkening Calculation</span>
<span class="n">Teff</span> <span class="o">=</span> <span class="mi">4500</span>           <span class="c1"># Effective Temperature (K)</span>
<span class="n">logg</span> <span class="o">=</span> <span class="mf">4.5</span>            <span class="c1"># Surface Gravity</span>
<span class="n">M_H</span> <span class="o">=</span> <span class="mf">0.0</span>            <span class="c1"># Stellar Metallicity log_10[M/H]</span>
<span class="n">Rstar</span> <span class="o">=</span> <span class="mf">0.455</span>          <span class="c1"># Planet radius (in units of solar radii Run)</span>

<span class="c1"># Setup Transit parameters (can get from NASA exoplanet archive)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mf">2454865.084034</span>              <span class="c1"># bjd time of inferior conjunction </span>
<span class="n">per</span> <span class="o">=</span> <span class="mf">2.64389803</span>                  <span class="c1"># orbital period (days) BJD_TDB</span>
<span class="n">rp</span> <span class="o">=</span> <span class="mf">0.0804</span>                      <span class="c1"># Planet radius (in units of stellar radii)</span>
<span class="n">a_Rs</span> <span class="o">=</span> <span class="mf">14.54</span>                       <span class="c1"># Semi-major axis (input a/Rstar so units of stellar radii)</span>
<span class="n">inc</span> <span class="o">=</span> <span class="mf">86.858</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span>      <span class="c1"># Orbital inclination (in degrees-&gt;radians)</span>
<span class="n">ecc</span> <span class="o">=</span> <span class="mf">0.0</span>                         <span class="c1"># Eccentricity</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span>         <span class="c1"># Longitude of periastron (in degrees-&gt;radians)</span>

<span class="n">rho_star</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">6.67259E-8</span><span class="o">*</span><span class="p">(</span><span class="n">per</span><span class="o">*</span><span class="mi">86400</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a_Rs</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>     <span class="c1"># Stellar Density (g/cm^3) from a/Rs</span>
<span class="c1"># a_Rs=(rho_star*6.67259E-8*per_sec*per_sec/(3*np.pi))**(1/3)  # a/Rs from Stellar Density (g/cm^3)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create local directories</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_directory</span><span class="p">):</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>      <span class="c1"># Create a new directory to save outputs to if needed</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid&#39;</span><span class="p">):</span> 
    <span class="n">mkdir</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid&#39;</span><span class="p">)</span>      <span class="c1"># Create new directory to save</span>
<span class="n">limb_dark_directory</span> <span class="o">=</span> <span class="n">save_directory</span>    <span class="c1"># Point to limb darkeing directory contaning 3DGrid/ directory</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="download-and-load-nirspec-data">
<h1>Download and Load NIRSpec data<a class="headerlink" href="#download-and-load-nirspec-data" title="Permalink to this heading">#</a></h1>
<p>The fits images are loaded, and information including the image date and science spectra are saved.</p>
<p>A default flux offset value BZERO is also taken from the header and subtracted from every science frame.</p>
<p>Reading in the 2^13 fits files is slow.  To speed things up, we created a pickle file of the for first instance the fits images are loaded.  This 1GB pickle file is loaded instead of reading the fits files if found.</p>
<p>Alternatively, the fits files can be downloaded here:
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/Archive.Trace_SLIT_A_1600_SRAD-PRM-PS-6007102143_37803_JLAB88_injected.tar.gz.  The images are in a tar.gz archvie, which needs to be un-archived and data_directory variable set to the directory in the SETUP cell above.</p>
<p>The cell below downloads the 1GB JWST data pickle file, and several other files needed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download 1GB NIRSpec Data</span>
<span class="n">fn_jw</span> <span class="o">=</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;jwst_data.pickle&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/jwst_data.pickle&#39;</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;jwst_data.pickle&#39;</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;JWST Data Download Complete&#39;</span><span class="p">)</span>

<span class="c1"># Download further files needed, move to local directory for easier repeated access</span>
<span class="n">fn_sens</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">)</span>
<span class="n">dest</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_sens</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">)</span>  <span class="c1"># Move files to save_directory</span>

<span class="n">fn_ld</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/3DGrid/mmu_t45g45m00v05.flx&#39;</span><span class="p">)</span>
<span class="n">destld</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_ld</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid/mmu_t45g45m00v05.flx&#39;</span><span class="p">)</span>        
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>JWST Data Download Complete
</pre></div>
</div>
</div>
</div>
<p>Loads the Pickle File data.  Alternatly, the data can be read from the original fits files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>
    <span class="n">dbfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="c1"># for reading also binary mode is important</span>
    <span class="n">jwst_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading JWST data from Pickle File&#39;</span><span class="p">)</span>
    <span class="n">bjd</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;bjd&#39;</span><span class="p">]</span>
    <span class="n">wsdata_all</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;wsdata_all&#39;</span><span class="p">]</span>
    <span class="n">shx</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;shx&#39;</span><span class="p">]</span>
    <span class="n">shy</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;shy&#39;</span><span class="p">]</span>
    <span class="n">common_mode</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;common_mode&#39;</span><span class="p">]</span>
    <span class="n">all_spec</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;all_spec&#39;</span><span class="p">]</span>
    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;exposure_length&#39;</span><span class="p">]</span>
    <span class="n">dbfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>
    <span class="c1"># Load all fits images</span>
    <span class="c1"># Arrays created for BJD time, and the white light curve total_counts</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">data_directory</span><span class="o">+</span><span class="s2">&quot;*.fits&quot;</span><span class="p">)</span>
    <span class="n">index_of_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)</span> 
    <span class="n">bjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_images</span><span class="p">))</span>
    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_images</span><span class="p">))</span>
    <span class="n">all_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">number_of_images</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_images</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="c1"># hdul.info()</span>
        <span class="n">bjd_image</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BJD_TDB&#39;</span><span class="p">]</span>
        <span class="n">BZERO</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BZERO&#39;</span><span class="p">]</span>        <span class="c1"># flux value offset</span>
        <span class="n">bjd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bjd_image</span>
        <span class="n">expleng</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INTTIME&#39;</span><span class="p">]</span>    <span class="c1"># Total integration time for one MULTIACCUM (seconds)</span>
        <span class="n">exposure_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">expleng</span><span class="o">/</span><span class="mf">86400.</span>    <span class="c1"># Total integration time for one MULTIACCUM (days)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bjd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># total counts in image</span>
        <span class="c1"># total_counts[i]=gain*np.sum(data[11:18,170:200]-BZERO) # total counts in 12 pix wide aperture around pixel 60 image</span>
        <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">BZERO</span><span class="p">)</span>     <span class="c1"># Load all spectra into an array subtract flux value offset</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Sort data</span>
    <span class="n">srt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">bjd</span><span class="p">)</span> <span class="c1"># index to sort</span>
    <span class="n">bjd</span> <span class="o">=</span> <span class="n">bjd</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>
    <span class="c1"># total_counts=total_counts[srt]</span>
    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">exposure_length</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>
    <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">srt</span><span class="p">]</span>

    <span class="c1"># Get Wavelength of Data</span>
    <span class="n">file_wave</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/JWST_NIRSpec_wavelength_microns.txt&#39;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_wave</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">wsdata_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wsdata size :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data wavelength Loaded :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wsdata new size :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="c1"># Read in Detrending parameters</span>
    <span class="c1"># Mean of parameter must be 0.0 to be properly normalized</span>
    <span class="c1"># Idealy standard deviation of parameter = 1.0</span>
    <span class="n">file_xy</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/JWST_NIRSpec_Xposs_Yposs_CM_detrending.txt&#39;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_xy</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">shx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">shy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">common_mode</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    
    <span class="c1"># Store Data in a pickle file</span>
    <span class="n">jwst_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bjd&#39;</span><span class="p">:</span> <span class="n">bjd</span><span class="p">,</span> <span class="s1">&#39;wsdata_all&#39;</span><span class="p">:</span> <span class="n">wsdata_all</span><span class="p">,</span> <span class="s1">&#39;shx&#39;</span><span class="p">:</span> <span class="n">shx</span><span class="p">,</span> <span class="s1">&#39;shy&#39;</span><span class="p">:</span> <span class="n">shy</span><span class="p">,</span> <span class="s1">&#39;common_mode&#39;</span><span class="p">:</span> <span class="n">common_mode</span><span class="p">,</span> <span class="s1">&#39;all_spec&#39;</span><span class="p">:</span> <span class="n">all_spec</span><span class="p">,</span> <span class="s1">&#39;exposure_length&#39;</span><span class="p">:</span> <span class="n">exposure_length</span><span class="p">}</span>
    <span class="n">dbfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;jwst_data.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="c1"># Its important to use binary mode</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jwst_data</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
    <span class="n">dbfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading JWST data from Pickle File
Done
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="visualizing-the-2d-spectral-data">
<h1>Visualizing the 2D spectral data<a class="headerlink" href="#visualizing-the-2d-spectral-data" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expnum</span> <span class="o">=</span> <span class="mi">2</span>                                           <span class="c1"># Choose Exposure number to view</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>                   <span class="c1"># Resolution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>                     <span class="c1"># Aspect ratio (the CCD is quite long!!!)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;magma&#39;</span>                   <span class="c1"># Colormap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monospace&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.monospace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DejaVu Sans Mono&#39;</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">expnum</span><span class="p">]</span>
<span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Plot on a log scale, so set zero or negative values to a small number </span>
<span class="n">img</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Plot image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y-pixel&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2D NIRSpec Image of Exposure &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expnum</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Log$_</span><span class="si">{10}</span><span class="s1">$ Electron counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3149d452c3ccf7ae5ba991fb3054d8b736d2b38d1bad8e743ef8c5de993f0d09.png" src="../../_images/3149d452c3ccf7ae5ba991fb3054d8b736d2b38d1bad8e743ef8c5de993f0d09.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="extract-1d-spectra-from-2d-array-of-images">
<h1>Extract 1D spectra from 2D array of images<a class="headerlink" href="#extract-1d-spectra-from-2d-array-of-images" title="Permalink to this heading">#</a></h1>
<p>Ideally, extracting 1D spectra from the 2D images would use optimal aperture extraction along a fit
trace with routines equivalent to IRAF/apall. This functionality is not yet available in astro-py.</p>
<p>Several processing steps have already been applied.  The 2D spectra here have been flat field corrected, and 1/f noise has been removed from each pixel by subtracting the median count rate from the un-illuminated pixels along each column (see <strong><span class="xref myst">Giardino et al.</span></strong>
for more information about 1/f noise).  Each 2D image has also been aligned in the X and Y directions, such that each pixel corresponds to the same wavelength.  As the CV3 test had no requirements for flux stability, the ~1% flux variations from the LED have also been removed.</p>
<p>For spectral extraction, the example here simply uses a simple summed box.  The 8192 2D spectra have been
pre-loaded into a numpy array.  The spectra peaks at pixel Y=16. For each column, an aperature sum is taken over Y-axis pixels 11 to 18, which
contains most of the spectrum counts. Wider aperture would add more counts, but also introduces more noise.</p>
<p><strong>Further cleaning steps are not done here</strong></p>
<ol class="arabic simple">
<li><p>Ideally, the pixels flagged as bad for various reasons should be cleaned.</p></li>
<li><p>Cosmic rays should be identified and removed.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_spec</span><span class="o">.</span><span class="n">shape</span>
<span class="n">y_lower</span> <span class="o">=</span> <span class="mi">11</span>                                             <span class="c1"># Lower extraction aperture</span>
<span class="n">y_upper</span> <span class="o">=</span> <span class="mi">18</span>                                             <span class="c1"># Upper extraction aperture</span>
<span class="n">all_spec_1D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec</span><span class="p">[</span><span class="n">y_lower</span><span class="p">:</span><span class="n">y_upper</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Sum along Y-axis from pixels 11 to 18</span>
<span class="c1"># Plot </span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>                   <span class="c1"># Resolution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>                     <span class="c1"># Aspect ratio (the CCD is quite long!!!)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;magma&#39;</span>                   <span class="c1"># Colormap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monospace&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.monospace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DejaVu Sans Mono&#39;</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">expnum</span><span class="p">]</span>
<span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Plot on a log scale, so set zero or negative values to a small number </span>
<span class="n">img</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Plot image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y-pixel&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_lower</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_upper</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2D NIRSpec Image of Exposure &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">expnum</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Log$_</span><span class="si">{10}</span><span class="s1">$ Electron counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/583a957466a83b861ea676cb3abc9e120f94c1beac2e940e226aac1900a0fd9a.png" src="../../_images/583a957466a83b861ea676cb3abc9e120f94c1beac2e940e226aac1900a0fd9a.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="visualizing-the-1d-spectral-data">
<h1>Visualizing the 1D spectral data<a class="headerlink" href="#visualizing-the-1d-spectral-data" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (e-)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;CO$_2$&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/eb5e7d883b68c5bec138276ac9f17fc5c947b2acba2e05c22f20bf6369232102.png" src="../../_images/eb5e7d883b68c5bec138276ac9f17fc5c947b2acba2e05c22f20bf6369232102.png" />
</div>
</div>
<p>The CV3 test observed a lamp with a similar PSF as JWST will have, and has significant counts from
about 1.5 to 4.5 <span class="math notranslate nohighlight">\(\mu\)</span>m.</p>
<p>The cryogenic test chamber had CO<span class="math notranslate nohighlight">\(_2\)</span> and H<span class="math notranslate nohighlight">\(_2\)</span>O ice buildup on the window, which can be seen as spectral absorption features in the 2D spectra.</p>
<section id="calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes">
<h2>Calculate Orbital Phase and a separate fine grid model used for plotting purposes<a class="headerlink" href="#calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate Orbital Phase</span>
<span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">bjd</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span>  <span class="c1"># phase in days relative to T0 ephemeris</span>
<span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">number_of_images</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Have current phase occur at value 0.0</span>

<span class="n">t_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bjd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bjd</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># times at which to calculate light curve</span>
<span class="n">phase_fine</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_fine</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">per</span><span class="p">)</span>  <span class="c1"># phase in days relative to T0 ephemeris</span>
<span class="n">phase_fine</span> <span class="o">=</span> <span class="n">phase_fine</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">number_of_images</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Have current phase occur at value 0.0</span>

<span class="n">b0</span> <span class="o">=</span> <span class="n">a_Rs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">rp</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># Select indicies between first and fourth contact</span>
<span class="n">outtransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">rp</span> <span class="o">&gt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span> <span class="c1"># Select indicies out of transit</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="dealing-with-systematic-drift-on-the-detector">
<h1>Dealing with Systematic Drift On the Detector<a class="headerlink" href="#dealing-with-systematic-drift-on-the-detector" title="Permalink to this heading">#</a></h1>
<p>The CV3 test assessed the stability of the instrument by introducing a large spatial jitter and drift. This resulted in a significant X,Y movement of the spectra on the 2D detector. While this bulk shift has been removed which aligns the spectra, intra- and inter- pixel sensitivities introduce flux variations which need to be removed. The jitter from the CV3 test was more than 30 mas, which is ~4X larger than the JWST stability requirement. Thus, in orbit these detector effects are expected to be significantly smaller, but they will still be present and will need to be modeled and removed from time series observations.</p>
<p>The detector X, Y positions here were measured from cross-correlation of the 2D images (collapsing the spectra along one dimension first), and are saved in arrays <span class="math notranslate nohighlight">\(shx\)</span> and <span class="math notranslate nohighlight">\(shy\)</span>. These detending vectors would ideally be measured using the trace position values from the spectral extraction of each integration, as that could also accurately measure integration-to-integration how the spectra spatially changed on the detector.</p>
<p>The detector shifts have original amplitudes near 0.2 pixels, though the vectors have had initial normalization. For detrending purposes, these arrays should have a mean of 0 and standard deviation of 1.0.</p>
<p>A residual color-dependent trend with the LED lamp can also been seen in the CV3 data, which can be partly removed by scaling original common-mode lamp trend, which was measured using the CV3 white light curve.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shx_tmp</span> <span class="o">=</span> <span class="n">shx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shx</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>       <span class="c1"># Set Mean around 0.0</span>
<span class="n">shx_detrend</span> <span class="o">=</span> <span class="n">shx_tmp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shx_tmp</span><span class="p">)</span>  <span class="c1"># Set standard deviation to 1.0</span>
<span class="n">shy_tmp</span> <span class="o">=</span> <span class="n">shy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shy</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>       <span class="c1"># Set Mean around 0.0</span>
<span class="n">shy_detrend</span> <span class="o">=</span> <span class="n">shy_tmp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shy_tmp</span><span class="p">)</span>  <span class="c1"># Set standard deviation to 1.0</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">common_mode</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">common_mode</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>
<span class="n">cm_detrend</span> <span class="o">=</span> <span class="n">cm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shx_detrend</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X-possition&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shy_detrend</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y-possition&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Image Sequence Number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Detector Possition&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time-series Detrending Vectors&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/98cd61e4c942c344c50e9c6578bce48d7800b15402dbd5415482f60cd7110c0c.png" src="../../_images/98cd61e4c942c344c50e9c6578bce48d7800b15402dbd5415482f60cd7110c0c.png" />
</div>
</div>
<section id="create-arrays-of-the-vectors-used-for-detrending">
<h2>Create arrays of the vectors used for detrending.<a class="headerlink" href="#create-arrays-of-the-vectors-used-for-detrending" title="Permalink to this heading">#</a></h2>
<p>From Sing et al. 2019:  Systematic errors are often removed by a parameterized deterministic model, where the non-transit photometric trends are found to correlate with a number <span class="math notranslate nohighlight">\(n\)</span> of external parameters (or optical state vectors, <span class="math notranslate nohighlight">\(X\)</span>). These parameters describe changes in the instrument or other external factors as a function of time during the observations, and are fit with a coefficient for each optical state parameter, <span class="math notranslate nohighlight">\(p_n\)</span>, to model and remove (or detrend) the photometric light curves.</p>
<p>When including systematic trends, the total parameterized model of the flux measurements over time, <span class="math notranslate nohighlight">\(f(t)\)</span>, can be modeled as a combination of the theoretical transit model, <span class="math notranslate nohighlight">\(T(t,\theta)\)</span> (which depends upon the transit parameters <span class="math notranslate nohighlight">\(\theta\)</span>), the total baseline flux detected from the star, <span class="math notranslate nohighlight">\(F_0\)</span>, and the systematics error model <span class="math notranslate nohighlight">\(S(x)\)</span> giving,</p>
<p><span class="math notranslate nohighlight">\(f(t) = T(t,\theta)\times F_0 \times S(x)\)</span>.</p>
<p>We will use a linear model for the instrument systematic effects.</p>
<p><span class="math notranslate nohighlight">\(S(x)= p_1 x + p_2 y + p_3 x^2 + p_4 y^2 + p_5 x y + p_6 cm + p_7 \phi \)</span></p>
<p><span class="math notranslate nohighlight">\(cm\)</span> is the common_mode trend, and <span class="math notranslate nohighlight">\(\phi\)</span> is a linear time trend which helps remove changing H<span class="math notranslate nohighlight">\(_2\)</span>O ice within the H<span class="math notranslate nohighlight">\(_2\)</span>O spectral feature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shx</span> <span class="o">=</span> <span class="n">shx_detrend</span>
<span class="n">shy</span> <span class="o">=</span> <span class="n">shy_detrend</span>
<span class="n">common_mode</span> <span class="o">=</span> <span class="n">cm_detrend</span>

<span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shx</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shx</span><span class="o">*</span><span class="n">shy</span><span class="p">,</span> <span class="n">common_mode</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)])</span>  <span class="c1"># Detrending array without linear time trend</span>
<span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
<span class="n">XXX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shx</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shx</span><span class="o">*</span><span class="n">shy</span><span class="p">,</span> <span class="n">common_mode</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)])</span>  <span class="c1"># Detrending array with with linear time trend</span>
<span class="n">XXX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">XXX</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Linear Regression</strong> can be used to quickly determine the parameters <span class="math notranslate nohighlight">\(p_n\)</span> using the out-of-transit data.</p>
<p>Here, we take a wavelength bin of the data (pixels 170 to 200) to make a time series.  The out-of-transit points are selected and a linear regression of <span class="math notranslate nohighlight">\(S(x)\)</span> is done to determine the optical state parameters <span class="math notranslate nohighlight">\(p_n\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pix1</span> <span class="o">=</span> <span class="mi">170</span>       <span class="c1"># wavelength bin lower range</span>
<span class="n">pix2</span> <span class="o">=</span> <span class="mi">200</span>       <span class="c1"># wavelength bin upper range</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec_1D</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># flux over a selected wavelength bin</span>

<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Plot Region of wavelength bin</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (e-)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;1D Extracted Spectrum&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;CO$_2$&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">regressor</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Linear Regression Coefficients:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2a062700257ace5e9f99b11dc8897d143321a232e403c433f7f849ab9a036973.png" src="../../_images/2a062700257ace5e9f99b11dc8897d143321a232e403c433f7f849ab9a036973.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/1502773371.py:21: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(bjd, y/np.mean(y[outtransit]), label=&#39;$f(t)$ Data&#39;, zorder=1, s=msize*0.75, linewidth=1, alpha=0.4, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<img alt="../../_images/60c005f84a9d0fc2c3d86181c4d686993fb43d430a89b377ce4586df3c943c1c.png" src="../../_images/60c005f84a9d0fc2c3d86181c4d686993fb43d430a89b377ce4586df3c943c1c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Linear Regression Coefficients:
[ 2.35589645e-04  2.33200386e-04 -1.43527088e-04 -4.65560797e-05
  1.94065907e-04 -4.51855007e-04  0.00000000e+00]
</pre></div>
</div>
</div>
</div>
<p>The coefficients are on the order of ~10<span class="math notranslate nohighlight">\(^{-4}\)</span> so the trends have an amplitude on the order of 100â€™s of ppm.</p>
<p>Visualize the fit</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yfit</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>                         <span class="c1"># Project the fit over the whole time series</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S(x)$ Regression fit &#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3911644354.py:5: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(bjd, y/np.mean(y[outtransit]), label=&#39;$f(t)$ Data&#39;, zorder=1, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<img alt="../../_images/1e7b334b3124d826f82e012d7799e8f7ff4cf4d80d82bace4e04cc87286636b4.png" src="../../_images/1e7b334b3124d826f82e012d7799e8f7ff4cf4d80d82bace4e04cc87286636b4.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="transit-and-limb-darkening-model-functions">
<h1>Transit and Limb-Darkening Model Functions<a class="headerlink" href="#transit-and-limb-darkening-model-functions" title="Permalink to this heading">#</a></h1>
<p>Define a functions used by the fitting routines.
These which will take the transit and systematic parameters and create our full transit light curve model</p>
<p><span class="math notranslate nohighlight">\(model = T(t,\theta)\times F_0 \times S(x)\)</span></p>
<p>compares it to the data</p>
<p><span class="math notranslate nohighlight">\(y = f(t)\)</span></p>
<p>by returning the residuals</p>
<p><span class="math notranslate nohighlight">\((y-model)/(\sigma_y)\)</span></p>
<p>To calculate the transit model, here we use  <strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2002ApJ...580L.171M/abstract">Mandel and Agol (2002)</a></strong> as coded in python by H. Wakeford (<strong><a class="reference external" href="https://github.com/hrwakeford/ExoTiC-ISM">ExoTiC-ISM</a></strong>).</p>
<p>To calculate the stellar limb-darkening, we use the procedure from Sing et al. (2010) which uses stellar models and fits for non-linear limb darkening coefficients, with a module as coded in python by H. Wakeford (<strong><a class="reference external" href="https://github.com/hrwakeford/ExoTiC-ISM">ExoTiC-ISM</a></strong>).</p>
<p>A new orbit is first calculated based on the system parameters of <span class="math notranslate nohighlight">\(a/R_{star}\)</span>, the cosine of the inclination <span class="math notranslate nohighlight">\(cos(i)\)</span>, and the orbital phase <span class="math notranslate nohighlight">\(\phi\)</span>.
The inputs are the orbit distance between the planet-star center <span class="math notranslate nohighlight">\(b\)</span> at each phase, limb-darkening parameters (<span class="math notranslate nohighlight">\(c_1,c_2,c_3,c_4\)</span>), and the planet-to-star radius ratio <span class="math notranslate nohighlight">\(R_p/R_{star}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_model</span>
<span class="k">def</span> <span class="nf">nonlinear_limb_darkening</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c3</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define non-linear limb darkening model with four parameters c0, c1, c2, c3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="nd">@custom_model</span>
<span class="k">def</span> <span class="nf">quadratic_limb_darkening</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">aLD</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">bLD</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define linear limb darkening model with parameters aLD and bLD.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">aLD</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">bLD</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">dirsen</span><span class="p">,</span> <span class="n">ld_model</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates stellar limb-darkening coefficients for a given wavelength bin.</span>

<span class="sd">    Currently supports:</span>
<span class="sd">    HST STIS G750L, G750M, G430L gratings</span>
<span class="sd">    HST WFC3 UVIS/G280, IR/G102, IR/G141 grisms</span>

<span class="sd">    What is used for 1D models - Kurucz (?)</span>
<span class="sd">    Procedure from Sing et al. (2010, A&amp;A, 510, A21).</span>
<span class="sd">    Uses 3D limb darkening from Magic et al. (2015, A&amp;A, 573, 90).</span>
<span class="sd">    Uses photon FLUX Sum over (lambda*dlamba).</span>
<span class="sd">    :param grating: string; grating to use (&#39;G430L&#39;,&#39;G750L&#39;,&#39;G750M&#39;, &#39;G280&#39;, &#39;G102&#39;, &#39;G141&#39;)</span>
<span class="sd">    :param wsdata: array; data wavelength solution</span>
<span class="sd">    :param M_H: float; stellar metallicity</span>
<span class="sd">    :param Teff: float; stellar effective temperature (K)</span>
<span class="sd">    :param logg: float; stellar gravity</span>
<span class="sd">    :param dirsen: string; path to main limb darkening directory</span>
<span class="sd">    :param ld_model: string; &#39;1D&#39; or &#39;3D&#39;, makes choice between limb darkening models; default is 1D</span>
<span class="sd">    :return: uLD: float; linear limb darkening coefficient</span>
<span class="sd">    aLD, bLD: float; quadratic limb darkening coefficients</span>
<span class="sd">    cp1, cp2, cp3, cp4: float; three-parameter limb darkening coefficients</span>
<span class="sd">    c1, c2, c3, c4: float; non-linear limb-darkening coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You are using the&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ld_model</span><span class="p">),</span> <span class="s1">&#39;limb darkening models.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>

        <span class="n">direc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;Kurucz&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current Directories Entered:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">dirsen</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">direc</span><span class="p">)</span>

        <span class="c1"># Select metallicity</span>
        <span class="n">M_H_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">M_H_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">])</span>
        <span class="n">optM</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">M_H</span> <span class="o">-</span> <span class="n">M_H_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">MH_ind</span> <span class="o">=</span> <span class="n">M_H_Grid_load</span><span class="p">[</span><span class="n">optM</span><span class="p">]</span>

        <span class="c1"># Determine which model is to be used, by using the input metallicity M_H to figure out the file name we need</span>
        <span class="n">direc</span> <span class="o">=</span> <span class="s1">&#39;Kurucz&#39;</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="s1">&#39;kuruczlist.sav&#39;</span>
        <span class="n">sav1</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">file_list</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sav1</span><span class="p">[</span><span class="s1">&#39;li&#39;</span><span class="p">][</span><span class="n">MH_ind</span><span class="p">])</span>  <span class="c1"># Convert object of type &quot;byte&quot; to &quot;string&quot;</span>

        <span class="c1"># Select Teff and subsequently logg</span>
        <span class="n">Teff_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3500</span><span class="p">,</span> <span class="mi">3750</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">4250</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">4750</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5250</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5750</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6250</span><span class="p">,</span> <span class="mi">6500</span><span class="p">])</span>
        <span class="n">optT</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Teff</span> <span class="o">-</span> <span class="n">Teff_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
        <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">4.0</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">138</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">4.5</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">9</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">139</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">140</span><span class="p">])</span>

        <span class="c1"># Where in the model file is the section for the Teff we want? Index T_ind tells us that.</span>
        <span class="n">T_ind</span> <span class="o">=</span> <span class="n">Teff_Grid_load</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span>
        <span class="n">header_rows</span> <span class="o">=</span> <span class="mi">3</span>    <span class="c1"># How many rows in each section we ignore for the data reading</span>
        <span class="n">data_rows</span> <span class="o">=</span> <span class="mi">1221</span>   <span class="c1"># How  many rows of data we read</span>
        <span class="n">line_skip_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">header_rows</span> <span class="o">+</span> <span class="n">T_ind</span> <span class="o">*</span> <span class="n">data_rows</span>   <span class="c1"># Calculate how many lines in the model file we need to skip in order to get to the part we need (for the Teff we want).</span>
        <span class="n">line_skip_header</span> <span class="o">=</span> <span class="n">T_ind</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_rows</span> <span class="o">+</span> <span class="n">header_rows</span><span class="p">)</span>

        <span class="c1"># Read the header, in case we want to have the actual Teff, logg and M_H info.</span>
        <span class="c1"># headerinfo is a pandas object.</span>
        <span class="n">headerinfo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">skiprows</span><span class="o">=</span><span class="n">line_skip_header</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Teff_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logg_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MH_model</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Closest values to your inputs:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Teff: &#39;</span><span class="p">,</span> <span class="n">Teff_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M_H: &#39;</span><span class="p">,</span> <span class="n">MH_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;log(g): &#39;</span><span class="p">,</span> <span class="n">logg_model</span><span class="p">)</span>

        <span class="c1"># Read the data; data is a pandas object.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">skiprows</span><span class="o">=</span><span class="n">line_skip_data</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">data_rows</span><span class="p">)</span>

        <span class="c1"># Unpack the data</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">10</span>   <span class="c1"># Import wavelength data</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="p">(</span><span class="n">ws</span> <span class="o">*</span> <span class="n">ws</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f6</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f7</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f8</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f9</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f10</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f11</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f14</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f15</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f16</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>

        <span class="c1"># Make single big array of them</span>
        <span class="n">fcalc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">f6</span><span class="p">,</span> <span class="n">f7</span><span class="p">,</span> <span class="n">f8</span><span class="p">,</span> <span class="n">f9</span><span class="p">,</span> <span class="n">f10</span><span class="p">,</span> <span class="n">f11</span><span class="p">,</span> <span class="n">f12</span><span class="p">,</span> <span class="n">f13</span><span class="p">,</span> <span class="n">f14</span><span class="p">,</span> <span class="n">f15</span><span class="p">,</span> <span class="n">f16</span><span class="p">])</span>
        <span class="n">phot1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Define mu</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.000</span><span class="p">,</span> <span class="mf">.900</span><span class="p">,</span> <span class="mf">.800</span><span class="p">,</span> <span class="mf">.700</span><span class="p">,</span> <span class="mf">.600</span><span class="p">,</span> <span class="mf">.500</span><span class="p">,</span> <span class="mf">.400</span><span class="p">,</span> <span class="mf">.300</span><span class="p">,</span> <span class="mf">.250</span><span class="p">,</span> <span class="mf">.200</span><span class="p">,</span> <span class="mf">.150</span><span class="p">,</span> <span class="mf">.125</span><span class="p">,</span> <span class="mf">.100</span><span class="p">,</span> <span class="mf">.075</span><span class="p">,</span> <span class="mf">.050</span><span class="p">,</span> <span class="mf">.025</span><span class="p">,</span> <span class="mf">.010</span><span class="p">])</span>

        <span class="c1"># Passed on to main body of function are: ws, fcalc, phot1, mu</span>

    <span class="k">elif</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>

        <span class="n">direc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;3DGrid&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current Directories Entered:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">dirsen</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">direc</span><span class="p">)</span>

        <span class="c1"># Select metallicity</span>
        <span class="n">M_H_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>  <span class="c1"># Available metallicity values in 3D models</span>
        <span class="n">M_H_Grid_load</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;30&#39;</span><span class="p">,</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;00&#39;</span><span class="p">]</span>  <span class="c1"># The according identifiers to individual available M_H values</span>
        <span class="n">optM</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">M_H</span> <span class="o">-</span> <span class="n">M_H_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># Find index at which the closes M_H values from available values is to the input M_H.</span>

        <span class="c1"># Select Teff</span>
        <span class="n">Teff_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5777</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span> <span class="mi">7000</span><span class="p">])</span>  <span class="c1"># Available Teff values in 3D models</span>
        <span class="n">optT</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Teff</span> <span class="o">-</span> <span class="n">Teff_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># Find index at which the Teff values is, that is closest to input Teff.</span>

        <span class="c1"># Select logg, depending on Teff. If several logg possibilities are given for one Teff, pick the one that is</span>
        <span class="c1"># closest to user input (logg).</span>

        <span class="k">if</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5777</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.4</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Select Teff and Log g. Mtxt, Ttxt and Gtxt are then put together as string to load correct files.</span>
        <span class="n">Mtxt</span> <span class="o">=</span> <span class="n">M_H_Grid_load</span><span class="p">[</span><span class="n">optM</span><span class="p">]</span>
        <span class="n">Ttxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:2.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5777</span><span class="p">:</span>
            <span class="n">Ttxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:4.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">])</span>
        <span class="n">Gtxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:2.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;mmu_t&#39;</span> <span class="o">+</span> <span class="n">Ttxt</span> <span class="o">+</span> <span class="s1">&#39;g&#39;</span> <span class="o">+</span> <span class="n">Gtxt</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">Mtxt</span> <span class="o">+</span> <span class="s1">&#39;v05.flx&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Filename:&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

        <span class="c1"># Read data from IDL .sav file</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>  <span class="c1"># readsav reads an IDL .sav file</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># read in wavelength</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flx</span>  <span class="c1"># read in flux</span>
        <span class="n">Teff_model</span> <span class="o">=</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span>
        <span class="n">logg_model</span> <span class="o">=</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">M_H_Grid</span><span class="p">[</span><span class="n">optM</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Closest values to your inputs:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Teff  : &#39;</span><span class="p">,</span> <span class="n">Teff_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M_H   : &#39;</span><span class="p">,</span> <span class="n">MH_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;log(g): &#39;</span><span class="p">,</span> <span class="n">logg_model</span><span class="p">)</span>

        <span class="n">f0</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">f6</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">f7</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">f8</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">f9</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">f10</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

        <span class="c1"># Make single big array of them</span>
        <span class="n">fcalc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">f6</span><span class="p">,</span> <span class="n">f7</span><span class="p">,</span> <span class="n">f8</span><span class="p">,</span> <span class="n">f9</span><span class="p">,</span> <span class="n">f10</span><span class="p">])</span>
        <span class="n">phot1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Mu from grid</span>
        <span class="c1"># 0.00000    0.0100000    0.0500000     0.100000     0.200000     0.300000   0.500000     0.700000     0.800000     0.900000      1.00000</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mu</span>

        <span class="c1"># Passed on to main body of function are: ws, fcalc, phot1, mu</span>

    <span class="c1"># Load response function and interpolate onto kurucz model grid</span>

    <span class="c1"># FOR STIS</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G430L&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G430L.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens,sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G750M&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G750M.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mf">0.554</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G750L&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G750L.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mf">4.882</span>

    <span class="c1"># FOR WFC3</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G141&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G141.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G102&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G141.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G280&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G280.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># FOR JWST</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;NIRSpecPrism&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">widek</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">))</span>
    <span class="n">wsHST</span> <span class="o">=</span> <span class="n">wssens</span>
    <span class="n">wsHST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsHST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsHST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">]),</span>
                            <span class="n">wsHST</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsHST</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsHST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">,</span>
                                      <span class="n">wsHST</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsHST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">])))</span>

    <span class="n">respoutHST</span> <span class="o">=</span> <span class="n">sensitivity</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">)</span>
    <span class="n">respoutHST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">respoutHST</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">inter_resp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wsHST</span><span class="p">,</span> <span class="n">respoutHST</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">respout</span> <span class="o">=</span> <span class="n">inter_resp</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>  <span class="c1"># interpolate sensitivity curve onto model wavelength grid</span>

    <span class="n">wsdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">]),</span> <span class="n">wsdata</span><span class="p">,</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsdata</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">])))</span>
    <span class="n">respwavebin</span> <span class="o">=</span> <span class="n">wsdata</span> <span class="o">/</span> <span class="n">wsdata</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="n">widek</span> <span class="o">=</span> <span class="n">widek</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># need to add two indicies to compensate for padding with 2 zeros</span>
    <span class="n">respwavebin</span><span class="p">[</span><span class="n">widek</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">data_resp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wsdata</span><span class="p">,</span> <span class="n">respwavebin</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">reswavebinout</span> <span class="o">=</span> <span class="n">data_resp</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>  <span class="c1"># interpolate data onto model wavelength grid</span>

    <span class="c1"># Integrate over the spectra to make synthetic photometric points.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># Loop over spectra at diff angles</span>
        <span class="n">fcal</span> <span class="o">=</span> <span class="n">fcalc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">Tot</span> <span class="o">=</span> <span class="n">int_tabulated</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">ws</span> <span class="o">*</span> <span class="n">respout</span> <span class="o">*</span> <span class="n">reswavebinout</span><span class="p">)</span>
        <span class="n">phot1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_tabulated</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">ws</span> <span class="o">*</span> <span class="n">respout</span> <span class="o">*</span> <span class="n">reswavebinout</span> <span class="o">*</span> <span class="n">fcal</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">/</span> <span class="n">Tot</span>

    <span class="k">if</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
        <span class="n">yall</span> <span class="o">=</span> <span class="n">phot1</span> <span class="o">/</span> <span class="n">phot1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
        <span class="n">yall</span> <span class="o">=</span> <span class="n">phot1</span> <span class="o">/</span> <span class="n">phot1</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

    <span class="c1"># Co = np.zeros((6, 4))   # NOT-REUSED</span>

    <span class="c1"># A = [0.0, 0.0, 0.0, 0.0]  # c1, c2, c3, c4      # NOT-REUSED</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>     <span class="c1"># wavelength</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">yall</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>   <span class="c1"># flux</span>
    <span class="c1"># weights = x / x   # NOT-REUSED</span>

    <span class="c1"># Start fitting the different models</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="c1"># Fit a four parameter non-linear limb darkening model and get fitted variables, c1, c2, c3, c4.</span>
    <span class="n">corot_4_param</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>
    <span class="n">corot_4_param</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">corot_4_param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="n">corot_4_param</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Fit a three parameter non-linear limb darkening model and get fitted variables, cp2, cp3, cp4 (cp1 = 0).</span>
    <span class="n">corot_3_param</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>
    <span class="n">corot_3_param</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 3 param is just 4 param with c0 = 0.0</span>
    <span class="n">corot_3_param</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">corot_3_param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span> <span class="o">=</span> <span class="n">corot_3_param</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Fit a quadratic limb darkening model and get fitted parameters aLD and bLD.</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">quadratic_limb_darkening</span><span class="p">()</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">quadratic</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">quadratic</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Fit a linear limb darkening model and get fitted variable uLD.</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c2</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c3</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">uLD</span> <span class="o">=</span> <span class="n">linear</span><span class="o">.</span><span class="n">c1</span><span class="o">.</span><span class="n">value</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Limb darkening parameters:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4param </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3param </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quad </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uLD</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span>


<span class="k">def</span> <span class="nf">int_tabulated</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">Xsegments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Sort vectors into ascending order.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">Xsegments</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Xsegments</span> <span class="o">=</span> <span class="n">Xsegments</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">Xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">Xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># Uniform step size.</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xmax</span> <span class="o">+</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">Xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">Xsegments</span>
    <span class="c1"># Compute the interpolates at Xgrid.</span>
    <span class="c1"># x values of interpolates &gt;&gt; Xgrid = h * FINDGEN(Xsegments + 1L) + Xmin</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xsegments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xmin</span><span class="p">,</span> <span class="n">splrep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>

    <span class="c1"># Compute the integral using the 5-point Newton-Cotes formula.</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="mf">7.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">+</span> <span class="mf">32.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mf">12.0</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">45.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="now-define-the-transit-model-function">
<h2>Now define the transit model function<a class="headerlink" href="#now-define-the-transit-model-function" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">occultnl</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MANDEL &amp; AGOL (2002) transit model.</span>
<span class="sd">    :param rl: float, transit depth (Rp/R*)</span>
<span class="sd">    :param c1: float, limb darkening parameter 1</span>
<span class="sd">    :param c2: float, limb darkening parameter 2</span>
<span class="sd">    :param c3: float, limb darkening parameter 3</span>
<span class="sd">    :param c4: float, limb darkening parameter 4</span>
<span class="sd">    :param b0: impact parameter in stellar radii</span>
<span class="sd">    :return: mulimb0: limb-darkened transit model, mulimbf: lightcurves for each component that you put in the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mulimb0</span> <span class="o">=</span> <span class="n">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">rl</span><span class="p">)</span>
    <span class="n">bt0</span> <span class="o">=</span> <span class="n">b0</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mulimb0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># DKS edit</span>

    <span class="n">omega</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c3</span> <span class="o">-</span> <span class="n">c4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">/</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">c4</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mulimb0</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">mulimb</span> <span class="o">=</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
    <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">1.</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.8</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">7</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dmumax</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">dmumax</span> <span class="o">&gt;</span> <span class="n">fac</span> <span class="o">*</span> <span class="mf">1.e-3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">131072</span><span class="p">):</span>
        <span class="c1"># print(nr)</span>
        <span class="n">mulimbp</span> <span class="o">=</span> <span class="n">mulimb</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">nr</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">mulimbhalf</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb1</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb3half</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb2</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr</span><span class="p">):</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rl</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sig1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="n">sig2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimbhalf</span> <span class="o">=</span> <span class="n">mulimbhalf</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb1</span> <span class="o">=</span> <span class="n">mulimb1</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb3half</span> <span class="o">=</span> <span class="n">mulimb3half</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb2</span> <span class="o">=</span> <span class="n">mulimb2</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">mulimb</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c3</span> <span class="o">-</span> <span class="n">c4</span><span class="p">)</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span>
            <span class="n">indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">mulimbhalf</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">mulimb1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span> <span class="n">mulimb3half</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">mulimb2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">omega</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mulimb</span> <span class="o">+</span> <span class="n">mulimbp</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ix1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ix1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># print(ix1)</span>
        <span class="c1"># python cannot index on single values so you need to use atlest_1d for the below to work when mulimb is a single value</span>
        <span class="n">dmumax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimbp</span><span class="p">)[</span><span class="n">ix1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimbp</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]))</span>

    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb0</span><span class="p">)[</span><span class="n">indx</span><span class="p">]</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimbhalf</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb1</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb3half</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb2</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb0</span><span class="p">)[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">bt0</span>

    <span class="k">return</span> <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span>


<span class="k">def</span> <span class="nf">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the lightcurve for occultation of a uniform source without microlensing (Mandel &amp; Agol 2002).</span>

<span class="sd">    :param b0: array; impact parameter in units of stellar radii</span>
<span class="sd">    :param w: array; occulting star size in units of stellar radius</span>
<span class="sd">    :return: muo1: float; fraction of flux at each b0 for a uniform source</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-3</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b0</span><span class="p">))</span>
    <span class="n">muo1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">):</span>
        <span class="c1"># substitute z=b0(i) to shorten expressions</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b0</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># z = z.value    # stripping it of astropy units</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">+</span><span class="n">w</span><span class="p">:</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">+</span><span class="n">w</span><span class="p">:</span>
            <span class="n">kap1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)))</span>
            <span class="n">kap0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">w</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)))</span>
            <span class="n">lambdae</span> <span class="o">=</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kap0</span> <span class="o">+</span> <span class="n">kap1</span>
            <span class="n">lambdae</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambdae</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lambdae</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">:</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">muo1</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data">
<h2>Now define the function to generate the transit light curve and compare it to the data<a class="headerlink" href="#now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Functions to call and calculate models</span>
<span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">):</span>
    <span class="c1"># calculate new orbit</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Select indicies between first and fourth contact</span>
    <span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
    <span class="c1"># Make light curve model, set all values initially to 1.0</span>
    <span class="n">light_curve</span> <span class="o">=</span> <span class="n">b0</span><span class="o">/</span><span class="n">b0</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">intransit</span><span class="p">])</span>  <span class="c1"># Madel and Agol</span>
    <span class="n">light_curve</span><span class="p">[</span><span class="n">intransit</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb0</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="n">light_curve</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">phase</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shx</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shx</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span> <span class="o">*</span> <span class="n">shx</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">common_mode</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># transit model is baseline flux X transit model X systematics model</span>
    <span class="n">chi2now</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rprs: &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;current chi^2=&quot;</span><span class="p">,</span> <span class="n">chi2now</span><span class="p">,</span> <span class="s1">&#39; scatter &#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">/</span><span class="n">err</span>
    <span class="c1"># return np.sum((y-model)**2/err**2)</span>
</pre></div>
</div>
</div>
</div>
<p>A function is also defined to return just the transit model <span class="math notranslate nohighlight">\(T(t,\theta)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_fine</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>  <span class="c1"># Make Transit model with a fine grid for plotting purposes</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase_fine</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase_fine</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>  <span class="c1"># Madel and Agol</span>
    <span class="n">model_fine</span> <span class="o">=</span> <span class="n">mulimb0</span>
    <span class="k">return</span> <span class="n">model_fine</span>
</pre></div>
</div>
</div>
</div>
<p>Now add a transit model to the Example Light curve.  Here, weâ€™ve compute the limb darkening coefficients, then use them in the transit light curve.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wave1</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">]</span>
<span class="n">wave2</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">]</span>
<span class="n">bin_wave_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">wsdata_all</span> <span class="o">&gt;</span> <span class="n">wave1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wsdata_all</span> <span class="o">&lt;=</span> <span class="n">wave2</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
<span class="n">wsdata</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">bin_wave_index</span><span class="p">]</span><span class="o">*</span><span class="mf">1E4</span> <span class="c1"># Select wavelength bin values (um=&gt; angstroms)</span>

<span class="n">_uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">_cp1</span><span class="p">,</span> <span class="n">_cp2</span><span class="p">,</span> <span class="n">_cp3</span><span class="p">,</span> <span class="n">_cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">limb_dark_directory</span><span class="p">,</span> <span class="n">ld_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.87682090	-0.73755228	0.57723174	-0.19560435
3param 	2.19231542	-3.11195060	1.36536769
Quad 	0.02781785	0.37167814
Linear 	0.34303525
</pre></div>
</div>
</div>
</div>
<p>Now run the transit model.</p>
<p>The transit parameters such as inclination and <span class="math notranslate nohighlight">\(a/R_{star}\)</span> have been setup at the beginning of the notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the Transit Model</span>
<span class="n">rl</span> <span class="o">=</span> <span class="mf">0.0825</span>     <span class="c1"># Planet-to-star Radius Ratio</span>

<span class="n">b0</span> <span class="o">=</span> <span class="n">a_Rs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">rl</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># Select indicies between first and fourth contact</span>

<span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>  <span class="c1"># Mandel &amp; Agol non-linear limb darkened transit model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">mulimb0</span><span class="o">*</span><span class="n">yfit</span> 

<span class="c1"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S(x)$ Regression fit &#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
<span class="c1"># Residual</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wsb_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">wsb</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (ppm)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># print chi^2 value</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chi^2 = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Residual Standard Deviation : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; ppm&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;256 Bin Standard Deviation  :&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wsb</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; ppm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/1695522111.py:16: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(bjd, y/np.mean(y[outtransit]), label=&#39;$f(t)$ Data&#39;, zorder=1, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/1695522111.py:32: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(bjd, 1E6*(y/np.mean(y[outtransit])-model), label=&#39;$f(t)$ Data&#39;, zorder=1, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<img alt="../../_images/1d0de8bceb13e1a98ab2810cb27ab50989da08175af2d90da646c900a60f1bc8.png" src="../../_images/1d0de8bceb13e1a98ab2810cb27ab50989da08175af2d90da646c900a60f1bc8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Chi^2 = 9265.443817708492
Residual Standard Deviation : 789.8093583096888 ppm
256 Bin Standard Deviation  :196.83309935696437 ppm
</pre></div>
</div>
</div>
</div>
<p>Note that the model transit depth is a little too deep compared to the data. The planet radius needs to be smaller, and the parameter <span class="math notranslate nohighlight">\(rl\)</span> is closer to 0.08.  As an exercise you can re-run the above cell changing the planet radius to <span class="math notranslate nohighlight">\(rl\)</span>=0.0805 and compare the <span class="math notranslate nohighlight">\(\chi^2\)</span> value to the previous default value (<span class="math notranslate nohighlight">\(\chi^2\)</span>=9265.4 at <span class="math notranslate nohighlight">\(rl\)</span> = 0.0825).</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="fit-transit-light-curves">
<h1>FIT Transit Light Curves<a class="headerlink" href="#fit-transit-light-curves" title="Permalink to this heading">#</a></h1>
<p>Now we can fit each light curve, optimizing the fit parameters with a least-squares fit. Here a Levenberg-Marquart fit is used to find a <span class="math notranslate nohighlight">\(\chi^2\)</span> minimum and estimate uncertainties using the lmfit package (https://lmfit.github.io/lmfit-py/fitting.html).</p>
<p>In practice, first we would fit the white light curve, which consists of summing over all of the wavelengths in the entire 1D spectra.  This can then be used to fit for the system parameters such as inclination and transit time, and then the spectroscopic channels are then fixed to these values as they are wavelength-independent.  However, the CV3 data required the overall variations of the lamp to be removed, which prevents our use of using this data for a white light curve analysis.  Here, we proceed to fitting for the spectroscopic light curve bins.</p>
<p>The steps are as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1) Wavelength Bin is selected

2) Limb-darkening coefficients are calculated from a stellar model for each bin. 

3) An initial linear regression is performed on the out-of-transit data to start the 
systematic fit parameters, this greatly speeds up the fit as those parameters start 
near their global minimum.

4) The fit is started, and some statistics are output during the minimization

5) Once the best-fit is found, a number of statistics are displayed 

6) Finally, several plots are generated which are stored as PDFs and the next bin is started.
</pre></div>
</div>
<p>These steps are performed for each spectral bin.</p>
<p>In this example, the planet radius is set to vary in the fit along with the baseline flux and instrument systematic parameters.</p>
<section id="setup-wavelengths-to-fit-over">
<h2>Setup Wavelengths to fit over<a class="headerlink" href="#setup-wavelengths-to-fit-over" title="Permalink to this heading">#</a></h2>
<p>The spectra must be binned in wavelength to get sufficient counts to reach ~100 ppm levels needed.
The spectra has significant counts from about pixel 100 to 400, we start at pixel <span class="math notranslate nohighlight">\(k0\)</span> and bin the spectra by <span class="math notranslate nohighlight">\(wk\)</span> pixels.</p>
<p>Several arrays are also defined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k0</span> <span class="o">=</span> <span class="mi">113</span> <span class="c1"># 98   #100</span>
<span class="n">kend</span> <span class="o">=</span> <span class="mi">392</span> <span class="c1"># 422</span>
<span class="n">wk</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">number_of_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">kend</span><span class="o">-</span><span class="n">k0</span><span class="p">)</span><span class="o">/</span><span class="n">wk</span><span class="p">)</span>
<span class="n">wsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">werr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">rprs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">rerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">sig_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">sig_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">depth_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loop-over-wavelength-bins-fitting-each-lightcurve">
<h2>Loop Over Wavelength Bins Fitting Each Lightcurve<a class="headerlink" href="#loop-over-wavelength-bins-fitting-each-lightcurve" title="Permalink to this heading">#</a></h2>
<section id="note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin">
<h3>Note this step takes considerable time to complete (~20 min, few minutes/bin)<a class="headerlink" href="#note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin" title="Permalink to this heading">#</a></h3>
<p>Each wavelength bin is fit for the transit+systematics model. Various outputs including plots are saved.
Can skip to the next cells to load pre-computed results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">k0</span>   <span class="c1"># wavelength to start</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Loop over wavelength bins and fit for each one</span>
<span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_bins</span><span class="p">):</span>
    
    <span class="c1"># Select wavelength bin</span>
    <span class="n">wave1</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">wave2</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">wk</span><span class="p">]</span>

    <span class="c1"># Indicies to select for wavelgth bin</span>
    <span class="n">bin_wave_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">wsdata_all</span> <span class="o">&gt;</span> <span class="n">wave1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wsdata_all</span> <span class="o">&lt;=</span> <span class="n">wave2</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>

    <span class="c1"># make light curve bin</span>
    <span class="n">wave_bin_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec_1D</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">wk</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Sum Wavelength pixels</span>
    <span class="n">wave_bin_counts_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wave_bin_counts</span><span class="p">)</span>            <span class="c1"># adopt photon noise for errors</span>

    <span class="c1"># Calculate Limb Darkening</span>

    <span class="n">wsdata</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">bin_wave_index</span><span class="p">]</span><span class="o">*</span><span class="mf">1E4</span> <span class="c1"># Select wavelength bin values (um=&gt; angstroms)</span>
    <span class="n">_uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">_cp1</span><span class="p">,</span> <span class="n">_cp2</span><span class="p">,</span> <span class="n">_cp3</span><span class="p">,</span> <span class="n">_cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">limb_dark_directory</span><span class="p">,</span> <span class="n">ld_model</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">c1 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c2 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c3 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c3</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c4 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># u   = [c1,c2,c3,c4]      # limb darkening coefficients</span>
    <span class="c1"># u = [aLD, bLD]</span>

    <span class="c1"># Make initial model</span>
    
    <span class="c1"># Setup LMFIT</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bjd</span>                    <span class="c1"># X data</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">wave_bin_counts</span>        <span class="c1"># Y data</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">wave_bin_counts_err</span>  <span class="c1"># Y Error</span>

    <span class="c1"># Perform Quick Linear regression on out-of-transit data to obtain accurate starting Detector fit values</span>
    <span class="k">if</span> <span class="n">wave1</span> <span class="o">&gt;</span> <span class="mf">2.7</span> <span class="ow">and</span> <span class="n">wave1</span> <span class="o">&lt;</span> <span class="mf">3.45</span><span class="p">:</span>
        <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XXX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>

    <span class="c1"># create a set of Parameters for LMFIT https://lmfit.github.io/lmfit-py/parameters.html</span>
    <span class="c1"># class Parameter(name, value=None, vary=True, min=- inf, max=inf, expr=None, brute_step=None, user_data=None)Â¶</span>
    <span class="c1"># Set vary=0 to fix</span>
    <span class="c1"># Set vary=1 to fit</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>  <span class="c1"># object to store L-M fit Parameters           # Parameter Name</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;cosinc&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">),</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># inclination, vary cos(inclin)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;rho_star&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">rho_star</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># stellar density</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">a_Rs</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># a/Rstar</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;rprs&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">rp</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># planet-to-star radius ratio</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># Transit T0</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;f0&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>         <span class="c1"># Baseline Flux</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ecc&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ecc</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># eccentricity</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># arguments of periatron</span>
    <span class="c1"># Turn on a linear slope in water feature to account for presumably changing H2O ice builtup on widow during cryogenic test</span>
    <span class="k">if</span> <span class="n">wave1</span> <span class="o">&gt;</span> <span class="mf">2.7</span> <span class="ow">and</span> <span class="n">wave1</span> <span class="o">&lt;</span> <span class="mf">3.45</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Fslope&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Orbital phase</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Fslope&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                          <span class="c1"># Orbital phase</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;xsh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                 <span class="c1"># Detector X-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ysh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                 <span class="c1"># Detector X-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x2sh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Detector X^2-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;y2sh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Detector Y^2-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;xysh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Detector X*Y detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;comm&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Common-Mode detrending</span>
    
    <span class="c1"># Perform Minimization https://lmfit.github.io/lmfit-py/fitting.html</span>
    <span class="c1"># create Minimizer</span>
    <span class="c1"># mini = lmfit.Minimizer(residual, p, nan_policy=&#39;omit&#39;,fcn_args=(phase,x,y,err)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting Bin&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="s1">&#39; Wavelength =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span><span class="o">/</span><span class="mf">1E4</span><span class="p">,</span> <span class="s1">&#39;  Range= [&#39;</span><span class="p">,</span> <span class="n">wave1</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">wave2</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>

    <span class="c1">#  solve with Levenberg-Marquardt using the</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">))</span>
    <span class="c1"># result = mini.minimize(method=&#39;emcee&#39;)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Re-Fitting Bin&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="s1">&#39; Wavelength =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span><span class="o">/</span><span class="mf">1E4</span><span class="p">,</span> <span class="s1">&#39;  Range= [&#39;</span><span class="p">,</span> <span class="n">wave1</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">wave2</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="c1"># --------------------------------------------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;redchi&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">redchi</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chi2&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">chisqr</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nfree&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">nfree</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bic&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">bic</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aic&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">aic</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L-M FIT Variable&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_statistics.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">redchi &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">redchi</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">chi2   &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">chisqr</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">nfree  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">nfree</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">bic    &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">bic</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">aic    &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">aic</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="c1"># file-output.py</span>

    <span class="c1"># Update with best-fit parameters</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rho_star&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rho_star&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="c1"># Update Fit Spectra arrays</span>
    <span class="n">wsd</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span><span class="o">/</span><span class="mf">1E4</span>
    <span class="n">werr</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wsdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wsdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mf">2E4</span>
    <span class="n">rprs</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">rerr</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>

    <span class="c1"># Calculate Bestfit Model</span>
    <span class="n">final_model</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">result</span><span class="o">.</span><span class="n">residual</span><span class="o">*</span><span class="n">err</span>
    <span class="n">final_model_fine</span> <span class="o">=</span> <span class="n">model_fine</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># More Stats</span>
    <span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">residppm</span> <span class="o">=</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">residerr</span> <span class="o">=</span> <span class="n">err</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="mf">1E6</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Residual standard deviation  (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Photon noise                 (ppm) : &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Photon noise performance       (%) : &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Residual standard deviation  (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Photon noise                 (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Photon noise performance       (%) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
 
    <span class="c1"># Measure Rednoise with Binning Technique</span>
    <span class="n">sig0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">number_of_images</span> <span class="o">/</span> <span class="n">binmeasure</span>
    <span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">sig_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wsb</span><span class="p">)</span>
    <span class="n">sigrednoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig_binned</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">binmeasure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigrednoise</span><span class="p">):</span>
        <span class="n">sigrednoise</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># if no rednoise detected, set to zero</span>
    <span class="n">sigwhite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">sigrednoise</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigrednoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig_binned</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">sigwhite</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">binmeasure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigrednoise</span><span class="p">):</span> 
        <span class="n">sigrednoise</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># if no rednoise detected, set to zero</span>
    <span class="n">beta</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">binmeasure</span><span class="o">*</span><span class="n">sigrednoise</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">sig0</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;White noise                  (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">sigwhite</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Red noise                    (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">sigrednoise</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transit depth measured error (ppm) : &quot;</span><span class="p">,</span> <span class="mf">2E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">White noise                  (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">sigwhite</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Red noise                    (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">sigrednoise</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transit depth measured error (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">2E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>
    <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">depth</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">depth_err</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>

    <span class="n">sig_r</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigrednoise</span><span class="o">*</span><span class="mf">1E6</span>
    <span class="n">sig_w</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigwhite</span><span class="o">*</span><span class="mf">1E6</span>
    <span class="c1"># --------------------------------------------------------------------------</span>
    <span class="c1"># ---------------------------------------------------------</span>
    <span class="c1"># Write Fit Spectra to ascii file</span>
    <span class="n">ascii_data</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">wsd</span><span class="p">,</span> <span class="n">werr</span><span class="p">,</span> <span class="n">rprs</span><span class="p">,</span> <span class="n">rerr</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_err</span><span class="p">,</span> <span class="n">sig_w</span><span class="p">,</span> <span class="n">sig_r</span><span class="p">,</span> <span class="n">beta</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Wavelength Center (um)&#39;</span><span class="p">,</span> <span class="s1">&#39;Wavelength half-width (um)&#39;</span><span class="p">,</span> <span class="s1">&#39;Rp/Rs&#39;</span><span class="p">,</span> <span class="s1">&#39;Rp/Rs 1-sigma error&#39;</span><span class="p">,</span> <span class="s1">&#39;Transit Depth (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Transit Depth error&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma_white (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma_red (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta Rednoise Inflation factor&#39;</span><span class="p">])</span>
    <span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ascii_data</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_transmission_spectra.csv&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># ---------------------------------------------------------</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span> <span class="c1"># default marker size</span>
    <span class="c1"># Plot data models</span>
     
    <span class="c1"># plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">final_model</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wave1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wave2</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>
    <span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
    <span class="c1"># Residual</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">residppm</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
    <span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">residppm</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wsb_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">wsb</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (ppm)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="o">-</span><span class="n">sigma</span><span class="p">,</span> <span class="o">-</span><span class="n">sigma</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
    <span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
    <span class="c1"># save</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_lightcurve.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>   
    
    <span class="c1"># plot systematic corrected light curve</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
    <span class="n">light_curve</span> <span class="o">=</span> <span class="n">b0</span><span class="o">/</span><span class="n">b0</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">intransit</span><span class="p">])</span>  <span class="c1"># Madel and Agol</span>
    <span class="n">light_curve</span><span class="p">[</span><span class="n">intransit</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb0</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">light_curve</span><span class="o">+</span><span class="n">resid</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;BJD&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">light_curve</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_corrected.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="c1"># close all figures</span>
    <span class="c1"># --------------------------------------------------------------------------</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">wk</span>  <span class="c1"># step wavelength index to next bin</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** Can Now View Output PDFs in &#39;</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.93487505	-0.53100613	0.43228652	-0.16656941
3param 	2.59284758	-3.50115591	1.49775430
Quad 	0.08088643	0.45654030
Linear 	0.46807479

c1 = 0.9348750506946152
c2 = -0.531006129789577
c3 = 0.43228651640755095
c4 = -0.1665694117104222


Fitting Bin 0  Wavelength = 1.5502650866666667   Range= [ 1.3906398 : 1.6900786 ]
rprs:  0.07869514581104897 current chi^2= 13085.417569552985  scatter  0.0023922892879259575
Re-Fitting Bin 0  Wavelength = 1.5502650866666667   Range= [ 1.3906398 : 1.6900786 ]

redchi 1.5989024400724565
chi2 13085.417569552985
nfree 8184
bic 3908.7316936329157
aic 3852.644386854681
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.07869515 +/- 5.4580e-04 (0.69%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        278433.709 +/- 22.2711416 (0.01%) (init = 278410.6)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:      -0.00112032 +/- 9.9569e-05 (8.89%) (init = -0.001091413)
    ysh:       3.3601e-05 +/- 9.2623e-05 (275.66%) (init = 0.0002380423)
    x2sh:     -4.1703e-04 +/- 2.2616e-04 (54.23%) (init = -0.0003157139)
    y2sh:     -3.3390e-04 +/- 2.2424e-04 (67.16%) (init = -0.0001744718)
    xysh:      6.7719e-04 +/- 4.4533e-04 (65.76%) (init = 0.0003395803)
    comm:      5.4547e-04 +/- 8.2561e-05 (15.14%) (init = 0.0002697908)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9755
    C(x2sh, y2sh) = +0.9376
    C(rprs, f0)   = +0.8090
    C(xsh, ysh)   = -0.6325
    C(xsh, comm)  = -0.4878
    C(f0, x2sh)   = -0.3857
    C(f0, y2sh)   = -0.3280
    C(ysh, comm)  = -0.3010
    C(f0, xysh)   = +0.2739
    C(xsh, x2sh)  = +0.2427
    C(xsh, xysh)  = -0.2134
    C(rprs, x2sh) = -0.1917
    C(xysh, comm) = +0.1795
    C(xsh, y2sh)  = +0.1757
    C(x2sh, comm) = -0.1724
    C(rprs, xsh)  = -0.1644
    C(y2sh, comm) = -0.1486
    C(rprs, y2sh) = -0.1369
    C(rprs, ysh)  = +0.1341
    C(f0, xsh)    = -0.1185
Residual standard deviation  (ppm) :  2392.2892879259575
Photon noise                 (ppm) :  1895.1303791648108
Photon noise performance       (%) :  79.21827802054122
White noise                  (ppm) :  2387.129444269294
Red noise                    (ppm) :  157.34479866780455
Transit depth measured error (ppm) :  85.90311947299497
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	1.12080976	-0.97843713	0.75312858	-0.25673953
3param 	2.76671119	-3.96262532	1.73859692
Quad 	0.01052393	0.47328324
Linear 	0.41191184

c1 = 1.1208097603789067
c2 = -0.9784371279899322
c3 = 0.7531285754201472
c4 = -0.25673952710770237


Fitting Bin 1  Wavelength = 1.84545072   Range= [ 1.6900786 : 1.9783379 ]
rprs:  0.08047594288462401 current chi^2= 14107.324261909878  scatter  0.0015893597541472527
Re-Fitting Bin 1  Wavelength = 1.84545072   Range= [ 1.6900786 : 1.9783379 ]

redchi 1.7237688492069743
chi2 14107.324261909878
nfree 8184
bic 4524.734590843977
aic 4468.6472840657425
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08047594 +/- 3.5164e-04 (0.44%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        679862.651 +/- 36.2424305 (0.01%) (init = 679718.7)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:      -0.00119414 +/- 6.6177e-05 (5.54%) (init = -0.001210365)
    ysh:      -5.0144e-04 +/- 6.1567e-05 (12.28%) (init = -0.0004319937)
    x2sh:     -1.1190e-04 +/- 1.5033e-04 (134.34%) (init = -8.991835e-05)
    y2sh:     -6.4121e-05 +/- 1.4905e-04 (232.45%) (init = -1.47937e-05)
    xysh:     -3.4284e-05 +/- 2.9598e-04 (863.31%) (init = -0.0001337487)
    comm:      0.00107817 +/- 5.4864e-05 (5.09%) (init = 0.001005529)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9755
    C(x2sh, y2sh) = +0.9376
    C(rprs, f0)   = +0.8102
    C(xsh, ysh)   = -0.6328
    C(xsh, comm)  = -0.4875
    C(f0, x2sh)   = -0.3863
    C(f0, y2sh)   = -0.3290
    C(ysh, comm)  = -0.3011
    C(f0, xysh)   = +0.2747
    C(xsh, x2sh)  = +0.2431
    C(xsh, xysh)  = -0.2139
    C(rprs, x2sh) = -0.1930
    C(xysh, comm) = +0.1791
    C(xsh, y2sh)  = +0.1762
    C(x2sh, comm) = -0.1719
    C(rprs, xsh)  = -0.1654
    C(y2sh, comm) = -0.1482
    C(rprs, y2sh) = -0.1388
    C(rprs, ysh)  = +0.1364
    C(f0, xsh)    = -0.1196
Residual standard deviation  (ppm) :  1589.3597541472527
Photon noise                 (ppm) :  1212.8006148401325
Photon noise performance       (%) :  76.3074949944761
White noise                  (ppm) :  1588.7050679155338
Red noise                    (ppm) :  45.70298419235961
Transit depth measured error (ppm) :  56.59740034216333
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	1.05423283	-0.97018497	0.77456621	-0.26658145
3param 	2.55249877	-3.66106843	1.61023054
Quad 	0.01394080	0.43332492
Linear 	0.38144036

c1 = 1.0542328323187433
c2 = -0.9701849696940038
c3 = 0.7745662054908382
c4 = -0.2665814455066517


Fitting Bin 2  Wavelength = 2.1223476199999998   Range= [ 1.9783379 : 2.2448517 ]
rprs:  0.07999433245668902 current chi^2= 12525.313078681707  scatter  0.0012094149112427549
Re-Fitting Bin 2  Wavelength = 2.1223476199999998   Range= [ 1.9783379 : 2.2448517 ]

redchi 1.530463474912232
chi2 12525.313078681706
nfree 8184
bic 3550.3578704200436
aic 3494.270563641809
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.07999433 +/- 2.6809e-04 (0.34%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        1042975.58 +/- 42.3147415 (0.00%) (init = 1043280)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:      -7.4025e-04 +/- 5.0367e-05 (6.80%) (init = -0.0006767627)
    ysh:      -3.6016e-04 +/- 4.6857e-05 (13.01%) (init = -0.0003522163)
    x2sh:      1.4337e-04 +/- 1.1440e-04 (79.80%) (init = 0.0001534885)
    y2sh:      3.2762e-04 +/- 1.1343e-04 (34.62%) (init = 0.0003162653)
    xysh:     -3.3426e-04 +/- 2.2524e-04 (67.38%) (init = -0.0003427445)
    comm:      7.9760e-04 +/- 4.1747e-05 (5.23%) (init = 0.0007132)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9755
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8104
    C(xsh, ysh)   = -0.6329
    C(xsh, comm)  = -0.4874
    C(f0, x2sh)   = -0.3866
    C(f0, y2sh)   = -0.3294
    C(ysh, comm)  = -0.3010
    C(f0, xysh)   = +0.2751
    C(xsh, x2sh)  = +0.2435
    C(xsh, xysh)  = -0.2142
    C(rprs, x2sh) = -0.1935
    C(xysh, comm) = +0.1793
    C(xsh, y2sh)  = +0.1765
    C(x2sh, comm) = -0.1721
    C(rprs, xsh)  = -0.1669
    C(y2sh, comm) = -0.1484
    C(rprs, y2sh) = -0.1393
    C(rprs, ysh)  = +0.1378
    C(f0, xsh)    = -0.1209
    C(rprs, xysh) = +0.1004
Residual standard deviation  (ppm) :  1209.414911242755
Photon noise                 (ppm) :  979.1808909666712
Photon noise performance       (%) :  80.96318987505265
White noise                  (ppm) :  1206.4904195622446
Red noise                    (ppm) :  84.21931993071638
Transit depth measured error (ppm) :  42.890979153541636
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.93455579	-0.84286559	0.70782403	-0.25114311
3param 	2.27992131	-3.22427512	1.41261223
Quad 	0.03322149	0.38713152
Linear 	0.36154478

c1 = 0.9345557878924728
c2 = -0.842865591448989
c3 = 0.7078240285892669
c4 = -0.25114311341177076


Fitting Bin 3  Wavelength = 2.377201606666667   Range= [ 2.2448517 : 2.4898652 ]
rprs:  0.08152564128527812 current chi^2= 10199.771177809664  scatter  0.001054037346435932
Re-Fitting Bin 3  Wavelength = 2.377201606666667   Range= [ 2.2448517 : 2.4898652 ]

redchi 1.2463063511497634
chi2 10199.771177809664
nfree 8184
bic 1867.832838218284
aic 1811.7455314400497
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08152564 +/- 2.2958e-04 (0.28%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        1117867.74 +/- 39.5908739 (0.00%) (init = 1117799)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:      -5.0800e-04 +/- 4.3896e-05 (8.64%) (init = -0.0004562807)
    ysh:       1.2772e-04 +/- 4.0840e-05 (31.98%) (init = 0.000158932)
    x2sh:      1.9435e-04 +/- 9.9708e-05 (51.30%) (init = 0.0001891058)
    y2sh:      1.5157e-04 +/- 9.8860e-05 (65.22%) (init = 0.000155217)
    xysh:     -4.0988e-04 +/- 1.9630e-04 (47.89%) (init = -0.0003957601)
    comm:      1.8396e-04 +/- 3.6386e-05 (19.78%) (init = 0.0001085827)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9819
    C(x2sh, xysh) = -0.9755
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8110
    C(xsh, ysh)   = -0.6329
    C(xsh, comm)  = -0.4873
    C(f0, x2sh)   = -0.3865
    C(f0, y2sh)   = -0.3296
    C(ysh, comm)  = -0.3012
    C(f0, xysh)   = +0.2751
    C(xsh, x2sh)  = +0.2435
    C(xsh, xysh)  = -0.2141
    C(rprs, x2sh) = -0.1937
    C(xysh, comm) = +0.1792
    C(xsh, y2sh)  = +0.1765
    C(x2sh, comm) = -0.1720
    C(rprs, xsh)  = -0.1664
    C(y2sh, comm) = -0.1483
    C(rprs, y2sh) = -0.1399
    C(rprs, ysh)  = +0.1377
    C(f0, xsh)    = -0.1207
    C(rprs, xysh) = +0.1007
Residual standard deviation  (ppm) :  1054.037346435932
Photon noise                 (ppm) :  945.8119322073638
Photon noise performance       (%) :  89.73229794992406
White noise                  (ppm) :  1052.8206317440454
Red noise                    (ppm) :  50.72926682911007
Transit depth measured error (ppm) :  37.434013904412495
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.87680367	-0.73477190	0.58280906	-0.20005969
3param 	2.19503822	-3.10630077	1.36088167
Quad 	0.03045602	0.37301051
Linear 	0.34680339

c1 = 0.8768036657165874
c2 = -0.7347718979202172
c3 = 0.5828090572725704
c4 = -0.2000596941008768


Fitting Bin 4  Wavelength = 2.6120002933333333   Range= [ 2.4898652 : 2.7162005 ]
rprs:  0.08079801924266616 current chi^2= 9205.709924232755  scatter  0.0010482768870580229
Re-Fitting Bin 4  Wavelength = 2.6120002933333333   Range= [ 2.4898652 : 2.7162005 ]

redchi 1.1248423661085964
chi2 9205.709924232753
nfree 8184
bic 1027.8140906872184
aic 971.7267839089841
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08079802 +/- 2.2966e-04 (0.28%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        1020091.41 +/- 35.9154006 (0.00%) (init = 1020040)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       4.9600e-04 +/- 4.3663e-05 (8.80%) (init = 0.0004393402)
    ysh:       2.2241e-04 +/- 4.0620e-05 (18.26%) (init = 0.000309657)
    x2sh:     -2.9802e-04 +/- 9.9151e-05 (33.27%) (init = -0.0003434394)
    y2sh:     -2.1077e-04 +/- 9.8311e-05 (46.64%) (init = -0.0002199046)
    xysh:      4.9765e-04 +/- 1.9521e-04 (39.23%) (init = 0.0005561113)
    comm:     -6.8653e-04 +/- 3.6185e-05 (5.27%) (init = -0.0007121339)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9755
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8109
    C(xsh, ysh)   = -0.6329
    C(xsh, comm)  = -0.4873
    C(f0, x2sh)   = -0.3866
    C(f0, y2sh)   = -0.3297
    C(ysh, comm)  = -0.3011
    C(f0, xysh)   = +0.2753
    C(xsh, x2sh)  = +0.2441
    C(xsh, xysh)  = -0.2145
    C(rprs, x2sh) = -0.1938
    C(xysh, comm) = +0.1795
    C(xsh, y2sh)  = +0.1769
    C(x2sh, comm) = -0.1724
    C(rprs, xsh)  = -0.1678
    C(y2sh, comm) = -0.1486
    C(rprs, y2sh) = -0.1399
    C(rprs, ysh)  = +0.1386
    C(f0, xsh)    = -0.1220
    C(rprs, xysh) = +0.1009
Residual standard deviation  (ppm) :  1048.2768870580228
Photon noise                 (ppm) :  990.1031808272959
Photon noise performance       (%) :  94.45054002917199
White noise                  (ppm) :  1047.7390803816916
Red noise                    (ppm) :  33.64007590200573
Transit depth measured error (ppm) :  37.1121852245308
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.86128574	-0.71348923	0.53201916	-0.17329851
3param 	2.16446825	-3.09179973	1.36001686
Quad 	0.02096721	0.36578104
Linear 	0.33118333

c1 = 0.8612857385139974
c2 = -0.713489233845713
c3 = 0.5320191611044409
c4 = -0.17329850590331394


Fitting Bin 5  Wavelength = 2.82970062   Range= [ 2.7162005 : 2.9267646 ]
rprs:  0.0798569649594219 current chi^2= 9962.93384572772  scatter  0.0016130786363043458
Re-Fitting Bin 5  Wavelength = 2.82970062   Range= [ 2.7162005 : 2.9267646 ]

redchi 1.2175160510482368
chi2 9962.93384572772
nfree 8183
bic 1684.383398479687
aic 1621.2851783541735
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.07985696 +/- 4.4930e-04 (0.56%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        466305.818 +/- 27.4132622 (0.01%) (init = 466320.8)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:   -0.03200602 +/- 0.00907390 (28.35%) (init = -0.03885871)
    xsh:       5.9845e-04 +/- 7.7661e-05 (12.98%) (init = 0.0005208206)
    ysh:       2.0512e-04 +/- 6.4429e-05 (31.41%) (init = 0.0001880271)
    x2sh:      1.3205e-04 +/- 1.5407e-04 (116.67%) (init = 0.0003234828)
    y2sh:      1.2008e-04 +/- 1.5150e-04 (126.17%) (init = 0.0003067711)
    xysh:     -1.9185e-04 +/- 3.0269e-04 (157.77%) (init = -0.0005659834)
    comm:     -4.1856e-04 +/- 6.2462e-05 (14.92%) (init = -0.0002515501)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh)   = -0.9796
    C(x2sh, xysh)   = -0.9758
    C(x2sh, y2sh)   = +0.9346
    C(rprs, f0)     = +0.8292
    C(rprs, Fslope) = -0.6095
    C(Fslope, xsh)  = -0.5011
    C(Fslope, comm) = -0.4531
    C(xsh, ysh)     = -0.4105
    C(f0, Fslope)   = -0.3889
    C(f0, x2sh)     = -0.2996
    C(f0, y2sh)     = -0.2832
    C(xsh, x2sh)    = +0.2785
    C(rprs, comm)   = +0.2590
    C(rprs, ysh)    = +0.2547
    C(xsh, xysh)    = -0.2457
    C(Fslope, ysh)  = -0.2417
    C(f0, xysh)     = +0.2044
    C(rprs, xsh)    = +0.1894
    C(xsh, y2sh)    = +0.1791
    C(ysh, comm)    = -0.1509
    C(xsh, comm)    = -0.1489
    C(f0, ysh)      = +0.1401
    C(Fslope, x2sh) = -0.1377
    C(f0, comm)     = +0.1331
    C(Fslope, xysh) = +0.1223
    C(y2sh, comm)   = -0.1088
    C(xysh, comm)   = +0.1034
Residual standard deviation  (ppm) :  1613.0786363043458
Photon noise                 (ppm) :  1464.4163972762306
Photon noise performance       (%) :  90.7839434679571
White noise                  (ppm) :  1609.088864053264
Red noise                    (ppm) :  113.60427859881536
Transit depth measured error (ppm) :  71.75961566001148
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.83139630	-0.69648917	0.51398704	-0.16463361
3param 	2.08159374	-2.98407343	1.31547068
Quad 	0.01845846	0.35019596
Linear 	0.31545699

c1 = 0.8313962953828634
c2 = -0.69648916712715
c3 = 0.5139870433675813
c4 = -0.1646336112166497


Fitting Bin 6  Wavelength = 3.03297832   Range= [ 2.9267646 : 3.1240093 ]
rprs:  0.07996217817640366 current chi^2= 9377.921035738047  scatter  0.0016759321966837164
Re-Fitting Bin 6  Wavelength = 3.03297832   Range= [ 2.9267646 : 3.1240093 ]

redchi 1.1460248118951541
chi2 9377.921035738047
nfree 8183
bic 1188.6568837001298
aic 1125.5586635746163
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.07996218 +/- 4.6570e-04 (0.58%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        406639.550 +/- 24.8600565 (0.01%) (init = 406639.5)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:   -0.02768365 +/- 0.00943268 (34.07%) (init = -0.0245558)
    xsh:       9.5268e-05 +/- 8.0679e-05 (84.69%) (init = 0.0001198049)
    ysh:      -2.8172e-04 +/- 6.6954e-05 (23.77%) (init = -0.0003972918)
    x2sh:      1.2084e-04 +/- 1.6007e-04 (132.46%) (init = 0.0001082623)
    y2sh:      8.5765e-05 +/- 1.5741e-04 (183.53%) (init = 4.592033e-05)
    xysh:     -2.0445e-04 +/- 3.1449e-04 (153.82%) (init = -0.0001742409)
    comm:      3.1334e-04 +/- 6.4895e-05 (20.71%) (init = 0.0003524477)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh)   = -0.9796
    C(x2sh, xysh)   = -0.9758
    C(x2sh, y2sh)   = +0.9347
    C(rprs, f0)     = +0.8296
    C(rprs, Fslope) = -0.6101
    C(Fslope, xsh)  = -0.5009
    C(Fslope, comm) = -0.4532
    C(xsh, ysh)     = -0.4102
    C(f0, Fslope)   = -0.3898
    C(f0, x2sh)     = -0.2995
    C(f0, y2sh)     = -0.2834
    C(xsh, x2sh)    = +0.2783
    C(rprs, comm)   = +0.2591
    C(rprs, ysh)    = +0.2558
    C(xsh, xysh)    = -0.2456
    C(Fslope, ysh)  = -0.2424
    C(f0, xysh)     = +0.2044
    C(rprs, xsh)    = +0.1896
    C(xsh, y2sh)    = +0.1790
    C(ysh, comm)    = -0.1505
    C(xsh, comm)    = -0.1488
    C(f0, ysh)      = +0.1414
    C(Fslope, x2sh) = -0.1374
    C(f0, comm)     = +0.1332
    C(Fslope, xysh) = +0.1221
    C(y2sh, comm)   = -0.1088
    C(xysh, comm)   = +0.1033
Residual standard deviation  (ppm) :  1675.9321966837165
Photon noise                 (ppm) :  1568.1774042089141
Photon noise performance       (%) :  93.57045632943718
White noise                  (ppm) :  1673.2041442027448
Red noise                    (ppm) :  95.77217562834234
Transit depth measured error (ppm) :  74.47713547007491
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.81389247	-0.73763493	0.57400093	-0.18855617
3param 	1.98195953	-2.85041302	1.26038669
Quad 	0.01890988	0.33067264
Linear 	0.29935083

c1 = 0.8138924681638973
c2 = -0.7376349257280954
c3 = 0.5740009254129774
c4 = -0.18855617472606742


Fitting Bin 7  Wavelength = 3.2240248533333333   Range= [ 3.1240093 : 3.3099063 ]
rprs:  0.08173193067865869 current chi^2= 9016.09530809757  scatter  0.0015709991669581843
Re-Fitting Bin 7  Wavelength = 3.2240248533333333   Range= [ 3.1240093 : 3.3099063 ]

redchi 1.101808054270753
chi2 9016.09530809757
nfree 8183
bic 866.3282848080157
aic 803.2300646825022
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08173193 +/- 4.2849e-04 (0.52%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        444771.966 +/- 25.5781982 (0.01%) (init = 444786.4)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:   -0.04678146 +/- 0.00886101 (18.94%) (init = -0.04274347)
    xsh:      -2.0829e-04 +/- 7.5679e-05 (36.33%) (init = -0.0001220049)
    ysh:      -6.4652e-04 +/- 6.2784e-05 (9.71%) (init = -0.000715279)
    x2sh:     -2.1765e-04 +/- 1.5007e-04 (68.95%) (init = -9.505015e-05)
    y2sh:     -1.9149e-04 +/- 1.4759e-04 (77.07%) (init = -9.269764e-05)
    xysh:      4.4090e-04 +/- 2.9486e-04 (66.88%) (init = 0.0002427406)
    comm:      9.2486e-04 +/- 6.0847e-05 (6.58%) (init = 0.0008865038)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh)   = -0.9796
    C(x2sh, xysh)   = -0.9759
    C(x2sh, y2sh)   = +0.9346
    C(rprs, f0)     = +0.8308
    C(rprs, Fslope) = -0.6122
    C(Fslope, xsh)  = -0.5019
    C(Fslope, comm) = -0.4531
    C(xsh, ysh)     = -0.4091
    C(f0, Fslope)   = -0.3929
    C(f0, x2sh)     = -0.2986
    C(f0, y2sh)     = -0.2833
    C(xsh, x2sh)    = +0.2779
    C(rprs, comm)   = +0.2589
    C(rprs, ysh)    = +0.2566
    C(xsh, xysh)    = -0.2455
    C(Fslope, ysh)  = -0.2432
    C(f0, xysh)     = +0.2037
    C(rprs, xsh)    = +0.1922
    C(xsh, y2sh)    = +0.1785
    C(ysh, comm)    = -0.1502
    C(xsh, comm)    = -0.1481
    C(f0, ysh)      = +0.1427
    C(Fslope, x2sh) = -0.1371
    C(f0, comm)     = +0.1336
    C(Fslope, xysh) = +0.1219
    C(y2sh, comm)   = -0.1088
    C(xysh, comm)   = +0.1032
Residual standard deviation  (ppm) :  1570.9991669581843
Photon noise                 (ppm) :  1499.4476120257361
Photon noise performance       (%) :  95.44547467386705
White noise                  (ppm) :  1570.9991669581843
Red noise                    (ppm) :  0.0
Transit depth measured error (ppm) :  70.04274835488246
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:138: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sig0**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:142: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sigwhite**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.77921338	-0.73484018	0.59159019	-0.19763154
3param 	1.86887525	-2.68691313	1.18957342
Quad 	0.02139147	0.31022264
Linear 	0.28448893

c1 = 0.7792133777907014
c2 = -0.7348401843860144
c3 = 0.5915901917273957
c4 = -0.19763153511838683


Fitting Bin 8  Wavelength = 3.4045925866666678   Range= [ 3.3099063 : 3.4860291 ]
rprs:  0.08227189100304827 current chi^2= 9103.126452750907  scatter  0.0014868598464022912
Re-Fitting Bin 8  Wavelength = 3.4045925866666678   Range= [ 3.3099063 : 3.4860291 ]

redchi 1.112443657918967
chi2 9103.126452750907
nfree 8183
bic 945.0253314503971
aic 881.9271113248834
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08227189 +/- 2.1027e-05 (0.03%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        501292.576 +/- 28.8379224 (0.01%) (init = 501326.9)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:   -0.03070645 +/- 0.00892025 (29.05%) (init = -0.03123646)
    xsh:       7.1767e-05 +/- 7.2558e-05 (101.10%) (init = -4.314611e-05)
    ysh:      -7.0107e-04 +/- 6.1147e-05 (8.72%) (init = -0.0007549212)
    x2sh:     -2.8376e-04 +/- 1.4177e-04 (49.96%) (init = -0.0003371664)
    y2sh:     -1.8900e-04 +/- 1.3982e-04 (73.98%) (init = -0.000238624)
    xysh:      4.8986e-04 +/- 2.7908e-04 (56.97%) (init = 0.0005530067)
    comm:      4.4287e-04 +/- 5.7141e-05 (12.90%) (init = 0.0005872099)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh)   = -0.9776
    C(x2sh, xysh)   = -0.9771
    C(x2sh, y2sh)   = +0.9328
    C(rprs, f0)     = +0.8501
    C(rprs, Fslope) = -0.6688
    C(Fslope, xsh)  = -0.5224
    C(f0, Fslope)   = -0.4657
    C(Fslope, comm) = -0.4321
    C(xsh, ysh)     = -0.3548
    C(rprs, ysh)    = +0.3432
    C(Fslope, ysh)  = -0.3082
    C(f0, y2sh)     = -0.2821
    C(xsh, x2sh)    = +0.2806
    C(f0, x2sh)     = -0.2547
    C(rprs, xsh)    = +0.2477
    C(xsh, xysh)    = -0.2451
    C(rprs, comm)   = +0.2288
    C(f0, ysh)      = +0.2269
    C(f0, xysh)     = +0.1828
    C(xsh, y2sh)    = +0.1689
    C(f0, xsh)      = +0.1547
    C(Fslope, x2sh) = -0.1485
    C(xsh, comm)    = -0.1402
    C(ysh, comm)    = -0.1337
    C(Fslope, xysh) = +0.1222
    C(f0, comm)     = +0.1168
    C(y2sh, comm)   = -0.1096
    C(xysh, comm)   = +0.1012
Residual standard deviation  (ppm) :  1486.8598464022912
Photon noise                 (ppm) :  1412.3891198622528
Photon noise performance       (%) :  94.99140912842371
White noise                  (ppm) :  1485.1862825953015
Red noise                    (ppm) :  70.66355613452959
Transit depth measured error (ppm) :  3.459847161666703
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.74674613	-0.70346448	0.56972787	-0.19098962
3param 	1.79176273	-2.57217104	1.13841509
Quad 	0.02245657	0.29733359
Linear 	0.27462292

c1 = 0.7467461281818586
c2 = -0.703464475253341
c3 = 0.5697278747363782
c4 = -0.19098961530866335


Fitting Bin 9  Wavelength = 3.576083346666666   Range= [ 3.4860291 : 3.6536426 ]
rprs:  0.08252602288912203 current chi^2= 9276.73253099844  scatter  0.0013166537622119156
Re-Fitting Bin 9  Wavelength = 3.576083346666666   Range= [ 3.4860291 : 3.6536426 ]

redchi 1.1335205927417449
chi2 9276.73253099844
nfree 8184
bic 1090.7733083166083
aic 1034.686001538374
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08252602 +/- 2.8079e-04 (0.34%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        651858.992 +/- 28.9193771 (0.00%) (init = 652312.5)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:      -1.4617e-04 +/- 5.4854e-05 (37.53%) (init = -0.0001409193)
    ysh:      -2.3084e-04 +/- 5.1041e-05 (22.11%) (init = -0.0003514006)
    x2sh:      2.9062e-04 +/- 1.2460e-04 (42.87%) (init = 0.0004020877)
    y2sh:      2.9660e-04 +/- 1.2354e-04 (41.65%) (init = 0.0003425623)
    xysh:     -1.9799e-04 +/- 2.4527e-04 (123.88%) (init = -0.0003119663)
    comm:      1.0111e-04 +/- 4.5457e-05 (44.96%) (init = 0.0002516143)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9819
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8122
    C(xsh, ysh)   = -0.6332
    C(xsh, comm)  = -0.4869
    C(f0, x2sh)   = -0.3871
    C(f0, y2sh)   = -0.3306
    C(ysh, comm)  = -0.3013
    C(f0, xysh)   = +0.2759
    C(xsh, x2sh)  = +0.2441
    C(xsh, xysh)  = -0.2147
    C(rprs, x2sh) = -0.1950
    C(xysh, comm) = +0.1792
    C(xsh, y2sh)  = +0.1772
    C(x2sh, comm) = -0.1718
    C(rprs, xsh)  = -0.1683
    C(y2sh, comm) = -0.1482
    C(rprs, y2sh) = -0.1417
    C(rprs, ysh)  = +0.1408
    C(f0, xsh)    = -0.1225
    C(rprs, xysh) = +0.1022
Residual standard deviation  (ppm) :  1316.6537622119156
Photon noise                 (ppm) :  1238.5774523478374
Photon noise performance       (%) :  94.07009556309521
White noise                  (ppm) :  1306.3149424296028
Red noise                    (ppm) :  164.9979756990808
Transit depth measured error (ppm) :  46.34440978535159
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.72352161	-0.69353431	0.56713532	-0.19083063
3param 	1.72408895	-2.47704753	1.09722831
Quad 	0.02204262	0.28542380
Linear 	0.26410838

c1 = 0.7235216095387155
c2 = -0.6935343054246529
c3 = 0.56713531990293
c4 = -0.19083063355448535


Fitting Bin 10  Wavelength = 3.739628686666667   Range= [ 3.6536426 : 3.8137721 ]
rprs:  0.08096454885995075 current chi^2= 8850.135154072304  scatter  0.001147068098288207
Re-Fitting Bin 10  Wavelength = 3.739628686666667   Range= [ 3.6536426 : 3.8137721 ]

redchi 1.0813948135474467
chi2 8850.135154072304
nfree 8184
bic 705.1213399520565
aic 649.0340331738222
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08096455 +/- 2.4849e-04 (0.31%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        819096.202 +/- 31.6234031 (0.00%) (init = 819352.4)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       1.5290e-04 +/- 4.7801e-05 (31.26%) (init = 0.0002021917)
    ysh:      -7.7256e-05 +/- 4.4471e-05 (57.56%) (init = -0.0001052952)
    x2sh:      1.7909e-04 +/- 1.0855e-04 (60.61%) (init = 0.0001836095)
    y2sh:      1.2922e-04 +/- 1.0762e-04 (83.29%) (init = 0.0001099149)
    xysh:     -1.6232e-04 +/- 2.1368e-04 (131.64%) (init = -0.0001007594)
    comm:     -3.7415e-04 +/- 3.9600e-05 (10.58%) (init = -0.0003567791)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8117
    C(xsh, ysh)   = -0.6333
    C(xsh, comm)  = -0.4870
    C(f0, x2sh)   = -0.3874
    C(f0, y2sh)   = -0.3306
    C(ysh, comm)  = -0.3011
    C(f0, xysh)   = +0.2762
    C(xsh, x2sh)  = +0.2445
    C(xsh, xysh)  = -0.2149
    C(rprs, x2sh) = -0.1952
    C(xysh, comm) = +0.1794
    C(xsh, y2sh)  = +0.1774
    C(x2sh, comm) = -0.1722
    C(rprs, xsh)  = -0.1700
    C(y2sh, comm) = -0.1485
    C(rprs, ysh)  = +0.1418
    C(rprs, y2sh) = -0.1416
    C(f0, xsh)    = -0.1239
    C(rprs, xysh) = +0.1024
Residual standard deviation  (ppm) :  1147.068098288207
Photon noise                 (ppm) :  1104.9243487157835
Photon noise performance       (%) :  96.32595923159964
White noise                  (ppm) :  1143.761751956722
Red noise                    (ppm) :  87.20013698637507
Transit depth measured error (ppm) :  40.238203628442655
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.70158183	-0.68497822	0.56261757	-0.18898808
3param 	1.65933401	-2.38925471	1.06001228
Quad 	0.02095753	0.27363515
Linear 	0.25302542

c1 = 0.7015818333762096
c2 = -0.6849782191633046
c3 = 0.5626175733208771
c4 = -0.1889880833590714


Fitting Bin 11  Wavelength = 3.896151973333334   Range= [ 3.8137721 : 3.9672586 ]
rprs:  0.08035896954195282 current chi^2= 9206.088737155027  scatter  0.0012179575143038588
Re-Fitting Bin 11  Wavelength = 3.896151973333334   Range= [ 3.8137721 : 3.9672586 ]

redchi 1.1248886531225595
chi2 9206.088737155027
nfree 8184
bic 1028.151182735288
aic 972.0638759570537
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08035897 +/- 2.6526e-04 (0.33%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        755663.729 +/- 30.9654606 (0.00%) (init = 755688.6)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       3.6211e-04 +/- 5.0760e-05 (14.02%) (init = 0.0003654635)
    ysh:       1.8443e-04 +/- 4.7221e-05 (25.60%) (init = 0.0001264471)
    x2sh:     -8.4928e-05 +/- 1.1525e-04 (135.70%) (init = -6.479008e-05)
    y2sh:     -1.0979e-04 +/- 1.1426e-04 (104.07%) (init = -0.0001160302)
    xysh:      1.8924e-04 +/- 2.2687e-04 (119.88%) (init = 0.0001877641)
    comm:     -7.9893e-04 +/- 4.2044e-05 (5.26%) (init = -0.0007396911)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8116
    C(xsh, ysh)   = -0.6333
    C(xsh, comm)  = -0.4870
    C(f0, x2sh)   = -0.3875
    C(f0, y2sh)   = -0.3307
    C(ysh, comm)  = -0.3010
    C(f0, xysh)   = +0.2764
    C(xsh, x2sh)  = +0.2447
    C(xsh, xysh)  = -0.2150
    C(rprs, x2sh) = -0.1953
    C(xysh, comm) = +0.1796
    C(xsh, y2sh)  = +0.1775
    C(x2sh, comm) = -0.1724
    C(rprs, xsh)  = -0.1709
    C(y2sh, comm) = -0.1487
    C(rprs, ysh)  = +0.1423
    C(rprs, y2sh) = -0.1415
    C(f0, xsh)    = -0.1246
    C(rprs, xysh) = +0.1026
Residual standard deviation  (ppm) :  1217.9575143038587
Photon noise                 (ppm) :  1150.365136647971
Photon noise performance       (%) :  94.4503501261683
White noise                  (ppm) :  1217.9575143038587
Red noise                    (ppm) :  0.0
Transit depth measured error (ppm) :  42.632166958260974
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:138: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sig0**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:142: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sigwhite**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.70601642	-0.70030861	0.58051914	-0.19676969
3param 	1.65882163	-2.39001144	1.06012540
Quad 	0.01948102	0.27394442
Linear 	0.25181120

c1 = 0.7060164155107614
c2 = -0.700308605577277
c3 = 0.5805191372829517
c4 = -0.1967696897622868


Fitting Bin 12  Wavelength = 4.046415566666666   Range= [ 3.9672586 : 4.1148019 ]
rprs:  0.08042004711851963 current chi^2= 9426.689204343304  scatter  0.001324849605356413
Re-Fitting Bin 12  Wavelength = 4.046415566666666   Range= [ 3.9672586 : 4.1148019 ]

redchi 1.1518437444212248
chi2 9426.689204343304
nfree 8184
bic 1222.1365859827429
aic 1166.0492792045086
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08042005 +/- 2.8830e-04 (0.36%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        653878.858 +/- 29.1478519 (0.00%) (init = 653852)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       4.1610e-04 +/- 5.5217e-05 (13.27%) (init = 0.0003917553)
    ysh:       2.5082e-04 +/- 5.1367e-05 (20.48%) (init = 0.0002782358)
    x2sh:      9.2727e-07 +/- 1.2537e-04 (13519.85%) (init = -5.076081e-05)
    y2sh:     -5.9623e-05 +/- 1.2429e-04 (208.47%) (init = -8.608243e-05)
    xysh:      5.8585e-06 +/- 2.4679e-04 (4212.40%) (init = 9.359886e-05)
    comm:     -8.7773e-04 +/- 4.5735e-05 (5.21%) (init = -0.0008647874)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8116
    C(xsh, ysh)   = -0.6333
    C(xsh, comm)  = -0.4870
    C(f0, x2sh)   = -0.3876
    C(f0, y2sh)   = -0.3307
    C(ysh, comm)  = -0.3010
    C(f0, xysh)   = +0.2764
    C(xsh, x2sh)  = +0.2446
    C(xsh, xysh)  = -0.2149
    C(rprs, x2sh) = -0.1953
    C(xysh, comm) = +0.1795
    C(xsh, y2sh)  = +0.1775
    C(x2sh, comm) = -0.1724
    C(rprs, xsh)  = -0.1709
    C(y2sh, comm) = -0.1487
    C(rprs, ysh)  = +0.1423
    C(rprs, y2sh) = -0.1416
    C(f0, xsh)    = -0.1246
    C(rprs, xysh) = +0.1026
Residual standard deviation  (ppm) :  1324.849605356413
Photon noise                 (ppm) :  1236.6629569412296
Photon noise performance       (%) :  93.34364836139576
White noise                  (ppm) :  1324.849605356413
Red noise                    (ppm) :  0.0
Transit depth measured error (ppm) :  46.36947542157553
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:138: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sig0**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:142: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sigwhite**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.70935323	-0.72091003	0.59985926	-0.20291388
3param 	1.64937007	-2.38471082	1.05992162
Quad 	0.01796001	0.27118947
Linear 	0.24795374

c1 = 0.7093532347748518
c2 = -0.7209100290636149
c3 = 0.5998592638096363
c4 = -0.2029138849439886


Fitting Bin 13  Wavelength = 4.191056326666667   Range= [ 4.1148019 : 4.2569868 ]
rprs:  0.08076799980124444 current chi^2= 10166.76684680261  scatter  0.001923789469298889
Re-Fitting Bin 13  Wavelength = 4.191056326666667   Range= [ 4.1148019 : 4.2569868 ]

redchi 1.2422735638810618
chi2 10166.76684680261
nfree 8184
bic 1841.2822564792052
aic 1785.194949700971
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08076800 +/- 4.1673e-04 (0.52%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        334548.499 +/- 21.6569457 (0.01%) (init = 334610.8)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       0.00255080 +/- 8.0179e-05 (3.14%) (init = 0.002471999)
    ysh:      -1.7229e-04 +/- 7.4585e-05 (43.29%) (init = -0.0001798177)
    x2sh:      2.3572e-04 +/- 1.8204e-04 (77.22%) (init = 0.000255704)
    y2sh:      1.2318e-04 +/- 1.8048e-04 (146.52%) (init = 0.0001410066)
    xysh:     -3.1019e-04 +/- 3.5834e-04 (115.52%) (init = -0.0003726413)
    comm:     -0.00237086 +/- 6.6405e-05 (2.80%) (init = -0.002301265)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8117
    C(xsh, ysh)   = -0.6332
    C(xsh, comm)  = -0.4870
    C(f0, x2sh)   = -0.3876
    C(f0, y2sh)   = -0.3309
    C(ysh, comm)  = -0.3011
    C(f0, xysh)   = +0.2765
    C(xsh, x2sh)  = +0.2455
    C(xsh, xysh)  = -0.2157
    C(rprs, x2sh) = -0.1954
    C(xysh, comm) = +0.1799
    C(xsh, y2sh)  = +0.1783
    C(x2sh, comm) = -0.1729
    C(rprs, xsh)  = -0.1715
    C(y2sh, comm) = -0.1491
    C(rprs, ysh)  = +0.1425
    C(rprs, y2sh) = -0.1419
    C(f0, xsh)    = -0.1256
    C(rprs, xysh) = +0.1028
Residual standard deviation  (ppm) :  1923.789469298889
Photon noise                 (ppm) :  1728.9023194239408
Photon noise performance       (%) :  89.86962175513034
White noise                  (ppm) :  1923.789469298889
Red noise                    (ppm) :  0.0
Transit depth measured error (ppm) :  67.31755156120067
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:138: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sig0**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:142: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sigwhite**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.66323587	-0.66364687	0.56071310	-0.19136859
3param 	1.55253360	-2.22982036	0.98936587
Quad 	0.02366143	0.25528761
Linear 	0.24016891

c1 = 0.6632358693959266
c2 = -0.6636468698454744
c3 = 0.5607130986026022
c4 = -0.1913685852532563


Fitting Bin 14  Wavelength = 4.33061144   Range= [ 4.2569868 : 4.3943119 ]
rprs:  0.08114760991530912 current chi^2= 10258.192606422173  scatter  0.0016628191173252076
Re-Fitting Bin 14  Wavelength = 4.33061144   Range= [ 4.2569868 : 4.3943119 ]

redchi 1.253444844381986
chi2 10258.192606422173
nfree 8184
bic 1914.6204510224768
aic 1858.5331442442425
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08114761 +/- 3.5865e-04 (0.44%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        451670.955 +/- 25.2930094 (0.01%) (init = 451633.6)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:      -5.6351e-04 +/- 6.9301e-05 (12.30%) (init = -0.0005649959)
    ysh:       5.0939e-05 +/- 6.4477e-05 (126.57%) (init = -4.022727e-05)
    x2sh:      2.6615e-05 +/- 1.5736e-04 (591.25%) (init = -6.50098e-06)
    y2sh:      2.7290e-05 +/- 1.5601e-04 (571.68%) (init = -4.604367e-05)
    xysh:     -1.3847e-04 +/- 3.0976e-04 (223.71%) (init = -5.075544e-05)
    comm:      2.9164e-04 +/- 5.7406e-05 (19.68%) (init = 0.0003705078)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8119
    C(xsh, ysh)   = -0.6334
    C(xsh, comm)  = -0.4869
    C(f0, x2sh)   = -0.3876
    C(f0, y2sh)   = -0.3309
    C(ysh, comm)  = -0.3011
    C(f0, xysh)   = +0.2764
    C(xsh, x2sh)  = +0.2443
    C(xsh, xysh)  = -0.2147
    C(rprs, x2sh) = -0.1954
    C(xysh, comm) = +0.1791
    C(xsh, y2sh)  = +0.1772
    C(x2sh, comm) = -0.1718
    C(rprs, xsh)  = -0.1703
    C(y2sh, comm) = -0.1482
    C(rprs, ysh)  = +0.1424
    C(rprs, y2sh) = -0.1420
    C(f0, xsh)    = -0.1240
    C(rprs, xysh) = +0.1028
Residual standard deviation  (ppm) :  1662.8191173252076
Photon noise                 (ppm) :  1487.9519878305853
Photon noise performance       (%) :  89.48369502896313
White noise                  (ppm) :  1661.4245919556586
Red noise                    (ppm) :  68.21913628208945
Transit depth measured error (ppm) :  58.207801105886354
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.60983174	-0.61629105	0.53858322	-0.18657597
3param 	1.42144129	-2.02725487	0.89908507
Quad 	0.03065179	0.23249928
Linear 	0.22783267

c1 = 0.6098317351531414
c2 = -0.6162910548658452
c3 = 0.5385832222369871
c4 = -0.1865759656282499


Fitting Bin 15  Wavelength = 4.465538639999999   Range= [ 4.3943119 : 4.5272022 ]
rprs:  0.08073844912626177 current chi^2= 10929.456415288656  scatter  0.0018686202314533622
Re-Fitting Bin 15  Wavelength = 4.465538639999999   Range= [ 4.3943119 : 4.5272022 ]

redchi 1.3354663264037947
chi2 10929.456415288656
nfree 8184
bic 2433.86957368386
aic 2377.7822669056254
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08073845 +/- 4.0441e-04 (0.50%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        381159.922 +/- 23.9803751 (0.01%) (init = 381273.9)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       8.1010e-04 +/- 7.7894e-05 (9.62%) (init = 0.0008546914)
    ysh:      -0.00148161 +/- 7.2466e-05 (4.89%) (init = -0.001520144)
    x2sh:      4.3154e-04 +/- 1.7687e-04 (40.99%) (init = 0.0004347958)
    y2sh:      4.8933e-04 +/- 1.7536e-04 (35.84%) (init = 0.0004636312)
    xysh:     -8.5004e-04 +/- 3.4817e-04 (40.96%) (init = -0.0008122209)
    comm:      4.8510e-04 +/- 6.4511e-05 (13.30%) (init = 0.0004869507)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9378
    C(rprs, f0)   = +0.8119
    C(xsh, ysh)   = -0.6335
    C(xsh, comm)  = -0.4867
    C(f0, x2sh)   = -0.3877
    C(f0, y2sh)   = -0.3311
    C(ysh, comm)  = -0.3011
    C(f0, xysh)   = +0.2767
    C(xsh, x2sh)  = +0.2452
    C(xsh, xysh)  = -0.2155
    C(rprs, x2sh) = -0.1957
    C(xysh, comm) = +0.1791
    C(xsh, y2sh)  = +0.1781
    C(x2sh, comm) = -0.1718
    C(rprs, xsh)  = -0.1715
    C(y2sh, comm) = -0.1482
    C(rprs, ysh)  = +0.1437
    C(rprs, y2sh) = -0.1422
    C(f0, xsh)    = -0.1253
    C(rprs, xysh) = +0.1031
Residual standard deviation  (ppm) :  1868.6202314533623
Photon noise                 (ppm) :  1619.7440194789522
Photon noise performance       (%) :  86.6812845229209
White noise                  (ppm) :  1868.6202314533623
Red noise                    (ppm) :  0.0
Transit depth measured error (ppm) :  65.30327824768023
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:138: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sig0**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:142: RuntimeWarning: invalid value encountered in sqrt
  sigrednoise = np.sqrt(sig_binned**2-sigwhite**2/binmeasure)
/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.60997947	-0.64472844	0.57190253	-0.19852233
3param 	1.39349756	-1.99455717	0.88740172
Quad 	0.03077627	0.22593125
Linear 	0.22238684

c1 = 0.6099794722510968
c2 = -0.6447284371809401
c3 = 0.5719025262011778
c4 = -0.19852232970661113


Fitting Bin 16  Wavelength = 4.59623168   Range= [ 4.5272022 : 4.6560258 ]
rprs:  0.08025350816232052 current chi^2= 11816.076602419895  scatter  0.002240984638087443
Re-Fitting Bin 16  Wavelength = 4.59623168   Range= [ 4.5272022 : 4.6560258 ]

redchi 1.4438021263953928
chi2 11816.076602419895
nfree 8184
bic 3072.8411538775026
aic 3016.753847099268
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.08025351 +/- 4.8728e-04 (0.61%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        286515.192 +/- 21.6081512 (0.01%) (init = 286539.3)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       0.00105521 +/- 9.3415e-05 (8.85%) (init = 0.0009579191)
    ysh:      -1.9211e-04 +/- 8.6901e-05 (45.23%) (init = -0.0002364105)
    x2sh:      2.6687e-04 +/- 2.1207e-04 (79.47%) (init = 0.000171836)
    y2sh:      3.2514e-04 +/- 2.1025e-04 (64.67%) (init = 0.000207163)
    xysh:     -6.0995e-04 +/- 4.1745e-04 (68.44%) (init = -0.0003703153)
    comm:     -9.2834e-04 +/- 7.7357e-05 (8.33%) (init = -0.0007643483)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8117
    C(xsh, ysh)   = -0.6335
    C(xsh, comm)  = -0.4869
    C(f0, x2sh)   = -0.3879
    C(f0, y2sh)   = -0.3311
    C(ysh, comm)  = -0.3010
    C(f0, xysh)   = +0.2768
    C(xsh, x2sh)  = +0.2451
    C(xsh, xysh)  = -0.2153
    C(rprs, x2sh) = -0.1957
    C(xysh, comm) = +0.1795
    C(xsh, y2sh)  = +0.1779
    C(x2sh, comm) = -0.1724
    C(rprs, xsh)  = -0.1721
    C(y2sh, comm) = -0.1486
    C(rprs, ysh)  = +0.1435
    C(rprs, y2sh) = -0.1421
    C(f0, xsh)    = -0.1258
    C(rprs, xysh) = +0.1031
Residual standard deviation  (ppm) :  2240.984638087443
Photon noise                 (ppm) :  1868.212066695138
Photon noise performance       (%) :  83.36567930646568
White noise                  (ppm) :  2239.910337649141
Red noise                    (ppm) :  69.5171306214575
Transit depth measured error (ppm) :  78.21205389847466
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
You are using the 3D limb darkening models.
Current Directories Entered:
  ./notebookrun2/
  ./notebookrun2/3DGrid
Filename: mmu_t45g45m00v05.flx

Closest values to your inputs:
Teff  :  4500
M_H   :  0.0
log(g):  4.5

Limb darkening parameters:
4param 	0.60350262	-0.62606713	0.54814049	-0.18913089
3param 	1.39051667	-1.99106813	0.88526265
Quad 	0.02900564	0.22612279
Linear 	0.22077866

c1 = 0.6035026150544636
c2 = -0.6260671293320387
c3 = 0.5481404929821063
c4 = -0.18913089064980246


Fitting Bin 17  Wavelength = 4.7230313   Range= [ 4.6560258 : 4.7811009 ]
rprs:  0.07993813095540425 current chi^2= 16280.793120699353  scatter  0.003335098304838922
Re-Fitting Bin 17  Wavelength = 4.7230313   Range= [ 4.6560258 : 4.7811009 ]

redchi 1.9893442229593539
chi2 16280.793120699353
nfree 8184
bic 5698.5823530513335
aic 5642.495046273099
L-M FIT Variable
[[Variables]]
    cosinc:    0.05481076 (fixed)
    rho_star:  8.320569 (fixed)
    a_Rs:      14.54 (fixed)
    rprs:      0.07993813 +/- 7.2749e-04 (0.91%) (init = 0.0804)
    t0:        2454865 (fixed)
    f0:        178202.655 +/- 19.9965859 (0.01%) (init = 178209.5)
    ecc:       0 (fixed)
    omega:     0 (fixed)
    Fslope:    0 (fixed)
    xsh:       0.00131928 +/- 1.3905e-04 (10.54%) (init = 0.001501862)
    ysh:       5.1327e-05 +/- 1.2935e-04 (252.00%) (init = -1.888577e-05)
    x2sh:      3.9976e-04 +/- 3.1563e-04 (78.95%) (init = 0.0001132571)
    y2sh:      5.5004e-04 +/- 3.1294e-04 (56.89%) (init = 0.0002763527)
    xysh:     -0.00101505 +/- 6.2132e-04 (61.21%) (init = -0.000378254)
    comm:     -0.00132254 +/- 1.1513e-04 (8.71%) (init = -0.001357975)
[[Correlations]] (unreported correlations are &lt; 0.100)
    C(y2sh, xysh) = -0.9820
    C(x2sh, xysh) = -0.9756
    C(x2sh, y2sh) = +0.9377
    C(rprs, f0)   = +0.8116
    C(xsh, ysh)   = -0.6335
    C(xsh, comm)  = -0.4869
    C(f0, x2sh)   = -0.3879
    C(f0, y2sh)   = -0.3311
    C(ysh, comm)  = -0.3010
    C(f0, xysh)   = +0.2769
    C(xsh, x2sh)  = +0.2453
    C(xsh, xysh)  = -0.2154
    C(rprs, x2sh) = -0.1957
    C(xysh, comm) = +0.1796
    C(xsh, y2sh)  = +0.1780
    C(x2sh, comm) = -0.1725
    C(rprs, xsh)  = -0.1725
    C(y2sh, comm) = -0.1488
    C(rprs, ysh)  = +0.1437
    C(rprs, y2sh) = -0.1420
    C(f0, xsh)    = -0.1262
    C(rprs, xysh) = +0.1032
Residual standard deviation  (ppm) :  3335.098304838922
Photon noise                 (ppm) :  2368.879199856751
Photon noise performance       (%) :  71.02876687082129
White noise                  (ppm) :  3332.548577726672
Red noise                    (ppm) :  130.64106910830395
Transit depth measured error (ppm) :  116.3089626329386
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_1956/3968974178.py:175: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax1.scatter(x, y/p[&#39;f0&#39;].value, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
/tmp/ipykernel_1956/3968974178.py:190: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  ax2.scatter(x, residppm, s=msize*0.75, linewidth=1, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;, zorder=0)  # overplot Transit model at data
/tmp/ipykernel_1956/3968974178.py:216: UserWarning: You passed a edgecolor/edgecolors (&#39;blue&#39;) for an unfilled marker (&#39;+&#39;).  Matplotlib is ignoring the edgecolor in favor of the facecolor.  This behavior may change in the future.
  plt.scatter(x, light_curve+resid, s=msize*0.75, linewidth=1, zorder=0, alpha=0.5, marker=&#39;+&#39;, edgecolors=&#39;blue&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Can Now View Output PDFs in  ./notebookrun2/
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="plot-measured-exoplanet-transmission-spectrum-vs-injected">
<h1>Plot Measured Exoplanet Transmission Spectrum vs Injected<a class="headerlink" href="#plot-measured-exoplanet-transmission-spectrum-vs-injected" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Load Injected Transmission spectra to compare with recovered value</span>

<span class="c1"># Download Injected Spectra</span>
<span class="n">fn_tm</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">)</span>
<span class="n">destld</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_tm</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">)</span>        

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;   &#39;</span><span class="p">)</span>
<span class="n">model_ws</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">model_spec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Read fit transit depths</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_transmission_spectra.csv&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
<span class="n">wsd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Wavelength Center (um)&#39;</span><span class="p">]</span>
<span class="n">werr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Wavelength half-width (um)&#39;</span><span class="p">]</span>
<span class="n">rprs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Rp/Rs&#39;</span><span class="p">]</span>
<span class="n">rerr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Rp/Rs 1-sigma error&#39;</span><span class="p">]</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Beta Rednoise Inflation factor&#39;</span><span class="p">]</span>

<span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">model_spec</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Injected Spectra&#39;</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wsd</span><span class="p">,</span> <span class="n">rprs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">werr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">rerr</span><span class="o">*</span><span class="n">rprs</span><span class="o">*</span><span class="mf">1E6</span><span class="o">*</span><span class="n">beta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Recovered Spectra with $\sigma_r$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wsd</span><span class="p">,</span> <span class="n">rprs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">werr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">rerr</span><span class="o">*</span><span class="n">rprs</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recovered Spectra&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Transit Depth ($R_p/R_s$)$^2$ (ppm)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">3.3</span><span class="p">,</span> <span class="mi">6850</span><span class="p">,</span> <span class="s1">&#39;CH$_4$&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">4.25</span><span class="p">,</span> <span class="mi">6700</span><span class="p">,</span> <span class="s1">&#39;CO&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.3</span><span class="p">,</span> <span class="mi">6750</span><span class="p">,</span> <span class="s1">&#39;CH$_4$&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.75</span><span class="p">,</span> <span class="mi">6550</span><span class="p">,</span> <span class="s1">&#39;H$_2$O&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">5700</span><span class="p">,</span> <span class="mi">7000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5c7908c65aa7eb7756bfc664222f3637c55ccde5fbdbcd775c9cb43ce7d9bafe.png" src="../../_images/5c7908c65aa7eb7756bfc664222f3637c55ccde5fbdbcd775c9cb43ce7d9bafe.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 2000x1400 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<p>By and large, the injected transit depths are well recovered across the spectra, with features such as H<span class="math notranslate nohighlight">\(_2\)</span>O and CH<span class="math notranslate nohighlight">\(_4\)</span> easily detected. There is a bit of an offset in data-points long-ward of 3.5 <span class="math notranslate nohighlight">\(\mu\)</span>m that could perhaps be due to changes in CO<span class="math notranslate nohighlight">\(_2\)</span> or H<span class="math notranslate nohighlight">\(_2\)</span>O absorption features from ice built up on the cryogenic window during the CV3 test. These wavelengths show some increases in time correlated noise (<span class="math notranslate nohighlight">\(\sigma_r\)</span>), which has been measured here, and the errors in the plot also show the transit depths with this error included.</p>
<p>The precisions from the ground-based test are very encouraging, with the best measured bin (which occurs in a clean part of the spectrum with high count rates) achieving near-photon limited transit depths measured to about 30 ppm in only 2 hours of data, and with minimal time correlated noise (<span class="math notranslate nohighlight">\(\sigma_r\)</span>).</p>
<p>For more robust error estimates, in practice the least-squares minimization performed here would be replaced by an MCMC routine.  In addition, with actual transit data, the transit fit parameters (e.g. <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(a/R_{star}\)</span>, T<span class="math notranslate nohighlight">\(_0\)</span>) would also have to be first fit as well, as they can/will differ from literature estimates in high precision transit light curves as JWST will provide.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/transit_spectroscopy_notebook"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../mos_spectroscopy_advanced/MOSspec_advanced.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">MOS Spectroscopy of Extragalactic Field</p>
      </div>
    </a>
    <a class="right-next"
       href="../galaxy_redshift/redshift_fitting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Redshift and Template Fitting</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">BOTS Time Series Observations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-parameters">Setup Parameters</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-load-nirspec-data">Download and Load NIRSpec data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-2d-spectral-data">Visualizing the 2D spectral data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-1d-spectra-from-2d-array-of-images">Extract 1D spectra from 2D array of images</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-1d-spectral-data">Visualizing the 1D spectral data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes">Calculate Orbital Phase and a separate fine grid model used for plotting purposes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-systematic-drift-on-the-detector">Dealing with Systematic Drift On the Detector</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-arrays-of-the-vectors-used-for-detrending">Create arrays of the vectors used for detrending.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transit-and-limb-darkening-model-functions">Transit and Limb-Darkening Model Functions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-transit-model-function">Now define the transit model function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data">Now define the function to generate the transit light curve and compare it to the data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-transit-light-curves">FIT Transit Light Curves</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-wavelengths-to-fit-over">Setup Wavelengths to fit over</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-wavelength-bins-fitting-each-lightcurve">Loop Over Wavelength Bins Fitting Each Lightcurve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin">Note this step takes considerable time to complete (~20 min, few minutes/bin)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-measured-exoplanet-transmission-spectrum-vs-injected">Plot Measured Exoplanet Transmission Spectrum vs Injected</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>