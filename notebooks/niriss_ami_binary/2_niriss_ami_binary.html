<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   NIRISS AMI: Pipeline — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html" rel="next" title="SOSS Transit Spectroscopy"/>
  <link href="1_niriss_ami_binary.html" rel="prev" title="NIRISS AMI: MIRAGE Simulations"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00.%20Optimal%20extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01.%20Combine%20and%20normalize%201D%20spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02.%20Cross%20correlation%20template.html">
            Part 2: Cross Correlation to Determine Redshift of NIRISS WFSS Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03.%20Spatially%20resolved%20emission%20line%20map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="1_niriss_ami_binary.html">
            AMI - MIRAGE
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            AMI - Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
            SOSS Transit Spectroscopy
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Modeling
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction_dynamic/Spectral%20Extraction.html">
            NIRSpec MOS Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/niriss_ami_binary/2_niriss_ami_binary.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/niriss_ami_binary/2_niriss_ami_binary.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#imports">
           Imports
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#loading-data">
           Loading data
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#examine-the-input-raw-files">
           Examine the input raw files
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#define-output-directory-and-non-default-reference-files-directory">
           Define output directory and non-default reference files directory
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#run-detector1-and-image2-pipelines">
           Run Detector1 and Image2 pipelines
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#examine-the-output-files">
           Examine the output files
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#rate-and-rateints-files">
             rate and rateints files
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#cal-and-calints-files">
             cal and calints files
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#display-calibrated-data">
           Display calibrated data
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#run-implaneia-to-reduce-calibrated-images-to-fringe-observables">
           Run ImPlaneIA to reduce calibrated images to fringe observables
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#define-functions">
             Define functions
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#run-implaneia">
             Run ImPlaneIA
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#examine-the-output-products">
             Examine the output products
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#information-about-observables-calculated-from-the-1st-integration">
             Information about observables calculated from the 1st integration
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#oifits-files-for-the-target-and-calibrator">
             OIFITS files for the target and calibrator
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#calibrate-the-closure-phases-and-fringe-amplitudes-of-target-with-the-closure-phases-and-fringe-amplitudes-of-the-calibrator">
             Calibrate the closure phases and fringe amplitudes of target with the closure phases and fringe amplitudes of the calibrator.
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#aditional-resources">
           Aditional Resources
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#about-this-notebook">
           About this notebook
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         NIRISS AMI: Pipeline
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#imports">
              Imports
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#loading-data">
              Loading data
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#examine-the-input-raw-files">
              Examine the input raw files
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#define-output-directory-and-non-default-reference-files-directory">
              Define output directory and non-default reference files directory
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#run-detector1-and-image2-pipelines">
              Run Detector1 and Image2 pipelines
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#examine-the-output-files">
              Examine the output files
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#rate-and-rateints-files">
                rate and rateints files
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#cal-and-calints-files">
                cal and calints files
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#display-calibrated-data">
              Display calibrated data
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#run-implaneia-to-reduce-calibrated-images-to-fringe-observables">
              Run ImPlaneIA to reduce calibrated images to fringe observables
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#define-functions">
                Define functions
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#run-implaneia">
                Run ImPlaneIA
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#examine-the-output-products">
                Examine the output products
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#information-about-observables-calculated-from-the-1st-integration">
                Information about observables calculated from the 1st integration
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#oifits-files-for-the-target-and-calibrator">
                OIFITS files for the target and calibrator
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#calibrate-the-closure-phases-and-fringe-amplitudes-of-target-with-the-closure-phases-and-fringe-amplitudes-of-the-calibrator">
                Calibrate the closure phases and fringe amplitudes of target with the closure phases and fringe amplitudes of the calibrator.
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#aditional-resources">
              Aditional Resources
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#about-this-notebook">
              About this notebook
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="niriss-ami-pipeline">
          <h1>
           NIRISS AMI: Pipeline
           <a class="headerlink" href="#niriss-ami-pipeline" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           Run pipeline on NIRISS AMI simulated.
           <br/>
           <strong>
            Data:
           </strong>
           JWST simulated NIRISS data from MIRAGE.
           <br/>
           <strong>
            Tools:
           </strong>
           mirage, jwst, astropy.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            This notebook runs JWST pipeline on Aperture Masking Interferometry(AMI) data of binary point source AB Dor and calibrator HD37093 simulated with Mirage.
           </p>
           <p>
            Steps:
           </p>
           <p>
            [1] Run Detector1 pipeline on all _uncal.fits files to create _rate.fits and _rateints.fits files.
           </p>
           <p>
            [2] Run Image2 pipeline on all _rate.fits files to create _cal.fits and on _rateints.fits files to
create _calints.fits files.
           </p>
           <p>
            [3] Run ImPlaneIA (
            <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2015ApJ...798...68G/abstract">
             Greenbaum, A. et al. 2015
            </a>
            ) to extract observables in oifits format.
           </p>
           <p>
            <em>
             Developer Note:
            </em>
            Create the conda environment needed to run this notebook by issuing the following command:
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="o">&lt;</span><span class="n">myenv</span><span class="o">&gt;</span> <span class="n">python</span><span class="o">=</span><span class="mf">3.6</span>
</pre>
            </div>
           </div>
           <p>
            Activate the environment and then open the notebook.
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="n">conda</span> <span class="n">activate</span> <span class="o">&lt;</span><span class="n">myenv</span><span class="o">&gt;</span>
<span class="n">jupyter</span> <span class="n">notebook</span>
</pre>
            </div>
           </div>
          </section>
          <hr class="docutils"/>
          <section id="imports">
           <h2>
            Imports
            <a class="headerlink" href="#imports" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Describe the libraries we’re using here. If there’s something unusual, explain what the library is, and why we need it.
           </p>
           <ul class="simple">
            <li>
             <p>
              <em>
               numpy
              </em>
              to handle array functions
             </p>
            </li>
            <li>
             <p>
              <em>
               <a class="reference external" href="http://astropy.io">
                astropy.io
               </a>
               fits
              </em>
              for accessing FITS files
             </p>
            </li>
            <li>
             <p>
              <em>
               matplotlib.pyplot
              </em>
              for plotting data
             </p>
            </li>
            <li>
             <p>
              <em>
               zipfile
              </em>
              for accessing zip file
             </p>
            </li>
            <li>
             <p>
              <em>
               urllib.request
              </em>
              to access URL
             </p>
            </li>
            <li>
             <p>
              <em>
               jwst.pipeline Detector1Pipeline, Image2Pipeline
              </em>
              for calibrating raw data
             </p>
            </li>
            <li>
             <p>
              ImplaneIA to extract interferometric obssrvables from calibrated data
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Detector1Pipeline</span><span class="p">,</span> <span class="n">Image2Pipeline</span>

<span class="kn">from</span> <span class="nn">nrm_analysis.misctools</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">nrm_analysis</span>
<span class="kn">from</span> <span class="nn">nrm_analysis.fringefitting.LG_Model</span> <span class="kn">import</span> <span class="n">NRM_Model</span>
<span class="kn">from</span> <span class="nn">nrm_analysis</span> <span class="kn">import</span> <span class="n">nrm_core</span><span class="p">,</span> <span class="n">InstrumentData</span>
<span class="kn">from</span> <span class="nn">nrm_analysis</span> <span class="kn">import</span> <span class="n">find_affine2d_parameters</span> <span class="k">as</span> <span class="n">FAP</span>
<span class="kn">from</span> <span class="nn">nrm_analysis.misctools.implane2oifits</span> <span class="kn">import</span> <span class="n">calibrate_oifits</span>

<span class="kn">from</span> <span class="nn">nrm_analysis.misctools.utils</span> <span class="kn">import</span> <span class="n">Affine2d</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            <em>
             Developer Note:
            </em>
            Plese follow the instructions on
            <a class="reference external" href="https://webbpsf.readthedocs.io/en/latest/installation.html">
             https://webbpsf.readthedocs.io/en/latest/installation.html
            </a>
            to download WebbPSF data
files and create WEBBPSF_PATH location.
           </p>
           <div class="alert alert-info">
            <p>
             <strong>
              Note:
             </strong>
             DO NOT UPGRADE PYSIAF AS INSTRUCTED BY THE ABOVE WARNING.
Pysiaf 0.10.0 uses PRD release PRDOPSSOC-031. APT 2020.4.1 that was used to create the xml and pointing files used in this notebook uses PRDOPSSOC-030. The mismatch bewtween these two PRD versions causes incorrect placement of PSF. The version of Mirage used in this notebook comes with pysiaf 0.10.0. It was downgraded to 0.9.0 using the file requirements.txt to resolve the placement issue. Using Pysiaf 0.10.0 will cause incorrect placement of the PSF.
            </p>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">nrm_analysis</span><span class="o">.</span><span class="n">__path__</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="o">%</span><span class="k">pwd</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="loading-data">
           <h2>
            Loading data
            <a class="headerlink" href="#loading-data" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Download simulated data created by 1_niriss_ami_binary.ipynb and reference files needed to calibrate data without bad pixels.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">boxlink</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/niriss_ami_binary/niriss_ami_binary2.zip'</span>
<span class="n">boxfile</span> <span class="o">=</span> <span class="s1">'./niriss_ami_binary2.zip'</span>

<span class="c1"># Download zip file</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">boxfile</span><span class="p">):</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>

    <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Define directory that has existing Mirage simulations</span>
<span class="n">currentdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">mirage_sim_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">currentdir</span><span class="p">,</span> <span class="s1">'mirage_sim_data/'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mirage_sim_dir</span><span class="p">)</span>
<span class="n">datafiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">mirage_sim_dir</span> <span class="o">+</span> <span class="s1">'jw*uncal.fits'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datafiles</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="examine-the-input-raw-files">
           <h2>
            Examine the input raw files
            <a class="headerlink" href="#examine-the-input-raw-files" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datafiles</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"AB-Dor"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"HD37093"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">11</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="define-output-directory-and-non-default-reference-files-directory">
           <h2>
            Define output directory and non-default reference files directory
            <a class="headerlink" href="#define-output-directory-and-non-default-reference-files-directory" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Note that we will not use the cfgfiles but update the steps and override reference files using the .run() method.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Define output directory to save pipeline output products and default configuration files.</span>
<span class="n">odir</span> <span class="o">=</span> <span class="s1">'./pipeline_calibrated_data/'</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">odir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">odir</span><span class="p">)</span>

<span class="c1"># Define path to non-default reference files.</span>
<span class="c1"># We are using these files to calibrate data that is simulated without bad pixels.</span>
<span class="n">refdir</span> <span class="o">=</span> <span class="s1">'./ref_files_non_default/'</span>

<span class="c1"># os.environ['CRDS_PATH']='$HOME/crds_cache'</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'CRDS_SERVER_URL'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'https://jwst-crds.stsci.edu'</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'CRDS_CONTEXT'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'jwst_0641.pmap'</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="run-detector1-and-image2-pipelines">
           <h2>
            Run Detector1 and Image2 pipelines
            <a class="headerlink" href="#run-detector1-and-image2-pipelines" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">datafiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">mirage_sim_dir</span> <span class="o">+</span> <span class="s1">'jw*uncal.fits'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datafiles</span><span class="p">)</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">datafiles</span><span class="p">:</span>
<span class="c1"># Run Detector1, Image 2 pipelines</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="p">()</span>
    <span class="n">superbiasfile</span> <span class="o">=</span> <span class="n">refdir</span> <span class="o">+</span> <span class="s1">'jwst_niriss_superbias_sim.fits'</span>
    <span class="n">darkfile</span> <span class="o">=</span> <span class="n">refdir</span> <span class="o">+</span> <span class="s1">'jwst_niriss_dark_sub80_sim.fits'</span>
    <span class="n">result1</span><span class="o">.</span><span class="n">superbias</span><span class="o">.</span><span class="n">override_superbias</span> <span class="o">=</span> <span class="n">superbiasfile</span>
    <span class="n">result1</span><span class="o">.</span><span class="n">dark_current</span><span class="o">.</span><span class="n">override_dark</span> <span class="o">=</span> <span class="n">darkfile</span>
    <span class="n">result1</span><span class="o">.</span><span class="n">ipc</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result1</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result1</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">odir</span>
    <span class="n">result1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">df_rate</span> <span class="o">=</span> <span class="n">odir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'uncal'</span><span class="p">,</span> <span class="s1">'rate'</span><span class="p">))</span>
    <span class="n">flatfieldfile</span> <span class="o">=</span> <span class="n">refdir</span> <span class="o">+</span> <span class="s2">"jwst_niriss_flat_general.fits"</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">Image2Pipeline</span><span class="p">()</span>
    <span class="n">result2</span><span class="o">.</span><span class="n">flat_field</span><span class="o">.</span><span class="n">override_flat</span> <span class="o">=</span> <span class="n">flatfieldfile</span>
    <span class="n">result2</span><span class="o">.</span><span class="n">photom</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result2</span><span class="o">.</span><span class="n">resample</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result2</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result2</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">odir</span>
    <span class="n">result2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">df_rate</span><span class="p">)</span>

    <span class="n">df_rateints</span> <span class="o">=</span> <span class="n">odir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'uncal'</span><span class="p">,</span> <span class="s1">'rateints'</span><span class="p">))</span>
    <span class="n">result3</span> <span class="o">=</span> <span class="n">Image2Pipeline</span><span class="p">()</span>
    <span class="n">result3</span><span class="o">.</span><span class="n">flat_field</span><span class="o">.</span><span class="n">override_flat</span> <span class="o">=</span> <span class="n">flatfieldfile</span>
    <span class="n">result3</span><span class="o">.</span><span class="n">photom</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result3</span><span class="o">.</span><span class="n">resample</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result3</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result3</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">odir</span>
    <span class="n">result3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">df_rateints</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="examine-the-output-files">
           <h2>
            Examine the output files
            <a class="headerlink" href="#examine-the-output-files" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">ratefiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s1">'jw*rate.fits'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ratefiles</span><span class="p">)</span>
<span class="n">rateintsfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s1">'jw*rateints.fits'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rateintsfiles</span><span class="p">)</span>
<span class="n">calfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s1">'jw*cal.fits'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">calfiles</span><span class="p">)</span>
<span class="n">calintsfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s1">'jw*calints.fits'</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">calintsfiles</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="rate-and-rateints-files">
            <h3>
             rate and rateints files
             <a class="headerlink" href="#rate-and-rateints-files" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rateintf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rateintsfiles</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rateintf</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ratef</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ratefiles</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ratef</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="cal-and-calints-files">
            <h3>
             cal and calints files
             <a class="headerlink" href="#cal-and-calints-files" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">calintf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calintsfiles</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">calintf</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">calf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calfiles</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">calf</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="display-calibrated-data">
           <h2>
            Display calibrated data
            <a class="headerlink" href="#display-calibrated-data" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">calfiles</span><span class="p">:</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="c1"># print(data[0].shape, data[1].shape)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"AB-Dor 2D calibrated file"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"HD37093 2D calibrated file"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="run-implaneia-to-reduce-calibrated-images-to-fringe-observables">
           <h2>
            Run ImPlaneIA to reduce calibrated images to fringe observables
            <a class="headerlink" href="#run-implaneia-to-reduce-calibrated-images-to-fringe-observables" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="define-functions">
            <h3>
             Define functions
             <a class="headerlink" href="#define-functions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">160</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">examine_observables</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="mi">36</span><span class="p">):</span>
    <span class="sd">""" input: FringeFitter instance after fringes are fit """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Examine_observables, standard deviations &amp; variances of *independent* CP's and CAs:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"   Closure phase mean </span><span class="si">{:+.4f}</span><span class="s2">  std dev </span><span class="si">{:.2e}</span><span class="s2">  var </span><span class="si">{:.2e}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">redundant_cps</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>\
              <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">cp_var</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">redundant_cps</span><span class="p">)),</span> <span class="n">utils</span><span class="o">.</span><span class="n">cp_var</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">redundant_cps</span><span class="p">)))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"   Closure amp   mean </span><span class="si">{:+.4f}</span><span class="s2">  std dev </span><span class="si">{:.2e}</span><span class="s2">  var </span><span class="si">{:.2e}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">redundant_cas</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>\
              <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">cp_var</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">redundant_cas</span><span class="p">)),</span> <span class="n">utils</span><span class="o">.</span><span class="n">cp_var</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">redundant_cas</span><span class="p">)))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"    Fringe amp   mean </span><span class="si">{:+.4f}</span><span class="s2">  std dev </span><span class="si">{:.2e}</span><span class="s2">  var </span><span class="si">{:.2e}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">fringeamp</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                                                                             <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">fringeamp</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                                                                             <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">fringeamp</span><span class="o">.</span><span class="n">var</span><span class="p">()))</span>

    <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="p">{</span><span class="s1">'float'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">'</span><span class="si">{:+.1e}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)},</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">" Normalized residuals central 6 pixels"</span><span class="p">)</span>
    <span class="n">tlo</span><span class="p">,</span> <span class="n">thi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">residual</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">residual</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">((</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">residual</span><span class="o">/</span><span class="n">ff</span><span class="o">.</span><span class="n">datapeak</span><span class="p">)[</span><span class="n">tlo</span><span class="p">:</span><span class="n">thi</span><span class="p">,</span> <span class="n">tlo</span><span class="p">:</span><span class="n">thi</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">" Normalized residuals max and min: </span><span class="si">{:.2e}</span><span class="s2">, </span><span class="si">{:.2e}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">residual</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">ff</span><span class="o">.</span><span class="n">datapeak</span><span class="p">,</span>
                                                                     <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">residual</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">ff</span><span class="o">.</span><span class="n">datapeak</span><span class="p">))</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">default_printoptions</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">raw_observables</span><span class="p">(</span><span class="n">fitsfn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fitsimdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">affine2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">psf_offset_find_rotation</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                    <span class="n">psf_offset_ff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">rotsearch_d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">set_pistons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">oversample</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">mnem</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
                    <span class="n">firstfew</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">        Reduce calibrated data to fringe observables</span>

<span class="sd">        returns: affine2d (measured or input),</span>
<span class="sd">        psf_offset_find_rotation (input),</span>
<span class="sd">        psf_offset_ff (input or found),</span>
<span class="sd">        fringe pistons/r (found)</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"raw_observables: input"</span><span class="p">,</span> <span class="n">fitsimdir</span> <span class="o">+</span> <span class="n">fitsfn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"raw_observables: oversample"</span><span class="p">,</span> <span class="n">oversample</span><span class="p">)</span>

    <span class="n">fobj</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsimdir</span> <span class="o">+</span> <span class="n">fitsfn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fobj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'FILTER'</span><span class="p">])</span>
    <span class="n">niriss</span> <span class="o">=</span> <span class="n">InstrumentData</span><span class="o">.</span><span class="n">NIRISS</span><span class="p">(</span><span class="n">fobj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'FILTER'</span><span class="p">],</span>
                                   <span class="n">bpexist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">firstfew</span><span class="o">=</span><span class="n">firstfew</span><span class="p">,</span><span class="c1"># read_data truncation to only read first few slices...</span>
                                   <span class="p">)</span>


    <span class="n">ff</span> <span class="o">=</span> <span class="n">nrm_core</span><span class="o">.</span><span class="n">FringeFitter</span><span class="p">(</span><span class="n">niriss</span><span class="p">,</span>
                               <span class="n">datadir</span><span class="o">=</span><span class="n">fitsimdir</span><span class="p">,</span>
                               <span class="n">savedir</span><span class="o">=</span><span class="n">fitsimdir</span><span class="p">,</span>
                               <span class="n">oversample</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span>
                               <span class="n">oifprefix</span><span class="o">=</span><span class="s2">"ov</span><span class="si">{:d}</span><span class="s2">_"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oversample</span><span class="p">)</span><span class="o">+</span><span class="n">mnem</span><span class="p">,</span>
                               <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">save_txt_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ff</span><span class="o">.</span><span class="n">fit_fringes</span><span class="p">(</span><span class="n">fitsimdir</span> <span class="o">+</span> <span class="n">fitsfn</span><span class="p">)</span>
    <span class="n">examine_observables</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">formatter</span><span class="o">=</span><span class="p">{</span><span class="s1">'float'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">'</span><span class="si">{:+.2e}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)},</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"raw_observables: fringepistons/rad"</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">fringepistons</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">default_printoptions</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">affine2d</span><span class="p">,</span> <span class="n">psf_offset_find_rotation</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">psf_offset</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">nrm</span><span class="o">.</span><span class="n">fringepistons</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">fitsimdir</span><span class="p">,</span> <span class="n">ifn</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mnem</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">firstfew</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    fitsimdir: string: dir containing data file</span>
<span class="sd">    ifn: str inout file name</span>

<span class="sd">    """</span>

    <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">formatter</span><span class="o">=</span><span class="p">{</span><span class="s1">'float'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">'</span><span class="si">{:+.2e}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)},</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"main: "</span><span class="p">,</span> <span class="n">ifn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"main: fitsimdir"</span><span class="p">,</span> <span class="n">fitsimdir</span><span class="p">)</span>

    <span class="n">aff</span><span class="p">,</span> <span class="n">psf_offset_r</span><span class="p">,</span> <span class="n">psf_offset_ff</span><span class="p">,</span> <span class="n">fringepistons</span> <span class="o">=</span> <span class="n">raw_observables</span><span class="p">(</span><span class="n">ifn</span><span class="p">,</span> <span class="n">fitsimdir</span><span class="p">,</span>
                                                                      <span class="n">oversample</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span>
                                                                      <span class="n">mnem</span><span class="o">=</span><span class="n">mnem</span><span class="p">,</span>
                                                                      <span class="n">firstfew</span><span class="o">=</span><span class="n">firstfew</span><span class="p">,</span>
                                                                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'aff'</span><span class="p">,</span> <span class="n">aff</span><span class="p">,</span> <span class="s1">'psf_offset_r'</span><span class="p">,</span> <span class="n">psf_offset_r</span><span class="p">,</span> <span class="s1">'psf_offset_ff'</span><span class="p">,</span> <span class="n">psf_offset_ff</span><span class="p">,</span> <span class="s1">'fringepistons'</span><span class="p">,</span> <span class="n">fringepistons</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">aff</span>
    <span class="k">del</span> <span class="n">psf_offset_r</span>
    <span class="k">del</span> <span class="n">psf_offset_ff</span>
    <span class="k">del</span> <span class="n">fringepistons</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="run-implaneia">
            <h3>
             Run ImPlaneIA
             <a class="headerlink" href="#run-implaneia" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">mirdatafiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'jw01093001001_01101_00001_nis_calints.fits'</span><span class="p">,</span>
                <span class="s1">'jw01093002001_01101_00001_nis_calints.fits'</span><span class="p">,</span>
               <span class="p">]</span>

<span class="c1"># Choose FIRSTFEW = None to analyze all integrations</span>
<span class="n">FIRSTFEW</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">OVERSAMPLE</span> <span class="o">=</span> <span class="mi">7</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'FIRSTFEW'</span><span class="p">,</span> <span class="n">FIRSTFEW</span><span class="p">,</span> <span class="s1">'OVERSAMPLE'</span><span class="p">,</span> <span class="n">OVERSAMPLE</span><span class="p">)</span>

<span class="n">datasuperdir</span> <span class="o">=</span> <span class="n">odir</span>

<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">fnmir</span> <span class="ow">in</span> <span class="n">mirdatafiles</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Analyzing</span><span class="se">\n</span><span class="s1">   '</span><span class="p">,</span> <span class="n">COUNT</span><span class="p">,</span> <span class="n">fnmir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.fits'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">datasuperdir</span> <span class="o">+</span> <span class="n">fnmir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">'FILTER'</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">'TARGNAME'</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">'TARGPROP'</span><span class="p">])</span>
    <span class="c1"># next line for convenient use in oifits writer which looks up target online</span>
    <span class="n">catname</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">'TARGPROP'</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="c1"># for target lookup on-line, otherwise UNKNOWN used</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">datasuperdir</span> <span class="o">+</span> <span class="n">fnmir</span><span class="p">,</span> <span class="s1">'TARGNAME'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">catname</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">datasuperdir</span> <span class="o">+</span> <span class="n">fnmir</span><span class="p">,</span> <span class="s1">'TARGPROP'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">catname</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">fitsimdir</span><span class="o">=</span><span class="n">datasuperdir</span><span class="p">,</span>
         <span class="n">ifn</span><span class="o">=</span><span class="n">fnmir</span><span class="p">,</span>
         <span class="n">oversample</span><span class="o">=</span><span class="n">OVERSAMPLE</span><span class="p">,</span>
         <span class="n">mnem</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
         <span class="n">firstfew</span><span class="o">=</span><span class="n">FIRSTFEW</span><span class="p">,</span>
         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">COUNT</span> <span class="o">+=</span> <span class="mi">1</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="examine-the-output-products">
            <h3>
             Examine the output products
             <a class="headerlink" href="#examine-the-output-products" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Analytical model is created and interferometric observables are calculated for each integration of the data. The output products are stored in a folder that has rootname of the file, jw01093001001_01101_00001_nis_calints for AB-dor and jw01093001001_01101_00001_nis_calints foir HD37093.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># integration 0 (1st integration)</span>
<span class="n">results_int0</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s2">"jw01093001001_01101_00001_nis_calints/*00*"</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">results_int0</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="information-about-observables-calculated-from-the-1st-integration">
            <h3>
             Information about observables calculated from the 1st integration
             <a class="headerlink" href="#information-about-observables-calculated-from-the-1st-integration" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="highlight-default notranslate">
             <div class="highlight">
              <pre><span></span><span class="o">-</span> <span class="n">phases_00</span><span class="o">.</span><span class="n">txt</span><span class="p">:</span> <span class="mi">35</span> <span class="n">fringe</span> <span class="n">phases</span>
<span class="o">-</span> <span class="n">amplitudes_00</span><span class="o">.</span><span class="n">txt</span><span class="p">:</span> <span class="mi">21</span> <span class="n">fringe</span> <span class="n">amplitudes</span>
<span class="o">-</span> <span class="n">CPs_00</span><span class="o">.</span><span class="n">txt</span><span class="p">:</span> <span class="mi">35</span> <span class="n">closure</span> <span class="n">phases</span>
<span class="o">-</span> <span class="n">CAs_00</span><span class="o">.</span><span class="n">txt</span><span class="p">:</span> <span class="mi">35</span> <span class="n">closure</span> <span class="n">amplitudes</span>
<span class="o">-</span> <span class="n">fringepistons_00</span><span class="o">.</span><span class="n">txt</span><span class="p">:</span> <span class="mi">7</span> <span class="n">pistons</span> <span class="p">(</span><span class="n">optical</span> <span class="n">path</span> <span class="n">delays</span> <span class="n">between</span> <span class="n">mask</span> <span class="n">holes</span><span class="p">)</span>
<span class="o">-</span> <span class="n">solutions_00</span><span class="o">.</span><span class="n">txt</span><span class="p">:</span> <span class="mi">44</span> <span class="n">fringe</span> <span class="n">coefficients</span> <span class="n">of</span> <span class="n">terms</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">analytical</span> <span class="n">model</span>
<span class="o">-</span> <span class="n">modelsolution_00</span><span class="o">.</span><span class="n">fits</span><span class="p">:</span> <span class="n">analytical</span> <span class="n">model</span>
<span class="o">-</span> <span class="n">n_modelsolution_00</span><span class="o">.</span><span class="n">fits</span><span class="p">:</span> <span class="n">normalized</span> <span class="n">analytical</span> <span class="n">model</span>
<span class="o">-</span> <span class="n">residual_00</span><span class="o">.</span><span class="n">fits</span><span class="p">:</span> <span class="n">data</span> <span class="o">-</span> <span class="n">model</span>
<span class="o">-</span> <span class="n">n_residual_00</span><span class="o">.</span><span class="n">fits</span><span class="p">:</span> <span class="n">normalized</span> <span class="n">residual</span>

</pre>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">cropped_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s2">"jw01093001001_01101_00001_nis_calints/centered_0.fits"</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s2">"jw01093001001_01101_00001_nis_calints/modelsolution_00.fits"</span><span class="p">)</span>
<span class="n">residual</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s2">"jw01093001001_01101_00001_nis_calints/residual_00.fits"</span><span class="p">)</span>
<span class="n">n_residual</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s2">"jw01093001001_01101_00001_nis_calints/n_residual_00.fits"</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"AB-Dor cropped data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cropped_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"AB-Dor analytical model"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"AB-Dor residual (data - model)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"AB-Dor normalized residual"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">n_residual</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.03</span><span class="p">,</span><span class="mf">0.03</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="oifits-files-for-the-target-and-calibrator">
            <h3>
             OIFITS files for the target and calibrator
             <a class="headerlink" href="#oifits-files-for-the-target-and-calibrator" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             OIFITS is the standard data exchange format for Optical Interferometry.  It is based on the Flexible Image Transport System (FITS).  OIFITS files include data tables for storing interferometric observables, including squared visibilities and closure phases.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">odirfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">odir</span> <span class="o">+</span> <span class="s2">"*oifits"</span><span class="p">)</span>
<span class="n">odirfiles</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="calibrate-the-closure-phases-and-fringe-amplitudes-of-target-with-the-closure-phases-and-fringe-amplitudes-of-the-calibrator">
            <h3>
             Calibrate the closure phases and fringe amplitudes of target with the closure phases and fringe amplitudes of the calibrator.
             <a class="headerlink" href="#calibrate-the-closure-phases-and-fringe-amplitudes-of-target-with-the-closure-phases-and-fringe-amplitudes-of-the-calibrator" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             This step is necessary to remove instrumental contribution to closure phases and fringe amplitudes.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Define the target and calibrator OIFITS files</span>
<span class="n">targ_oifits</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">odir</span><span class="p">,</span> <span class="s1">'*ABDOR*oifits'</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cal_oifits</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">odir</span><span class="p">,</span> <span class="s1">'*HD37093*oifits'</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Produce a single calibrated OIFITS file</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"************  Running calibrate ***************"</span><span class="p">)</span>
<span class="n">calibrate_oifits</span><span class="p">(</span><span class="n">targ_oifits</span><span class="p">,</span> <span class="n">cal_oifits</span><span class="p">,</span> <span class="n">oifprefix</span><span class="o">=</span><span class="s1">'calib_'</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">odir</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"The output of calibrate is calibrated oifits file that will be used as an input to 3_niriss_ami_binary.ipynb."</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="aditional-resources">
           <h2>
            Aditional Resources
            <a class="headerlink" href="#aditional-resources" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-imager-and-slitless-spectrograph/niriss-observing-modes/niriss-aperture-masking-interferometry">
               JWST NIRISS AMI
              </a>
             </p>
            </li>
           </ul>
          </section>
          <section id="about-this-notebook">
           <h2>
            About this notebook
            <a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <strong>
             Author:
            </strong>
            Deepashri Thatte, Anand Sivaramakrishnan, Rachel Cooper,
            <strong>
             Updated On:
            </strong>
            2020-12-18
           </p>
           <hr class="docutils"/>
           <p>
            <a class="reference external" href="#top">
             Top of Page
            </a>
            <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="float: right;" width="200px"/>
           </p>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/niriss_ami_binary"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="1_niriss_ami_binary.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            NIRISS AMI: MIRAGE Simulations
           </p>
          </div>
         </a>
         <a class="right-next" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            SOSS Transit Spectroscopy
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>