

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Cross-Filter PSF Matching &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="PSF Photometry" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html" />
    <link rel="prev" title="Extended Aperture Photometry" href="../NIRCam_photometry/NIRCam_multiband_photometry.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1 current active"><a class="current reference internal" href="#">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/niriss_imaging/niriss-imaging-tutorial.html">NIRISS Imaging Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cross-Filter PSF Matching</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import packages</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">Matplotlib setup for plotting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-list-of-images-to-be-loaded-and-analyzed">Create list of images to be loaded and analyzed</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-detection-image-f200w">Load detection image: F200W</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#report-image-size-and-field-of-view">Report image size and field of view</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-color-images-optional">Create color images (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detect-sources-and-deblend-using-astropy-photutils">Detect Sources and Deblend using astropy.photutils</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#measure-photometry-and-more-in-detection-image">Measure photometry (and more) in detection image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-detections-alongside-images-optional">Show detections alongside images (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-save-measured-quantities-in-detection-image-optional">View / save measured quantities in detection image (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#only-keep-some-quantities">Only keep some quantities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-measured-fluxes-data-units-to-magnitudes">Convert measured fluxes (data units) to magnitudes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiband-photometry-using-isophotal-apertures-defined-in-detection-image">Multiband photometry using isophotal apertures defined in detection image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-corrections-isophotal-to-total-kron-aperture-fluxes">Aperture corrections: isophotal to total (Kron aperture) fluxes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reformat-output-catalog-for-readability-optional">Reformat output catalog for readability (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#isophotal-photometry-without-psf-corrections-complete">Isophotal Photometry without PSF corrections complete</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-magnitude-corrections">PSF magnitude corrections</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-psfs">Load PSFs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-matching">PSF Matching</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-psf-convolution-kernels">Determine PSF convolution kernels</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convolve-f200w-detection-image-to-long-wavelength-psfs">Convolve F200W detection image to Long Wavelength PSFs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiband-photometry-in-convolved-images">Multiband photometry in convolved images</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">PSF magnitude corrections</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#start-new-session-and-analyze-results">Start new session and analyze results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-catalog-and-segmentation-map">Load catalog and segmentation map</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-simulation-jades-jaguar-catalog">Input simulation JADES JAGUAR catalog</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#match-objects-to-photutils-catalog">Match objects to photutils catalog</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts">Plot F200W vs. F090W magnitudes and look for dropouts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-selected-object-in-all-filters">Show selected object in all filters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-spectral-energy-distribution-sed-for-one-object">Plot Spectral Energy Distribution (SED) for one object</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="cross-filter-psf-matching">
<h1>Cross-Filter PSF Matching<a class="headerlink" href="#cross-filter-psf-matching" title="Permalink to this heading">#</a></h1>
<p><strong>Use case:</strong> Measure galaxy photometry in an extragalactic “blank” field. Related to <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-example-science-programs/nircam-deep-field-imaging-with-miri-imaging-parallels">JDox Science Use Case #22</a>.<br>
<strong>Data:</strong> JWST simulated NIRCam images from <a class="reference external" href="http://fenrir.as.arizona.edu/jwstmock/">JADES JWST GTO extragalactic blank field</a>.<br>
(Williams et al. 2018) https://ui.adsabs.harvard.edu/abs/2018ApJS..236…33W.<br>
<strong>Tools:</strong>  photutils, matplotlib.<br>
<strong>Cross-intrument:</strong> potentially NIRISS, MIRI.<br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This notebook uses <code class="docutils literal notranslate"><span class="pre">photutils</span></code> to detect objects/galaxies in NIRCam deep imaging.  Detections are first made in a F200W image, then isophotal photometry is obtained in all 9 filters (F090W, F115W, F150W, F200W, F277W, F335M, F356W, F410M, F444W). PSF-matching is used to correct photometry measured in the Long Wavelength images (redder than F200W).</p>
<p>After saving the photometry catalog, the notebook demonstrates how one would load the notebook in a new session.
It demonstrates some simple analysis of the full catalog and on an individual galaxy.
By comparing the measured colors to simulated input colors,
it shows the measurements are more accurate after PSF corrections, though they could be improved further.</p>
<p>The notebook analyzes only the central 1000 x 1000 pixels (30” x 30”) of the full JADES simulation. These cutouts have been staged at STScI with permission from the authors (Williams et al.).</p>
<p><strong>NOTES:</strong></p>
<ul class="simple">
<li><p>This is a work in progress. More accurate photometry may be obtainable.</p></li>
<li><p>These JADES images are simulated using <a class="reference external" href="https://github.com/cnaw/guitarra">Guitarra</a>,
not <a class="reference external" href="https://github.com/spacetelescope/mirage">MIRAGE</a>.
They have different properties and units (e-/s) than JWST pipeline products (MJy/sr).</p></li>
<li><p>All images are aligned to the same 0.03” pixel grid prior to analysis. This alignment can be done using <a class="reference external" href="https://reproject.readthedocs.io"><code class="docutils literal notranslate"><span class="pre">reproject</span></code></a>, if needed.</p></li>
<li><p>The flux uncertainty calculations could be improved further by accounting for correlated noise and/or measuring the noise in each image more directly.</p></li>
</ul>
<p><em>Developer’s Note:</em></p>
<p>Summary of issues reported below:</p>
<ul class="simple">
<li><p>units work with <code class="docutils literal notranslate"><span class="pre">plot</span></code> but are incompatible with <code class="docutils literal notranslate"><span class="pre">errorbar</span></code> and <code class="docutils literal notranslate"><span class="pre">text</span></code></p></li>
<li><p>flux units can be automatically converted to AB magnitudes,
but flux <em>uncertainties</em> cannot be automatically converted to magnitude uncertainties</p></li>
<li><p>secondary axis should automatically handle conversion between flux and AB magnitude units</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sharex</span></code> and <code class="docutils literal notranslate"><span class="pre">sharey</span></code> don’t work with WCS <code class="docutils literal notranslate"><span class="pre">projection</span></code></p></li>
</ul>
<p>And I couldn’t figure out how to:</p>
<ul class="simple">
<li><p>Make plot axes autoscale to only <em>some</em> of plotted data</p></li>
<li><p>Make tooltips hover over data points under cursor in interactive plot</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check PEP 8 style formatting</span>
<span class="c1"># %load_ext pycodestyle_magic</span>
<span class="c1"># %flake8_on --ignore E261,E501,W291,W2,E302,E305</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-packages">
<h2>Import packages<a class="headerlink" href="#import-packages" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Numpy for general array computations</p></li>
<li><p>Photutils for photometry calculations, PSF matching</p></li>
<li><p>Astropy for FITS, WCS, tables, units, color images, plotting, convolution</p></li>
<li><p>os and glob for file management</p></li>
<li><p>copy for table modfications</p></li>
<li><p>Matplotlib for plotting</p></li>
<li><p>Watermark to check versions of all imports (optional)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">astropy</span>  <span class="c1"># version 4.2 is required to write magnitudes to ecsv file</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.wcs</span> <span class="k">as</span> <span class="nn">wcs</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">QTable</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">make_lupton_rgb</span><span class="p">,</span> <span class="n">SqrtStretch</span><span class="p">,</span> <span class="n">LogStretch</span><span class="p">,</span> <span class="n">hist</span>
<span class="kn">from</span> <span class="nn">astropy.visualization.mpl_normalize</span> <span class="kn">import</span> <span class="n">ImageNormalize</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian2DKernel</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">gaussian_fwhm_to_sigma</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>

<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">MedianBackground</span>
<span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="p">(</span><span class="n">detect_sources</span><span class="p">,</span> <span class="n">deblend_sources</span><span class="p">,</span> <span class="n">SourceCatalog</span><span class="p">,</span> 
                                    <span class="n">make_2dgaussian_kernel</span><span class="p">,</span> <span class="n">SegmentationImage</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">photutils.utils</span> <span class="kn">import</span> <span class="n">calc_total_error</span>

<span class="kn">from</span> <span class="nn">photutils.psf.matching</span> <span class="kn">import</span> <span class="n">resize_psf</span><span class="p">,</span> <span class="n">SplitCosineBellWindow</span><span class="p">,</span> <span class="n">create_matching_kernel</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">convolve_fft</span> <span class="c1"># , Gaussian2DKernel, Tophat2DKernel</span>
</pre></div>
</div>
</div>
</div>
<section id="matplotlib-setup-for-plotting">
<h3>Matplotlib setup for plotting<a class="headerlink" href="#matplotlib-setup-for-plotting" title="Permalink to this heading">#</a></h3>
<p>There are two versions</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">notebook</span></code> – gives interactive plots, but makes the overall notebook a bit harder to scroll</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inline</span></code> – gives non-interactive plots for better overall scrolling</p></li>
</ul>
<p><em>Developer’s Notes:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>`%matplotlib notebook` occasionally creates oversized plot; need to rerun cell to get it to settle back down
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

<span class="c1"># Use this version for non-interactive plots (easier scrolling of the notebook)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Use this version if you want interactive plots</span>
<span class="c1"># %matplotlib notebook</span>

<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="n">mpl_colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>

<span class="c1"># These gymnastics are needed to make the sizes of the figures</span>
<span class="c1"># be the same in both the inline and notebook versions</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.print_figure_kwargs = {&#39;bbox_inches&#39;: None}

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

<span class="kn">import</span> <span class="nn">mplcursors</span>  <span class="c1"># optional to hover over plotted points and reveal ID number</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show versions of Python and imported libraries</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">watermark</span>
    <span class="o">%</span><span class="k">load_ext</span> watermark
    <span class="c1"># %watermark -n -v -m -g -iv</span>
    <span class="o">%</span><span class="k">watermark</span> -iv -v
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-list-of-images-to-be-loaded-and-analyzed">
<h3>Create list of images to be loaded and analyzed<a class="headerlink" href="#create-list-of-images-to-be-loaded-and-analyzed" title="Permalink to this heading">#</a></h3>
<p>All data and weight images must be aligned to the same pixel grid.
(If needed, use <a class="reference external" href="https://reproject.readthedocs.io"><code class="docutils literal notranslate"><span class="pre">reproject</span></code></a> to do so.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_file_url</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/&#39;</span>

<span class="n">filters</span> <span class="o">=</span> <span class="s1">&#39;F090W F115W F150W F200W F277W F335M F356W F410M F444W&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">filt</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span>  <span class="c1"># e.g., F115W = 1.15 microns</span>

<span class="c1"># Data images [e-/s], unlike JWST pipeline images that will have units [Myr/sr]</span>
<span class="n">image_files</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;jades_jwst_nircam_goods_s_crop_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">.fits&#39;</span>
    <span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="c1"># Weight images (Inverse Variance Maps; IVM)</span>
<span class="n">weight_files</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;jades_jwst_nircam_goods_s_crop_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_wht.fits&#39;</span>
    <span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-detection-image-f200w">
<h3>Load detection image: F200W<a class="headerlink" href="#load-detection-image-f200w" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detection_filter</span> <span class="o">=</span> <span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">imwcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">hdu</span><span class="p">)</span>

<span class="n">weight</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="report-image-size-and-field-of-view">
<h3>Report image size and field of view<a class="headerlink" href="#report-image-size-and-field-of-view" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="c1"># image_pixel_scale = np.abs(hdu[0].header[&#39;CD1_1&#39;]) * 3600</span>
<span class="n">image_pixel_scale</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_plane_pixel_scales</span><span class="p">(</span><span class="n">imwcs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
<span class="n">image_pixel_scale</span> <span class="o">*=</span> <span class="n">imwcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
<span class="n">outline</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> x </span><span class="si">%d</span><span class="s1"> pixels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
<span class="n">outline</span> <span class="o">+=</span> <span class="s1">&#39; = </span><span class="si">%g</span><span class="s1">&quot; x </span><span class="si">%g</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ny</span> <span class="o">*</span> <span class="n">image_pixel_scale</span><span class="p">,</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">image_pixel_scale</span><span class="p">)</span>
<span class="n">outline</span> <span class="o">+=</span> <span class="s1">&#39; (</span><span class="si">%.2f</span><span class="s1">&quot; / pixel)&#39;</span> <span class="o">%</span> <span class="n">image_pixel_scale</span>
<span class="nb">print</span><span class="p">(</span><span class="n">outline</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-color-images-optional">
<h3>Create color images (optional)<a class="headerlink" href="#create-color-images-optional" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3 NIRCam short wavelength channel images</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F200W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F150W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F090W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">color_image_short_wavelength</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span> <span class="c1"># , minimum=-0.001</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3 NIRCam long wavelength channel images</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F444W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F356W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F277W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">color_image_long_wavelength</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span> <span class="c1"># , minimum=-0.001</span>
</pre></div>
</div>
</div>
</div>
<p><em>Developer’s Note:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sharex &amp; sharey appear to have some compatibility issues with projection=imwcs

As a workaround, I tried but was unable to turn off yticklabels in the right plot below
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax_sw</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">imwcs</span><span class="p">)</span> <span class="c1"># , sharex=True, sharey=True)</span>
<span class="n">ax_sw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_short_wavelength</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax_sw</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension&#39;</span><span class="p">)</span>
<span class="n">ax_sw</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination&#39;</span><span class="p">)</span>
<span class="n">ax_sw</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Short Wavelength Channel&#39;</span><span class="p">)</span>

<span class="n">ax_lw</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">imwcs</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_sw</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_sw</span><span class="p">)</span>
<span class="n">ax_lw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_long_wavelength</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax_lw</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension&#39;</span><span class="p">)</span>
<span class="n">ax_lw</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Long Wavelength Channel&#39;</span><span class="p">)</span>
<span class="n">ax_lw</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="c1"># ax_lw.set(yticklabels=[])  # this didn&#39;t work</span>

<span class="c1"># plt.subplots_adjust(left=0.15)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Interactive zoom / pan controls both images simultaneously&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="detect-sources-and-deblend-using-astropy-photutils">
<h3>Detect Sources and Deblend using astropy.photutils<a class="headerlink" href="#detect-sources-and-deblend-using-astropy-photutils" title="Permalink to this heading">#</a></h3>
<p>https://photutils.readthedocs.io/en/latest/segmentation.html</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define all detection and measurement parameters here so that we do measurements consistently for every image</span>

<span class="k">class</span> <span class="nc">Photutils_Catalog</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">image_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_file</span> <span class="o">=</span> <span class="n">image_file</span> <span class="ow">or</span> <span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imwcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeropoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ABMAG&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_file</span> <span class="o">=</span> <span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;  zeropoint =&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeropoint</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_file</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">measure_background_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkg_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Calculate sigma-clipped background in cells of 50x50 pixels, then median filter over 3x3 cells</span>
        <span class="c1"># For best results, the image should span an integer number of cells in both dimensions (here, 1000=20x50 pixels)</span>
        <span class="c1"># https://photutils.readthedocs.io/en/stable/background.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">bkg_size</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_detect_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">npixels</span><span class="p">,</span> <span class="n">smooth_fwhm</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                           <span class="n">deblend_levels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">deblend_contrast</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1"># Set detection threshold map as nsigma times RMS above background pedestal</span>
        <span class="n">detection_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background</span>

        <span class="c1"># Before detection, convolve data with Gaussian</span>
        <span class="n">smooth_kernel</span> <span class="o">=</span> <span class="n">make_2dgaussian_kernel</span><span class="p">(</span><span class="n">smooth_fwhm</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">)</span>
        <span class="n">convolved_data</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">smooth_kernel</span><span class="p">)</span>

        <span class="c1"># Detect sources with npixels connected pixels at/above threshold in data smoothed by kernel</span>
        <span class="c1"># https://photutils.readthedocs.io/en/stable/segmentation.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segm_detect</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">convolved_data</span><span class="p">,</span> <span class="n">detection_threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">npixels</span><span class="p">)</span>

        <span class="c1"># Deblend: separate connected/overlapping sources</span>
        <span class="c1"># https://photutils.readthedocs.io/en/stable/segmentation.html#source-deblending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segm_deblend</span> <span class="o">=</span> <span class="n">deblend_sources</span><span class="p">(</span><span class="n">convolved_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_detect</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">npixels</span><span class="p">,</span>
                                            <span class="n">nlevels</span><span class="o">=</span><span class="n">deblend_levels</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="n">deblend_contrast</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;Cataloged </span><span class="si">%d</span><span class="s1"> objects&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_deblend</span><span class="o">.</span><span class="n">nlabels</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;, deblended from </span><span class="si">%d</span><span class="s1"> detections&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_detect</span><span class="o">.</span><span class="n">nlabels</span>
            <span class="n">median_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms_median</span><span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_median</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39; with </span><span class="si">%d</span><span class="s1"> pixels above </span><span class="si">%g</span><span class="s1">-sigma threshold&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npixels</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span>
            <span class="c1"># Background outputs equivalent to those reported by SourceExtractor</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;Background median </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_median</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;, RMS </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms_median</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;, threshold median </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">median_threshold</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">measure_source_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">,</span> <span class="n">local_background_width</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
        <span class="c1"># &quot;effective_gain&quot; = exposure time map (conversion from data rate units to counts)</span>
        <span class="c1"># weight = inverse variance map = 1 / sigma_background**2 (without sources)</span>
        <span class="c1"># https://photutils.readthedocs.io/en/latest/api/photutils.utils.calc_total_error.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_map</span> <span class="o">=</span> <span class="n">exposure_time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms_median</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>

        <span class="c1"># Data RMS uncertainty is combination of background RMS and source Poisson uncertainties</span>
        <span class="n">background_rms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="c1"># effective gain parameter required to be positive everywhere (not zero), so adding small value 1e-8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rms</span> <span class="o">=</span> <span class="n">calc_total_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">background_rms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_map</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">SourceCatalog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_deblend</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imwcs</span><span class="p">,</span> 
                                         <span class="n">error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rms</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> 
                                         <span class="n">localbkg_width</span><span class="o">=</span><span class="n">local_background_width</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detection_catalog</span> <span class="o">=</span> <span class="n">Photutils_Catalog</span><span class="p">(</span><span class="n">detection_filter</span><span class="p">)</span>
<span class="n">detection_catalog</span><span class="o">.</span><span class="n">measure_background_map</span><span class="p">()</span>
<span class="n">detection_catalog</span><span class="o">.</span><span class="n">run_detect_sources</span><span class="p">(</span><span class="n">nsigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="measure-photometry-and-more-in-detection-image">
<h3>Measure photometry (and more) in detection image<a class="headerlink" href="#measure-photometry-and-more-in-detection-image" title="Permalink to this heading">#</a></h3>
<p>https://photutils.readthedocs.io/en/latest/segmentation.html#centroids-photometry-and-morphological-properties</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># exposure_time = hdu[0].header.get(&#39;EXPTIME&#39;)  # seconds</span>
<span class="n">exposure_time</span> <span class="o">=</span> <span class="mi">49500</span>  <span class="c1"># seconds; Adding by hand because it&#39;s missing from the image header</span>
<span class="n">detection_catalog</span><span class="o">.</span><span class="n">measure_source_properties</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save segmentation map of detected objects</span>
<span class="n">segm_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="n">imwcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>
<span class="n">segm_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;JADES_detections_segm.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="show-detections-alongside-images-optional">
<h3>Show detections alongside images (optional)<a class="headerlink" href="#show-detections-alongside-images-optional" title="Permalink to this heading">#</a></h3>
<p><em>Developer’s Note:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Interactive plots zoom / pan all frames simultaneously. (User can zoom in on individual galaxies.)
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="c1"># fig, ax = plt.subplots(2, 3, sharex=True, sharey=True, figsize=(9.5, 6), subplot_kw={&#39;projection&#39;: imwcs})</span>
<span class="c1"># For RA,Dec axes instead of pixels, add: , subplot_kw={&#39;projection&#39;: imwcs})</span>

<span class="c1"># Color image</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_short_wavelength</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Color Image&#39;</span><span class="p">)</span>

<span class="c1"># Data</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detection Image F200W&#39;</span><span class="p">)</span>

<span class="c1"># Segmentation map</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>  <span class="c1"># ERROR</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detections (Segmentation Image)&#39;</span><span class="p">)</span>

<span class="c1"># norm = ImageNormalize(stretch=SqrtStretch())</span>
<span class="c1"># ax[1,0].imshow(weight, origin=&#39;lower&#39;, cmap=&#39;Greys_r&#39;, vmin=0)</span>
<span class="c1"># ax[1,0].set_title(&#39;Weight Image F200W&#39;)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">exposure_time_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Exposure Time Map&#39;</span><span class="p">)</span>

<span class="c1"># ax[1,0].imshow(background_map.background, origin=&#39;lower&#39;, cmap=&#39;Greys_r&#39;)</span>
<span class="c1"># ax[1,0].set_title(&#39;Background Pedestal&#39;)</span>

<span class="c1"># RMS</span>
<span class="c1"># norm = ImageNormalize()</span>
<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0035</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Background RMS&#39;</span><span class="p">)</span>

<span class="c1"># Total error including Poisson noise</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">data_rms</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS + Poisson noise&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Interactive zoom / pan controls all images simultaneously&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="view-save-measured-quantities-in-detection-image-optional">
<h3>View / save measured quantities in detection image (optional)<a class="headerlink" href="#view-save-measured-quantities-in-detection-image-optional" title="Permalink to this heading">#</a></h3>
</section>
<section id="only-keep-some-quantities">
<h3>Only keep some quantities<a class="headerlink" href="#only-keep-some-quantities" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;label xcentroid ycentroid sky_centroid area semimajor_sigma semiminor_sigma&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="s1">&#39;ellipticity orientation gini&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="s1">&#39;kron_radius local_background segment_flux segment_fluxerr kron_flux kron_fluxerr&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="c1"># columns += &#39;source_sum source_sum_err kron_flux kron_fluxerr kron_radius local_background&#39;.split()</span>

<span class="n">source_table</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
<span class="n">source_table</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;semimajor_sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">source_table</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;semiminor_sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="c1"># Replace sky_centroid with ra, dec</span>
<span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;sky_centroid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span>
<span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;sky_centroid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span>

<span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

<span class="n">source_table</span> <span class="o">=</span> <span class="n">source_table</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If interested, view / save output, but photometry in other filters will be added soon!</span>
<span class="c1"># source_table.write(&#39;JADES_detections.ecsv&#39;, overwrite=True)</span>
<span class="c1"># source_table.write(&#39;JADES_detections.cat&#39;, format=&#39;ascii.fixed_width_two_line&#39;, delimiter=&#39; &#39;, overwrite=True)</span>
<span class="c1"># source_table</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="convert-measured-fluxes-data-units-to-magnitudes">
<h3>Convert measured fluxes (data units) to magnitudes<a class="headerlink" href="#convert-measured-fluxes-data-units-to-magnitudes" title="Permalink to this heading">#</a></h3>
<p>https://docs.astropy.org/en/stable/units/</p>
<p>https://docs.astropy.org/en/stable/units/equivalencies.html#photometric-zero-point-equivalency</p>
<p>https://docs.astropy.org/en/stable/units/logarithmic_units.html#logarithmic-units</p>
<p><em>Developer note:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>flux units can be automatically converted to magnitude units
but flux uncertainties *cannot* be automatically converted to magnitude uncertainties
thus I wrote this function to do so

Note magnitude uncertainties for detections should probably be u.mag instead of u.ABmag
but magnitude uncertainties for non-detections quote u.ABmag upper limits
They need to be the same, so we go with u.ABmag
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># not detected: mag =  99; magerr = 1-sigma upper limit assuming zero flux</span>
<span class="c1"># not observed: mag = -99; magerr = 0</span>
<span class="k">def</span> <span class="nf">fluxes2mags</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">):</span>
    <span class="n">nondet</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="c1"># Non-detection if flux is negative</span>
    <span class="n">unobs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fluxerr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fluxerr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>  <span class="c1"># Unobserved if flux uncertainty is negative or infinity</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span>
    <span class="n">magupperlimit</span> <span class="o">=</span> <span class="n">fluxerr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span> <span class="c1"># 1-sigma upper limit if flux=0</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nondet</span><span class="p">,</span> <span class="mi">99</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">,</span> <span class="n">mag</span><span class="p">)</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unobs</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">,</span> <span class="n">mag</span><span class="p">)</span>

    <span class="n">magerr</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fluxerr</span><span class="o">/</span><span class="n">flux</span><span class="p">)</span> 
    <span class="n">magerr</span> <span class="o">=</span> <span class="n">magerr</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>

    <span class="n">magerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nondet</span><span class="p">,</span> <span class="n">magupperlimit</span><span class="p">,</span> <span class="n">magerr</span><span class="p">)</span>
    <span class="n">magerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unobs</span><span class="p">,</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">,</span> <span class="n">magerr</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mag</span><span class="p">,</span> <span class="n">magerr</span>

<span class="c1"># Includes features I couldn&#39;t find in astropy:</span>
<span class="c1"># mag = 99 / -99 for non-detections / unobserved</span>
<span class="c1"># flux uncertainties -&gt; mag uncertainties</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="multiband-photometry-using-isophotal-apertures-defined-in-detection-image">
<h3>Multiband photometry using isophotal apertures defined in detection image<a class="headerlink" href="#multiband-photometry-using-isophotal-apertures-defined-in-detection-image" title="Permalink to this heading">#</a></h3>
<p>(Similar to running SourceExtractor in double-image mode)<br />
(No PSF corrections just yet)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filters = &#39;F090W F200W F444W&#39;.split()  # quicker for testing</span>
<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
    <span class="n">filter_catalog</span> <span class="o">=</span> <span class="n">Photutils_Catalog</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_background_map</span><span class="p">()</span>

    <span class="c1"># Measure photometry in this filter for objects detected in detected image</span>
    <span class="c1"># segmentation map will define isophotal apertures</span>
    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">segm_deblend</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span>
    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_source_properties</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">)</span>
    
    <span class="c1"># Convert measured fluxes to fluxes in nJy and to AB magnitudes</span>
    <span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">[</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">zeropoint</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>
    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">[</span><span class="s1">&#39;segment_fluxerr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">zeropoint</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>

    <span class="n">mag</span><span class="p">,</span> <span class="n">magerr</span> <span class="o">=</span> <span class="n">fluxes2mags</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">)</span>
    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span>
    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_magerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magerr</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="aperture-corrections-isophotal-to-total-kron-aperture-fluxes">
<h3>Aperture corrections: isophotal to total (Kron aperture) fluxes<a class="headerlink" href="#aperture-corrections-isophotal-to-total-kron-aperture-fluxes" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_flux_table</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">source_table</span><span class="p">)</span> <span class="c1"># copy to new table, which will include total magnitude corrections</span>

<span class="n">reference_flux_auto</span> <span class="o">=</span> <span class="n">total_flux_table</span><span class="p">[</span><span class="s1">&#39;kron_flux&#39;</span><span class="p">]</span>
<span class="n">reference_flux_iso</span> <span class="o">=</span> <span class="n">total_flux_table</span><span class="p">[</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">]</span>
<span class="n">kron_flux_corrections</span> <span class="o">=</span> <span class="n">reference_flux_auto</span> <span class="o">/</span> <span class="n">reference_flux_iso</span>
<span class="n">total_flux_table</span><span class="p">[</span><span class="s1">&#39;total_flux_cor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kron_flux_corrections</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
    <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">kron_flux_corrections</span>
    <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">kron_flux_corrections</span>
    <span class="c1"># total_flux_table[filt+&#39;_mag&#39;] = total_flux_table[filt+&#39;_flux&#39;].to(u.ABmag)  # doesn&#39;t handle non-detections</span>
    <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxes2mags</span><span class="p">(</span><span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">],</span> <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># magnitude uncertainty magerr stays the same</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reformat-output-catalog-for-readability-optional">
<h3>Reformat output catalog for readability (optional)<a class="headerlink" href="#reformat-output-catalog-for-readability-optional" title="Permalink to this heading">#</a></h3>
<p><em>Developer’s Note:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;d&#39; format incompatible with units (pix2)
As a workaround, I set the format to &#39;.0f&#39; (a float with no decimals)

ValueError: Unable to parse format string &quot;d&quot; for entry &quot;101.0&quot; in column &quot;area&quot;
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">isophotal_table</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">total_flux_table</span><span class="p">)</span> <span class="c1"># copy to new table, which will include PSF-corrections</span>

<span class="n">old_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">isophotal_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="c1"># Reorder columns,</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">old_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">)</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">old_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">)</span>
<span class="n">columns</span> <span class="o">=</span> <span class="n">old_columns</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="c1"># detection catalog (except source_sum &amp; kron_flux)</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="n">old_columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># total_flux_cor</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="n">old_columns</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># photometry in all filters</span>
        
<span class="n">isophotal_table</span> <span class="o">=</span> <span class="n">isophotal_table</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="n">isophotal_table</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.4f&#39;</span>

<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;11.7f&#39;</span>
<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39; 11.7f&#39;</span>

<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.0f&#39;</span>  <span class="c1"># &#39;d&#39; raises error</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="isophotal-photometry-without-psf-corrections-complete">
<h3>Isophotal Photometry without PSF corrections complete<a class="headerlink" href="#isophotal-photometry-without-psf-corrections-complete" title="Permalink to this heading">#</a></h3>
<p>We recommend proceeding with PSF corrections to photometry in the Long Wavelength Channel. But if you are interested, you may save the catalog now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># isophotal_table.write(&#39;JADES_isophotal_photometry.ecsv&#39;, overwrite=True)</span>
<span class="c1"># isophotal_table.write(&#39;JADES_isophotal_photometry.cat&#39;, format=&#39;ascii.fixed_width_two_line&#39;, delimiter=&#39; &#39;, overwrite=True)</span>
<span class="c1"># isophotal_table</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="psf-magnitude-corrections">
<h2>PSF magnitude corrections<a class="headerlink" href="#psf-magnitude-corrections" title="Permalink to this heading">#</a></h2>
<p>Color corrections are perfomed as described here:
https://www.stsci.edu/~dcoe/ColorPro/color</p>
<p>Note this is different from one common approach, which is to degrade every image to the broadest PSF.</p>
<p>Photometry is only corrected in Long Wavelength images &gt; 2.4 microns. The F200W detection image is convolved (blurred) to the PSF of each Long Wavelength image. Then we correct colors based on the magnitudes lost in that aperture:</p>
<ul class="simple">
<li><p>PSF_magnitude_corrections = detection_image_magnitudes - blurred_detection_image_magnitudes</p></li>
</ul>
<p>In practice, we actually correct the fluxes:</p>
<ul class="simple">
<li><p>PSF_flux_corrections = detection_image_fluxes / blurred_detection_image_fluxes</p></li>
</ul>
<section id="load-psfs">
<h3>Load PSFs<a class="headerlink" href="#load-psfs" title="Permalink to this heading">#</a></h3>
<p>PSF files used in this notebook were extracted from tar files available on JDox:<br />
https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions#NIRCamPointSpreadFunctions-SimulatedNIRCamPSFs<br />
PSFs_SW_filters (short wavelength channel): https://stsci.box.com/s/s2lepxr9086gq4sogr3kwftp54n1c5vl<br />
PSFs_LW_filters (long wavelength channel): https://stsci.box.com/s/gzl7blxb1k3p4n66gs7jvt7xorfrotyb</p>
<p>Each FITS file contains:<br />
– hdu[0]: a 4x oversampled PSF<br />
– hdu[1]: PSF at detector pixel scale (0.031” and 0.063” in the short and long wavelength channels, respectively)<br />
This notebook will use the latter: PSF at detector pixel scale. We find no advantage to the former for this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_inputs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">PSF_images</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">detector_pixel_scales</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SW&#39;</span><span class="p">:</span> <span class="mf">0.031</span><span class="p">,</span> <span class="s1">&#39;LW&#39;</span><span class="p">:</span> <span class="mf">0.063</span><span class="p">}</span>

<span class="n">PSF_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="s1">&#39;NIRCam_PSFs&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lam</span> <span class="o">&lt;</span> <span class="mf">2.4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">:</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;SW&#39;</span>  <span class="c1"># Short Wavelength Channel &lt; 2.4 microns</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;LW&#39;</span>  <span class="c1"># Long Wavelength Channel &gt; 2.4 microns</span>

    <span class="c1"># Load PSF</span>
    <span class="n">PSF_file</span> <span class="o">=</span> <span class="s1">&#39;PSF_</span><span class="si">%s</span><span class="s1">cen_G5V_fov299px_ISIM41.fits&#39;</span> <span class="o">%</span> <span class="n">filt</span>
    <span class="c1"># PSF_file = os.path.join(&#39;NIRCam_PSFs_&#39; + channel, PSF_file)</span>
    <span class="n">PSF_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PSF_url</span><span class="p">,</span> <span class="n">PSF_file</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">PSF_file</span><span class="p">)</span>
    <span class="n">PSF_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">PSF_file</span><span class="p">)</span>
    <span class="n">PSF_inputs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="n">PSF_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># extension [1] is at pixel scale (not oversampled)</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="c1"># Resize from detector pixel scale to image pixel scale (here 0.03&quot; / pix)</span>
    <span class="n">detector_pixel_scale</span> <span class="o">=</span> <span class="n">detector_pixel_scales</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
    <span class="n">ny_resize</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">detector_pixel_scale</span> <span class="o">/</span> <span class="n">image_pixel_scale</span>  <span class="c1"># Assume square PSF (ny = nx)</span>
    <span class="n">ny_resize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ny_resize</span><span class="p">)</span>
    <span class="n">ny_resize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">ny_resize</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Make it an odd number of pixels to ensure PSF is centered</span>
    <span class="n">PSF_pixel_scale</span> <span class="o">=</span> <span class="n">ny_resize</span> <span class="o">/</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">image_pixel_scale</span>    
    <span class="n">PSF_image</span> <span class="o">=</span> <span class="n">resize_psf</span><span class="p">(</span><span class="n">PSF_inputs</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span> <span class="n">PSF_pixel_scale</span><span class="p">,</span> <span class="n">image_pixel_scale</span><span class="p">)</span>  <span class="c1"># Resize PSF here</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny_resize</span> <span class="o">-</span> <span class="n">ny</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF_image</span><span class="p">[</span><span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">]</span>  <span class="c1"># Trim to same size as input PSFs</span>
    <span class="c1"># Note PSF is no longer normalized but will be later in convolution step</span>
    <span class="c1"># print(filt, ny, ny_resize, PSF_image.shape, PSF_images[filt].shape, PSF_pixel_scale)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PSF_image</span><span class="p">[</span><span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show PSFs (optional)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># PSF will be shown out to radius r (pixels)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">yc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">yc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">xc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">())</span>  <span class="c1"># scale each filter individually</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="psf-matching">
<h2>PSF Matching<a class="headerlink" href="#psf-matching" title="Permalink to this heading">#</a></h2>
<p>https://photutils.readthedocs.io/en/stable/psf_matching.html</p>
<section id="determine-psf-convolution-kernels">
<h3>Determine PSF convolution kernels<a class="headerlink" href="#determine-psf-convolution-kernels" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_kernels</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">reference_filter</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>
<span class="n">reference_PSF</span> <span class="o">=</span> <span class="n">PSF_images</span><span class="p">[</span><span class="n">reference_filter</span><span class="p">]</span>
<span class="n">i_reference</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">reference_filter</span><span class="p">)</span>
<span class="n">window</span> <span class="o">=</span> <span class="n">SplitCosineBellWindow</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">PSF_kernels</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_matching_kernel</span><span class="p">(</span><span class="n">reference_PSF</span><span class="p">,</span> <span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="convolve-f200w-detection-image-to-long-wavelength-psfs">
<h2>Convolve F200W detection image to Long Wavelength PSFs<a class="headerlink" href="#convolve-f200w-detection-image-to-long-wavelength-psfs" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reference_image_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="n">reference_filter</span><span class="p">])</span>
<span class="n">reference_image_data</span> <span class="o">=</span> <span class="n">reference_image_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>

<span class="k">for</span> <span class="n">output_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">output_image</span> <span class="o">=</span> <span class="s1">&#39;jades_convolved_</span><span class="si">%s</span><span class="s1">_to_</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reference_filter</span><span class="p">,</span> <span class="n">output_filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_image</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_image</span><span class="p">,</span> <span class="s1">&#39;EXISTS&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_filter</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>
        <span class="n">PSF_kernel</span> <span class="o">=</span> <span class="n">PSF_kernels</span><span class="p">[</span><span class="n">output_filter</span><span class="p">][</span><span class="n">yc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">yc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">xc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># convolve_fft may be faster for larger images / kernels (but doesn&#39;t make much difference in this demo):</span>
        <span class="n">convolved_image</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">reference_image_data</span><span class="p">,</span> <span class="n">PSF_kernel</span><span class="p">,</span> <span class="n">normalize_kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">reference_image_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">convolved_image</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SAVING </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">output_image</span><span class="p">)</span>
        <span class="n">reference_image_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="multiband-photometry-in-convolved-images">
<h3>Multiband photometry in convolved images<a class="headerlink" href="#multiband-photometry-in-convolved-images" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Measure and save the fluxes in each blurry image</span>
<span class="n">blurry_catalog</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">()</span>

<span class="k">for</span> <span class="n">blurry_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">image_file</span> <span class="o">=</span> <span class="s1">&#39;jades_convolved_</span><span class="si">%s</span><span class="s1">_to_</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reference_filter</span><span class="p">,</span> <span class="n">blurry_filter</span><span class="p">)</span>
    <span class="n">filter_catalog</span> <span class="o">=</span> <span class="n">Photutils_Catalog</span><span class="p">(</span><span class="n">blurry_filter</span><span class="p">,</span> <span class="n">image_file</span><span class="o">=</span><span class="n">image_file</span><span class="p">)</span>
    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_background_map</span><span class="p">()</span>

    <span class="c1"># Measure photometry in this filter for objects detected in detected image</span>
    <span class="c1"># segmentation map will define isophotal apertures</span>
    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">segm_deblend</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span>
    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_source_properties</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">)</span>

    <span class="c1"># Convert measured fluxes to fluxes in nJy</span>
    <span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
    <span class="n">blurry_catalog</span><span class="p">[</span><span class="n">blurry_filter</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">[</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">zeropoint</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>PSF magnitude corrections<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>https://www.stsci.edu/~dcoe/ColorPro/color</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_corrected_table</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">isophotal_table</span><span class="p">)</span>

<span class="n">reference_fluxes</span> <span class="o">=</span> <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">reference_filter</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span>  <span class="c1"># det_flux_auto</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="c1"># Convert isophotal fluxes to total fluxes</span>
    <span class="n">blurry_total_fluxes</span> <span class="o">=</span> <span class="n">blurry_catalog</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kron_flux_corrections</span>
    <span class="n">PSF_flux_corrections</span> <span class="o">=</span> <span class="n">reference_fluxes</span> <span class="o">/</span> <span class="n">blurry_total_fluxes</span>
    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">PSF_flux_corrections</span>
    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">PSF_flux_corrections</span>
    <span class="c1"># PSF_corrected_table[filt+&#39;_mag&#39;] = PSF_corrected_fluxes.to(u.ABmag)  # doesn&#39;t handle non-detections</span>
    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_mag&#39;</span><span class="p">],</span> <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_magerr&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">fluxes2mags</span><span class="p">(</span><span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">],</span> <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">])</span>
    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_PSF_flux_cor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF_flux_corrections</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_corrected_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;JADES_photometry.ecsv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">PSF_corrected_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;JADES_photometry.cat&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.fixed_width_two_line&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PSF_corrected_table</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !cat JADES_photometry.cat</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="start-new-session-and-analyze-results">
<h2>Start new session and analyze results<a class="headerlink" href="#start-new-session-and-analyze-results" title="Permalink to this heading">#</a></h2>
<p>Just run the first few blocks above, including imports, defining file lists, and creating the color image</p>
<section id="load-catalog-and-segmentation-map">
<h3>Load catalog and segmentation map<a class="headerlink" href="#load-catalog-and-segmentation-map" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Catalog: ecsv format preserves units for loading in Python notebooks</span>
<span class="n">output_catalog</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;JADES_photometry.ecsv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reconstitute filter list</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">output_catalog</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_mag&#39;</span><span class="p">:</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Segmentation map</span>
<span class="n">segmfile</span> <span class="o">=</span> <span class="s1">&#39;JADES_detections_segm.fits&#39;</span>
<span class="n">segm</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">segmfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">segm</span> <span class="o">=</span> <span class="n">SegmentationImage</span><span class="p">(</span><span class="n">segm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="input-simulation-jades-jaguar-catalog">
<h2>Input simulation JADES JAGUAR catalog<a class="headerlink" href="#input-simulation-jades-jaguar-catalog" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># full_catalog_file = &#39;JADES_SF_mock_r1_v1.1.fits.gz&#39;  # not available in this demo</span>
<span class="c1"># Cropped 302,515 simulated galaxies down to 653 in the smaller image region used in this demo</span>
<span class="n">cropped_catalog_file</span> <span class="o">=</span> <span class="s1">&#39;JADES_SF_mock_r1_v1.1_crop.fits.gz&#39;</span>
<span class="n">input_catalog_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="n">cropped_catalog_file</span><span class="p">)</span>
<span class="n">simulated_catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">input_catalog_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="match-objects-to-photutils-catalog">
<h3>Match objects to photutils catalog<a class="headerlink" href="#match-objects-to-photutils-catalog" title="Permalink to this heading">#</a></h3>
<p>https://docs.astropy.org/en/stable/coordinates/matchsep.html</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>

<span class="c1"># Can use output_catalog[&#39;sky_centroid&#39;] if saved in table, but this demo saved (ra,dec) instead:</span>
<span class="n">detected_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])</span>

<span class="c1"># Match photutils detection sources to input object catalog:</span>
<span class="n">input_indices</span><span class="p">,</span> <span class="n">separation2d</span><span class="p">,</span> <span class="n">distance3d</span> <span class="o">=</span> <span class="n">detected_coordinates</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">input_coordinates</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Determine threshold maximum distance between input objects and matched output sources</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">separation2d</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">separation_max</span> <span class="o">=</span> <span class="mf">0.036</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>  <span class="c1"># determined by eye after plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">separation_max</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&quot;good&quot; matches&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Matches between output (detected) and input (simulated) catalogs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Detected sources (sorted)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Separation (arcsec)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">good_matches</span> <span class="o">=</span> <span class="n">separation2d</span> <span class="o">&lt;</span> <span class="n">separation_max</span>
<span class="n">unique_matches</span><span class="p">,</span> <span class="n">index_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">input_indices</span><span class="p">[</span><span class="n">good_matches</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> matches (</span><span class="si">%d</span><span class="s1"> unique) between input catalog (</span><span class="si">%d</span><span class="s1"> galaxies) and photutils catalog (</span><span class="si">%d</span><span class="s1"> detected sources)&#39;</span>
      <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_matches</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_matches</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">simulated_catalog</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_catalog</span><span class="p">)))</span>

<span class="n">multiple_matches</span> <span class="o">=</span> <span class="n">unique_matches</span><span class="p">[</span><span class="n">index_counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiple_matches</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input sources matched multiple times:&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">multiple_matches</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Input vs. Output Color</span>

<span class="n">filt1</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">=</span> <span class="s1">&#39;F200W F444W&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">input_flux1</span> <span class="o">=</span> <span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt1</span><span class="p">][</span><span class="n">input_indices</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span>
<span class="n">input_flux2</span> <span class="o">=</span> <span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt2</span><span class="p">][</span><span class="n">input_indices</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span>

<span class="n">input_mag1</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_flux1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
<span class="n">input_mag2</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_flux2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

<span class="n">output_mag1</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_mag&#39;</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">output_mag2</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_mag&#39;</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">output_ids</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Only plot detections</span>
<span class="n">det1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">output_mag1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">output_mag1</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span>
<span class="n">det2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">output_mag2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">output_mag2</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span>
<span class="n">det</span> <span class="o">=</span> <span class="n">det1</span> <span class="o">*</span> <span class="n">det2</span>

<span class="n">output_mag1</span> <span class="o">=</span> <span class="n">output_mag1</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>
<span class="n">output_mag2</span> <span class="o">=</span> <span class="n">output_mag2</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>

<span class="n">input_color</span> <span class="o">=</span> <span class="n">input_mag1</span> <span class="o">-</span> <span class="n">input_mag2</span>
<span class="n">output_color</span> <span class="o">=</span> <span class="n">output_mag1</span> <span class="o">-</span> <span class="n">output_mag2</span>

<span class="n">output_mag1_uncor</span> <span class="o">=</span> <span class="n">output_mag1</span>
<span class="n">PSF_flux_cor</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">filt2</span><span class="o">+</span><span class="s1">&#39;_PSF_flux_cor&#39;</span><span class="p">]</span>
<span class="n">PSF_mag_cor</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PSF_flux_cor</span><span class="p">)</span>
<span class="n">output_mag2_uncor</span> <span class="o">=</span> <span class="n">output_mag2</span> <span class="o">-</span> <span class="n">PSF_mag_cor</span><span class="p">[</span><span class="n">good_matches</span><span class="p">][</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">output_color_uncor</span> <span class="o">=</span> <span class="n">output_mag1_uncor</span> <span class="o">-</span> <span class="n">output_mag2_uncor</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_mag1</span><span class="p">,</span> <span class="n">output_color</span> <span class="o">-</span> <span class="n">input_color</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSF corrected&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_mag1</span><span class="p">,</span> <span class="n">output_color_uncor</span> <span class="o">-</span> <span class="n">input_color</span><span class="p">,</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;uncorrected&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;correct&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Input  &#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;  (mag)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Measured $-$ Input colors  [</span><span class="si">%s</span><span class="s1"> $-$ </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">filt2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Accuracy of measured JADES photometry colors&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="c1"># plt.savefig(&#39;JADES_color_deviation_%s-%s.png&#39; % (filt1, filt2))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts">
<h3>Plot F200W vs. F090W magnitudes and look for dropouts<a class="headerlink" href="#plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mag1</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;F090W_mag&#39;</span><span class="p">]</span>
<span class="n">mag2</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;F200W_mag&#39;</span><span class="p">]</span>

<span class="c1"># Only plot detections in F200W</span>
<span class="n">det2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span> <span class="o">&lt;</span> <span class="n">mag2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mag2</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span>

<span class="n">mag1</span> <span class="o">=</span> <span class="n">mag1</span><span class="p">[</span><span class="n">det2</span><span class="p">]</span>
<span class="n">mag2</span> <span class="o">=</span> <span class="n">mag2</span><span class="p">[</span><span class="n">det2</span><span class="p">]</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">det2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag1</span><span class="p">,</span> <span class="n">mag2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;F090W AB magnitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F200W AB magnitude&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># brighter at right</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># brighter at top</span>

<span class="n">mplcursors</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">hover</span><span class="o">=</span><span class="n">mplcursors</span><span class="o">.</span><span class="n">HoverMode</span><span class="o">.</span><span class="n">Transient</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hover cursor over data point to reveal magnitudes and catalog ID number&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select brightest F090W dropout</span>
<span class="n">dropouts</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;F090W_mag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>
<span class="n">i_brightest_dropout</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">dropouts</span><span class="p">][</span><span class="s1">&#39;F200W_mag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
<span class="n">output_id</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">dropouts</span><span class="p">][</span><span class="n">i_brightest_dropout</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
<span class="n">output_id</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select object with id from catalog</span>
<span class="n">output_index</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">output_id</span><span class="p">)</span>
<span class="n">output_obj</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">output_index</span><span class="p">]</span>
<span class="n">segmobj</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segm</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">output_id</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output_id</span><span class="p">,</span> <span class="n">output_obj</span><span class="p">[</span><span class="s1">&#39;F090W_mag&#39;</span><span class="p">],</span> <span class="n">output_obj</span><span class="p">[</span><span class="s1">&#39;F200W_mag&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Alternartively, could select an object by position</span>
<span class="c1"># x, y = 905, 276</span>
<span class="c1"># id = segm.data[y,x]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="show-selected-object-in-all-filters">
<h3>Show selected object in all filters<a class="headerlink" href="#show-selected-object-in-all-filters" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_short_wavelength</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Color&#39;</span><span class="p">)</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>  <span class="c1"># ERROR</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">segm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Segment&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Show data on top row</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>  <span class="c1"># scale each filter individually</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="c1"># Show weights on bottom row</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">]</span>
    <span class="c1"># set black to zero weight (no exposure time / bad pixel)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Weight&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="plot-spectral-energy-distribution-sed-for-one-object">
<h2>Plot Spectral Energy Distribution (SED) for one object<a class="headerlink" href="#plot-spectral-energy-distribution-sed-for-one-object" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># output_obj = output_catalog[index]  # already done above</span>
<span class="n">input_obj</span> <span class="o">=</span> <span class="n">simulated_catalog</span><span class="p">[</span><span class="n">input_indices</span><span class="p">][</span><span class="n">output_index</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">input_obj</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt</span><span class="p">]</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span>
<span class="n">output_fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output_obj</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span>
<span class="n">output_flux_errs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output_obj</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Measured flux does not recover total input flux</span>
<span class="c1"># Given known simulation input, determine what fraction of the flux was recovered</span>
<span class="c1"># Use this to scale measured SED to input SED for comparison, plotted below</span>

<span class="c1"># Scale output to input flux using F200W only (other filters may have incorrect flux corrections)</span>

<span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>
<span class="n">flux_scale_factor</span> <span class="o">=</span> <span class="n">output_obj</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">input_obj</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt</span><span class="p">]</span>
<span class="n">flux_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">flux_scale_factor</span>  <span class="c1"># input / output</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d%%</span><span class="s1"> of input flux recovered by photutils&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">flux_scale_factor</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Scale output to input flux considering all measured fluxes and uncertainties</span>
    <span class="c1"># Benitez+00 Equations 8 &amp; 9</span>
    <span class="n">FOT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">input_fluxes</span> <span class="o">*</span> <span class="n">output_fluxes</span> <span class="o">/</span> <span class="n">output_flux_errs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">FTT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">input_fluxes</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">output_flux_errs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">flux_scale_factor</span> <span class="o">=</span> <span class="n">FOT</span> <span class="o">/</span> <span class="n">FTT</span>  <span class="c1"># a_m: observed / theoretical (output / input)</span>
    <span class="n">flux_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">flux_scale_factor</span>  <span class="c1"># input / output</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d%%</span><span class="s1"> of input flux recovered by photutils&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">flux_scale_factor</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_flux_corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
    <span class="n">PSFcor_column</span> <span class="o">=</span> <span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_PSF_flux_cor&#39;</span>
    <span class="k">if</span> <span class="n">PSFcor_column</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_obj</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">PSF_flux_corrections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_obj</span><span class="p">[</span><span class="n">PSFcor_column</span><span class="p">]</span>

<span class="n">PSF_flux_corrections</span>
</pre></div>
</div>
</div>
</div>
<p><em>Developer’s Note:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>automatic secondary axis magnitudes don&#39;t work when fluxes extend to negative values
so I wrote my own code to do this
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_magnitude_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">flux_units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">,</span> <span class="n">plothuge</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span> <span class="o">*</span> <span class="n">flux_units</span>
    <span class="n">maghi</span> <span class="o">=</span> <span class="n">yhi</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">maghi</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.</span>  <span class="c1"># 24.101 -&gt; 24.2</span>
    <span class="n">ytx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">maghi</span><span class="p">)</span>  <span class="c1"># 24.1 -&gt; 25</span>

    <span class="n">fpart</span> <span class="o">=</span> <span class="n">ytx1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ytx1</span><span class="p">)</span>  <span class="c1"># 0.2</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>  <span class="c1"># 24.1, 24.3, 24.5, 24.7</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>  <span class="c1"># 24.3, 24.5, 24.7</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>  <span class="c1"># 24.5, 24.7</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.2</span><span class="p">])</span>  <span class="c1"># 24.6, 24.8</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ytx1</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">plothuge</span><span class="p">:</span>
        <span class="n">ytx3</span> <span class="o">=</span> <span class="n">ytx2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ytx3</span> <span class="o">=</span> <span class="n">ytx2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">ytx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx2</span><span class="p">])</span>
    <span class="n">ytx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx3</span><span class="p">])</span>
    <span class="n">yts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mag</span> <span class="k">for</span> <span class="n">mag</span> <span class="ow">in</span> <span class="n">ytx</span><span class="p">]</span>

    <span class="n">ytx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ytx</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">flux_units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_left</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ytx</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yts</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (AB)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylo</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">yhi</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># interactive cursor will output left axis ax</span>
</pre></div>
</div>
</div>
</div>
<p><em>Developer’s Note:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>errorbar doesn&#39;t work with units either
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">input_fluxes</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input fluxes&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured PSF-corrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">mpl_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured uncorrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span> <span class="o">/</span> <span class="n">PSF_flux_corrections</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($</span><span class="se">\\</span><span class="s1">mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (nJy)&#39;</span><span class="p">)</span>
<span class="n">add_magnitude_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;JADES photutils SED linear.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><em>Developer’s Notes:</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Ideally, the secondary axis should know how to convert between units.
As a workaround, I wrote functions and fed them in.

Even then, this only works so long as fluxes are positive.
Clipping all fluxes to positive values doesn&#39;t work either.

I would like to automatically scale the y limits to only *some* of the plotted data along the lines of:
https://stackoverflow.com/questions/7386872/make-matplotlib-autoscaling-ignore-some-of-the-plots
But that old solution didn&#39;t work.
So for now, I just hard-coded a range that works for this object: y=10-70.
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this didn&#39;t work</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">output_fluxes</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">detections</span><span class="p">],</span> <span class="n">output_fluxes</span><span class="p">[</span><span class="n">detections</span><span class="p">]</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">input_fluxes</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input fluxes&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scaley</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured PSF-corrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">mpl_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured uncorrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span> <span class="o">/</span> <span class="n">PSF_flux_corrections</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($</span><span class="se">\\</span><span class="s1">mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (nJy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="c1"># Add AB magnitudes as secondary x-axis at right</span>
<span class="c1"># (Note this breaks if any fluxes are negative)</span>
<span class="c1"># https://matplotlib.org/gallery/subplots_axes_and_figures/secondary_axis.html#sphx-glr-gallery-subplots-axes-and-figures-secondary-axis-py</span>

<span class="k">def</span> <span class="nf">AB2nJy</span><span class="p">(</span><span class="n">mAB</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mAB</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span>

<span class="k">def</span> <span class="nf">nJy2AB</span><span class="p">(</span><span class="n">F_nJy</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">F_nJy</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nJy</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># secondary_axis = add_magnitude_axis(ax, flux_units)</span>
<span class="n">secax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_yaxis</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="n">nJy2AB</span><span class="p">,</span> <span class="n">AB2nJy</span><span class="p">))</span>
<span class="n">secax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;magnitude (AB)&#39;</span><span class="p">)</span>
<span class="n">secax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>
<span class="n">secax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;JADES SED PSF-corrected&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;JADES photutils SED.png&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRCam/NIRCam_PSF-matched_photometry"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../NIRCam_photometry/NIRCam_multiband_photometry.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Extended Aperture Photometry</p>
      </div>
    </a>
    <a class="right-next"
       href="../psf_photometry/NIRCam_PSF_Photometry_Example.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">PSF Photometry</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import packages</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">Matplotlib setup for plotting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-list-of-images-to-be-loaded-and-analyzed">Create list of images to be loaded and analyzed</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-detection-image-f200w">Load detection image: F200W</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#report-image-size-and-field-of-view">Report image size and field of view</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-color-images-optional">Create color images (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detect-sources-and-deblend-using-astropy-photutils">Detect Sources and Deblend using astropy.photutils</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#measure-photometry-and-more-in-detection-image">Measure photometry (and more) in detection image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-detections-alongside-images-optional">Show detections alongside images (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-save-measured-quantities-in-detection-image-optional">View / save measured quantities in detection image (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#only-keep-some-quantities">Only keep some quantities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-measured-fluxes-data-units-to-magnitudes">Convert measured fluxes (data units) to magnitudes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiband-photometry-using-isophotal-apertures-defined-in-detection-image">Multiband photometry using isophotal apertures defined in detection image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-corrections-isophotal-to-total-kron-aperture-fluxes">Aperture corrections: isophotal to total (Kron aperture) fluxes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reformat-output-catalog-for-readability-optional">Reformat output catalog for readability (optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#isophotal-photometry-without-psf-corrections-complete">Isophotal Photometry without PSF corrections complete</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-magnitude-corrections">PSF magnitude corrections</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-psfs">Load PSFs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-matching">PSF Matching</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-psf-convolution-kernels">Determine PSF convolution kernels</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convolve-f200w-detection-image-to-long-wavelength-psfs">Convolve F200W detection image to Long Wavelength PSFs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiband-photometry-in-convolved-images">Multiband photometry in convolved images</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">PSF magnitude corrections</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#start-new-session-and-analyze-results">Start new session and analyze results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-catalog-and-segmentation-map">Load catalog and segmentation map</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-simulation-jades-jaguar-catalog">Input simulation JADES JAGUAR catalog</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#match-objects-to-photutils-catalog">Match objects to photutils catalog</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts">Plot F200W vs. F090W magnitudes and look for dropouts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-selected-object-in-all-filters">Show selected object in all filters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-spectral-energy-distribution-sed-for-one-object">Plot Spectral Energy Distribution (SED) for one object</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>