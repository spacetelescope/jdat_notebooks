<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Spectral Cube Modeling — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html" rel="next" title="MRS Pipeline"/>
  <link href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html" rel="prev" title="Specviz Simple Demo"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/cube_fitting/cube_fitting.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/cube_fitting/cube_fitting.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#imports">
           Imports
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#definitions-of-functions">
           Definitions of functions
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#scrolling">
             Scrolling
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#model-functions">
             Model Functions
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#model-parameters">
           Model Parameters
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#line-flux-from-model-parameters">
             Line Flux from Model Parameters
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">
             Extract and plot 1D spectrum and model components
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#input-data">
           Input data
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#model-parameter-starting-values">
           Model Parameter Starting Values
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#fit-a-representative-spaxel">
           Fit a Representative Spaxel
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#fit-the-entire-cube">
           Fit the Entire Cube
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">
             Total flux and Reduced Chi^2 Maps
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">
             Line and PAH feature flux maps.
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
               Functions to extract line and PAH maps from model parameter cube
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
               H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">
           Extract and model cube sub-regions
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#make-spectral-region-masks">
             Make spectral region masks
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">
             Extract spectra from mask regions
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#save-spectra-to-files">
             Save spectra to files
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#fit-spectra-of-regions">
             Fit spectra of regions
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#generic-model-components">
               Generic model components
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#spiral-arm-spectral-fit">
               Spiral arm spectral fit
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">
               H2-strongest region spectral fit
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#nucleus-spectral-fit">
               Nucleus spectral fit
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#summary-plot">
           Summary Plot
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Spectral Cube Modeling
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#imports">
              Imports
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#definitions-of-functions">
              Definitions of functions
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#scrolling">
                Scrolling
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#model-functions">
                Model Functions
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#model-parameters">
              Model Parameters
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#line-flux-from-model-parameters">
                Line Flux from Model Parameters
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">
                Extract and plot 1D spectrum and model components
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#input-data">
              Input data
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#model-parameter-starting-values">
              Model Parameter Starting Values
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#fit-a-representative-spaxel">
              Fit a Representative Spaxel
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#fit-the-entire-cube">
              Fit the Entire Cube
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">
                Total flux and Reduced Chi^2 Maps
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">
                Line and PAH feature flux maps.
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
                  Functions to extract line and PAH maps from model parameter cube
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
                  H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">
              Extract and model cube sub-regions
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#make-spectral-region-masks">
                Make spectral region masks
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">
                Extract spectra from mask regions
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#save-spectra-to-files">
                Save spectra to files
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-spectra-of-regions">
                Fit spectra of regions
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#generic-model-components">
                  Generic model components
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#spiral-arm-spectral-fit">
                  Spiral arm spectral fit
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">
                  H2-strongest region spectral fit
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#nucleus-spectral-fit">
                  Nucleus spectral fit
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#summary-plot">
              Summary Plot
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="spectral-cube-modeling">
          <h1>
           Spectral Cube Modeling
           <a class="headerlink" href="#spectral-cube-modeling" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           Extracting spatial-spectral features of interest from the cube of data and measuring their
attributes.  Create line and PAH maps from the model parameters map.
           <br/>
           <strong>
            Data:
           </strong>
           SL1 and SL2 spectral cubes generated using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby galaxy Messier 58.
           <br/>
           <strong>
            Tools:
           </strong>
           astropy, specutils, dust-extinction, matplotlib.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           NIRSpec, MIRI.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Analysis of JWST spectral cubes requires extracting spatial-spectral features of interest and measuring their
attributes. Here, we demonstrate 1-D spectral modeling applied to an individual spaxel, 900 spaxels in a cube, and spectra summed over spatial regions. Analysis of large JWST spectral data cubes can be computationally expensive, depending on number of spaxels modeled and number of free model parameters. This task can be made manageable by focusing on spatial sub-regions of interest or by minimizing model complexity.  Sub-regions in the cube are selected by location and line ratios. The spaxels in these regions are then summed and modeled with a combination of continuum, emission line, polycyclic aromatic hydrocarbon (PAH), and silicate dust features. Best-fitting model spectra are fit using the lmfit package, utilizing a Levenberg-Marquardt least-squares method.
           </p>
          </section>
          <section id="imports">
           <h2>
            Imports
            <a class="headerlink" href="#imports" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              <em>
               time
              </em>
              for timing
             </p>
            </li>
            <li>
             <p>
              <em>
               multiprocessing.Pool
              </em>
              for parallel processing on cube spaxels
             </p>
            </li>
            <li>
             <p>
              <em>
               pickle
              </em>
              for pickling and unpickling IO to multiprocessing pools
             </p>
            </li>
            <li>
             <p>
              <em>
               numpy
              </em>
              for array processing and math
             </p>
            </li>
            <li>
             <p>
              <em>
               matplotlib.pyplot
              </em>
              for plotting images and spectra
             </p>
            </li>
            <li>
             <p>
              <em>
               <a class="reference external" href="http://astropy.io">
                astropy.io
               </a>
              </em>
              for reading and writing FITS cubes and images
             </p>
            </li>
            <li>
             <p>
              <em>
               astropy.visualization
              </em>
              to construct RGB images
             </p>
            </li>
            <li>
             <p>
              <em>
               lmfit
              </em>
              Levenberg-Marquart fitting package for model-fitting
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import time
import multiprocess as mp
from multiprocess import Pool
import pickle

import numpy as np
from numpy import exp, loadtxt, pi, sqrt, arange, interp

import matplotlib.pyplot as plt
from matplotlib.colors import LogNorm

from astropy.io import fits 
from astropy.nddata import StdDevUncertainty
import astropy.units as u
from astropy.visualization import make_lupton_rgb
from astropy.visualization import quantity_support
from astropy.modeling import models

from specutils import Spectrum1D

import lmfit
from lmfit import Model, Minimizer, Parameters
from lmfit.model import save_modelresult
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="definitions-of-functions">
           <h2>
            Definitions of functions
            <a class="headerlink" href="#definitions-of-functions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="scrolling">
            <h3>
             Scrolling
             <a class="headerlink" href="#scrolling" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Limit scrolling in cell output.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>%%javascript
IPython.OutputArea.auto_scroll_threshold=70;
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <script type="application/javascript">
               IPython.OutputArea.auto_scroll_threshold=70;
              </script>
             </div>
            </div>
           </section>
           <section id="model-functions">
            <h3>
             Model Functions
             <a class="headerlink" href="#model-functions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             A variety of emission line, continuum and extinction models for spectral fitting.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def Modelcero(x):
    """Simple model of 0 to initialize some models"""
    return 0*x

#powerlaw, zblackbody, gaussian and drude functions wrap existing astropy models.
#lmfit requires wavelength (x) to be passed as function parameter.

def powerlaw(x, c1, c2):
    """power law function (c1*nu^c2) normalized at 1 micron, with positive index convention"""
    x0=1.0  #Normalize at  1 micron
    c2=-c2
    return models.PowerLaw1D.evaluate(x,c1,x0,c2)

def zblackbody(x, OnePlusZ, T, scale):
    """black body function"""
    xs=x*u.um/OnePlusZ
    bb=models.BlackBody(T*u.K, scale)
    return bb(xs)

def gaussian(x, amplitude, xcen, std):
    """1-d gaussian"""
    return models.Gaussian1D.evaluate(x,amplitude,xcen,std)   

def drude(x, amplitude, peakx, frac_FWHM):
    """dust emission"""
    FWHM=peakx*frac_FWHM
    return models.Drude1D.evaluate(x,amplitude,peakx,FWHM)

#pahdust and sidust functions do not exist in astropy

def pahdust(x, OnePlusZ, amplitude_76, amplitude_113):
    """PAH dust emission"""
    
    #Ionized PAH features
    PAH_peakx=     [ 5.27, 5.70, 6.22, 6.69, 7.42, 7.60, 7.85, 8.33, 8.61]
    PAH_frac_FWHM= [0.034,0.035, 0.030,0.07, 0.126,0.044,0.053,0.050, 0.039]
    PAH_rel_amplitude= [0.0,  0.0,   0.8,  0.0,  0.0,  1.0,  0.6,  0.0,   0.5]
    PAH_amplitude=[]
    for ampl in PAH_rel_amplitude: PAH_amplitude.append(amplitude_76*(ampl/PAH_rel_amplitude[5]))
 
    #Neutral PAH features
    PAH_peakx+=    [10.68, 11.23,11.33]
    PAH_peakx+=    [11.99,12.62,12.69,13.48,14.04,14.19,15.90, 16.45,17.04,17.375,17.87,18.92]
    PAH_frac_FWHM+=[0.020, 0.012,0.022]
    PAH_frac_FWHM+=[0.045,0.042, 0.013,0.040,0.016,0.025,0.020,0.014,0.065, 0.012, 0.016,0.019]   
    PAH_rel_amplitude= [0.0,  0.6, 1.0]
    PAH_rel_amplitude+=[0.2,  0.3,   0.1,  0.0,  0.1,  0.1,  0.0,   0.0,  0.0,  0.0,   0.0,  0.0]
    for ampl in PAH_rel_amplitude: PAH_amplitude.append(amplitude_113*(ampl/PAH_rel_amplitude[2]))
    
    pahflux=x-x
    for peakx, frac_FWHM, ampl in zip(PAH_peakx,PAH_frac_FWHM,PAH_amplitude):
        pahflux=pahflux+drude(x,ampl,peakx*OnePlusZ,frac_FWHM)

    return pahflux    #Amplitude unit

def sidust(x, T, amplitude):
    """Silicate dust emission"""
    
    #Custom extinction curve built from weighted sum of three components: 
    #two Drude functions and an exponent 1.7 power-law.
    d1=drude(x,0.80,10.0,0.25)
    d2=drude(x,0.25,11.1,0.25)
    #d3=drude(x,0.40,17.0,0.40)  #Outside of wavelength range.
    ext=d1+d2  #+d3

    # Form linear combination of modified silicate and powerlaw.
    beta=0.1
    ext=(1. - beta)*ext + beta*(9.7/x)**1.7
    si_em=amplitude*1.0E-6*3.97289E13/x**3/(exp(1.4387752E4/x/T)-1.)*ext
    
    return si_em

# Enable tabulated extinction functions. Existing options in dust_extinction are insufficient
# at mid-IR wavelengths

def extinction_a(x, tau, a):
    """Extinction from table data"""
    ext=np.interp(x, wave, a)      
    return exp(-tau*ext)

#Read extinction data from Chiar &amp; Tielens (2005)
#Note, this is normalized to extinction in the K-band (1.004 at 2.14 um)
#agal is for Galactic Center, alocal is for local ISM extinction

Boxdata="https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/"
wave, agal, alocal = np.loadtxt(Boxdata+'chiar+tielens_2005.dat', skiprows=14, usecols=(0, 1, 2), unpack=True)

#Compare to dust_extinction
#P92 is the only model that extends over the mid-IR range, but it is crude
#Normalized to extinction in the V-band

from dust_extinction.parameter_averages import F99
from dust_extinction.shapes import P92
a92 = P92()

#Extinction Comparison
tau=1.
xa=arange(5.,15.,0.01)
extin1=extinction_a(xa, tau, alocal)
extin2=extinction_a(xa, tau, agal)
lam=xa*u.um
scale=21.9             #Empirical scaling to adjust P2 curve to match Chiar &amp; Tielens Local ISM curve
aa92=scale*a92(lam)
extin3 = exp(-tau*aa92)

with quantity_support():
    plt.plot(lam,extin1,label='CT+05 Local ISM')
    plt.plot(lam,extin2,label='CT+05 Gal. Cen.')
    plt.plot(lam,extin3,label='P92 scaled')
    plt.legend()
    plt.show()

pl1=powerlaw(xa,1.0,-1.0)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/cube_fitting_9_0.png" src="../../_images/cube_fitting_9_0.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="model-parameters">
           <h2>
            Model Parameters
            <a class="headerlink" href="#model-parameters" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Declare the parameters of model functions. Parameters are frozen by setting vary=’False’
in the lmfit setpar command.  For now we are just fitting amplitudes of emission features.
Fits with more variable parameters take longer.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def setpar(pars, name, value, vary, minus):
    """Set any parameter"""
    pars[name].set(value,vary=vary,min=minus)
    
def gaussian_defpar(name, amplitude, mean, stddev, pars):
    """set the parameters for a gaussian"""
    std=stddev
    name=str(name)
    xcen=mean*OneZ
    setpar(pars,name+'_std',std,False,None)
    #setpar(pars,name+'_std',std,True,0)
    setpar(pars,name+'_xcen',xcen,False,None)
    setpar(pars,name+'_amplitude',amplitude,True,0)
    return #pars[name+'_std'].set(std,vary=False),pars[name+'_xcen'].set(xcen,vary=False),pars[name+'_amplitude'].set(amplitude)

def drude_defpar(name, amplitude, peakx, frac_FWHM, pars):
    """set the parameters for a drude"""
    peakx=peakx*OneZ
    setpar(pars,name+'_frac_FWHM',frac_FWHM,False,None)
    #setpar(pars,name+'_frac_FWHM',frac_FWHM,True,0)
    setpar(pars,name+'_peakx',peakx,False,None)
    setpar(pars,name+'_amplitude',amplitude,True,0)    
    return #pars[name+'_frac_FWHM'].set(frac_FWHM,vary=False),pars[name+'_peakx'].set(peakx,vary=False),pars[name+'_amplitude'].set(amplitude)

def pahdust_defpar(name, OnePlusZ, amplitude_76, amplitude_113, pars):
    """set the parameters for pdr dust"""
    setpar(pars,name+'_amplitude_76',amplitude_76,True,0) 
    setpar(pars,name+'_amplitude_113',amplitude_113,True,0) 
    setpar(pars,name+'_OnePlusZ',OnePlusZ,False,None)
    return #pars[name+'_frac_FWHM'].set(frac_FWHM,vary=False),pars[name+'_peakx'].set(peakx,vary=False),pars[name+'_amplitude'].set(amplitude)

def sidust_defpar(name, T, amplitude, pars):
    setpar(pars,name+'_amplitude',amplitude,True,0)
    setpar(pars,name+'_T',T,False,0)
    return

def gaussian_extractpars(prefix, result):
    """extract the parameters for a gaussian"""
    amp = result.params[prefix+'amplitude'].value
    cen = result.params[prefix+'xcen'].value
    std = result.params[prefix+'std'].value
    return amp, cen, std

def drude_extractpars(prefix, result):
    """extract the parameters for a drude"""
    ampl = result.params[prefix+'amplitude'].value
    peak = result.params[prefix+'peakx'].value         
    frac = result.params[prefix+'frac_FWHM'].value
    return ampl, peak, frac

def pahdust_extractpars(prefix, result):
    """extract the parameters for pahdust model"""
    ampl_76 = result.params[prefix+'amplitude_76'].value
    ampl_113 = result.params[prefix+'amplitude_113'].value
    return ampl_76, ampl_113  

def sidust_extractpars(prefix, result):
    """extract the parameters for pahdust model"""
    T = result.params[prefix+'T'].value
    ampl = result.params[prefix+'amplitude'].value
    return T,ampl 
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="line-flux-from-model-parameters">
            <h3>
             Line Flux from Model Parameters
             <a class="headerlink" href="#line-flux-from-model-parameters" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Helper functions to calculate the fluxes and widths of emission features from model parameters.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>#NOTE that these are ANALYTIC estimates of line fluxes,
#NOT available in astropy modeling or specutils

def gaussianline_flux(amp,std,cen):
    """calculate the integrated flux for a gaussian line"""
    #Units= amp:Jy cen:microns
    c= 29979.2458*10**10 #c in microns/s
    gaussianfactor=sqrt(2*pi)
    return amp*gaussianfactor*c*std/(cen**2)*10**(-23)      #erg s^{-1} cm^{-2}

def drudeline_flux(amp,frac,peak):
    """calculate the integrate flux for a drude line"""
    #Units= amp:Jy peak:microns
    c= 29979.2458*10**10 #c in microns/s
    drudefactor=pi
    return (amp*frac*drudefactor*c/((2*peak)))*10**(-23)   #erg s^{-1} cm^{-2}
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="extract-and-plot-1d-spectrum-and-model-components">
            <h3>
             Extract and plot 1D spectrum and model components
             <a class="headerlink" href="#extract-and-plot-1d-spectrum-and-model-components" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def extract_spec(a, b):
    """extract spec and errors from a,b coordinates"""
    spec_pix=data_cube[:,a,b]
    err_pix=error_cube[:,a,b]
    return spec_pix, err_pix

def model_comps(model_result):
    """Evaluate model components"""
    comps = model_result.eval_components()
    plcomp=[]
    h2comp=[]
    pahcomp=[]
    sidustcomp=[]
    #print(comps.keys())
    for key in comps.keys(): 
        keyl=key.lower()
        if keyl[0:3]=='pwl': plcomp.append(key)
        if keyl[0]=='h': h2comp.append(key)
        if keyl[0:3]=='pah': pahcomp.append(key)
        if keyl[0:3]=='sid': sidustcomp.append(key)
       
    plaw_model=x-x
    h2_model=x-x
    ion_model=x-x
    pah_model=x-x
    sidust_model=x-x
    for comp in plcomp: plaw_model+=comps[comp]
    for comp in h2comp: h2_model+=comps[comp]
    for comp in pahcomp: pah_model+=comps[comp]
    for comp in sidustcomp: sidust_model+=comps[comp]
    atomiclines=['ArII','SIV','NeII']
    for comp in atomiclines:
        ion_model+=comps[comp+'_']
        
    return([plaw_model,h2_model,ion_model,pah_model,sidust_model],['PL','H2','Ions','PAHs','Si Dust'])

def plot_fit(x, spec, specerr, model_result):
    """plot spectrum, model components, and residual"""

    #Model Results
    fit_model = model_result.best_fit 
    fit_residual = spec - fit_model

    #Evaluate model components
    mod_comps,mod_labels=model_comps(model_result)
        
    #Spec-1D object
    spec1 = Spectrum1D(spectral_axis=x* u.um, flux=spec*u.Jy, uncertainty=StdDevUncertainty(specerr))
    with quantity_support():    
        f, ax = plt.subplots()  
        #ax.step, ax.plot, ax.scatter all work, but ax.scatter doesn't autscale correctly
        ax.plot(spec1.spectral_axis, spec1.flux,label='Data', color='k')
        #ax.set_xlabel(r"$Wavelength\ (\mu m)$")
        ax.grid(linestyle=':')
        #plt.errorbar only works on unitless data
        #ax.errorbar(spec1.spectral_axis, spec1.flux, yerr=specerr,label='Data', color='k')
        #ax.plot(spec1.spectral_axis, spec1.flux, yerr=specerr,label='Data', color='k')
        
        plt.show()   

    #Plot results
    fig1=plt.figure(figsize=(15, 6), dpi= 150)
    
    frame1=fig1.add_axes((.1,.3,.8,.6))
    frame1.set_xticklabels([])
    plt.ylabel(r"$Flux\ (Jy)$")
    plt.grid(linestyle=':')
    plt.errorbar(x, spec, yerr=specerr,label='Data', color='k')
    plt.plot(x, fit_model,label='Model',c='red')
    mod_colors=['brown','g','b','magenta','orange']
    for mcomp, mlabel, mcolr in zip(mod_comps,mod_labels,mod_colors):
        plt.plot(x, mcomp, label=mlabel, c=mcolr)        
    plt.legend()

    frame2=fig1.add_axes((.1,.1,.8,.2))
    plt.plot(x, 0.*x, '-',c='r')
    plt.xlabel(r"$Wavelength\ (\mu m)$")
    plt.grid(linestyle=':')
    plt.errorbar(x,fit_residual,yerr=specerr,c='k')

    plt.show()     
    return 
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="input-data">
           <h2>
            Input data
            <a class="headerlink" href="#input-data" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            With the present lack of JWST flight data, we utilize the SL1 and SL2 spectral cubes generated
using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby
galaxy Messier 58. This galaxy has a radio-loud Seyfert nucleus that is exciting strong
H2 emission via shocks.  There is also significant star-formation, revealed by PAH emission
features.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Spitzer IRS (CUBISM) cube loader does not exist in specutils

#Target 
targname='M58'

#Redshift
z=0.005060
OneZ=1.+z

#Download and open the data cubes and their uncertainties
BoxPath="https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/"
cubeSL1 = fits.open(BoxPath+targname+'_SL1_cube.fits') 
errorsSL1 = fits.open(BoxPath+targname+'_SL1_cube_unc.fits')
cubeSL2 = fits.open(BoxPath+targname+'_SL2_cube.fits') 
errorsSL2 = fits.open(BoxPath+targname+'_SL2_cube_unc.fits')

#Cube Info and Headers
cubeSL1.info()
cubeSL2.info()
hdr1 = cubeSL1[0].header                        
er_hdr1=errorsSL1[0].header
hdr2 = cubeSL2[0].header                               
er_hdr2=errorsSL2[0].header
#print(repr(hdr1))

#Flux Data
data_cube1 = cubeSL1[0].data
error_cube1 = errorsSL1[0].data
data_cube2 = cubeSL2[0].data
error_cube2 = errorsSL2[0].data

#Wavelength Data
xwave1 = cubeSL1[1].data
xwave1 = xwave1.field(0)[0]
xwave2 = cubeSL2[1].data
xwave2 = xwave2.field(0)[0]
x=[]
for line in xwave2:
    x.append(float(line))
for line in xwave1:
    x.append(float(line))
x=np.array(x)

#Change the units from MJy/sr to Jy/pix
correct_unit1=abs(hdr1['CDELT1'])*abs(hdr1['CDELT2'])*0.0003046118*(10**6)    
data_cube1=data_cube1*correct_unit1
error_cube1=error_cube1*correct_unit1
correct_unit2=abs(hdr2['CDELT1'])*abs(hdr2['CDELT2'])*0.0003046118*(10**6)    
data_cube2=data_cube2*correct_unit2
error_cube2=error_cube2*correct_unit2

#Concatenate SL1 and SL2
data_cube=np.concatenate((data_cube2,data_cube1),axis=0)
error_cube=np.concatenate((error_cube2,error_cube1),axis=0)

#Reorder x and data_cube
xcor = x.argsort()
data_cube = data_cube[xcor]
error_cube = error_cube[xcor]
x=np.sort(x)

#Cube dimensions and trimming 
xsize, ysize, zsize = data_cube.shape
ytrim=0; ysize=ysize-ytrim
ztrim=3; zsize=zsize-ztrim
print('Trimmed cube dimensions:', xsize, ysize, zsize)

#Collapsed 2D image
cube_2dflux=np.sum(data_cube,axis=0)[0:ysize,0:zsize]

#Collapsed 1D spectrum
cube_1dflux=np.zeros(xsize,)
for a in arange(0,ysize):
    for b in arange(0,zsize):
        spec_pix,err_pix=extract_spec(a,b)
        cube_1dflux=cube_1dflux+spec_pix

f,(ax1,ax2)=plt.subplots(1,2, figsize=(10,5))
ax1.set_title('log Flux (Sum over Wavelength)')
ax1.imshow(cube_2dflux, origin='lower', cmap='gray', norm=LogNorm())
ax2.set_title('Flux (Sum over Spaxels)')
ax2.plot(x,cube_1dflux)
ax2.set_xlabel(r"Wavelength $(\mu m)$")
ax2.set_ylabel('Flux (Jy)')
plt.show()
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Filename: /home/runner/.astropy/cache/download/url/06853bf85036af1a6d55c1fb3a08260f/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 117)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [117E]   
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Filename: /home/runner/.astropy/cache/download/url/bec801dcb9ee22f478e4a56b91820bd4/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 77)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [77E]   
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Trimmed cube dimensions: 194 30 32
</pre>
              </div>
             </div>
             <img alt="../../_images/cube_fitting_17_3.png" src="../../_images/cube_fitting_17_3.png"/>
            </div>
           </div>
          </section>
          <section id="model-parameter-starting-values">
           <h2>
            Model Parameter Starting Values
            <a class="headerlink" href="#model-parameter-starting-values" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Set starting parameters for spectral model components. Use a PAH dust model with only two free parameters (7.6 and 11.3 micron PAH flux).  The rest of the PAH ratios are fixed by this ‘pahdust’ model, so that fitting the whole cube does not take so long.   Later, we will fit summed region spectra with all PAH amplitudes free.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>#Power Law
p_law = Model(powerlaw,prefix='pwl_')
generic_pars = p_law.make_params()      
setpar(generic_pars,'pwl_c1',0.0002,True,None)
setpar(generic_pars,'pwl_c2',0.0015,True,None)

#PAH dust model with fixed PAH feature ratios
prefix='pahdust1_'
pahs = Model(pahdust,prefix=prefix)
generic_pars.update(pahs.make_params())
pahdust_defpar('pahdust1',1.00506,0.003,0.005,generic_pars)

#Silicate dust emission
prefix='sidust1_'
silicate= Model(sidust,prefix=prefix)
generic_pars.update(silicate.make_params())
sidust_defpar('sidust1', 190.,1.E-4,generic_pars)

#Gaussians with wavelengths from Smith et al 2007
#H2 pure-rotational lines
h2lines=['55','61','69','80','96','122']
h2wavel=[5.511,6.109,6.909,8.026,9.665,12.278]
amp_guess=0.05
std_guess=0.04
gaussH2=Model(Modelcero)
for line in h2lines:
    prefix='h'+line+'_'
    gaussH2+=Model(gaussian,prefix=prefix)
generic_pars.update(gaussH2.make_params())
for h2lin, h2w in zip(h2lines,h2wavel):
    gaussian_defpar('h'+h2lin, amp_guess, h2w, std_guess,generic_pars)

#Atomic lines
atomiclines=['ArII','SIV','NeII']
atomicwavel=[6.985,10.511,12.813]
amp_guess=0.05
std_guess=0.05
gaussAt=Model(Modelcero)
for line in atomiclines:
    prefix = line+'_'
    gaussAt+=Model(gaussian,prefix=prefix)
generic_pars.update(gaussAt.make_params())
for atlin, atw in zip(atomiclines,atomicwavel):
    gaussian_defpar(atlin,amp_guess, atw, std_guess,generic_pars)
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="fit-a-representative-spaxel">
           <h2>
            Fit a Representative Spaxel
            <a class="headerlink" href="#fit-a-representative-spaxel" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Fit a single spaxel in the cube and use the fit parameters to adjust the generic model starting parameters.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>#Select spaxel
spec=data_cube[:,8,16]
specerr=error_cube[:,8,16]

#Composite model (powerlaw + PAHs + H2 + Atomic lines, no extinction)
generic_mod = p_law + silicate + pahs + gaussH2  + gaussAt

print(generic_mod.param_names)

#Fit and plot
spax_result = generic_mod.fit(spec, generic_pars, weights=1./specerr, x=x)
plot_fit(x, spec, specerr, spax_result)

#Save results
save_modelresult(spax_result, 'OnePointResult.sav')

#Update generic model starting parameters
for par in spax_result.params:
    value=spax_result.params[par].value
    vary=spax_result.params[par].vary
    minus=spax_result.params[par].min
    if minus==float("-inf"):
        minus=None
    generic_pars[par].set(value,vary=vary,min=minus)
    
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>['pwl_c1', 'pwl_c2', 'sidust1_T', 'sidust1_amplitude', 'pahdust1_OnePlusZ', 'pahdust1_amplitude_76', 'pahdust1_amplitude_113', 'h55_amplitude', 'h55_xcen', 'h55_std', 'h61_amplitude', 'h61_xcen', 'h61_std', 'h69_amplitude', 'h69_xcen', 'h69_std', 'h80_amplitude', 'h80_xcen', 'h80_std', 'h96_amplitude', 'h96_xcen', 'h96_std', 'h122_amplitude', 'h122_xcen', 'h122_std', 'ArII_amplitude', 'ArII_xcen', 'ArII_std', 'SIV_amplitude', 'SIV_xcen', 'SIV_std', 'NeII_amplitude', 'NeII_xcen', 'NeII_std']
</pre>
              </div>
             </div>
             <img alt="../../_images/cube_fitting_21_1.png" src="../../_images/cube_fitting_21_1.png"/>
             <img alt="../../_images/cube_fitting_21_2.png" src="../../_images/cube_fitting_21_2.png"/>
            </div>
           </div>
           <p>
            Plot of observed flux density (black), model fit (red), and residuals (bottom panel).  This spaxel has strong H2 emission at 9.6 microns and 8 micron PAH and [Ne II] 12.8 micron emission from star-forming regions.
           </p>
          </section>
          <section id="fit-the-entire-cube">
           <h2>
            Fit the Entire Cube
            <a class="headerlink" href="#fit-the-entire-cube" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Identify NaNs, then create list of models (based on generic model), one entry per NaN-free spaxel. Next launch the multiprocessing Pool, limited to number of available cores minus one. Fitting the entire cube (900 spaxels) takes about 2 minutes to fit with 7 processes running in parallel.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>cube_res = mp.Manager().dict()

#The fit method is redefined as a top-level function to make it pickle-able for multiprocessing.Pool
def modfit(spaxel, generic_pars, weights, x):
        modf=generic_mod.fit(spaxel, generic_pars, weights=1./spaxerr, x=x)
        return modf.dumps()

#Helper to either assign a NaN result or fit a single non-NaN spaxel
def fit_point(args):
        a,b,spaxel,spaxerr,x,generic_pars,nancheck = args
        # print(a, b, len(spaxel), mp.current_process().name)
        if nancheck == False:
            res_point=modfit(spaxel, generic_pars, weights=1./spaxerr, x=x)

            cube_res[(a,b)] = res_point 
        elif nancheck == True:
            cube_res[(a,b)] = float('nan')
        return 

#Extraction region dimensions (trimmed cube)
astart=0; aend=ysize
bstart=0; bend=zsize

#Check for NaNs, select data, and set model start parameters for each spaxel
pooldata=[]
for a in np.arange(astart,aend):
    for b in np.arange(bstart,bend):        
        nancheck = False
        for point in data_cube[:,a,b]:
            if np.isnan(point) == True or point == 0:
                nancheck = True
        
        #Copy spaxel data vectors
        spaxel = 1.0*np.array(data_cube[:,a,b])
        spaxerr= 1.0*np.array(error_cube[:,a,b])
        wavelen= 1.0*np.array(x)
        
        pooldata.append([a,b,spaxel,spaxerr,wavelen,generic_pars,nancheck])


#Launch Multiprocessing Pool
start_time = time.time()
if __name__ == '__main__':
    with Pool(mp.cpu_count() - 1) as pool:
        pool.map(fit_point,pooldata)    

print('Time count')
print("--- %s seconds ---" % (time.time() - start_time))

#Save model fit
with open('MPF_cube_result_model.sav', 'wb') as fp:
    pickle.dump(list(cube_res.items()), fp)

#Load model fit to full cube
cube_res = mp.Manager().dict()
with open ('MPF_cube_result_model.sav', 'rb') as fp:
        restore_cube = pickle.load(fp)
for line in restore_cube:
    pos=line[0]
    cube_res[pos] = line[1]
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time count
--- 383.49088311195374 seconds ---
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="total-flux-and-reduced-chi-2-maps">
            <h3>
             Total flux and Reduced Chi^2 Maps
             <a class="headerlink" href="#total-flux-and-reduced-chi-2-maps" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Display total flux image (observed flux cube collapsed along wavelength direction) and reduced Chi^2 image for model fit in square sub-region.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>#Sum observed flux in each spaxel
cube_tflux=np.sum(data_cube,axis=0)[0:ysize,0:zsize]

#Sum model flux in each spaxel
tcube_chi=np.zeros((ysize, zsize))
tcube_modflux=np.zeros((ysize, zsize))
funcdefs = {}
modres=spax_result
for pos, dumpval in cube_res.items():
    #for pos, dumpval in cube_res:
    if str(cube_res[pos])=='nan':
        tcube_modflux[pos]=np.float('nan')
        tcube_chi[pos]=np.float('nan')
    else:
        result = modres.loads(dumpval, funcdefs=funcdefs)
        tcube_modflux[pos]=np.sum(result.best_fit)
        tcube_chi[pos]=result.redchi

f,(ax1,ax2,ax3)=plt.subplots(1,3, figsize=(10,15))
ax1.set_title('log Observed Flux')
ax1.imshow(cube_tflux, origin='lower', cmap='gray', norm=LogNorm())
ax2.set_title('log Model Flux')
ax2.imshow(tcube_modflux, origin='lower', cmap='gray', norm=LogNorm())
ax3.set_title('Reduced Chi Square')
ax3.imshow(cube_tflux-tcube_modflux, origin='lower', cmap='hot')
plt.show()
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output traceback highlight-ipythontb notranslate">
               <div class="highlight">
                <pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">line</span> <span class="mi">12</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="c1">#for pos, dumpval in cube_res:</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">'nan'</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">12</span>         <span class="n">tcube_modflux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>         <span class="n">tcube_chi</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="k">else</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/numpy/__init__.py:284,</span> in <span class="ni">__getattr__</span><span class="nt">(attr)</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span>     <span class="kn">from</span> <span class="nn">.testing</span> <span class="kn">import</span> <span class="n">Tester</span>
<span class="g g-Whitespace">    </span><span class="mi">282</span>     <span class="k">return</span> <span class="n">Tester</span>
<span class="ne">--&gt; </span><span class="mi">284</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">"module </span><span class="si">{!r}</span><span class="s2"> has no attribute "</span>
<span class="g g-Whitespace">    </span><span class="mi">285</span>                      <span class="s2">"</span><span class="si">{!r}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

<span class="ne">AttributeError</span>: module 'numpy' has no attribute 'float'
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Collapsed cube maps, showing observed flux, model flux, and Chi^2/DF.  White regions with NaNs in the input data cube also have NaNs in the output model cube along the left and top edges and in column 26.  Residuals in the nucleus may either be the result of inadequate PSF sampling or mis-fit AGN model.
            </p>
           </section>
           <section id="line-and-pah-feature-flux-maps">
            <h3>
             Line and PAH feature flux maps.
             <a class="headerlink" href="#line-and-pah-feature-flux-maps" title="Permalink to this headline">
              #
             </a>
            </h3>
            <section id="functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
             <h4>
              Functions to extract line and PAH maps from model parameter cube
              <a class="headerlink" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>def line_map(line, cube_res, modres):
    """Create total emission line flux map for Gaussian emission line model component"""
    
    line_flux=np.zeros((35, 35))
    for pos, dumpval in cube_res.items():
        if str(cube_res[pos])=='nan':
            line_flux[pos]=float('nan')
        else:
            result = modres.loads(dumpval, funcdefs=funcdefs)
            prefix = line+'_'
            amp, cen, std = gaussian_extractpars(prefix,result)               
            line_flux[pos]=gaussianline_flux(amp,std,cen)                      

    return line_flux

def pahdust_maps(pahdust_comp, cube_res, modres):
    """Create total emission line flux map for Gaussian emission line model component"""
    
    pah_ion_flux=np.zeros((35, 35))
    pah_neutral_flux=np.zeros((35, 35))
    for pos, dumpval in cube_res.items():
        if str(cube_res[pos])=='nan':
            pah_ion_flux[pos]=float('nan')
            pah_neutral_flux[pos]=float('nan')
        else:
            result = modres.loads(dumpval, funcdefs=funcdefs)
            prefix = pahdust_comp+'_'
            ampl_76, ampl_113 = pahdust_extractpars(prefix,result)  
            pah_76_flux = drudeline_flux(ampl_76,0.044,7.60)
            pah_113_flux = drudeline_flux(ampl_113,0.032,11.33)                      
            pah_ion_flux[pos]=pah_76_flux
            pah_neutral_flux[pos]=pah_113_flux

    return pah_ion_flux, pah_neutral_flux

def sidust_map(sidust_comp, cube_res, modres):
    """Create silicate dust emission map"""
    sidust_flux=np.zeros((35, 35))
    for pos, dumpval in cube_res.items():
        if str(cube_res[pos])=='nan':
            sidust_flux[pos]=float('nan')
        else:
            result = modres.loads(dumpval, funcdefs=funcdefs)
            prefix = sidust_comp+'_'
            t,si_ampl = sidust_extractpars(prefix,result)
            si_norm=1.0
            sidust_flux[pos]=si_ampl*si_norm
            
    return sidust_flux
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
            <section id="h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
             <h4>
              H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
              <a class="headerlink" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>h2_flux=line_map('h96', cube_res, modres)
ne_flux=line_map('NeII', cube_res, modres)
pah_ion_flux, pah_neutral_flux = pahdust_maps('pahdust1', cube_res, modres)
sidust_flux=sidust_map('sidust1', cube_res, modres)

f,(ax1,ax2,ax3,ax4,ax5)=plt.subplots(1,5, figsize=(10,20))

ax1.set_title('[Ne II] 12.8 um')
ax1.imshow(ne_flux, origin='lower')
ax2.set_title('H2 9.6 um')
ax2.imshow(h2_flux, origin='lower')
ax3.set_title('PAH 7.6 um')
ax3.imshow(pah_ion_flux, origin='lower')
ax4.set_title('PAH 11.3 um')
ax4.imshow(pah_neutral_flux, origin='lower')
ax5.set_title('Si dust em.')
ax5.imshow(sidust_flux, origin='lower')           
plt.show()

#Make RGB images
stretch1=0.000000000000004
stretch2=0.000000000000005
m58_neii_pah0_h2 = make_lupton_rgb(2.5*ne_flux, h2_flux, pah_neutral_flux, minimum=0, Q=5, stretch=stretch1, filename="m58_NeII_H96_PAH113.png")
m58_pah_h2 = make_lupton_rgb(pah_neutral_flux, h2_flux, 1.2*pah_ion_flux, minimum=0, Q=5, stretch=stretch2, filename="m58_PAH113_H96_PAH76.png")

#Two-panel figure
f,(ax1,ax2)=plt.subplots(1,2, figsize=(10,15))
ax1.axis('off')
ax1.imshow(m58_neii_pah0_h2,origin='lower')
ax2.axis('off')
ax2.imshow(m58_pah_h2,origin='lower')
plt.show()
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              3-color RGB images. Top: individual feature maps. Bottom left: r = [Ne II] 12.8 micron, g = H2 S(3) 9.6 micron, b = PAH 11.3 micron. Ionized atomic gas in the active galactic nucleus shows up as red, shocked regions are green, and dust emission is blue. Bottom right: r = PAH 11.3 micron, g = H2 S(3) 9.6 micron, b = PAH 7.6 micron. Neutral PAH emission shows up as red, ionized PAH emission from PDRs in star-forming regions is blue, and shocked regions are green.
             </p>
            </section>
           </section>
          </section>
          <section id="extract-and-model-cube-sub-regions">
           <h2>
            Extract and model cube sub-regions
            <a class="headerlink" href="#extract-and-model-cube-sub-regions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="make-spectral-region-masks">
            <h3>
             Make spectral region masks
             <a class="headerlink" href="#make-spectral-region-masks" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Define spectral extraction regions based on spatial location, line flux, and line or feature ratios.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>#Nucleus extraction region, defined by 5x5 square
nuc_mask=np.zeros((35, 35))
for a in arange(-2,3):
    for b in arange(-2,3):
        nuc_mask[14-a,17-b]=int(1)

#Spiral arm extraction region
arm_mask=np.where(((pah_neutral_flux&gt;=0.155e-14) &amp;((pah_ion_flux/pah_neutral_flux)&gt;0.8) &amp; (nuc_mask==0)),1,0)

#Inner disk extraction region        
pah_mask=np.where(((pah_neutral_flux&gt;=0.155e-14) &amp; (h2_flux&lt;1e-15) &amp; (nuc_mask==0)),1,0) - arm_mask
pah_mask[:,0:3]=int(0)  #Trim edges of cube
pah_mask[28:,:]=int(0)

#Regions of strongest H2 emission
h2s_mask=np.where(((h2_flux&gt;=1e-15)&amp;((h2_flux/pah_neutral_flux)&gt;0.7) &amp; (nuc_mask==0)),1,0)

#H2 extraction region
h2_mask=np.where(((h2_flux&gt;=1e-15) &amp; (nuc_mask==0)),1,0)-h2s_mask

#M58 combined central regions mask (excluding spiral arm)
m58_mask=nuc_mask + h2_mask*2 + h2s_mask*3 + pah_mask*4 +arm_mask*5

f,((ax1,ax2,ax3,ax4,ax5,ax6))=plt.subplots(1,6,figsize=(15,10))

ax1.set_title('Nucleus')
ax1.imshow(nuc_mask,origin='lower')
ax2.set_title('Spiral Arm')
ax2.imshow(arm_mask,origin='lower')
ax3.set_title('Inner Disk')
ax3.imshow(pah_mask,origin='lower')
ax4.set_title('H2')
ax4.imshow(h2_mask,origin='lower')
ax5.set_title('H2-strongest')
ax5.imshow(h2s_mask,origin='lower')
ax6.set_title('All regions')
ax6.imshow(m58_mask,origin='lower')

plt.show()
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Extraction region masks based on spatial and emission line or PAH feature strengths.
            </p>
           </section>
           <section id="extract-spectra-from-mask-regions">
            <h3>
             Extract spectra from mask regions
             <a class="headerlink" href="#extract-spectra-from-mask-regions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Spectra summed over five different regions: Spiral Arm, Nucleus, PAH, H2, and Strongest H2
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>nuc_spec=np.zeros(xsize,)
nuc_err=np.zeros(xsize,)
pah_spec=np.zeros(xsize,)
pah_err=np.zeros(xsize,)
h2_spec=np.zeros(xsize,)
h2_err=np.zeros(xsize,)
arm_spec=np.zeros(xsize,)
arm_err=np.zeros(xsize,)
h2s_spec=np.zeros(xsize,)
h2s_err=np.zeros(xsize,)
for a in arange(0,ysize):
    for b in arange(0,zsize):
        if nuc_mask[a,b]==1:
            spec_pix,err_pix=extract_spec(a,b)
            nuc_spec=nuc_spec+spec_pix
            nuc_err=nuc_err+err_pix**2
        if pah_mask[a,b]==1:
            spec_pix,err_pix=extract_spec(a,b)
            pah_spec=pah_spec+spec_pix
            pah_err=pah_err+err_pix**2
        if h2_mask[a,b]==1:
            spec_pix,err_pix=extract_spec(a,b)
            h2_spec=h2_spec+spec_pix
            h2_err=h2_err+err_pix**2
        if arm_mask[a,b]==1:
            spec_pix,err_pix=extract_spec(a,b)
            arm_spec=arm_spec+spec_pix
            arm_err=arm_err+err_pix**2
        if h2s_mask[a,b]==1:
            spec_pix,err_pix=extract_spec(a,b)
            h2s_spec=h2s_spec+spec_pix
            h2s_err=h2s_err+err_pix**2

nuc_err=sqrt(nuc_err)
pah_err=sqrt(pah_err)
h2_err=sqrt(h2_err)
arm_err=sqrt(arm_err)
h2s_err=sqrt(h2s_err)
f,((ax1,ax2,ax3),(ax4,ax5,ax6))=plt.subplots(2,3,figsize=(15,10))

ax1.set_title('Spiral Arm')
ax1.errorbar(x,arm_spec,yerr=arm_err, c='gold')
ax1.set_ylabel('Flux (Jy)')

ax2.set_title('Nucleus')
ax2.errorbar(x,nuc_spec,yerr=nuc_err, c='navy')

ax3.set_title('Inner Disk')
ax3.errorbar(x,pah_spec,yerr=pah_err, c='limegreen')

ax4.set_title('H2')
ax4.errorbar(x,h2_spec,yerr=h2_err, c='steelblue')
ax4.set_xlabel(r"Wavelength $(\mu m)$")
ax4.set_ylabel('Flux (Jy)')

ax5.set_title('All regions')
ax5.imshow(m58_mask,origin='lower')
ax5.set_xlabel('Pixel')

ax6.set_title('H2-Strongest')
ax6.errorbar(x,h2s_spec,yerr=h2s_err,c='teal')
ax6.set_xlabel(r"Wavelength $(\mu m)$")
plt.show()

</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="save-spectra-to-files">
            <h3>
             Save spectra to files
             <a class="headerlink" href="#save-spectra-to-files" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>#np.savetxt(targname+'_spec_nuc.dat', np.column_stack((x, nuc_spec, nuc_err)),header='Wavelength[microns]     Flux_Nucleus[Jy]      Err_Flux_Nucleus')
#np.savetxt(targname+'_spec_h2.dat', np.column_stack((x, h2_spec, h2_err)), header='Wavelength[microns]     Flux_H2[Jy]      Err_H2')
#np.savetxt(targname+'_spec_h2s.dat', np.column_stack((x, h2_spec, h2_err)), header='Wavelength[microns]     Flux_H2s[Jy]      Err_H2s')
#np.savetxt(targname+'_spec_pah.dat', np.column_stack((x, pah_spec, pah_err)), header='Wavelength[microns]     Flux_PAH[Jy]      Err_PAH')
#np.savetxt(targname+'_spec_arm.dat', np.column_stack((x, arm_spec, arm_err)), header='Wavelength[microns]     Flux_Arm[Jy]      Err_Arm')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="fit-spectra-of-regions">
            <h3>
             Fit spectra of regions
             <a class="headerlink" href="#fit-spectra-of-regions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <section id="generic-model-components">
             <h4>
              Generic model components
              <a class="headerlink" href="#generic-model-components" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              Model 14 individual PAH components with all amplitudes free. It would be computationally expensive to do this
for the full cube, but only takes a couple of seconds for the summed region spectra.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>#Power Law
p_law = Model(powerlaw,prefix='pwl_')
generic_pars = p_law.make_params()      #Generate the parameters
setpar(generic_pars,'pwl_c1',0.005,True,None)
setpar(generic_pars,'pwl_c2',0.0015,True,None)

#Individual PAHs
drudes=Model(Modelcero)
allpahlines=['52','62','74','76','78','83','86','112','113','119','126','134','140','141'] 
for line in allpahlines:
    prefix='PAH'+line+'_'  
    drudes+=Model(drude,prefix=prefix)  
generic_pars.update(drudes.make_params())

drude_defpar('PAH52', 0.05, 5.27, 0.034,generic_pars)
drude_defpar('PAH62', 0.05, 6.22, 0.030,generic_pars)
drude_defpar('PAH74', 0.05, 7.42, 0.126,generic_pars)
drude_defpar('PAH76', 0.05, 7.60, 0.044,generic_pars)
drude_defpar('PAH78', 0.5, 7.85, 0.053,generic_pars)
drude_defpar('PAH83', 0.5, 8.33, 0.05,generic_pars)
drude_defpar('PAH86', 0.5, 8.61, 0.039,generic_pars)
drude_defpar('PAH112', 0.5, 11.23, 0.012,generic_pars)
drude_defpar('PAH113', 0.5, 11.33, 0.032,generic_pars)
drude_defpar('PAH119', 0.5, 11.99, 0.045,generic_pars)
drude_defpar('PAH126', 0.5, 12.62, 0.042,generic_pars)
drude_defpar('PAH134', 0.5, 13.48, 0.04,generic_pars)
drude_defpar('PAH140', 0.5, 14.04, 0.016,generic_pars)
drude_defpar('PAH141', 0.5, 14.19, 0.025,generic_pars)

#Silicate dust emission
prefix='sidust1_'
silicate= Model(sidust,prefix=prefix)
generic_pars.update(silicate.make_params())
sidust_defpar('sidust1', 190.,1.E-4,generic_pars)

#Gaussians with FWHM and X central from Smith et al 2007
#H2 molecular
h2lines=['55','61','69','80','96','122']
gaussH2=Model(Modelcero)
for line in h2lines:
    prefix='h'+line+'_'
    gaussH2+=Model(gaussian,prefix=prefix)
generic_pars.update(gaussH2.make_params())
gaussian_defpar('h55',0.05, 5.511, 0.02,generic_pars)
gaussian_defpar('h61',0.05, 6.109, 0.02,generic_pars)
gaussian_defpar('h69',0.05, 6.909, 0.02,generic_pars)
gaussian_defpar('h80',0.05, 8.026, 0.04,generic_pars)
gaussian_defpar('h96',0.05, 9.665, 0.04,generic_pars)
gaussian_defpar('h122',0.05, 12.278, 0.04,generic_pars)

#Atomic lines
atomiclines=['ArII','SIV','NeII']
gaussAt=Model(Modelcero)
for line in atomiclines:
    prefix = line+'_'
    gaussAt+=Model(gaussian,prefix=prefix)
generic_pars.update(gaussAt.make_params())
gaussian_defpar('ArII',0.05, 6.985, 0.02,generic_pars)
gaussian_defpar('SIV',0.05, 10.511, 0.04,generic_pars)
gaussian_defpar('NeII',0.05, 12.813, 0.04,generic_pars)
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
            <section id="spiral-arm-spectral-fit">
             <h4>
              Spiral arm spectral fit
              <a class="headerlink" href="#spiral-arm-spectral-fit" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>#Spiral arm spectrum
spec=arm_spec
specerr=arm_err

#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)
model = p_law + drudes + gaussAt + gaussH2

#Adjust power law starting parameters 
setpar(generic_pars,'pwl_c1',0.01,True,None)
setpar(generic_pars,'pwl_c2',0.001,True,None)

#Model Results
arm_result = model.fit(spec, generic_pars, weights=1./specerr, x=x)
arm_model = arm_result.best_fit 
arm_residual = spec - arm_model
arm_modelcomps,arm_modlabels=model_comps(arm_result)

#Plot
#plot_fit(x, spec, specerr, arm_result)
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              Model fit to integrated spectrum of spiral arm region.
             </p>
            </section>
            <section id="h2-strongest-region-spectral-fit">
             <h4>
              H2-strongest region spectral fit
              <a class="headerlink" href="#h2-strongest-region-spectral-fit" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>#H2 region spectrum
spec=h2s_spec
specerr=h2s_err

#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)
model = p_law + drudes + gaussAt + gaussH2

#Adjust power law starting parameters 
setpar(generic_pars,'pwl_c1',0.002,True,None)
setpar(generic_pars,'pwl_c2',0.0015,True,None)

#Model Results
h2s_result = model.fit(spec, generic_pars, weights=1./specerr, x=x)
h2s_model = h2s_result.best_fit 
h2s_residual = spec - h2s_model
h2s_modelcomps,h2s_modlabels=model_comps(h2s_result)

#Plot
#plot_fit(x, spec, specerr, h2s_result)
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              Model fit to integrated spectrum of H2-strongest region.
             </p>
            </section>
            <section id="nucleus-spectral-fit">
             <h4>
              Nucleus spectral fit
              <a class="headerlink" href="#nucleus-spectral-fit" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>#Nucleus spectrum
spec=nuc_spec
specerr=nuc_err

#Model (powerlaw + AGN silicate emission + individual PAHs + H2 and Atomic lines, no extinction)
model = p_law + silicate + drudes + gaussH2 + gaussAt

#Adjust power law and silicate dust starting parameters
setpar(generic_pars,'pwl_c1',0.005,True,None)
setpar(generic_pars,'pwl_c2',0.01,True,None)
sidust_defpar('sidust1', 190.,2.E-4,generic_pars)

#Model Results
nuc_result = model.fit(spec, generic_pars, weights=1./specerr, x=x)
nuc_model = nuc_result.best_fit 
nuc_residual = spec - nuc_model
nuc_modelcomps,nuc_modlabels=model_comps(nuc_result)

#Plot
plot_fit(x, spec, specerr, nuc_result)
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              Model fit to nucleus, including fixed-temperature AGN silicate emission.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>nuc_result
#result.fit_report(show_correl=False)
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              Fit parameters for spectrum of nucleus
             </p>
            </section>
           </section>
          </section>
          <section id="summary-plot">
           <h2>
            Summary Plot
            <a class="headerlink" href="#summary-plot" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>f,((ax1,ax2,ax3),(ax4,ax5,ax6))=plt.subplots(2,3,figsize=(15,10))

ax1.set_title('Spiral Arm')
ax1.set_ylabel('Flux (Jy)')
ax1.errorbar(x,arm_spec,yerr=arm_err, c='gold')
mod_colors=['brown','g','b','magenta','orange']
for mcomp,mlabl,mcolr in zip(arm_modelcomps,arm_modlabels,mod_colors):
    ax1.plot(x,mcomp,label=mlabl,c=mcolr)

ax2.set_title('Nucleus')
ax2.errorbar(x,nuc_spec,yerr=nuc_err, c='navy')
#ax2.plot(x, fit_model,label='Model',c='red')
for mcomp,mlabl,mcolr in zip(nuc_modelcomps,nuc_modlabels,mod_colors):
    ax2.plot(x,mcomp,label=mlabl,c=mcolr)

ax3.set_title('Inner Disk')
ax3.errorbar(x,pah_spec,yerr=pah_err, c='limegreen')

ax4.set_title('H2')
ax4.set_xlabel(r"Wavelength $(\mu m)$")
ax4.set_ylabel('Flux (Jy)')
ax4.errorbar(x,h2_spec,yerr=h2_err, c='steelblue')

ax5.set_title('All regions')
ax5.set_xlabel('Pixel')
ax5.imshow(m58_mask,origin='lower')

ax6.set_title('H2-Strongest')
ax6.set_xlabel(r"Wavelength $(\mu m)$")
ax6.errorbar(x,h2s_spec,yerr=h2s_err,c='teal')
for mcomp,mlabl,mcolr in zip(h2s_modelcomps,arm_modlabels,mod_colors):
    ax6.plot(x,mcomp,label=mlabl,c=mcolr)

plt.show()
</pre>
              </div>
             </div>
            </div>
           </div>
           <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="float: right;" width="200px"/>
           <p>
            Notebook created by Patrick Ogle and Ivan Lopez.
           </p>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/cube_fitting"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            Specviz Simple Demo
           </p>
          </div>
         </a>
         <a class="right-next" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            MRS Pipeline
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>