

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Spectral Cube Modeling &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/cube_fitting/cube_fitting';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="NIRSpec IFU Optimal Point Source Extraction" href="../ifu_optimal/ifu_optimal.html" />
    <link rel="prev" title="IFU Cube Fitting" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">MRS Mstar - Run Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">MRS Detector Based Extraction</a></li>




<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../niriss_imaging/niriss-imaging-tutorial.html">NIRISS Imaging Tutorial</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/cube_fitting/cube_fitting.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/cube_fitting/cube_fitting.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Spectral Cube Modeling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#definitions-of-functions">Definitions of functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scrolling">Scrolling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-functions">Model Functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameters">Model Parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#line-flux-from-model-parameters">Line Flux from Model Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">Extract and plot 1D spectrum and model components</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-data">Input data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameter-starting-values">Model Parameter Starting Values</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-representative-spaxel">Fit a Representative Spaxel</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-entire-cube">Fit the Entire Cube</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">Total flux and Reduced Chi^2 Maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">Line and PAH feature flux maps.</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">Functions to extract line and PAH maps from model parameter cube</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">Extract and model cube sub-regions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-spectral-region-masks">Make spectral region masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">Extract spectra from mask regions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-spectra-to-files">Save spectra to files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-spectra-of-regions">Fit spectra of regions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generic-model-components">Generic model components</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spiral-arm-spectral-fit">Spiral arm spectral fit</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">H2-strongest region spectral fit</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nucleus-spectral-fit">Nucleus spectral fit</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-plot">Summary Plot</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="spectral-cube-modeling">
<h1>Spectral Cube Modeling<a class="headerlink" href="#spectral-cube-modeling" title="Permalink to this heading">#</a></h1>
<p><strong>Use case:</strong> Extracting spatial-spectral features of interest from the cube of data and measuring their
attributes.  Create line and PAH maps from the model parameters map.<br>
<strong>Data:</strong> SL1 and SL2 spectral cubes generated using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby galaxy Messier 58.<br>
<strong>Tools:</strong> astropy, specutils, dust-extinction, matplotlib.<br>
<strong>Cross-intrument:</strong> NIRSpec, MIRI.<br>
<strong>Documentation:</strong> This notebook is part of a STScIâ€™s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>Analysis of JWST spectral cubes requires extracting spatial-spectral features of interest and measuring their
attributes. Here, we demonstrate 1-D spectral modeling applied to an individual spaxel, 900 spaxels in a cube, and spectra summed over spatial regions. Analysis of large JWST spectral data cubes can be computationally expensive, depending on number of spaxels modeled and number of free model parameters. This task can be made manageable by focusing on spatial sub-regions of interest or by minimizing model complexity.  Sub-regions in the cube are selected by location and line ratios. The spaxels in these regions are then summed and modeled with a combination of continuum, emission line, polycyclic aromatic hydrocarbon (PAH), and silicate dust features. Best-fitting model spectra are fit using the lmfit package, utilizing a Levenberg-Marquardt least-squares method.</p>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><em>time</em> for timing</p></li>
<li><p><em>multiprocessing.Pool</em> for parallel processing on cube spaxels</p></li>
<li><p><em>pickle</em> for pickling and unpickling IO to multiprocessing pools</p></li>
<li><p><em>numpy</em> for array processing and math</p></li>
<li><p><em>matplotlib.pyplot</em> for plotting images and spectra</p></li>
<li><p><em>astropy.io</em> for reading and writing FITS cubes and images</p></li>
<li><p><em>astropy.visualization</em> to construct RGB images</p></li>
<li><p><em>lmfit</em> Levenberg-Marquart fitting package for model-fitting</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocess</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">multiprocess</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">loadtxt</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">interp</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> 
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">make_lupton_rgb</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>

<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Minimizer</span><span class="p">,</span> <span class="n">Parameters</span>
<span class="kn">from</span> <span class="nn">lmfit.model</span> <span class="kn">import</span> <span class="n">save_modelresult</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="definitions-of-functions">
<h2>Definitions of functions<a class="headerlink" href="#definitions-of-functions" title="Permalink to this heading">#</a></h2>
<section id="scrolling">
<h3>Scrolling<a class="headerlink" href="#scrolling" title="Permalink to this heading">#</a></h3>
<p>Limit scrolling in cell output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%javascript</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">OutputArea</span><span class="p">.</span><span class="nx">auto_scroll_threshold</span><span class="o">=</span><span class="mf">70</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">IPython.OutputArea.auto_scroll_threshold=70;
</script></div>
</div>
</section>
<section id="model-functions">
<h3>Model Functions<a class="headerlink" href="#model-functions" title="Permalink to this heading">#</a></h3>
<p>A variety of emission line, continuum and extinction models for spectral fitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Modelcero</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple model of 0 to initialize some models&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">*</span><span class="n">x</span>

<span class="c1">#powerlaw, zblackbody, gaussian and drude functions wrap existing astropy models.</span>
<span class="c1">#lmfit requires wavelength (x) to be passed as function parameter.</span>

<span class="k">def</span> <span class="nf">powerlaw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;power law function (c1*nu^c2) normalized at 1 micron, with positive index convention&quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="o">=</span><span class="mf">1.0</span>  <span class="c1">#Normalize at  1 micron</span>
    <span class="n">c2</span><span class="o">=-</span><span class="n">c2</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">PowerLaw1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">c2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">zblackbody</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;black body function&quot;&quot;&quot;</span>
    <span class="n">xs</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="o">/</span><span class="n">OnePlusZ</span>
    <span class="n">bb</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">BlackBody</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bb</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d gaussian&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="n">xcen</span><span class="p">,</span><span class="n">std</span><span class="p">)</span>   

<span class="k">def</span> <span class="nf">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dust emission&quot;&quot;&quot;</span>
    <span class="n">FWHM</span><span class="o">=</span><span class="n">peakx</span><span class="o">*</span><span class="n">frac_FWHM</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Drude1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="n">peakx</span><span class="p">,</span><span class="n">FWHM</span><span class="p">)</span>

<span class="c1">#pahdust and sidust functions do not exist in astropy</span>

<span class="k">def</span> <span class="nf">pahdust</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">amplitude_76</span><span class="p">,</span> <span class="n">amplitude_113</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PAH dust emission&quot;&quot;&quot;</span>
    
    <span class="c1">#Ionized PAH features</span>
    <span class="n">PAH_peakx</span><span class="o">=</span>     <span class="p">[</span> <span class="mf">5.27</span><span class="p">,</span> <span class="mf">5.70</span><span class="p">,</span> <span class="mf">6.22</span><span class="p">,</span> <span class="mf">6.69</span><span class="p">,</span> <span class="mf">7.42</span><span class="p">,</span> <span class="mf">7.60</span><span class="p">,</span> <span class="mf">7.85</span><span class="p">,</span> <span class="mf">8.33</span><span class="p">,</span> <span class="mf">8.61</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.034</span><span class="p">,</span><span class="mf">0.035</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.126</span><span class="p">,</span><span class="mf">0.044</span><span class="p">,</span><span class="mf">0.053</span><span class="p">,</span><span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">]</span>
    <span class="n">PAH_rel_amplitude</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.8</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span>  <span class="mf">0.6</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">PAH_amplitude</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="n">PAH_rel_amplitude</span><span class="p">:</span> <span class="n">PAH_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_76</span><span class="o">*</span><span class="p">(</span><span class="n">ampl</span><span class="o">/</span><span class="n">PAH_rel_amplitude</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
 
    <span class="c1">#Neutral PAH features</span>
    <span class="n">PAH_peakx</span><span class="o">+=</span>    <span class="p">[</span><span class="mf">10.68</span><span class="p">,</span> <span class="mf">11.23</span><span class="p">,</span><span class="mf">11.33</span><span class="p">]</span>
    <span class="n">PAH_peakx</span><span class="o">+=</span>    <span class="p">[</span><span class="mf">11.99</span><span class="p">,</span><span class="mf">12.62</span><span class="p">,</span><span class="mf">12.69</span><span class="p">,</span><span class="mf">13.48</span><span class="p">,</span><span class="mf">14.04</span><span class="p">,</span><span class="mf">14.19</span><span class="p">,</span><span class="mf">15.90</span><span class="p">,</span> <span class="mf">16.45</span><span class="p">,</span><span class="mf">17.04</span><span class="p">,</span><span class="mf">17.375</span><span class="p">,</span><span class="mf">17.87</span><span class="p">,</span><span class="mf">18.92</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.020</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span><span class="mf">0.022</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.045</span><span class="p">,</span><span class="mf">0.042</span><span class="p">,</span> <span class="mf">0.013</span><span class="p">,</span><span class="mf">0.040</span><span class="p">,</span><span class="mf">0.016</span><span class="p">,</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.020</span><span class="p">,</span><span class="mf">0.014</span><span class="p">,</span><span class="mf">0.065</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.016</span><span class="p">,</span><span class="mf">0.019</span><span class="p">]</span>   
    <span class="n">PAH_rel_amplitude</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">PAH_rel_amplitude</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">,</span>   <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="n">PAH_rel_amplitude</span><span class="p">:</span> <span class="n">PAH_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_113</span><span class="o">*</span><span class="p">(</span><span class="n">ampl</span><span class="o">/</span><span class="n">PAH_rel_amplitude</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="n">pahflux</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">,</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PAH_peakx</span><span class="p">,</span><span class="n">PAH_frac_FWHM</span><span class="p">,</span><span class="n">PAH_amplitude</span><span class="p">):</span>
        <span class="n">pahflux</span><span class="o">=</span><span class="n">pahflux</span><span class="o">+</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ampl</span><span class="p">,</span><span class="n">peakx</span><span class="o">*</span><span class="n">OnePlusZ</span><span class="p">,</span><span class="n">frac_FWHM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pahflux</span>    <span class="c1">#Amplitude unit</span>

<span class="k">def</span> <span class="nf">sidust</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Silicate dust emission&quot;&quot;&quot;</span>
    
    <span class="c1">#Custom extinction curve built from weighted sum of three components: </span>
    <span class="c1">#two Drude functions and an exponent 1.7 power-law.</span>
    <span class="n">d1</span><span class="o">=</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.80</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">d2</span><span class="o">=</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">11.1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="c1">#d3=drude(x,0.40,17.0,0.40)  #Outside of wavelength range.</span>
    <span class="n">ext</span><span class="o">=</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span>  <span class="c1">#+d3</span>

    <span class="c1"># Form linear combination of modified silicate and powerlaw.</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">ext</span> <span class="o">+</span> <span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="mf">9.7</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mf">1.7</span>
    <span class="n">si_em</span><span class="o">=</span><span class="n">amplitude</span><span class="o">*</span><span class="mf">1.0E-6</span><span class="o">*</span><span class="mf">3.97289E13</span><span class="o">/</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.4387752E4</span><span class="o">/</span><span class="n">x</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">ext</span>
    
    <span class="k">return</span> <span class="n">si_em</span>

<span class="c1"># Enable tabulated extinction functions. Existing options in dust_extinction are insufficient</span>
<span class="c1"># at mid-IR wavelengths</span>

<span class="k">def</span> <span class="nf">extinction_a</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extinction from table data&quot;&quot;&quot;</span>
    <span class="n">ext</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>      
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>

<span class="c1">#Read extinction data from Chiar &amp; Tielens (2005)</span>
<span class="c1">#Note, this is normalized to extinction in the K-band (1.004 at 2.14 um)</span>
<span class="c1">#agal is for Galactic Center, alocal is for local ISM extinction</span>

<span class="n">Boxdata</span><span class="o">=</span><span class="s2">&quot;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/&quot;</span>
<span class="n">wave</span><span class="p">,</span> <span class="n">agal</span><span class="p">,</span> <span class="n">alocal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">Boxdata</span><span class="o">+</span><span class="s1">&#39;chiar+tielens_2005.dat&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Compare to dust_extinction</span>
<span class="c1">#P92 is the only model that extends over the mid-IR range, but it is crude</span>
<span class="c1">#Normalized to extinction in the V-band</span>

<span class="kn">from</span> <span class="nn">dust_extinction.parameter_averages</span> <span class="kn">import</span> <span class="n">F99</span>
<span class="kn">from</span> <span class="nn">dust_extinction.shapes</span> <span class="kn">import</span> <span class="n">P92</span>
<span class="n">a92</span> <span class="o">=</span> <span class="n">P92</span><span class="p">()</span>

<span class="c1">#Extinction Comparison</span>
<span class="n">tau</span><span class="o">=</span><span class="mf">1.</span>
<span class="n">xa</span><span class="o">=</span><span class="n">arange</span><span class="p">(</span><span class="mf">5.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">extin1</span><span class="o">=</span><span class="n">extinction_a</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">alocal</span><span class="p">)</span>
<span class="n">extin2</span><span class="o">=</span><span class="n">extinction_a</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">agal</span><span class="p">)</span>
<span class="n">lam</span><span class="o">=</span><span class="n">xa</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span>
<span class="n">scale</span><span class="o">=</span><span class="mf">21.9</span>             <span class="c1">#Empirical scaling to adjust P2 curve to match Chiar &amp; Tielens Local ISM curve</span>
<span class="n">aa92</span><span class="o">=</span><span class="n">scale</span><span class="o">*</span><span class="n">a92</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
<span class="n">extin3</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="n">aa92</span><span class="p">)</span>

<span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;CT+05 Local ISM&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;CT+05 Gal. Cen.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;P92 scaled&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">pl1</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4d53835931bf49df5ba8577dc57c4a59f0ab7d934be56439bdeb6f2eebb879dc.png" src="../../_images/4d53835931bf49df5ba8577dc57c4a59f0ab7d934be56439bdeb6f2eebb879dc.png" />
</div>
</div>
</section>
</section>
<section id="model-parameters">
<h2>Model Parameters<a class="headerlink" href="#model-parameters" title="Permalink to this heading">#</a></h2>
<p>Declare the parameters of model functions. Parameters are frozen by setting vary=â€™Falseâ€™
in the lmfit setpar command.  For now we are just fitting amplitudes of emission features.
Fits with more variable parameters take longer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">vary</span><span class="p">,</span> <span class="n">minus</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set any parameter&quot;&quot;&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">vary</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">minus</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">gaussian_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;set the parameters for a gaussian&quot;&quot;&quot;</span>
    <span class="n">std</span><span class="o">=</span><span class="n">stddev</span>
    <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">xcen</span><span class="o">=</span><span class="n">mean</span><span class="o">*</span><span class="n">OneZ</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_std&#39;</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1">#setpar(pars,name+&#39;_std&#39;,std,True,0)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_xcen&#39;</span><span class="p">,</span><span class="n">xcen</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude&#39;</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="c1">#pars[name+&#39;_std&#39;].set(std,vary=False),pars[name+&#39;_xcen&#39;].set(xcen,vary=False),pars[name+&#39;_amplitude&#39;].set(amplitude)</span>

<span class="k">def</span> <span class="nf">drude_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;set the parameters for a drude&quot;&quot;&quot;</span>
    <span class="n">peakx</span><span class="o">=</span><span class="n">peakx</span><span class="o">*</span><span class="n">OneZ</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_frac_FWHM&#39;</span><span class="p">,</span><span class="n">frac_FWHM</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1">#setpar(pars,name+&#39;_frac_FWHM&#39;,frac_FWHM,True,0)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_peakx&#39;</span><span class="p">,</span><span class="n">peakx</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude&#39;</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>    
    <span class="k">return</span> <span class="c1">#pars[name+&#39;_frac_FWHM&#39;].set(frac_FWHM,vary=False),pars[name+&#39;_peakx&#39;].set(peakx,vary=False),pars[name+&#39;_amplitude&#39;].set(amplitude)</span>

<span class="k">def</span> <span class="nf">pahdust_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">amplitude_76</span><span class="p">,</span> <span class="n">amplitude_113</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;set the parameters for pdr dust&quot;&quot;&quot;</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude_76&#39;</span><span class="p">,</span><span class="n">amplitude_76</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude_113&#39;</span><span class="p">,</span><span class="n">amplitude_113</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_OnePlusZ&#39;</span><span class="p">,</span><span class="n">OnePlusZ</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="c1">#pars[name+&#39;_frac_FWHM&#39;].set(frac_FWHM,vary=False),pars[name+&#39;_peakx&#39;].set(peakx,vary=False),pars[name+&#39;_amplitude&#39;].set(amplitude)</span>

<span class="k">def</span> <span class="nf">sidust_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude&#39;</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_T&#39;</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">gaussian_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;extract the parameters for a gaussian&quot;&quot;&quot;</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">cen</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;xcen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">amp</span><span class="p">,</span> <span class="n">cen</span><span class="p">,</span> <span class="n">std</span>

<span class="k">def</span> <span class="nf">drude_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;extract the parameters for a drude&quot;&quot;&quot;</span>
    <span class="n">ampl</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;peakx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>         
    <span class="n">frac</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;frac_FWHM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">ampl</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">frac</span>

<span class="k">def</span> <span class="nf">pahdust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;extract the parameters for pahdust model&quot;&quot;&quot;</span>
    <span class="n">ampl_76</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude_76&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ampl_113</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude_113&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">ampl_76</span><span class="p">,</span> <span class="n">ampl_113</span>  

<span class="k">def</span> <span class="nf">sidust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;extract the parameters for pahdust model&quot;&quot;&quot;</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ampl</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">T</span><span class="p">,</span><span class="n">ampl</span> 
</pre></div>
</div>
</div>
</div>
<section id="line-flux-from-model-parameters">
<h3>Line Flux from Model Parameters<a class="headerlink" href="#line-flux-from-model-parameters" title="Permalink to this heading">#</a></h3>
<p>Helper functions to calculate the fluxes and widths of emission features from model parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#NOTE that these are ANALYTIC estimates of line fluxes,</span>
<span class="c1">#NOT available in astropy modeling or specutils</span>

<span class="k">def</span> <span class="nf">gaussianline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">cen</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;calculate the integrated flux for a gaussian line&quot;&quot;&quot;</span>
    <span class="c1">#Units= amp:Jy cen:microns</span>
    <span class="n">c</span><span class="o">=</span> <span class="mf">29979.2458</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">10</span> <span class="c1">#c in microns/s</span>
    <span class="n">gaussianfactor</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amp</span><span class="o">*</span><span class="n">gaussianfactor</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="n">std</span><span class="o">/</span><span class="p">(</span><span class="n">cen</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span>      <span class="c1">#erg s^{-1} cm^{-2}</span>

<span class="k">def</span> <span class="nf">drudeline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">frac</span><span class="p">,</span><span class="n">peak</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;calculate the integrate flux for a drude line&quot;&quot;&quot;</span>
    <span class="c1">#Units= amp:Jy peak:microns</span>
    <span class="n">c</span><span class="o">=</span> <span class="mf">29979.2458</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">10</span> <span class="c1">#c in microns/s</span>
    <span class="n">drudefactor</span><span class="o">=</span><span class="n">pi</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">amp</span><span class="o">*</span><span class="n">frac</span><span class="o">*</span><span class="n">drudefactor</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">peak</span><span class="p">)))</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span>   <span class="c1">#erg s^{-1} cm^{-2}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-and-plot-1d-spectrum-and-model-components">
<h3>Extract and plot 1D spectrum and model components<a class="headerlink" href="#extract-and-plot-1d-spectrum-and-model-components" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;extract spec and errors from a,b coordinates&quot;&quot;&quot;</span>
    <span class="n">spec_pix</span><span class="o">=</span><span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
    <span class="n">err_pix</span><span class="o">=</span><span class="n">error_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spec_pix</span><span class="p">,</span> <span class="n">err_pix</span>

<span class="k">def</span> <span class="nf">model_comps</span><span class="p">(</span><span class="n">model_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate model components&quot;&quot;&quot;</span>
    <span class="n">comps</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">eval_components</span><span class="p">()</span>
    <span class="n">plcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">h2comp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">pahcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sidustcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1">#print(comps.keys())</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">comps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
        <span class="n">keyl</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;pwl&#39;</span><span class="p">:</span> <span class="n">plcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">h2comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;pah&#39;</span><span class="p">:</span> <span class="n">pahcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;sid&#39;</span><span class="p">:</span> <span class="n">sidustcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
       
    <span class="n">plaw_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">h2_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">ion_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">pah_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">sidust_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">plcomp</span><span class="p">:</span> <span class="n">plaw_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">h2comp</span><span class="p">:</span> <span class="n">h2_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">pahcomp</span><span class="p">:</span> <span class="n">pah_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">sidustcomp</span><span class="p">:</span> <span class="n">sidust_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="s1">&#39;NeII&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
        <span class="n">ion_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">]</span>
        
    <span class="k">return</span><span class="p">([</span><span class="n">plaw_model</span><span class="p">,</span><span class="n">h2_model</span><span class="p">,</span><span class="n">ion_model</span><span class="p">,</span><span class="n">pah_model</span><span class="p">,</span><span class="n">sidust_model</span><span class="p">],[</span><span class="s1">&#39;PL&#39;</span><span class="p">,</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span><span class="s1">&#39;Ions&#39;</span><span class="p">,</span><span class="s1">&#39;PAHs&#39;</span><span class="p">,</span><span class="s1">&#39;Si Dust&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">model_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;plot spectrum, model components, and residual&quot;&quot;&quot;</span>

    <span class="c1">#Model Results</span>
    <span class="n">fit_model</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">best_fit</span> 
    <span class="n">fit_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">fit_model</span>

    <span class="c1">#Evaluate model components</span>
    <span class="n">mod_comps</span><span class="p">,</span><span class="n">mod_labels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">model_result</span><span class="p">)</span>
        
    <span class="c1">#Spec-1D object</span>
    <span class="n">spec1</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">x</span><span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">spec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">specerr</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>    
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  
        <span class="c1">#ax.step, ax.plot, ax.scatter all work, but ax.scatter doesn&#39;t autscale correctly</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="c1">#ax.set_xlabel(r&quot;$Wavelength\ (\mu m)$&quot;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="c1">#plt.errorbar only works on unitless data</span>
        <span class="c1">#ax.errorbar(spec1.spectral_axis, spec1.flux, yerr=specerr,label=&#39;Data&#39;, color=&#39;k&#39;)</span>
        <span class="c1">#ax.plot(spec1.spectral_axis, spec1.flux, yerr=specerr,label=&#39;Data&#39;, color=&#39;k&#39;)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>   

    <span class="c1">#Plot results</span>
    <span class="n">fig1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span> <span class="mi">150</span><span class="p">)</span>
    
    <span class="n">frame1</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.3</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.6</span><span class="p">))</span>
    <span class="n">frame1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Flux\ (Jy)$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">specerr</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit_model</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">mod_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="s1">&#39;orange&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">mlabel</span><span class="p">,</span> <span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mod_comps</span><span class="p">,</span><span class="n">mod_labels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mlabel</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>        
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">frame2</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Wavelength\ (\mu m)$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fit_residual</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">specerr</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>     
    <span class="k">return</span> 
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="input-data">
<h2>Input data<a class="headerlink" href="#input-data" title="Permalink to this heading">#</a></h2>
<p>With the present lack of JWST flight data, we utilize the SL1 and SL2 spectral cubes generated
using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby
galaxy Messier 58. This galaxy has a radio-loud Seyfert nucleus that is exciting strong
H2 emission via shocks.  There is also significant star-formation, revealed by PAH emission
features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Spitzer IRS (CUBISM) cube loader does not exist in specutils</span>

<span class="c1">#Target </span>
<span class="n">targname</span><span class="o">=</span><span class="s1">&#39;M58&#39;</span>

<span class="c1">#Redshift</span>
<span class="n">z</span><span class="o">=</span><span class="mf">0.005060</span>
<span class="n">OneZ</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span>

<span class="c1">#Download and open the data cubes and their uncertainties</span>
<span class="n">BoxPath</span><span class="o">=</span><span class="s2">&quot;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/&quot;</span>
<span class="n">cubeSL1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL1_cube.fits&#39;</span><span class="p">)</span> 
<span class="n">errorsSL1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL1_cube_unc.fits&#39;</span><span class="p">)</span>
<span class="n">cubeSL2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL2_cube.fits&#39;</span><span class="p">)</span> 
<span class="n">errorsSL2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL2_cube_unc.fits&#39;</span><span class="p">)</span>

<span class="c1">#Cube Info and Headers</span>
<span class="n">cubeSL1</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">cubeSL2</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">hdr1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>                        
<span class="n">er_hdr1</span><span class="o">=</span><span class="n">errorsSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">hdr2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>                               
<span class="n">er_hdr2</span><span class="o">=</span><span class="n">errorsSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="c1">#print(repr(hdr1))</span>

<span class="c1">#Flux Data</span>
<span class="n">data_cube1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">error_cube1</span> <span class="o">=</span> <span class="n">errorsSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">data_cube2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">error_cube2</span> <span class="o">=</span> <span class="n">errorsSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1">#Wavelength Data</span>
<span class="n">xwave1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">xwave1</span> <span class="o">=</span> <span class="n">xwave1</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xwave2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">xwave2</span> <span class="o">=</span> <span class="n">xwave2</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xwave2</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xwave1</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1">#Change the units from MJy/sr to Jy/pix</span>
<span class="n">correct_unit1</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">0.0003046118</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>    
<span class="n">data_cube1</span><span class="o">=</span><span class="n">data_cube1</span><span class="o">*</span><span class="n">correct_unit1</span>
<span class="n">error_cube1</span><span class="o">=</span><span class="n">error_cube1</span><span class="o">*</span><span class="n">correct_unit1</span>
<span class="n">correct_unit2</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr2</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr2</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">0.0003046118</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>    
<span class="n">data_cube2</span><span class="o">=</span><span class="n">data_cube2</span><span class="o">*</span><span class="n">correct_unit2</span>
<span class="n">error_cube2</span><span class="o">=</span><span class="n">error_cube2</span><span class="o">*</span><span class="n">correct_unit2</span>

<span class="c1">#Concatenate SL1 and SL2</span>
<span class="n">data_cube</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_cube2</span><span class="p">,</span><span class="n">data_cube1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">error_cube</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">error_cube2</span><span class="p">,</span><span class="n">error_cube1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Reorder x and data_cube</span>
<span class="n">xcor</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
<span class="n">data_cube</span> <span class="o">=</span> <span class="n">data_cube</span><span class="p">[</span><span class="n">xcor</span><span class="p">]</span>
<span class="n">error_cube</span> <span class="o">=</span> <span class="n">error_cube</span><span class="p">[</span><span class="n">xcor</span><span class="p">]</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1">#Cube dimensions and trimming </span>
<span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>
<span class="n">ytrim</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ysize</span><span class="o">=</span><span class="n">ysize</span><span class="o">-</span><span class="n">ytrim</span>
<span class="n">ztrim</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">zsize</span><span class="o">=</span><span class="n">zsize</span><span class="o">-</span><span class="n">ztrim</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trimmed cube dimensions:&#39;</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">)</span>

<span class="c1">#Collapsed 2D image</span>
<span class="n">cube_2dflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">ysize</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">zsize</span><span class="p">]</span>

<span class="c1">#Collapsed 1D spectrum</span>
<span class="n">cube_1dflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ysize</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zsize</span><span class="p">):</span>
        <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="n">cube_1dflux</span><span class="o">=</span><span class="n">cube_1dflux</span><span class="o">+</span><span class="n">spec_pix</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log Flux (Sum over Wavelength)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_2dflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flux (Sum over Spaxels)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">cube_1dflux</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filename: /home/runner/.astropy/cache/download/url/06853bf85036af1a6d55c1fb3a08260f/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 117)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [117E]   
Filename: /home/runner/.astropy/cache/download/url/bec801dcb9ee22f478e4a56b91820bd4/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 77)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [77E]   
Trimmed cube dimensions: 194 30 32
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2096/4105009505.py:39: DeprecationWarning: Conversion of an array with ndim &gt; 0 to a scalar is deprecated, and will error in future. Ensure you extract a single element from your array before performing this operation. (Deprecated NumPy 1.25.)
  x.append(float(line))
/tmp/ipykernel_2096/4105009505.py:41: DeprecationWarning: Conversion of an array with ndim &gt; 0 to a scalar is deprecated, and will error in future. Ensure you extract a single element from your array before performing this operation. (Deprecated NumPy 1.25.)
  x.append(float(line))
</pre></div>
</div>
<img alt="../../_images/42129ab91ef9d911cef7eb6ddaae58bda6fe5e274caeddd4bb28494897f50d20.png" src="../../_images/42129ab91ef9d911cef7eb6ddaae58bda6fe5e274caeddd4bb28494897f50d20.png" />
</div>
</div>
</section>
<section id="model-parameter-starting-values">
<h2>Model Parameter Starting Values<a class="headerlink" href="#model-parameter-starting-values" title="Permalink to this heading">#</a></h2>
<p>Set starting parameters for spectral model components. Use a PAH dust model with only two free parameters (7.6 and 11.3 micron PAH flux).  The rest of the PAH ratios are fixed by this â€˜pahdustâ€™ model, so that fitting the whole cube does not take so long.   Later, we will fit summed region spectra with all PAH amplitudes free.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Power Law</span>
<span class="n">p_law</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">powerlaw</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;pwl_&#39;</span><span class="p">)</span>
<span class="n">generic_pars</span> <span class="o">=</span> <span class="n">p_law</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>      
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.0002</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#PAH dust model with fixed PAH feature ratios</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;pahdust1_&#39;</span>
<span class="n">pahs</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">pahdust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pahs</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">pahdust_defpar</span><span class="p">(</span><span class="s1">&#39;pahdust1&#39;</span><span class="p">,</span><span class="mf">1.00506</span><span class="p">,</span><span class="mf">0.003</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Silicate dust emission</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sidust1_&#39;</span>
<span class="n">silicate</span><span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">sidust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">silicate</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">1.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Gaussians with wavelengths from Smith et al 2007</span>
<span class="c1">#H2 pure-rotational lines</span>
<span class="n">h2lines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;55&#39;</span><span class="p">,</span><span class="s1">&#39;61&#39;</span><span class="p">,</span><span class="s1">&#39;69&#39;</span><span class="p">,</span><span class="s1">&#39;80&#39;</span><span class="p">,</span><span class="s1">&#39;96&#39;</span><span class="p">,</span><span class="s1">&#39;122&#39;</span><span class="p">]</span>
<span class="n">h2wavel</span><span class="o">=</span><span class="p">[</span><span class="mf">5.511</span><span class="p">,</span><span class="mf">6.109</span><span class="p">,</span><span class="mf">6.909</span><span class="p">,</span><span class="mf">8.026</span><span class="p">,</span><span class="mf">9.665</span><span class="p">,</span><span class="mf">12.278</span><span class="p">]</span>
<span class="n">amp_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">std_guess</span><span class="o">=</span><span class="mf">0.04</span>
<span class="n">gaussH2</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">h2lines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussH2</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussH2</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="k">for</span> <span class="n">h2lin</span><span class="p">,</span> <span class="n">h2w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h2lines</span><span class="p">,</span><span class="n">h2wavel</span><span class="p">):</span>
    <span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="o">+</span><span class="n">h2lin</span><span class="p">,</span> <span class="n">amp_guess</span><span class="p">,</span> <span class="n">h2w</span><span class="p">,</span> <span class="n">std_guess</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Atomic lines</span>
<span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="s1">&#39;NeII&#39;</span><span class="p">]</span>
<span class="n">atomicwavel</span><span class="o">=</span><span class="p">[</span><span class="mf">6.985</span><span class="p">,</span><span class="mf">10.511</span><span class="p">,</span><span class="mf">12.813</span><span class="p">]</span>
<span class="n">amp_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">std_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">gaussAt</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussAt</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussAt</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="k">for</span> <span class="n">atlin</span><span class="p">,</span> <span class="n">atw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atomiclines</span><span class="p">,</span><span class="n">atomicwavel</span><span class="p">):</span>
    <span class="n">gaussian_defpar</span><span class="p">(</span><span class="n">atlin</span><span class="p">,</span><span class="n">amp_guess</span><span class="p">,</span> <span class="n">atw</span><span class="p">,</span> <span class="n">std_guess</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-a-representative-spaxel">
<h2>Fit a Representative Spaxel<a class="headerlink" href="#fit-a-representative-spaxel" title="Permalink to this heading">#</a></h2>
<p>Fit a single spaxel in the cube and use the fit parameters to adjust the generic model starting parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Select spaxel</span>
<span class="n">spec</span><span class="o">=</span><span class="n">data_cube</span><span class="p">[:,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">error_cube</span><span class="p">[:,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span>

<span class="c1">#Composite model (powerlaw + PAHs + H2 + Atomic lines, no extinction)</span>
<span class="n">generic_mod</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">silicate</span> <span class="o">+</span> <span class="n">pahs</span> <span class="o">+</span> <span class="n">gaussH2</span>  <span class="o">+</span> <span class="n">gaussAt</span>

<span class="nb">print</span><span class="p">(</span><span class="n">generic_mod</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>

<span class="c1">#Fit and plot</span>
<span class="n">spax_result</span> <span class="o">=</span> <span class="n">generic_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">spax_result</span><span class="p">)</span>

<span class="c1">#Save results</span>
<span class="n">save_modelresult</span><span class="p">(</span><span class="n">spax_result</span><span class="p">,</span> <span class="s1">&#39;OnePointResult.sav&#39;</span><span class="p">)</span>

<span class="c1">#Update generic model starting parameters</span>
<span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
    <span class="n">value</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">vary</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span>
    <span class="n">minus</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">min</span>
    <span class="k">if</span> <span class="n">minus</span><span class="o">==</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">):</span>
        <span class="n">minus</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">generic_pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">vary</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">minus</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;pwl_c1&#39;, &#39;pwl_c2&#39;, &#39;sidust1_T&#39;, &#39;sidust1_amplitude&#39;, &#39;pahdust1_OnePlusZ&#39;, &#39;pahdust1_amplitude_76&#39;, &#39;pahdust1_amplitude_113&#39;, &#39;h55_amplitude&#39;, &#39;h55_xcen&#39;, &#39;h55_std&#39;, &#39;h61_amplitude&#39;, &#39;h61_xcen&#39;, &#39;h61_std&#39;, &#39;h69_amplitude&#39;, &#39;h69_xcen&#39;, &#39;h69_std&#39;, &#39;h80_amplitude&#39;, &#39;h80_xcen&#39;, &#39;h80_std&#39;, &#39;h96_amplitude&#39;, &#39;h96_xcen&#39;, &#39;h96_std&#39;, &#39;h122_amplitude&#39;, &#39;h122_xcen&#39;, &#39;h122_std&#39;, &#39;ArII_amplitude&#39;, &#39;ArII_xcen&#39;, &#39;ArII_std&#39;, &#39;SIV_amplitude&#39;, &#39;SIV_xcen&#39;, &#39;SIV_std&#39;, &#39;NeII_amplitude&#39;, &#39;NeII_xcen&#39;, &#39;NeII_std&#39;]
</pre></div>
</div>
<img alt="../../_images/87899aef14759b9110c2ed14f39aeadbf4320746729a4252f9b9451dc94fad1c.png" src="../../_images/87899aef14759b9110c2ed14f39aeadbf4320746729a4252f9b9451dc94fad1c.png" />
<img alt="../../_images/c27e8dd7c39ba7a0ae525737ea8e6386e6638b75e4d13118f2919e8faa8721ba.png" src="../../_images/c27e8dd7c39ba7a0ae525737ea8e6386e6638b75e4d13118f2919e8faa8721ba.png" />
</div>
</div>
<p>Plot of observed flux density (black), model fit (red), and residuals (bottom panel).  This spaxel has strong H2 emission at 9.6 microns and 8 micron PAH and [Ne II] 12.8 micron emission from star-forming regions.</p>
</section>
<section id="fit-the-entire-cube">
<h2>Fit the Entire Cube<a class="headerlink" href="#fit-the-entire-cube" title="Permalink to this heading">#</a></h2>
<p>Identify NaNs, then create list of models (based on generic model), one entry per NaN-free spaxel. Next launch the multiprocessing Pool, limited to number of available cores minus one. Fitting the entire cube (900 spaxels) takes about 2 minutes to fit with 7 processes running in parallel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cube_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

<span class="c1">#The fit method is redefined as a top-level function to make it pickle-able for multiprocessing.Pool</span>
<span class="k">def</span> <span class="nf">modfit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">modf</span><span class="o">=</span><span class="n">generic_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">spaxerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">modf</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span>

<span class="c1">#Helper to either assign a NaN result or fit a single non-NaN spaxel</span>
<span class="k">def</span> <span class="nf">fit_point</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">spaxel</span><span class="p">,</span><span class="n">spaxerr</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">,</span><span class="n">nancheck</span> <span class="o">=</span> <span class="n">args</span>
        <span class="c1"># print(a, b, len(spaxel), mp.current_process().name)</span>
        <span class="k">if</span> <span class="n">nancheck</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">res_point</span><span class="o">=</span><span class="n">modfit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">spaxerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

            <span class="n">cube_res</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res_point</span> 
        <span class="k">elif</span> <span class="n">nancheck</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cube_res</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">return</span> 

<span class="c1">#Extraction region dimensions (trimmed cube)</span>
<span class="n">astart</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">aend</span><span class="o">=</span><span class="n">ysize</span>
<span class="n">bstart</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">bend</span><span class="o">=</span><span class="n">zsize</span>

<span class="c1">#Check for NaNs, select data, and set model start parameters for each spaxel</span>
<span class="n">pooldata</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">astart</span><span class="p">,</span><span class="n">aend</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bstart</span><span class="p">,</span><span class="n">bend</span><span class="p">):</span>        
        <span class="n">nancheck</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">point</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nancheck</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1">#Copy spaxel data vectors</span>
        <span class="n">spaxel</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
        <span class="n">spaxerr</span><span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">error_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
        <span class="n">wavelen</span><span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">pooldata</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">spaxel</span><span class="p">,</span><span class="n">spaxerr</span><span class="p">,</span><span class="n">wavelen</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">,</span><span class="n">nancheck</span><span class="p">])</span>


<span class="c1">#Launch Multiprocessing Pool</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_point</span><span class="p">,</span><span class="n">pooldata</span><span class="p">)</span>    

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time count&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="c1">#Save model fit</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;MPF_cube_result_model.sav&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">fp</span><span class="p">)</span>

<span class="c1">#Load model fit to full cube</span>
<span class="n">cube_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="s1">&#39;MPF_cube_result_model.sav&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">restore_cube</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">restore_cube</span><span class="p">:</span>
    <span class="n">pos</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time count
--- 819.6926140785217 seconds ---
</pre></div>
</div>
</div>
</div>
<section id="total-flux-and-reduced-chi-2-maps">
<h3>Total flux and Reduced Chi^2 Maps<a class="headerlink" href="#total-flux-and-reduced-chi-2-maps" title="Permalink to this heading">#</a></h3>
<p>Display total flux image (observed flux cube collapsed along wavelength direction) and reduced Chi^2 image for model fit in square sub-region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Sum observed flux in each spaxel</span>
<span class="n">cube_tflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">ysize</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">zsize</span><span class="p">]</span>

<span class="c1">#Sum model flux in each spaxel</span>
<span class="n">tcube_chi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">))</span>
<span class="n">tcube_modflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">))</span>
<span class="n">funcdefs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">modres</span><span class="o">=</span><span class="n">spax_result</span>
<span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1">#for pos, dumpval in cube_res:</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
        <span class="n">tcube_modflux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="n">tcube_chi</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
        <span class="n">tcube_modflux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">)</span>
        <span class="n">tcube_chi</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">redchi</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log Observed Flux&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_tflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log Model Flux&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tcube_modflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reduced Chi Square&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_tflux</span><span class="o">-</span><span class="n">tcube_modflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7934afe29a21dba43f394c5cdd7727bd11eeb468d41a223feb7c81fc12e1e19b.png" src="../../_images/7934afe29a21dba43f394c5cdd7727bd11eeb468d41a223feb7c81fc12e1e19b.png" />
</div>
</div>
<p>Collapsed cube maps, showing observed flux, model flux, and Chi^2/DF.  White regions with NaNs in the input data cube also have NaNs in the output model cube along the left and top edges and in column 26.  Residuals in the nucleus may either be the result of inadequate PSF sampling or mis-fit AGN model.</p>
</section>
<section id="line-and-pah-feature-flux-maps">
<h3>Line and PAH feature flux maps.<a class="headerlink" href="#line-and-pah-feature-flux-maps" title="Permalink to this heading">#</a></h3>
<section id="functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
<h4>Functions to extract line and PAH maps from model parameter cube<a class="headerlink" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">line_map</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create total emission line flux map for Gaussian emission line model component&quot;&quot;&quot;</span>
    
    <span class="n">line_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
            <span class="n">line_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
            <span class="n">amp</span><span class="p">,</span> <span class="n">cen</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gaussian_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>               
            <span class="n">line_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">gaussianline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">cen</span><span class="p">)</span>                      

    <span class="k">return</span> <span class="n">line_flux</span>

<span class="k">def</span> <span class="nf">pahdust_maps</span><span class="p">(</span><span class="n">pahdust_comp</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create total emission line flux map for Gaussian emission line model component&quot;&quot;&quot;</span>
    
    <span class="n">pah_ion_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="n">pah_neutral_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
            <span class="n">pah_ion_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
            <span class="n">pah_neutral_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">pahdust_comp</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
            <span class="n">ampl_76</span><span class="p">,</span> <span class="n">ampl_113</span> <span class="o">=</span> <span class="n">pahdust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>  
            <span class="n">pah_76_flux</span> <span class="o">=</span> <span class="n">drudeline_flux</span><span class="p">(</span><span class="n">ampl_76</span><span class="p">,</span><span class="mf">0.044</span><span class="p">,</span><span class="mf">7.60</span><span class="p">)</span>
            <span class="n">pah_113_flux</span> <span class="o">=</span> <span class="n">drudeline_flux</span><span class="p">(</span><span class="n">ampl_113</span><span class="p">,</span><span class="mf">0.032</span><span class="p">,</span><span class="mf">11.33</span><span class="p">)</span>                      
            <span class="n">pah_ion_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">pah_76_flux</span>
            <span class="n">pah_neutral_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">pah_113_flux</span>

    <span class="k">return</span> <span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span>

<span class="k">def</span> <span class="nf">sidust_map</span><span class="p">(</span><span class="n">sidust_comp</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create silicate dust emission map&quot;&quot;&quot;</span>
    <span class="n">sidust_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
            <span class="n">sidust_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">sidust_comp</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
            <span class="n">t</span><span class="p">,</span><span class="n">si_ampl</span> <span class="o">=</span> <span class="n">sidust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="n">si_norm</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">sidust_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">si_ampl</span><span class="o">*</span><span class="n">si_norm</span>
            
    <span class="k">return</span> <span class="n">sidust_flux</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
<h4>H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model<a class="headerlink" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h2_flux</span><span class="o">=</span><span class="n">line_map</span><span class="p">(</span><span class="s1">&#39;h96&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">ne_flux</span><span class="o">=</span><span class="n">line_map</span><span class="p">(</span><span class="s1">&#39;NeII&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span> <span class="o">=</span> <span class="n">pahdust_maps</span><span class="p">(</span><span class="s1">&#39;pahdust1&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">sidust_flux</span><span class="o">=</span><span class="n">sidust_map</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;[Ne II] 12.8 um&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ne_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2 9.6 um&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PAH 7.6 um&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PAH 11.3 um&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Si dust em.&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sidust_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>           
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#Make RGB images</span>
<span class="n">stretch1</span><span class="o">=</span><span class="mf">0.000000000000004</span>
<span class="n">stretch2</span><span class="o">=</span><span class="mf">0.000000000000005</span>
<span class="n">m58_neii_pah0_h2</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">ne_flux</span><span class="p">,</span> <span class="n">h2_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch1</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;m58_NeII_H96_PAH113.png&quot;</span><span class="p">)</span>
<span class="n">m58_pah_h2</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">h2_flux</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch2</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;m58_PAH113_H96_PAH76.png&quot;</span><span class="p">)</span>

<span class="c1">#Two-panel figure</span>
<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_neii_pah0_h2</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_pah_h2</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/49bc12c0c40767c884bb46f4a711ddf25b4d8d6baf075359c2ca1c53dab7f739.png" src="../../_images/49bc12c0c40767c884bb46f4a711ddf25b4d8d6baf075359c2ca1c53dab7f739.png" />
<img alt="../../_images/cfefdbe42fda5149ed2a83483f8c43d8f7538fed95a0ddf801eff70d4fe18704.png" src="../../_images/cfefdbe42fda5149ed2a83483f8c43d8f7538fed95a0ddf801eff70d4fe18704.png" />
</div>
</div>
<p>3-color RGB images. Top: individual feature maps. Bottom left: r = [Ne II] 12.8 micron, g = H2 S(3) 9.6 micron, b = PAH 11.3 micron. Ionized atomic gas in the active galactic nucleus shows up as red, shocked regions are green, and dust emission is blue. Bottom right: r = PAH 11.3 micron, g = H2 S(3) 9.6 micron, b = PAH 7.6 micron. Neutral PAH emission shows up as red, ionized PAH emission from PDRs in star-forming regions is blue, and shocked regions are green.</p>
</section>
</section>
</section>
<section id="extract-and-model-cube-sub-regions">
<h2>Extract and model cube sub-regions<a class="headerlink" href="#extract-and-model-cube-sub-regions" title="Permalink to this heading">#</a></h2>
<section id="make-spectral-region-masks">
<h3>Make spectral region masks<a class="headerlink" href="#make-spectral-region-masks" title="Permalink to this heading">#</a></h3>
<p>Define spectral extraction regions based on spatial location, line flux, and line or feature ratios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Nucleus extraction region, defined by 5x5 square</span>
<span class="n">nuc_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">nuc_mask</span><span class="p">[</span><span class="mi">14</span><span class="o">-</span><span class="n">a</span><span class="p">,</span><span class="mi">17</span><span class="o">-</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#Spiral arm extraction region</span>
<span class="n">arm_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">pah_neutral_flux</span><span class="o">&gt;=</span><span class="mf">0.155e-14</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">pah_ion_flux</span><span class="o">/</span><span class="n">pah_neutral_flux</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Inner disk extraction region        </span>
<span class="n">pah_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">pah_neutral_flux</span><span class="o">&gt;=</span><span class="mf">0.155e-14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h2_flux</span><span class="o">&lt;</span><span class="mf">1e-15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">arm_mask</span>
<span class="n">pah_mask</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#Trim edges of cube</span>
<span class="n">pah_mask</span><span class="p">[</span><span class="mi">28</span><span class="p">:,:]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Regions of strongest H2 emission</span>
<span class="n">h2s_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">h2_flux</span><span class="o">&gt;=</span><span class="mf">1e-15</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">h2_flux</span><span class="o">/</span><span class="n">pah_neutral_flux</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#H2 extraction region</span>
<span class="n">h2_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">h2_flux</span><span class="o">&gt;=</span><span class="mf">1e-15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">h2s_mask</span>

<span class="c1">#M58 combined central regions mask (excluding spiral arm)</span>
<span class="n">m58_mask</span><span class="o">=</span><span class="n">nuc_mask</span> <span class="o">+</span> <span class="n">h2_mask</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">h2s_mask</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">pah_mask</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span><span class="n">arm_mask</span><span class="o">*</span><span class="mi">5</span>

<span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Nucleus&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nuc_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spiral Arm&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arm_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inner Disk&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2-strongest&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2s_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All regions&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2096/486002270.py:8: RuntimeWarning: invalid value encountered in divide
  arm_mask=np.where(((pah_neutral_flux&gt;=0.155e-14) &amp;((pah_ion_flux/pah_neutral_flux)&gt;0.8) &amp; (nuc_mask==0)),1,0)
/tmp/ipykernel_2096/486002270.py:16: RuntimeWarning: invalid value encountered in divide
  h2s_mask=np.where(((h2_flux&gt;=1e-15)&amp;((h2_flux/pah_neutral_flux)&gt;0.7) &amp; (nuc_mask==0)),1,0)
</pre></div>
</div>
<img alt="../../_images/fd62a55585f957c0203eeb499ce31270b9eb27b58f5de42cbb4aa4d3d0da3756.png" src="../../_images/fd62a55585f957c0203eeb499ce31270b9eb27b58f5de42cbb4aa4d3d0da3756.png" />
</div>
</div>
<p>Extraction region masks based on spatial and emission line or PAH feature strengths.</p>
</section>
<section id="extract-spectra-from-mask-regions">
<h3>Extract spectra from mask regions<a class="headerlink" href="#extract-spectra-from-mask-regions" title="Permalink to this heading">#</a></h3>
<p>Spectra summed over five different regions: Spiral Arm, Nucleus, PAH, H2, and Strongest H2</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuc_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">nuc_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">pah_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">pah_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">arm_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">arm_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2s_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2s_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ysize</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zsize</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nuc_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">nuc_spec</span><span class="o">=</span><span class="n">nuc_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">nuc_err</span><span class="o">=</span><span class="n">nuc_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">pah_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">pah_spec</span><span class="o">=</span><span class="n">pah_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">pah_err</span><span class="o">=</span><span class="n">pah_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">h2_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">h2_spec</span><span class="o">=</span><span class="n">h2_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">h2_err</span><span class="o">=</span><span class="n">h2_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">arm_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">arm_spec</span><span class="o">=</span><span class="n">arm_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">arm_err</span><span class="o">=</span><span class="n">arm_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">h2s_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">h2s_spec</span><span class="o">=</span><span class="n">h2s_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">h2s_err</span><span class="o">=</span><span class="n">h2s_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>

<span class="n">nuc_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nuc_err</span><span class="p">)</span>
<span class="n">pah_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pah_err</span><span class="p">)</span>
<span class="n">h2_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2_err</span><span class="p">)</span>
<span class="n">arm_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arm_err</span><span class="p">)</span>
<span class="n">h2s_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2s_err</span><span class="p">)</span>
<span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">),(</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spiral Arm&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">arm_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">arm_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Nucleus&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nuc_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">nuc_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inner Disk&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pah_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pah_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All regions&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel&#39;</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2-Strongest&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2s_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2s_err</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3e04721f7648da9b7616001a8b5f11edaddab3a712f26e551ef7e5b332dbc217.png" src="../../_images/3e04721f7648da9b7616001a8b5f11edaddab3a712f26e551ef7e5b332dbc217.png" />
</div>
</div>
</section>
<section id="save-spectra-to-files">
<h3>Save spectra to files<a class="headerlink" href="#save-spectra-to-files" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#np.savetxt(targname+&#39;_spec_nuc.dat&#39;, np.column_stack((x, nuc_spec, nuc_err)),header=&#39;Wavelength[microns]     Flux_Nucleus[Jy]      Err_Flux_Nucleus&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_h2.dat&#39;, np.column_stack((x, h2_spec, h2_err)), header=&#39;Wavelength[microns]     Flux_H2[Jy]      Err_H2&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_h2s.dat&#39;, np.column_stack((x, h2_spec, h2_err)), header=&#39;Wavelength[microns]     Flux_H2s[Jy]      Err_H2s&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_pah.dat&#39;, np.column_stack((x, pah_spec, pah_err)), header=&#39;Wavelength[microns]     Flux_PAH[Jy]      Err_PAH&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_arm.dat&#39;, np.column_stack((x, arm_spec, arm_err)), header=&#39;Wavelength[microns]     Flux_Arm[Jy]      Err_Arm&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-spectra-of-regions">
<h3>Fit spectra of regions<a class="headerlink" href="#fit-spectra-of-regions" title="Permalink to this heading">#</a></h3>
<section id="generic-model-components">
<h4>Generic model components<a class="headerlink" href="#generic-model-components" title="Permalink to this heading">#</a></h4>
<p>Model 14 individual PAH components with all amplitudes free. It would be computationally expensive to do this
for the full cube, but only takes a couple of seconds for the summed region spectra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Power Law</span>
<span class="n">p_law</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">powerlaw</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;pwl_&#39;</span><span class="p">)</span>
<span class="n">generic_pars</span> <span class="o">=</span> <span class="n">p_law</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>      <span class="c1">#Generate the parameters</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Individual PAHs</span>
<span class="n">drudes</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="n">allpahlines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;52&#39;</span><span class="p">,</span><span class="s1">&#39;62&#39;</span><span class="p">,</span><span class="s1">&#39;74&#39;</span><span class="p">,</span><span class="s1">&#39;76&#39;</span><span class="p">,</span><span class="s1">&#39;78&#39;</span><span class="p">,</span><span class="s1">&#39;83&#39;</span><span class="p">,</span><span class="s1">&#39;86&#39;</span><span class="p">,</span><span class="s1">&#39;112&#39;</span><span class="p">,</span><span class="s1">&#39;113&#39;</span><span class="p">,</span><span class="s1">&#39;119&#39;</span><span class="p">,</span><span class="s1">&#39;126&#39;</span><span class="p">,</span><span class="s1">&#39;134&#39;</span><span class="p">,</span><span class="s1">&#39;140&#39;</span><span class="p">,</span><span class="s1">&#39;141&#39;</span><span class="p">]</span> 
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">allpahlines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;PAH&#39;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>  
    <span class="n">drudes</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">drude</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>  
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">drudes</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>

<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH52&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">5.27</span><span class="p">,</span> <span class="mf">0.034</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH62&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.22</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH74&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">7.42</span><span class="p">,</span> <span class="mf">0.126</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH76&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">7.60</span><span class="p">,</span> <span class="mf">0.044</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH78&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">7.85</span><span class="p">,</span> <span class="mf">0.053</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH83&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">8.33</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH86&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">8.61</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH112&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.23</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH113&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.33</span><span class="p">,</span> <span class="mf">0.032</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH119&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.99</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH126&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">12.62</span><span class="p">,</span> <span class="mf">0.042</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH134&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">13.48</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH140&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">14.04</span><span class="p">,</span> <span class="mf">0.016</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH141&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">14.19</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Silicate dust emission</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sidust1_&#39;</span>
<span class="n">silicate</span><span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">sidust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">silicate</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">1.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Gaussians with FWHM and X central from Smith et al 2007</span>
<span class="c1">#H2 molecular</span>
<span class="n">h2lines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;55&#39;</span><span class="p">,</span><span class="s1">&#39;61&#39;</span><span class="p">,</span><span class="s1">&#39;69&#39;</span><span class="p">,</span><span class="s1">&#39;80&#39;</span><span class="p">,</span><span class="s1">&#39;96&#39;</span><span class="p">,</span><span class="s1">&#39;122&#39;</span><span class="p">]</span>
<span class="n">gaussH2</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">h2lines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussH2</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussH2</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h55&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">5.511</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h61&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.109</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h69&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.909</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h80&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">8.026</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h96&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">9.665</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h122&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">12.278</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Atomic lines</span>
<span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="s1">&#39;NeII&#39;</span><span class="p">]</span>
<span class="n">gaussAt</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussAt</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussAt</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.985</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">10.511</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;NeII&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">12.813</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="spiral-arm-spectral-fit">
<h4>Spiral arm spectral fit<a class="headerlink" href="#spiral-arm-spectral-fit" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Spiral arm spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">arm_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">arm_err</span>

<span class="c1">#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussAt</span> <span class="o">+</span> <span class="n">gaussH2</span>

<span class="c1">#Adjust power law starting parameters </span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.001</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">arm_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">arm_model</span> <span class="o">=</span> <span class="n">arm_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">arm_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">arm_model</span>
<span class="n">arm_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">arm_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="c1">#plot_fit(x, spec, specerr, arm_result)</span>
</pre></div>
</div>
</div>
</div>
<p>Model fit to integrated spectrum of spiral arm region.</p>
</section>
<section id="h2-strongest-region-spectral-fit">
<h4>H2-strongest region spectral fit<a class="headerlink" href="#h2-strongest-region-spectral-fit" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#H2 region spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">h2s_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">h2s_err</span>

<span class="c1">#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussAt</span> <span class="o">+</span> <span class="n">gaussH2</span>

<span class="c1">#Adjust power law starting parameters </span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.002</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">h2s_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">h2s_model</span> <span class="o">=</span> <span class="n">h2s_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">h2s_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">h2s_model</span>
<span class="n">h2s_modelcomps</span><span class="p">,</span><span class="n">h2s_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">h2s_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="c1">#plot_fit(x, spec, specerr, h2s_result)</span>
</pre></div>
</div>
</div>
</div>
<p>Model fit to integrated spectrum of H2-strongest region.</p>
</section>
<section id="nucleus-spectral-fit">
<h4>Nucleus spectral fit<a class="headerlink" href="#nucleus-spectral-fit" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Nucleus spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">nuc_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">nuc_err</span>

<span class="c1">#Model (powerlaw + AGN silicate emission + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">silicate</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussH2</span> <span class="o">+</span> <span class="n">gaussAt</span>

<span class="c1">#Adjust power law and silicate dust starting parameters</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">2.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">nuc_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">nuc_model</span> <span class="o">=</span> <span class="n">nuc_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">nuc_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">nuc_model</span>
<span class="n">nuc_modelcomps</span><span class="p">,</span><span class="n">nuc_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">nuc_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">nuc_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8baac928440f6c7c2b82107e009ca41a1a6726311d05df9f4632b728ecc0eae7.png" src="../../_images/8baac928440f6c7c2b82107e009ca41a1a6726311d05df9f4632b728ecc0eae7.png" />
<img alt="../../_images/d3d3d39b52da89329e32f7beec30ff78f265468f1ecdd85479b1f3a20cd9ee81.png" src="../../_images/d3d3d39b52da89329e32f7beec30ff78f265468f1ecdd85479b1f3a20cd9ee81.png" />
</div>
</div>
<p>Model fit to nucleus, including fixed-temperature AGN silicate emission.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuc_result</span>
<span class="c1">#result.fit_report(show_correl=False)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><h2>Fit Result</h2> <p>Model: ((((Model(powerlaw, prefix='pwl_') + Model(sidust, prefix='sidust1_')) + ((((((((((((((Model(Modelcero) + Model(drude, prefix='PAH52_')) + Model(drude, prefix='PAH62_')) + Model(drude, prefix='PAH74_')) + Model(drude, prefix='PAH76_')) + Model(drude, prefix='PAH78_')) + Model(drude, prefix='PAH83_')) + Model(drude, prefix='PAH86_')) + Model(drude, prefix='PAH112_')) + Model(drude, prefix='PAH113_')) + Model(drude, prefix='PAH119_')) + Model(drude, prefix='PAH126_')) + Model(drude, prefix='PAH134_')) + Model(drude, prefix='PAH140_')) + Model(drude, prefix='PAH141_'))) + ((((((Model(Modelcero) + Model(gaussian, prefix='h55_')) + Model(gaussian, prefix='h61_')) + Model(gaussian, prefix='h69_')) + Model(gaussian, prefix='h80_')) + Model(gaussian, prefix='h96_')) + Model(gaussian, prefix='h122_'))) + (((Model(Modelcero) + Model(gaussian, prefix='ArII_')) + Model(gaussian, prefix='SIV_')) + Model(gaussian, prefix='NeII_')))</p> <table class="jp-toc-ignore"><caption class="jp-toc-ignore">Fit Statistics</caption><tr><td style='text-align:left'>fitting method</td><td style='text-align:right'>leastsq</td></tr><tr><td style='text-align:left'># function evals</td><td style='text-align:right'>437</td></tr><tr><td style='text-align:left'># data points</td><td style='text-align:right'>194</td></tr><tr><td style='text-align:left'># variables</td><td style='text-align:right'>26</td></tr><tr><td style='text-align:left'>chi-square</td><td style='text-align:right'> 7693.84415</td></tr><tr><td style='text-align:left'>reduced chi-square</td><td style='text-align:right'> 45.7966914</td></tr><tr><td style='text-align:left'>Akaike info crit.</td><td style='text-align:right'> 765.981628</td></tr><tr><td style='text-align:left'>Bayesian info crit.</td><td style='text-align:right'> 850.945940</td></tr><tr><td style='text-align:left'>R-squared</td><td style='text-align:right'>-189118.976</td></tr></table><table class="jp-toc-ignore"><caption>Parameters</caption><tr><th style='text-align:left'>name</th><th style='text-align:left'>value</th><th style='text-align:left'>standard error</th><th style='text-align:left'>relative error</th><th style='text-align:left'>initial value</th><th style='text-align:left'>min</th><th style='text-align:left'>max</th><th style='text-align:right'>vary</th></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'> 0.09323630</td><td style='text-align:left'> 0.00988866</td><td style='text-align:left'>(10.61%)</td><td style='text-align:left'>0.005</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>-0.40070155</td><td style='text-align:left'> 0.05813497</td><td style='text-align:left'>(14.51%)</td><td style='text-align:left'>0.01</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'> 0.00153019</td><td style='text-align:left'> 0.00171567</td><td style='text-align:left'>(112.12%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH52_peakx</td><td style='text-align:left'> 5.29666620</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>5.2966662</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH52_frac_FWHM</td><td style='text-align:left'> 0.03400000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.034</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH62_amplitude</td><td style='text-align:left'> 0.00969676</td><td style='text-align:left'> 0.00130534</td><td style='text-align:left'>(13.46%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH62_peakx</td><td style='text-align:left'> 6.25147320</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>6.2514732</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH62_frac_FWHM</td><td style='text-align:left'> 0.03000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.03</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'> 0.00387555</td><td style='text-align:left'> 0.00178379</td><td style='text-align:left'>(46.03%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH74_peakx</td><td style='text-align:left'> 7.45754520</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>7.4575452</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH74_frac_FWHM</td><td style='text-align:left'> 0.12600000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.126</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:left'> 0.00815708</td><td style='text-align:left'> 0.00241384</td><td style='text-align:left'>(29.59%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH76_peakx</td><td style='text-align:left'> 7.63845600</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>7.638456</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH76_frac_FWHM</td><td style='text-align:left'> 0.04400000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.044</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:left'> 0.01091009</td><td style='text-align:left'> 0.00163269</td><td style='text-align:left'>(14.96%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH78_peakx</td><td style='text-align:left'> 7.88972100</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>7.889721</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH78_frac_FWHM</td><td style='text-align:left'> 0.05300000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.053</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:left'> 7.5373e-04</td><td style='text-align:left'> 0.00114875</td><td style='text-align:left'>(152.41%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH83_peakx</td><td style='text-align:left'> 8.37214980</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>8.3721498</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH83_frac_FWHM</td><td style='text-align:left'> 0.05000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:left'> 0.00579103</td><td style='text-align:left'> 0.00124850</td><td style='text-align:left'>(21.56%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH86_peakx</td><td style='text-align:left'> 8.65356660</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>8.6535666</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH86_frac_FWHM</td><td style='text-align:left'> 0.03900000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.039</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH112_amplitude</td><td style='text-align:left'> 0.02791784</td><td style='text-align:left'> 0.00249670</td><td style='text-align:left'>(8.94%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH112_peakx</td><td style='text-align:left'> 11.2868238</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>11.2868238</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH112_frac_FWHM</td><td style='text-align:left'> 0.01200000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.012</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH113_amplitude</td><td style='text-align:left'> 0.02507602</td><td style='text-align:left'> 0.00171112</td><td style='text-align:left'>(6.82%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH113_peakx</td><td style='text-align:left'> 11.3873298</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>11.387329800000002</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH113_frac_FWHM</td><td style='text-align:left'> 0.03200000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.032</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:left'> 0.00753090</td><td style='text-align:left'> 0.00125443</td><td style='text-align:left'>(16.66%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH119_peakx</td><td style='text-align:left'> 12.0506694</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>12.0506694</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH119_frac_FWHM</td><td style='text-align:left'> 0.04500000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.045</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:left'> 0.01570182</td><td style='text-align:left'> 0.00113757</td><td style='text-align:left'>(7.24%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH126_peakx</td><td style='text-align:left'> 12.6838572</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>12.6838572</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH126_frac_FWHM</td><td style='text-align:left'> 0.04200000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.042</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:left'> 0.00532542</td><td style='text-align:left'> 0.00149158</td><td style='text-align:left'>(28.01%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH134_peakx</td><td style='text-align:left'> 13.5482088</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>13.548208800000001</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH134_frac_FWHM</td><td style='text-align:left'> 0.04000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.04</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH140_amplitude</td><td style='text-align:left'> 0.00612965</td><td style='text-align:left'> 0.00231252</td><td style='text-align:left'>(37.73%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH140_peakx</td><td style='text-align:left'> 14.1110424</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>14.1110424</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH140_frac_FWHM</td><td style='text-align:left'> 0.01600000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.016</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:left'> 0.00106661</td><td style='text-align:left'> 0.00205048</td><td style='text-align:left'>(192.24%)</td><td style='text-align:left'>0.5</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>PAH141_peakx</td><td style='text-align:left'> 14.2618014</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>14.261801400000001</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>PAH141_frac_FWHM</td><td style='text-align:left'> 0.02500000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.025</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>sidust1_T</td><td style='text-align:left'> 190.000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>190.0</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:left'> 0.00147028</td><td style='text-align:left'> 6.3970e-05</td><td style='text-align:left'>(4.35%)</td><td style='text-align:left'>0.0002</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>h55_amplitude</td><td style='text-align:left'> 0.00807689</td><td style='text-align:left'> 0.00208744</td><td style='text-align:left'>(25.84%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>h55_xcen</td><td style='text-align:left'> 5.53888566</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>5.53888566</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h55_std</td><td style='text-align:left'> 0.02000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.02</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h61_amplitude</td><td style='text-align:left'> 0.00570436</td><td style='text-align:left'> 0.00234815</td><td style='text-align:left'>(41.16%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>h61_xcen</td><td style='text-align:left'> 6.13991154</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>6.13991154</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h61_std</td><td style='text-align:left'> 0.02000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.02</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h69_amplitude</td><td style='text-align:left'> 0.03374199</td><td style='text-align:left'> 0.00392859</td><td style='text-align:left'>(11.64%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>h69_xcen</td><td style='text-align:left'> 6.94395954</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>6.94395954</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h69_std</td><td style='text-align:left'> 0.02000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.02</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h80_amplitude</td><td style='text-align:left'> 0.00788398</td><td style='text-align:left'> 0.00224406</td><td style='text-align:left'>(28.46%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>h80_xcen</td><td style='text-align:left'> 8.06661156</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>8.06661156</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h80_std</td><td style='text-align:left'> 0.04000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.04</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h96_amplitude</td><td style='text-align:left'> 0.04421750</td><td style='text-align:left'> 0.00185182</td><td style='text-align:left'>(4.19%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>h96_xcen</td><td style='text-align:left'> 9.71390490</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>9.7139049</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h96_std</td><td style='text-align:left'> 0.04000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.04</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h122_amplitude</td><td style='text-align:left'> 0.02237824</td><td style='text-align:left'> 0.00242099</td><td style='text-align:left'>(10.82%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>h122_xcen</td><td style='text-align:left'> 12.3401267</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>12.340126680000001</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>h122_std</td><td style='text-align:left'> 0.04000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.04</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>ArII_amplitude</td><td style='text-align:left'> 0.01904380</td><td style='text-align:left'> 0.00277181</td><td style='text-align:left'>(14.55%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>ArII_xcen</td><td style='text-align:left'> 7.02034410</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>7.020344100000001</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>ArII_std</td><td style='text-align:left'> 0.02000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.02</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>SIV_amplitude</td><td style='text-align:left'> 8.4793e-04</td><td style='text-align:left'> 0.00222142</td><td style='text-align:left'>(261.98%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>SIV_xcen</td><td style='text-align:left'> 10.5641857</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>10.56418566</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>SIV_std</td><td style='text-align:left'> 0.04000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.04</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>NeII_amplitude</td><td style='text-align:left'> 0.05889577</td><td style='text-align:left'> 0.00237346</td><td style='text-align:left'>(4.03%)</td><td style='text-align:left'>0.05</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>        inf</td><td style='text-align:right'>True</td></tr><tr><td style='text-align:left'>NeII_xcen</td><td style='text-align:left'> 12.8778338</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>12.877833780000001</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr><tr><td style='text-align:left'>NeII_std</td><td style='text-align:left'> 0.04000000</td><td style='text-align:left'> 0.00000000</td><td style='text-align:left'>(0.00%)</td><td style='text-align:left'>0.04</td><td style='text-align:left'>       -inf</td><td style='text-align:left'>        inf</td><td style='text-align:right'>False</td></tr></table><table class="jp-toc-ignore"><caption>Correlations (unreported values are < 0.100)</caption><tr><th style='text-align:left'>Parameter1</th><th style='text-align:left'>Parameter 2</th><th style='text-align:right'>Correlation</th></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>pwl_c2</td><td style='text-align:right'>-0.9932</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>-0.8837</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.8382</td></tr><tr><td style='text-align:left'>PAH112_amplitude</td><td style='text-align:left'>PAH113_amplitude</td><td style='text-align:right'>-0.7136</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:right'>-0.7006</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>-0.6250</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>+0.6103</td></tr><tr><td style='text-align:left'>PAH140_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>-0.5920</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>-0.5673</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.5537</td></tr><tr><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.5146</td></tr><tr><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.4884</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>-0.4291</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>+0.4203</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:right'>-0.4172</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.4037</td></tr><tr><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:left'>h80_amplitude</td><td style='text-align:right'>-0.3960</td></tr><tr><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:right'>-0.3889</td></tr><tr><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:right'>-0.3786</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:right'>-0.3743</td></tr><tr><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.3685</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:right'>+0.3591</td></tr><tr><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.3490</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:right'>+0.3466</td></tr><tr><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.3178</td></tr><tr><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>+0.2766</td></tr><tr><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.2751</td></tr><tr><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.2726</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:right'>-0.2725</td></tr><tr><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:left'>NeII_amplitude</td><td style='text-align:right'>-0.2719</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:right'>-0.2643</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'>PAH62_amplitude</td><td style='text-align:right'>+0.2594</td></tr><tr><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:right'>-0.2544</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:right'>+0.2478</td></tr><tr><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.2448</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>+0.2337</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>ArII_amplitude</td><td style='text-align:right'>-0.2283</td></tr><tr><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:left'>h122_amplitude</td><td style='text-align:right'>-0.2128</td></tr><tr><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:left'>SIV_amplitude</td><td style='text-align:right'>-0.2103</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.2100</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:right'>+0.2050</td></tr><tr><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>+0.1987</td></tr><tr><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:left'>h80_amplitude</td><td style='text-align:right'>+0.1944</td></tr><tr><td style='text-align:left'>PAH113_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>-0.1932</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>h55_amplitude</td><td style='text-align:right'>-0.1919</td></tr><tr><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:left'>ArII_amplitude</td><td style='text-align:right'>+0.1847</td></tr><tr><td style='text-align:left'>PAH62_amplitude</td><td style='text-align:left'>h61_amplitude</td><td style='text-align:right'>-0.1818</td></tr><tr><td style='text-align:left'>PAH113_amplitude</td><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:right'>-0.1787</td></tr><tr><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>+0.1785</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>-0.1783</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:right'>+0.1771</td></tr><tr><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>+0.1666</td></tr><tr><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.1653</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:right'>+0.1637</td></tr><tr><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>+0.1632</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:right'>-0.1629</td></tr><tr><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.1617</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>-0.1605</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:right'>+0.1604</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>+0.1601</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:right'>-0.1596</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>h55_amplitude</td><td style='text-align:right'>+0.1589</td></tr><tr><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:right'>+0.1582</td></tr><tr><td style='text-align:left'>PAH62_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>+0.1580</td></tr><tr><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:right'>+0.1562</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:right'>+0.1528</td></tr><tr><td style='text-align:left'>PAH112_amplitude</td><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:right'>+0.1525</td></tr><tr><td style='text-align:left'>PAH62_amplitude</td><td style='text-align:left'>h55_amplitude</td><td style='text-align:right'>+0.1515</td></tr><tr><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>-0.1465</td></tr><tr><td style='text-align:left'>PAH62_amplitude</td><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:right'>+0.1446</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>-0.1394</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>h69_amplitude</td><td style='text-align:right'>-0.1334</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>-0.1282</td></tr><tr><td style='text-align:left'>PAH119_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.1267</td></tr><tr><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:left'>sidust1_amplitude</td><td style='text-align:right'>-0.1256</td></tr><tr><td style='text-align:left'>PAH83_amplitude</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>+0.1222</td></tr><tr><td style='text-align:left'>pwl_c2</td><td style='text-align:left'>SIV_amplitude</td><td style='text-align:right'>+0.1200</td></tr><tr><td style='text-align:left'>PAH76_amplitude</td><td style='text-align:left'>h69_amplitude</td><td style='text-align:right'>+0.1175</td></tr><tr><td style='text-align:left'>PAH52_amplitude</td><td style='text-align:left'>h55_amplitude</td><td style='text-align:right'>+0.1163</td></tr><tr><td style='text-align:left'>pwl_c1</td><td style='text-align:left'>SIV_amplitude</td><td style='text-align:right'>-0.1131</td></tr><tr><td style='text-align:left'>PAH62_amplitude</td><td style='text-align:left'>PAH86_amplitude</td><td style='text-align:right'>+0.1124</td></tr><tr><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:right'>+0.1120</td></tr><tr><td style='text-align:left'>PAH134_amplitude</td><td style='text-align:left'>PAH140_amplitude</td><td style='text-align:right'>-0.1112</td></tr><tr><td style='text-align:left'>PAH113_amplitude</td><td style='text-align:left'>PAH126_amplitude</td><td style='text-align:right'>+0.1044</td></tr><tr><td style='text-align:left'>PAH74_amplitude</td><td style='text-align:left'>h55_amplitude</td><td style='text-align:right'>+0.1028</td></tr><tr><td style='text-align:left'>PAH78_amplitude</td><td style='text-align:left'>PAH141_amplitude</td><td style='text-align:right'>+0.1009</td></tr></table></div></div>
</div>
<p>Fit parameters for spectrum of nucleus</p>
</section>
</section>
</section>
<section id="summary-plot">
<h2>Summary Plot<a class="headerlink" href="#summary-plot" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">),(</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spiral Arm&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">arm_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">arm_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>
<span class="n">mod_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="s1">&#39;orange&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arm_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Nucleus&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nuc_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">nuc_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
<span class="c1">#ax2.plot(x, fit_model,label=&#39;Model&#39;,c=&#39;red&#39;)</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nuc_modelcomps</span><span class="p">,</span><span class="n">nuc_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inner Disk&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pah_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pah_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All regions&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2-Strongest&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2s_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2s_err</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h2s_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a20ee6e1e5063435258a2cd8ccc00a5ab836fc3b37f503c4581708c4bdefcb5a.png" src="../../_images/a20ee6e1e5063435258a2cd8ccc00a5ab836fc3b37f503c4581708c4bdefcb5a.png" />
</div>
</div>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a>
<p>Notebook created by Patrick Ogle and Ivan Lopez.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/cube_fitting"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">IFU Cube Fitting</p>
      </div>
    </a>
    <a class="right-next"
       href="../ifu_optimal/ifu_optimal.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NIRSpec IFU Optimal Point Source Extraction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#definitions-of-functions">Definitions of functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scrolling">Scrolling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-functions">Model Functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameters">Model Parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#line-flux-from-model-parameters">Line Flux from Model Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">Extract and plot 1D spectrum and model components</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-data">Input data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameter-starting-values">Model Parameter Starting Values</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-representative-spaxel">Fit a Representative Spaxel</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-entire-cube">Fit the Entire Cube</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">Total flux and Reduced Chi^2 Maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">Line and PAH feature flux maps.</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">Functions to extract line and PAH maps from model parameter cube</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">Extract and model cube sub-regions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-spectral-region-masks">Make spectral region masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">Extract spectra from mask regions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-spectra-to-files">Save spectra to files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-spectra-of-regions">Fit spectra of regions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generic-model-components">Generic model components</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spiral-arm-spectral-fit">Spiral arm spectral fit</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">H2-strongest region spectral fit</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nucleus-spectral-fit">Nucleus spectral fit</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-plot">Summary Plot</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>