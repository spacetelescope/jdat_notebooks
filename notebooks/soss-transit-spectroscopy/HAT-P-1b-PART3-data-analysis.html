

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>SOSS Transit Spectroscopy &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>SOSS Transit Spectroscopy</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-introduction-a-class-anchor-id-intro-a">1.<font color="white">-</font>Introduction <a class="anchor" id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-spectral-extraction-a-class-anchor-id-extraction-a">2.<font color="white">-</font>Spectral extraction <a class="anchor" id="extraction"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-font-color-white-font-tracing-the-orders-a-class-anchor-id-tracing-a">A.<font color="white">-</font>Tracing the orders<a class="anchor" id="tracing"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-font-color-white-font-extracting-the-spectra-a-class-anchor-id-extracting-a">B.<font color="white">-</font>Extracting the spectra<a class="anchor" id="extracting"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-time-stamps-and-wavelength-solution">C. Time-stamps and wavelength solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-analyzing-white-light-lightcurves">3. Fitting &amp; analyzing white-light lightcurves</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-studying-the-residuals">A. Studying the residuals</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-analyzing-the-wavelength-dependent-lightcurves">4. Fitting &amp; analyzing the wavelength-dependent lightcurves</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="soss-transit-spectroscopy">
<h1>SOSS Transit Spectroscopy<a class="headerlink" href="#soss-transit-spectroscopy" title="Permalink to this heading">#</a></h1>
<p><strong>Use case:</strong> Primary transit of an exoplanet with SOSS.<br>
<strong>Data:</strong> JWST simulated data with awesimsoss.<br>
<strong>Tools:</strong>  awesimsoss, jwst, astropy.<br>
<strong>Cross-intrument:</strong> <br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<section id="table-of-contents">
<h2>Table of contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><span class="xref myst">Introduction</span></p></li>
<li><p><span class="xref myst">Spectral extraction</span></p>
<ol class="arabic simple">
<li><p><span class="xref myst">Tracing the orders</span></p></li>
<li><p><span class="xref myst">Extracting the spectra</span></p></li>
<li><p><span class="xref myst">Time-stamps and wavelength solution</span></p></li>
</ol>
</li>
<li><p><span class="xref myst">Fitting &amp; analyzing white-light lightcurves</span></p>
<ol class="arabic simple">
<li><p><span class="xref myst">Studying the residuals</span></p></li>
</ol>
</li>
<li><p><span class="xref myst">Fitting &amp; analyzing the wavelength-dependent lightcurves</span></p></li>
<li><p><span class="xref myst">Studying the transit spectrum of HAT-P-1b</span></p></li>
</ol>
</section>
<section id="font-color-white-font-introduction-a-class-anchor-id-intro-a">
<h2>1.<font color='white'>-</font>Introduction <a class="anchor" id="intro"></a><a class="headerlink" href="#font-color-white-font-introduction-a-class-anchor-id-intro-a" title="Permalink to this heading">#</a></h2>
<p>This notebook is part of a series of notebooks that are being prepared by STScI in order to showcase how to simulate, process and analyze JWST observations for a wide range of science cases. Here, we touch on the transiting exoplanet observations science case and, in particular, on spectrophotometric observations of the <em>primary transit of an exoplanet</em>. During primary transit, the observed flux decrease due to the planet blocking light from the stellar host is proportional to <span class="math notranslate nohighlight">\(\delta = (R_p/R_*)^2\)</span> — a quantity known as the <em>transit depth</em>, where <span class="math notranslate nohighlight">\(R_p\)</span> is the planetary radius and <span class="math notranslate nohighlight">\(R_*\)</span> is the stellar radius. Interestingly, the transit depth is wavelength dependent; i.e., <span class="math notranslate nohighlight">\(\delta \equiv \delta (\lambda)\)</span>. This is because opacity sources on the planetary atmosphere absorb different amounts of light at different wavelengths and, therefore, the observed planetary radius <span class="math notranslate nohighlight">\(R_p\)</span> — and thus occulted area during transit, <span class="math notranslate nohighlight">\(\delta\)</span> — is wavelength-dependent (see, e.g., <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018haex.bookE.100K/abstract">Kreidberg 2018</a> for a review). This technique, referred to as <em>transmission spectroscopy</em> in what follows, aims at obtaining those transit depths as a function of wavelength in JWST observations through the study of ultra-precise transit lightcurves at different wavelengths.</p>
<p>Simulated data for NIRISS/SOSS observations targeting a transit of HAT-P-1b have been generated with the help of the <a class="reference external" href="https://github.com/spacetelescope/awesimsoss/"><code class="docutils literal notranslate"><span class="pre">awesimsoss</span></code> simulator</a> by the NIRISS team. These simulations, in turn, have been calibrated using the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/">JWST pipeline</a>. HAT-P-1b is a Guaranteed Time Observations (GTO) target of the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-opportunities-and-policies/jwst-cycle-1-guaranteed-time-observations-call-for-proposals/jwst-gto-observation-specifications/jwst-gto-niriss-observations-table">NIRISS Exploration of the Atmospheric diversity of Transiting exoplanets (NEAT) program</a>, which will be observed using the <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-imager-and-slitless-spectrograph/niriss-observing-modes/niriss-single-object-slitless-spectroscopy">NIRISS/SOSS</a> instrument onboard JWST. This target is also used as an <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-imager-and-slitless-spectrograph/niriss-example-science-programs/niriss-soss-time-series-observations-of-hat-p-1">example science program used in the JWST documentation</a>. If you are not familiar with transiting exoplanet observations and/or with how JWST will observe planetary transits, we encourage you to read through that example science program in order to familiarize yourself with the terminology.</p>
<p>In this notebook, we analyze the 2D spectral products of the JWST pipeline in order to analyze the transmission spectrum of this exoplanet. In particular, the data we take a look at here has been processed by the JWST pipeline up to the <code class="docutils literal notranslate"><span class="pre">assign_wcs</span></code> step of the pipeline’s <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec2.html#calwebb-spec2">Stage 2 processing</a>. The simulations didn’t include flat-fielding, so we don’t apply the flat-field step of the pipeline to them. Although the JWST Pipeline will eventually be able to produce white-light lightcurves, as well as extracted 1D spectra, as of the day of writing of this notebook, the JWST calibration pipeline does not have a spectral extraction algorithm that can deal with the complicated structure of NIRISS/SOSS data. In particular, the <code class="docutils literal notranslate"><span class="pre">SUBSTRIP256</span></code> subarray has data from at least two NIRISS/SOSS orders, which overlap at the reddest wavelengths. An algorithm to properly extract this data is in-the-making, but in this notebook we will be performing our own tracing and extraction of the spectra in order to showcase how to analyze the JWST pipeline products. After extracting the spectrum, we will generate the white-light lightcurves of each order, fit them and compare the extracted parameters to the ones in the literature. Then, we will repeat the procedures for the wavelength-dependent lightcurves, with which we will get the transmission spectrum of the exoplanet.</p>
<p>Before we begin, let’s import some libraries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># General internal libraries:</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial</span> <span class="kn">import</span> <span class="n">chebyshev</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter1d</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">mark_inset</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="c1"># Libraries for plotting, reading data:</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> 
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;ticks&quot;</span><span class="p">)</span> <span class="c1"># Set seaborn &quot;ticks&quot; style for better styled plots</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>
<span class="c1"># Library for some power-spectral density analysis:</span>
<span class="kn">from</span> <span class="nn">astropy.timeseries</span> <span class="kn">import</span> <span class="n">LombScargle</span>

<span class="c1"># Useful library to obtain wavelength map solution from the JWST pipeline:</span>
<span class="kn">from</span> <span class="nn">jwst</span> <span class="kn">import</span> <span class="n">datamodels</span>

<span class="c1"># Corner (for posterior distribution plotting):</span>
<span class="kn">import</span> <span class="nn">corner</span>
<span class="c1"># Juliet (for transit fitting &amp; model evaluation:)</span>
<span class="kn">import</span> <span class="nn">juliet</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="font-color-white-font-spectral-extraction-a-class-anchor-id-extraction-a">
<h2>2.<font color='white'>-</font>Spectral extraction <a class="anchor" id="extraction"></a><a class="headerlink" href="#font-color-white-font-spectral-extraction-a-class-anchor-id-extraction-a" title="Permalink to this heading">#</a></h2>
<section id="a-font-color-white-font-tracing-the-orders-a-class-anchor-id-tracing-a">
<h3>A.<font color='white'>-</font>Tracing the orders<a class="anchor" id="tracing"></a><a class="headerlink" href="#a-font-color-white-font-tracing-the-orders-a-class-anchor-id-tracing-a" title="Permalink to this heading">#</a></h3>
<p>Before we can go ahead and perform spectral extraction of the orders, we need to trace them in order to guide the spectral extraction algorithm on where the spectrum is. Let’s first do some data exploration to understand how we might do this with the complicated spectral profile of NIRISS/SOSS.</p>
<p>The products with which we will be working with are the so-called “rates”. These combine the information of all the groups in a given integration into one number, which is the slope of the up-the-ramp samples in a given integration (so they have units of counts per second). These calibrated data have been already corrected by various inhomogeneities present in the raw JWST data, such as bias and dark current. Let’s download them (or load them if they are already on the same folder as this notebook), along with some supplementary data we will be using for this notebook — if downloading, be patient, as this might take a while (the calibrated data are 12 GB worth of data!):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_data_url</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/soss-transit-spectroscopy&#39;</span>
<span class="n">transit_model_path</span> <span class="o">=</span> <span class="s1">&#39;hp1_model.txt&#39;</span>
<span class="n">transit_fits_results_path</span> <span class="o">=</span> <span class="s1">&#39;transit_spectra_results.pkl&#39;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;calibrated_data_hatp1_transit.fits&#39;</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">base_data_url</span> <span class="o">+</span> <span class="s1">&#39;/data/calibrated_data_hatp1_transit.fits&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;calibrated_data_hatp1_transit.fits&#39;</span><span class="p">)</span>
    
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">transit_model_path</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">base_data_url</span> <span class="o">+</span> <span class="s1">&#39;/data/hp1_tspec.dat&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">transit_model_path</span><span class="p">)</span>
    
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">transit_fits_results_path</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">base_data_url</span> <span class="o">+</span> <span class="s1">&#39;/data/transit_spectra_results.pkl&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">transit_fits_results_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s open the calibrated data, and explore its format and content:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;calibrated_data_hatp1_transit.fits&#39;</span><span class="p">)</span>
<span class="n">hdul</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The data we will be mostly interested in working with is mainly on the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> and <code class="docutils literal notranslate"><span class="pre">ERR</span></code> keys — the former has the science data (the “rates”) and the latter their errors. There is a lot of extra information in these pipeline products (e.g., the wavelength solution is here, as well as the time-stamps of the observations), but we will get to that in time. As can be seen, the <code class="docutils literal notranslate"><span class="pre">SCI</span></code> and <code class="docutils literal notranslate"><span class="pre">ERR</span></code> keys have three dimensions: the 2048 and 256 dimensions are the spatial ones (i.e., the 2D spectral dimensions). 1198, on the other hand, is the number of integrations of this particular simulated observation. This latter dimension is specific to time-series observations data/analysis, as here we are interested in using the rates for each integration separately.</p>
<p>Let’s extract the science data (<code class="docutils literal notranslate"><span class="pre">SCI</span></code>) and errors (<code class="docutils literal notranslate"><span class="pre">ERR</span></code>) then:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">errors</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;ERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<p>There are several ways moving forward to trace the spectrum. In theory, when JWST is on the sky, precise shapes and positions will be available for them, and we could use those. Here, however, we will trace each integration individually, in order to check for possible movements/shape changes of the trace during the observations. Before doing this, however, let’s generate a “median” image by collapsing all the products in time, so as to have a view of the “average” shape of the traces along the entire exposure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">median_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">median_image</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rates (Counts/s)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This plot tells us a lot about how to move forward with the data analysis in general of this dataset. For example, note that although the pipeline has done a good job at removing structure in the data, there is still some structure which appears as vertical strips. This is a well known pattern due to the readout of IR detectors which is typically referred to as “1/f noise”. By eye it seems some simple column-by-column background substraction should take care of that. On top of this, this image tells us a little bit of the care we have to have with tracing. For example, spectra of order 1 and 2 start to overlap around pixel ~750. In addition, we can see how the right side of both traces are the ones that have the most signal, which decreases to the left-hand side (redder wavelengths) — so if we do any kind of iterative tracing, we should perhaps start in those sides of the trace. With tracing we also have to be careful with the sides of the image: both sides have 4 reference pixels each (i.e, pixels 0 to 3 and 2044 to 2048) which are not sensitive to light, so we have to be careful to leave those out of our analyses. Finally, it is important to note that the order in the bottom of this image (order 2) ends rather abruptly at around column 1750; this is actually a problem of the simulations, and not a real feature of the NIRISS/SOSS traces.</p>
<p>Let’s use all of the above to our advantage to trace the spectra of each integration. First, let’s write a small script to get the centroids of each column for each order on each integration. Here we’ll use a very simple algorithm in which we convolve each column with a gaussian filter (in order to smooth the profile, which is rather complex), and then take the centroiding of that filtered image. We repeat this procedure in each of the columns of the image in order to obtain the centroids of the traces, and then we fit them with a polynomial:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trace_spectrum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">ystart</span><span class="p">,</span> <span class="n">profile_radius</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">gauss_filter_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">xend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that non-parametrically traces NIRISS/SOSS spectra. First, to get the centroid at xstart and </span>
<span class="sd">    ystart, it convolves the spatial profile with a gaussian filter, finding its peak through usual flux-weighted </span>
<span class="sd">    centroiding. Next, this centroid is using to find the one left to it through the same algorithm. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: ndarray</span>
<span class="sd">        The image that wants to be traced.</span>
<span class="sd">    xstart: float</span>
<span class="sd">        The x-position (column) on which the tracing algorithm will be started</span>
<span class="sd">    ystart: float</span>
<span class="sd">        The estimated y-position (row) of the center of the trace. An estimate within 10-20 pixels is enough.</span>
<span class="sd">    profile_radius: float</span>
<span class="sd">        Expected radius of the profile measured from its center. Only this region will be used to estimate </span>
<span class="sd">        the centroids of the spectrum.</span>
<span class="sd">    gauss_filter_width: float</span>
<span class="sd">        Width of the gaussian filter used to perform the centroiding of the first column</span>
<span class="sd">    xend: int</span>
<span class="sd">        x-position at which tracing ends. If none, trace all the columns left to xstart.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Define x-axis:</span>
    <span class="k">if</span> <span class="n">xend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xend</span><span class="p">,</span> <span class="n">xstart</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xstart</span><span class="p">)</span>
        
    <span class="c1"># Define y-axis:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Define array that will save centroids at each x:</span>
    <span class="n">ycentroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">xcurrent</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Convolve column with a gaussian filter; remove median before convolving:</span>
        <span class="n">filtered_column</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">image</span><span class="p">[:,</span><span class="n">xcurrent</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">image</span><span class="p">[:,</span><span class="n">xcurrent</span><span class="p">]),</span> <span class="n">gauss_filter_width</span><span class="p">)</span>
        
        <span class="c1"># Find centroid within profile_radius pixels of the initial guess:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">ystart</span><span class="p">)</span><span class="o">&lt;</span><span class="n">profile_radius</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ycentroids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="n">filtered_column</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filtered_column</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ystart</span> <span class="o">=</span> <span class="n">ycentroids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">ycentroids</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try our algorithm first for order 1 (the one on the top). Let’s start it on column 2043 (as columns larger than that have reference pixels, so no signal) which, by eye, has the center of the profile around pixel 70 in the median image. Let’s do it for all integrations, and plot all of them on top of the median image to visually see our results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define variables for the tracing algorithm:</span>
<span class="n">nintegrations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Choose the algorithm to start and end so we don&#39;t include reference pixels:</span>
<span class="n">xstart</span> <span class="o">=</span> <span class="mi">2043</span>
<span class="n">xend</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">ystart</span> <span class="o">=</span> <span class="mi">70</span>

<span class="c1"># Prepare arrays that will save our results:</span>
<span class="n">X1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nintegrations</span><span class="p">,</span> <span class="n">xstart</span><span class="o">-</span><span class="n">xend</span><span class="p">])</span>
<span class="n">Y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nintegrations</span><span class="p">,</span> <span class="n">xstart</span><span class="o">-</span><span class="n">xend</span><span class="p">])</span>

<span class="c1"># Prepare median image plot, on top of which we&#39;ll show the traces:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">median_image</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1"># Iterate tracing through all integrations:</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">Y1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">trace_spectrum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">ystart</span><span class="p">,</span> <span class="n">xend</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">Y1</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Woah, pretty good for such a simple approach! There are evidently some parts of the traces that go a bit off-board. In particular, the trace goes off at values below around 30. Let’s fit a Chebyshev polynomial for each of them so we can smooth the shape a little bit, being careful not to use these pixels that throw the trace off in the fit. We could do some iterative fitting but, as we will see below, this is not terribly important. To select the best order for this polynomial, let’s write a small function that does model selection using the <a class="reference external" href="https://projecteuclid.org/euclid.aos/1176344136">Bayesian Information Criterion</a> (BIC) for each trace, and then select the best order via “majority vote”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_cheby_order</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">min_order</span><span class="p">,</span> <span class="n">max_order</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function selects (and returns) the optimal order of a Chebyshev polynomial using the BIC.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: ndarray</span>
<span class="sd">        Array with the regressors</span>
<span class="sd">    y: ndarray</span>
<span class="sd">        Array with the data</span>
<span class="sd">    min_order: int</span>
<span class="sd">        Minimum order to try</span>
<span class="sd">    max_order: int</span>
<span class="sd">        Maximum order to try</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_order</span><span class="p">,</span> <span class="n">max_order</span><span class="p">)</span>
    <span class="n">bics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">))</span>
    
    <span class="c1"># Fit only non-nans:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebfit</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">RSS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">coeffs</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">bics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">RSS</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bics</span><span class="p">)</span> <span class="o">==</span> <span class="n">bics</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">orders</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Try orders from 1 to 30 in the polynomial for all the traces:</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="n">orders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_cheby_order</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">30</span><span class="p">:],</span> <span class="n">Y1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">30</span><span class="p">:],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    
<span class="c1"># Select best order:</span>
<span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">orders</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best order was: &#39;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

<span class="c1"># Use the best-one as deemed by the BIC to fit all the traces; plot them with median image on top:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">median_image</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">coeffs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nintegrations</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="c1"># Fit only non-nans:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">30</span><span class="p">:]))</span>
    <span class="n">coeffs1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebfit</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">30</span><span class="p">:][</span><span class="n">idx</span><span class="p">],</span> <span class="n">Y1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">30</span><span class="p">:][</span><span class="n">idx</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">30</span><span class="p">:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">30</span><span class="p">:],</span> <span class="n">coeffs1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>That’s pretty good!</p>
<p>Now, we can see how the same procedure is deemed to fail for order 2 (the lower trace) for columns below around 1000. This is because this order quickly starts to overlap with order 1 below this. We will help our algorithm a little bit then by masking the upper trace, and only fitting the trace for values above column 1000. To this end, we will use the same algorithm for obtaining the centroids of the trace but will pass a masked image, containing only the lower trace. To do this, we will multiply all the values below row 80 (i.e., the upper pixels in the plot above) by zero.</p>
<p>We’ll start our algorithm in column 1839 (the edge of the trace here), which has its centroid, by eye, around row 225. We also make sure to stop tracing for pixels smaller than 1000. Let’s see how we do:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">median_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="mi">80</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">80</span><span class="p">:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">xstart</span> <span class="o">=</span> <span class="mi">1839</span>
<span class="n">ystart</span> <span class="o">=</span> <span class="mi">225</span>
<span class="n">xend</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Prepare arrays that will save our results for order 2:</span>
<span class="n">X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nintegrations</span><span class="p">,</span> <span class="n">xstart</span><span class="o">-</span><span class="n">xend</span><span class="p">])</span>
<span class="n">Y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nintegrations</span><span class="p">,</span> <span class="n">xstart</span><span class="o">-</span><span class="n">xend</span><span class="p">])</span>

<span class="c1"># Prepare median image plot, on top of which we&#39;ll show the traces:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">median_image</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1"># Iterate tracing through all integrations:</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">Y2</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">trace_spectrum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">ystart</span><span class="p">,</span> <span class="n">xend</span><span class="o">=</span><span class="n">xend</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">Y2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Pretty good! Let’s smooth the trace, as done for Order 1, with a Chebyshev polynomial. Let’s repeat the same procedure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Try orders from 1 to 30 in the polynomial for all the traces:</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="n">orders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_cheby_order</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">Y2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1"># Select best order:</span>
<span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">orders</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best order was: &#39;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

<span class="c1"># Use the best-one as deemed by the BIC to fit all the traces; plot them with median image on top:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">median_image</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">coeffs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nintegrations</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="c1"># Fit only non-nans:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y2</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
    <span class="n">coeffs2</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebfit</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:][</span><span class="n">idx</span><span class="p">],</span> <span class="n">Y2</span><span class="p">[</span><span class="n">i</span><span class="p">,:][</span><span class="n">idx</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">coeffs2</span><span class="p">[</span><span class="n">i</span><span class="p">,:]),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This looks great! Let’s do a final plot showing the traces corresponding to the first integration on the median image:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">median_image</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">coeffs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Order 1 trace&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orangered&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">coeffs2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Order 2 trace&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>That’s pretty good for such a simple procedure!</p>
<p>How does the trace position change as a function of each integration? Was our integration-by-integration tracing really worthwile? Let’s map this out using the location of the center of the trace as a proxy of the trace shift for each order; let’s use the same (uncontaminated) column for both orders:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Column 1500 seems pretty uncontaminated</span>
<span class="n">x1_median</span><span class="p">,</span> <span class="n">y1_shift</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">)</span>
<span class="n">x2_median</span><span class="p">,</span> <span class="n">y2_shift</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="n">y1_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">x1_median</span><span class="p">,</span> <span class="n">coeffs1</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
    <span class="n">y2_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">x2_median</span><span class="p">,</span> <span class="n">coeffs2</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">shift1</span> <span class="o">=</span> <span class="n">y1_shift</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y1_shift</span><span class="p">)</span>
<span class="n">shift2</span> <span class="o">=</span> <span class="n">y2_shift</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y2_shift</span><span class="p">)</span>
<span class="n">sigma_y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">shift1</span><span class="p">))</span>
<span class="n">sigma_y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">shift2</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> 
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Order 1 shifts (RMS=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">sigma_y1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1"> px)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> 
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Order 2 shifts (RMS=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">sigma_y2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1"> px)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Integration number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Trace shift (pixel)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>It appears that the impact of the tracing in the case of the simulations is, indeed, very small. The pixel shifts of the traces are about 1/500 - 1/1000 of a pixel. Consequently, at least in the simulations outlined here, we pressume these will not have a big impact on the retrieved lightcurves and transmission spectrum.</p>
</section>
<section id="b-font-color-white-font-extracting-the-spectra-a-class-anchor-id-extracting-a">
<h3>B.<font color='white'>-</font>Extracting the spectra<a class="anchor" id="extracting"></a><a class="headerlink" href="#b-font-color-white-font-extracting-the-spectra-a-class-anchor-id-extracting-a" title="Permalink to this heading">#</a></h3>
<p>With our traces at hand, in theory we can now perform simple extraction of the spectra on each integration. Before doing that, however, let’s correct our images for the 1/f-noise patters on a column-by-column basis using the fact that we now know where the spectra is located, so we can mask the traces out of this procedure.</p>
<p>To this end, for each image we will mask all the pixels in a 30-pixel radius around the traces (more or less the radius of the actual portion of the trace that contains flux from the target), and use the remaining pixels to track the column-to-column variations. Let’s apply these corrections to the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We will save the corrected data in a new array, as to keep track of the original dataset:</span>
<span class="n">corrected_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">30</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        
        <span class="c1"># Create mask that will turn to zero values not to be used for background estimation:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">coeffs1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">y1</span> <span class="o">-</span> <span class="n">radius</span> <span class="p">:</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">radius</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            
        <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,:]:</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">coeffs2</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">y2</span> <span class="o">-</span> <span class="n">radius</span> <span class="p">:</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">radius</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            
        <span class="c1"># Use only pixels that are not zero to calculate background through median:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">corrected_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">corrected_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">corrected_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>All right, let’s now see how we did — to this end, let’s check the corrections made on the first integration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Non-corrected image&#39;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Corrected image&#39;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corrected_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Much better! The strips observed in the original image have been corrected quite successfully thanks to our procedure.</p>
<p>Let’s now move forward and write a small script that is able to do simple aperture extraction given a set of x and y coordinates that follow the trace, and loop that through all of our integrations. In theory before doing this we would take care of bad pixels/cosmic rays, but we don’t worry about this on this notebook because (a) cosmic rays have not been included in the simulations made to create this dataset and (b) bad pixels are the same on each image, so they don’t impact any time-varying signal.</p>
<p>First, the aperture extraction function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aperture_extraction</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">aperture_radius</span><span class="p">,</span> <span class="n">background_radius</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">error_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">correct_bkg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes as inputs two arrays (x,y) that follow the trace, </span>
<span class="sd">    and returns the added flux over the defined aperture radius (and its error, if an error image </span>
<span class="sd">    is given as well), substracting in the way any background between the aperture radius and the </span>
<span class="sd">    background radius. The background is calculated by taking the median of the points between the </span>
<span class="sd">    aperture_radius and the background_radius.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: ndarray</span>
<span class="sd">        Image from which the spectrum wants to be extracted</span>
<span class="sd">    x: ndarray</span>
<span class="sd">        Array with the x-axis of the trace (i.e., the columns, wavelength direction)</span>
<span class="sd">    y: ndarray</span>
<span class="sd">        Array with the y-axis of the trace (i.e., rows, spatial direction)</span>
<span class="sd">    aperture_radius: float</span>
<span class="sd">        Distance from the center of the trace at which you want to add fluxes.</span>
<span class="sd">    background_radius: float</span>
<span class="sd">        Distance from the center of the trace from which you want to calculate the background. The </span>
<span class="sd">        background region will be between this radius and the aperture_radius.</span>
<span class="sd">    error_image: ndarray</span>
<span class="sd">        Image with the errors of each pixel value on the image ndarray above</span>
<span class="sd">    correct_bkg: boolean</span>
<span class="sd">        If True, apply background correction. If false, ommit this.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Create array that will save our fluxes:</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        
    <span class="n">max_column</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        
        <span class="c1"># Cut the column with which we&#39;ll be working with:</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variance_column</span> <span class="o">=</span> <span class="n">error_image</span><span class="p">[:,</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">**</span><span class="mi">2</span>
            
        <span class="c1"># Define limits given by the aperture_radius and background_radius variables:</span>
        <span class="k">if</span> <span class="n">correct_bkg</span><span class="p">:</span>
            <span class="n">left_side_bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">background_radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">right_side_bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">max_column</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">background_radius</span><span class="p">])</span>
        <span class="n">left_side_ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">aperture_radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">right_side_ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">max_column</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">aperture_radius</span><span class="p">])</span>
        
        <span class="c1"># Extract background, being careful with edges:</span>
        <span class="k">if</span> <span class="n">correct_bkg</span><span class="p">:</span>
            <span class="n">bkg_left</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">left_side_bkg</span><span class="p">)])</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">left_side_ap</span><span class="p">)])]</span>
            <span class="n">bkg_right</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">right_side_ap</span><span class="p">),</span> <span class="n">max_column</span><span class="p">])</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">right_side_bkg</span><span class="p">),</span> <span class="n">max_column</span><span class="p">])]</span>
            <span class="n">bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkg_left</span><span class="p">,</span> <span class="n">bkg_right</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bkg</span> <span class="o">=</span> <span class="mf">0.</span>
            
        <span class="c1"># Substract it from the column:</span>
        <span class="n">column</span> <span class="o">-=</span> <span class="n">bkg</span>
        
        <span class="c1"># Perform aperture extraction of the background-substracted column, being careful with pixelization </span>
        <span class="c1"># at the edges. First, deal with left side:</span>
        <span class="n">l_decimal</span><span class="p">,</span> <span class="n">l_integer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">modf</span><span class="p">(</span><span class="n">left_side_ap</span><span class="p">)</span>
        <span class="n">l_integer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l_integer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l_decimal</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">l_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">l_decimal</span><span class="p">)</span> <span class="o">*</span> <span class="n">column</span><span class="p">[</span><span class="n">l_integer</span><span class="p">]</span>
            <span class="n">l_limit</span> <span class="o">=</span> <span class="n">l_integer</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">l_fraction_variance</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">l_decimal</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_column</span><span class="p">[</span><span class="n">l_integer</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_decimal</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">*</span> <span class="n">column</span><span class="p">[</span><span class="n">l_integer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">l_limit</span> <span class="o">=</span> <span class="n">l_integer</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">l_fraction_variance</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_decimal</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_column</span><span class="p">[</span><span class="n">l_integer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                
        <span class="c1"># Now right side:</span>
        <span class="n">r_decimal</span><span class="p">,</span> <span class="n">r_integer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">modf</span><span class="p">(</span><span class="n">right_side_ap</span><span class="p">)</span>
        <span class="n">r_integer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_integer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r_decimal</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">r_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">r_decimal</span><span class="p">))</span> <span class="o">*</span> <span class="n">column</span><span class="p">[</span><span class="n">r_integer</span><span class="p">]</span>
            <span class="n">r_limit</span> <span class="o">=</span> <span class="n">r_integer</span>
            <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">r_fraction_variance</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">r_decimal</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_column</span><span class="p">[</span><span class="n">r_integer</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_decimal</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">column</span><span class="p">[</span><span class="n">r_integer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">r_limit</span> <span class="o">=</span> <span class="n">r_integer</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">r_fraction_variance</span> <span class="o">=</span> <span class="p">((</span><span class="n">r_decimal</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance_column</span><span class="p">[</span><span class="n">r_integer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                
        <span class="c1"># Save total flux in current column:</span>
        <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_fraction</span> <span class="o">+</span> <span class="n">r_fraction</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="n">l_limit</span><span class="p">:</span><span class="n">r_limit</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># For the flux error, ommit edge values (contribution to total variance is small nonetheless):</span>
            <span class="n">flux_error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">variance_column</span><span class="p">[</span><span class="n">l_limit</span><span class="p">:</span><span class="n">r_limit</span><span class="p">])</span> <span class="o">+</span> <span class="n">l_fraction_variance</span> <span class="o">+</span> \
                                    <span class="n">r_fraction_variance</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">error_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now extract the spectra. To this end, we have to define an aperture radius for the extraction — we decide to use a 30-pixel aperture extraction, and a 50-pixel background radius. As shown in the following plot, these regions cover both the spectra and also a big chunk of the background region(s):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">median_image</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Order 1 trace&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Order 2 trace&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="o">+</span> <span class="mi">30</span><span class="p">,</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="o">+</span> <span class="mi">30</span><span class="p">,</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s loop over all the integrations, extract the spectra of both orders, and save that to some dictionaries. We note that this will take a while (around 10 minutes). We will save both the spectra and the columns, so we can later relate the latter to wavelength-space:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extraction parameters:</span>
<span class="n">extraction_aperture</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">background_aperture</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Create dictionary:</span>
<span class="n">spectra</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># Generate sub-dictionaries for each order:</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="c1"># Save the X positions for both orders. X positions are the same for all integrations, so </span>
<span class="c1"># we save the ones corresponding to the first integration:</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
<span class="c1"># Create sub-dictionaries that will save the fluxes and the errors on those fluxes:</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])]),</span>\
                                                       <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])])</span>

<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])]),</span>\
                                                                     <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])])</span>

<span class="c1"># Now iterate through all integrations:</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
    <span class="c1"># Trace order 1:</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs1</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
    <span class="c1"># Extract order 1:</span>
    <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> \
                                                         <span class="n">aperture_extraction</span><span class="p">(</span><span class="n">corrected_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">y1</span><span class="p">,</span> 
                                                                             <span class="n">extraction_aperture</span><span class="p">,</span> 
                                                                             <span class="n">error_image</span><span class="o">=</span><span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> 
                                                                             <span class="n">correct_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Same for Order 2:</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span><span class="p">(</span><span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">coeffs2</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
    <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> \
                                                         <span class="n">aperture_extraction</span><span class="p">(</span><span class="n">corrected_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">X2</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">y2</span><span class="p">,</span> 
                                                                             <span class="n">extraction_aperture</span><span class="p">,</span> 
                                                                             <span class="n">error_image</span><span class="o">=</span><span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> 
                                                                             <span class="n">correct_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s plot the spectra of the first integration along with the errorbars:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Order 1 spectrum for the first integration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> \
             <span class="n">yerr</span><span class="o">=</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel column&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts/s&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order 2 spectrum for the first integration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> \
             <span class="n">yerr</span><span class="o">=</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel column&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts/s&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This is pretty good! It is interesting to see how we can actually identify where the contamination from the second order kicks in in the Order 1 spectra (blue) around pixel ~750. This is actually evident from the images above, and something to keep in mind when performing analyses with this data.</p>
<p>Note: the flattening of the spectra for pixels above ~1700 in order 2 is a bug from the simulator.</p>
</section>
<section id="c-time-stamps-and-wavelength-solution">
<h3>C. Time-stamps and wavelength solution<a class="headerlink" href="#c-time-stamps-and-wavelength-solution" title="Permalink to this heading">#</a></h3>
<p>Before continuing to the next step, we need to extract two extra data products that will become useful in our analyses in this notebook: (a) the time-stamps of each integration and (b) the wavelength solution corresponding to each pixel in the frame for Order 1 and Order 2.</p>
<p>The first is the easiest to extract — these will be typically stored in the very same data products of the pipeline we are using here. In particular, recall that each integration is composed of various groups which sample up-the-ramp. These have been, in turn, combined in the rates that we see here. Perhaps the most useful timing measure for those ramps, thus, is the middle of an integration — these can be extracted from the products as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;INT_TIMES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;int_mid_BJD_TDB&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>As for the wavelength solution, there is a particular step in the JWST calibration pipeline that “attaches” this data to the products — these have been attached to our dataset as well. To extract them, one has to re-open the pipeline products with a so-called <code class="docutils literal notranslate"><span class="pre">datamodel</span></code> from the JWST pipeline, that lets you gain access to this information:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exposure</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">SpecModel</span><span class="p">(</span><span class="s1">&#39;calibrated_data_hatp1_transit.fits&#39;</span><span class="p">)</span>

<span class="c1"># Get number of rows and columns on the first integration:</span>
<span class="n">rows</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Prepare map that will save the wavelength corresponding to each pixel in the frame:</span>
<span class="n">wmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">])</span>

<span class="c1"># Save it:</span>
<span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">wmap</span><span class="p">[</span><span class="n">order</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">order</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize this 2D wavelength solution for Order 1 and 2:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order 1 wavelength map&#39;</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wmap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span>
<span class="n">im1</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="n">im1</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">cb1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order 2 wavelength map&#39;</span><span class="p">)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wmap</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:])</span>
<span class="n">im2</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">im2</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
<span class="n">cb2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>One important caveat to have in mind is that the wavelength maps are not strictly vertical, i.e., wavelengths do not align perfectly with the columns of the image for NIRISS/SOSS observations. An easy way to see this is to have an image showing “iso-wavelength” bands — identify pixels that have the same wavelengths and “paint” them in a plot. Let’s do this for Order 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wmap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">wmin</span><span class="p">,</span><span class="n">wmax</span> <span class="o">=</span> <span class="n">w</span><span class="p">,</span><span class="n">w</span><span class="o">+</span><span class="mf">0.005</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">wmap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="n">wmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wmap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">&lt;</span> <span class="n">wmax</span><span class="p">)</span>
    <span class="n">Z</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As can be seen from these maps, this is not extremely critical for NIRISS/SOSS (iso-wavelength bands span ~3 pixels), but it might be important for precise, higher-resolution work to take this into account in the extraction. For our application here, however, we simply take the average wavelength value per column to associate wavelengths with pixels for each order, and we save that to our dictionary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">avg_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wmap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_waves</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)],</span>\
                                                 <span class="n">avg_waves</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s have a final look at the extracted spectra of the first 100 integrations, but now with these wavelengths as x-axis instead of the pixel columns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (um)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts/s&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>That looks pretty good! Let’s deep dive into analyzing the lightcurves that can be extracted from these spectra in the next sections.</p>
</section>
<section id="fitting-analyzing-white-light-lightcurves">
<h3>3. Fitting &amp; analyzing white-light lightcurves<a class="headerlink" href="#fitting-analyzing-white-light-lightcurves" title="Permalink to this heading">#</a></h3>
<p>Having extracted our spectra, we are ready to jump into the “fun” part of this notebook: the analyses of actual simulated NIRISS/SOSS transit lightcurves. Let’s first create the white-light lightcurves of both Order 1 and Order 2 by summing the spectra extracted in the previous section, but on regions on which we know there will be no contamination from overlapping orders. This step is important because the white-light lightcurves help determine the most precise transit parameters for the wavelength-dependent lightcurves, and thus we want to have estimates that are as unbiased as possible.</p>
<p>From the figures above, it seems that for Order 1 pixels below around 300 and above 1300 have virtually no contamination from Order 2. For Order 2, fluxes from pixels above around 1300 also have virtually no contamination from Order 1. Let’s generate the corresponding lightcurves taking that into account:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract order 1 length, create array that will save white-light lightcurve (and errors): </span>
<span class="n">NT1</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lc_order1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT1</span><span class="p">)</span>
<span class="n">lc_errors_order1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT1</span><span class="p">)</span>

<span class="c1"># Same for order 2:</span>
<span class="n">NT2</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lc_order2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT2</span><span class="p">)</span>
<span class="n">lc_errors_order2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT2</span><span class="p">)</span>

<span class="c1"># Indexes of uncontaminated spectra for Order 1 and 2:</span>
<span class="n">idx_uncontaminated1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1300</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">idx_uncontaminated2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>  <span class="o">&gt;</span> <span class="mi">1300</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Sum the fluxes and errors for each order. First, order 1:</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NT1</span><span class="p">):</span>
    <span class="n">lc_order1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">idx_uncontaminated1</span><span class="p">])</span>
    <span class="n">lc_errors_order1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">idx_uncontaminated1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    
<span class="c1"># Now order 2:</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NT2</span><span class="p">):</span>
    <span class="n">lc_order2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">idx_uncontaminated2</span><span class="p">])</span>
    <span class="n">lc_errors_order2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">idx_uncontaminated2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Save median-normalized lightcurves and errors:</span>
<span class="n">median_lc1</span><span class="p">,</span> <span class="n">median_lc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lc_order1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lc_order2</span><span class="p">)</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_order1</span> <span class="o">/</span> <span class="n">median_lc1</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_errors_order1</span> <span class="o">/</span> <span class="n">median_lc1</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_order2</span> <span class="o">/</span> <span class="n">median_lc2</span>
<span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc_errors_order2</span> <span class="o">/</span> <span class="n">median_lc2</span>
<span class="c1"># Write median errors in ppm:</span>
<span class="n">med_err_order1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span>
<span class="n">med_err_order2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span>

<span class="c1"># Save variable with times in units of hours since beggining of observation:</span>
<span class="n">thours</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">24</span>

<span class="c1"># Plot lightcurve</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;White-light lightcurve of HAT-P-1b NIRISS/SOSS observations&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">thours</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">],</span> 
            <span class="n">yerr</span><span class="o">=</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">],</span> 
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> 
            <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Order 1 ($\sigma=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">med_err_order1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">$ ppm)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">thours</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">],</span> 
            <span class="n">yerr</span><span class="o">=</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">],</span> 
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> 
            <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Order 2 ($\sigma=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">med_err_order2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">$ ppm)&#39;</span><span class="p">)</span>

<span class="c1"># Define legend, limits, labels:</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">thours</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">thours</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time since start of observations (hours)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Relative flux&#39;</span><span class="p">)</span>

<span class="c1"># Plot inset to see errorbars:</span>
<span class="n">axins</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.9998</span><span class="p">,</span> <span class="mf">1.0004</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">axins</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">thours</span><span class="p">,</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">],</span> 
               <span class="n">yerr</span><span class="o">=</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">],</span>
               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
               <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="n">axins</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">thours</span><span class="p">,</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">],</span>
               <span class="n">yerr</span><span class="o">=</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">],</span>
               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span>
               <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="n">mark_inset</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axins</span><span class="p">,</span> <span class="n">loc1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Wow! Those look pretty good. There is a notable difference in the overall lightcurve shape here. Part of it can be attributed to limb-darkening (being Order 1 the order covering the reddest wavelengths, limb-darkening produces a more “box-shaped” lightcurve than for Order 2) — but a portion of it could also be explained by the transit depths themselves.</p>
<p>Let’s now fit those transit lightcurves. We will fit them separately to see what we obtain from each order, compare and discuss the results. To perform the transit fitting, users can of course use any tool they want. In this notebook, we will use <code class="docutils literal notranslate"><span class="pre">juliet</span></code> (http://juliet.readthedocs.io/), which is a tool that allows to perform lightcurve fitting through Nested Sampling algorithms, so we can thoroughly explore the parameter space.</p>
<p>We first import <code class="docutils literal notranslate"><span class="pre">juliet</span></code> and write the priors for the parameters of our fit. We will leave the period, <span class="math notranslate nohighlight">\(P\)</span> (<code class="docutils literal notranslate"><span class="pre">P_p1</span></code>) of the orbit fixed. The parameters we will be fitting for are the time-of-transit center <span class="math notranslate nohighlight">\(t_0\)</span> (<code class="docutils literal notranslate"><span class="pre">t0_p1</span></code>), two parameters that parametrize the planet-to-star radius ratio <span class="math notranslate nohighlight">\(R_p/R_*\)</span> and the impact parameter of the orbit <span class="math notranslate nohighlight">\(b = (a/R_*)\cos i\)</span> in a unitary uniform plane, <span class="math notranslate nohighlight">\(r_1\)</span> (<code class="docutils literal notranslate"><span class="pre">r1_p1</span></code>) and <span class="math notranslate nohighlight">\(r_2\)</span> (<code class="docutils literal notranslate"><span class="pre">r2_p1</span></code> — see Espinoza (2018) for details), two parameters that parametrize the limb-darkening through a square-root limb-darkening law, <span class="math notranslate nohighlight">\(q_1\)</span> (<code class="docutils literal notranslate"><span class="pre">q1_SOSS</span></code>) and <span class="math notranslate nohighlight">\(q_2\)</span> (<code class="docutils literal notranslate"><span class="pre">q2_SOSS</span></code> — see Kipping (2013), the stellar density <span class="math notranslate nohighlight">\(\rho_*\)</span> (<code class="docutils literal notranslate"><span class="pre">rho</span></code>), a scaling normalization factor for the out-of-transit flux (<code class="docutils literal notranslate"><span class="pre">mflux_SOSS</span></code>) and an unknown standard deviation added in quadrature to the errorbars of our data, <code class="docutils literal notranslate"><span class="pre">sigma_w_SOSS</span></code>. On top of this, we fix some parameters in our fit as well: we don’t fit for the eccentricity <span class="math notranslate nohighlight">\(e\)</span> (<code class="docutils literal notranslate"><span class="pre">ecc_p1</span></code>) or argument of periastron passage <span class="math notranslate nohighlight">\(\omega\)</span> (<code class="docutils literal notranslate"><span class="pre">omega_p1</span></code>), as a single transit does not hold much information on these parameters. Similarly, we fix any possible dilution of the transit lightcurve by background sources (<code class="docutils literal notranslate"><span class="pre">mdilution_SOSS</span></code>) to 1, so we assume no dilution is in place. We take very wide priors for all the parameters that are left as free parameters in our fit except for the period, which we assume is well-known:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Name of the parameters to be fit:</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;P_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;t0_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;r1_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;r2_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;q1_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;q2_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;ecc_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_p1&#39;</span><span class="p">,</span>
          <span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;mdilution_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;mflux_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_w_SOSS&#39;</span><span class="p">]</span>

<span class="c1"># Distributions:</span>
<span class="n">dists</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
         <span class="s1">&#39;loguniform&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;loguniform&#39;</span><span class="p">]</span>

<span class="c1"># Hyperparameters</span>
<span class="n">hyperps</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.4652998</span><span class="p">,</span> <span class="p">[</span><span class="mf">2459775.89</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> 
           <span class="p">[</span><span class="mf">100.</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">]]</span>

<span class="n">priors</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">generate_priors</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">dists</span><span class="p">,</span> <span class="n">hyperps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Having defined the parameters, priors and the hyperparameters of those priors, we now fit both datasets. For this, we pass the data in a juliet-friendly format, and fit each transit individually:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;order2&#39;</span><span class="p">]:</span>
    <span class="c1"># Define times, fluxes and errors in a juliet-friendly format:</span>
    <span class="n">times</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">fluxes_error</span><span class="p">,</span> <span class="n">norm_times</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="n">times</span><span class="p">[</span><span class="s1">&#39;SOSS&#39;</span><span class="p">],</span> <span class="n">fluxes</span><span class="p">[</span><span class="s1">&#39;SOSS&#39;</span><span class="p">],</span> <span class="n">fluxes_error</span><span class="p">[</span><span class="s1">&#39;SOSS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">],</span>
                                                           <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">],</span>
                                                           <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">]]</span>
    
    <span class="c1"># Load and fit dataset with juliet (save them to order*_juliet_results):</span>
    <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span> <span class="n">t_lc</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">y_lc</span><span class="o">=</span><span class="n">fluxes</span><span class="p">,</span>
                                            <span class="n">yerr_lc</span><span class="o">=</span><span class="n">fluxes_error</span><span class="p">,</span> <span class="n">ld_laws</span><span class="o">=</span><span class="s1">&#39;squareroot&#39;</span><span class="p">,</span>
                                            <span class="n">out_folder</span><span class="o">=</span><span class="n">order</span><span class="o">+</span><span class="s1">&#39;_juliet_results&#39;</span><span class="p">)</span>

    <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">use_dynesty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dynesty_nthreads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see what the fits look like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="s1">&#39;22&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (white) lightcurve&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;order&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="c1"># First, extract estimated additional errorbars form our fits:</span>
    <span class="n">sigma_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;sigma_w_SOSS&#39;</span><span class="p">])</span>
    <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;sigma_w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_w</span>
    
    <span class="c1"># Extract estimated time-of-transit center:</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;t0_p1&#39;</span><span class="p">])</span>
    
    <span class="c1"># Normalize times to plot by this:</span>
    <span class="n">tnorm</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">tnorm</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">],</span> 
                 <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigma_w</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
    
    <span class="c1"># Plot best-fit model on top:</span>
    <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;SOSS&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tnorm</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tnorm</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tnorm</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative flux&#39;</span><span class="p">)</span>
    
    <span class="c1"># Residuals:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="s1">&#39;22&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;white-light&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">tnorm</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span>
                 <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigma_w</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span>
                 <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tnorm</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tnorm</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">350</span><span class="p">,</span> <span class="mi">350</span><span class="p">)</span>
    <span class="n">average_total_errorbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;white-light_errors&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigma_w</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sigma_w = </span><span class="si">{0:.1f}</span><span class="s1">$ ppm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">average_total_errorbar</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals (ppm)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time from mid-transit (hours)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Those look pretty good! The precisions more or less match what is expected from NIRISS/SOSS white-light lightcurves. What about the posterior distribution of the parameters?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Names of the parameters to show in the corner plot:</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$t_0 - Med[t_0]$ (s)&#39;</span><span class="p">,</span><span class="s1">&#39;$R_p/R_s$&#39;</span><span class="p">,</span> <span class="s1">&#39;$b = a \cos i$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\rho_*$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$u_1$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$u_2$&#39;</span><span class="p">]</span>

<span class="c1"># Retrieve posterior distributions of parameters for Order 1:</span>
<span class="n">Theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;t0_p1&#39;</span><span class="p">]),</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">Theta1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;t0_p1&#39;</span><span class="p">]</span>

<span class="c1"># Convert r1 and r2 sampling scheme to rp/rs and b:</span>
<span class="n">b_1</span><span class="p">,</span> <span class="n">rprs_1</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">reverse_bp</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;r1_p1&#39;</span><span class="p">],</span>
                                      <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;r2_p1&#39;</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">Theta1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Theta1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rprs_1</span><span class="p">,</span> <span class="n">b_1</span>

<span class="c1"># Extract stellar density:</span>
<span class="n">Theta1</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span>

<span class="c1"># Convert q1 and q2 sampling to u1 and u2:</span>
<span class="n">u1_1</span><span class="p">,</span> <span class="n">u2_1</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">reverse_ld_coeffs</span><span class="p">(</span><span class="s1">&#39;squareroot&#39;</span><span class="p">,</span>
                                            <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;q1_SOSS&#39;</span><span class="p">],</span>
                                            <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;q2_SOSS&#39;</span><span class="p">])</span>

<span class="n">Theta1</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">Theta1</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">u1_1</span><span class="p">,</span> <span class="n">u2_1</span>

<span class="c1"># Do the same for Order 2:</span>
<span class="n">Theta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;t0_p1&#39;</span><span class="p">]),</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">Theta2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;t0_p1&#39;</span><span class="p">]</span>

<span class="c1"># Convert r1 and r2 sampling scheme to rp/rs and b:</span>
<span class="n">b_2</span><span class="p">,</span> <span class="n">rprs_2</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">reverse_bp</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;r1_p1&#39;</span><span class="p">],</span>
                                      <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;r2_p1&#39;</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">Theta2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Theta2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rprs_2</span><span class="p">,</span> <span class="n">b_2</span>

<span class="c1"># Extract stellar density:</span>
<span class="n">Theta2</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span>

<span class="c1"># Convert q1 and q2 sampling to u1 and u2:</span>
<span class="n">u1_2</span><span class="p">,</span> <span class="n">u2_2</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">reverse_ld_coeffs</span><span class="p">(</span><span class="s1">&#39;squareroot&#39;</span><span class="p">,</span>
                                            <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;q1_SOSS&#39;</span><span class="p">],</span>
                                            <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;q2_SOSS&#39;</span><span class="p">])</span>

<span class="n">Theta2</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">Theta2</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">u1_2</span><span class="p">,</span> <span class="n">u2_2</span>

<span class="c1"># Plot t0 minus combined median t0 for better plotting:</span>
<span class="n">median_t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Theta1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Theta2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">Theta1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Theta1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">median_t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
<span class="n">Theta2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Theta2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">median_t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>

<span class="c1"># Corner plot for redder order (Order 1)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">Theta1</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">)</span>

<span class="c1"># Same for order 2:</span>
<span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">Theta2</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>All right! It seems as if all the posteriors are more or less consistent with each other. However, there is a clear separation in the limb-darkening coefficients plane (despite the average values of the coefficients being consistent) — this is expected; the profiles are expected to be different for both orders given the different wavelength ranges they encompass.</p>
</section>
<section id="a-studying-the-residuals">
<h3>A. Studying the residuals<a class="headerlink" href="#a-studying-the-residuals" title="Permalink to this heading">#</a></h3>
<p>One might wonder if there is any structure in the residuals. This structure can give rise to signals that, if not accounted for, might led us to believe we have a precision that is much better that what the dataset actually has to offer. A classic approach to performing a quick check on the residuals is to see if, as you bin more datapoints, their rms decreases with the square-root of the number of datapoints. If the data is distributed as gaussian random noise, then one should see a <span class="math notranslate nohighlight">\(1/\sqrt{N}\)</span> decline in this plot, where <span class="math notranslate nohighlight">\(N\)</span> is the number of datapoints in a given bin. This is an easy check to make in this case:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">bin_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;order&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="s1">&#39;12&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; residuals as a function of bin-size&#39;</span><span class="p">)</span>
    
    <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_sizes</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_sizes</span><span class="p">)):</span>
        <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_sizes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">binned_times</span><span class="p">,</span> <span class="n">binned_residuals</span><span class="p">,</span> <span class="n">binned_errors</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">bin_data</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">],</span>
                                                                              <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;residuals&#39;</span><span class="p">],</span>
                                                                              <span class="n">bin_size</span><span class="p">)</span>
        <span class="n">rms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">binned_residuals</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1e6</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_sizes</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;White-light lightcurve&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_sizes</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bin_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">rms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bin_sizes</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Expected ($1/\sqrt</span><span class="si">{N}</span><span class="s1">$)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RMS (ppm)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Bin size&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The plots look very promising, but it is hard to see if there is any particular frequency at which we should be paying attention to. What about the power spectrum of the residuals? This basically transforms the time-series to Fourier space where we can actually see if there is any evidence for residual signals at different time-scales/frequencies:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 

<span class="c1"># Define frequencies in hours. From more or less the duration of the observation (~1 over 10 hours) to the </span>
<span class="c1"># time-sampling (~1 over 1 minute, so over 1/60 hours)</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;order&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="s1">&#39;12&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Residuals Power Spectral Density (PSD)&#39;</span><span class="p">)</span>
    
    <span class="n">ls</span> <span class="o">=</span> <span class="n">LombScargle</span><span class="p">((</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;residuals&#39;</span><span class="p">])</span>
    <span class="n">psd</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
    <span class="n">max_power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>
    <span class="n">max_freq</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_power</span> <span class="o">==</span> <span class="n">psd</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fap</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">false_alarm_probability</span><span class="p">(</span><span class="n">max_power</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum power: </span><span class="si">{0:.4f}</span><span class="s1">, frequency: </span><span class="si">{1:.2f}</span><span class="s1">, FAP: </span><span class="si">{2:.2f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_power</span><span class="p">,</span> <span class="n">max_freq</span><span class="p">,</span> <span class="n">fap</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span><span class="n">psd</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Spectral Density&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (1/hr)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">,</span><span class="mf">60.</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>This looks fairly good! There is apparently no clear peak in these power spectral densities, with peaks evenly distributed across all frequencies — i.e., the noise pattern appears to be fairly “white”. We thus move ahead with that hypothesis, and assume there is no residual signal and/or correlated noise in our fits left to mode.</p>
</section>
</section>
<section id="fitting-analyzing-the-wavelength-dependent-lightcurves">
<h2>4. Fitting &amp; analyzing the wavelength-dependent lightcurves<a class="headerlink" href="#fitting-analyzing-the-wavelength-dependent-lightcurves" title="Permalink to this heading">#</a></h2>
<p>One of the main products that ought to be analyzed when observing transits with JWST are the wavelength-dependent lightcurves. Fitting those lets us obtain the final product of our observations: its transmission spectrum. To retrieve this, let us fit the wavelength dependent lightcurves for each order. Unlike as with HST and ground-based low resolution lightcurves, JWST’s precision is so impressive in cases like this that we won’t need to bin the lightcurves — we can work at the (extracted) “pixel”-level!</p>
<p>First, let’s extract those lightcurves, and lets plot them in a slightly different way than above: let’s create a matrix, where the rows are the wavelengths, and the columns are the time-stamps. The values of this matrix will be the relative fluxes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s iterate then to get all the lightcurves:</span>
<span class="n">matrices</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ntimes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;order2&#39;</span><span class="p">]:</span>
    
    <span class="c1"># Create the matrix for each order</span>
    <span class="n">nwavs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
    <span class="n">matrices</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nwavs</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwavs</span><span class="p">):</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Get central wavelength and limits:</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dwav_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">dwav_max</span> <span class="o">=</span> <span class="n">dwav_min</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nwavs</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">dwav_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">dwav_max</span> <span class="o">=</span> <span class="n">dwav_min</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dwav_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">dwav_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
            
        <span class="c1"># Extract lightcurve and errors:</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;flux&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;flux_errors&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Median normalize the extracted fluxes:</span>
        <span class="n">median_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc&#39;</span><span class="p">][:</span><span class="mi">100</span><span class="p">])</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_flux</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc_errors&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_flux</span>
        <span class="n">matrices</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span>

<span class="n">times_hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">24</span>

<span class="c1"># Let&#39;s plot them:</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># First, order 1:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order 1 lightcurves&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time since start of observation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">matrices</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">im1</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.985</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>

<span class="c1"># Y axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]),</span> <span class="mi">250</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>

<span class="c1"># X axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">times_hours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hours since start of observations&#39;</span><span class="p">)</span>

<span class="c1"># Repeat for order 2:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order 2 lightcurves&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time since start of observation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">matrices</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">im2</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mf">0.985</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>

<span class="c1"># Y axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]),</span> <span class="mi">250</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>

<span class="c1"># X axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">times_hours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hours since start of observations&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Relative flux&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Nice! As can be seen, this plot comes very handy. First of all, note how the transit is marked in the dark regions at all wavelengths where it is expected (i.e., where we saw them in the white-light lightcurves — time of transit around 3.5 hours since start of observations). One can actually see how the lightcurves get noisier for longer wavelengths, which makes sense with the image plots (the traces fade to the left of all of our image/trace plots). On top of this, we can see that some lightcurves seem to be a bit noisier/corrupted than usual for Order 1 at the shorter wavelengths. We won’t worry too much about those here, but this is a very important application of this kind of plots, which allow us to visually see outlier lightcurves in one simple image.</p>
<p>Let’s now fit those lightcurves. To this end, we once again use <code class="docutils literal notranslate"><span class="pre">juliet</span></code> — however, we fix the ephemerides and orbital parameters (<span class="math notranslate nohighlight">\(P\)</span>, <span class="math notranslate nohighlight">\(t_0\)</span>, <span class="math notranslate nohighlight">\(a/R_*\)</span> and <span class="math notranslate nohighlight">\(b\)</span>) to those found in the white-light analysis, as they should be wavelength-independent. To this end, we combine the posterior parameters from Orders 1 and 2. In our fits, thus, we only leave the transit depth, the out-of-transit flux and the “jitter” as free parameters.</p>
<p>Let’s first combine the orbital parameters using the posterior distributions of our white-light fits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t0_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;t0_p1&#39;</span><span class="p">],</span>
                                <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;t0_p1&#39;</span><span class="p">]))</span>

<span class="n">b_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_1</span><span class="p">,</span> <span class="n">b_2</span><span class="p">))</span>
<span class="n">rho_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;rho&#39;</span><span class="p">],</span>
                                 <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;rho&#39;</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">t0_median</span><span class="p">,</span> <span class="n">b_median</span><span class="p">,</span> <span class="n">rho_median</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And define the priors of our fit using those:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Name of the parameters to be fit:</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;P_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;t0_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;b_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;q1_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;q2_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;ecc_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_p1&#39;</span><span class="p">,</span>
          <span class="s1">&#39;p_p1&#39;</span><span class="p">,</span> <span class="s1">&#39;mdilution_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;mflux_SOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_w_SOSS&#39;</span><span class="p">]</span>

<span class="c1"># Distributions:</span>
<span class="n">dists</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
         <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;loguniform&#39;</span><span class="p">]</span>

<span class="c1"># Hyperparameters:</span>
<span class="n">hyperps</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.4652997979</span><span class="p">,</span> <span class="n">t0_median</span><span class="p">,</span> <span class="n">rho_median</span><span class="p">,</span> <span class="n">b_median</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span>
           <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">]]</span>

<span class="n">priors</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">generate_priors</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">dists</span><span class="p">,</span> <span class="n">hyperps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And now we ingest those values into our priors, and fit the wavelength-dependent lightcurves. Note that <strong>performing the fitting below with NIRISS/SOSS’ native resolution can take <em>days</em></strong> (we need to run almost 3,000 <code class="docutils literal notranslate"><span class="pre">juliet</span></code> runs). Therefore, it is important to consider parallelizing these runs/fits in a real application.</p>
<p>For simplicity (and speed) in rendering this notebook, we have pickled and uploaded the results of these fits — these were downloaded in the second cell of this notebook above. By default, thus, this notebook will read these downloaded results directly. If you wish to run the fits on your own, however, you can set the <code class="docutils literal notranslate"><span class="pre">use_downloaded_results</span></code> variable below to <code class="docutils literal notranslate"><span class="pre">False</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">use_downloaded_results</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>If the fits are ran, we create a matrix similar to the above, but now for the residuals of the wavelength-dependent light curves. If results were downloaded, these have been already generated, so we just extract them from these products:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If use_downloaded_results is True, read results from downloaded file. If False, run fits and save results.</span>
<span class="n">residual_matrices</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">use_downloaded_results</span><span class="p">:</span>
    <span class="n">transpec_results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">transit_fits_results_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;order2&#39;</span><span class="p">]:</span>
        <span class="n">residual_matrices</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpec_results</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;residual_matrix&#39;</span><span class="p">]</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpec_results</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpec_results</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">]</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpec_results</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span>
        
<span class="k">else</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;order2&#39;</span><span class="p">]:</span>    
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    
        <span class="n">nwavs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
        <span class="n">residual_matrices</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nwavs</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwavs</span><span class="p">):</span>
        
            <span class="c1"># Save dataset in juliet format:</span>
            <span class="n">times</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">fluxes_error</span><span class="p">,</span> <span class="n">norm_times</span> <span class="o">=</span> <span class="p">{},{},{},</span> <span class="p">{}</span>
            <span class="n">times</span><span class="p">[</span><span class="s1">&#39;SOSS&#39;</span><span class="p">],</span> <span class="n">fluxes</span><span class="p">[</span><span class="s1">&#39;SOSS&#39;</span><span class="p">],</span> <span class="n">fluxes_error</span><span class="p">[</span><span class="s1">&#39;SOSS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">],</span>\
                                                              <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc&#39;</span><span class="p">],</span>\
                                                              <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc_errors&#39;</span><span class="p">]</span>
    
            <span class="c1"># Load and fit dataset with juliet (save them to order*_juliet_results):</span>
            <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span> <span class="n">t_lc</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">y_lc</span><span class="o">=</span><span class="n">fluxes</span><span class="p">,</span>
                                                    <span class="n">yerr_lc</span><span class="o">=</span><span class="n">fluxes_error</span><span class="p">,</span> <span class="n">ld_laws</span><span class="o">=</span><span class="s1">&#39;squareroot&#39;</span><span class="p">,</span>
                                                    <span class="n">out_folder</span><span class="o">=</span><span class="n">order</span> <span class="o">+</span> <span class="s1">&#39;_wbin_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_juliet_results&#39;</span><span class="p">)</span>

            <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

            <span class="c1"># Save transmission spectrum for plotting later:</span>
            <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">],</span>
                                                                               <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
        
            <span class="n">depths</span> <span class="o">=</span> <span class="p">((</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;posterior_samples&#39;</span><span class="p">][</span><span class="s1">&#39;p_p1&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
        
            <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">],</span>
                                                                          <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">depths</span><span class="p">))</span>
            <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">],</span>
                                                                          <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">depths</span><span class="p">)))</span>
        
            <span class="c1"># Save residuals:</span>
            <span class="n">residual_matrices</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;wbin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span> <span class="o">-</span> \
                                             <span class="n">spectra</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;SOSS&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1e6</span>
        
<span class="c1"># Plot fits:</span>
<span class="n">fig</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># First, order 1:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order 1 lightcurve residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time since start of observation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">residual_matrices</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">im1</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Y axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]),</span> <span class="mi">250</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>

<span class="c1"># X axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">times_hours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hours since start of observations&#39;</span><span class="p">)</span>

<span class="c1"># Repeat for order 2:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Order 2 lightcurve residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time since start of observation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">residual_matrices</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">im2</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Y axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">]),</span> <span class="mi">250</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>

<span class="c1"># X axis:</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> 
<span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">times_hours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ticklabels</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hours since start of observations&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residuals (ppm)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>All right! That looks <em>great</em>. The residual image seems to be just random noise from the looks of it!</p>
<p>Let’s now see how our transmission spectrum looks. The model transmission spectrum we are using is taken from the ExoCTK website (https://exoctk.stsci.edu/generic), with properties that match that of HAT-P-1b. We’ll plot the original, non-binned spectrum and also plot the binned spectrum on top:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 

<span class="n">nbin</span> <span class="o">=</span> <span class="mi">21</span>

<span class="c1"># Plot order 1 transit spectra:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">],</span>
             <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">],</span>
             <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">],</span>
             <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Bin:</span>
<span class="n">wb1</span><span class="p">,</span> <span class="n">db1</span><span class="p">,</span> <span class="n">db1_err</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">bin_data</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">],</span>
                                          <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order1&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">],</span>
                                          <span class="n">nbin</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wb1</span><span class="p">,</span> <span class="n">db1</span><span class="p">,</span> <span class="n">db1_err</span><span class="p">,</span>
             <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> 
             <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NIRISS/SOSS Order 1&#39;</span><span class="p">)</span>

<span class="c1"># Same, order 2:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">],</span>
             <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">],</span>
             <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">],</span>
             <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span>
             <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">wb2</span><span class="p">,</span> <span class="n">db2</span><span class="p">,</span> <span class="n">db2_err</span> <span class="o">=</span> <span class="n">juliet</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">bin_data</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">],</span>
                                          <span class="n">spectra</span><span class="p">[</span><span class="s1">&#39;order2&#39;</span><span class="p">][</span><span class="s1">&#39;transmission_spectrum&#39;</span><span class="p">][</span><span class="s1">&#39;depths&#39;</span><span class="p">],</span>
                                          <span class="n">nbin</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wb2</span><span class="p">,</span> <span class="n">db2</span><span class="p">,</span> <span class="n">db2_err</span><span class="p">,</span>
             <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> 
             <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NIRISS/SOSS Order 2&#39;</span><span class="p">)</span>

<span class="c1"># Plot the transit spectrum model:</span>
<span class="n">wavelength_model</span><span class="p">,</span> <span class="n">transit_depth_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">transit_model_path</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength_model</span><span class="p">,</span> <span class="n">transit_depth_model</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model spectrum&#39;</span><span class="p">)</span>

<span class="c1"># Mark some features in the plot:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mi">14800</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mi">14600</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.15</span><span class="p">,</span> <span class="mi">14300</span><span class="p">,</span> <span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mi">14500</span><span class="p">,</span> <span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.85</span><span class="p">,</span> <span class="mi">14550</span><span class="p">,</span> <span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">14700</span><span class="p">,</span> <span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

<span class="c1"># Define plot limits:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.54</span><span class="p">,</span> <span class="mf">2.85</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">14000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Transit depth (ppm)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Interesting! There are clear hints of the Na and K features in the blue-optical bandpass of Order 2. The Order 1 transmission spectrum, on the other hand, shows a very clear detection of several water bands in the entire NIRISS/SOSS range. There seems to be some problems at around ~1.75-2 microns where the contamination overlap between order 1 and 2 is largest, which is expected given our simple extraction routine used above.</p>
<p>Overall, these results showcase the power of NIRISS/SOSS observations for targeting both optical and near-infrared features in the transit spectrum of HAT-P-1b.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/soss-transit-spectroscopy"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-introduction-a-class-anchor-id-intro-a">1.<font color="white">-</font>Introduction <a class="anchor" id="intro"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#font-color-white-font-spectral-extraction-a-class-anchor-id-extraction-a">2.<font color="white">-</font>Spectral extraction <a class="anchor" id="extraction"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-font-color-white-font-tracing-the-orders-a-class-anchor-id-tracing-a">A.<font color="white">-</font>Tracing the orders<a class="anchor" id="tracing"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-font-color-white-font-extracting-the-spectra-a-class-anchor-id-extracting-a">B.<font color="white">-</font>Extracting the spectra<a class="anchor" id="extracting"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-time-stamps-and-wavelength-solution">C. Time-stamps and wavelength solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-analyzing-white-light-lightcurves">3. Fitting &amp; analyzing white-light lightcurves</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-studying-the-residuals">A. Studying the residuals</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-analyzing-the-wavelength-dependent-lightcurves">4. Fitting &amp; analyzing the wavelength-dependent lightcurves</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>