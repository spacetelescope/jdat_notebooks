

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>MRS Detector Based Extraction &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/niriss_imaging/niriss-imaging-tutorial.html">NIRISS Imaging Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>MRS Detector Based Extraction</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">MRS Detector Based Extraction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation-to-the-detector-based-extraction-technique">Motivation to the Detector Based Extraction Technique</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-of-the-algorithm">Implementation of the Algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-paths-to-the-data-and-outputs">Set paths to the Data and Outputs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-pipeline">Run Pipeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-to-detect-the-point-source-in-the-detector-image-plane-and-extract-and-plot-the-spectra-for-each-source">Now to detect the point source in the detector image plane and extract and plot the spectra for each source</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-transmission-factor-corresponding-to-source-across-slice-position-beta-the-signal-should-be-multiplied-by-this-factor">Determine transmission factor corresponding to source across-slice position <span class="math notranslate nohighlight">\(\beta\)</span>, the signal should be multiplied by this factor</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-wavelength-correction-due-to-source-across-slice-position-beta">Determine wavelength correction due to source across-slice position <span class="math notranslate nohighlight">\(\beta\)</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-mrs-psf-model-in-the-3d-spectral-cube-and-project-it-on-the-2d-detector">Load MRS PSF model in the 3D spectral cube and project it on the 2D detector</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correct-for-spectral-leak-if-mrs-band-is-set-to-3a">Correct for spectral leak if MRS band is set to 3A</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#caution-in-order-for-the-following-cell-to-work-the-user-must-have-run-this-notebook-already-once-for-band-1b">CAUTION: In order for the following cell to work, the user must have run this notebook already once for band 1B.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-end">THE END</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#still-to-do">Still to do:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this notebook</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="mrs-detector-based-extraction">
<h1>MRS Detector Based Extraction<a class="headerlink" href="#mrs-detector-based-extraction" title="Permalink to this heading">#</a></h1>
<p><font color="red">This notebook currently fails to execute, use as reference only</font></p>
<p><strong>Use case:</strong> This notebook illustrates a spectral extraction technique from detector image plane using a PSF model and the pixel variance. This extraction is considered more advanced than what is currently implemented in the JWST pipeline and is expected to be fully integrated into the pipeline in the future.<br>
<strong>Data:</strong> Simulated <a class="reference external" href="https://jwst-docs.stsci.edu/mid-infrared-instrument/miri-observing-modes/miri-medium-resolution-spectroscopy">MIRI MRS</a> spectrum of AGB star.<br>
<strong>Tools:</strong> jwst, astropy, numpy, scipy.<br>
<strong>Cross-intrument:</strong> No. <br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a> and can be <a class="reference external" href="https://github.com/spacetelescope/dat_pyinthesky/tree/main/jdat_notebooks/MRS_Mstar_analysis">downloaded</a> directly from the <a class="reference external" href="https://github.com/spacetelescope/jdat_notebooks">JDAT Notebook Github directory</a>.<br>
<strong>Source of Simulations:</strong> <a class="reference external" href="https://www.stsci.edu/jwst/science-planning/proposal-planning-toolbox/mirisim">MIRISim</a><br>
<strong>Pipeline Version:</strong> <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-data-reduction-pipeline">JWST Pipeline</a><br></p>
<p><strong>Note</strong>: This notebook includes MIRI simulated data cubes obtained using MIRISim (https://wiki.miricle.org//bin/view/Public/MIRISim_Public) and run through the JWST pipeline (https://jwst-pipeline.readthedocs.io/en/latest/) of point sources with spectra representative of late M type stars.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This notebook analyzes one star represented by a dusty SED corresponding to the ISO SWS spectrum of W Per from Kraemer et al. (2002) and Sloan et al. (2003) to cover the MRS spectral range 5-28 microns.  Analysis of JWST spectral cubes requires extracting spatial-spectral features of interest and measuring their attributes.</p>
<p>This is the first notebook, which will process the data and automatically detect and extract spectra for the point source.  The workflow automatically detects sources on the detector image plane to extract the spectrum of the point source. Then it will read in the spectra generated at Stage 3 of the JWST pipeline.</p>
</section>
<section id="motivation-to-the-detector-based-extraction-technique">
<h2>Motivation to the Detector Based Extraction Technique<a class="headerlink" href="#motivation-to-the-detector-based-extraction-technique" title="Permalink to this heading">#</a></h2>
<p>At present, one-dimensional spectra produced by the JWST pipeline are
constructed exclusively from the combined and rectified 3-dimensional
data cubes.  These data cubes are treated as a collection of images at
various wavelength planes, and simple aperture-based (or effective
PSF-weighted) techniques are used to recover the source intensity as a
function of wavelength in a manner akin to standard imaging PSF
photometry.  However, this method of extracting point source spectra
from data cubes is not ideal; fundamentally, a source with no spatial
structure should not undergo spatial reprocessing prior to extraction of
spectral information.  Indeed, large-scale IFU surveys targeting point
sources rather than extended sources (e.g., SDSS IV/MaStar, R. Yan et
al. 2019) have relied on detector-based spectral extraction rather than
the construction of 3d data cubes.</p>
<p>For the MIRI MRS in particular, such detector-based extraction offers
the opportunity to correct for the following effects which would be
difficult or impossible to handle once the observational data has been
rectified into 3-dimensional cubes:</p>
<ol class="arabic simple">
<li><p>Given the significant undersampling of the MRS, offsets in spaxel
sampling locations as a function of wavelength can alias spatial
structure from the point spread function into spectral artifacts that
bias extracted 1D spectra.  3D cube building is designed in a manner to
mitigate these artifacts, but the act of resampling ensures that 1D
spectra of unresolved sources extracted from 3D cubes can never be as
reliable as 1D spectra extracted directly from detector-level data
without the intermediate resampling step.</p></li>
<li><p>Resampled pixels in the data cubes have significant covariance with
adjacent/nearby pixels.  Treating this covariance properly in the
construction of extracted 1D spectra with flux and variance information
is challenging, and not handled at present by the cube-based spectral
extraction.</p></li>
<li><p>Pipeline calibrations of the instrument throughput and wavelength
calibration are based on sources that fill a given IFU slice, whereas
point sources produce a non-uniform response depending upon the location
of the source centroid within a given IFU slice.  For instance, given
the degeneracy on the detector between the spatial across-slice and
spectral dispersion directions, the wavelength solution for point
sources will differ slightly than for extended sources in a manner that
depends on the source location within the slice.  This effect cannot be
recovered once a 3D cube has been constructed that combines data from
many slices (and indeed, multiple dithered exposures).</p></li>
<li><p>The MRS has a spectral leak in which 2nd order light from 6 microns
(Ch1B) is visible at a few percent transmission in the 12 micron
observations (Ch3A).  This effect is not possible to correct in general,
since the Ch3A field of view is larger than that of Ch1B.  However, for
the specific case of a point source within the common field of view of
all channels it is possible to use the Ch1B spectrum to predict and
subtract the second-order signal from the Ch3A data.</p></li>
</ol>
</section>
<section id="implementation-of-the-algorithm">
<h2>Implementation of the Algorithm<a class="headerlink" href="#implementation-of-the-algorithm" title="Permalink to this heading">#</a></h2>
<p>In this notebook, we implement a method for achieving MIRI MRS
detector-based point source extraction. The formalism behind the method
follows the optimal spectral extraction formalism by Keith Horne 1986.
Extracting a 1d integrated spectrum directly from the MRS detectors
depends on (a) a detailed knowledge of the detector PSF, and (b) the
pixel variance. The MRS detector PSF differs considerably from the
telescope PSF due to the scattering of the photons inside the detector
substrate. How well the detector PSF is understood/modeled/measured is
key in this instance and should not be understated. For the pixel
variance, the slope-fitting uncertainty from the pixel integration
ramp(s) is used. The combination of the detector PSF and pixel variance
is used as a weighing function to weigh the signal in each detector pixel.</p>
<p>In its most basic form, the notebook code assumes that there is only one
point source in the MRS field of view. Using a Gaussian-fitting routine
at detector-level, the centroid of the point source is determined with a
sub-pixel accuracy. The centroid is used to project the known detector
PSF model directly onto the point source signal. The centroid is also
used to derive the throughput and wavelength correction due to the
location of the point source with respect to the imaging slicer of the
MRS. The throughput and wavelength correction are applied before the
spectral extraction step.</p>
<p>The spectral extraction step integrates the point source flux in a
pre-defined list of wavelength bins. All detector pixels contributing to
a wavelength bin are weighed by the projected PSF model -and- the pixel
variance. In case the extracted spectral band is MRS band 3A (around 12
microns) then the following steps are taken:</p>
<ul class="simple">
<li><p>The band 1B (~6 micron) detector image is multiplied by a spectral
leak transmission curve.</p></li>
<li><p>A 1d “spectral leak” integrated point source spectrum is extracted
from band 1B.</p></li>
<li><p>The spectral leak spectrum is subtracted from the band 3A integrated
point source spectrum.</p></li>
</ul>
<p>Future improvements to the code will allow users to input MRS point
source centroid locations to address the case of crowded fields, barely
resolved blended point sources, and point sources located within a
semi-extended environment with spatial structure. In addition, the fine
centroiding, currently performed using a Gaussian distribution, can be
improved by striving for residual minimisation with a master
detector-based PSF model. Such a master PSF model will be derived and
refined throughout commissioning and Cycle 1 calibration.</p>
</section>
<section id="import-packages">
<h2>Import Packages<a class="headerlink" href="#import-packages" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import useful python packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="c1"># Import packages to display images in the notebook</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>    
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Set general plotting options</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span> <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span> 
          <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span> <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span> 
          <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span> <span class="s1">&#39;lines.linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;axes.linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;animation.html&#39;</span><span class="p">:</span> <span class="s1">&#39;html5&#39;</span><span class="p">}</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;figure.max_open_warning&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import astropy packages </span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="c1"># added by BAS on 8 April 2021</span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">get_pkg_data_filename</span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>

<span class="c1"># To find stars in the MRS spectralcubes and do aperture photometry</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">DAOStarFinder</span><span class="p">,</span> <span class="n">CircularAperture</span>

<span class="c1"># To deal with 1D spectrum</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>
<span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">fit_generic_continuum</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">box_smooth</span><span class="p">,</span> <span class="n">extract_region</span><span class="p">,</span> <span class="n">SplineInterpolatedResampler</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">line_flux</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">equivalent_width</span>
<span class="kn">from</span> <span class="nn">specutils.spectra</span> <span class="kn">import</span> <span class="n">SpectralRegion</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">SpectrumList</span>

<span class="c1"># To make nice plots with WCS axis</span>
<span class="c1"># import aplpy</span>

<span class="c1"># To fit a curve to the data</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

<span class="c1"># To download data</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import necessary functions from PointSourceDetectorBasedExtractionFuncs and create_distortionMaps</span>
<span class="kn">from</span> <span class="nn">PointSourceDetectorBasedExtractionFuncs</span> <span class="kn">import</span> <span class="n">mrs_aux</span><span class="p">,</span> <span class="n">point_source_centroiding</span><span class="p">,</span> <span class="n">evaluate_psf_cdp</span>

<span class="c1"># evaluate distortion maps on the 2D detector image plane</span>
<span class="kn">from</span> <span class="nn">create_distortionMaps</span> <span class="kn">import</span> <span class="n">d2cMapping</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-paths-to-the-data-and-outputs">
<h2>Set paths to the Data and Outputs<a class="headerlink" href="#set-paths-to-the-data-and-outputs" title="Permalink to this heading">#</a></h2>
<p>Use MIRISim JWST pipeline processed data in future iterations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds-pub.stsci.edu&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set JWST pipeline paths</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="s1">&#39;crds_cache&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds-pub.stsci.edu&#39;</span>

<span class="c1"># import JWST pipeline</span>
<span class="kn">from</span> <span class="nn">jdaviz.app</span> <span class="kn">import</span> <span class="n">Application</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Detector1Pipeline</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Spec2Pipeline</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Spec3Pipeline</span>
<span class="kn">from</span> <span class="nn">jwst.extract_1d</span> <span class="kn">import</span> <span class="n">Extract1dStep</span>
<span class="kn">from</span> <span class="nn">jwst.associations.lib.rules_level3_base</span> <span class="kn">import</span> <span class="n">DMS_Level3_Base</span>
<span class="kn">from</span> <span class="nn">jwst.associations</span> <span class="kn">import</span> <span class="n">asn_from_list</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">aperture_photometry</span>

<span class="kn">import</span> <span class="nn">asdf</span>
<span class="kn">import</span> <span class="nn">crds</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">glob</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tar_location</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="n">tar_files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;20210413_120546_mirisim.tar.gz&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;20210413_123047_mirisim.tar.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;20210413_125354_mirisim.tar.gz&#39;</span>
<span class="p">]</span>
<span class="n">tar_paths_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">tar_location</span> <span class="o">/</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tar_files</span><span class="p">]</span>

<span class="n">tar_urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/20210413_120546_mirisim.tar.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/20210413_123047_mirisim.tar.gz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/20210413_125354_mirisim.tar.gz&#39;</span>
<span class="p">]</span>


<span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tar_paths_full</span><span class="p">,</span> <span class="n">tar_urls</span><span class="p">):</span>
    <span class="c1"># check for un-tarred version of file</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">stem</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">stem</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> Directory Exists.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># check for tarred version of file and un-tar</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c1"># download file if absent</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>           
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        
        <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create Directories If They Don&#39;t Exist</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;./miri_devel/cdp_data/DISTORTION&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MIRI Reference File Directory Exists.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;./miri_devel/cdp_data/DISTORTION&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Made Directory ./miri_devel/cdp_data/DISTORTION&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="n">data_paths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;spectral_leak_transmission.npy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;W_Per_spectrum_sws.fit&#39;</span><span class="p">,</span>
    <span class="s1">&#39;jwst_miri_photom_0064.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;jwst_miri_photom_0060.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;jwst_miri_photom_0052.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_2SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_2MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_2LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_1SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_1MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_1LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFULONG_3SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFULONG_3MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFULONG_3LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFULONG_4SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFULONG_4MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/MIRI_FM_MIRIFULONG_4LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34LONG_DISTORTION_8B.05.03.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34LONG_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34MEDIUM_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34MEDIUM_DISTORTION_8B.05.03.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34SHORT_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34SHORT_DISTORTION_8B.05.03.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFUSHORT_12LONG_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFUSHORT_12MEDIUM_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFUSHORT_12SHORT_DISTORTION_8B.05.02.fits&#39;</span>
<span class="p">]</span>

<span class="n">data_paths_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_dir</span> <span class="o">/</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">data_paths</span><span class="p">]</span>
<span class="n">data_urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/spectral_leak_transmission.npy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/W_Per_spectrum_sws.fit&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/jwst_miri_photom_0064.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/jwst_miri_photom_0060.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/jwst_miri_photom_0052.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_2SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_2MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_2LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_1SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_1MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFUSHORT_1LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFULONG_3SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFULONG_3MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFULONG_3LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFULONG_4SHORT_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFULONG_4MEDIUM_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/MIRI_FM_MIRIFULONG_4LONG_PSF_07.02.00.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34LONG_DISTORTION_8B.05.03.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34LONG_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34MEDIUM_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34MEDIUM_DISTORTION_8B.05.03.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34SHORT_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFULONG_34SHORT_DISTORTION_8B.05.03.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFUSHORT_12LONG_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFUSHORT_12MEDIUM_DISTORTION_8B.05.02.fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri_devel/cdp_data/DISTORTION/MIRI_FM_MIRIFUSHORT_12SHORT_DISTORTION_8B.05.02.fits&#39;</span>
<span class="p">]</span> 

<span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data_paths_full</span><span class="p">,</span> <span class="n">data_urls</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> exists.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-pipeline">
<h2>Run Pipeline<a class="headerlink" href="#run-pipeline" title="Permalink to this heading">#</a></h2>
<p>The various <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/main.html#pipelines">stages of the pipeline</a> can be <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/introduction.html#running-from-within-python">run within Python</a>.  For a more in depth tutorial on running the pipelines, check out the <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/jwebbinars">JWebbinars</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Execute calwebb_detector1 pipeline on raw simulation output.  This will overwrite previous reductions.</span>

<span class="n">allshortfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;20210413_*_mirisim/det_images/*MIRIFUSHORT*fits&#39;</span><span class="p">)</span>
<span class="n">alllongfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;20210413_*_mirisim/det_images/*MIRIFULONG*fits&#39;</span><span class="p">)</span>
      
<span class="n">pipe1short</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="p">()</span>

<span class="c1"># run calwebb_detector1 on the MIRIFUSHORT data separate from MIRIFULONG data, as it saves time this way</span>
<span class="k">for</span> <span class="n">shortfile</span> <span class="ow">in</span> <span class="n">allshortfiles</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">shortfile</span><span class="p">)</span>
    <span class="n">baseshort</span><span class="p">,</span> <span class="n">remaindershort</span> <span class="o">=</span> <span class="n">shortfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    
    <span class="c1"># If you run your own simulations, you will need to update these hardcoded files.</span>
    <span class="n">beforestuffshort</span><span class="p">,</span> <span class="n">dateafterstuffshort</span> <span class="o">=</span> <span class="n">shortfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;20210413_&#39;</span><span class="p">)</span>    
    <span class="n">datestringshort</span><span class="p">,</span> <span class="n">afterstuffshort</span> <span class="o">=</span> <span class="n">dateafterstuffshort</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_mirisim&#39;</span><span class="p">)</span>
    
    <span class="n">pipe1short</span><span class="o">.</span><span class="n">refpix</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe1short</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">baseshort</span> <span class="o">+</span> <span class="n">datestringshort</span>
    
    <span class="n">pipe1short</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">shortfile</span><span class="p">)</span>

<span class="n">pipe1long</span> <span class="o">=</span> <span class="n">Detector1Pipeline</span><span class="p">()</span>

<span class="k">for</span> <span class="n">longfile</span> <span class="ow">in</span> <span class="n">alllongfiles</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">longfile</span><span class="p">)</span>
    <span class="n">baselong</span><span class="p">,</span> <span class="n">remainderlong</span> <span class="o">=</span> <span class="n">longfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    
    <span class="c1"># If you run your own simulations, you will need to update these hardcoded files.</span>
    <span class="n">beforestufflong</span><span class="p">,</span> <span class="n">dateafterstufflong</span> <span class="o">=</span> <span class="n">longfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;20210413_&#39;</span><span class="p">)</span>
    <span class="n">datestringlong</span><span class="p">,</span> <span class="n">afterstufflong</span> <span class="o">=</span> <span class="n">dateafterstufflong</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_mirisim&#39;</span><span class="p">)</span>
    
    <span class="n">pipe1long</span><span class="o">.</span><span class="n">refpix</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe1long</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">baselong</span> <span class="o">+</span> <span class="n">datestringlong</span>
    
    <span class="n">pipe1long</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">longfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Execute calwebb_spec2 pipeline. This will overwrite previous reductions.</span>

<span class="c1"># All the local calwebb_detector1 files</span>
<span class="n">allshortfiles2</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;det_image_*_MIRIFUSHORT_*_rate.fits&#39;</span><span class="p">)</span>
<span class="n">alllongfiles2</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;det_image_*_MIRIFULONG_*_rate.fits&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">short2file</span> <span class="ow">in</span> <span class="n">allshortfiles2</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">short2file</span><span class="p">)</span>
    <span class="n">pipe2short</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="p">()</span>
    <span class="n">base2short</span><span class="p">,</span> <span class="n">remainder2short</span> <span class="o">=</span> <span class="n">short2file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    
    <span class="n">pipe2short</span><span class="o">.</span><span class="n">straylight</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1"># If you run your own simulations, you will need to update these hardcoded files.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">short2file</span> <span class="o">==</span> <span class="s1">&#39;det_image_seq1_MIRIFUSHORT_12LONGexp1125354_rate.fits&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this one will have the level 2b cube built&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipe2short</span><span class="o">.</span><span class="n">cube_build</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe2short</span><span class="o">.</span><span class="n">extract_1d</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe2short</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">base2short</span>
        
    <span class="n">pipe2short</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">short2file</span><span class="p">)</span>

<span class="k">for</span> <span class="n">long2file</span> <span class="ow">in</span> <span class="n">alllongfiles2</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">long2file</span><span class="p">)</span>
    <span class="n">pipe2long</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="p">()</span>
    <span class="n">base2long</span><span class="p">,</span> <span class="n">remainder2long</span> <span class="o">=</span> <span class="n">long2file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    
    <span class="n">pipe2long</span><span class="o">.</span><span class="n">straylight</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># If you run your own simulations, you will need to update these hardcoded files.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">long2file</span> <span class="o">==</span> <span class="s1">&#39;det_image_seq1_MIRIFULONG_34SHORTexp1120546_rate.fits&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;this one will have the level 2b cube built&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipe2long</span><span class="o">.</span><span class="n">cube_build</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe2long</span><span class="o">.</span><span class="n">extract_1d</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe2long</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">base2long</span>
    
    <span class="n">pipe2long</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">long2file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you run your own simulations, you will need to update these hardcoded files.</span>
<span class="n">l_cube_file</span> <span class="o">=</span> <span class="s1">&#39;det_image_seq1_MIRIFULONG_34SHORTexp1120546_s3d.fits&#39;</span>
<span class="n">s_cube_file</span> <span class="o">=</span> <span class="s1">&#39;det_image_seq1_MIRIFUSHORT_12LONGexp1125354_s3d.fits&#39;</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s_cube_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu_s_cube</span><span class="p">:</span>
    <span class="n">s_cube</span> <span class="o">=</span> <span class="n">hdu_s_cube</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">s_med_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">s_med_cube</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">s_cube</span><span class="p">[:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>

<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">s_med_cube</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

<span class="c1"># Get a list of sources using a dedicated source detection algorithm</span>
<span class="c1"># Find sources at least 3* background (typically)</span>

<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">s_med_cube</span><span class="o">-</span><span class="n">median</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Number of sources in field: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">))</span>

<span class="c1"># Positions in pixels</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]])</span>

<span class="c1"># Convert to RA &amp; Dec (ICRS)</span>
<span class="n">peakpixval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]))</span>
<span class="k">for</span> <span class="n">count_s</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
    <span class="n">peakpixval</span><span class="p">[</span><span class="n">count_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_med_cube</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">][</span><span class="n">count_s</span><span class="p">])),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">][</span><span class="n">count_s</span><span class="p">]))]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;peak pixel x =&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">peakpixval</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;peak pixel y =&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">peakpixval</span><span class="p">)])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">s_med_cube</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">peakpixval</span><span class="p">)],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">peakpixval</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">f0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s_cube_file</span><span class="p">)</span>
<span class="n">w0</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">f0</span><span class="p">[(</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">f0</span><span class="p">)</span>
<span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">radec</span> <span class="o">=</span> <span class="n">w0</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">([</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">peakpixval</span><span class="p">)]],</span> <span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">peakpixval</span><span class="p">)]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Take the brightest source flux and take that to be your primary point source for extraction</span>
<span class="n">ra_ptsrc</span> <span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dec_ptsrc</span> <span class="o">=</span> <span class="n">radec</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Due to the way the pipeline currently extracts Level3 data, you must update the headers to be centered on the point source of your choosing from the step above.</span>
<span class="n">all_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;det_image_*_cal.fits&#39;</span><span class="p">)</span>
<span class="n">targra</span> <span class="o">=</span> <span class="n">ra_ptsrc</span>
<span class="n">targdec</span> <span class="o">=</span> <span class="n">dec_ptsrc</span>
<span class="k">for</span> <span class="n">thisfile</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">thisfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">outfilename</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s1">&#39;_fix.&#39;</span> <span class="o">+</span> <span class="n">remainder</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">thisfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">hduthis</span><span class="p">:</span>
        <span class="n">hduthis</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SRCTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;POINT&#39;</span>
        <span class="n">hduthis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARG_RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targra</span> 
        <span class="n">hduthis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TARG_DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targdec</span>
        <span class="n">hduthis</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up needed reference file(s) for spec3</span>

<span class="n">file_all_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;det_image_*_cal.fits&#39;</span><span class="p">)</span>

<span class="n">asnall</span> <span class="o">=</span> <span class="n">asn_from_list</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">(</span><span class="n">file_all_list</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">DMS_Level3_Base</span><span class="p">,</span> <span class="n">product_name</span><span class="o">=</span><span class="s1">&#39;combine_dithers_all_exposures&#39;</span><span class="p">)</span>

<span class="n">asnallfile</span> <span class="o">=</span> <span class="s1">&#39;for_spec3_all.json&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asnallfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fpall</span><span class="p">:</span>
    <span class="n">fpall</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">asnall</span><span class="o">.</span><span class="n">dump</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Execute calwebb_spec3 pipeline.  This will overwrite previous reductions.</span>

<span class="n">pipe3ss</span> <span class="o">=</span> <span class="n">Spec3Pipeline</span><span class="p">()</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">master_background</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">mrs_imatch</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">outlier_detection</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">resample_spec</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">combine_1d</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">use_source_posn</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">subtract_background</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;allspec3&#39;</span>
<span class="n">pipe3ss</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">asnallfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="now-to-detect-the-point-source-in-the-detector-image-plane-and-extract-and-plot-the-spectra-for-each-source">
<h2>Now to detect the point source in the detector image plane and extract and plot the spectra for each source<a class="headerlink" href="#now-to-detect-the-point-source-in-the-detector-image-plane-and-extract-and-plot-the-spectra-for-each-source" title="Permalink to this heading">#</a></h2>
<p>Steps involved:</p>
<ol class="arabic simple">
<li><p>Convert MJy/sr to Jy</p></li>
<li><p>Determine PSF centroid on the detector plane, if this one is not provided</p></li>
<li><p>Based on the across-slice position of the point source, determine the transmission and wavelength correction factors and apply correction</p></li>
<li><p>Project MRS PSF model from 3D spectral cube to 2D detector image plane</p></li>
<li><p>Determine pixel weights based on PSF and pixel variance information</p></li>
<li><p>Perform detector-based spectral extraction</p></li>
<li><p>If MRS spectral band is 3A (~12.2 micron), determine diffraction grating second order spectral leak contribution (from ~6.1 microns) and apply correction.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># centroid placeholders in local MRS coordinates</span>
<span class="n">alpha_centers2D_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">beta_centers2D_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># spectrum placeholder</span>
<span class="n">isolambda_spec_optimal</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define spectral band</span>
<span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;1B&#39;</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]:</span>
    <span class="n">det_id</span> <span class="o">=</span> <span class="s1">&#39;MIRIFUSHORT&#39;</span>
    <span class="n">band_combo</span> <span class="o">=</span> <span class="s1">&#39;12&#39;</span>
<span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]:</span>
    <span class="n">det_id</span> <span class="o">=</span> <span class="s1">&#39;MIRIFULONG&#39;</span>
    <span class="n">band_combo</span> <span class="o">=</span> <span class="s1">&#39;34&#39;</span>
    
<span class="k">if</span> <span class="n">band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
    <span class="n">band_id</span> <span class="o">=</span> <span class="s1">&#39;short&#39;</span>
    <span class="n">band_id_nr</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">elif</span> <span class="n">band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
    <span class="n">band_id</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span>
    <span class="n">band_id_nr</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">elif</span> <span class="n">band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
    <span class="n">band_id</span> <span class="o">=</span> <span class="s1">&#39;long&#39;</span>
    <span class="n">band_id_nr</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data file SCI and ERR extensions</span>
<span class="k">if</span> <span class="n">band</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1A&#39;</span><span class="p">,</span> <span class="s1">&#39;2A&#39;</span><span class="p">]:</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;det_image_seq1_MIRIFUSHORT_12SHORTexp1120546_cal.fits&#39;</span><span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/jwst_miri_photom_0052.fits&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">hdu_photom</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>  
<span class="k">elif</span> <span class="n">band</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1B&#39;</span><span class="p">,</span> <span class="s1">&#39;2B&#39;</span><span class="p">]:</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;det_image_seq1_MIRIFUSHORT_12MEDIUMexp1123047_cal.fits&#39;</span><span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/jwst_miri_photom_0064.fits&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">hdu_photom</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">band</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1C&#39;</span><span class="p">,</span> <span class="s1">&#39;2C&#39;</span><span class="p">]:</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;det_image_seq1_MIRIFUSHORT_12LONGexp1125354_cal.fits&#39;</span><span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/jwst_miri_photom_0060.fits&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">hdu_photom</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<span class="n">sci_img</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">err_img</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;ERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># load photom PIXSIZ extension to convert MJy/sr to Jansky</span>
<span class="n">pixsiz_img</span> <span class="o">=</span> <span class="n">hdu_photom</span><span class="p">[</span><span class="s1">&#39;PIXSIZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># convert MJy/sr to Jansky for both the SCI and ERR extensions</span>
<span class="n">sci_img</span> <span class="o">=</span> <span class="n">sci_img</span><span class="o">*</span><span class="n">pixsiz_img</span> <span class="c1"># MJy/sr --&gt; MJy</span>
<span class="n">err_img</span> <span class="o">=</span> <span class="n">err_img</span><span class="o">*</span><span class="n">pixsiz_img</span> <span class="c1"># MJy/sr --&gt; MJy</span>

<span class="n">sci_img</span> <span class="o">=</span> <span class="n">sci_img</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span> <span class="c1"># MJy --&gt; Jy</span>
<span class="n">err_img</span> <span class="o">=</span> <span class="n">err_img</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span> <span class="c1"># MJy --&gt; Jy</span>

<span class="c1"># close opened fits files</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">hdu_photom</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Point source corrections CDP values</span>
<span class="c1"># Transmission vs across-slice correction</span>
<span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MRS_Mstar_analysis/miri-ifuptcor-59645.fits&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<span class="n">list_channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CH1&#39;</span><span class="p">,</span> <span class="s1">&#39;CH2&#39;</span><span class="p">,</span> <span class="s1">&#39;CH3&#39;</span><span class="p">,</span> <span class="s1">&#39;CH4&#39;</span><span class="p">]</span>
<span class="n">lamb_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;TRACOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;WAVE_MIN&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">lamb_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;TRACOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;WAVE_MAX&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Tcen_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;TRACOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;T_WMIN_CENTRE&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Tcen_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;TRACOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;T_WMAX_CENTRE&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Tedg_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;TRACOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;T_WMIN_EDGE&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Tedg_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;TRACOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;T_WMAX_EDGE&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Wavelength offset vs across-slice correction</span>
<span class="n">bands</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_OPTICAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SUB_BAND&#39;</span><span class="p">]</span>
<span class="n">x_slice_min_LT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_XSLICE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;XSLICE_MIN&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># micron * arcsec^-1</span>
<span class="n">x_slice_max_LT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_XSLICE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;XSLICE_MAX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># micron * arcsec^-1</span>

<span class="n">beta_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_OPTICAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BETA_SLICE&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">wave_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_OPTICAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;WAVE_MIN&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">wave_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_OPTICAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;WAVE_MAX&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">srp_min</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_OPTICAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SRP_MIN&#39;</span><span class="p">]</span>
<span class="n">srp_max</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_OPTICAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SRP_MAX&#39;</span><span class="p">]</span>

<span class="n">beta_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_SHIFT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BETA_OFF&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">Delta_s_min_LT</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_SHIFT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DS_MIN&#39;</span><span class="p">]</span>
<span class="n">Delta_s_max_LT</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVCORR_SHIFT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DS_MAX&#39;</span><span class="p">]</span>

<span class="c1"># Spectral leak (second order spectral response in form of an optical system transmission)</span>
<span class="n">sys_transm_img</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define path to distortion (D2C) files (and create folder if it doesn&#39;t exist)</span>
<span class="n">workDir</span> <span class="o">=</span> <span class="s1">&#39;./miri_devel/&#39;</span>
<span class="n">cdpDir</span> <span class="o">=</span> <span class="n">workDir</span><span class="o">+</span><span class="s1">&#39;cdp_data/&#39;</span>
<span class="n">d2cDir</span> <span class="o">=</span> <span class="n">cdpDir</span><span class="o">+</span><span class="s1">&#39;DISTORTION/&#39;</span>

<span class="c1"># Evaluate largest distortion solution on the 2D detector (lowest slice transmission)</span>
<span class="n">d2cMaps</span> <span class="o">=</span> <span class="n">d2cMapping</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">d2cDir</span><span class="p">,</span> <span class="n">slice_transmission</span><span class="o">=</span><span class="s1">&#39;10pc&#39;</span><span class="p">,</span> <span class="n">fileversion</span><span class="o">=</span><span class="s2">&quot;8B.05.02&quot;</span><span class="p">)</span>
<span class="n">sliceMap</span> <span class="o">=</span> <span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;sliceMap&#39;</span><span class="p">]</span>
<span class="n">lambdaMap</span> <span class="o">=</span> <span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;lambdaMap&#39;</span><span class="p">]</span>
<span class="n">alphaMap</span> <span class="o">=</span> <span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;alphaMap&#39;</span><span class="p">]</span>
<span class="n">betaMap</span> <span class="o">=</span> <span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;betaMap&#39;</span><span class="p">]</span>
<span class="n">nslices</span> <span class="o">=</span> <span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;nslices&#39;</span><span class="p">]</span>

<span class="c1"># some auxiliary data</span>
<span class="n">det_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1032</span><span class="p">)</span>
<span class="n">bandlims</span> <span class="o">=</span> <span class="p">[</span><span class="n">lambdaMap</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lambdaMap</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="c1"># spectral grid based on which the point source centroid is determined</span>
<span class="n">lambmin</span> <span class="o">=</span> <span class="n">mrs_aux</span><span class="p">(</span><span class="n">band</span><span class="p">)[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lambmax</span> <span class="o">=</span> <span class="n">mrs_aux</span><span class="p">(</span><span class="n">band</span><span class="p">)[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="n">lambcens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lambmin</span><span class="p">,</span> <span class="n">lambmax</span><span class="p">,</span> <span class="p">(</span><span class="n">lambmax</span><span class="o">-</span><span class="n">lambmin</span><span class="p">)</span><span class="o">/</span><span class="mf">1024.</span><span class="p">)</span>
<span class="n">lambfwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lambcens</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">lambmax</span><span class="o">-</span><span class="n">lambmin</span><span class="p">)</span><span class="o">/</span><span class="mf">1024.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Determine point source centroid</span>
<span class="n">sign_amp2D</span><span class="p">,</span> <span class="n">alpha_centers2D</span><span class="p">,</span> <span class="n">beta_centers2D</span><span class="p">,</span> <span class="n">sigma_alpha2D</span><span class="p">,</span> <span class="n">sigma_beta2D</span><span class="p">,</span> <span class="n">bkg_amp2D</span> <span class="o">=</span> <span class="n">point_source_centroiding</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">sci_img</span><span class="p">,</span> <span class="n">d2cMaps</span><span class="p">,</span> <span class="n">spec_grid</span><span class="o">=</span><span class="p">[</span><span class="n">lambcens</span><span class="p">,</span> <span class="n">lambfwhms</span><span class="p">],</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;2D&#39;</span><span class="p">)</span>

<span class="n">alpha_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_centers2D</span>
<span class="n">beta_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta_centers2D</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Diagnostic plot for the point source centroid: We care about the mean value of alpha, beta. These will be used for the PSF projection on the detector plane.</span>
<span class="c1"># Conceivably a PSF residual algorithm could be coded, to determine the alpha,beta centroid more accurately still.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambcens</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">alpha_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambcens</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lambcens</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">alpha_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambcens</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">beta_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lambcens</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lambcens</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">beta_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">]),</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Along-slice position $\alpha$ [arcsec]&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MRS Band </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\mu m$]&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Across-slice position $\beta$ [arcsec]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="determine-transmission-factor-corresponding-to-source-across-slice-position-beta-the-signal-should-be-multiplied-by-this-factor">
<h1>Determine transmission factor corresponding to source across-slice position <span class="math notranslate nohighlight">\(\beta\)</span>, the signal should be multiplied by this factor<a class="headerlink" href="#determine-transmission-factor-corresponding-to-source-across-slice-position-beta-the-signal-should-be-multiplied-by-this-factor" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">beta_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">])</span>
<span class="n">wav_array</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">Tb_min</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">Tb_max</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">Tdiff_point</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">Tdiff_extended</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;CH1&#39;</span><span class="p">,</span> <span class="s1">&#39;CH2&#39;</span><span class="p">,</span> <span class="s1">&#39;CH3&#39;</span><span class="p">,</span> <span class="s1">&#39;CH4&#39;</span><span class="p">]):</span>
    <span class="n">wav_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lamb_min</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lamb_max</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">0.01</span><span class="p">)</span> <span class="c1"># micron</span>
    <span class="n">Tb_min</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tcen_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tedg_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">Tcen_min</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">Tb_max</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tcen_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tedg_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">Tcen_max</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">Tdiff_point</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tb_min</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">wav_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">-</span><span class="n">lamb_min</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lamb_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">lamb_min</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tb_max</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">-</span><span class="n">Tb_min</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="n">Tdiff_extended</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tcen_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">Tedg_max</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">((</span><span class="n">wav_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">-</span><span class="n">lamb_min</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">lamb_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">lamb_min</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="p">((</span><span class="n">Tcen_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">Tedg_max</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">Tcen_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">Tedg_min</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">2.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CH1&#39;</span><span class="p">,</span> <span class="s1">&#39;CH2&#39;</span><span class="p">,</span> <span class="s1">&#39;CH3&#39;</span><span class="p">,</span> <span class="s1">&#39;CH4&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Tdiff_point</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Tdiff_extended</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\mu m$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Transmission correction [%]&#39;</span><span class="p">)</span>
<span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Point source correction ($\beta$ = </span><span class="si">{}</span><span class="s1"> arcsec)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mi">2</span><span class="p">))),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Extended source correction&#39;</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CH1&#39;</span><span class="p">,</span> <span class="s1">&#39;CH2&#39;</span><span class="p">,</span> <span class="s1">&#39;CH3&#39;</span><span class="p">,</span> <span class="s1">&#39;CH4&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Tdiff_point</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="n">Tdiff_extended</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\mu m$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\zeta$ = Tdiff_point / Tdiff_extended&#39;</span><span class="p">)</span>
<span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\beta$ = </span><span class="si">{}</span><span class="s1"> arcsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;CH&#39;</span> <span class="o">+</span> <span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ip_zeta</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Tdiff_point</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="n">Tdiff_extended</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

<span class="n">zetaMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lambdaMap</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">sliceMap</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sliceMap</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">zetaMap</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip_zeta</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">[</span><span class="n">sel</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zetaMap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">zetaMap</span><span class="p">[</span><span class="n">zetaMap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">zetaMap</span><span class="p">[</span><span class="n">zetaMap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\zeta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply correction to science and error signal</span>
<span class="n">sci_img</span> <span class="o">*=</span> <span class="n">zetaMap</span>
<span class="n">err_img</span> <span class="o">*=</span> <span class="n">zetaMap</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="determine-wavelength-correction-due-to-source-across-slice-position-beta">
<h1>Determine wavelength correction due to source across-slice position <span class="math notranslate nohighlight">\(\beta\)</span><a class="headerlink" href="#determine-wavelength-correction-due-to-source-across-slice-position-beta" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">beta_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">])</span>

<span class="c1"># determine unique beta values for each slice</span>
<span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sliceMap</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sliceMap</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">unique_betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">betaMap</span><span class="p">[</span><span class="n">sel</span><span class="p">])</span>

<span class="c1"># find index of value nearest to beta center in the unique_betas array</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unique_betas</span><span class="o">-</span><span class="n">beta_center</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> 
<span class="n">source_center_slice</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span>

<span class="c1"># find index of value nearest to beta center in the unique_betas array</span>
<span class="n">beta_brightest_slice</span> <span class="o">=</span> <span class="n">unique_betas</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="c1"># Point source offset from slice centre (-0.5 &lt; tgtOffset &lt; +0.5)</span>
<span class="n">betaOffsetSlice0</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_center</span><span class="o">-</span><span class="n">beta_brightest_slice</span><span class="p">)</span><span class="o">/</span><span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;bdel&#39;</span><span class="p">]</span> 

<span class="c1"># Define input data characteristics.</span>
<span class="n">nSubBands</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">optIndex</span> <span class="o">=</span> <span class="n">nSubBands</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">band_id_nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">betaSlice</span> <span class="o">=</span> <span class="n">beta_slice</span><span class="p">[</span><span class="n">optIndex</span><span class="p">]</span>

<span class="c1"># Compute wavelength correction map (based on MIRI-DD-00006-ATC issue 4)</span>
<span class="c1"># The correction is valid only for the two slices nearest to the brightest slice</span>
<span class="n">wavcorr_across_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1032</span><span class="p">))</span>
<span class="k">for</span> <span class="n">islice</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">sliceMap</span> <span class="o">==</span> <span class="mi">100</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">source_center_slice</span><span class="o">+</span><span class="n">islice</span><span class="p">)</span>
    <span class="n">tgtWave</span> <span class="o">=</span> <span class="n">lambdaMap</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
    
    <span class="c1"># Step 1. Find target offset from slice centre in beta direction&#39;</span>
    <span class="n">betaOff</span> <span class="o">=</span> <span class="n">betaOffsetSlice0</span> <span class="o">-</span> <span class="n">islice</span>

    <span class="c1"># Step 2. Calculate Xslice</span>
    <span class="n">xSlice</span> <span class="o">=</span> <span class="n">betaSlice</span> <span class="o">/</span> <span class="n">tgtWave</span>
    <span class="n">xSliceref</span> <span class="o">=</span> <span class="n">betaSlice</span> <span class="o">/</span> <span class="p">((</span><span class="n">lambmin</span><span class="o">+</span><span class="n">lambmax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="c1"># We define a reference xslice for the entire band to avoid jumps between beta_off values as a function of wavelength in Step 4.</span>

    <span class="c1"># Step 3. Derive scaled offset</span>
    <span class="n">betaOff_scaled</span> <span class="o">=</span> <span class="n">betaOff</span> <span class="o">*</span> <span class="n">xSlice</span>
    <span class="n">betaOff_scaled_ref</span> <span class="o">=</span> <span class="n">betaOff</span> <span class="o">*</span> <span class="n">xSliceref</span>  <span class="c1"># We define a reference betaOff_scaled_ref for the entire band to avoid jumps between beta_off values as a function of wavelength in Step 4.</span>

    <span class="c1"># Step 4. Find look-up table betaOff_LT values which bracket betaOFF_scaled</span>
    <span class="n">nShiftValues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta_off</span><span class="p">)</span>
    <span class="n">betaSign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">betaOff</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="n">betaSign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">betaOff_scaled</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">betaOff_scaled</span>
    <span class="n">indexA</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Index in look up table_WCORR_SHIFT </span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nShiftValues</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">betaOff_scaled_ref</span> <span class="o">&lt;</span> <span class="n">beta_off</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">indexA</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">indexA</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">indexB</span> <span class="o">=</span> <span class="n">indexA</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">betaOff_LT_A</span> <span class="o">=</span> <span class="n">beta_off</span><span class="p">[</span><span class="n">indexA</span><span class="p">]</span>
    <span class="n">betaOff_LT_B</span> <span class="o">=</span> <span class="n">beta_off</span><span class="p">[</span><span class="n">indexB</span><span class="p">]</span>

    <span class="c1"># Step 5. Find ds_min and ds_max</span>
    <span class="n">betaFactor</span> <span class="o">=</span> <span class="p">(</span><span class="n">betaOff_scaled</span> <span class="o">-</span> <span class="n">betaOff_LT_A</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">betaOff_LT_B</span> <span class="o">-</span> <span class="n">betaOff_LT_A</span><span class="p">)</span> 

    <span class="n">ds_minA</span> <span class="o">=</span> <span class="n">Delta_s_min_LT</span><span class="p">[</span><span class="n">indexA</span><span class="p">]</span>
    <span class="n">ds_minB</span> <span class="o">=</span> <span class="n">Delta_s_min_LT</span><span class="p">[</span><span class="n">indexB</span><span class="p">]</span>
    <span class="n">ds_min</span> <span class="o">=</span> <span class="n">ds_minA</span> <span class="o">+</span> <span class="n">betaFactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">ds_minB</span> <span class="o">-</span> <span class="n">ds_minA</span><span class="p">)</span>
    <span class="n">ds_min</span> <span class="o">=</span> <span class="n">betaSign</span> <span class="o">*</span> <span class="n">ds_min</span>

    <span class="n">ds_maxA</span> <span class="o">=</span> <span class="n">Delta_s_max_LT</span><span class="p">[</span><span class="n">indexA</span><span class="p">]</span>
    <span class="n">ds_maxB</span> <span class="o">=</span> <span class="n">Delta_s_max_LT</span><span class="p">[</span><span class="n">indexA</span><span class="p">]</span>
    <span class="n">ds_max</span> <span class="o">=</span> <span class="n">ds_maxA</span> <span class="o">+</span> <span class="n">betaFactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">ds_maxB</span> <span class="o">-</span> <span class="n">ds_maxA</span><span class="p">)</span>
    <span class="n">ds_max</span> <span class="o">=</span> <span class="n">betaSign</span> <span class="o">*</span> <span class="n">ds_max</span>

    <span class="c1"># Step 6. Find ds by interpolation between ds_min and ds_max</span>
    <span class="n">xSlice_min</span> <span class="o">=</span> <span class="n">x_slice_min_LT</span>
    <span class="n">xSlice_max</span> <span class="o">=</span> <span class="n">x_slice_max_LT</span>
    <span class="n">xFactor</span> <span class="o">=</span> <span class="p">(</span><span class="n">xSlice</span> <span class="o">-</span> <span class="n">xSlice_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xSlice_max</span> <span class="o">-</span> <span class="n">xSlice_min</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds_min</span> <span class="o">+</span> <span class="n">xFactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">ds_max</span> <span class="o">-</span> <span class="n">ds_min</span><span class="p">)</span>

    <span class="c1"># Step 7. Convert ds to wavelength shift by intepolstion between SRP values</span>
    <span class="n">w_min</span> <span class="o">=</span> <span class="n">wave_min</span><span class="p">[</span><span class="n">optIndex</span><span class="p">]</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="n">wave_max</span><span class="p">[</span><span class="n">optIndex</span><span class="p">]</span>
    <span class="n">wFactor</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgtWave</span> <span class="o">-</span> <span class="n">w_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w_max</span> <span class="o">-</span> <span class="n">w_min</span><span class="p">)</span>

    <span class="n">srp</span> <span class="o">=</span> <span class="n">srp_min</span><span class="p">[</span><span class="n">optIndex</span><span class="p">]</span> <span class="o">+</span> <span class="n">wFactor</span> <span class="o">*</span> <span class="p">(</span><span class="n">srp_max</span><span class="p">[</span><span class="n">optIndex</span><span class="p">]</span> <span class="o">-</span> <span class="n">srp_min</span><span class="p">[</span><span class="n">optIndex</span><span class="p">])</span>

    <span class="n">wavcorr_across_slice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span> <span class="o">*</span> <span class="n">tgtWave</span> <span class="o">/</span> <span class="n">srp</span>

<span class="c1"># Plot wavelength correction map</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wavcorr_across_slice</span><span class="p">)</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Wavelength correction [$</span><span class="se">\u03bc</span><span class="s1"> m$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MRS spectral band </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply correction to wavelength map</span>
<span class="n">lambdaMap</span> <span class="o">+=</span> <span class="n">wavcorr_across_slice</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="load-mrs-psf-model-in-the-3d-spectral-cube-and-project-it-on-the-2d-detector">
<h1>Load MRS PSF model in the 3D spectral cube and project it on the 2D detector<a class="headerlink" href="#load-mrs-psf-model-in-the-3d-spectral-cube-and-project-it-on-the-2d-detector" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_fits_file</span> <span class="o">=</span> <span class="n">cdpDir</span><span class="o">+</span><span class="s2">&quot;MIRI_FM_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}{}</span><span class="s2">_PSF_07.02.00.fits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">band_id</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<span class="n">psffits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">psf_fits_file</span><span class="p">)</span>

<span class="c1"># normalize and project PSF on 2D detector (normalization ensures that each cube slice of the model has a signal sum of 1)</span>
<span class="n">psf_img</span> <span class="o">=</span> <span class="n">evaluate_psf_cdp</span><span class="p">(</span><span class="n">psffits</span><span class="p">,</span> <span class="n">d2cMaps</span><span class="p">,</span> <span class="n">source_center</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">alpha_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">beta_centers2D_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">])],</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># close fits file</span>
<span class="n">psffits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Diagnostic plot to show how well the projected PSF matches the data</span>
<span class="c1"># For low SNR observations this will likely not be very useful</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">if</span> <span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sci_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">516</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MIRISim signal&#39;</span><span class="p">)</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">sci_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">516</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sci_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">516</span><span class="p">])]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">psf_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">516</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psf_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">516</span><span class="p">]</span><span class="o">*</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSF model (scaled)&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sci_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">516</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MIRISim signal&#39;</span><span class="p">)</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">sci_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">516</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sci_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">516</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">])]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">psf_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">516</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psf_img</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">516</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSF model (scaled)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Signal [DN/sec]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MRS spectral band </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Determine optimal pixel weights for detector-based spectral extraction</span>
<span class="n">weight_map</span> <span class="o">=</span> <span class="n">psf_img</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">err_img</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Wavelength array used for the detector-based spectral extraction</span>
<span class="c1"># The grid step is approximately half the smallest spectral size in each band (due to the MRS distortion and slice curvature, different pixels contribute to each bin)</span>
<span class="n">wav_array</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1A&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">4.9</span><span class="p">,</span> <span class="mf">5.74</span><span class="p">,</span> <span class="mf">0.0005</span><span class="p">),</span> <span class="s1">&#39;1B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">5.67</span><span class="p">,</span> <span class="mf">6.6</span><span class="p">,</span> <span class="mf">0.0008</span><span class="p">),</span> <span class="s1">&#39;1C&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">6.45</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">),</span>
             <span class="s1">&#39;2A&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">7.477</span><span class="p">,</span> <span class="mf">8.765</span><span class="p">,</span> <span class="mf">0.0014</span><span class="p">),</span> <span class="s1">&#39;2B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">8.711</span><span class="p">,</span> <span class="mf">10.228</span><span class="p">,</span> <span class="mf">0.0017</span><span class="p">),</span> <span class="s1">&#39;2C&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">10.017</span><span class="p">,</span> <span class="mf">11.753</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">),</span>
             <span class="s1">&#39;3A&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">11.481</span><span class="p">,</span> <span class="mf">13.441</span><span class="p">,</span> <span class="mf">0.0023</span><span class="p">),</span> <span class="s1">&#39;3B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">13.319</span><span class="p">,</span> <span class="mf">15.592</span><span class="p">,</span> <span class="mf">0.0026</span><span class="p">),</span> <span class="s1">&#39;3C&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">15.4</span><span class="p">,</span> <span class="mf">18.072</span><span class="p">,</span> <span class="mf">0.0030</span><span class="p">),</span>
             <span class="s1">&#39;4A&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">17.651</span><span class="p">,</span> <span class="mf">20.938</span><span class="p">,</span> <span class="mf">0.0036</span><span class="p">),</span> <span class="s1">&#39;4B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">20.417</span><span class="p">,</span> <span class="mf">24.22</span><span class="p">,</span> <span class="mf">0.0042</span><span class="p">),</span> <span class="s1">&#39;4C&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">23.884</span><span class="p">,</span> <span class="mf">28.329</span><span class="p">,</span> <span class="mf">0.0048</span><span class="p">)}</span>
<span class="n">nwavs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>

<span class="c1"># Evaluate smallest distortion solution on the 2D detector (largest slice transmission of 90%)</span>
<span class="n">slice_transmission</span> <span class="o">=</span> <span class="s1">&#39;90pc&#39;</span>
<span class="n">d2cMaps</span> <span class="o">=</span> <span class="n">d2cMapping</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">d2cDir</span><span class="p">,</span> <span class="n">slice_transmission</span><span class="o">=</span><span class="n">slice_transmission</span><span class="p">,</span> <span class="n">fileversion</span><span class="o">=</span><span class="s2">&quot;8B.05.02&quot;</span><span class="p">)</span>
<span class="n">lambdaMap</span> <span class="o">=</span> <span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;lambdaMap&#39;</span><span class="p">]</span>
<span class="n">lambdas</span> <span class="o">=</span> <span class="n">lambdaMap</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># Need approximate number of pixels contributing to each spectral bin</span>
<span class="c1"># This is because only one pixel is used for each detector column --&gt; we want to avoid sampling issues</span>
<span class="k">if</span> <span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">slice_transmission</span> <span class="o">==</span> <span class="s1">&#39;90pc&#39;</span><span class="p">:</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="mi">380</span>
    <span class="k">elif</span> <span class="n">slice_transmission</span> <span class="o">==</span> <span class="s1">&#39;10pc&#39;</span><span class="p">:</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="mi">500</span>
<span class="k">elif</span> <span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]:</span>
    <span class="n">npix</span> <span class="o">=</span> <span class="mi">380</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>

<span class="c1"># Define pixel grid</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1032</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
<span class="n">X_flat</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">Y_flat</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Omit NaNs from analysis</span>
<span class="n">nan_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sci_img</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Diffraction grating second order spectral leak contribution</span>
<span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;1B&#39;</span><span class="p">:</span>
    
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;spectral_leak_transmission.npy&#39;</span><span class="p">,</span> <span class="n">sys_transm_img</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sys_transm_img</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
    <span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Dichroic transmission [%]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X-pixel&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y-pixel&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Compute spectral leak signal from band 1B and update the error map</span>
    <span class="n">spectral_leak_sci_img</span> <span class="o">=</span> <span class="n">sci_img</span><span class="o">*</span><span class="n">sys_transm_img</span>
    <span class="n">spectral_leak_err_img</span> <span class="o">=</span> <span class="n">err_img</span><span class="o">*</span><span class="n">sys_transm_img</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">spectral_leak_sci_img</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Spectral leak signal [mJy]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X-pixel&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y-pixel&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Redetermine optimal pixel weights for detector-based spectral extraction</span>
    <span class="n">spectral_leak_weight_map</span> <span class="o">=</span> <span class="n">psf_img</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">spectral_leak_err_img</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c1"># Initialize placeholder</span>
    <span class="n">spectral_leak_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwavs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform detector-based spectral extraction</span>
<span class="n">isolambda_spec_optimal</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwavs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwavs</span><span class="p">):</span>
    <span class="c1"># determine pixels contributing to spectral bin</span>
    <span class="n">test_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1032</span><span class="p">))</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span><span class="o">-</span><span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]))[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">test_img</span><span class="p">[</span><span class="n">Y_flat</span><span class="p">[</span><span class="n">idxs</span><span class="p">],</span> <span class="n">X_flat</span><span class="p">[</span><span class="n">idxs</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># ascertain that only one pixel is selected per detector column</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outliers</span><span class="p">:</span>
        <span class="n">Y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">test_img</span><span class="p">[</span><span class="n">Y_</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># plot meant for debugging !!!ONLY USE AT A SINGLE WAVELENGTH!!!</span>
    <span class="c1"># plt.figure()</span>
    <span class="c1"># plt.imshow(test_img,aspect=0.5)</span>
    <span class="c1"># plt.tight_layout()</span>

    <span class="c1"># spectral extraction</span>
    <span class="n">sel_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_img</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">nan_idx</span>
    <span class="n">isolambda_spec_optimal</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">]</span> <span class="o">*</span> <span class="n">sci_img</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">]</span> <span class="o">/</span> <span class="n">psf_img</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weight_map</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;1B&#39;</span><span class="p">:</span>
        <span class="c1"># Estimate diffraction grating second order spectral leak contribution</span>
        <span class="n">spectral_leak_spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectral_leak_weight_map</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">]</span> <span class="o">*</span> <span class="n">spectral_leak_sci_img</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">]</span> <span class="o">/</span> <span class="n">psf_img</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectral_leak_weight_map</span><span class="p">[</span><span class="n">sel_valid</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># debugging spectral bins</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">200</span>
<span class="c1"># determine pixels contributing to spectral bin</span>
<span class="n">test_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1032</span><span class="p">))</span>
<span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdas</span><span class="o">-</span><span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]))[</span><span class="n">k</span><span class="p">]</span>
<span class="n">test_img</span><span class="p">[</span><span class="n">Y_flat</span><span class="p">[</span><span class="n">idxs</span><span class="p">],</span> <span class="n">X_flat</span><span class="p">[</span><span class="n">idxs</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># ascertain that only one pixel is selected per detector column</span>
<span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outliers</span><span class="p">:</span>
    <span class="n">Y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lambdaMap</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span><span class="o">-</span><span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">test_img</span><span class="p">[</span><span class="n">Y_</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">d2cMaps</span><span class="p">[</span><span class="s1">&#39;sliceMap&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MRS spectral band </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare resulting extracted spectrum to result from JWST-pipeline-reconstructed spectrum and original ISO spectrum</span>
<span class="c1"># Disclaimer: Due to flux conservation issues in MIRISim, the  MIRISim MRS PSF is broader than the MRS PSF CDP model. </span>
<span class="c1"># This results on the detector-based spectrum having a significantly higher spectral baseline.</span>

<span class="c1"># JWST pipeline result</span>
<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;combine_dithers_all_exposures_ch</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_x1d.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">band_id</span><span class="p">))</span>
<span class="n">wav</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">]</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Original ISO spectrum</span>
<span class="n">W_Per_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;W_Per_spectrum_sws.fit&#39;</span><span class="p">)</span>
<span class="n">wav_WPer</span> <span class="o">=</span> <span class="n">W_Per_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">flux_WPer</span> <span class="o">=</span> <span class="n">W_Per_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">sel_WPer</span> <span class="o">=</span> <span class="p">(</span><span class="n">wav_WPer</span> <span class="o">&gt;</span> <span class="n">lambmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wav_WPer</span> <span class="o">&lt;</span> <span class="n">lambmax</span><span class="p">)</span>
<span class="n">W_Per_hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Plot</span>
<span class="k">if</span> <span class="n">band</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1A&#39;</span><span class="p">,</span> <span class="s1">&#39;1B&#39;</span><span class="p">,</span> <span class="s1">&#39;1C&#39;</span><span class="p">]:</span>
    <span class="n">fudge_factor</span> <span class="o">=</span> <span class="mf">28.5</span>
<span class="k">elif</span> <span class="n">band</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2A&#39;</span><span class="p">,</span> <span class="s1">&#39;2B&#39;</span><span class="p">,</span> <span class="s1">&#39;2C&#39;</span><span class="p">]:</span>
    <span class="n">fudge_factor</span> <span class="o">=</span> <span class="mi">45</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;combine_dithers_all_exposures&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">isolambda_spec_optimal</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">/</span><span class="n">fudge_factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Single dither detector-based extraction (scaled)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_WPer</span><span class="p">[</span><span class="n">sel_WPer</span><span class="p">],</span> <span class="n">flux_WPer</span><span class="p">[</span><span class="n">sel_WPer</span><span class="p">]</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ISO SWS spectrum of W Per&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength&#39;</span> <span class="sa">u</span><span class="s1">&#39;[$</span><span class="se">\u03bc</span><span class="s1"> m$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Signal [Jy]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MRS spectral band </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;1B&#39;</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">isolambda_spec_optimal</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original signal band 1B&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_array</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">spectral_leak_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Estimated spectral leak&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [$</span><span class="se">\u03bc</span><span class="s1"> m$]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Spectral flux density [Jy]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MRS spectral band 1B&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="correct-for-spectral-leak-if-mrs-band-is-set-to-3a">
<h2>Correct for spectral leak if MRS band is set to 3A<a class="headerlink" href="#correct-for-spectral-leak-if-mrs-band-is-set-to-3a" title="Permalink to this heading">#</a></h2>
</section>
<section id="caution-in-order-for-the-following-cell-to-work-the-user-must-have-run-this-notebook-already-once-for-band-1b">
<h2>CAUTION: In order for the following cell to work, the user must have run this notebook already once for band 1B.<a class="headerlink" href="#caution-in-order-for-the-following-cell-to-work-the-user-must-have-run-this-notebook-already-once-for-band-1b" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;3A&#39;</span><span class="p">:</span>
    <span class="n">spectral_leak_corr_band3A</span> <span class="o">=</span> <span class="n">isolambda_spec_optimal</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-</span><span class="n">spectral_leak_spectrum</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="the-end">
<h1>THE END<a class="headerlink" href="#the-end" title="Permalink to this heading">#</a></h1>
<section id="still-to-do">
<h2>Still to do:<a class="headerlink" href="#still-to-do" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Loop the notebook over all dither positions and average the resulting spectra. The reason why we may not want to use all four dithers in one go (i.e. to run the detector based extraction only once) is because we will likely find variations in the PSF as a function of which slice gets illuminated on the detector (think incoming cone angle and detector-scattered light).</p></li>
<li><p>Consider updating current centroiding algorithm to use the cross-correlation method of the SDSS MANGA pipeline.</p></li>
</ul>
</section>
<section id="about-this-notebook">
<h2>About this notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Author:</strong> Ioannis (Yannis) Argyriou, Post-Doctoral Researcher, Institute of Astronomy, KU Leuven, Belgium<br />
<strong>Date:</strong> 2022-01-08</p>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/MIRI/MRS_Mstar_analysis"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">MRS Detector Based Extraction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation-to-the-detector-based-extraction-technique">Motivation to the Detector Based Extraction Technique</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-of-the-algorithm">Implementation of the Algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-packages">Import Packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-paths-to-the-data-and-outputs">Set paths to the Data and Outputs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-pipeline">Run Pipeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-to-detect-the-point-source-in-the-detector-image-plane-and-extract-and-plot-the-spectra-for-each-source">Now to detect the point source in the detector image plane and extract and plot the spectra for each source</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-transmission-factor-corresponding-to-source-across-slice-position-beta-the-signal-should-be-multiplied-by-this-factor">Determine transmission factor corresponding to source across-slice position <span class="math notranslate nohighlight">\(\beta\)</span>, the signal should be multiplied by this factor</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-wavelength-correction-due-to-source-across-slice-position-beta">Determine wavelength correction due to source across-slice position <span class="math notranslate nohighlight">\(\beta\)</span></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-mrs-psf-model-in-the-3d-spectral-cube-and-project-it-on-the-2d-detector">Load MRS PSF model in the 3D spectral cube and project it on the 2D detector</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correct-for-spectral-leak-if-mrs-band-is-set-to-3a">Correct for spectral leak if MRS band is set to 3A</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#caution-in-order-for-the-following-cell-to-work-the-user-must-have-run-this-notebook-already-once-for-band-1b">CAUTION: In order for the following cell to work, the user must have run this notebook already once for band 1B.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-end">THE END</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#still-to-do">Still to do:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this notebook</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>