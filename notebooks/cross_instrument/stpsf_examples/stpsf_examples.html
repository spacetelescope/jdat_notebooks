

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>JWST Using Wavefronts Measured On Orbit &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/cross_instrument/stpsf_examples/stpsf_examples';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="MRS Cube Analysis" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html" />
    <link rel="prev" title="Improving Accuracy of World Coordinate System of Pure Parallel Dataset" href="../update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">STPSF Examples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/cross_instrument/stpsf_examples/stpsf_examples.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/cross_instrument/stpsf_examples/stpsf_examples.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>JWST Using Wavefronts Measured On Orbit</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#index">Index</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-setup">Imports and Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-measured-wavefront-near-a-given-date">Finding the measured wavefront near a given date</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#opd-file-description">OPD File description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#delta-wavefront-error-around-time-of-observation">Delta Wavefront Error Around Time of Observation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-a-psf-simulation-using-a-particular-observation">Setup a PSF simulation using a particular observation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trending-wavefront-changes-over-time">Trending Wavefront Changes over Time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wavefront-time-series-and-histogram-plots">Wavefront time series and histogram plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-all-opds">Table of all OPDs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trending-plots">Trending Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-over-a-time-range">Plot over a time range</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-plot-a-single-opd">Load and plot a Single OPD</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#jwst-simulated-psf-subtraction-from-in-flight-data">JWST Simulated PSF Subtraction from in-flight data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-a-subarray-around-source-of-interest-and-measure-source-location">Extract a subarray around source of interest, and measure source location</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-the-source">Find the source</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-previous-function-to-set-up-our-simulation">Use previous function to set up our simulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-photutils-to-create-our-model-psf">Use photutils to create our model PSF</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-location-of-the-source-to-be-subtracted">Check the location of the source to be subtracted</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subtract-psf-and-create-residual-image">Subtract PSF and create residual image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-properties-and-differences">PSF properties and differences</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#improved-ifu-sims">Improved IFU sims</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="jwst-using-wavefronts-measured-on-orbit">
<h1>JWST Using Wavefronts Measured On Orbit<a class="headerlink" href="#jwst-using-wavefronts-measured-on-orbit" title="Permalink to this heading">#</a></h1>
<p>STPSF, formerly knows as WebbPSF, includes code for using the results of in-flight wavefront sensing measurements, by retrieving Optical Path Difference (OPD) files. These can be used to create simulated PSFs appropriate for a given instrument, detector, and time.</p>
<p>This notebook serves as a reference for how to use STPSF to search for and retrieve an OPD file, and explains the contents of this file. It also shows how to load multiple OPD files and plot changes in the wavefront properties over time. It also contains an example case of using an OPD file to create and subtract a simulated PSF from an in-flight image.</p>
<p>Details on the use of STPSF’s in-flight OPDs are given here:
https://stpsf.readthedocs.io/en/latest/jwst_measured_opds.html</p>
<p>Author: Marcio Melendez Hernandez<br>
Last Updated: 13 Feb 2025</p>
<section id="index">
<h2>Index<a class="headerlink" href="#index" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><span class="xref myst">Imports and Setup</span></p></li>
<li><p><span class="xref myst">Finding the measured wavefront near a given date</span></p></li>
<li><p><span class="xref myst">OPD File description</span></p></li>
<li><p><span class="xref myst">Delta Wavefront Error Around Time of Observation</span></p></li>
<li><p><span class="xref myst">Setup a PSF simulation using a particular observation</span></p></li>
<li><p><span class="xref myst">Trending Wavefront Changes over Time</span></p></li>
<li><p><span class="xref myst">Wavefront time series and histogram plots</span></p>
<ul>
<li><p><span class="xref myst">Table of all OPDs</span></p></li>
<li><p><span class="xref myst">Trending Plots</span></p></li>
<li><p><span class="xref myst">Plot over a time range</span></p></li>
<li><p><span class="xref myst">Load and plot a Single OPD</span></p></li>
</ul>
</li>
<li><p><span class="xref myst">JWST Simulated PSF Subtraction from in-flight data</span></p>
<ul>
<li><p><span class="xref myst">Extract a subarray around source of interest, and measure source location</span></p></li>
<li><p><span class="xref myst">Find the source</span></p></li>
<li><p><span class="xref myst">Use previous function to set up our simulation</span></p></li>
<li><p><span class="xref myst">Use photutils to create our model PSF</span></p></li>
<li><p><span class="xref myst">Subtract PSF and create residual image</span></p></li>
<li><p><span class="xref myst">PSF properties and differences</span></p></li>
</ul>
</li>
<li><p><span class="xref myst">Improved IFU Sims</span></p></li>
</ul>
<p>For other STPSF examples:
https://stpsf.readthedocs.io/en/latest/more_examples.html</p>
</section>
<section id="imports-and-setup">
<h2>Imports and Setup<a class="headerlink" href="#imports-and-setup" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pylab</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">poppy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">stpsf</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cutout2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">SigmaClip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization.mpl_normalize</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageNormalize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogStretch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">photutils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">MedianBackground</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">IRAFStarFinder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSFPhotometry</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Files containing such information as the JWST pupil shape, instrument throughputs, and aperture positions are distributed separately from STPSF.</span>
<span class="c1"># To run STPSF, you must download these files and tell STPSF where to find them using the STPSF_PATH environment variable.</span>

<span class="c1"># Set environmental variables</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;STPSF_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./data/stpsf-data&quot;</span>

<span class="c1"># STPSF Data</span>
<span class="n">stpsf_url</span> <span class="o">=</span> <span class="s1">&#39;https://stsci.box.com/shared/static/kqfolg2bfzqc4mjkgmujo06d3iaymahv.gz&#39;</span>
<span class="n">stpsf_file</span> <span class="o">=</span> <span class="s1">&#39;./stpsf-data-LATEST.tar.gz&#39;</span>
<span class="n">stpsf_folder</span> <span class="o">=</span> <span class="s2">&quot;./data&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported URL scheme: </span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>


<span class="c1"># Gather stpsf files</span>
<span class="n">stpsfExist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stpsf_folder</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">stpsfExist</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stpsf_folder</span><span class="p">)</span>
    <span class="n">download_file</span><span class="p">(</span><span class="n">stpsf_url</span><span class="p">,</span> <span class="n">stpsf_file</span><span class="p">)</span>
    <span class="n">gzf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stpsf_file</span><span class="p">)</span>
    <span class="n">gzf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">stpsf_folder</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="finding-the-measured-wavefront-near-a-given-date">
<h2>Finding the measured wavefront near a given date<a class="headerlink" href="#finding-the-measured-wavefront-near-a-given-date" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nrc</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">NIRCam</span><span class="p">()</span>
<span class="n">nrc</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>

<span class="n">nrc</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="s1">&#39;NRCB2&#39;</span>
<span class="n">nrc</span><span class="o">.</span><span class="n">detector_position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The interpixel capacitance effect is now included for oversampled outputs as well as for the detector-sampled outputs (in the geometric distortion extension). Remember that, in general, the last (“DET_DIST”) FITS extension of the output PSF FITS file are the output data product that most represents the PSF as actually observed on a detector.
In any case, there are way to disable any detector effects or to adjust the empirical approximation of charge difussion. For example:
<code class="docutils literal notranslate"><span class="pre">nrc.options['charge_diffusion_sigma']</span> <span class="pre">=</span> <span class="pre">0</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">nrc.options['add_ipc']</span> <span class="pre">=</span> <span class="pre">False</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">nrc</span><span class="o">.</span><span class="n">load_wss_opd_by_date</span><span class="p">(</span><span class="s1">&#39;2022-07-01T00:00:00&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
<span class="c1"># choice : string . Default &#39;closest&#39;</span>
<span class="c1"># Method to choose which OPD file to use, e.g. &#39;before&#39;, &#39;after&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Upper Left: This is the measured OPD as sensed in NIRCam at “field point 1” which is in the upper left corner of NRCA3, relatively close to the center of the NIRCam module. This observatory total OPD measurement includes both the telescope and NIRCam contributions to the WFE.</p></li>
<li><p>Upper Middle: This is the wavefront map for the NIRCam portion of the WFE at that field point. This is known from ground calibration test data, not measured in flight.</p></li>
<li><p>Upper Right: That NIRCam WFE contribution is subtracted from the total observatory WFE to yield this estimate of the OTE-only portion of the WFE.</p></li>
<li><p>Lower Left and Middle: These are models for the field dependence of the OTE OPD between the sensing field point in NRCA3 and the requested field ooint, in this case in NRCB2. This field dependence arises mostly from the figure of the tertiary mirror. These are used to transform the estimated OTE OPD from one field position to another.</p></li>
<li><p>Lower Right: This is the resulting estimate for the OTE OPD at the requested field point, in this case in NRCB2.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># What&#39;s inside an OPD?</span>
<span class="n">opd_fn</span> <span class="o">=</span> <span class="s1">&#39;R2022070403-NRCA3_FP1-0.fits&#39;</span>
<span class="n">opd</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">opd_fn</span><span class="p">))</span>

<span class="n">opd</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>

<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">opd</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">opd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">opd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="opd-file-description">
<h2>OPD File description<a class="headerlink" href="#opd-file-description" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>RESULT_PHASE Image Extension.
The FITS file contains a ‘RESULT’ image extension, which is the average of the optical path difference results from all images analyzed together in the phase retrieval</p></li>
<li><p>RESULT_PSF Image Extension
The FITS file contains a ‘RESULT_PSF’ image extension, which is the PSF computed from the resultant phase by the WAS</p></li>
<li><p>EXPECTED Image Extension
The FITS file contains an ‘EXPECTED’ image extension, which is the expected optical path difference if the WAS-recommended correction is applied</p></li>
<li><p>PUPIL_MASK Image Extension
The FITS file contains a ‘PUPIL_MASK’ image extension, which is the pupil mask used to compute the PSF from the resultant phase</p></li>
</ul>
<p><b>The FITS file contains five image extensions for each analyzed input image. In the case of the sensing program, there are 2 images +/-8WL</b></p>
<ul class="simple">
<li><p>RAW_PSF Image Extensions
For each input image, the Raw PSF extension will contain the raw extracted subimage taken from the calibrated science data</p></li>
<li><p>CALC_PSF Image Extensions
For each input image, the Calculated PSF extension will contain an image which represents the estimated PSF as calculated by the phase retrieval process</p></li>
<li><p>CALC_AMP Image Extension
For each input image, the Calculated Amplitude extension will contain an image which represents the estimated pupil amplitude as calculated by the phase retrieval process</p></li>
<li><p>HO_PHASE Image Extension
For each input image, the High-Order Phase extension will contain an image which represents the retrieved phase information minus the Low-Order (controllable) phase as calculated by the phase retrieval process.</p></li>
<li><p>LO_PHASE Image Extension
For each input image, the Low-Order Phase extension will contain an image which represents the retrieved controllable phase information as calculated by the phase retrieval process</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s simulate Webb&#39;s PSF from the OPD above</span>
<span class="c1"># The PSF below is calculated using the actual </span>
<span class="c1"># as-measured-at-L2 state of the telescope WFE near </span>
<span class="c1"># the requested date, in this case 2022 July 1.</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">fov_pixels</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">stpsf</span><span class="o">.</span><span class="n">display_psf</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="delta-wavefront-error-around-time-of-observation">
<h2>Delta Wavefront Error Around Time of Observation<a class="headerlink" href="#delta-wavefront-error-around-time-of-observation" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stpsf</span><span class="o">.</span><span class="n">trending</span><span class="o">.</span><span class="n">delta_wfe_around_time</span><span class="p">(</span><span class="s1">&#39;2024-05-11 01:50:25.231&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setup-a-psf-simulation-using-a-particular-observation">
<h2>Setup a PSF simulation using a particular observation<a class="headerlink" href="#setup-a-psf-simulation-using-a-particular-observation" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mast_retrieve_files</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download files from MAST.</span>
<span class="sd">    If file is already present locally, the download is skipped and the cached file is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPError</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mast</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="n">Mast</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>

    <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">redownload</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found file previously downloaded: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_filename</span>

    <span class="n">data_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;mast:JWST/product/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="c1"># Download the file</span>
    <span class="n">url_path</span> <span class="o">=</span> <span class="n">Mast</span><span class="o">.</span><span class="n">_portal_api_connection</span><span class="o">.</span><span class="n">MAST_DOWNLOAD_URL</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Mast</span><span class="o">.</span><span class="n">_download_file</span><span class="p">(</span><span class="n">url_path</span> <span class="o">+</span> <span class="s2">&quot;?uri=&quot;</span> <span class="o">+</span> <span class="n">data_uri</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_filename</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;jw04500-o056_t012_nircam_f212n-wlm8-nrca3_wfscmb-04.fits&#39;</span>
<span class="n">mast_retrieve_files</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inst</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">setup_sim_to_match_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span> <span class="c1"># source position</span>
<span class="n">size_pixels</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1"># size in pixels</span>
<span class="n">inst</span><span class="o">.</span><span class="n">detector_position</span> <span class="o">=</span> <span class="n">position</span>

<span class="n">single_stpsf_nrc</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">fov_pixels</span><span class="o">=</span><span class="n">size_pixels</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="trending-wavefront-changes-over-time">
<h2>Trending Wavefront Changes over Time<a class="headerlink" href="#trending-wavefront-changes-over-time" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trend_table</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">trending</span><span class="o">.</span><span class="n">monthly_trending_plot</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trend_table</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="wavefront-time-series-and-histogram-plots">
<h2>Wavefront time series and histogram plots<a class="headerlink" href="#wavefront-time-series-and-histogram-plots" title="Permalink to this heading">#</a></h2>
<section id="table-of-all-opds">
<h3>Table of all OPDs<a class="headerlink" href="#table-of-all-opds" title="Permalink to this heading">#</a></h3>
<p><b>Retrieve a table of all available OPDs and plot the measurements over time</b></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opdtable</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">mast_wss</span><span class="o">.</span><span class="n">retrieve_mast_opd_table</span><span class="p">()</span>

<span class="n">opdtable</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">mast_wss</span><span class="o">.</span><span class="n">deduplicate_opd_table</span><span class="p">(</span><span class="n">opdtable</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opdtable</span>
</pre></div>
</div>
</div>
</div>
<p><b>Download all the OPDs from the opdtable object. Note that some functions need to have all the OPDs available. </b></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stpsf</span><span class="o">.</span><span class="n">mast_wss</span><span class="o">.</span><span class="n">download_all_opds</span><span class="p">(</span><span class="n">opdtable</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="trending-plots">
<h3>Trending Plots<a class="headerlink" href="#trending-plots" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stpsf</span><span class="o">.</span><span class="n">trending</span><span class="o">.</span><span class="n">wavefront_time_series_plot</span><span class="p">(</span><span class="n">opdtable</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-over-a-time-range">
<h3>Plot over a time range<a class="headerlink" href="#plot-over-a-time-range" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="s1">&#39;2022-11-22&#39;</span><span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="s1">&#39;2022-12-01&#39;</span><span class="p">)</span>
<span class="n">stpsf</span><span class="o">.</span><span class="n">trending</span><span class="o">.</span><span class="n">wavefront_time_series_plot</span><span class="p">(</span><span class="n">opdtable</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                                          <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                                          <span class="n">label_visits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label_events</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can also plot all measured wavefront drifts over specified time periods</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="s1">&#39;2024-01-01T00:00:00&#39;</span><span class="p">)</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">stpsf</span><span class="o">.</span><span class="n">trending</span><span class="o">.</span><span class="n">wavefront_drift_plots</span><span class="p">(</span><span class="n">opdtable</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span> <span class="n">n_per_row</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can plot histograms of wavefront error levels over time</span>
<span class="n">stpsf</span><span class="o">.</span><span class="n">trending</span><span class="o">.</span><span class="n">wfe_histogram_plot</span><span class="p">(</span><span class="n">opdtable</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">ote_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or select a particular time period</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="s1">&#39;2024-04-01&#39;</span><span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">stpsf</span><span class="o">.</span><span class="n">trending</span><span class="o">.</span><span class="n">wfe_histogram_plot</span><span class="p">(</span><span class="n">opdtable</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">ote_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-and-plot-a-single-opd">
<h3>Load and plot a Single OPD<a class="headerlink" href="#load-and-plot-a-single-opd" title="Permalink to this heading">#</a></h3>
<p>Inspect the OPD table above for an OPD around your observation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nrc</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">NIRCam</span><span class="p">()</span>
<span class="n">nrc</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="s1">&#39;F212N&#39;</span>
<span class="n">opd_fn</span> <span class="o">=</span> <span class="s1">&#39;R2022120204-NRCA3_FP1-1.fits&#39;</span>
<span class="n">nrc</span><span class="o">.</span><span class="n">load_wss_opd</span><span class="p">(</span><span class="n">opd_fn</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
<span class="n">fov_pixels</span> <span class="o">=</span> <span class="mi">511</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov_pixels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display the PSF and plot the encircled energy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">stpsf</span><span class="o">.</span><span class="n">display_psf</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">colorbar_orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
<span class="n">axis2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">stpsf</span><span class="o">.</span><span class="n">display_ee</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="jwst-simulated-psf-subtraction-from-in-flight-data">
<h2>JWST Simulated PSF Subtraction from in-flight data<a class="headerlink" href="#jwst-simulated-psf-subtraction-from-in-flight-data" title="Permalink to this heading">#</a></h2>
<p>https://stpsf.readthedocs.io/en/latest/jwst_psf_subtraction.html</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;jw02725-o484_t097_nircam_clear-f356w-nrcalong_wfscmb-04.fits&#39;</span>
<span class="n">mast_retrieve_files</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open and inspect observation</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">psf</span><span class="p">[</span><span class="s1">&#39;DQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
<span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">bkg_estimator</span> <span class="o">=</span> <span class="n">MedianBackground</span><span class="p">()</span>
<span class="c1"># norm = simple_norm(data1, &#39;log&#39;,min_cut = min_cut, max_cut = max_cut)</span>
<span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                   <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span> <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bkg_estimator</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">min_percent</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_percent</span><span class="o">=</span><span class="mf">98.99</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="extract-a-subarray-around-source-of-interest-and-measure-source-location">
<h3>Extract a subarray around source of interest, and measure source location<a class="headerlink" href="#extract-a-subarray-around-source-of-interest-and-measure-source-location" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">550</span><span class="p">,</span> <span class="mi">1950</span><span class="p">)</span> <span class="c1"># approximate location. This will be improved below.</span>
<span class="n">size_pixels</span> <span class="o">=</span> <span class="mi">200</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_source</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">size_pixels</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">min_percent</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_percent</span><span class="o">=</span><span class="mf">99.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cutout around a galaxy merger and a star&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-the-source">
<h3>Find the source<a class="headerlink" href="#find-the-source" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">starfind</span> <span class="o">=</span> <span class="n">IRAFStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">100.</span> <span class="o">*</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background_median</span><span class="p">)</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">starfind</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cutout around a galaxy merger and a star&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s re-center the image </span>
<span class="n">positions_original</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">size_pixels</span><span class="p">)</span><span class="o">.</span><span class="n">to_original_position</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions_original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">positions_original</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">data_source</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">size_pixels</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">min_percent</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_percent</span><span class="o">=</span><span class="mf">99.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cutout centered on the star&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-previous-function-to-set-up-our-simulation">
<h3>Use previous function to set up our simulation<a class="headerlink" href="#use-previous-function-to-set-up-our-simulation" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inst</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">setup_sim_to_match_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">inst</span><span class="o">.</span><span class="n">detector_position</span> <span class="o">=</span> <span class="n">position</span>

<span class="n">single_stpsf_nrc</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">fov_pixels</span><span class="o">=</span><span class="n">size_pixels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">single_stpsf_nrc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-photutils-to-create-our-model-psf">
<h3>Use photutils to create our model PSF<a class="headerlink" href="#use-photutils-to-create-our-model-psf" title="Permalink to this heading">#</a></h3>
<p>We’ll use photutils to fit and subtract the PSF from the data. First, we take the output simulated PSF and convert it into a photutils fittable model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stpsf_model</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">FittableImageModel</span><span class="p">(</span><span class="n">single_stpsf_nrc</span><span class="p">[</span><span class="s1">&#39;DET_DIST&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">oversampling</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">psfphot</span> <span class="o">=</span> <span class="n">PSFPhotometry</span><span class="p">(</span><span class="n">stpsf_model</span><span class="p">,</span> <span class="n">fit_shape</span><span class="p">,</span>
                        <span class="n">finder</span><span class="o">=</span><span class="n">starfind</span><span class="p">,</span> <span class="n">aperture_radius</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># fit model PSF to background subtracted data</span>
<span class="n">phot</span> <span class="o">=</span> <span class="n">psfphot</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="check-the-location-of-the-source-to-be-subtracted">
<h4>Check the location of the source to be subtracted<a class="headerlink" href="#check-the-location-of-the-source-to-be-subtracted" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">phot</span><span class="p">)</span> <span class="c1"># single source</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="subtract-psf-and-create-residual-image">
<h3>Subtract PSF and create residual image<a class="headerlink" href="#subtract-psf-and-create-residual-image" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residual</span> <span class="o">=</span> <span class="n">psfphot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="p">(</span><span class="n">size_pixels</span><span class="p">,</span> <span class="n">size_pixels</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Original - zoom&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Clean - PSFPhotometry zoom&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="psf-properties-and-differences">
<h3>PSF properties and differences<a class="headerlink" href="#psf-properties-and-differences" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pixelscale</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">pixelscale</span> 
<span class="n">ee_pixel_radius</span> <span class="o">=</span> <span class="mf">2.5</span>
<span class="n">ee_arcsec_radius</span> <span class="o">=</span> <span class="n">ee_pixel_radius</span> <span class="o">*</span> <span class="n">pixelscale</span>
<span class="n">ee_psf</span> <span class="o">=</span> <span class="n">poppy</span><span class="o">.</span><span class="n">measure_ee</span><span class="p">(</span><span class="n">single_stpsf_nrc</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">)</span>
<span class="n">ee_val</span> <span class="o">=</span> <span class="n">ee_psf</span><span class="p">(</span><span class="n">ee_arcsec_radius</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ee (</span><span class="si">{}</span><span class="s2">px, </span><span class="si">{:.3f}</span><span class="s2">arsec)  = </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ee_pixel_radius</span><span class="p">,</span> <span class="n">ee_arcsec_radius</span><span class="p">,</span> <span class="n">ee_val</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">measure_fwhm</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit a Gaussian2D model to a PSF and return the fitted PSF</span>
<span class="sd">    the FWHM is x and y can be found with fitted_psf.x_fwhm, fitted_psf.y_fwhm</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array : numpy.ndarray</span>
<span class="sd">        Array containing PSF</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x_fwhm : float</span>
<span class="sd">        FWHM in x direction in units of pixels</span>

<span class="sd">    y_fwhm : float</span>
<span class="sd">        FWHM in y direction in units of pixels</span>
<span class="sd">        </span>
<span class="sd">    x_mean : float</span>
<span class="sd">        x centroid position in units of pixels</span>
<span class="sd">    </span>
<span class="sd">    y_mean : float</span>
<span class="sd">        y centroid position in units of pixels</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">yp</span><span class="p">,</span> <span class="n">xp</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">yp</span><span class="p">,</span> <span class="p">:</span><span class="n">xp</span><span class="p">]</span>
    <span class="n">p_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x_mean</span><span class="o">=</span><span class="n">xp</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">y_mean</span><span class="o">=</span><span class="n">yp</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">fit_p</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
    <span class="n">fitted_psf</span> <span class="o">=</span> <span class="n">fit_p</span><span class="p">(</span><span class="n">p_init</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fitted_psf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitted_psf</span> <span class="o">=</span> <span class="n">measure_fwhm</span><span class="p">(</span><span class="n">single_stpsf_nrc</span><span class="p">[</span><span class="s2">&quot;DET_SAMP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FWHM X-direction: </span><span class="si">{:.3f}</span><span class="s2">, FWHM y-direction: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fitted_psf</span><span class="o">.</span><span class="n">x_fwhm</span><span class="p">,</span> <span class="n">fitted_psf</span><span class="o">.</span><span class="n">y_fwhm</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that the OPD is loaded in STPSF instrument object</span>
<span class="c1"># norm = ImageNormalize(stretch=LinearStretch(), vmin = 1e-9 , vmax = 1e-7)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nrc</span><span class="o">.</span><span class="n">pupilopd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check OPD header information</span>
<span class="n">nrc</span><span class="o">.</span><span class="n">pupilopd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s calculate the difference between two different times</span>
<span class="c1"># We can use the same instrument setup from before</span>
<span class="n">opd_fn</span> <span class="o">=</span> <span class="s1">&#39;R2022120404-NRCA3_FP1-1.fits&#39;</span>
<span class="n">inst</span><span class="o">.</span><span class="n">load_wss_opd</span><span class="p">(</span><span class="n">opd_fn</span><span class="p">)</span>
<span class="n">psf2</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">fov_pixels</span><span class="o">=</span><span class="n">size_pixels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pixelscale</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">pixelscale</span>
<span class="n">ee_pixel_radius</span> <span class="o">=</span> <span class="mf">2.5</span>
<span class="n">ee_arcsec_radius</span> <span class="o">=</span> <span class="n">ee_pixel_radius</span> <span class="o">*</span> <span class="n">pixelscale</span>
<span class="n">ee_psf</span> <span class="o">=</span> <span class="n">poppy</span><span class="o">.</span><span class="n">measure_ee</span><span class="p">(</span><span class="n">psf2</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">)</span>
<span class="n">ee_val</span> <span class="o">=</span> <span class="n">ee_psf</span><span class="p">(</span><span class="n">ee_arcsec_radius</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ee (</span><span class="si">{}</span><span class="s2">px, </span><span class="si">{:.3f}</span><span class="s2">arsec)  = </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ee_pixel_radius</span><span class="p">,</span> <span class="n">ee_arcsec_radius</span><span class="p">,</span> <span class="n">ee_val</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stpsf</span><span class="o">.</span><span class="n">display_psf_difference</span><span class="p">(</span><span class="n">single_stpsf_nrc</span><span class="p">,</span> <span class="n">psf2</span><span class="p">,</span> <span class="n">imagecrop</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Difference between two OPDs&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_heat&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">miri_psfs_for_ee</span><span class="p">():</span>
    <span class="n">miri</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">MIRI</span><span class="p">()</span>

    <span class="c1"># opd_fn = &#39;R2022120404-NRCA3_FP1-1.fits&#39;</span>
    <span class="c1"># miri.load_wss_opd(opd_fn, output_path = output_path)</span>
    <span class="n">miri</span><span class="o">.</span><span class="n">load_wss_opd_by_date</span><span class="p">(</span><span class="s1">&#39;2022-07-12T00:00:00&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">wave</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">]:</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="mi">18</span>

        <span class="n">outname</span> <span class="o">=</span> <span class="s2">&quot;PSF_MIRI_</span><span class="si">%.1f</span><span class="s2">um_wfed.fits&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wave</span><span class="p">)</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">miri</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">monochromatic</span><span class="o">=</span><span class="n">wave</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
                            <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fov_arcsec</span><span class="o">=</span><span class="n">fov</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">psf</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_ee_curves</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">iw</span><span class="p">,</span> <span class="n">wave</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">]):</span>

        <span class="n">ees60</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ees51</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
       
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;PSF_MIRI_</span><span class="si">%.1f</span><span class="s2">um_wfed.fits&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wave</span><span class="p">)</span>
        <span class="n">stpsf</span><span class="o">.</span><span class="n">display_ee</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">mark_levels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">eefn</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">measure_ee</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ees60</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eefn</span><span class="p">(</span><span class="mf">0.60</span><span class="p">))</span>
        <span class="n">ees51</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eefn</span><span class="p">(</span><span class="mf">0.51</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="s1">&#39;Mean EE inside 0.60&quot;: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ees60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Mean EE inside 0.51&quot;: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ees51</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wavelength = </span><span class="si">{</span><span class="n">wave</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> $</span><span class="se">\\</span><span class="s2">mu$m&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.51</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">miri_psfs_for_ee</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_ee_curves</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsp</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">NIRSpec</span><span class="p">()</span>
<span class="c1"># or you can specify a full path name.</span>
<span class="c1"># please make an output PSF with its center</span>
<span class="c1"># aligned to the center of a single pixel</span>
<span class="n">nsp</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;parity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;odd&#39;</span>

<span class="n">opd_fn</span> <span class="o">=</span> <span class="s1">&#39;R2022120404-NRCA3_FP1-1.fits&#39;</span>
<span class="n">nsp</span><span class="o">.</span><span class="n">load_wss_opd</span><span class="p">(</span><span class="n">opd_fn</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
    
<span class="n">waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="c1"># iterate over wavelengths in meters</span>

<span class="k">for</span> <span class="n">iw</span><span class="p">,</span> <span class="n">wavelength</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">waves</span><span class="p">):</span>
    <span class="n">psffile</span> <span class="o">=</span> <span class="s1">&#39;psf_NIRSPec_mono_</span><span class="si">%.1f</span><span class="s1">um_opd1.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">fov_arcsec</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                       <span class="n">monochromatic</span><span class="o">=</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">outfile</span><span class="o">=</span><span class="n">psffile</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">iw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stpsf</span><span class="o">.</span><span class="n">display_psf</span><span class="p">(</span><span class="n">psffile</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;DET_SAMP&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imagecrop</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">nsp</span><span class="o">.</span><span class="n">image_mask</span> <span class="o">=</span> <span class="s1">&#39;MSA all open&#39;</span>
<span class="n">nsp</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
<span class="n">msapsf</span> <span class="o">=</span> <span class="n">nsp</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">monochromatic</span><span class="o">=</span><span class="mf">2e-6</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">stpsf</span><span class="o">.</span><span class="n">display_psf</span><span class="p">(</span><span class="n">msapsf</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;DET_SAMP&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">miri_psfs_for_ee</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_ee_curves</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="improved-ifu-sims">
<h2>Improved IFU sims<a class="headerlink" href="#improved-ifu-sims" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">miri</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">MIRI</span><span class="p">()</span>
<span class="n">miri</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;IFU&#39;</span>
<span class="n">miri</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;2A&#39;</span>
<span class="n">waves</span> <span class="o">=</span> <span class="n">miri</span><span class="o">.</span><span class="n">get_IFU_wavelengths</span><span class="p">()</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">miri</span><span class="o">.</span><span class="n">calc_datacube_fast</span><span class="p">(</span><span class="n">waves</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cube</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nrs</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">NIRSpec</span><span class="p">()</span>
<span class="n">nrs</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;IFU&#39;</span>
<span class="n">nrs</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="s1">&#39;PRISM&#39;</span>
<span class="n">nrs</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="s1">&#39;CLEAR&#39;</span>
<span class="n">waves</span> <span class="o">=</span> <span class="n">nrs</span><span class="o">.</span><span class="n">get_IFU_wavelengths</span><span class="p">()</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">nrs</span><span class="o">.</span><span class="n">calc_datacube_fast</span><span class="p">(</span><span class="n">waves</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cube</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/cross_instrument/stpsf_examples"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Improving Accuracy of World Coordinate System of Pure Parallel Dataset</p>
      </div>
    </a>
    <a class="right-next"
       href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">MRS Cube Analysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#index">Index</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-setup">Imports and Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-measured-wavefront-near-a-given-date">Finding the measured wavefront near a given date</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#opd-file-description">OPD File description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#delta-wavefront-error-around-time-of-observation">Delta Wavefront Error Around Time of Observation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-a-psf-simulation-using-a-particular-observation">Setup a PSF simulation using a particular observation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trending-wavefront-changes-over-time">Trending Wavefront Changes over Time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wavefront-time-series-and-histogram-plots">Wavefront time series and histogram plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-all-opds">Table of all OPDs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trending-plots">Trending Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-over-a-time-range">Plot over a time range</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-plot-a-single-opd">Load and plot a Single OPD</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#jwst-simulated-psf-subtraction-from-in-flight-data">JWST Simulated PSF Subtraction from in-flight data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-a-subarray-around-source-of-interest-and-measure-source-location">Extract a subarray around source of interest, and measure source location</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-the-source">Find the source</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-previous-function-to-set-up-our-simulation">Use previous function to set up our simulation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-photutils-to-create-our-model-psf">Use photutils to create our model PSF</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-location-of-the-source-to-be-subtracted">Check the location of the source to be subtracted</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subtract-psf-and-create-residual-image">Subtract PSF and create residual image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-properties-and-differences">PSF properties and differences</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#improved-ifu-sims">Improved IFU sims</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>