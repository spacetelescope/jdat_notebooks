
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NIRSpec MOS Optimal Spectral Extraction &#8212; STScI JDAT Notebooks</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="NIRSpec MOS Optimal Spectral Extraction" href="../optimal_extraction_dynamic/Spectral%20Extraction.html" />
    <link rel="prev" title="Creating simulated images of the JWST astrometric calibration field in the LMC" href="../preimaging/preimaging_03_association.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/stsci_logo2.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">STScI JDAT Notebooks</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRISS WFSS Spectra
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00.%20Optimal%20extraction.html">
   Part 0: Optimal Extraction of NIRISS WFSS Spectrum
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01.%20Combine%20and%20normalize%201D%20spectra.html">
   Part 1: Combine One-Dimensional NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02.%20Cross%20correlation%20template.html">
   Part 2: Cross Correlation to Determine Redshift of NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03.%20Spatially%20resolved%20emission%20line%20map.html">
   Part 3: Spatially Resolved Emission Line Map of NIRISS WFSS Spectra
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MOS Spectroscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
   MOS Spectroscopy of Typical Extragalactic Field
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Example Notebook
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../example_notebook/example_notebook.html">
   Draft: Notebook title
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  IFU Continuum Fit
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
   IFU Data Modeling
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PSF Matched Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
   NIRCam PSF-matched multiband photometry
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MIRI IFU in the LMC
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
   JWST Data Analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Preimaging
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_02_calwebb.html">
   Excuting the JWST pipeline on the  JWST astrometric calibration field in the LMC (part 1)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_01_mirage.html">
   NIRSpec Pre-Imaging with NIRCam
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_03_association.html">
   Creating simulated images of the JWST astrometric calibration field in the LMC
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Optimal Extraction
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../optimal_extraction_dynamic/Spectral%20Extraction.html">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
   Baseline: NIRSpec IFU Optimal Point Source Extraction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Background Estimation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html">
   Imaging Sky Background Estimation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  SOSS Transient Spectroscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
   Analyzing the JWST Pipeline products of HAT-P-1b observations with NIRISS/SOSS
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PSF Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
   NIRCam PSF Photometry Notebook
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Specviz Interaction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
   Specviz notebook/GUI interaction on NIRISS WFSS 1D spectra
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ASDF Example
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../asdf_example/asdf_example.html">
   Example of Converting a FITS File to ASDF
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Composite Model Fitting
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
   Draft: Advanced Composite spectral model fitting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRISS AMI Binary
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/1_niriss_ami_binary.html">
   NIRISS AMI simulation of binary point source AB Dor and calibrator HD37093
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/2_niriss_ami_binary.html">
   NIRISS AMI calibration of binary point source AB Dor and calibrator HD37093
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Aperture Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
   Draft Aperture Photometry
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRSpec MAST Query
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
   MAST Query Tutorial for NIRSpec Users
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MIRI LRS Extraction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
   MIRI LRS Optimal Spectral Extraction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Transient Spectroscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
   Extracting an Exoplanet Transmission Spectrum from NIRSpec BOTS Time Series Observations
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRCam Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html">
   NIRCam Multiband Photometry
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/optimal_extraction/Spectral Extraction-static.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/spacetelescope/jdat_notebooks/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/optimal_extraction/Spectral Extraction-static.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defining-terms">
       Defining terms
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-data">
     Loading data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimal-extraction-algorithm">
   Optimal Extraction algorithm
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-an-extraction-region">
   Define an extraction region
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-kernel-slice">
   Create kernel slice
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-the-extraction-kernel">
   Define the extraction kernel
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#select-a-psf-template">
     Select a PSF template
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polynomial-background">
     Polynomial background
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-extraction-kernel">
   Fit extraction kernel
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#wavelength-varying-fwhm-skipped">
     Wavelength-varying FWHM (skipped)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-geometric-distortion-skipped">
   Fit geometric distortion
   <em>
    (skipped)
   </em>
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-bins-for-trace-fitting">
     Define bins for trace fitting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-each-bin-with-a-modified-extraction-kernel">
     Fit each bin with a modified extraction kernel
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-the-trace-centers-with-a-1d-polynomial">
     Fit the trace centers with a 1D polynomial
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#construct-final-1d-spectrum">
   Construct final 1D spectrum
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-variance-image">
     Create a variance image
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generate-the-1d-spectrum">
     Generate the 1D spectrum
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-a-batch-processing">
   Appendix A: Batch Processing
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Define an extraction region
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Create Kernel Slice
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-and-fit-the-extraction-kernel">
     Create and fit the extraction kernel
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#account-for-varying-fwhm">
     Account for varying FWHM
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-the-trace-centers">
     Fit the trace centers
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Generate the 1D spectrum
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convenience-functions">
     Convenience functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#iterate-over-the-desired-files">
     Iterate over the desired files
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-on-example-dataset">
     Run on example dataset
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-b-webbpsf">
   Appendix B: WebbPSF
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#instrument-properties">
     Instrument properties
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#monochromatic-psfs">
     Monochromatic PSFs
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpolation-methods">
     Interpolation Methods
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#full-trace-psf">
     Full trace PSF
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resampling-the-trace">
     Resampling the trace
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#about-this-notebook">
     About this notebook
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>NIRSpec MOS Optimal Spectral Extraction</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defining-terms">
       Defining terms
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-data">
     Loading data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimal-extraction-algorithm">
   Optimal Extraction algorithm
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-an-extraction-region">
   Define an extraction region
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-kernel-slice">
   Create kernel slice
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-the-extraction-kernel">
   Define the extraction kernel
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#select-a-psf-template">
     Select a PSF template
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polynomial-background">
     Polynomial background
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-extraction-kernel">
   Fit extraction kernel
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#wavelength-varying-fwhm-skipped">
     Wavelength-varying FWHM (skipped)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-geometric-distortion-skipped">
   Fit geometric distortion
   <em>
    (skipped)
   </em>
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-bins-for-trace-fitting">
     Define bins for trace fitting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-each-bin-with-a-modified-extraction-kernel">
     Fit each bin with a modified extraction kernel
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-the-trace-centers-with-a-1d-polynomial">
     Fit the trace centers with a 1D polynomial
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#construct-final-1d-spectrum">
   Construct final 1D spectrum
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-variance-image">
     Create a variance image
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generate-the-1d-spectrum">
     Generate the 1D spectrum
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-a-batch-processing">
   Appendix A: Batch Processing
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Define an extraction region
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Create Kernel Slice
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-and-fit-the-extraction-kernel">
     Create and fit the extraction kernel
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#account-for-varying-fwhm">
     Account for varying FWHM
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-the-trace-centers">
     Fit the trace centers
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Generate the 1D spectrum
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convenience-functions">
     Convenience functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#iterate-over-the-desired-files">
     Iterate over the desired files
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-on-example-dataset">
     Run on example dataset
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-b-webbpsf">
   Appendix B: WebbPSF
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#instrument-properties">
     Instrument properties
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#monochromatic-psfs">
     Monochromatic PSFs
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpolation-methods">
     Interpolation Methods
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#full-trace-psf">
     Full trace PSF
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resampling-the-trace">
     Resampling the trace
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#about-this-notebook">
     About this notebook
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="nirspec-mos-optimal-spectral-extraction">
<h1>NIRSpec MOS Optimal Spectral Extraction<a class="headerlink" href="#nirspec-mos-optimal-spectral-extraction" title="Permalink to this headline">¶</a></h1>
<p><strong>NOTE:</strong> This is a static version of the notebook for web rendering. The full, interactive version is available <a class="reference external" href="https://github.com/spacetelescope/dat_pyinthesky/blob/master/jdat_notebooks/optimal_extraction/Spectral%20Extraction.ipynb">here</a>.</p>
<p><strong>Use case:</strong> optimal spectral extraction; method by <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/abstract">Horne (1986)</a>.<br>
<strong>Data:</strong> JWST simulated NIRSpec MOS data; point sources.<br>
<strong>Tools:</strong>  jwst, webbpsf, matplotlib, scipy, custom functions.<br>
<strong>Cross-intrument:</strong> any spectrograph. <br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The JWST pipeline produces 1-D and 2-D rectified spectra from combined exposures for each spectroscopic mode. Currently, the 1D products are produced using aperture extraction, with plans to implement optimal extraction via PSF-weighting or fitting. However, there are many situations in which the output will not necessarily be “optimal”, and fine-tuning the parameters will be needed to improve the results. This notebook is intended to provide a walkthrough of the optimal extraction procedure with example JWST data.</p>
<div class="section" id="defining-terms">
<h3>Defining terms<a class="headerlink" href="#defining-terms" title="Permalink to this headline">¶</a></h3>
<p><strong>Optimal extraction:</strong> a method of aperture extraction first defined in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/">Horne (1986)</a>.<br>
<strong>S/N:</strong> Signal-to-noise ratio, a measure of how noisy a spectrum is.<br>
<strong>WCS:</strong> World Coordinate System, used for converting between different reference frames.<br></p>
</div>
</div>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<p>We will be using the following libraries to perform optimal spectral extraction.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">glob</span> <span class="pre">glob</span></code> for collecting filenames</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> to handle array functions, as well as other various and sundry activities</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jwst.datamodels</span> <span class="pre">ImageModel,</span> <span class="pre">MultiSpecModel</span></code> for accessing the datamodels for our example data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.io</span> <span class="pre">fits</span></code> for low-level FITS file I/O</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.modeling</span> <span class="pre">models,</span> <span class="pre">fitting</span></code> for the many fitting tasks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy.visualization</span> <span class="pre">astropy_mpl_style,</span> <span class="pre">simple_norm</span></code> for displaying nice images</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy.interpolate</span> <span class="pre">interp1d,</span> <span class="pre">RegularGridInterpolator</span></code> for all our interpolation needs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> for plotting data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.patches</span> <span class="pre">Rectangle</span></code> for plotting rectangles on our data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">webbpsf</span> <span class="pre">NIRSpec</span></code> to generate and visualize a PSF from the instrument model (see Appendix B)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">jwst.datamodels</span> <span class="kn">import</span> <span class="n">ImageModel</span><span class="p">,</span> <span class="n">MultiSpecModel</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">astropy_mpl_style</span><span class="p">,</span> <span class="n">simple_norm</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">RegularGridInterpolator</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">astropy_mpl_style</span><span class="p">)</span> <span class="c1">#use the style we imported for matplotlib displays</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loading-data">
<h2>Loading data<a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h2>
<p>We will be using simulated level 3 MOS data provided by James Muzerolle. These files come from a simulated visit with many point sources, and we will begin with the products of the <code class="docutils literal notranslate"><span class="pre">resample</span></code> step, which have the file extension <code class="docutils literal notranslate"><span class="pre">s2d.fits</span></code>. We will also compare the results of our optimal extraction with the products of the <code class="docutils literal notranslate"><span class="pre">extract1d</span></code> step, with the <code class="docutils literal notranslate"><span class="pre">x1d.fits</span></code> extension. See <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/data_products/product_types.html#stage-3-data-products">the science data products specification</a> and links therein for details on structure and format of these files.</p>
<p>The optimal extraction procedure laid out below can be repeated for each <code class="docutils literal notranslate"><span class="pre">'SCI'</span></code> extension in each <code class="docutils literal notranslate"><span class="pre">s2d</span></code> file. For the purposes of this notebook, we will assume that the <code class="docutils literal notranslate"><span class="pre">resample</span></code> step has produced optimal output, so those are the only extensions we need to access. (Rectifying and combining the input spectra is a complicated process on its own, and is far beyond the scope of this notebook!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># If the example dataset has already been downloaded, comment out these lines:</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="n">boxlink</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/optimal_extraction/optimal_extraction.zip&#39;</span>
<span class="n">boxfile</span> <span class="o">=</span> <span class="s1">&#39;./optimal_extraction.zip&#39;</span>
<span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>
<span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
<span class="c1"># ...to here</span>

<span class="n">example_file</span> <span class="o">=</span> <span class="s1">&#39;F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s30263_&#39;</span>
<span class="n">s2d_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;s2d_files&#39;</span><span class="p">,</span> <span class="n">example_file</span><span class="o">+</span><span class="s1">&#39;s2d.fits&#39;</span><span class="p">)</span>
<span class="n">x1d_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;x1d_files&#39;</span><span class="p">,</span> <span class="n">example_file</span><span class="o">+</span><span class="s1">&#39;x1d.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">s2d_file</span><span class="p">)</span>
<span class="n">resampled_2d_image</span> <span class="o">=</span> <span class="n">data_model</span><span class="o">.</span><span class="n">data</span> <span class="c1"># if multiple SCI extensions, also specify EXTVER</span>
<span class="n">weights_2d_image</span> <span class="o">=</span> <span class="n">data_model</span><span class="o">.</span><span class="n">wht</span> <span class="c1"># we will use this to estimate the per-pixel variance later</span>

<span class="n">image_shape</span> <span class="o">=</span> <span class="n">resampled_2d_image</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="n">image_shape</span><span class="p">)</span> <span class="c1">#note the swap of x and y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.extensions plugin from package asdf-astropy==0.2.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.extensions plugin from package gwcs==0.18.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.extensions plugin from package jwst==1.4.6 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package jwst==1.4.6 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package specutils==1.7.0 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package stpipe==0.3.3 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf_extensions plugin from package asdf==2.11.1 failed to load:

VersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;))
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf-astropy==0.2.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf-coordinates-schemas==0.1.0 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf-wcs-schemas==0.1.1 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package jwst==1.4.6 failed to load:

ContextualVersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;), {&#39;asdf&#39;})
  warnings.warn(
/usr/share/miniconda/lib/python3.9/site-packages/asdf/entry_points.py:46: AsdfWarning: asdf.resource_mappings plugin from package asdf==2.11.1 failed to load:

VersionConflict: (jsonschema 3.2.0 (/usr/share/miniconda/lib/python3.9/site-packages), Requirement.parse(&#39;jsonschema&gt;=4.0.1&#39;))
  warnings.warn(
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">Input In [3],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">data_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">s2d_file</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">resampled_2d_image</span> <span class="o">=</span> <span class="n">data_model</span><span class="o">.</span><span class="n">data</span> <span class="c1"># if multiple SCI extensions, also specify EXTVER</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">weights_2d_image</span> <span class="o">=</span> <span class="n">data_model</span><span class="o">.</span><span class="n">wht</span> <span class="c1"># we will use this to estimate the per-pixel variance later</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/stdatamodels/model_base.py:174,</span> in <span class="ni">DataModel.__init__</span><span class="nt">(self, init, schema, memmap, pass_invalid_values, strict_validation, validate_on_assignment, cast_fits_arrays, validate_arrays, ignore_missing_extensions, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">171</span>         <span class="n">schema</span> <span class="o">=</span> <span class="n">_DEFAULT_SCHEMA</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">173</span>         <span class="c1"># Create an AsdfFile so we can use its resolver for loading schemas</span>
<span class="ne">--&gt; </span><span class="mi">174</span>         <span class="n">schema</span> <span class="o">=</span> <span class="n">asdf_schema</span><span class="o">.</span><span class="n">load_schema</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_url</span><span class="p">,</span> <span class="n">resolve_references</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">mschema</span><span class="o">.</span><span class="n">merge_property_trees</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span> <span class="c1"># Provide the object as context to other classes and functions</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:435,</span> in <span class="ni">load_schema</span><span class="nt">(url, resolver, resolve_references, resolve_local_refs)</span>
<span class="g g-Whitespace">    </span><span class="mi">430</span>     <span class="n">resolver</span> <span class="o">=</span> <span class="n">extension</span><span class="o">.</span><span class="n">get_default_resolver</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span> <span class="c1"># We want to cache the work that went into constructing the schema, but returning</span>
<span class="g g-Whitespace">    </span><span class="mi">433</span> <span class="c1"># the same object is treacherous, because users who mutate the result will not</span>
<span class="g g-Whitespace">    </span><span class="mi">434</span> <span class="c1"># expect that they&#39;re changing the schema everywhere.</span>
<span class="ne">--&gt; </span><span class="mi">435</span> <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_load_schema_cached</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">resolve_references</span><span class="p">,</span> <span class="n">resolve_local_refs</span><span class="p">))</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:482,</span> in <span class="ni">_load_schema_cached</span><span class="nt">(url, resolver, resolve_references, resolve_local_refs)</span>
<span class="g g-Whitespace">    </span><span class="mi">479</span> <span class="nd">@lru_cache</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">480</span> <span class="k">def</span> <span class="nf">_load_schema_cached</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">resolve_references</span><span class="p">,</span> <span class="n">resolve_local_refs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">481</span>     <span class="n">loader</span> <span class="o">=</span> <span class="n">_make_schema_loader</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">482</span>     <span class="n">schema</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">loader</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">484</span>     <span class="k">if</span> <span class="n">resolve_references</span> <span class="ow">or</span> <span class="n">resolve_local_refs</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">486</span>         <span class="k">def</span> <span class="nf">resolve_refs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">json_id</span><span class="p">):</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:359,</span> in <span class="ni">_make_schema_loader.&lt;locals&gt;.load_schema</span><span class="nt">(url)</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>     <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">url</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span> <span class="c1"># If not, this must be a URL (or missing).  Fall back to fetching</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span> <span class="c1"># the schema the old way:</span>
<span class="ne">--&gt; </span><span class="mi">359</span> <span class="k">return</span> <span class="n">_load_schema</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/asdf/schema.py:323,</span> in <span class="ni">_load_schema</span><span class="nt">(url)</span>
<span class="g g-Whitespace">    </span><span class="mi">320</span> <span class="nd">@lru_cache</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">321</span> <span class="k">def</span> <span class="nf">_load_schema</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">322</span>     <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;asdf://&quot;</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">323</span>         <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Unable to fetch schema from non-file URL: &quot;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span>     <span class="k">with</span> <span class="n">generic_io</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>

<span class="ne">FileNotFoundError</span>: Unable to fetch schema from non-file URL: http://stsci.edu/schemas/jwst_datamodel/image.schema
</pre></div>
</div>
</div>
</div>
<p>When we want to view 2d spectra, we’ll generally need to stretch the pixels vertically to get a useful image. We can do this by setting the plot aspect ratio explicitly (we’ll try to retain a measure of rectangularity).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">resampled_2d_image</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;power&#39;</span><span class="p">)</span>
<span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">fig1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span> <span class="c1"># we save these in dummy variables to avoid spurious Jupyter Notebook output</span>
<span class="n">img1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resampled_2d_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect_ratio</span><span class="p">,</span> 
                  <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">clb1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="optimal-extraction-algorithm">
<h1>Optimal Extraction algorithm<a class="headerlink" href="#optimal-extraction-algorithm" title="Permalink to this headline">¶</a></h1>
<p>Here is an outline of the steps we’ll be following:</p>
<ol class="simple">
<li><p><a class="reference external" href="#Define-an-extraction-region">Define an extraction region on the 2D image</a></p></li>
<li><p><a class="reference external" href="#Create-kernel-slice">Identify a high S/N cross-dispersion (binned &amp; coadded) slice to use for the initial kernel fit</a></p></li>
<li><p><a class="reference external" href="#Define-the-extraction-kernel">Define the extraction kernel</a></p>
<ol class="simple">
<li><p>Single or composite PSF</p></li>
<li><p>Polynomial fit to background</p></li>
</ol>
</li>
<li><p><a class="reference external" href="#Fit-extraction-kernel">Fit extraction kernel to initial slice</a></p></li>
<li><p><em><strong>Skipped:</strong></em> <a class="reference external" href="#Fit-geometric-distortion-(skipped)"><em>Fit geometric distortion</em></a></p>
<ol class="simple">
<li><p><em>Determine cross-dispersion bins for trace fitting</em></p></li>
<li><p><em>First-pass fit of kernel to each bin to find trace center</em></p></li>
<li><p><em>Polynomial fit of trace centers</em></p></li>
</ol>
</li>
<li><p><a class="reference external" href="#Construct-final-1D-spectrum">Combine composite model (kernel | trace) with 2D image to create output 1D spectrum</a></p></li>
<li><p>Compare output spectrum with catalog photometry for flux calibration (not sure how to do this yet)</p></li>
</ol>
<p>Appendices:</p>
<ul class="simple">
<li><p><a class="reference external" href="#Appendix-A:-Batch-Processing">Appendix A: Batch Processing</a></p></li>
<li><p><a class="reference external" href="#Appendix-B:-WebbPSF">Appendix B: WebbPSF</a></p></li>
</ul>
<p><em>Developer Note:</em></p>
<p>This sort of functionality is desired by many, and as of yet, no general-purpose optimal extraction Python packages exist. While this notebook can provide optimal extraction for 2D resampled JWST pipeline products, and could be adapted for use with other data, it is a far cry from a widely-applicable, maintained and updated spectral extraction codebase. It would be very nice if such a thing existed…!</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="define-an-extraction-region">
<h1>Define an extraction region<a class="headerlink" href="#define-an-extraction-region" title="Permalink to this headline">¶</a></h1>
<p>We begin by identifying the region in the 2D resampled image which contains the spectral trace we want to extract. For a simple case with only a single source, we can theoretically use the entire image. However, we may still want to exclude large systematic fluctuations in the background which might complicate the fit, or part of the trace with essentially no signal which will make fitting the trace centers difficult. In addition, when working with background nod-subtracted data, the images will contain negative traces, which we will want to exclude.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span> <span class="c1"># we want the largest figure that will fit in the notebook</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resampled_2d_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect_ratio</span><span class="p">,</span> 
                  <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="c1"># reuse norm from earlier</span>

<span class="c1"># create region box and slider</span>
<span class="n">region_x</span> <span class="o">=</span> <span class="n">region_y</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">region_h</span><span class="p">,</span> <span class="n">region_w</span> <span class="o">=</span> <span class="n">image_shape</span>
<span class="n">region_rectangle</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">region_x</span><span class="p">,</span> <span class="n">region_y</span><span class="p">),</span> <span class="n">region_w</span><span class="p">,</span> <span class="n">region_h</span><span class="p">,</span> 
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">current_axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">rect_patch</span> <span class="o">=</span> <span class="n">current_axis</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">region_rectangle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll set the region coordinates to <code class="docutils literal notranslate"><span class="pre">x1=51,</span> <span class="pre">y1=3,</span> <span class="pre">x2=1268,</span> <span class="pre">y2=9</span></code>, then create a new array containing only our extraction region (so that we don’t need to continually index our original array).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">1268</span>
<span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span>

<span class="n">er_y</span><span class="p">,</span> <span class="n">er_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">extraction_region</span> <span class="o">=</span> <span class="n">resampled_2d_image</span><span class="p">[</span><span class="n">er_y</span><span class="p">,</span> <span class="n">er_x</span><span class="p">]</span>
<span class="n">weights_region</span> <span class="o">=</span> <span class="n">weights_2d_image</span><span class="p">[</span><span class="n">er_y</span><span class="p">,</span> <span class="n">er_x</span><span class="p">]</span>
<span class="n">er_ny</span><span class="p">,</span> <span class="n">er_nx</span> <span class="o">=</span> <span class="n">extraction_region</span><span class="o">.</span><span class="n">shape</span>

<span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">er_nx</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">er_ny</span><span class="p">)</span>

<span class="n">er_norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;power&#39;</span><span class="p">)</span>
<span class="n">fig3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">img3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect_ratio</span><span class="p">,</span> 
                  <span class="n">norm</span><span class="o">=</span><span class="n">er_norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">clb3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="create-kernel-slice">
<h1>Create kernel slice<a class="headerlink" href="#create-kernel-slice" title="Permalink to this headline">¶</a></h1>
<p>We now define a cross-dispersion slice of our extraction region with which to fit our initial extraction kernel. As an initial guess, we’ll coadd the 30 columns centered on the middle of the trace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slice_width</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">initial_column</span> <span class="o">=</span> <span class="n">er_nx</span> <span class="o">//</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">kernel_slice_coadd</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">column_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Coadd a number of columns (= width) of the extraction region,</span>
<span class="sd">    centered on column_idx.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">half_width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">to_coadd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">column_idx</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">),</span> 
                         <span class="nb">min</span><span class="p">(</span><span class="n">er_nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">column_idx</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">extraction_region</span><span class="p">[:,</span> <span class="n">to_coadd</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>

<span class="n">slice_0</span> <span class="o">=</span> <span class="n">kernel_slice_coadd</span><span class="p">(</span><span class="n">slice_width</span><span class="p">,</span> <span class="n">initial_column</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we’ll plot the resulting slice, and see if we need to adjust the width and center of the coadd region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig4</span><span class="p">,</span> <span class="p">(</span><span class="n">iax4</span><span class="p">,</span> <span class="n">pax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">img4</span> <span class="o">=</span> <span class="n">iax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect_ratio</span><span class="p">,</span> 
                  <span class="n">norm</span><span class="o">=</span><span class="n">er_norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1">#create slice box</span>
<span class="k">def</span> <span class="nf">make_slice</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">column_idx</span><span class="p">):</span>
    <span class="n">sy</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">er_ny</span><span class="p">,</span> <span class="n">width</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="n">column_idx</span> <span class="o">-</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">sh</span>

<span class="o">*</span><span class="n">sxy</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">make_slice</span><span class="p">(</span><span class="n">slice_width</span><span class="p">,</span> <span class="n">initial_column</span><span class="p">)</span>
<span class="n">slice_rectangle</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="n">sxy</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">iax4</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">slice_rectangle</span><span class="p">)</span>

<span class="c1">#plot the coadded slice</span>
<span class="n">xd_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">er_ny</span><span class="p">)</span>
<span class="n">lin4</span><span class="p">,</span> <span class="o">=</span> <span class="n">pax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">slice_0</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">xlbl4</span> <span class="o">=</span> <span class="n">pax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Cross-dispersion pixel&#39;</span><span class="p">)</span>
<span class="n">ylbl4</span> <span class="o">=</span> <span class="n">pax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Coadded signal&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A column index of 670 and width 50 seem to work reasonably well for this file, so we can now generate the final slice for kernel fitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel_slice</span> <span class="o">=</span> <span class="n">kernel_slice_coadd</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">670</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="define-the-extraction-kernel">
<h1>Define the extraction kernel<a class="headerlink" href="#define-the-extraction-kernel" title="Permalink to this headline">¶</a></h1>
<p>Now we will define an extraction kernel which will be used to fit our trace at each pixel in the dispersion direction. This kernel will be made of 2 parts:</p>
<ul class="simple">
<li><p>a PSF template (or a composite of multiple PSFs, for deblending purposes)</p></li>
<li><p>a polynomial for background fitting</p></li>
</ul>
<div class="section" id="select-a-psf-template">
<h2>Select a PSF template<a class="headerlink" href="#select-a-psf-template" title="Permalink to this headline">¶</a></h2>
<p>There are many options for PSF template that we could consider for our kernel, but a full comparison is outside the scope of this notebook. We will be demonstrating only Gaussian and Moffat profiles.</p>
<p>There are two things to note:</p>
<ol class="simple">
<li><p>The methods shown here are only applicable to a true point source. Extended sources require a different methodology.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">WebbPSF</span></code> package can be used to directly construct a composite PSF from the instrument model; however, this process is far more arduous than fitting a 1D profile using the <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> tools, and has thus been banished to Appendix B.</p></li>
</ol>
<p>We start by plotting the two profiles against the kernel slice, with a naive normalization so that we can ignore scaling for the time being, centered on the pixel with the kernel’s maximum value. (We will perform a true fit later, don’t worry!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">kernel_slice</span><span class="p">)</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="mf">1.</span>

<span class="n">moffat_profile</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Moffat1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">x_0</span><span class="o">=</span><span class="n">max_pixel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">gauss_profile</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">max_pixel</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>

<span class="n">fig5</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">kern5</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">kernel_slice</span> <span class="o">/</span> <span class="n">kernel_slice</span><span class="p">[</span><span class="n">max_pixel</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kernel Slice&#39;</span><span class="p">)</span>
<span class="n">moff5</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">moffat_profile</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Moffat Profile&#39;</span><span class="p">)</span>
<span class="n">gaus5</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">gauss_profile</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gaussian Profile&#39;</span><span class="p">)</span>
<span class="n">lgd5</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The Gaussian profile looks like a better approximation, so that’s the profile we’ll use for this spectrum. In the cell below, we could add more PSF templates using <a class="reference external" href="https://docs.astropy.org/en/stable/modeling/compound-models.html">model operations</a>; this is left as an exercise for the reader.</p>
<p>We need to de-normalize our amplitude, so we’ll set it to the maximum pixel value of the slice.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_template</span> <span class="o">=</span> <span class="n">gauss_profile</span>
<span class="n">psf_template</span><span class="o">.</span><span class="n">amplitude</span> <span class="o">=</span> <span class="n">kernel_slice</span><span class="p">[</span><span class="n">max_pixel</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">psf_template</span><span class="p">)</span>
<span class="c1"># If deblending multiple sources, add more PSF templates here:</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="polynomial-background">
<h2>Polynomial background<a class="headerlink" href="#polynomial-background" title="Permalink to this headline">¶</a></h2>
<p>We will fit the background with a polynomial. Some experimentation is recommended to find the polynomial degree which best fits the data; for this example, we’ll use a 2nd-degree polynomial.</p>
<p>For nod-subtracted data, there may not be enough pixels in the extraction region to accurately fit a residual. In such cases, use a 0th-order polynomial or a <code class="docutils literal notranslate"><span class="pre">Const1D</span></code> model for the background; to avoid fitting the background at all, set the parameter to <code class="docutils literal notranslate"><span class="pre">fixed</span> <span class="pre">=</span> <span class="pre">True</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">background_poly</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">background_poly</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The final step is to combine the PSF(s) and the background to create our compound model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extraction_kernel</span> <span class="o">=</span> <span class="n">psf_template</span> <span class="o">+</span> <span class="n">background_poly</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extraction_kernel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="fit-extraction-kernel">
<h1>Fit extraction kernel<a class="headerlink" href="#fit-extraction-kernel" title="Permalink to this headline">¶</a></h1>
<p>Now that we have an extraction kernel, we want to fit it to our kernel slice, so as to have the best tool for fitting trace centers in the next step. We also plot the fit components, as well as the fit vs the kernel slice, as visual checks; if they are unacceptable, we can go back to the previous section, tweak parameters, and try again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">fit_extraction_kernel</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">extraction_kernel</span><span class="p">,</span> <span class="n">xd_pixels</span><span class="p">,</span> <span class="n">kernel_slice</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fit_extraction_kernel</span><span class="p">)</span>

<span class="n">fit_line</span> <span class="o">=</span> <span class="n">fit_extraction_kernel</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">)</span>

<span class="n">fig6</span><span class="p">,</span> <span class="p">(</span><span class="n">fax6</span><span class="p">,</span> <span class="n">fln6</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">psf6</span> <span class="o">=</span> <span class="n">fax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">fit_extraction_kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">xd_pixels</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PSF&quot;</span><span class="p">)</span>
<span class="n">poly6</span> <span class="o">=</span> <span class="n">fax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">fit_extraction_kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">xd_pixels</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Background&quot;</span><span class="p">)</span>
<span class="n">sum6</span> <span class="o">=</span> <span class="n">fax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">fit_line</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Composite Kernel&quot;</span><span class="p">)</span>
<span class="n">lgd6a</span> <span class="o">=</span> <span class="n">fax6</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">lin6</span> <span class="o">=</span> <span class="n">fln6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">kernel_slice</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kernel Slice&#39;</span><span class="p">)</span>
<span class="n">fit6</span> <span class="o">=</span> <span class="n">fln6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">fit_line</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Extraction Kernel&#39;</span><span class="p">)</span>
<span class="n">lgd6b</span> <span class="o">=</span> <span class="n">fln6</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="wavelength-varying-fwhm-skipped">
<h2>Wavelength-varying FWHM (skipped)<a class="headerlink" href="#wavelength-varying-fwhm-skipped" title="Permalink to this headline">¶</a></h2>
<p>The NIRSpec PSF width changes with wavelength, and so for science data, it may be beneficial to fit multiple locations along the spectral trace. Below is a demonstration of the process; note, however, for this example dataset, the (not-yet-optimized) resampling and combining of the dithered input spectra introduces a width variation artifact, so we will not actually be using the results of this step for the extraction.</p>
<p>If we wish to account for a varying FWHM, we can bin the 2D spectrum in the dispersion direction and fit each bin. The kernel we defined above can act as our initial estimate, which can be helpful in very faint regions of the spectrum, since <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> fitting routines can be sensitive to initial estimates.</p>
<p>(Once the binned kernel FWHMs have been calculated and plotted, the next step would be to find an appropriate model and fit the FWHM as a function of bin center. The fit model would then be included in the final 1D extraction below.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clip</span>

<span class="n">n_bin</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">bin_width</span> <span class="o">=</span> <span class="n">er_nx</span> <span class="o">//</span> <span class="n">n_bin</span>
<span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">er_nx</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">bin_width</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">binned_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">extraction_region</span><span class="p">[:,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">bin_width</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> 
                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">er_nx</span><span class="p">,</span> <span class="n">bin_width</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">bin_fwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin_centers</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
    <span class="n">bin_fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">fit_extraction_kernel</span><span class="p">,</span> <span class="n">xd_pixels</span><span class="p">,</span> <span class="n">binned_spectrum</span><span class="p">[:,</span> <span class="n">y</span><span class="p">])</span>
    <span class="n">bin_fwhms</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_fit</span><span class="o">.</span><span class="n">stddev_0</span><span class="o">.</span><span class="n">value</span>
    
<span class="n">bin_ny</span><span class="p">,</span> <span class="n">bin_nx</span> <span class="o">=</span> <span class="n">binned_spectrum</span><span class="o">.</span><span class="n">shape</span>
<span class="n">bin_ar</span> <span class="o">=</span> <span class="n">bin_nx</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">bin_ny</span><span class="p">)</span>

<span class="n">fig_fwhm</span><span class="p">,</span> <span class="n">ax_fwhm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">fwhm_img</span> <span class="o">=</span> <span class="n">ax_fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">binned_spectrum</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">bin_ar</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">fwhm_plot</span> <span class="o">=</span> <span class="n">ax_fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">bin_fwhms</span><span class="p">)</span>
<span class="n">xlbl_fwhm</span> <span class="o">=</span> <span class="n">ax_fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Bin center (px)&quot;</span><span class="p">)</span>
<span class="n">ylbl_fwhm</span> <span class="o">=</span> <span class="n">ax_fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;FWHM (arcsec)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="fit-geometric-distortion-skipped">
<h1>Fit geometric distortion <em>(skipped)</em><a class="headerlink" href="#fit-geometric-distortion-skipped" title="Permalink to this headline">¶</a></h1>
<p>The pipeline <code class="docutils literal notranslate"><span class="pre">resample</span></code> step drizzles all input 2d spectra onto a rectified grid, so this particular step of our optimal extraction process is not typically necessary. A brief discussion of the procedure is included here as a guideline for extracting unrectified spectra (with the suffix <code class="docutils literal notranslate"><span class="pre">_cal.fits</span></code>), where the trace can have significant curvature and the trace dispersion is not column-aligned.</p>
<div class="section" id="define-bins-for-trace-fitting">
<h2>Define bins for trace fitting<a class="headerlink" href="#define-bins-for-trace-fitting" title="Permalink to this headline">¶</a></h2>
<p>Depending on how noisy the 2D resampled spectrum is, it may be beneficial to define bins in the dispersion direction. These can be evenly- or unevenly-spaced, and once they’re defined, coadd the columns in each bin (possibly using the <code class="docutils literal notranslate"><span class="pre">WHT</span></code> extension in the <code class="docutils literal notranslate"><span class="pre">s2d</span></code> file) and create an array of bin center locations.</p>
<p>If the 2D spectrum has high S/N, this may not be necessary, and each cross-dispersed column can be fit individually in the next step.</p>
</div>
<div class="section" id="fit-each-bin-with-a-modified-extraction-kernel">
<h2>Fit each bin with a modified extraction kernel<a class="headerlink" href="#fit-each-bin-with-a-modified-extraction-kernel" title="Permalink to this headline">¶</a></h2>
<p>We want to fit each of the defined bins with our extraction kernel, but we don’t want any other artifacts or noise to confuse the trace. So, we copy the extraction kernel, then set each parameter other than the profile center (<code class="docutils literal notranslate"><span class="pre">mean_0</span></code> in the example above) to <code class="docutils literal notranslate"><span class="pre">fixed</span> <span class="pre">=</span> <span class="pre">True</span></code>. Starting at one end of the trace, iterate over each bin to fit the slice with the extraction kernel, and store the resulting trace centers in an array.</p>
</div>
<div class="section" id="fit-the-trace-centers-with-a-1d-polynomial">
<h2>Fit the trace centers with a 1D polynomial<a class="headerlink" href="#fit-the-trace-centers-with-a-1d-polynomial" title="Permalink to this headline">¶</a></h2>
<p>This step is straightforward: create a <code class="docutils literal notranslate"><span class="pre">Polynomial1D</span></code> model, then fit it to the trace centers from the previous step.</p>
<p>Since we won’t be fitting, instead we’ll create a placeholder trace center model: a 0th-order polynomial.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trace_center_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#we use a constant because the spectrum has already been rectified</span>
<span class="n">trace_center_model</span><span class="o">.</span><span class="n">c0</span> <span class="o">=</span> <span class="n">fit_extraction_kernel</span><span class="o">.</span><span class="n">mean_0</span><span class="o">.</span><span class="n">value</span> <span class="c1"># use the parameter for center of the PSF profile</span>
<span class="nb">print</span><span class="p">(</span><span class="n">trace_center_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="construct-final-1d-spectrum">
<h1>Construct final 1D spectrum<a class="headerlink" href="#construct-final-1d-spectrum" title="Permalink to this headline">¶</a></h1>
<p>We calculate the final 1D spectrum as a weighted sum in the cross-dispersion direction the 2D spectrum, using our composite model (the extraction kernel centered on the trace) for the weights. We also need to incorporate the variance for each pixel, which we’ll estimate from the <code class="docutils literal notranslate"><span class="pre">WHT</span></code> extension output by the resample step.</p>
<div class="section" id="create-a-variance-image">
<h2>Create a variance image<a class="headerlink" href="#create-a-variance-image" title="Permalink to this headline">¶</a></h2>
<p>Horne’s algorithm requires the variance for each pixel. Errors are not currently propagated through the resample step; however, as per the <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/scientific-community/software/drizzlepac/_documents/drizzlepac-handbook.pdf">DrizzlePac Handbook</a>, we can estimate the variance from the drizzle weights image: <span class="math notranslate nohighlight">\( Var \approx 1 / (W \times s^4) \)</span>, where <span class="math notranslate nohighlight">\(s\)</span> is the pixel scale. Currently, the NIRSpec drizzle parameters are set to <code class="docutils literal notranslate"><span class="pre">PIXFRAC</span> <span class="pre">=</span> <span class="pre">1.0</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># adjust this if and when the NIRSpec PIXFRAC changes</span>

<span class="c1"># We want any pixel with 0 weight to be excluded from the calculation</span>
<span class="c1"># in the next step, so we&#39;ll use masked array operations.</span>
<span class="n">bad_pixels</span> <span class="o">=</span> <span class="n">weights_region</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">masked_wht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights_region</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">bad_pixels</span><span class="p">)</span>
<span class="n">variance_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">weights_region</span> <span class="o">*</span> <span class="n">scale</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can display the variance image to see if there are any regions of the extraction region which will not be included in the spectrum (indicated in red below). For this particular example spectrum, every pixel has a nonzero weight.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="n">fig_var</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
<span class="n">palette</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">var_norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">variance_image</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">0.006</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">img_var</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">variance_image</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect_ratio</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">var_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generate-the-1d-spectrum">
<h2>Generate the 1D spectrum<a class="headerlink" href="#generate-the-1d-spectrum" title="Permalink to this headline">¶</a></h2>
<p>Now, we finally calculate our 1D spectrum, summing over cross-dispersed columns:
$<span class="math notranslate nohighlight">\(S_x = \frac{1}{G_x}\sum_{y} \frac{I_{xy}\cdot K_y(x)}{V_{xy}}\)</span><span class="math notranslate nohighlight">\(
where \)</span>I<span class="math notranslate nohighlight">\( is the pixel value in the 2D resampled image, \)</span>K<span class="math notranslate nohighlight">\( is our extraction kernel set to the column's trace center, \)</span>V<span class="math notranslate nohighlight">\( is the pixel value in the variance image, and \)</span>G<span class="math notranslate nohighlight">\( is the kernel normalization given by:
\)</span><span class="math notranslate nohighlight">\(G_x = \sum_y \frac{K_y^2(x)}{V_{xy}}\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">er_nx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="c1">#initialize our spectrum with zeros</span>
<span class="n">column_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">er_nx</span><span class="p">)</span>
<span class="n">trace_centers</span> <span class="o">=</span> <span class="n">trace_center_model</span><span class="p">(</span><span class="n">column_pixels</span><span class="p">)</span> <span class="c1"># calculate our trace centers array</span>

<span class="c1"># Loop over columns</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column_pixels</span><span class="p">:</span>
    <span class="c1"># create the kernel for this column, using the fit trace centers</span>
    <span class="n">kernel_column</span> <span class="o">=</span> <span class="n">fit_extraction_kernel</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kernel_column</span><span class="o">.</span><span class="n">mean_0</span> <span class="o">=</span> <span class="n">trace_centers</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="c1"># kernel_column.stddev_0 = fwhm_fit(x) # if accounting for a varying FWHM, uncomment this line.</span>
    <span class="n">kernel_values</span> <span class="o">=</span> <span class="n">kernel_column</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">)</span>
    
    <span class="c1"># isolate the relevant column in the spectrum and variance images</span>
    <span class="n">variance_column</span> <span class="o">=</span> <span class="n">variance_image</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span> <span class="c1"># remember that numpy arrays are row, column</span>
    <span class="n">image_pixels</span> <span class="o">=</span> <span class="n">extraction_region</span><span class="p">[:,</span> <span class="n">x</span><span class="p">]</span>
    
    <span class="c1"># calculate the kernal normalization</span>
    <span class="n">g_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel_values</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">variance_column</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">g_x</span><span class="p">):</span> <span class="c1">#this column isn&#39;t valid, so we&#39;ll skip it</span>
        <span class="k">continue</span>
    
    <span class="c1"># and now sum the weighted column</span>
    <span class="n">weighted_column</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">image_pixels</span> <span class="o">*</span> <span class="n">kernel_values</span><span class="p">,</span> <span class="n">variance_column</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_column</span><span class="p">)</span> <span class="o">/</span> <span class="n">g_x</span>
</pre></div>
</div>
</div>
</div>
<p>We need a wavelength array to display the spectrum, which we can create from the WCS object stored in the data model’s metadata.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wcs</span> <span class="o">=</span> <span class="n">data_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>
<span class="n">alpha_C</span><span class="p">,</span> <span class="n">delta_C</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wcs</span><span class="p">(</span><span class="n">er_x</span><span class="p">,</span> <span class="n">er_y</span><span class="p">)</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig7</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">spec7</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write the extracted spectrum out to a file</span>
<span class="c1"># This is left as an exercise for the reader</span>
</pre></div>
</div>
</div>
</div>
<p>We also want to compare our optimally-extracted spectrum with the <code class="docutils literal notranslate"><span class="pre">x1d</span></code> pipeline product. We’ll normalize the spectra so we can plot them on the same axes.</p>
<p>(Note that the <code class="docutils literal notranslate"><span class="pre">x1d</span></code> spectrum includes negative traces from the background subtraction step, which usually results in a negative flux calculation. We need to correct for that when comparing with our optimally-extracted version.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x1d_model</span> <span class="o">=</span> <span class="n">MultiSpecModel</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span>
<span class="c1"># For a file with multiple spectra, the index to .spec is EXTVAR-1</span>
<span class="n">x1d_wave</span> <span class="o">=</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">WAVELENGTH</span>
<span class="n">x1d_flux</span> <span class="o">=</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">FLUX</span> 
<span class="k">if</span> <span class="n">x1d_flux</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">x1d_flux</span> <span class="o">=</span> <span class="o">-</span><span class="n">x1d_flux</span>
<span class="n">fig8</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">x1d8</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x1d_wave</span><span class="p">,</span> <span class="n">x1d_flux</span> <span class="o">/</span> <span class="n">x1d_flux</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pipeline&quot;</span><span class="p">)</span>
<span class="n">opt8</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span> <span class="o">/</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Optimal&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">lgd8</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="appendix-a-batch-processing">
<h1>Appendix A: Batch Processing<a class="headerlink" href="#appendix-a-batch-processing" title="Permalink to this headline">¶</a></h1>
<p>When optimal extraction is desired for a large number of spectra, going step-by-step through the process laid out above for each spectrum may not be practical. In such cases, we can initially use those interactive methods on one or two spectra to make decisions about some of our extraction parameters (e.g., what PSF template profile to use, or what degree polynonmial to fit the background with), then use those parameters to process all of the spectra non-interactively. Afterwards, we can examine the output from each extracted spectrum and revisit any which need more individualized handling.</p>
<p>We can extract a large number of spectra non-interactively by defining functions for each of the steps above, and a single master function to iterate over all the spectra in a single directory.</p>
<div class="section" id="id1">
<h2>Define an extraction region<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>There’s no way to perform this step non-interactively, so we’ll skip it here. However, there are two good ways (and one bad way) to deal with this for a real dataset:</p>
<ol class="simple">
<li><p>Define an extraction region for each 2D spectrum before batch processing. You can save the region bounding boxes to a python dictionary (or write them to a file, then read it in during iteration).</p></li>
<li><p>Visually examine the 2D spectra, and only batch process those spectra for which a specific extraction region (i.e., smaller than the full 2D spectrum) doesn’t need to be defined. The remainder of the spectra can be extracted individually.</p></li>
<li><p>Skip this step, and assume that any spectra for which a specific extraction region would need to be defined will need individualized reprocessing anyway. This step is not recommended, but it is the one we will be using here.</p></li>
</ol>
</div>
<div class="section" id="id2">
<h2>Create Kernel Slice<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_kernel_slice</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">slice_width</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">column_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a slice in the cross-dispersion direction out of the </span>
<span class="sd">    2D array `extraction_region`, centered on `column_idx` and </span>
<span class="sd">    `slice_width` pixels wide. If `column_idx` is not given, use</span>
<span class="sd">    the column with the largest total signal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">column_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">extraction_region</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">extraction_region</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">half_width</span> <span class="o">=</span> <span class="n">slice_width</span> <span class="o">//</span> <span class="mi">2</span>
    
    <span class="c1">#make sure we don&#39;t go past the edges of the extraction region</span>
    <span class="n">to_coadd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">column_idx</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">),</span> 
                         <span class="nb">min</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">column_idx</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">extraction_region</span><span class="p">[:,</span> <span class="n">to_coadd</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">slice_width</span>
    
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-and-fit-the-extraction-kernel">
<h2>Create and fit the extraction kernel<a class="headerlink" href="#create-and-fit-the-extraction-kernel" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_fit_extraction_kernel</span><span class="p">(</span><span class="n">xd_slice</span><span class="p">,</span> <span class="n">psf_profile</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">,</span> 
                          <span class="n">height_param_name</span><span class="o">=</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="n">height_param_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">width_param_name</span><span class="o">=</span><span class="s1">&#39;stddev&#39;</span><span class="p">,</span> <span class="n">width_param_value</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                          <span class="n">center_param_name</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">center_param_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">other_psf_args</span><span class="o">=</span><span class="p">[],</span> <span class="n">other_psf_kw</span><span class="o">=</span><span class="p">{},</span>
                          <span class="n">bg_model</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">,</span>
                          <span class="n">bg_args</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bg_kw</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a composite extraction kernel, then fit it to </span>
<span class="sd">    the 1D array `xd_slice`, which has been nominally</span>
<span class="sd">    generated via the `kernel_slice` function defined above. </span>
<span class="sd">    </span>
<span class="sd">    To allow for PSF template models with different parameter </span>
<span class="sd">    names, we use the `height_param_*`, `width_param_*`, and</span>
<span class="sd">    `center_param_*` keyword arguments. We collect any other</span>
<span class="sd">    positional or keyword arguments for the PSF model in </span>
<span class="sd">    `other_psf_*`. If the height or center values are `None`, </span>
<span class="sd">    they will be calculated from the data.</span>
<span class="sd">    </span>
<span class="sd">    Similarly, any desired positional or keyword arguments to</span>
<span class="sd">    the background fit model (default `Polynomial1D`) are</span>
<span class="sd">    accepted via `bg_args` and `bg_kw`.</span>
<span class="sd">    </span>
<span class="sd">    Note that this function can not handle cases which involve</span>
<span class="sd">    multiple PSFs for deblending. It is recommended to process</span>
<span class="sd">    such spectra individually, using the interactive procedure</span>
<span class="sd">    above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xd_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xd_slice</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">center_param_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center_param_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">xd_slice</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">height_param_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># In case of non-integer values passed via center_param_value,</span>
        <span class="c1"># we need to interpolate.</span>
        <span class="n">slice_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">xd_slice</span><span class="p">)</span>
        <span class="n">height_param_value</span> <span class="o">=</span> <span class="n">slice_interp</span><span class="p">(</span><span class="n">center_param_value</span><span class="p">)</span>
    
    <span class="c1"># Create the PSF and the background models</span>
    <span class="n">psf_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">height_param_name</span><span class="p">,</span> <span class="n">height_param_value</span><span class="p">),</span> 
                   <span class="p">(</span><span class="n">width_param_name</span><span class="p">,</span> <span class="n">width_param_value</span><span class="p">),</span>
                   <span class="p">(</span><span class="n">center_param_name</span><span class="p">,</span> <span class="n">center_param_value</span><span class="p">)])</span>
    <span class="n">psf_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_psf_kw</span><span class="p">)</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">psf_profile</span><span class="p">(</span><span class="o">*</span><span class="n">other_psf_args</span><span class="p">,</span> <span class="o">**</span><span class="n">psf_kw</span><span class="p">)</span>
    
    <span class="n">bg</span> <span class="o">=</span> <span class="n">bg_model</span><span class="p">(</span><span class="o">*</span><span class="n">bg_args</span><span class="p">,</span> <span class="o">**</span><span class="n">bg_kw</span><span class="p">)</span>
    
    <span class="n">composite_kernel</span> <span class="o">=</span> <span class="n">psf</span> <span class="o">+</span> <span class="n">bg</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fitter</span><span class="p">(</span><span class="n">composite_kernel</span><span class="p">,</span> <span class="n">xd_pixels</span><span class="p">,</span> <span class="n">xd_slice</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="account-for-varying-fwhm">
<h2>Account for varying FWHM<a class="headerlink" href="#account-for-varying-fwhm" title="Permalink to this headline">¶</a></h2>
<p>This is left as an exercise for the user, as per the process shown <a class="reference external" href="#Wavelength-varying-FWHM">here</a>. Note that <code class="docutils literal notranslate"><span class="pre">batch_extract_spectrum</span></code> and <code class="docutils literal notranslate"><span class="pre">batch_optimal_extraction</span></code> below will also need to be modified to incorporate this function, if desired.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_vary_fwhm</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">kernel</span><span class="p">):</span>
    <span class="k">pass</span> <span class="c1"># implement a function which fits a wavelength-varying FWHM</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fit-the-trace-centers">
<h2>Fit the trace centers<a class="headerlink" href="#fit-the-trace-centers" title="Permalink to this headline">¶</a></h2>
<p>If this is required, replace this with a real function that does the fitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_fit_trace_centers</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span>
                      <span class="n">trace_model</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">,</span>
                      <span class="n">trace_args</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trace_kw</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the geometric distortion of the trace with</span>
<span class="sd">    a model. Currently this is a placeholder function,</span>
<span class="sd">    since geometric distortion is typically removed</span>
<span class="sd">    during the `resample` step. However, if this</span>
<span class="sd">    functionality is necesary, use this function</span>
<span class="sd">    signature to remain compatible with the rest of</span>
<span class="sd">    this Appendix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">trace_centers</span> <span class="o">=</span> <span class="n">trace_model</span><span class="p">(</span><span class="o">*</span><span class="n">trace_args</span><span class="p">,</span> <span class="o">**</span><span class="n">trace_kw</span><span class="p">)</span>
    <span class="n">trace_centers</span><span class="o">.</span><span class="n">c0</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">mean_0</span>
    <span class="k">return</span> <span class="n">trace_centers</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>Generate the 1D spectrum<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_extract_spectrum</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> 
                     <span class="n">weights_image</span><span class="p">,</span> 
                     <span class="n">trace_center_param</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                     <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimally extract the 1D spectrum from the extraction </span>
<span class="sd">    region.</span>
<span class="sd">    </span>
<span class="sd">    A variance image is created from `weights_image` (which </span>
<span class="sd">    should have the same dimensions as `extraction_region`).</span>
<span class="sd">    Then, for each column of the spectrum, we sum the aperture</span>
<span class="sd">    as per the equations defined above, masking pixels with</span>
<span class="sd">    zero weights. </span>
<span class="sd">    </span>
<span class="sd">    Note that unlike the interactive, step-by-step method, </span>
<span class="sd">    here we will vectorize for speed. This requires using</span>
<span class="sd">    a model set for the kernel, but this is allowed since</span>
<span class="sd">    we are not fitting anything.</span>
<span class="sd">    </span>
<span class="sd">    `trace_center_param` is the name of the parameter which </span>
<span class="sd">    will defines the trace centers, *without the model number</span>
<span class="sd">    subscript* (since we will be dealing with the components</span>
<span class="sd">    individually).</span>
<span class="sd">    </span>
<span class="sd">    `scale` is the size ratio of input to output pixels when</span>
<span class="sd">    drizzling, equivalent to PIXFRAC in the drizzle parameters</span>
<span class="sd">    from the `resample` step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">bad_pixels</span> <span class="o">=</span> <span class="n">weights_image</span> <span class="o">==</span> <span class="mf">0.</span>
    <span class="n">masked_wht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights_image</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">bad_pixels</span><span class="p">)</span>
    <span class="n">variance_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">masked_wht</span> <span class="o">*</span> <span class="n">scale</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
    
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">extraction_region</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">trace_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">xd_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">trace_centers</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">trace_pixels</span><span class="p">)</span> <span class="c1"># calculate our trace centers array</span>
    
    <span class="c1"># Create kernel image for vectorizing, which requires some gymnastics...</span>
    <span class="c1"># ******************************************************************</span>
    <span class="c1"># * IMPORTANT:                                                     *</span>
    <span class="c1"># * ----------                                                     *</span>
    <span class="c1"># * Note that because of the way model sets are implemented, it is *</span>
    <span class="c1"># * not feasible to alter an existing model instance to use them.  *</span>
    <span class="c1"># * Instead we&#39;ll create a new kernel instance, using the fitted   *</span>
    <span class="c1"># * parameters from the original kernel.                           *</span>
    <span class="c1"># *                                                                *</span>
    <span class="c1"># * Caveat: this assumes that the PSF is the first element, and    *</span>
    <span class="c1"># * the background is the second. If you change that when creating *</span>
    <span class="c1"># * your composite kernel, make sure you update this section       *</span>
    <span class="c1"># * similarly, or it will not work!                                *</span>
    <span class="c1"># ******************************************************************</span>
    <span class="n">psf0</span><span class="p">,</span> <span class="n">bg0</span> <span class="o">=</span> <span class="n">kernel</span>
    <span class="n">psf_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">psf0</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">psf0</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pname</span> <span class="o">==</span> <span class="n">trace_center_param</span><span class="p">:</span>
            <span class="n">psf_params</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_centers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psf_params</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">)</span>
    <span class="n">psf_set</span> <span class="o">=</span> <span class="n">psf0</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">n_models</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="o">**</span><span class="n">psf_params</span><span class="p">)</span>
    <span class="c1">#if not using Polynomial1D for background model, edit this:</span>
    <span class="n">bg_set</span> <span class="o">=</span> <span class="n">bg0</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bg0</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_models</span><span class="o">=</span><span class="n">nx</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bg0</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">bg0</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">bg_set</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">))</span>
    <span class="n">kernel_set</span> <span class="o">=</span> <span class="n">psf_set</span> <span class="o">+</span> <span class="n">bg_set</span>
    <span class="c1"># We pass model_set_axis=False so that every model in the set </span>
    <span class="c1"># uses the same input, and we transpose the result to fix the</span>
    <span class="c1"># orientation.</span>
    <span class="n">kernel_image</span> <span class="o">=</span> <span class="n">kernel_set</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">model_set_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c1"># Now we perform our weighted sum, using numpy.ma routines</span>
    <span class="c1"># to preserve our masks</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel_image</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">variance_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">weighted_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">kernel_image</span> <span class="o">*</span> <span class="n">extraction_region</span><span class="p">,</span> <span class="n">variance_image</span><span class="p">)</span>
    <span class="n">spectrum1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_spectrum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">g</span>
    
    <span class="c1"># Any masked values we set to 0.</span>
    <span class="k">return</span> <span class="n">spectrum1d</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="convenience-functions">
<h2>Convenience functions<a class="headerlink" href="#convenience-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_wavelength_from_wcs</span><span class="p">(</span><span class="n">datamodel</span><span class="p">,</span> <span class="n">pix_x</span><span class="p">,</span> <span class="n">pix_y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to grab the WCS object from the</span>
<span class="sd">    datamodel&#39;s metadata, generate world coordinates from</span>
<span class="sd">    the given pixel coordinates, and return the 1D </span>
<span class="sd">    wavelength.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">datamodel</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span>
    <span class="n">aC</span><span class="p">,</span> <span class="n">dC</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wcs</span><span class="p">(</span><span class="n">pix_x</span><span class="p">,</span> <span class="n">pix_y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">batch_save_extracted_spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quick &amp; dirty fits dump of an extracted spectrum.</span>
<span class="sd">    Replace with your preferred output format &amp; function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">wcol</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> 
                       <span class="n">array</span><span class="o">=</span><span class="n">wavelength</span><span class="p">)</span>
    <span class="n">scol</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span>
                       <span class="n">array</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span><span class="n">wcol</span><span class="p">,</span> <span class="n">scol</span><span class="p">])</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">batch_plot_output</span><span class="p">(</span><span class="n">resampled_image</span><span class="p">,</span> <span class="n">extraction_bbox</span><span class="p">,</span> 
                <span class="n">kernel_slice</span><span class="p">,</span> <span class="n">kernel_model</span><span class="p">,</span>
                <span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function for summary output figures,</span>
<span class="sd">    allowing visual inspection of the results from </span>
<span class="sd">    each file being processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">resampled_image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">aspect</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span>
    
    <span class="c1"># Subplot 1: Extraction region</span>
    <span class="n">power_norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">resampled_image</span><span class="p">,</span> <span class="s1">&#39;power&#39;</span><span class="p">)</span>
    <span class="n">er_img</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resampled_image</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
               <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">power_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">extraction_bbox</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">),</span> <span class="n">rw</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                       <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">er_ptch</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    
    <span class="c1"># Subplot 2: Kernel fit</span>
    <span class="n">xd_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">kernel_slice</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">fit_line</span> <span class="o">=</span> <span class="n">kernel_model</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">)</span>
    <span class="n">ks_line</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">kernel_slice</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kernel Slice&#39;</span><span class="p">)</span>
    <span class="n">kf_line</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd_pixels</span><span class="p">,</span> <span class="n">fit_line</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Extraction Kernel&#39;</span><span class="p">)</span>
    <span class="n">k_lgd</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1"># Subplot 3: Extracted spectrum</span>
    <span class="n">spec_line</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="iterate-over-the-desired-files">
<h2>Iterate over the desired files<a class="headerlink" href="#iterate-over-the-desired-files" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">batch_optimal_extraction</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterate over a list of fits file paths, optimally extract</span>
<span class="sd">    the SCI extension in each file, generate an output summary</span>
<span class="sd">    image, and then save the resulting spectrum.</span>
<span class="sd">    </span>
<span class="sd">    Note that in the example dataset, there is only one SCI</span>
<span class="sd">    extension in each file. For data with multiple SCI </span>
<span class="sd">    extensions, a second loop over those extensions is</span>
<span class="sd">    required.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># For this example data, we&#39;ll just use the default values</span>
    <span class="c1"># for all the functions</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing file </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">),</span> <span class="n">fitsfile</span><span class="p">))</span>
        <span class="n">dmodel</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
        <span class="n">spec2d</span> <span class="o">=</span> <span class="n">dmodel</span><span class="o">.</span><span class="n">data</span>
        <span class="n">wht2d</span> <span class="o">=</span> <span class="n">dmodel</span><span class="o">.</span><span class="n">wht</span>
        
        <span class="n">k_slice</span> <span class="o">=</span> <span class="n">batch_kernel_slice</span><span class="p">(</span><span class="n">spec2d</span><span class="p">)</span>
        <span class="n">k_model</span> <span class="o">=</span> <span class="n">batch_fit_extraction_kernel</span><span class="p">(</span><span class="n">k_slice</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">batch_fit_trace_centers</span><span class="p">(</span><span class="n">spec2d</span><span class="p">,</span> <span class="n">k_model</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">batch_extract_spectrum</span><span class="p">(</span><span class="n">spec2d</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">k_model</span><span class="p">,</span> <span class="n">wht2d</span><span class="p">)</span>
        
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">spec2d</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">y2d</span><span class="p">,</span> <span class="n">x2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">ny</span><span class="p">,</span> <span class="p">:</span><span class="n">nx</span><span class="p">]</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">batch_wavelength_from_wcs</span><span class="p">(</span><span class="n">dmodel</span><span class="p">,</span> <span class="n">x2d</span><span class="p">,</span> <span class="n">y2d</span><span class="p">)</span>
        
        <span class="n">bbox</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">fitsfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s2d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;x1d_optimal&#39;</span><span class="p">)</span>
        
        <span class="n">batch_plot_output</span><span class="p">(</span><span class="n">spec2d</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">k_slice</span><span class="p">,</span> <span class="n">k_model</span><span class="p">,</span>
                    <span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> 
                    <span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">batch_save_extracted_spectrum</span><span class="p">(</span><span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
        
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="run-on-example-dataset">
<h2>Run on example dataset<a class="headerlink" href="#run-on-example-dataset" title="Permalink to this headline">¶</a></h2>
<p>Take particular note of any spectrum which produces a warning during fitting - these are likely to be good candidates for interactive reprocessing.</p>
<p><em>Developer Note:</em></p>
<p>It would be great if there was a way to do this without spawning invisible plots from the creation of matplotlib figures, so that the <code class="docutils literal notranslate"><span class="pre">ioff</span></code> and <code class="docutils literal notranslate"><span class="pre">ion</span></code> calls could be removed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span> <span class="c1"># if we don&#39;t turn this off, then matplotlib tries to display an (invisible) plot for each spectrum</span>
<span class="n">s2d_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;s2d_files&#39;</span><span class="p">,</span> <span class="s1">&#39;*s2d.fits&#39;</span><span class="p">))</span>
<span class="n">batch_optimal_extraction</span><span class="p">(</span><span class="n">s2d_files</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> <span class="c1"># now we turn it back on so everything else plots as it should!</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="appendix-b-webbpsf">
<h1>Appendix B: WebbPSF<a class="headerlink" href="#appendix-b-webbpsf" title="Permalink to this headline">¶</a></h1>
<p>Instead of using a PSF template, we can generate a PSF directly from the instrument model with <a class="reference external" href="https://webbpsf.readthedocs.io/en/stable/index.html">WebbPSF</a>. Currently, only the F110W and F140X imaging filters are supported, but we’ll walk through the process anyway for whenever more filters become available.</p>
<p>The primary function of WebbPSF is to produce imaging PSFs; however, it <em>can</em> generate a set of monochromatic PSFs, which we can combine.</p>
<p><code class="docutils literal notranslate"><span class="pre">webbpsf</span></code> is only needed here so we import it at the start of this appendix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">webbpsf</span> <span class="kn">import</span> <span class="n">NIRSpec</span><span class="p">,</span> <span class="n">display_psf</span>
</pre></div>
</div>
</div>
</div>
<p>WebbPSF has a number of data files which are required to run, so we’ll begin by verifying that they can be accessed (and downloading them if necessary).</p>
<p>Note that you will see a big red error message if you have not yet downloaded the data files. Don’t worry, as long as you see “Downloading WebbPSF data files.” everything is still proceeding as expected.</p>
<p><em>Developer Note:</em></p>
<p>WebbPSF should be updated so that the red error doesn’t appear.  See <a class="reference external" href="https://github.com/spacetelescope/webbpsf/issues/380">https://github.com/spacetelescope/webbpsf/issues/380</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">NIRSpec</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="c1"># assume that WebbPSF data files have not been downloaded</span>
    <span class="kn">import</span> <span class="nn">tarfile</span><span class="o">,</span> <span class="nn">sys</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading WebbPSF data files.&quot;</span><span class="p">)</span>
    <span class="n">webb_url</span> <span class="o">=</span> <span class="s2">&quot;https://stsci.box.com/shared/static/qcptcokkbx7fgi3c00w2732yezkxzb99.gz&quot;</span>
    <span class="n">webb_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s2">&quot;webbpsf-data-0.9.0.tar.gz&quot;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">webb_url</span><span class="p">,</span> <span class="n">webb_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting into ./webbpsf-data ...&quot;</span><span class="p">)</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">webb_file</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WEBBPSF_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;webbpsf-data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="instrument-properties">
<h2>Instrument properties<a class="headerlink" href="#instrument-properties" title="Permalink to this headline">¶</a></h2>
<p>See the WebbPSF documentation for a full list of instrument settings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instrument</span> <span class="o">=</span> <span class="n">NIRSpec</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">filter_list</span><span class="p">)</span>

<span class="c1"># For reference:</span>
<span class="n">allowed_masks</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;S200A1&#39;</span><span class="p">,</span><span class="s1">&#39;S200A2&#39;</span><span class="p">,</span><span class="s1">&#39;S400A1&#39;</span><span class="p">,</span><span class="s1">&#39;S1600A1&#39;</span><span class="p">,</span><span class="s1">&#39;S200B1&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;MSA all open&#39;</span><span class="p">,</span> <span class="s1">&#39;Single MSA open shutter&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;Three adjacent MSA open shutters&#39;</span><span class="p">)</span>

<span class="c1"># Edit these as necessary</span>
<span class="n">instrument</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="s1">&#39;F110W&#39;</span> 
<span class="n">instrument</span><span class="o">.</span><span class="n">image_mask</span> <span class="o">=</span> <span class="s1">&#39;Three adjacent MSA open shutters&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="monochromatic-psfs">
<h2>Monochromatic PSFs<a class="headerlink" href="#monochromatic-psfs" title="Permalink to this headline">¶</a></h2>
<p>The most rigorous method we could use is to generate a PSF for each wavelength in the 2D spectrum and combine all of them. However, the computation time and memory required for this method is generally very large unless the spectra are quite short (in the dispersion direction). A more reasonable method (which is what we will be doing here) is to create a subset of monochromatic PSFs spaced evenly across the wavelength range, and interpolate between them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">psf_wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wavelength</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0e-6</span> <span class="c1"># wavelengths must be in meters</span>

<span class="n">cube_hdul</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">calc_datacube</span><span class="p">(</span><span class="n">psf_wavelengths</span><span class="p">)</span> <span class="c1">#the output is a HDUList</span>
<span class="n">psf_cube</span> <span class="o">=</span> <span class="n">cube_hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">psf_cube</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Display the contents of the data cube</span>
<span class="n">fig9</span><span class="p">,</span> <span class="n">ax9</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> 
                   <span class="n">right</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax9</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">row</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">col</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">psf_wavelengths</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        
        <span class="n">display_psf</span><span class="p">(</span><span class="n">cube_hdul</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cube_slice</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;$\lambda$ = </span><span class="si">{:.3f}</span><span class="s2"> $\mu$m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wl</span><span class="o">*</span><span class="mf">1e6</span><span class="p">),</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="interpolation-methods">
<h2>Interpolation Methods<a class="headerlink" href="#interpolation-methods" title="Permalink to this headline">¶</a></h2>
<p>The method of interpolation we choose depends strongly on how the PSF varies with wavelength. For evaluating the different methods, we’ll create another monochromatic PSF for comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reference_psf_hdul</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">monochromatic</span><span class="o">=</span><span class="mf">3.0e-6</span><span class="p">)</span>
<span class="n">reference_psf</span> <span class="o">=</span> <span class="n">reference_psf_hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">ref_norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">reference_psf</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The simplest way is a 3D linear interpolation, so let’s see how it does. In the figure below, the top-left image is the reference PSF, the top-right is the linearly-interpolated PSF, the bottom left is a difference image, and the bottom right is a log-log plot of the pixel values in the reference (X) and interpolated (Y) PSFs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_pix</span> <span class="o">=</span> <span class="n">reference_psf</span> <span class="o">&gt;=</span> <span class="mf">1e-4</span>
<span class="n">psf_x</span> <span class="o">=</span> <span class="n">psf_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
<span class="n">out_x</span><span class="p">,</span> <span class="n">out_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">psf_x</span><span class="p">,</span> <span class="n">psf_y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
<span class="n">interpolator</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">psf_wavelengths</span><span class="p">,</span> <span class="n">psf_x</span><span class="p">,</span> <span class="n">psf_y</span><span class="p">),</span> <span class="n">psf_cube</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">linear_psf</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">((</span><span class="mf">3.0e-6</span><span class="p">,</span> <span class="n">out_x</span><span class="p">,</span> <span class="n">out_y</span><span class="p">))</span>

<span class="n">diff_lin_psf</span> <span class="o">=</span> <span class="n">reference_psf</span> <span class="o">-</span> <span class="n">linear_psf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reference: min </span><span class="si">{:.3e}</span><span class="s2">, max </span><span class="si">{:.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference_psf</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">reference_psf</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear: min </span><span class="si">{:.3e}</span><span class="s2">, max </span><span class="si">{:.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linear_psf</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">linear_psf</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Diff: min </span><span class="si">{:.3e}</span><span class="s2">, max </span><span class="si">{:.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff_lin_psf</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">diff_lin_psf</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total error: </span><span class="si">{:.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">diff_lin_psf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())))</span>

<span class="n">figA</span><span class="p">,</span> <span class="n">axA</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">reference_psf</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">ref_norm</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">linear_psf</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">ref_norm</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">diff_lin_psf</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">5e-4</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">reference_psf</span><span class="p">[</span><span class="n">ref_pix</span><span class="p">],</span> <span class="n">linear_psf</span><span class="p">[</span><span class="n">ref_pix</span><span class="p">],</span> <span class="s1">&#39;k+&#39;</span><span class="p">)</span>
<span class="n">axA</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The next method is more calculation-intensive, but could be more accurate. We go pixel-by-pixel through the PSF cube and interpolate with a 1D cubic spline along the wavelength axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cubic_psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
        <span class="n">spline</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">psf_wavelengths</span><span class="p">,</span> <span class="n">psf_cube</span><span class="p">[:,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
        <span class="n">cubic_psf</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="mf">3.0e-6</span><span class="p">)</span>
        
<span class="n">diff_cub_psf</span> <span class="o">=</span> <span class="n">reference_psf</span> <span class="o">-</span> <span class="n">cubic_psf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reference: min </span><span class="si">{:.3e}</span><span class="s2">, max </span><span class="si">{:.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference_psf</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">reference_psf</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cubic: min </span><span class="si">{:.3e}</span><span class="s2">, max </span><span class="si">{:.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cubic_psf</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">cubic_psf</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Diff: min </span><span class="si">{:.3e}</span><span class="s2">, max </span><span class="si">{:.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff_cub_psf</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">diff_cub_psf</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total error: </span><span class="si">{:.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">diff_cub_psf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())))</span>

<span class="n">figB</span><span class="p">,</span> <span class="n">axB</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">reference_psf</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">ref_norm</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cubic_psf</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">ref_norm</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">diff_cub_psf</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">5e-4</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">reference_psf</span><span class="p">[</span><span class="n">ref_pix</span><span class="p">],</span> <span class="n">cubic_psf</span><span class="p">[</span><span class="n">ref_pix</span><span class="p">],</span> <span class="s1">&#39;k+&#39;</span><span class="p">)</span>
<span class="n">axB</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>While the log-log plot looks virtually identical to the linear case, the difference image in the spline case shows slightly larger errors in some of the central pixels. This is consistent with the “total error” statistic (the sum of squares of the difference image), which is larger in this second case.</p>
<p>We can see in the plot below that the difference between the two methods is very slight, but the linearly-interpolated PSF is more accurate by about a factor of ~3 in total error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">figC</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">linear_psf</span><span class="p">[</span><span class="n">ref_pix</span><span class="p">],</span> <span class="n">cubic_psf</span><span class="p">[</span><span class="n">ref_pix</span><span class="p">],</span> <span class="s1">&#39;k+&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Linear interpolation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cubic interpolation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="full-trace-psf">
<h2>Full trace PSF<a class="headerlink" href="#full-trace-psf" title="Permalink to this headline">¶</a></h2>
<p>Now we can generate a full PSF for the spectral trace. Note that the PSF at each wavelength is going to be a linear combination of the overlapping adjacent monochromatic PSFs. If geometric distortion is present, it may be beneficial to create this PSF <em>after</em> the trace centers have been fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cube_w</span><span class="p">,</span> <span class="n">cube_x</span><span class="p">,</span> <span class="n">cube_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">psf_x</span><span class="p">,</span> <span class="n">psf_y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
<span class="n">full_psf_cube</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">((</span><span class="n">cube_w</span><span class="p">,</span> <span class="n">cube_x</span><span class="p">,</span> <span class="n">cube_y</span><span class="p">))</span>
<span class="n">nw</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">full_psf_cube</span><span class="o">.</span><span class="n">shape</span>
<span class="n">half</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span> <span class="n">nw</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="k">for</span> <span class="n">wl</span><span class="p">,</span> <span class="n">psf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_psf_cube</span><span class="p">):</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">-</span> <span class="n">half</span>
    <span class="n">lo_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">lo_x</span> <span class="o">=</span> <span class="n">lo_w</span> <span class="o">-</span> <span class="n">lo</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">+</span> <span class="n">half</span>
    <span class="n">hi_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">nw</span><span class="p">)</span>
    <span class="n">hi_x</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">-</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">hi_w</span><span class="p">)</span>
    <span class="n">trace</span><span class="p">[:,</span> <span class="n">lo_w</span><span class="p">:</span><span class="n">hi_w</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psf</span><span class="p">[:,</span> <span class="n">lo_x</span><span class="p">:</span><span class="n">hi_x</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wpsf_aspect</span> <span class="o">=</span> <span class="n">nw</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span>
<span class="n">figD</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">trace_norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">wpsf_aspect</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">trace_norm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="resampling-the-trace">
<h2>Resampling the trace<a class="headerlink" href="#resampling-the-trace" title="Permalink to this headline">¶</a></h2>
<p>Currently, our PSF array is not the same size or position as the trace in the extraction region. While we could shift and trim to the correct size, the spectrum will rarely be centered on a pixel, and is sufficiently under-sampled that fractional pixel shifts in the PSF could cause significant errors in the final extraction. Thus, we will perform a final resampling to the location of the spectrum in the extraction region. To do this, we can use our old friend <code class="docutils literal notranslate"><span class="pre">RegularGridInterpolator</span></code>. We set the center of the WebbPSF trace (originally at row 23) to our fit trace center, and resample appropriately.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trace_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
<span class="n">trace_interpolator</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">trace_row</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">),</span> <span class="n">trace</span><span class="p">)</span>
<span class="n">center_0</span> <span class="o">=</span> <span class="mi">23</span>
<span class="n">center_1</span> <span class="o">=</span> <span class="n">fit_extraction_kernel</span><span class="o">.</span><span class="n">mean_0</span>

<span class="n">out_lo</span> <span class="o">=</span> <span class="n">center_0</span> <span class="o">-</span> <span class="n">center_1</span>
<span class="n">out_hi</span> <span class="o">=</span> <span class="n">out_lo</span> <span class="o">+</span> <span class="n">er_ny</span>

<span class="n">resample_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">out_lo</span><span class="p">,</span> <span class="n">out_hi</span><span class="p">,</span> <span class="n">er_ny</span><span class="p">)</span>
<span class="n">resample_y</span><span class="p">,</span> <span class="n">resample_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">resample_row</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

<span class="n">resampled_trace</span> <span class="o">=</span> <span class="n">trace_interpolator</span><span class="p">((</span><span class="n">resample_y</span><span class="p">,</span> <span class="n">resample_w</span><span class="p">))</span>

<span class="n">figE</span><span class="p">,</span> <span class="n">axE</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">trace_renorm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">resampled_trace</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">axE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resampled_trace</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect_ratio</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">trace_renorm</span><span class="p">)</span>
<span class="n">axE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">extraction_region</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect_ratio</span><span class="p">,</span> 
                  <span class="n">norm</span><span class="o">=</span><span class="n">er_norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="about-this-notebook">
<h2>About this notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">¶</a></h2>
<p><strong>Author:</strong> Graham Kanarek, Staff Scientist, Science Support<br />
<strong>Updated On:</strong> 2020-07-13</p>
<p>Optimal extraction algorithm adapted from <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/">Horne (1986)</a>.</p>
<hr class="docutils" />
<p><a class="reference external" href="#top">Top of Page</a>
<img style="float: right;" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" alt="Space Telescope Logo" width="200px"/></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/optimal_extraction"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../preimaging/preimaging_03_association.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Creating simulated images of the JWST astrometric calibration field in the LMC</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../optimal_extraction_dynamic/Spectral%20Extraction.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NIRSpec MOS Optimal Spectral Extraction</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By STScI<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>