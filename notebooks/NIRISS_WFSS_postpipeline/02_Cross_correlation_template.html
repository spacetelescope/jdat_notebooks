<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   WFSS Spectra - Part 2: Cross Correlation to Determine Redshift — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="03_Spatially_resolved_emission_line_map.html" rel="next" title="WFSS Spectra Part 3: Emission Line Map"/>
  <link href="01_Combine_and_normalize_1D_spectra.html" rel="prev" title="WFSS Spectra Part 1: Combine and Normalize 1D Spectra"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#download-notebook-01-products">
           0. Download notebook 01 products
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#open-optimally-extracted-1d-spectrum-text-file">
           1.Open optimally extracted 1D spectrum text file;
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#continuum-is-visible-we-need-to-subtract-it-before-template-correlation">
             Continuum is visible. We need to subtract it before template correlation.
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#do-cross-correlation-with-an-input-template">
             Do cross-correlation with an input template;
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-synthetic-template">
             Load synthetic template;
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below">
             Binning the template into a course array, if you have too many elements and cause an issue below;
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#in-this-example-this-is-not-necessary">
             -&gt; In this example this is not necessary.
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly">
               CAUTION: Two inputs spectra above have to overlap, if only a small part, to make Specutils works properly.
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#cross-correlation-using-specutils-functionarity">
             Cross Correlation using specutils functionarity;
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#how-does-it-look">
             How does it look?
            </a>
           </li>
          </ul>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         WFSS Spectra - Part 2: Cross Correlation to Determine Redshift
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#download-notebook-01-products">
              0. Download notebook 01 products
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#open-optimally-extracted-1d-spectrum-text-file">
              1.Open optimally extracted 1D spectrum text file;
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#continuum-is-visible-we-need-to-subtract-it-before-template-correlation">
                Continuum is visible. We need to subtract it before template correlation.
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#do-cross-correlation-with-an-input-template">
                Do cross-correlation with an input template;
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#load-synthetic-template">
                Load synthetic template;
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below">
                Binning the template into a course array, if you have too many elements and cause an issue below;
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#in-this-example-this-is-not-necessary">
                -&gt; In this example this is not necessary.
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly">
                  CAUTION: Two inputs spectra above have to overlap, if only a small part, to make Specutils works properly.
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#cross-correlation-using-specutils-functionarity">
                Cross Correlation using specutils functionarity;
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#how-does-it-look">
                How does it look?
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="wfss-spectra-part-2-cross-correlation-to-determine-redshift">
          <h1>
           WFSS Spectra - Part 2: Cross Correlation to Determine Redshift
           <a class="headerlink" href="#wfss-spectra-part-2-cross-correlation-to-determine-redshift" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           optimal extraction of grism spectra; redshift measurement; emission-line maps.  Simplified version of
           <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-imager-and-slitless-spectrograph/niriss-example-science-programs/niriss-wfss-with-nircam-parallel-imaging-of-galaxies-in-lensing-clusters">
            JDox Science Use Case # 33
           </a>
           .
           <br/>
           <strong>
            Data:
           </strong>
           JWST simulated NIRISS images from
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">
            MIRAGE
           </a>
           , run through the
           <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/">
            JWST calibration pipeline
           </a>
           ; galaxy cluster.
           <br/>
           <strong>
            Tools:
           </strong>
           specutils, astropy, pandas, emcee, lmfit, corner, h5py.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           NIRSpec
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            This notebook is 3 of 4 in a set focusing on NIRISS WFSS data:
1. 1D optimal extraction since the JWST pipeline only provides a box extraction.  Optimal extraction improves S/N of spectra for faint sources.
2. Combine and normalize 1D spectra.
3. Cross correlate galaxy with template to get redshift.
4. Spatially resolved emission line map.
           </p>
           <p>
            This notebook derives the redshift of a galaxy with multiple emission lines by using specutils template correlation.  The notebook begins with optimally extracted 1D spectra from notebook #2.
           </p>
           <p>
            <strong>
             Note:
            </strong>
            Spectra without emission lines (e.g., ID 00003 in the previous notebook) may fail with the function here.  For those spectra, Notebook #4 derives the redshift from absorption lines and direct images instead.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>%matplotlib inline
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import os
import numpy as np
import h5py

from astropy.convolution import Gaussian2DKernel
from astropy.io import fits
from astropy.stats import gaussian_fwhm_to_sigma
from astropy.table import QTable
from astropy.table import Table
import astropy.units as u
from astropy.visualization import make_lupton_rgb, SqrtStretch, ImageNormalize, simple_norm
import astropy.wcs as wcs
from astropy.io import ascii
from astropy.nddata import StdDevUncertainty
from astropy.modeling.polynomial import Chebyshev1D
from astropy import constants as const
from astropy.io.misc import hdf5

import astropy
print('astropy', astropy.__version__)
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>astropy 5.2
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import matplotlib.pyplot as plt
import matplotlib as mpl

mpl.rcParams['savefig.dpi'] = 80
mpl.rcParams['figure.dpi'] = 80
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import specutils
from specutils.fitting import continuum 
from specutils.spectra.spectrum1d import Spectrum1D
from specutils.analysis import correlation
from specutils.spectra.spectral_region import SpectralRegion

print("Specutils: ", specutils.__version__)
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Specutils:  1.9.1
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="download-notebook-01-products">
           <h2>
            0. Download notebook 01 products
            <a class="headerlink" href="#download-notebook-01-products" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            These can be also obtained by running the notebooks.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>if not os.path.exists('./output'):
    import zipfile
    import urllib.request
    boxlink = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/NIRISS_lensing_cluster/output.zip'
    boxfile = './output.zip'
    urllib.request.urlretrieve(boxlink, boxfile)
    zf = zipfile.ZipFile(boxfile, 'r')
    zf.extractall()
else:
    print('Already exists')
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Already exists
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="open-optimally-extracted-1d-spectrum-text-file">
           <h2>
            1.Open optimally extracted 1D spectrum text file;
            <a class="headerlink" href="#open-optimally-extracted-1d-spectrum-text-file" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            These are optimally extracted, normalized spectra from notebooks 01a &amp; 01b.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>DIR_OUT = './output/'
filt = 'f200w'

grism = 'G150C'
#grism = 'G150R'

id = '00004'

file_1d = '%sl3_nis_%s_%s_s%s_combine_1d_opt.fits'%(DIR_OUT, filt, grism, id)
fd = fits.open(file_1d)[1].data
hd = fits.open(file_1d)[1].header
fd
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>FITS_rec([(1.71986127, 42.38365482, 1.51015508),
          (1.72453201, 38.56917716, 0.97178267),
          (1.72920275, 35.93947653, 0.62354777),
          (1.73387337, 23.77350774, 0.31776521),
          (1.73854411, 22.91664629, 0.21997059),
          (1.74321485, 18.82889931, 0.14420642),
          (1.74788558, 16.24401145, 0.10209115),
          (1.7525562 , 12.60893081, 0.0719594 ),
          (1.75722694, 10.30048011, 0.05026028),
          (1.76189768, 10.56057566, 0.04827347),
          (1.76656842, 10.80664315, 0.04615251),
          (1.77123904, 10.96807816, 0.04635962),
          (1.77590978, 10.84610055, 0.04520876),
          (1.78058052, 11.14885447, 0.04861023),
          (1.78525114, 11.40215898, 0.05138483),
          (1.78992188, 11.48868052, 0.04729241),
          (1.79459262, 11.58795191, 0.04634937),
          (1.79926336, 11.73206527, 0.04663301),
          (1.80393398, 11.97186637, 0.04839924),
          (1.80860472, 11.9611019 , 0.04914871),
          (1.81327546, 11.77717771, 0.04949575),
          (1.81794608, 11.6472086 , 0.04936947),
          (1.82261682, 11.56556774, 0.04957357),
          (1.82728755, 11.71344915, 0.04822698),
          (1.83195829, 11.65288706, 0.04838117),
          (1.83662891, 11.73176765, 0.04977119),
          (1.84129965, 11.98642048, 0.04941678),
          (1.84597039, 12.14407666, 0.04846335),
          (1.85064113, 12.2294789 , 0.04976337),
          (1.85531175, 12.58098372, 0.05318308),
          (1.85998249, 12.62738604, 0.05218814),
          (1.86465323, 12.40292156, 0.05172025),
          (1.86932385, 12.20461574, 0.05425321),
          (1.87399459, 12.41531018, 0.05062367),
          (1.87866533, 12.49310545, 0.0504054 ),
          (1.88333607, 12.47879134, 0.05008047),
          (1.88800669, 12.48052731, 0.05093631),
          (1.89267743, 12.44949336, 0.0523712 ),
          (1.89734817, 12.46076927, 0.0512366 ),
          (1.90201879, 12.50730277, 0.05058337),
          (1.90668952, 12.43958853, 0.05015841),
          (1.91136026, 12.42111697, 0.05012851),
          (1.916031  , 12.46504231, 0.05106978),
          (1.92070162, 12.43572865, 0.05177651),
          (1.92537236, 12.50323568, 0.0518209 ),
          (1.9300431 , 12.56200541, 0.05140919),
          (1.93471372, 12.524999  , 0.05147548),
          (1.93938446, 12.59353438, 0.0513625 ),
          (1.9440552 , 12.66183485, 0.05211391),
          (1.94872594, 12.62118241, 0.05276501),
          (1.95339656, 12.35676077, 0.05585218),
          (1.9580673 , 12.31514282, 0.05852116),
          (1.96273804, 12.6059867 , 0.0581315 ),
          (1.96740878, 12.7973866 , 0.05491294),
          (1.9720794 , 13.13971683, 0.05460986),
          (1.97675014, 13.4866589 , 0.05613727),
          (1.98142087, 13.52707449, 0.0561673 ),
          (1.98609149, 13.5420637 , 0.05623735),
          (1.99076223, 13.79659428, 0.05655741),
          (1.99543297, 14.08201932, 0.05897219),
          (2.00010371, 14.67188355, 0.05941912),
          (2.00477433, 15.88794186, 0.06221541),
          (2.00944495, 17.92468302, 0.06824417),
          (2.01411581, 21.49804726, 0.0774888 ),
          (2.01878643, 28.19607868, 0.08944139),
          (2.02345729, 39.44270001, 0.111863  ),
          (2.02812791, 54.27856681, 0.14055919),
          (2.03279853, 65.73083879, 0.16328814),
          (2.03746939, 65.81027175, 0.16305239),
          (2.04214001, 54.96117411, 0.14097168),
          (2.04681063, 40.50272461, 0.11793418),
          (2.05148149, 29.101485  , 0.09050252),
          (2.05615211, 22.31114997, 0.07628278),
          (2.06082273, 18.71178258, 0.06872121),
          (2.06549358, 16.61084154, 0.0639475 ),
          (2.0701642 , 15.69277454, 0.06156768),
          (2.07483506, 15.01033761, 0.06108708),
          (2.07950568, 14.67329672, 0.06055912),
          (2.0841763 , 14.5614213 , 0.05847086),
          (2.08884716, 14.3771121 , 0.05891275),
          (2.09351778, 14.25279852, 0.05998107),
          (2.0981884 , 14.25994032, 0.05832638),
          (2.10285926, 14.23462592, 0.05942212),
          (2.10752988, 14.20510948, 0.05972571),
          (2.1122005 , 14.09332883, 0.0590418 ),
          (2.11687136, 14.10938846, 0.05772431),
          (2.12154198, 14.21478398, 0.05830313),
          (2.1262126 , 14.28427848, 0.0584818 ),
          (2.13088346, 14.32668972, 0.05868324),
          (2.13555408, 14.35109908, 0.06058188),
          (2.14022493, 14.41141221, 0.0654428 ),
          (2.14489555, 14.48783474, 0.06164804),
          (2.14956617, 14.43695253, 0.05853947),
          (2.15423703, 14.53766106, 0.05931266),
          (2.15890765, 14.54226979, 0.05933905),
          (2.16357827, 14.63735923, 0.06272671),
          (2.16824913, 14.59274168, 0.06241335),
          (2.17291975, 14.62996471, 0.06227284),
          (2.17759037, 14.78774487, 0.06166981),
          (2.18226123, 14.87656607, 0.06212647),
          (2.18693185, 14.904289  , 0.06553384),
          (2.19160271, 14.78106993, 0.06598214),
          (2.19627333, 14.35750049, 0.06232894),
          (2.20094395, 14.01928977, 0.06014454),
          (2.20561481, 13.6717337 , 0.06316704),
          (2.21028543, 13.27033976, 0.06272573),
          (2.21495605, 13.45858388, 0.06378313),
          (2.2196269 , 14.4814341 , 0.07466454),
          (2.22429752, 15.33204144, 0.08537209),
          (2.22896814, 18.84246093, 0.12252199),
          (2.233639  , 20.87433452, 0.17291249),
          (2.23830962, 28.3669051 , 0.28658091),
          (2.24298024, 31.28393199, 0.3807091 ),
          (2.2476511 , 39.62514071, 0.76141747),
          (2.25232172, 51.17825988, 1.22953228),
          (2.25699258, 63.41328878, 2.06786936)],
         dtype=(numpy.record, [('wavelength', '&gt;f8'), ('flux', '&gt;f8'), ('uncertainty', '&gt;f8')]))
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Normalization of observed spectra; Just for visual purpose;
flux_normalize = 500.
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>wave_200 = fd['wavelength']
flux_200 = fd['flux'] / flux_normalize
flux_err_200 = fd['uncertainty'] / flux_normalize
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Open files for other filters.
filt = 'f150w'
file_1d = '%sl3_nis_%s_%s_s%s_combine_1d_opt.fits'%(DIR_OUT, filt, grism, id)
fd = fits.open(file_1d)[1].data

wave_150 = fd['wavelength']
flux_150 = fd['flux'] / flux_normalize
flux_err_150 = fd['uncertainty'] / flux_normalize

# 
filt = 'f115w'
file_1d = '%sl3_nis_%s_%s_s%s_combine_1d_opt.fits'%(DIR_OUT, filt, grism, id)
fd = fits.open(file_1d)[1].data

wave_115 = fd['wavelength']
flux_115 = fd['flux'] / flux_normalize
flux_err_115 = fd['uncertainty'] / flux_normalize
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># plot all
plt.figure()
plt.errorbar(wave_115, flux_115, ls='-', color='lightblue', label='F115W')
plt.errorbar(wave_150, flux_150, ls='-', color='orange', label='F150W')
plt.errorbar(wave_200, flux_200, ls='-', color='purple', label='F200W')

plt.fill_between(wave_115, -flux_err_115, flux_err_115, ls='-', color='gray', label='', alpha=0.3)
plt.fill_between(wave_150, -flux_err_150, flux_err_150, ls='-', color='gray', label='', alpha=0.3)
plt.fill_between(wave_200, -flux_err_200, flux_err_200, ls='-', color='gray', label='', alpha=0.3)

plt.xlabel('Wavelength / um')
plt.ylim(0., 0.2)
plt.legend(loc=2)
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>&lt;matplotlib.legend.Legend at 0x7fe7938c32b0&gt;
</pre>
              </div>
             </div>
             <img alt="../../_images/02_Cross_correlation_template_13_1.png" src="../../_images/02_Cross_correlation_template_13_1.png"/>
            </div>
           </div>
           <section id="continuum-is-visible-we-need-to-subtract-it-before-template-correlation">
            <h3>
             Continuum is visible. We need to subtract it before template correlation.
             <a class="headerlink" href="#continuum-is-visible-we-need-to-subtract-it-before-template-correlation" title="Permalink to this headline">
              #
             </a>
            </h3>
            <ul class="simple">
             <li>
              <p>
               Strong emission lines are seen. (Hb+Oiii doublet at ~1.55um, and blended Ha+Nii at ~2.1um)
              </p>
             </li>
             <li>
              <p>
               Note that flux excess at the edges of each filter are not real, and should be masked out.
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># F200W

spec_unit = u.MJy

mask = ((wave_200 &gt; 1.75) &amp; (wave_200 &lt; 1.97)) | ((wave_200 &gt; 2.08) &amp; (wave_200 &lt; 2.23))

obs_200 = Spectrum1D(spectral_axis=wave_200[mask]*u.um, flux=flux_200[mask]*spec_unit)
continuum_200 = continuum.fit_generic_continuum(obs_200, model=Chebyshev1D(7))

plt.figure()
plt.errorbar(wave_200, flux_200, ls='-', color='purple', label='F200W')
plt.plot(wave_200[mask], continuum_200(obs_200.spectral_axis),color='r',label='Fitted continuum')
plt.legend(loc=0)

flux_200_sub = flux_200 * spec_unit - continuum_200(wave_200*u.um)

mask_200 = (wave_200 &gt; 1.75) &amp; (wave_200 &lt; 2.23)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_15_1.png" src="../../_images/02_Cross_correlation_template_15_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># F150W

spec_unit = u.MJy

mask = ((wave_150 &gt; 1.35) &amp; (wave_150 &lt; 1.48)) | ((wave_150 &gt; 1.6) &amp; (wave_150 &lt; 1.65))

obs_150 = Spectrum1D(spectral_axis=wave_150[mask]*u.um, flux=flux_150[mask]*spec_unit)
continuum_150 = continuum.fit_generic_continuum(obs_150, model=Chebyshev1D(7))

flux_150_sub = flux_150 * spec_unit - continuum_150(wave_150 * u.um)

plt.figure()
plt.errorbar(wave_150, flux_150, ls='-', color='orange', label='F150W')
plt.plot(wave_150[mask], continuum_150(obs_150.spectral_axis), color='r', label='Fitted continuum')
plt.legend(loc=0)

mask_150 = (wave_150 &gt; 1.35) &amp; (wave_150 &lt; 1.65)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/02_Cross_correlation_template_16_0.png" src="../../_images/02_Cross_correlation_template_16_0.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># F150W

spec_unit = u.MJy

mask = ((wave_115 &gt; 1.05) &amp; (wave_115 &lt; 1.13)) | ((wave_115 &gt; 1.17) &amp; (wave_115 &lt; 1.25))

obs_115 = Spectrum1D(spectral_axis=wave_115[mask]*u.um, flux=flux_115[mask]*spec_unit)
continuum_115 = continuum.fit_generic_continuum(obs_115, model=Chebyshev1D(7))

plt.figure()
plt.errorbar(wave_115, flux_115, ls='-', color='lightblue', label='F115W')
plt.plot(wave_115[mask], continuum_115(obs_115.spectral_axis), color='r', label='Fitted continuum')
plt.ylim(0, 0.5)
plt.legend(loc=0)

flux_115_sub = flux_115 * spec_unit - continuum_115(wave_115 * u.um)
mask_115 = (wave_115 &gt; 1.02)  &amp; (wave_115 &lt; 1.25)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/02_Cross_correlation_template_17_0.png" src="../../_images/02_Cross_correlation_template_17_0.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># plot all
plt.figure()
plt.errorbar(wave_115[mask_115], flux_115_sub[mask_115], ls='-', color='lightblue', label='F115W')
plt.errorbar(wave_150[mask_150], flux_150_sub[mask_150], ls='-', color='orange', label='F150W')
plt.errorbar(wave_200[mask_200], flux_200_sub[mask_200], ls='-', color='purple', label='F200W')

plt.fill_between(wave_115, -flux_err_115, flux_err_115,ls='-', color='gray', label='', alpha=0.3)
plt.fill_between(wave_150, -flux_err_150, flux_err_150,ls='-', color='gray', label='', alpha=0.3)
plt.fill_between(wave_200, -flux_err_200, flux_err_200,ls='-', color='gray', label='', alpha=0.3)

plt.xlabel('Wavelength / um')
plt.legend(loc=2)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>&lt;matplotlib.legend.Legend at 0x7fe793186280&gt;
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_18_1.png" src="../../_images/02_Cross_correlation_template_18_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Concatenate arrays
wave_obs = np.concatenate([wave_115[mask_115], wave_150[mask_150], wave_200[mask_200]])
flux_obs = np.concatenate([flux_115_sub[mask_115], flux_150_sub[mask_150], flux_200_sub[mask_200]])
flux_err_obs = np.concatenate([flux_err_115[mask_115], flux_err_150[mask_150], flux_err_200[mask_200]])

plt.figure()
plt.plot(wave_obs, flux_obs)
plt.fill_between(wave_obs, -flux_err_obs, flux_err_obs, ls='-', color='gray', label='', alpha=0.3)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>&lt;matplotlib.collections.PolyCollection at 0x7fe793168400&gt;
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_19_1.png" src="../../_images/02_Cross_correlation_template_19_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>wht_obs = 1 / flux_err_obs**2
spec_unit = u.MJy

dataspec = QTable([wave_obs*u.um, flux_obs*spec_unit, wht_obs, flux_err_obs],
                   names=('wavelength','flux','weight','uncertainty'))
dataspec_sub = dataspec[dataspec['weight'] &gt; 0.]

# Now make it into a Spectrum1D instance.
p_obs = Spectrum1D(spectral_axis=dataspec_sub['wavelength'],
                 flux=dataspec_sub['flux'],
                 uncertainty=StdDevUncertainty(dataspec_sub['uncertainty']), unit='MJy')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="do-cross-correlation-with-an-input-template">
            <h3>
             Do cross-correlation with an input template;
             <a class="headerlink" href="#do-cross-correlation-with-an-input-template" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             (*Another notebook on Specutils cross correlation by Ivo Busko:
             <a class="reference external" href="https://spacetelescope.github.io/jdat_notebooks/pages/redshift_crosscorr/redshift_crosscorr.html">
              https://spacetelescope.github.io/jdat_notebooks/pages/redshift_crosscorr/redshift_crosscorr.html
             </a>
             )
            </p>
           </section>
           <section id="load-synthetic-template">
            <h3>
             Load synthetic template;
             <a class="headerlink" href="#load-synthetic-template" title="Permalink to this headline">
              #
             </a>
            </h3>
            <ul class="simple">
             <li>
              <p>
               Just to test the functionality, for now we are using the input spectral template used for simulation.
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def read_hdf5(filename):

    contents = {}
    with h5py.File(filename, 'r') as file_obj:
        no_wave_units = False
        no_flux_units = False
        for key in file_obj.keys():
            dataset = file_obj[key]
            try:
                wave_units_string = dataset.attrs['wavelength_units']
            except KeyError:
                wave_units_string = 'micron'
                no_wave_units = True
            try:
                flux_units_string = dataset.attrs['flux_units']
            except KeyError:
                flux_units_string = 'flam_cgs'
                no_flux_units = True

            # Catch common errors
            if wave_units_string.lower() in ['microns', 'angstroms', 'nanometers']:
                wave_units_string = wave_units_string[0:-1]

            # Get the data
            waves = dataset[0]
            fluxes = dataset[1]

            contents[int(key)] = {'wavelengths': waves, 'fluxes': fluxes}

    return contents
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Download files, if not exists yet.
if not os.path.exists('./pipeline_products'):
    import zipfile
    import urllib.request
    boxlink = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/NIRISS_lensing_cluster/pipeline_products.zip'
    boxfile = './pipeline_products.zip'
    urllib.request.urlretrieve(boxlink, boxfile)
    zf = zipfile.ZipFile(boxfile, 'r')
    zf.extractall()
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Template file;
file_temp = './pipeline_products/source_sed_file_from_sources_extend_01_and_sed_file.hdf5'

content = read_hdf5(file_temp)
content
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>{10177: {'wavelengths': array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], dtype=float32),
  'fluxes': array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.4608030e-25,
         8.3700207e-26, 2.1320117e-26], dtype=float32)},
 10265: {'wavelengths': array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], dtype=float32),
  'fluxes': array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.7282180e-25,
         9.9022388e-26, 2.5222983e-26], dtype=float32)},
 10455: {'wavelengths': array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], dtype=float32),
  'fluxes': array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.4816426e-26,
         8.4894260e-27, 2.1624266e-27], dtype=float32)},
 10709: {'wavelengths': array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], dtype=float32),
  'fluxes': array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 3.6238049e-24,
         2.0763458e-24, 5.2888681e-25], dtype=float32)},
 11151: {'wavelengths': array([3.5000000e-02, 3.5081513e-02, 3.5163030e-02, ..., 3.8499809e+01,
         3.8499889e+01, 3.8499973e+01], dtype=float32),
  'fluxes': array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.0507161e-24,
         6.0203300e-25, 1.5334984e-25], dtype=float32)},
 11420: {'wavelengths': array([3.5000000e-02, 3.5081513e-02, 3.5163030e-02, ..., 3.8499809e+01,
         3.8499889e+01, 3.8499973e+01], dtype=float32),
  'fluxes': array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.0168714e-24,
         5.8264083e-25, 1.4841028e-25], dtype=float32)},
 11423: {'wavelengths': array([3.5000000e-02, 3.5081513e-02, 3.5163030e-02, ..., 3.8499809e+01,
         3.8499889e+01, 3.8499973e+01], dtype=float32),
  'fluxes': array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.0033151e-24,
         5.7487341e-25, 1.4643175e-25], dtype=float32)}}
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># The template is already redshifted for simulation. 
# Now, blueshift it to z=0;
z_input  = 2.1 
iix = 10709 # Index for the particular template.

flux_all = content[iix]['fluxes']
wave_all = content[iix]['wavelengths'] / (1. + z_input) * 1e4
plt.plot(wave_all, flux_all, color='orange')
plt.xlim(2000,8000)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>(2000.0, 8000.0)
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_26_1.png" src="../../_images/02_Cross_correlation_template_26_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Cut templates for better fit.
con_tmp = (wave_all &gt; 3600) &amp; (wave_all &lt; 13000)
flux = flux_all[con_tmp]
wave = wave_all[con_tmp]
flux /= flux.max()

wave *= 1.e-4 # force wavelengths in um. (with_spectral_unit doesn't convert)

factor = p_obs.flux.unit # normalize template to a sensible range
template = Spectrum1D(spectral_axis=wave*u.um, flux=flux*factor)

plt.figure()
plt.plot(template.spectral_axis, template.flux, color='orange')
plt.xlabel(template.spectral_axis.unit)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 0, 'um')
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_27_1.png" src="../../_images/02_Cross_correlation_template_27_1.png"/>
             </div>
            </div>
           </section>
           <section id="binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below">
            <h3>
             Binning the template into a course array, if you have too many elements and cause an issue below;
             <a class="headerlink" href="#binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below" title="Permalink to this headline">
              #
             </a>
            </h3>
           </section>
           <section id="in-this-example-this-is-not-necessary">
            <h3>
             -&gt; In this example this is not necessary.
             <a class="headerlink" href="#in-this-example-this-is-not-necessary" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Make this true, if you want to bin;
if False:
    wave_bin = np.arange(wave.min(), wave.max(), 20.0)
    flux_bin = np.interp(wave_bin, wave, flux)
else:
    wave_bin = wave
    flux_bin = flux

factor = p_obs.flux.unit # normalize template to a sensible range
template = Spectrum1D(spectral_axis=wave_bin*u.um, flux=flux_bin*factor)

plt.figure()    
plt.plot(template.spectral_axis, template.flux, color='orange')
plt.xlabel(template.spectral_axis.unit)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 0, 'um')
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_29_1.png" src="../../_images/02_Cross_correlation_template_29_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Continuum fit to the fitting temp;
regions = [SpectralRegion(0.37*u.um, 0.452*u.um), 
           SpectralRegion(0.476*u.um, 0.53*u.um),
           SpectralRegion(0.645*u.um, 0.67*u.um)]

continuum_model = continuum.fit_generic_continuum(template, model=Chebyshev1D(3), exclude_regions=regions)

p_template = template - continuum_model(template.spectral_axis)

plt.figure()
plt.plot(p_template.spectral_axis, p_template.flux, color='orange')
plt.xlabel(p_template.spectral_axis.unit)
plt.title('Continuum subtracted template')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'Continuum subtracted template')
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_30_1.png" src="../../_images/02_Cross_correlation_template_30_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Put data array into Specutils format;
sflux = p_template.flux 
p_smooth_template = Spectrum1D(spectral_axis=p_template.spectral_axis,
                               flux=sflux/sflux.max())
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.figure()
plt.plot(p_smooth_template.spectral_axis, p_smooth_template.flux, color='b', label='Smoothed template')
plt.plot(p_obs.spectral_axis, p_obs.flux, color='red', label='Spectrum')
plt.xlabel(p_smooth_template.spectral_axis.unit)
plt.legend(loc=0)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>&lt;matplotlib.legend.Legend at 0x7fe793088d60&gt;
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_32_1.png" src="../../_images/02_Cross_correlation_template_32_1.png"/>
             </div>
            </div>
            <section id="caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly">
             <h4>
              CAUTION: Two inputs spectra above have to overlap, if only a small part, to make Specutils works properly.
              <a class="headerlink" href="#caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly" title="Permalink to this headline">
               #
              </a>
             </h4>
            </section>
           </section>
           <section id="cross-correlation-using-specutils-functionarity">
            <h3>
             Cross Correlation using specutils functionarity;
             <a class="headerlink" href="#cross-correlation-using-specutils-functionarity" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>### With no additional specifications, both the entire template and entire spectrum 
### will be included in the correlation computation. This in general will incur in 
### a significant increase in execution time. It is advised that the template is cut
### to work only on the useful region.

corr, lag = correlation.template_correlate(p_obs, p_smooth_template)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/astropy/units/quantity.py:673: RuntimeWarning: invalid value encountered in divide
  result = super().__array_ufunc__(function, method, *arrays, **kwargs)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.figure()
plt.gcf().set_size_inches((8., 4.))
plt.plot(lag, corr, linewidth=0.5)
plt.xlabel(lag.unit)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 0, 'km / s')
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_36_1.png" src="../../_images/02_Cross_correlation_template_36_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Redshift based on maximum
index_peak = np.argmax(corr)

v = lag[index_peak]

z = v / const.c.to('km/s')
print("Peak maximum at: ", v)
print("Redshift from peak maximum: ", z)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Peak maximum at:  628833.1938062641 km / s
Redshift from peak maximum:  2.0975617532255066
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Redshift based on parabolic fit to mazimum
n = 8 # points to the left or right of correlation maximum
peak_lags = lag[index_peak-n : index_peak+n+1].value
peak_vals = corr[index_peak-n : index_peak+n+1].value
p = np.polyfit(peak_lags, peak_vals, deg=2)
roots = np.roots(p)

v_fit = np.mean(roots) * u.km/u.s # maximum lies at mid point between roots
z = v_fit / const.c.to('km/s')

print("")
print("Parabolic fit with maximum at: ", v_fit)
print("Redshift from parabolic fit: ", z)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Parabolic fit with maximum at:  629196.3184175593 km / s
Redshift from parabolic fit:  2.0987730065496155
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="how-does-it-look">
            <h3>
             How does it look?
             <a class="headerlink" href="#how-does-it-look" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>print('z =',z)
plt.figure()

plt.plot(
    template.spectral_axis * (1. + z), 
    p_smooth_template.flux / np.max(p_smooth_template.flux), 
    color='b', label='Template'
)

plt.plot(p_obs.spectral_axis, p_obs.flux / np.max(p_obs.flux), label='Observed')
plt.legend(loc=2)
plt.xlabel(p_obs.spectral_axis.unit)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>z = 2.0987730065496155
</pre>
               </div>
              </div>
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 0, 'um')
</pre>
               </div>
              </div>
              <img alt="../../_images/02_Cross_correlation_template_40_2.png" src="../../_images/02_Cross_correlation_template_40_2.png"/>
             </div>
            </div>
           </section>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/NIRISS_WFSS_postpipeline"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="01_Combine_and_normalize_1D_spectra.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            WFSS Spectra Part 1: Combine and Normalize 1D Spectra
           </p>
          </div>
         </a>
         <a class="right-next" href="03_Spatially_resolved_emission_line_map.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            WFSS Spectra Part 3: Emission Line Map
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>