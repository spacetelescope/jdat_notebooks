
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Measuring Galaxy Redshifts with Cross-correlation &#8212; STScI JDAT Notebooks</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/stsci_logo2.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">STScI JDAT Notebooks</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   James Webb Space Telescope Data Analysis Tool Notebooks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRISS WFSS Spectra
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00.%20Optimal%20extraction.html">
   Part 0: Optimal Extraction of NIRISS WFSS Spectrum
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01.%20Combine%20and%20normalize%201D%20spectra.html">
   Part 1: Combine One-Dimensional NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02.%20Cross%20correlation%20template.html">
   Part 2: Cross Correlation to Determine Redshift of NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03.%20Spatially%20resolved%20emission%20line%20map.html">
   Part 3: Spatially Resolved Emission Line Map of NIRISS WFSS Spectra
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MOS Spectroscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
   MOS Spectroscopy of Typical Extragalactic Field
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Example Notebook
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../example_notebook/example_notebook.html">
   Draft: Notebook title
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  IFU Continuum Fit
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
   IFU Data Modeling
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PSF Matched Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
   NIRCam PSF-matched multiband photometry
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MIRI IFU in the LMC
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
   JWST Data Analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Preimaging
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_02_calwebb.html">
   Excuting the JWST pipeline on the  JWST astrometric calibration field in the LMC (part 1)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_01_mirage.html">
   NIRSpec Pre-Imaging with NIRCam
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_03_association.html">
   Creating simulated images of the JWST astrometric calibration field in the LMC
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Optimal Extraction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../optimal_extraction/Spectral%20Extraction-static.html">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../optimal_extraction_dynamic/Spectral%20Extraction.html">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
   Baseline: NIRSpec IFU Optimal Point Source Extraction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Background Estimation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html">
   Imaging Sky Background Estimation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  SOSS Transient Spectroscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
   Analyzing the JWST Pipeline products of HAT-P-1b observations with NIRISS/SOSS
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PSF Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
   NIRCam PSF Photometry Notebook
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Specviz Interaction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
   Specviz notebook/GUI interaction on NIRISS WFSS 1D spectra
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ASDF Example
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../asdf_example/asdf_example.html">
   Example of Converting a FITS File to ASDF
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Composite Model Fitting
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
   Draft: Advanced Composite spectral model fitting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRISS AMI Binary
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/1_niriss_ami_binary.html">
   NIRISS AMI simulation of binary point source AB Dor and calibrator HD37093
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/2_niriss_ami_binary.html">
   NIRISS AMI calibration of binary point source AB Dor and calibrator HD37093
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Aperture Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
   Draft Aperture Photometry
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRSpec MAST Query
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
   MAST Query Tutorial for NIRSpec Users
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MIRI LRS Extraction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
   MIRI LRS Optimal Spectral Extraction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Transient Spectroscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
   Extracting an Exoplanet Transmission Spectrum from NIRSpec BOTS Time Series Observations
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRCam Photometry
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html">
   NIRCam Multiband Photometry
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/redshift_crosscorr/redshift_with_crosscorr.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/spacetelescope/jdat_notebooks/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/redshift_crosscorr/redshift_with_crosscorr.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
   Matplotlib setup for plotting
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-data-files">
     Define data files:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-observation-and-template">
     Read observation and template:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preprocess-spectra">
   Preprocess Spectra
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subtract-continuum">
     Subtract continuum
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#smooth-observed-spectrum">
     Smooth observed spectrum
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cross-correlate">
   Cross correlate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-correlation-peak">
   Fit correlation peak
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visual-check">
   Visual check
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#case-with-lower-resolution-observed-spectrum">
   Case with lower resolution observed spectrum
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Read observation and template:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   Preprocess Spectra
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Subtract continuum
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Smooth observed spectrum
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   Cross correlate
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Measuring Galaxy Redshifts with Cross-correlation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
   Matplotlib setup for plotting
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-data-files">
     Define data files:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-observation-and-template">
     Read observation and template:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preprocess-spectra">
   Preprocess Spectra
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subtract-continuum">
     Subtract continuum
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#smooth-observed-spectrum">
     Smooth observed spectrum
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cross-correlate">
   Cross correlate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-correlation-peak">
   Fit correlation peak
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visual-check">
   Visual check
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#case-with-lower-resolution-observed-spectrum">
   Case with lower resolution observed spectrum
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Read observation and template:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   Preprocess Spectra
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Subtract continuum
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Smooth observed spectrum
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   Cross correlate
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="measuring-galaxy-redshifts-with-cross-correlation">
<h1>Measuring Galaxy Redshifts with Cross-correlation<a class="headerlink" href="#measuring-galaxy-redshifts-with-cross-correlation" title="Permalink to this headline">¶</a></h1>
<p>This notebook attempts to follow the workflow that uses IRAF tasks, described here <a class="reference external" href="http://tdc-www.harvard.edu/iraf/rvsao/xcsao/xcsao.proc.html">http://tdc-www.harvard.edu/iraf/rvsao/xcsao/xcsao.proc.html</a></p>
<p>Observed spectrum from LEGA-C: LEGA-C is a galaxy survey of about 3000 galaxies at z~0.8 and M* &gt; 10^10 M_sun in the COSMOS field. The spectra sample the rest-frame optical between ~3000A and 5000A at high resolution and very high signal-to-noise ratio. More information about the survey can be found here: <a class="reference external" href="http://www.mpia.de/home/legac/">http://www.mpia.de/home/legac/</a></p>
<p>Template from Pacifici et al. 2012.</p>
<p><strong>Developer Notes:</strong>
- This workflow will be rendered in a few simple clicks in specviz
- Preparing the template outside the correlation function allows for applications to different science cases</p>
<p>Author: Ivo Busko</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy.signal.windows</span> <span class="kn">import</span> <span class="n">tukey</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">QTable</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.polynomial</span> <span class="kn">import</span> <span class="n">Chebyshev1D</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span><span class="p">,</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>

<span class="kn">import</span> <span class="nn">specutils</span>
<span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">continuum</span><span class="p">,</span> <span class="n">find_lines_threshold</span><span class="p">,</span> <span class="n">find_lines_derivative</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">FluxConservingResampler</span><span class="p">,</span> <span class="n">SplineInterpolatedResampler</span><span class="p">,</span> <span class="n">LinearInterpolatedResampler</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">correlation</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">SpectralRegion</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">extract_region</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">linear_exciser</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">noise_region_uncertainty</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">gaussian_smooth</span><span class="p">,</span> <span class="n">convolution_smooth</span>

<span class="c1"># Check versions</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numpy: &quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Astropy: &quot;</span><span class="p">,</span><span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Specutils: &quot;</span><span class="p">,</span><span class="n">specutils</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;They should be:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numpy:  1.18.1&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Astropy:  4.0&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Specutils:  1.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Numpy:  1.22.3
Astropy:  5.0.4
Specutils:  1.7.0

They should be:
Numpy:  1.18.1
Astropy:  4.0
Specutils:  1.0
</pre></div>
</div>
</div>
</div>
<div class="section" id="matplotlib-setup-for-plotting">
<h2>Matplotlib setup for plotting<a class="headerlink" href="#matplotlib-setup-for-plotting" title="Permalink to this headline">¶</a></h2>
<p>There are two versions</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">notebook</span></code> – gives interactive plots, but makes the overall notebook a bit harder to scroll</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inline</span></code> – gives non-interactive plots for better overall scrolling</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Use this version for non-interactive plots (easier scrolling of the notebook)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Use this version if you want interactive plots</span>
<span class="c1"># %matplotlib notebook</span>

<span class="c1"># These gymnastics are needed to make the sizes of the figures</span>
<span class="c1"># be the same in both the inline and notebook versions</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.print_figure_kwargs = {&#39;bbox_inches&#39;: None}

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="define-data-files">
<h3>Define data files:<a class="headerlink" href="#define-data-files" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Files are on box</span>

<span class="c1"># Observation and weight.</span>
<span class="n">file1d</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/legac_M1_v3.7_spec1d_130902.fits&#39;</span>
<span class="n">file1dwht</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/legac_M1_v3.7_wht1d_130902.fits&#39;</span>
<span class="c1"># Template.</span>
<span class="n">template_file</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/00006.dat&#39;</span>

<span class="c1"># Plot limits</span>
<span class="n">sp_xlim</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3000.</span><span class="p">,</span> <span class="mf">9000.</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="read-observation-and-template">
<h3>Read observation and template:<a class="headerlink" href="#read-observation-and-template" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Observation</span>
<span class="n">hdu1d</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1d</span><span class="p">)</span>
<span class="n">hdu1dwht</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1dwht</span><span class="p">)</span>

<span class="n">flux</span> <span class="o">=</span> <span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wht</span> <span class="o">=</span> <span class="n">hdu1dwht</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">unc</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wht</span><span class="p">)</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;10^-19 erg s^-1 cm^-2 angstrom^-1&#39;</span><span class="p">)</span>
<span class="n">dataspec</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">([</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span> <span class="n">flux</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">,</span> <span class="n">wht</span><span class="p">,</span> <span class="n">unc</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">],</span> 
                   <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">))</span>
<span class="n">dataspec_sub</span> <span class="o">=</span> <span class="n">dataspec</span><span class="p">[</span><span class="n">dataspec</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">]</span>
<span class="n">dataspec_sub</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_3290/3474148523.py:7: RuntimeWarning: divide by zero encountered in true_divide
  unc = 1./ np.sqrt(wht)
WARNING: FITSFixedWarning: RADECSYS= &#39;FK5 &#39; / Coordinate reference frame 
the RADECSYS keyword is deprecated, use RADESYSa. [astropy.wcs.wcs]
WARNING: FITSFixedWarning: The WCS transformation has more axes (2) than the image it is associated with (1) [astropy.wcs.wcs]
</pre></div>
</div>
<div class="output text_html"><div><i>QTable length=4059</i>
<table id="table140229809421040" class="table-striped table-bordered table-condensed">
<thead><tr><th>wavelength</th><th>flux</th><th>weight</th><th>uncertainty</th></tr></thead>
<thead><tr><th>Angstrom</th><th>1e-19 erg / (Angstrom cm2 s)</th><th></th><th>1e-19 erg / (Angstrom cm2 s)</th></tr></thead>
<thead><tr><th>float64</th><th>float32</th><th>float32</th><th>float32</th></tr></thead>
<tr><td>6229.3</td><td>14.757168769836426</td><td>0.20703126</td><td>2.1977689266204834</td></tr>
<tr><td>6229.900000000001</td><td>26.817886352539062</td><td>0.14812198</td><td>2.5983057022094727</td></tr>
<tr><td>6230.5</td><td>23.95525360107422</td><td>0.14219064</td><td>2.651945114135742</td></tr>
<tr><td>6231.1</td><td>22.23990249633789</td><td>0.14140277</td><td>2.659322738647461</td></tr>
<tr><td>6231.7</td><td>22.505369186401367</td><td>0.13691239</td><td>2.702580213546753</td></tr>
<tr><td>6232.3</td><td>21.266435623168945</td><td>0.12861502</td><td>2.788393974304199</td></tr>
<tr><td>6232.900000000001</td><td>21.235198974609375</td><td>0.11325585</td><td>2.9714584350585938</td></tr>
<tr><td>6233.5</td><td>24.18277359008789</td><td>0.096821204</td><td>3.2137696743011475</td></tr>
<tr><td>6234.1</td><td>32.75020980834961</td><td>0.085573986</td><td>3.4184489250183105</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>8677.9</td><td>46.554779052734375</td><td>0.08704492</td><td>3.3894426822662354</td></tr>
<tr><td>8678.5</td><td>45.3433837890625</td><td>0.08504387</td><td>3.429086923599243</td></tr>
<tr><td>8679.1</td><td>46.19153594970703</td><td>0.06836141</td><td>3.824674606323242</td></tr>
<tr><td>8679.7</td><td>49.632057189941406</td><td>0.058549482</td><td>4.132743835449219</td></tr>
<tr><td>8680.3</td><td>40.599159240722656</td><td>0.04911178</td><td>4.51239538192749</td></tr>
<tr><td>8680.9</td><td>46.05984115600586</td><td>0.0454888</td><td>4.6886491775512695</td></tr>
<tr><td>8681.5</td><td>53.85580825805664</td><td>0.049859755</td><td>4.478421211242676</td></tr>
<tr><td>8682.1</td><td>51.271400451660156</td><td>0.058481682</td><td>4.135138511657715</td></tr>
<tr><td>8682.7</td><td>51.61949920654297</td><td>0.069049306</td><td>3.805575370788574</td></tr>
<tr><td>8683.3</td><td>51.20613098144531</td><td>0.08998948</td><td>3.3335282802581787</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now make it into a Spectrum1D instance.</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span> 
                 <span class="n">flux</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> 
                 <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Template</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">2.E-5</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># normalize template to a sensible range</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">,</span> 
                      <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that in this and in subsequent plots, we are showing just the wavelength range of</span>
<span class="c1"># interest. The template covers a significantly wider range.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Input data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Input data&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_10_1.png" src="../../_images/redshift_with_crosscorr_10_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="preprocess-spectra">
<h2>Preprocess Spectra<a class="headerlink" href="#preprocess-spectra" title="Permalink to this headline">¶</a></h2>
<div class="section" id="subtract-continuum">
<h3>Subtract continuum<a class="headerlink" href="#subtract-continuum" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> 
<span class="n">p_obs</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
<span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> 
<span class="n">p_template</span> <span class="o">=</span> <span class="n">template</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;After continuum subtraction&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;After continuum subtraction&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_14_1.png" src="../../_images/redshift_with_crosscorr_14_1.png" />
</div>
</div>
</div>
<div class="section" id="smooth-observed-spectrum">
<h3>Smooth observed spectrum<a class="headerlink" href="#smooth-observed-spectrum" title="Permalink to this headline">¶</a></h3>
<p>The IRAF task XCORR works in Fourier space. In there, it applies a cosine bell filter (raised-cosine filter) to the observed spectrum, before multiplying together the two Fourier transforms. Here, we are working in data space, thus we emulate the filter operation by convolving the observed spectrum with a windowed sinc smoothing function.</p>
<p><strong>Developer Notes:</strong></p>
<ul class="simple">
<li><p>We should implement this window function in specutils so the user doe
sn’t have to: <a class="reference external" href="https://github.com/astropy/specutils/issues/636">https://github.com/astropy/specutils/issues/636</a></p></li>
<li><p>We should implement a fourier-space version of the xcorr as well as t
he current freq/wave-space version</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Smooth data with sinc kernel</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># Cutoff frequency as a fraction of the sampling rate (in (0, 0.5)).</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.49</span>   <span class="c1"># Transition band, as a fraction of the sampling rate (in (0, 0.5)).</span>

<span class="c1"># The IRAF task uses the above values. Here, we try</span>
<span class="c1"># a much lower cutoff frequency to really dampen the</span>
<span class="c1"># high frequency structure in the observed spectrum.</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.05</span> 

<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">4</span> <span class="o">/</span> <span class="n">b</span><span class="p">)))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># N must be odd</span>
    <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
 
<span class="c1"># Compute sinc filter and Blackman window. Multiply filter </span>
<span class="c1"># by window and normalize to get unity gain.</span>
<span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">w</span> <span class="o">=</span> <span class="mf">0.42</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
    <span class="mf">0.08</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">filt</span> <span class="o">*=</span> <span class="n">w</span>
<span class="n">filt</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>

<span class="c1"># Smooth</span>
<span class="n">p_obs_smoothed</span> <span class="o">=</span> <span class="n">convolution_smooth</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;After smoothing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;After smoothing&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_19_1.png" src="../../_images/redshift_with_crosscorr_19_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="cross-correlate">
<h2>Cross correlate<a class="headerlink" href="#cross-correlate" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correlation. </span>
<span class="c1">#</span>
<span class="c1"># With no additional specifications, both the entire template and entire spectrum </span>
<span class="c1"># will be included in the correlation computation. This in general will incur in </span>
<span class="c1"># a significant increase in execution time. It is advised that the template is cut</span>
<span class="c1"># to work only on the useful region.</span>

<span class="n">corr</span><span class="p">,</span> <span class="n">lag</span> <span class="o">=</span> <span class="n">correlation</span><span class="o">.</span><span class="n">template_correlate</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="p">,</span> <span class="n">p_template</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">300000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;km / s&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_22_1.png" src="../../_images/redshift_with_crosscorr_22_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redshift based on maximum</span>
<span class="n">index_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">corr</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Peak maximum at: &quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redshift from peak maximum: &quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Peak maximum at:  227330.87493406623 km / s
Redshift from peak maximum:  0.7582941760798607
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fit-correlation-peak">
<h2>Fit correlation peak<a class="headerlink" href="#fit-correlation-peak" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redshift based on parabolic fit to mazimum</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># points to the left or right of correlation maximum</span>

<span class="n">peak_lags</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">peak_vals</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">peak_vals</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">v_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="c1"># maximum lies at mid point between roots</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v_fit</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parabolic fit with maximum at: &quot;</span><span class="p">,</span> <span class="n">v_fit</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redshift from parabolic fit: &quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Parabolic fit with maximum at:  227331.8076513029 km / s
Redshift from parabolic fit:  0.7582972872896719
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visual-check">
<h2>Visual check<a class="headerlink" href="#visual-check" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="c1"># plt.xlim(sp_xlim)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">peak_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">peak_lags</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Fit to correlation peak&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Fit to correlation peak&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_27_1.png" src="../../_images/redshift_with_crosscorr_27_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_ref</span> <span class="o">=</span> <span class="mf">0.758</span> <span class="c1"># &quot;true&quot; redshift, corresponding to 227242.6 km/s</span>

<span class="n">template_z</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">),</span> <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template_z</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template_z</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Redshifted original template and original observed spectrum&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Redshifted original template and original observed spectrum&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_29_1.png" src="../../_images/redshift_with_crosscorr_29_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_ref</span><span class="p">)</span> <span class="o">/</span> <span class="n">z_ref</span> <span class="o">*</span> <span class="mf">100.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in the derived redshift: &quot;</span><span class="p">,</span> <span class="n">z_err</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error in the derived redshift:  0.0392199590596217 %
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="case-with-lower-resolution-observed-spectrum">
<h2>Case with lower resolution observed spectrum<a class="headerlink" href="#case-with-lower-resolution-observed-spectrum" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Read observation and template:<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Observation</span>
<span class="n">hdu1d</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1d</span><span class="p">)</span>
<span class="n">hdu1dwht</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1dwht</span><span class="p">)</span>

<span class="n">flux</span> <span class="o">=</span> <span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wht</span> <span class="o">=</span> <span class="n">hdu1dwht</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">unc</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wht</span><span class="p">)</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CD1_1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>

<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;10^-19 erg s^-1 cm^-2 angstrom^-1&#39;</span><span class="p">)</span>
<span class="n">dataspec</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">([</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span> <span class="n">flux</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">,</span> <span class="n">wht</span><span class="p">,</span> <span class="n">unc</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">],</span> 
                   <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">))</span>
<span class="n">dataspec_sub</span> <span class="o">=</span> <span class="n">dataspec</span><span class="p">[</span><span class="n">dataspec</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">]</span>
<span class="n">dataspec_sub</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_3290/1377199938.py:7: RuntimeWarning: divide by zero encountered in true_divide
  unc = 1./ np.sqrt(wht)
</pre></div>
</div>
<div class="output text_html"><div><i>QTable length=4059</i>
<table id="table140230818021328" class="table-striped table-bordered table-condensed">
<thead><tr><th>wavelength</th><th>flux</th><th>weight</th><th>uncertainty</th></tr></thead>
<thead><tr><th>Angstrom</th><th>1e-19 erg / (Angstrom cm2 s)</th><th></th><th>1e-19 erg / (Angstrom cm2 s)</th></tr></thead>
<thead><tr><th>float64</th><th>float32</th><th>float32</th><th>float32</th></tr></thead>
<tr><td>6229.3</td><td>14.757168769836426</td><td>0.20703126</td><td>2.1977689266204834</td></tr>
<tr><td>6229.900000000001</td><td>26.817886352539062</td><td>0.14812198</td><td>2.5983057022094727</td></tr>
<tr><td>6230.5</td><td>23.95525360107422</td><td>0.14219064</td><td>2.651945114135742</td></tr>
<tr><td>6231.1</td><td>22.23990249633789</td><td>0.14140277</td><td>2.659322738647461</td></tr>
<tr><td>6231.7</td><td>22.505369186401367</td><td>0.13691239</td><td>2.702580213546753</td></tr>
<tr><td>6232.3</td><td>21.266435623168945</td><td>0.12861502</td><td>2.788393974304199</td></tr>
<tr><td>6232.900000000001</td><td>21.235198974609375</td><td>0.11325585</td><td>2.9714584350585938</td></tr>
<tr><td>6233.5</td><td>24.18277359008789</td><td>0.096821204</td><td>3.2137696743011475</td></tr>
<tr><td>6234.1</td><td>32.75020980834961</td><td>0.085573986</td><td>3.4184489250183105</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>8677.9</td><td>46.554779052734375</td><td>0.08704492</td><td>3.3894426822662354</td></tr>
<tr><td>8678.5</td><td>45.3433837890625</td><td>0.08504387</td><td>3.429086923599243</td></tr>
<tr><td>8679.1</td><td>46.19153594970703</td><td>0.06836141</td><td>3.824674606323242</td></tr>
<tr><td>8679.7</td><td>49.632057189941406</td><td>0.058549482</td><td>4.132743835449219</td></tr>
<tr><td>8680.3</td><td>40.599159240722656</td><td>0.04911178</td><td>4.51239538192749</td></tr>
<tr><td>8680.9</td><td>46.05984115600586</td><td>0.0454888</td><td>4.6886491775512695</td></tr>
<tr><td>8681.5</td><td>53.85580825805664</td><td>0.049859755</td><td>4.478421211242676</td></tr>
<tr><td>8682.1</td><td>51.271400451660156</td><td>0.058481682</td><td>4.135138511657715</td></tr>
<tr><td>8682.7</td><td>51.61949920654297</td><td>0.069049306</td><td>3.805575370788574</td></tr>
<tr><td>8683.3</td><td>51.20613098144531</td><td>0.08998948</td><td>3.3335282802581787</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now make it into a Spectrum1D instance.</span>
<span class="n">obs_orig</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span> 
                 <span class="n">flux</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> 
                 <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change resolution of spectrum</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">gaussian_smooth</span><span class="p">(</span><span class="n">obs_orig</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Template</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">2.E-5</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># normalize template to a sensible range</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">,</span> 
                      <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that in this and in subsequent plots, we are showing just the wavelength range of</span>
<span class="c1"># interest. The template covers a significantly wider range.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Input data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Input data&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_37_1.png" src="../../_images/redshift_with_crosscorr_37_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>Preprocess Spectra<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>Subtract continuum<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> 
<span class="n">p_obs</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
<span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> 
<span class="n">p_template</span> <span class="o">=</span> <span class="n">template</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;After continuum subtraction&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;After continuum subtraction&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_40_2.png" src="../../_images/redshift_with_crosscorr_40_2.png" />
</div>
</div>
</div>
<div class="section" id="id4">
<h3>Smooth observed spectrum<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Smooth data with sinc kernel</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># Cutoff frequency as a fraction of the sampling rate (in (0, 0.5)).</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.49</span>   <span class="c1"># Transition band, as a fraction of the sampling rate (in (0, 0.5)).</span>

<span class="c1"># The IRAF task uses the above values. Here, we try</span>
<span class="c1"># a much lower cutoff frequency to really dampen the</span>
<span class="c1"># high frequency structure in the observed spectrum.</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.05</span> 

<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">4</span> <span class="o">/</span> <span class="n">b</span><span class="p">)))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># N must be odd</span>
    <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
 
<span class="c1"># Compute sinc filter and Blackman window. Multiply filter </span>
<span class="c1"># by window and normalize to get unity gain.</span>
<span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">w</span> <span class="o">=</span> <span class="mf">0.42</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
    <span class="mf">0.08</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">filt</span> <span class="o">*=</span> <span class="n">w</span>
<span class="n">filt</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>

<span class="c1"># Smooth</span>
<span class="n">p_obs_smoothed</span> <span class="o">=</span> <span class="n">convolution_smooth</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;After smoothing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;After smoothing&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_42_1.png" src="../../_images/redshift_with_crosscorr_42_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>Cross correlate<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">corr</span><span class="p">,</span> <span class="n">lag</span> <span class="o">=</span> <span class="n">correlation</span><span class="o">.</span><span class="n">template_correlate</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="p">,</span> <span class="n">p_template</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">300000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;km / s&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_44_1.png" src="../../_images/redshift_with_crosscorr_44_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redshift based on maximum</span>
<span class="n">index_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">corr</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Peak maximum at: &quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redshift from peak maximum: &quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="c1"># Redshift based on parabolic fit to mazimum</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># points to the left or right of correlation maximum</span>

<span class="n">peak_lags</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">peak_vals</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">peak_vals</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">v_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="c1"># maximum lies at mid point between roots</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v_fit</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parabolic fit with maximum at: &quot;</span><span class="p">,</span> <span class="n">v_fit</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redshift from parabolic fit: &quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Peak maximum at:  227330.87493406623 km / s
Redshift from peak maximum:  0.7582941760798607

Parabolic fit with maximum at:  227368.82804418207 km / s
Redshift from parabolic fit:  0.7584207740282182
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_ref</span> <span class="o">=</span> <span class="mf">0.758</span> <span class="c1"># &quot;true&quot; redshift, corresponding to 227242.6 km/s</span>

<span class="n">template_z</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">),</span> <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template_z</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template_z</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Redshifted original template and original observed spectrum&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Redshifted original template and original observed spectrum&#39;)
</pre></div>
</div>
<img alt="../../_images/redshift_with_crosscorr_46_1.png" src="../../_images/redshift_with_crosscorr_46_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_ref</span><span class="p">)</span> <span class="o">/</span> <span class="n">z_ref</span> <span class="o">*</span> <span class="mf">100.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in the derived redshift: &quot;</span><span class="p">,</span> <span class="n">z_err</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error in the derived redshift:  0.055511085516908004 %
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/redshift_crosscorr"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By STScI<br/>
    
        &copy; Copyright 2022.<br/>
      <div class="extra_footer">
        <div class="header">
    <div class="header content">
        <img class="logo" src="../../Jspectra.svg" alt="JWST Data Analysis Notebooks"/>
        <div class="search">
            <div class="searchbox"></div>
            <div class="searchbutton">
                Filter Notebooks
            </div>
        </div>
    </div>
</div>

      </div>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>