

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>BOTS Time Series Observations &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Redshift and Template Fitting" href="../galaxy_redshift/redshift_fitting.html" />
    <link rel="prev" title="MOS Spectroscopy of Extragalactic Field" href="../mos_spectroscopy_advanced/MOSspec_advanced.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>BOTS Time Series Observations</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">BOTS Time Series Observations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-parameters">Setup Parameters</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-load-nirspec-data">Download and Load NIRSpec data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-2d-spectral-data">Visualizing the 2D spectral data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-1d-spectra-from-2d-array-of-images">Extract 1D spectra from 2D array of images</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-1d-spectral-data">Visualizing the 1D spectral data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes">Calculate Orbital Phase and a separate fine grid model used for plotting purposes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-systematic-drift-on-the-detector">Dealing with Systematic Drift On the Detector</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-arrays-of-the-vectors-used-for-detrending">Create arrays of the vectors used for detrending.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transit-and-limb-darkening-model-functions">Transit and Limb-Darkening Model Functions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-transit-model-function">Now define the transit model function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data">Now define the function to generate the transit light curve and compare it to the data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-transit-light-curves">FIT Transit Light Curves</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-wavelengths-to-fit-over">Setup Wavelengths to fit over</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-wavelength-bins-fitting-each-lightcurve">Loop Over Wavelength Bins Fitting Each Lightcurve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin">Note this step takes considerable time to complete (~20 min, few minutes/bin)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-measured-exoplanet-transmission-spectrum-vs-injected">Plot Measured Exoplanet Transmission Spectrum vs Injected</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="bots-time-series-observations">
<h1>BOTS Time Series Observations<a class="headerlink" href="#bots-time-series-observations" title="Permalink to this heading">#</a></h1>
<p><strong>Use case:</strong> Bright Object Time Series; extracting exoplanet spectra.<br>
<strong>Data:</strong> JWST simulated NIRSpec data from ground-based campaign; GJ436b spectra from the Goyal et al. (2018).<br>
<strong>Tools:</strong>  scikit, lmfit, scipy, matplotlip, astropy, pandas.<br>
<strong>Cross-intrument:</strong> . <br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br>
<strong>Author:</strong> David K. Sing (dsing&#64;jhu.edu)<br>
<strong>Last updated:</strong> 2 July 2020</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This notebook uses time series JWST NIRSpec data taken during a ground-based campaign to illustrate extracting exoplanet spectra from time-series observations.</p>
<p>The data are derived from the ISIM-CV3, the cryovacuum campaign of the JWST Integrated Science Instrument Module (ISIM), that took place at Goddard Space Flight Center during the winter 2015-2016 (Kimble et al. 2016). The data can be found at https://www.cosmos.esa.int/web/jwst-nirspec/test-data, and detailed and insightful report of the data by G. Giardino, S. Birkmann, P. Ferruit, B. Dorner, B. Rauscher can be found here: ftp://ftp.cosmos.esa.int/jwstlib/ReleasedCV3dataTimeSeries/CV3_TimeSeries_PRM.tgz</p>
<p>This NIRSpec time series dataset has had a transit light curve injected at the pixel-level, which closely mimics a bright object time series (BOTS) observation of a transiting exoplanet. In this case, a GJ436b spectra from the
<strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018MNRAS.474.5158G/">Goyal et al. (2018)</a></strong>
exoplanet grid was selected (clear atmosphere at solar metallicity).  With an actual NIRSpec dataset, the noise properties of the detector, jitter, and the effects on extracting exoplanet spectra from time-series observations can more accurately simulated.</p>
<p>Broadly the aim of this notebook is to work with these time series observations to:</p>
<ol class="arabic simple">
<li><p>Extract 1D spectra from the 2D spectral images.</p></li>
<li><p>Define a time series model to fit to the wavelength dependent transit light curve.</p></li>
<li><p>Fit each time series wavelength bin of the 1D spectra, measuring the desired quantity <span class="math notranslate nohighlight">\(R_{pl}(\lambda)/R_{star}\)</span>.</p></li>
<li><p>Produce a measured transmission spectrum that can then be compared to models.</p></li>
</ol>
<p>The example outputs the fit light curves for each spectral bin, along with fitting statistics.</p>
</section>
<section id="load-packages">
<h2>Load packages<a class="headerlink" href="#load-packages" title="Permalink to this heading">#</a></h2>
<p>This notebook uses packages (matplotlib, astropy, scipy, glob, lmfit, pickle, os, sklearn) which can all be installed in a standard fashion through pip.</p>
<p>Several routines to calculate limb-darkening and a transit model were extracted from ExoTiC-ISm
(<strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2281L/">Laginja &amp; Wakeford 2020</a></strong> ;
https://github.com/hrwakeford/ExoTiC-ISM), and slightly adapted. The full set of stellar models used for the limb-darkening calculation can also be downloaded from ExoTiC-ISM, as this notebook only downloads and loads the single stellar model used to generate the limb darkening.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span><span class="p">,</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.models</span> <span class="kn">import</span> <span class="n">custom_model</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.fitting</span> <span class="kn">import</span> <span class="n">LevMarLSQFitter</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">splev</span><span class="p">,</span> <span class="n">splrep</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">readsav</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">mkdir</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setup-parameters">
<h2>Setup Parameters<a class="headerlink" href="#setup-parameters" title="Permalink to this heading">#</a></h2>
<p>Parameters of the fit include directories where the data and limb darkening stellar models are held, along with properties of the planet and star. The stellar and planet values that have been entered here (modeled after GJ436) are the same as was used to model the injected transit.  Note, the 4500K stellar model used to inject the transit was hotter than GJ436A.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SETUP  ----------------------------------------------</span>
<span class="c1"># Setup directories</span>
<span class="n">save_directory</span> <span class="o">=</span> <span class="s1">&#39;./notebookrun2/&#39;</span>          <span class="c1"># Local directory to save files to</span>
<span class="n">data_directory</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>                       <span class="c1"># Local data to work with fits files if desired</span>

<span class="c1"># Setup Detector Properties &amp; Rednoise measurement timescale </span>
<span class="n">gain</span> <span class="o">=</span> <span class="mf">1.0</span>   <span class="c1"># 2D spectra has already converted to counts, gain of detector is 1.0</span>
<span class="n">binmeasure</span> <span class="o">=</span> <span class="mi">256</span>   <span class="c1"># Binning technique to measure rednoise, choose bin size to evaluate sigma_r</span>
<span class="n">number_of_images</span> <span class="o">=</span> <span class="mi">8192</span>  <span class="c1"># Number of images in the dataset</span>

<span class="c1"># Setup Planet Properties</span>
<span class="n">grating</span> <span class="o">=</span> <span class="s1">&#39;NIRSpecPrism&#39;</span>
<span class="n">ld_model</span> <span class="o">=</span> <span class="s1">&#39;3D&#39;</span>      <span class="c1"># 3D/1D stellar model choice (transit was injected with the 3D model)</span>

<span class="c1"># Setup Stellar Properties for Limb-Darkening Calculation</span>
<span class="n">Teff</span> <span class="o">=</span> <span class="mi">4500</span>           <span class="c1"># Effective Temperature (K)</span>
<span class="n">logg</span> <span class="o">=</span> <span class="mf">4.5</span>            <span class="c1"># Surface Gravity</span>
<span class="n">M_H</span> <span class="o">=</span> <span class="mf">0.0</span>            <span class="c1"># Stellar Metallicity log_10[M/H]</span>
<span class="n">Rstar</span> <span class="o">=</span> <span class="mf">0.455</span>          <span class="c1"># Planet radius (in units of solar radii Run)</span>

<span class="c1"># Setup Transit parameters (can get from NASA exoplanet archive)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mf">2454865.084034</span>              <span class="c1"># bjd time of inferior conjunction </span>
<span class="n">per</span> <span class="o">=</span> <span class="mf">2.64389803</span>                  <span class="c1"># orbital period (days) BJD_TDB</span>
<span class="n">rp</span> <span class="o">=</span> <span class="mf">0.0804</span>                      <span class="c1"># Planet radius (in units of stellar radii)</span>
<span class="n">a_Rs</span> <span class="o">=</span> <span class="mf">14.54</span>                       <span class="c1"># Semi-major axis (input a/Rstar so units of stellar radii)</span>
<span class="n">inc</span> <span class="o">=</span> <span class="mf">86.858</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span>      <span class="c1"># Orbital inclination (in degrees-&gt;radians)</span>
<span class="n">ecc</span> <span class="o">=</span> <span class="mf">0.0</span>                         <span class="c1"># Eccentricity</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span>         <span class="c1"># Longitude of periastron (in degrees-&gt;radians)</span>

<span class="n">rho_star</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">6.67259E-8</span><span class="o">*</span><span class="p">(</span><span class="n">per</span><span class="o">*</span><span class="mi">86400</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a_Rs</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>     <span class="c1"># Stellar Density (g/cm^3) from a/Rs</span>
<span class="c1"># a_Rs=(rho_star*6.67259E-8*per_sec*per_sec/(3*np.pi))**(1/3)  # a/Rs from Stellar Density (g/cm^3)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create local directories</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_directory</span><span class="p">):</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>      <span class="c1"># Create a new directory to save outputs to if needed</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid&#39;</span><span class="p">):</span> 
    <span class="n">mkdir</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid&#39;</span><span class="p">)</span>      <span class="c1"># Create new directory to save</span>
<span class="n">limb_dark_directory</span> <span class="o">=</span> <span class="n">save_directory</span>    <span class="c1"># Point to limb darkeing directory contaning 3DGrid/ directory</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="download-and-load-nirspec-data">
<h1>Download and Load NIRSpec data<a class="headerlink" href="#download-and-load-nirspec-data" title="Permalink to this heading">#</a></h1>
<p>The fits images are loaded, and information including the image date and science spectra are saved.</p>
<p>A default flux offset value BZERO is also taken from the header and subtracted from every science frame.</p>
<p>Reading in the 2^13 fits files is slow.  To speed things up, we created a pickle file of the for first instance the fits images are loaded.  This 1GB pickle file is loaded instead of reading the fits files if found.</p>
<p>Alternatively, the fits files can be downloaded here:
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/Archive.Trace_SLIT_A_1600_SRAD-PRM-PS-6007102143_37803_JLAB88_injected.tar.gz.  The images are in a tar.gz archvie, which needs to be un-archived and data_directory variable set to the directory in the SETUP cell above.</p>
<p>The cell below downloads the 1GB JWST data pickle file, and several other files needed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download 1GB NIRSpec Data</span>
<span class="n">fn_jw</span> <span class="o">=</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;jwst_data.pickle&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/jwst_data.pickle&#39;</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;jwst_data.pickle&#39;</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;JWST Data Download Complete&#39;</span><span class="p">)</span>

<span class="c1"># Download further files needed, move to local directory for easier repeated access</span>
<span class="n">fn_sens</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">)</span>
<span class="n">dest</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_sens</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">)</span>  <span class="c1"># Move files to save_directory</span>

<span class="n">fn_ld</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/3DGrid/mmu_t45g45m00v05.flx&#39;</span><span class="p">)</span>
<span class="n">destld</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_ld</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid/mmu_t45g45m00v05.flx&#39;</span><span class="p">)</span>        
</pre></div>
</div>
</div>
</div>
<p>Loads the Pickle File data.  Alternatly, the data can be read from the original fits files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>
    <span class="n">dbfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="c1"># for reading also binary mode is important</span>
    <span class="n">jwst_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading JWST data from Pickle File&#39;</span><span class="p">)</span>
    <span class="n">bjd</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;bjd&#39;</span><span class="p">]</span>
    <span class="n">wsdata_all</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;wsdata_all&#39;</span><span class="p">]</span>
    <span class="n">shx</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;shx&#39;</span><span class="p">]</span>
    <span class="n">shy</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;shy&#39;</span><span class="p">]</span>
    <span class="n">common_mode</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;common_mode&#39;</span><span class="p">]</span>
    <span class="n">all_spec</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;all_spec&#39;</span><span class="p">]</span>
    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;exposure_length&#39;</span><span class="p">]</span>
    <span class="n">dbfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>
    <span class="c1"># Load all fits images</span>
    <span class="c1"># Arrays created for BJD time, and the white light curve total_counts</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">data_directory</span><span class="o">+</span><span class="s2">&quot;*.fits&quot;</span><span class="p">)</span>
    <span class="n">index_of_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)</span> 
    <span class="n">bjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_images</span><span class="p">))</span>
    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_images</span><span class="p">))</span>
    <span class="n">all_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">number_of_images</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_images</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="c1"># hdul.info()</span>
        <span class="n">bjd_image</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BJD_TDB&#39;</span><span class="p">]</span>
        <span class="n">BZERO</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BZERO&#39;</span><span class="p">]</span>        <span class="c1"># flux value offset</span>
        <span class="n">bjd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bjd_image</span>
        <span class="n">expleng</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INTTIME&#39;</span><span class="p">]</span>    <span class="c1"># Total integration time for one MULTIACCUM (seconds)</span>
        <span class="n">exposure_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">expleng</span><span class="o">/</span><span class="mf">86400.</span>    <span class="c1"># Total integration time for one MULTIACCUM (days)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bjd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># total counts in image</span>
        <span class="c1"># total_counts[i]=gain*np.sum(data[11:18,170:200]-BZERO) # total counts in 12 pix wide aperture around pixel 60 image</span>
        <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">BZERO</span><span class="p">)</span>     <span class="c1"># Load all spectra into an array subtract flux value offset</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Sort data</span>
    <span class="n">srt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">bjd</span><span class="p">)</span> <span class="c1"># index to sort</span>
    <span class="n">bjd</span> <span class="o">=</span> <span class="n">bjd</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>
    <span class="c1"># total_counts=total_counts[srt]</span>
    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">exposure_length</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>
    <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">srt</span><span class="p">]</span>

    <span class="c1"># Get Wavelength of Data</span>
    <span class="n">file_wave</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/JWST_NIRSpec_wavelength_microns.txt&#39;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_wave</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">wsdata_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wsdata size :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data wavelength Loaded :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wsdata new size :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="c1"># Read in Detrending parameters</span>
    <span class="c1"># Mean of parameter must be 0.0 to be properly normalized</span>
    <span class="c1"># Idealy standard deviation of parameter = 1.0</span>
    <span class="n">file_xy</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/JWST_NIRSpec_Xposs_Yposs_CM_detrending.txt&#39;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_xy</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">shx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">shy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">common_mode</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    
    <span class="c1"># Store Data in a pickle file</span>
    <span class="n">jwst_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bjd&#39;</span><span class="p">:</span> <span class="n">bjd</span><span class="p">,</span> <span class="s1">&#39;wsdata_all&#39;</span><span class="p">:</span> <span class="n">wsdata_all</span><span class="p">,</span> <span class="s1">&#39;shx&#39;</span><span class="p">:</span> <span class="n">shx</span><span class="p">,</span> <span class="s1">&#39;shy&#39;</span><span class="p">:</span> <span class="n">shy</span><span class="p">,</span> <span class="s1">&#39;common_mode&#39;</span><span class="p">:</span> <span class="n">common_mode</span><span class="p">,</span> <span class="s1">&#39;all_spec&#39;</span><span class="p">:</span> <span class="n">all_spec</span><span class="p">,</span> <span class="s1">&#39;exposure_length&#39;</span><span class="p">:</span> <span class="n">exposure_length</span><span class="p">}</span>
    <span class="n">dbfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;jwst_data.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="c1"># Its important to use binary mode</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jwst_data</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
    <span class="n">dbfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="visualizing-the-2d-spectral-data">
<h1>Visualizing the 2D spectral data<a class="headerlink" href="#visualizing-the-2d-spectral-data" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expnum</span> <span class="o">=</span> <span class="mi">2</span>                                           <span class="c1"># Choose Exposure number to view</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>                   <span class="c1"># Resolution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>                     <span class="c1"># Aspect ratio (the CCD is quite long!!!)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;magma&#39;</span>                   <span class="c1"># Colormap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monospace&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.monospace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DejaVu Sans Mono&#39;</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">expnum</span><span class="p">]</span>
<span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Plot on a log scale, so set zero or negative values to a small number </span>
<span class="n">img</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Plot image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y-pixel&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2D NIRSpec Image of Exposure &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expnum</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Log$_</span><span class="si">{10}</span><span class="s1">$ Electron counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="extract-1d-spectra-from-2d-array-of-images">
<h1>Extract 1D spectra from 2D array of images<a class="headerlink" href="#extract-1d-spectra-from-2d-array-of-images" title="Permalink to this heading">#</a></h1>
<p>Ideally, extracting 1D spectra from the 2D images would use optimal aperture extraction along a fit
trace with routines equivalent to IRAF/apall. This functionality is not yet available in astro-py.</p>
<p>Several processing steps have already been applied.  The 2D spectra here have been flat field corrected, and 1/f noise has been removed from each pixel by subtracting the median count rate from the un-illuminated pixels along each column (see <strong><span class="xref myst">Giardino et al.</span></strong>
for more information about 1/f noise).  Each 2D image has also been aligned in the X and Y directions, such that each pixel corresponds to the same wavelength.  As the CV3 test had no requirements for flux stability, the ~1% flux variations from the LED have also been removed.</p>
<p>For spectral extraction, the example here simply uses a simple summed box.  The 8192 2D spectra have been
pre-loaded into a numpy array.  The spectra peaks at pixel Y=16. For each column, an aperature sum is taken over Y-axis pixels 11 to 18, which
contains most of the spectrum counts. Wider aperture would add more counts, but also introduces more noise.</p>
<p><strong>Further cleaning steps are not done here</strong></p>
<ol class="arabic simple">
<li><p>Ideally, the pixels flagged as bad for various reasons should be cleaned.</p></li>
<li><p>Cosmic rays should be identified and removed.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_spec</span><span class="o">.</span><span class="n">shape</span>
<span class="n">y_lower</span> <span class="o">=</span> <span class="mi">11</span>                                             <span class="c1"># Lower extraction aperture</span>
<span class="n">y_upper</span> <span class="o">=</span> <span class="mi">18</span>                                             <span class="c1"># Upper extraction aperture</span>
<span class="n">all_spec_1D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec</span><span class="p">[</span><span class="n">y_lower</span><span class="p">:</span><span class="n">y_upper</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Sum along Y-axis from pixels 11 to 18</span>
<span class="c1"># Plot </span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>                   <span class="c1"># Resolution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>                     <span class="c1"># Aspect ratio (the CCD is quite long!!!)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span>
<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;magma&#39;</span>                   <span class="c1"># Colormap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monospace&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.monospace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DejaVu Sans Mono&#39;</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">expnum</span><span class="p">]</span>
<span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Plot on a log scale, so set zero or negative values to a small number </span>
<span class="n">img</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Plot image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x-pixel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y-pixel&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_lower</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_upper</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2D NIRSpec Image of Exposure &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">expnum</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Log$_</span><span class="si">{10}</span><span class="s1">$ Electron counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="visualizing-the-1d-spectral-data">
<h1>Visualizing the 1D spectral data<a class="headerlink" href="#visualizing-the-1d-spectral-data" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (e-)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;CO$_2$&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The CV3 test observed a lamp with a similar PSF as JWST will have, and has significant counts from
about 1.5 to 4.5 <span class="math notranslate nohighlight">\(\mu\)</span>m.</p>
<p>The cryogenic test chamber had CO<span class="math notranslate nohighlight">\(_2\)</span> and H<span class="math notranslate nohighlight">\(_2\)</span>O ice buildup on the window, which can be seen as spectral absorption features in the 2D spectra.</p>
<section id="calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes">
<h2>Calculate Orbital Phase and a separate fine grid model used for plotting purposes<a class="headerlink" href="#calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate Orbital Phase</span>
<span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">bjd</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span>  <span class="c1"># phase in days relative to T0 ephemeris</span>
<span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">number_of_images</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Have current phase occur at value 0.0</span>

<span class="n">t_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bjd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bjd</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># times at which to calculate light curve</span>
<span class="n">phase_fine</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_fine</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">per</span><span class="p">)</span>  <span class="c1"># phase in days relative to T0 ephemeris</span>
<span class="n">phase_fine</span> <span class="o">=</span> <span class="n">phase_fine</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">number_of_images</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Have current phase occur at value 0.0</span>

<span class="n">b0</span> <span class="o">=</span> <span class="n">a_Rs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">rp</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># Select indicies between first and fourth contact</span>
<span class="n">outtransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">rp</span> <span class="o">&gt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span> <span class="c1"># Select indicies out of transit</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="dealing-with-systematic-drift-on-the-detector">
<h1>Dealing with Systematic Drift On the Detector<a class="headerlink" href="#dealing-with-systematic-drift-on-the-detector" title="Permalink to this heading">#</a></h1>
<p>The CV3 test assessed the stability of the instrument by introducing a large spatial jitter and drift. This resulted in a significant X,Y movement of the spectra on the 2D detector. While this bulk shift has been removed which aligns the spectra, intra- and inter- pixel sensitivities introduce flux variations which need to be removed. The jitter from the CV3 test was more than 30 mas, which is ~4X larger than the JWST stability requirement. Thus, in orbit these detector effects are expected to be significantly smaller, but they will still be present and will need to be modeled and removed from time series observations.</p>
<p>The detector X, Y positions here were measured from cross-correlation of the 2D images (collapsing the spectra along one dimension first), and are saved in arrays <span class="math notranslate nohighlight">\(shx\)</span> and <span class="math notranslate nohighlight">\(shy\)</span>. These detending vectors would ideally be measured using the trace position values from the spectral extraction of each integration, as that could also accurately measure integration-to-integration how the spectra spatially changed on the detector.</p>
<p>The detector shifts have original amplitudes near 0.2 pixels, though the vectors have had initial normalization. For detrending purposes, these arrays should have a mean of 0 and standard deviation of 1.0.</p>
<p>A residual color-dependent trend with the LED lamp can also been seen in the CV3 data, which can be partly removed by scaling original common-mode lamp trend, which was measured using the CV3 white light curve.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shx_tmp</span> <span class="o">=</span> <span class="n">shx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shx</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>       <span class="c1"># Set Mean around 0.0</span>
<span class="n">shx_detrend</span> <span class="o">=</span> <span class="n">shx_tmp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shx_tmp</span><span class="p">)</span>  <span class="c1"># Set standard deviation to 1.0</span>
<span class="n">shy_tmp</span> <span class="o">=</span> <span class="n">shy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shy</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>       <span class="c1"># Set Mean around 0.0</span>
<span class="n">shy_detrend</span> <span class="o">=</span> <span class="n">shy_tmp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shy_tmp</span><span class="p">)</span>  <span class="c1"># Set standard deviation to 1.0</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">common_mode</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">common_mode</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>
<span class="n">cm_detrend</span> <span class="o">=</span> <span class="n">cm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shx_detrend</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X-possition&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shy_detrend</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y-possition&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Image Sequence Number&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Detector Possition&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time-series Detrending Vectors&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="create-arrays-of-the-vectors-used-for-detrending">
<h2>Create arrays of the vectors used for detrending.<a class="headerlink" href="#create-arrays-of-the-vectors-used-for-detrending" title="Permalink to this heading">#</a></h2>
<p>From Sing et al. 2019:  Systematic errors are often removed by a parameterized deterministic model, where the non-transit photometric trends are found to correlate with a number <span class="math notranslate nohighlight">\(n\)</span> of external parameters (or optical state vectors, <span class="math notranslate nohighlight">\(X\)</span>). These parameters describe changes in the instrument or other external factors as a function of time during the observations, and are fit with a coefficient for each optical state parameter, <span class="math notranslate nohighlight">\(p_n\)</span>, to model and remove (or detrend) the photometric light curves.</p>
<p>When including systematic trends, the total parameterized model of the flux measurements over time, <span class="math notranslate nohighlight">\(f(t)\)</span>, can be modeled as a combination of the theoretical transit model, <span class="math notranslate nohighlight">\(T(t,\theta)\)</span> (which depends upon the transit parameters <span class="math notranslate nohighlight">\(\theta\)</span>), the total baseline flux detected from the star, <span class="math notranslate nohighlight">\(F_0\)</span>, and the systematics error model <span class="math notranslate nohighlight">\(S(x)\)</span> giving,</p>
<p><span class="math notranslate nohighlight">\(f(t) = T(t,\theta)\times F_0 \times S(x)\)</span>.</p>
<p>We will use a linear model for the instrument systematic effects.</p>
<p><span class="math notranslate nohighlight">\(S(x)= p_1 x + p_2 y + p_3 x^2 + p_4 y^2 + p_5 x y + p_6 cm + p_7 \phi \)</span></p>
<p><span class="math notranslate nohighlight">\(cm\)</span> is the common_mode trend, and <span class="math notranslate nohighlight">\(\phi\)</span> is a linear time trend which helps remove changing H<span class="math notranslate nohighlight">\(_2\)</span>O ice within the H<span class="math notranslate nohighlight">\(_2\)</span>O spectral feature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shx</span> <span class="o">=</span> <span class="n">shx_detrend</span>
<span class="n">shy</span> <span class="o">=</span> <span class="n">shy_detrend</span>
<span class="n">common_mode</span> <span class="o">=</span> <span class="n">cm_detrend</span>

<span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shx</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shx</span><span class="o">*</span><span class="n">shy</span><span class="p">,</span> <span class="n">common_mode</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)])</span>  <span class="c1"># Detrending array without linear time trend</span>
<span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
<span class="n">XXX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shx</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shx</span><span class="o">*</span><span class="n">shy</span><span class="p">,</span> <span class="n">common_mode</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)])</span>  <span class="c1"># Detrending array with with linear time trend</span>
<span class="n">XXX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">XXX</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Linear Regression</strong> can be used to quickly determine the parameters <span class="math notranslate nohighlight">\(p_n\)</span> using the out-of-transit data.</p>
<p>Here, we take a wavelength bin of the data (pixels 170 to 200) to make a time series.  The out-of-transit points are selected and a linear regression of <span class="math notranslate nohighlight">\(S(x)\)</span> is done to determine the optical state parameters <span class="math notranslate nohighlight">\(p_n\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pix1</span> <span class="o">=</span> <span class="mi">170</span>       <span class="c1"># wavelength bin lower range</span>
<span class="n">pix2</span> <span class="o">=</span> <span class="mi">200</span>       <span class="c1"># wavelength bin upper range</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec_1D</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># flux over a selected wavelength bin</span>

<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Plot Region of wavelength bin</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (e-)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;1D Extracted Spectrum&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;CO$_2$&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">regressor</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Linear Regression Coefficients:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The coefficients are on the order of ~10<span class="math notranslate nohighlight">\(^{-4}\)</span> so the trends have an amplitude on the order of 100’s of ppm.</p>
<p>Visualize the fit</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yfit</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>                         <span class="c1"># Project the fit over the whole time series</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S(x)$ Regression fit &#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="transit-and-limb-darkening-model-functions">
<h1>Transit and Limb-Darkening Model Functions<a class="headerlink" href="#transit-and-limb-darkening-model-functions" title="Permalink to this heading">#</a></h1>
<p>Define a functions used by the fitting routines.
These which will take the transit and systematic parameters and create our full transit light curve model</p>
<p><span class="math notranslate nohighlight">\(model = T(t,\theta)\times F_0 \times S(x)\)</span></p>
<p>compares it to the data</p>
<p><span class="math notranslate nohighlight">\(y = f(t)\)</span></p>
<p>by returning the residuals</p>
<p><span class="math notranslate nohighlight">\((y-model)/(\sigma_y)\)</span></p>
<p>To calculate the transit model, here we use  <strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2002ApJ...580L.171M/abstract">Mandel and Agol (2002)</a></strong> as coded in python by H. Wakeford (<strong><a class="reference external" href="https://github.com/hrwakeford/ExoTiC-ISM">ExoTiC-ISM</a></strong>).</p>
<p>To calculate the stellar limb-darkening, we use the procedure from Sing et al. (2010) which uses stellar models and fits for non-linear limb darkening coefficients, with a module as coded in python by H. Wakeford (<strong><a class="reference external" href="https://github.com/hrwakeford/ExoTiC-ISM">ExoTiC-ISM</a></strong>).</p>
<p>A new orbit is first calculated based on the system parameters of <span class="math notranslate nohighlight">\(a/R_{star}\)</span>, the cosine of the inclination <span class="math notranslate nohighlight">\(cos(i)\)</span>, and the orbital phase <span class="math notranslate nohighlight">\(\phi\)</span>.
The inputs are the orbit distance between the planet-star center <span class="math notranslate nohighlight">\(b\)</span> at each phase, limb-darkening parameters (<span class="math notranslate nohighlight">\(c_1,c_2,c_3,c_4\)</span>), and the planet-to-star radius ratio <span class="math notranslate nohighlight">\(R_p/R_{star}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_model</span>
<span class="k">def</span> <span class="nf">nonlinear_limb_darkening</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c3</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define non-linear limb darkening model with four parameters c0, c1, c2, c3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="nd">@custom_model</span>
<span class="k">def</span> <span class="nf">quadratic_limb_darkening</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">aLD</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">bLD</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define linear limb darkening model with parameters aLD and bLD.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">aLD</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">bLD</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">dirsen</span><span class="p">,</span> <span class="n">ld_model</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates stellar limb-darkening coefficients for a given wavelength bin.</span>

<span class="sd">    Currently supports:</span>
<span class="sd">    HST STIS G750L, G750M, G430L gratings</span>
<span class="sd">    HST WFC3 UVIS/G280, IR/G102, IR/G141 grisms</span>

<span class="sd">    What is used for 1D models - Kurucz (?)</span>
<span class="sd">    Procedure from Sing et al. (2010, A&amp;A, 510, A21).</span>
<span class="sd">    Uses 3D limb darkening from Magic et al. (2015, A&amp;A, 573, 90).</span>
<span class="sd">    Uses photon FLUX Sum over (lambda*dlamba).</span>
<span class="sd">    :param grating: string; grating to use (&#39;G430L&#39;,&#39;G750L&#39;,&#39;G750M&#39;, &#39;G280&#39;, &#39;G102&#39;, &#39;G141&#39;)</span>
<span class="sd">    :param wsdata: array; data wavelength solution</span>
<span class="sd">    :param M_H: float; stellar metallicity</span>
<span class="sd">    :param Teff: float; stellar effective temperature (K)</span>
<span class="sd">    :param logg: float; stellar gravity</span>
<span class="sd">    :param dirsen: string; path to main limb darkening directory</span>
<span class="sd">    :param ld_model: string; &#39;1D&#39; or &#39;3D&#39;, makes choice between limb darkening models; default is 1D</span>
<span class="sd">    :return: uLD: float; linear limb darkening coefficient</span>
<span class="sd">    aLD, bLD: float; quadratic limb darkening coefficients</span>
<span class="sd">    cp1, cp2, cp3, cp4: float; three-parameter limb darkening coefficients</span>
<span class="sd">    c1, c2, c3, c4: float; non-linear limb-darkening coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You are using the&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ld_model</span><span class="p">),</span> <span class="s1">&#39;limb darkening models.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>

        <span class="n">direc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;Kurucz&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current Directories Entered:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">dirsen</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">direc</span><span class="p">)</span>

        <span class="c1"># Select metallicity</span>
        <span class="n">M_H_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">M_H_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">])</span>
        <span class="n">optM</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">M_H</span> <span class="o">-</span> <span class="n">M_H_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">MH_ind</span> <span class="o">=</span> <span class="n">M_H_Grid_load</span><span class="p">[</span><span class="n">optM</span><span class="p">]</span>

        <span class="c1"># Determine which model is to be used, by using the input metallicity M_H to figure out the file name we need</span>
        <span class="n">direc</span> <span class="o">=</span> <span class="s1">&#39;Kurucz&#39;</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="s1">&#39;kuruczlist.sav&#39;</span>
        <span class="n">sav1</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">file_list</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sav1</span><span class="p">[</span><span class="s1">&#39;li&#39;</span><span class="p">][</span><span class="n">MH_ind</span><span class="p">])</span>  <span class="c1"># Convert object of type &quot;byte&quot; to &quot;string&quot;</span>

        <span class="c1"># Select Teff and subsequently logg</span>
        <span class="n">Teff_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3500</span><span class="p">,</span> <span class="mi">3750</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">4250</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">4750</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5250</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5750</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6250</span><span class="p">,</span> <span class="mi">6500</span><span class="p">])</span>
        <span class="n">optT</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Teff</span> <span class="o">-</span> <span class="n">Teff_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
        <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">4.0</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">138</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">4.5</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">9</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">139</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">140</span><span class="p">])</span>

        <span class="c1"># Where in the model file is the section for the Teff we want? Index T_ind tells us that.</span>
        <span class="n">T_ind</span> <span class="o">=</span> <span class="n">Teff_Grid_load</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span>
        <span class="n">header_rows</span> <span class="o">=</span> <span class="mi">3</span>    <span class="c1"># How many rows in each section we ignore for the data reading</span>
        <span class="n">data_rows</span> <span class="o">=</span> <span class="mi">1221</span>   <span class="c1"># How  many rows of data we read</span>
        <span class="n">line_skip_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">header_rows</span> <span class="o">+</span> <span class="n">T_ind</span> <span class="o">*</span> <span class="n">data_rows</span>   <span class="c1"># Calculate how many lines in the model file we need to skip in order to get to the part we need (for the Teff we want).</span>
        <span class="n">line_skip_header</span> <span class="o">=</span> <span class="n">T_ind</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_rows</span> <span class="o">+</span> <span class="n">header_rows</span><span class="p">)</span>

        <span class="c1"># Read the header, in case we want to have the actual Teff, logg and M_H info.</span>
        <span class="c1"># headerinfo is a pandas object.</span>
        <span class="n">headerinfo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">skiprows</span><span class="o">=</span><span class="n">line_skip_header</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Teff_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logg_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MH_model</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Closest values to your inputs:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Teff: &#39;</span><span class="p">,</span> <span class="n">Teff_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M_H: &#39;</span><span class="p">,</span> <span class="n">MH_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;log(g): &#39;</span><span class="p">,</span> <span class="n">logg_model</span><span class="p">)</span>

        <span class="c1"># Read the data; data is a pandas object.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">skiprows</span><span class="o">=</span><span class="n">line_skip_data</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">data_rows</span><span class="p">)</span>

        <span class="c1"># Unpack the data</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">10</span>   <span class="c1"># Import wavelength data</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="p">(</span><span class="n">ws</span> <span class="o">*</span> <span class="n">ws</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f6</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f7</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f8</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f9</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f10</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f11</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f14</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f15</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>
        <span class="n">f16</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>

        <span class="c1"># Make single big array of them</span>
        <span class="n">fcalc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">f6</span><span class="p">,</span> <span class="n">f7</span><span class="p">,</span> <span class="n">f8</span><span class="p">,</span> <span class="n">f9</span><span class="p">,</span> <span class="n">f10</span><span class="p">,</span> <span class="n">f11</span><span class="p">,</span> <span class="n">f12</span><span class="p">,</span> <span class="n">f13</span><span class="p">,</span> <span class="n">f14</span><span class="p">,</span> <span class="n">f15</span><span class="p">,</span> <span class="n">f16</span><span class="p">])</span>
        <span class="n">phot1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Define mu</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.000</span><span class="p">,</span> <span class="mf">.900</span><span class="p">,</span> <span class="mf">.800</span><span class="p">,</span> <span class="mf">.700</span><span class="p">,</span> <span class="mf">.600</span><span class="p">,</span> <span class="mf">.500</span><span class="p">,</span> <span class="mf">.400</span><span class="p">,</span> <span class="mf">.300</span><span class="p">,</span> <span class="mf">.250</span><span class="p">,</span> <span class="mf">.200</span><span class="p">,</span> <span class="mf">.150</span><span class="p">,</span> <span class="mf">.125</span><span class="p">,</span> <span class="mf">.100</span><span class="p">,</span> <span class="mf">.075</span><span class="p">,</span> <span class="mf">.050</span><span class="p">,</span> <span class="mf">.025</span><span class="p">,</span> <span class="mf">.010</span><span class="p">])</span>

        <span class="c1"># Passed on to main body of function are: ws, fcalc, phot1, mu</span>

    <span class="k">elif</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>

        <span class="n">direc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;3DGrid&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current Directories Entered:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">dirsen</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">direc</span><span class="p">)</span>

        <span class="c1"># Select metallicity</span>
        <span class="n">M_H_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>  <span class="c1"># Available metallicity values in 3D models</span>
        <span class="n">M_H_Grid_load</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;30&#39;</span><span class="p">,</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;00&#39;</span><span class="p">]</span>  <span class="c1"># The according identifiers to individual available M_H values</span>
        <span class="n">optM</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">M_H</span> <span class="o">-</span> <span class="n">M_H_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># Find index at which the closes M_H values from available values is to the input M_H.</span>

        <span class="c1"># Select Teff</span>
        <span class="n">Teff_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5777</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span> <span class="mi">7000</span><span class="p">])</span>  <span class="c1"># Available Teff values in 3D models</span>
        <span class="n">optT</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Teff</span> <span class="o">-</span> <span class="n">Teff_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># Find index at which the Teff values is, that is closest to input Teff.</span>

        <span class="c1"># Select logg, depending on Teff. If several logg possibilities are given for one Teff, pick the one that is</span>
        <span class="c1"># closest to user input (logg).</span>

        <span class="k">if</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5777</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.4</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Select Teff and Log g. Mtxt, Ttxt and Gtxt are then put together as string to load correct files.</span>
        <span class="n">Mtxt</span> <span class="o">=</span> <span class="n">M_H_Grid_load</span><span class="p">[</span><span class="n">optM</span><span class="p">]</span>
        <span class="n">Ttxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:2.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5777</span><span class="p">:</span>
            <span class="n">Ttxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:4.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">])</span>
        <span class="n">Gtxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:2.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;mmu_t&#39;</span> <span class="o">+</span> <span class="n">Ttxt</span> <span class="o">+</span> <span class="s1">&#39;g&#39;</span> <span class="o">+</span> <span class="n">Gtxt</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">Mtxt</span> <span class="o">+</span> <span class="s1">&#39;v05.flx&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Filename:&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

        <span class="c1"># Read data from IDL .sav file</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>  <span class="c1"># readsav reads an IDL .sav file</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># read in wavelength</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flx</span>  <span class="c1"># read in flux</span>
        <span class="n">Teff_model</span> <span class="o">=</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span>
        <span class="n">logg_model</span> <span class="o">=</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">M_H_Grid</span><span class="p">[</span><span class="n">optM</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Closest values to your inputs:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Teff  : &#39;</span><span class="p">,</span> <span class="n">Teff_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M_H   : &#39;</span><span class="p">,</span> <span class="n">MH_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;log(g): &#39;</span><span class="p">,</span> <span class="n">logg_model</span><span class="p">)</span>

        <span class="n">f0</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">f6</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">f7</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">f8</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">f9</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">f10</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

        <span class="c1"># Make single big array of them</span>
        <span class="n">fcalc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">f6</span><span class="p">,</span> <span class="n">f7</span><span class="p">,</span> <span class="n">f8</span><span class="p">,</span> <span class="n">f9</span><span class="p">,</span> <span class="n">f10</span><span class="p">])</span>
        <span class="n">phot1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Mu from grid</span>
        <span class="c1"># 0.00000    0.0100000    0.0500000     0.100000     0.200000     0.300000   0.500000     0.700000     0.800000     0.900000      1.00000</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mu</span>

        <span class="c1"># Passed on to main body of function are: ws, fcalc, phot1, mu</span>

    <span class="c1"># Load response function and interpolate onto kurucz model grid</span>

    <span class="c1"># FOR STIS</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G430L&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G430L.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens,sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G750M&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G750M.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mf">0.554</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G750L&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G750L.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mf">4.882</span>

    <span class="c1"># FOR WFC3</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G141&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G141.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G102&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G141.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G280&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G280.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># FOR JWST</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;NIRSpecPrism&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># wssens, sensitivity</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">widek</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">))</span>
    <span class="n">wsHST</span> <span class="o">=</span> <span class="n">wssens</span>
    <span class="n">wsHST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsHST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsHST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">]),</span>
                            <span class="n">wsHST</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsHST</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsHST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">,</span>
                                      <span class="n">wsHST</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsHST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">])))</span>

    <span class="n">respoutHST</span> <span class="o">=</span> <span class="n">sensitivity</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">)</span>
    <span class="n">respoutHST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">respoutHST</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">inter_resp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wsHST</span><span class="p">,</span> <span class="n">respoutHST</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">respout</span> <span class="o">=</span> <span class="n">inter_resp</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>  <span class="c1"># interpolate sensitivity curve onto model wavelength grid</span>

    <span class="n">wsdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">]),</span> <span class="n">wsdata</span><span class="p">,</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsdata</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">])))</span>
    <span class="n">respwavebin</span> <span class="o">=</span> <span class="n">wsdata</span> <span class="o">/</span> <span class="n">wsdata</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="n">widek</span> <span class="o">=</span> <span class="n">widek</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># need to add two indicies to compensate for padding with 2 zeros</span>
    <span class="n">respwavebin</span><span class="p">[</span><span class="n">widek</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">data_resp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wsdata</span><span class="p">,</span> <span class="n">respwavebin</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">reswavebinout</span> <span class="o">=</span> <span class="n">data_resp</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>  <span class="c1"># interpolate data onto model wavelength grid</span>

    <span class="c1"># Integrate over the spectra to make synthetic photometric points.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># Loop over spectra at diff angles</span>
        <span class="n">fcal</span> <span class="o">=</span> <span class="n">fcalc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">Tot</span> <span class="o">=</span> <span class="n">int_tabulated</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">ws</span> <span class="o">*</span> <span class="n">respout</span> <span class="o">*</span> <span class="n">reswavebinout</span><span class="p">)</span>
        <span class="n">phot1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_tabulated</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">ws</span> <span class="o">*</span> <span class="n">respout</span> <span class="o">*</span> <span class="n">reswavebinout</span> <span class="o">*</span> <span class="n">fcal</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">/</span> <span class="n">Tot</span>

    <span class="k">if</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
        <span class="n">yall</span> <span class="o">=</span> <span class="n">phot1</span> <span class="o">/</span> <span class="n">phot1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
        <span class="n">yall</span> <span class="o">=</span> <span class="n">phot1</span> <span class="o">/</span> <span class="n">phot1</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

    <span class="c1"># Co = np.zeros((6, 4))   # NOT-REUSED</span>

    <span class="c1"># A = [0.0, 0.0, 0.0, 0.0]  # c1, c2, c3, c4      # NOT-REUSED</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>     <span class="c1"># wavelength</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">yall</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>   <span class="c1"># flux</span>
    <span class="c1"># weights = x / x   # NOT-REUSED</span>

    <span class="c1"># Start fitting the different models</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="c1"># Fit a four parameter non-linear limb darkening model and get fitted variables, c1, c2, c3, c4.</span>
    <span class="n">corot_4_param</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>
    <span class="n">corot_4_param</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">corot_4_param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="n">corot_4_param</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Fit a three parameter non-linear limb darkening model and get fitted variables, cp2, cp3, cp4 (cp1 = 0).</span>
    <span class="n">corot_3_param</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>
    <span class="n">corot_3_param</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 3 param is just 4 param with c0 = 0.0</span>
    <span class="n">corot_3_param</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">corot_3_param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span> <span class="o">=</span> <span class="n">corot_3_param</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Fit a quadratic limb darkening model and get fitted parameters aLD and bLD.</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">quadratic_limb_darkening</span><span class="p">()</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">quadratic</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">quadratic</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Fit a linear limb darkening model and get fitted variable uLD.</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c2</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c3</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">uLD</span> <span class="o">=</span> <span class="n">linear</span><span class="o">.</span><span class="n">c1</span><span class="o">.</span><span class="n">value</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Limb darkening parameters:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4param </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3param </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quad </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uLD</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span>


<span class="k">def</span> <span class="nf">int_tabulated</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">Xsegments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Sort vectors into ascending order.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">Xsegments</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Xsegments</span> <span class="o">=</span> <span class="n">Xsegments</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">Xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">Xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># Uniform step size.</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xmax</span> <span class="o">+</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">Xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">Xsegments</span>
    <span class="c1"># Compute the interpolates at Xgrid.</span>
    <span class="c1"># x values of interpolates &gt;&gt; Xgrid = h * FINDGEN(Xsegments + 1L) + Xmin</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xsegments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xmin</span><span class="p">,</span> <span class="n">splrep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>

    <span class="c1"># Compute the integral using the 5-point Newton-Cotes formula.</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="mf">7.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">+</span> <span class="mf">32.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mf">12.0</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">45.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="now-define-the-transit-model-function">
<h2>Now define the transit model function<a class="headerlink" href="#now-define-the-transit-model-function" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">occultnl</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MANDEL &amp; AGOL (2002) transit model.</span>
<span class="sd">    :param rl: float, transit depth (Rp/R*)</span>
<span class="sd">    :param c1: float, limb darkening parameter 1</span>
<span class="sd">    :param c2: float, limb darkening parameter 2</span>
<span class="sd">    :param c3: float, limb darkening parameter 3</span>
<span class="sd">    :param c4: float, limb darkening parameter 4</span>
<span class="sd">    :param b0: impact parameter in stellar radii</span>
<span class="sd">    :return: mulimb0: limb-darkened transit model, mulimbf: lightcurves for each component that you put in the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mulimb0</span> <span class="o">=</span> <span class="n">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">rl</span><span class="p">)</span>
    <span class="n">bt0</span> <span class="o">=</span> <span class="n">b0</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mulimb0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># DKS edit</span>

    <span class="n">omega</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c3</span> <span class="o">-</span> <span class="n">c4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">/</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">c4</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mulimb0</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">mulimb</span> <span class="o">=</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
    <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">1.</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.8</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">7</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dmumax</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">dmumax</span> <span class="o">&gt;</span> <span class="n">fac</span> <span class="o">*</span> <span class="mf">1.e-3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">131072</span><span class="p">):</span>
        <span class="c1"># print(nr)</span>
        <span class="n">mulimbp</span> <span class="o">=</span> <span class="n">mulimb</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">nr</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">mulimbhalf</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb1</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb3half</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb2</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr</span><span class="p">):</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rl</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sig1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="n">sig2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimbhalf</span> <span class="o">=</span> <span class="n">mulimbhalf</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb1</span> <span class="o">=</span> <span class="n">mulimb1</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb3half</span> <span class="o">=</span> <span class="n">mulimb3half</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb2</span> <span class="o">=</span> <span class="n">mulimb2</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">mulimb</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c3</span> <span class="o">-</span> <span class="n">c4</span><span class="p">)</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span>
            <span class="n">indx</span><span class="p">]</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">mulimbhalf</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">mulimb1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span> <span class="n">mulimb3half</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">mulimb2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">omega</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mulimb</span> <span class="o">+</span> <span class="n">mulimbp</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ix1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ix1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># print(ix1)</span>
        <span class="c1"># python cannot index on single values so you need to use atlest_1d for the below to work when mulimb is a single value</span>
        <span class="n">dmumax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimbp</span><span class="p">)[</span><span class="n">ix1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimbp</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]))</span>

    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb0</span><span class="p">)[</span><span class="n">indx</span><span class="p">]</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimbhalf</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb1</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb3half</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb2</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb0</span><span class="p">)[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">bt0</span>

    <span class="k">return</span> <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span>


<span class="k">def</span> <span class="nf">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the lightcurve for occultation of a uniform source without microlensing (Mandel &amp; Agol 2002).</span>

<span class="sd">    :param b0: array; impact parameter in units of stellar radii</span>
<span class="sd">    :param w: array; occulting star size in units of stellar radius</span>
<span class="sd">    :return: muo1: float; fraction of flux at each b0 for a uniform source</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-3</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b0</span><span class="p">))</span>
    <span class="n">muo1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">):</span>
        <span class="c1"># substitute z=b0(i) to shorten expressions</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b0</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># z = z.value    # stripping it of astropy units</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">+</span><span class="n">w</span><span class="p">:</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">+</span><span class="n">w</span><span class="p">:</span>
            <span class="n">kap1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)))</span>
            <span class="n">kap0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">w</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)))</span>
            <span class="n">lambdae</span> <span class="o">=</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kap0</span> <span class="o">+</span> <span class="n">kap1</span>
            <span class="n">lambdae</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambdae</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lambdae</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">:</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">muo1</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data">
<h2>Now define the function to generate the transit light curve and compare it to the data<a class="headerlink" href="#now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Functions to call and calculate models</span>
<span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">):</span>
    <span class="c1"># calculate new orbit</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Select indicies between first and fourth contact</span>
    <span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
    <span class="c1"># Make light curve model, set all values initially to 1.0</span>
    <span class="n">light_curve</span> <span class="o">=</span> <span class="n">b0</span><span class="o">/</span><span class="n">b0</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">intransit</span><span class="p">])</span>  <span class="c1"># Madel and Agol</span>
    <span class="n">light_curve</span><span class="p">[</span><span class="n">intransit</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb0</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="n">light_curve</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">phase</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shx</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shx</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span> <span class="o">*</span> <span class="n">shx</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">common_mode</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># transit model is baseline flux X transit model X systematics model</span>
    <span class="n">chi2now</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rprs: &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;current chi^2=&quot;</span><span class="p">,</span> <span class="n">chi2now</span><span class="p">,</span> <span class="s1">&#39; scatter &#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">/</span><span class="n">err</span>
    <span class="c1"># return np.sum((y-model)**2/err**2)</span>
</pre></div>
</div>
</div>
</div>
<p>A function is also defined to return just the transit model <span class="math notranslate nohighlight">\(T(t,\theta)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_fine</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>  <span class="c1"># Make Transit model with a fine grid for plotting purposes</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase_fine</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase_fine</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>  <span class="c1"># Madel and Agol</span>
    <span class="n">model_fine</span> <span class="o">=</span> <span class="n">mulimb0</span>
    <span class="k">return</span> <span class="n">model_fine</span>
</pre></div>
</div>
</div>
</div>
<p>Now add a transit model to the Example Light curve.  Here, we’ve compute the limb darkening coefficients, then use them in the transit light curve.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wave1</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">]</span>
<span class="n">wave2</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">]</span>
<span class="n">bin_wave_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">wsdata_all</span> <span class="o">&gt;</span> <span class="n">wave1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wsdata_all</span> <span class="o">&lt;=</span> <span class="n">wave2</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
<span class="n">wsdata</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">bin_wave_index</span><span class="p">]</span><span class="o">*</span><span class="mf">1E4</span> <span class="c1"># Select wavelength bin values (um=&gt; angstroms)</span>

<span class="n">_uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">_cp1</span><span class="p">,</span> <span class="n">_cp2</span><span class="p">,</span> <span class="n">_cp3</span><span class="p">,</span> <span class="n">_cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">limb_dark_directory</span><span class="p">,</span> <span class="n">ld_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now run the transit model.</p>
<p>The transit parameters such as inclination and <span class="math notranslate nohighlight">\(a/R_{star}\)</span> have been setup at the beginning of the notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the Transit Model</span>
<span class="n">rl</span> <span class="o">=</span> <span class="mf">0.0825</span>     <span class="c1"># Planet-to-star Radius Ratio</span>

<span class="n">b0</span> <span class="o">=</span> <span class="n">a_Rs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">rl</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># Select indicies between first and fourth contact</span>

<span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>  <span class="c1"># Mandel &amp; Agol non-linear limb darkened transit model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">mulimb0</span><span class="o">*</span><span class="n">yfit</span> 

<span class="c1"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S(x)$ Regression fit &#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
<span class="c1"># Residual</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wsb_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">wsb</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (ppm)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># print chi^2 value</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chi^2 = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Residual Standard Deviation : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; ppm&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;256 Bin Standard Deviation  :&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wsb</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; ppm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the model transit depth is a little too deep compared to the data. The planet radius needs to be smaller, and the parameter <span class="math notranslate nohighlight">\(rl\)</span> is closer to 0.08.  As an exercise you can re-run the above cell changing the planet radius to <span class="math notranslate nohighlight">\(rl\)</span>=0.0805 and compare the <span class="math notranslate nohighlight">\(\chi^2\)</span> value to the previous default value (<span class="math notranslate nohighlight">\(\chi^2\)</span>=9265.4 at <span class="math notranslate nohighlight">\(rl\)</span> = 0.0825).</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="fit-transit-light-curves">
<h1>FIT Transit Light Curves<a class="headerlink" href="#fit-transit-light-curves" title="Permalink to this heading">#</a></h1>
<p>Now we can fit each light curve, optimizing the fit parameters with a least-squares fit. Here a Levenberg-Marquart fit is used to find a <span class="math notranslate nohighlight">\(\chi^2\)</span> minimum and estimate uncertainties using the lmfit package (https://lmfit.github.io/lmfit-py/fitting.html).</p>
<p>In practice, first we would fit the white light curve, which consists of summing over all of the wavelengths in the entire 1D spectra.  This can then be used to fit for the system parameters such as inclination and transit time, and then the spectroscopic channels are then fixed to these values as they are wavelength-independent.  However, the CV3 data required the overall variations of the lamp to be removed, which prevents our use of using this data for a white light curve analysis.  Here, we proceed to fitting for the spectroscopic light curve bins.</p>
<p>The steps are as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1) Wavelength Bin is selected

2) Limb-darkening coefficients are calculated from a stellar model for each bin. 

3) An initial linear regression is performed on the out-of-transit data to start the 
systematic fit parameters, this greatly speeds up the fit as those parameters start 
near their global minimum.

4) The fit is started, and some statistics are output during the minimization

5) Once the best-fit is found, a number of statistics are displayed 

6) Finally, several plots are generated which are stored as PDFs and the next bin is started.
</pre></div>
</div>
<p>These steps are performed for each spectral bin.</p>
<p>In this example, the planet radius is set to vary in the fit along with the baseline flux and instrument systematic parameters.</p>
<section id="setup-wavelengths-to-fit-over">
<h2>Setup Wavelengths to fit over<a class="headerlink" href="#setup-wavelengths-to-fit-over" title="Permalink to this heading">#</a></h2>
<p>The spectra must be binned in wavelength to get sufficient counts to reach ~100 ppm levels needed.
The spectra has significant counts from about pixel 100 to 400, we start at pixel <span class="math notranslate nohighlight">\(k0\)</span> and bin the spectra by <span class="math notranslate nohighlight">\(wk\)</span> pixels.</p>
<p>Several arrays are also defined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k0</span> <span class="o">=</span> <span class="mi">113</span> <span class="c1"># 98   #100</span>
<span class="n">kend</span> <span class="o">=</span> <span class="mi">392</span> <span class="c1"># 422</span>
<span class="n">wk</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">number_of_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">kend</span><span class="o">-</span><span class="n">k0</span><span class="p">)</span><span class="o">/</span><span class="n">wk</span><span class="p">)</span>
<span class="n">wsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">werr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">rprs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">rerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">sig_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">sig_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
<span class="n">depth_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loop-over-wavelength-bins-fitting-each-lightcurve">
<h2>Loop Over Wavelength Bins Fitting Each Lightcurve<a class="headerlink" href="#loop-over-wavelength-bins-fitting-each-lightcurve" title="Permalink to this heading">#</a></h2>
<section id="note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin">
<h3>Note this step takes considerable time to complete (~20 min, few minutes/bin)<a class="headerlink" href="#note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin" title="Permalink to this heading">#</a></h3>
<p>Each wavelength bin is fit for the transit+systematics model. Various outputs including plots are saved.
Can skip to the next cells to load pre-computed results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">k0</span>   <span class="c1"># wavelength to start</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Loop over wavelength bins and fit for each one</span>
<span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_bins</span><span class="p">):</span>
    
    <span class="c1"># Select wavelength bin</span>
    <span class="n">wave1</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">wave2</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">wk</span><span class="p">]</span>

    <span class="c1"># Indicies to select for wavelgth bin</span>
    <span class="n">bin_wave_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">wsdata_all</span> <span class="o">&gt;</span> <span class="n">wave1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wsdata_all</span> <span class="o">&lt;=</span> <span class="n">wave2</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>

    <span class="c1"># make light curve bin</span>
    <span class="n">wave_bin_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec_1D</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">wk</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Sum Wavelength pixels</span>
    <span class="n">wave_bin_counts_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wave_bin_counts</span><span class="p">)</span>            <span class="c1"># adopt photon noise for errors</span>

    <span class="c1"># Calculate Limb Darkening</span>

    <span class="n">wsdata</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">bin_wave_index</span><span class="p">]</span><span class="o">*</span><span class="mf">1E4</span> <span class="c1"># Select wavelength bin values (um=&gt; angstroms)</span>
    <span class="n">_uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">_cp1</span><span class="p">,</span> <span class="n">_cp2</span><span class="p">,</span> <span class="n">_cp3</span><span class="p">,</span> <span class="n">_cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">limb_dark_directory</span><span class="p">,</span> <span class="n">ld_model</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">c1 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c2 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c3 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c3</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c4 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># u   = [c1,c2,c3,c4]      # limb darkening coefficients</span>
    <span class="c1"># u = [aLD, bLD]</span>

    <span class="c1"># Make initial model</span>
    
    <span class="c1"># Setup LMFIT</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bjd</span>                    <span class="c1"># X data</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">wave_bin_counts</span>        <span class="c1"># Y data</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">wave_bin_counts_err</span>  <span class="c1"># Y Error</span>

    <span class="c1"># Perform Quick Linear regression on out-of-transit data to obtain accurate starting Detector fit values</span>
    <span class="k">if</span> <span class="n">wave1</span> <span class="o">&gt;</span> <span class="mf">2.7</span> <span class="ow">and</span> <span class="n">wave1</span> <span class="o">&lt;</span> <span class="mf">3.45</span><span class="p">:</span>
        <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XXX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>

    <span class="c1"># create a set of Parameters for LMFIT https://lmfit.github.io/lmfit-py/parameters.html</span>
    <span class="c1"># class Parameter(name, value=None, vary=True, min=- inf, max=inf, expr=None, brute_step=None, user_data=None)¶</span>
    <span class="c1"># Set vary=0 to fix</span>
    <span class="c1"># Set vary=1 to fit</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>  <span class="c1"># object to store L-M fit Parameters           # Parameter Name</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;cosinc&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">),</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># inclination, vary cos(inclin)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;rho_star&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">rho_star</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># stellar density</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">a_Rs</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># a/Rstar</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;rprs&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">rp</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># planet-to-star radius ratio</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># Transit T0</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;f0&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>         <span class="c1"># Baseline Flux</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ecc&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ecc</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># eccentricity</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># arguments of periatron</span>
    <span class="c1"># Turn on a linear slope in water feature to account for presumably changing H2O ice builtup on widow during cryogenic test</span>
    <span class="k">if</span> <span class="n">wave1</span> <span class="o">&gt;</span> <span class="mf">2.7</span> <span class="ow">and</span> <span class="n">wave1</span> <span class="o">&lt;</span> <span class="mf">3.45</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Fslope&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Orbital phase</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Fslope&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                          <span class="c1"># Orbital phase</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;xsh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                 <span class="c1"># Detector X-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ysh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                 <span class="c1"># Detector X-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x2sh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Detector X^2-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;y2sh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Detector Y^2-shift detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;xysh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Detector X*Y detrending</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;comm&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Common-Mode detrending</span>
    
    <span class="c1"># Perform Minimization https://lmfit.github.io/lmfit-py/fitting.html</span>
    <span class="c1"># create Minimizer</span>
    <span class="c1"># mini = lmfit.Minimizer(residual, p, nan_policy=&#39;omit&#39;,fcn_args=(phase,x,y,err)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting Bin&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="s1">&#39; Wavelength =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span><span class="o">/</span><span class="mf">1E4</span><span class="p">,</span> <span class="s1">&#39;  Range= [&#39;</span><span class="p">,</span> <span class="n">wave1</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">wave2</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>

    <span class="c1">#  solve with Levenberg-Marquardt using the</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">))</span>
    <span class="c1"># result = mini.minimize(method=&#39;emcee&#39;)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Re-Fitting Bin&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="s1">&#39; Wavelength =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span><span class="o">/</span><span class="mf">1E4</span><span class="p">,</span> <span class="s1">&#39;  Range= [&#39;</span><span class="p">,</span> <span class="n">wave1</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">wave2</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="c1"># --------------------------------------------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;redchi&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">redchi</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chi2&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">chisqr</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nfree&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">nfree</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bic&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">bic</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aic&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">aic</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L-M FIT Variable&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_statistics.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">redchi &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">redchi</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">chi2   &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">chisqr</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">nfree  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">nfree</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">bic    &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">bic</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">aic    &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">aic</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="c1"># file-output.py</span>

    <span class="c1"># Update with best-fit parameters</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rho_star&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rho_star&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="c1"># Update Fit Spectra arrays</span>
    <span class="n">wsd</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span><span class="o">/</span><span class="mf">1E4</span>
    <span class="n">werr</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wsdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wsdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mf">2E4</span>
    <span class="n">rprs</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">rerr</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>

    <span class="c1"># Calculate Bestfit Model</span>
    <span class="n">final_model</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">result</span><span class="o">.</span><span class="n">residual</span><span class="o">*</span><span class="n">err</span>
    <span class="n">final_model_fine</span> <span class="o">=</span> <span class="n">model_fine</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># More Stats</span>
    <span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">residppm</span> <span class="o">=</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">residerr</span> <span class="o">=</span> <span class="n">err</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="mf">1E6</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Residual standard deviation  (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Photon noise                 (ppm) : &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Photon noise performance       (%) : &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Residual standard deviation  (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">final_model</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Photon noise                 (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Photon noise performance       (%) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">*</span><span class="mf">1E6</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
 
    <span class="c1"># Measure Rednoise with Binning Technique</span>
    <span class="n">sig0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">number_of_images</span> <span class="o">/</span> <span class="n">binmeasure</span>
    <span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">sig_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wsb</span><span class="p">)</span>
    <span class="n">sigrednoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig_binned</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">binmeasure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigrednoise</span><span class="p">):</span>
        <span class="n">sigrednoise</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># if no rednoise detected, set to zero</span>
    <span class="n">sigwhite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">sigrednoise</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigrednoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig_binned</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">sigwhite</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">binmeasure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigrednoise</span><span class="p">):</span> 
        <span class="n">sigrednoise</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># if no rednoise detected, set to zero</span>
    <span class="n">beta</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">binmeasure</span><span class="o">*</span><span class="n">sigrednoise</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">sig0</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;White noise                  (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">sigwhite</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Red noise                    (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">sigrednoise</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transit depth measured error (ppm) : &quot;</span><span class="p">,</span> <span class="mf">2E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">White noise                  (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">sigwhite</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Red noise                    (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">sigrednoise</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transit depth measured error (ppm) : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">2E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>
    <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">depth</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">depth_err</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2E6</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>

    <span class="n">sig_r</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigrednoise</span><span class="o">*</span><span class="mf">1E6</span>
    <span class="n">sig_w</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigwhite</span><span class="o">*</span><span class="mf">1E6</span>
    <span class="c1"># --------------------------------------------------------------------------</span>
    <span class="c1"># ---------------------------------------------------------</span>
    <span class="c1"># Write Fit Spectra to ascii file</span>
    <span class="n">ascii_data</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">wsd</span><span class="p">,</span> <span class="n">werr</span><span class="p">,</span> <span class="n">rprs</span><span class="p">,</span> <span class="n">rerr</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_err</span><span class="p">,</span> <span class="n">sig_w</span><span class="p">,</span> <span class="n">sig_r</span><span class="p">,</span> <span class="n">beta</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Wavelength Center (um)&#39;</span><span class="p">,</span> <span class="s1">&#39;Wavelength half-width (um)&#39;</span><span class="p">,</span> <span class="s1">&#39;Rp/Rs&#39;</span><span class="p">,</span> <span class="s1">&#39;Rp/Rs 1-sigma error&#39;</span><span class="p">,</span> <span class="s1">&#39;Transit Depth (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Transit Depth error&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma_white (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma_red (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta Rednoise Inflation factor&#39;</span><span class="p">])</span>
    <span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ascii_data</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_transmission_spectra.csv&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># ---------------------------------------------------------</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span> <span class="c1"># default marker size</span>
    <span class="c1"># Plot data models</span>
     
    <span class="c1"># plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># Figure dimensions</span>
    <span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># default marker size</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">final_model</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wave1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wave2</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>
    <span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>
    <span class="c1"># Residual</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">residppm</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
    <span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">residppm</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wsb_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">wsb</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (ppm)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="o">-</span><span class="n">sigma</span><span class="p">,</span> <span class="o">-</span><span class="n">sigma</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>
    <span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
    <span class="c1"># save</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_lightcurve.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>   
    
    <span class="c1"># plot systematic corrected light curve</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
    <span class="n">light_curve</span> <span class="o">=</span> <span class="n">b0</span><span class="o">/</span><span class="n">b0</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">intransit</span><span class="p">])</span>  <span class="c1"># Madel and Agol</span>
    <span class="n">light_curve</span><span class="p">[</span><span class="n">intransit</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb0</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">light_curve</span><span class="o">+</span><span class="n">resid</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;BJD&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">light_curve</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_corrected.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="c1"># close all figures</span>
    <span class="c1"># --------------------------------------------------------------------------</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">wk</span>  <span class="c1"># step wavelength index to next bin</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** Can Now View Output PDFs in &#39;</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="plot-measured-exoplanet-transmission-spectrum-vs-injected">
<h1>Plot Measured Exoplanet Transmission Spectrum vs Injected<a class="headerlink" href="#plot-measured-exoplanet-transmission-spectrum-vs-injected" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Load Injected Transmission spectra to compare with recovered value</span>

<span class="c1"># Download Injected Spectra</span>
<span class="n">fn_tm</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">)</span>
<span class="n">destld</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_tm</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">)</span>        

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;   &#39;</span><span class="p">)</span>
<span class="n">model_ws</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">model_spec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Read fit transit depths</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_transmission_spectra.csv&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>
<span class="n">wsd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Wavelength Center (um)&#39;</span><span class="p">]</span>
<span class="n">werr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Wavelength half-width (um)&#39;</span><span class="p">]</span>
<span class="n">rprs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Rp/Rs&#39;</span><span class="p">]</span>
<span class="n">rerr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Rp/Rs 1-sigma error&#39;</span><span class="p">]</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Beta Rednoise Inflation factor&#39;</span><span class="p">]</span>

<span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">model_spec</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Injected Spectra&#39;</span><span class="p">)</span>  <span class="c1"># overplot Transit model at data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wsd</span><span class="p">,</span> <span class="n">rprs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">werr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">rerr</span><span class="o">*</span><span class="n">rprs</span><span class="o">*</span><span class="mf">1E6</span><span class="o">*</span><span class="n">beta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Recovered Spectra with $\sigma_r$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wsd</span><span class="p">,</span> <span class="n">rprs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">werr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">rerr</span><span class="o">*</span><span class="n">rprs</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recovered Spectra&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Transit Depth ($R_p/R_s$)$^2$ (ppm)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">3.3</span><span class="p">,</span> <span class="mi">6850</span><span class="p">,</span> <span class="s1">&#39;CH$_4$&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">4.25</span><span class="p">,</span> <span class="mi">6700</span><span class="p">,</span> <span class="s1">&#39;CO&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.3</span><span class="p">,</span> <span class="mi">6750</span><span class="p">,</span> <span class="s1">&#39;CH$_4$&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.75</span><span class="p">,</span> <span class="mi">6550</span><span class="p">,</span> <span class="s1">&#39;H$_2$O&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">5700</span><span class="p">,</span> <span class="mi">7000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>By and large, the injected transit depths are well recovered across the spectra, with features such as H<span class="math notranslate nohighlight">\(_2\)</span>O and CH<span class="math notranslate nohighlight">\(_4\)</span> easily detected. There is a bit of an offset in data-points long-ward of 3.5 <span class="math notranslate nohighlight">\(\mu\)</span>m that could perhaps be due to changes in CO<span class="math notranslate nohighlight">\(_2\)</span> or H<span class="math notranslate nohighlight">\(_2\)</span>O absorption features from ice built up on the cryogenic window during the CV3 test. These wavelengths show some increases in time correlated noise (<span class="math notranslate nohighlight">\(\sigma_r\)</span>), which has been measured here, and the errors in the plot also show the transit depths with this error included.</p>
<p>The precisions from the ground-based test are very encouraging, with the best measured bin (which occurs in a clean part of the spectrum with high count rates) achieving near-photon limited transit depths measured to about 30 ppm in only 2 hours of data, and with minimal time correlated noise (<span class="math notranslate nohighlight">\(\sigma_r\)</span>).</p>
<p>For more robust error estimates, in practice the least-squares minimization performed here would be replaced by an MCMC routine.  In addition, with actual transit data, the transit fit parameters (e.g. <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(a/R_{star}\)</span>, T<span class="math notranslate nohighlight">\(_0\)</span>) would also have to be first fit as well, as they can/will differ from literature estimates in high precision transit light curves as JWST will provide.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSpec/transit_spectroscopy_notebook"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../mos_spectroscopy_advanced/MOSspec_advanced.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">MOS Spectroscopy of Extragalactic Field</p>
      </div>
    </a>
    <a class="right-next"
       href="../galaxy_redshift/redshift_fitting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Redshift and Template Fitting</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">BOTS Time Series Observations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-packages">Load packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-parameters">Setup Parameters</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-and-load-nirspec-data">Download and Load NIRSpec data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-2d-spectral-data">Visualizing the 2D spectral data</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-1d-spectra-from-2d-array-of-images">Extract 1D spectra from 2D array of images</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-1d-spectral-data">Visualizing the 1D spectral data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-orbital-phase-and-a-separate-fine-grid-model-used-for-plotting-purposes">Calculate Orbital Phase and a separate fine grid model used for plotting purposes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-systematic-drift-on-the-detector">Dealing with Systematic Drift On the Detector</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-arrays-of-the-vectors-used-for-detrending">Create arrays of the vectors used for detrending.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transit-and-limb-darkening-model-functions">Transit and Limb-Darkening Model Functions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-transit-model-function">Now define the transit model function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-define-the-function-to-generate-the-transit-light-curve-and-compare-it-to-the-data">Now define the function to generate the transit light curve and compare it to the data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-transit-light-curves">FIT Transit Light Curves</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-wavelengths-to-fit-over">Setup Wavelengths to fit over</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-wavelength-bins-fitting-each-lightcurve">Loop Over Wavelength Bins Fitting Each Lightcurve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-this-step-takes-considerable-time-to-complete-20-min-few-minutes-bin">Note this step takes considerable time to complete (~20 min, few minutes/bin)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-measured-exoplanet-transmission-spectrum-vs-injected">Plot Measured Exoplanet Transmission Spectrum vs Injected</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>