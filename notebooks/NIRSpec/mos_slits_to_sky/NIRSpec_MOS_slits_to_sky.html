
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>NIRSpec MOS Slits to Sky &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSpec/mos_slits_to_sky/NIRSpec_MOS_slits_to_sky';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="BOTS Time Series Observations" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html" />
    <link rel="prev" title="NIRSpec MOS MSA Metafile" href="../msa_metafile/NIRSpec_MOS_MSA_metafile.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">JDAViz Demo Notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/Cubeviz.html">Cubeviz with NIRSpec data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/Imviz.html">Jdaviz Imviz Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/Specviz_Specviz2d.html">Specviz and Specviz2D Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/specreduce_extraction.html">Specreduce Demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/photometry_extragalactic/imviz.html">Photometry with JWST - Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/photometry_extragalactic/photutils_example.html">Photometry of a JWST/NIRCam extragalactic field with Photutils</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples.html">JWST PSFs Using Wavefronts Measured On Orbit</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_1028.html">MIRI PSF Photometry With Space_Phot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_1028_photutils.html">MIRI PSF Photometry with Photutils</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_photutils.html">MIRI PSF Photometry with Photutils</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_spacephot.html">MIRI PSF Photometry With Space_Phot</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_claw_detection/nircam_claw_detection.html">NIRCam Claw Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_WFSS_Box_extraction/BoxExtraction_using_Grismconf_CRDS.html">WFSS Box Extraction Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_WFSS_simulating_spectra/Simulating_WFSS_spectra_CRDS.html">WFSS Spectra Simulation for Contamination Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry_basics/psf_photometry_basics.html">PSF Photometry Basics with Photutils</a></li>









<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry_with_space_phot/nircam_spacephot.html">NIRCam PSF Photometry With Space_Phot</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/extra_niriss_individual_steps.html">Running Individual Pipline Steps</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../mos_master_background/Master_Background_MOS_Demo.html">Master Background Subtraction for Multi-Object Spectroscopy (MOS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../msa_metafile/NIRSpec_MOS_MSA_metafile.html">NIRSpec MOS MSA Metafile</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">NIRSpec MOS Slits to Sky</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRSpec/mos_slits_to_sky/NIRSpec_MOS_slits_to_sky.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSpec/mos_slits_to_sky/NIRSpec_MOS_slits_to_sky.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>NIRSpec MOS Slits to Sky</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">1. Introduction <a id="intro"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inputs">Inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outputs">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-library">2. Import Library <a id="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">3. Helper Functions <a id="funcs"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">4. Download the Data <a id="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-in-the-data">5. Load in the Data <a id="load"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nirspec-spectra">5.1 NIRSpec Spectra <a id="load_spectra"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-the-wavelength-grid">5.1.1 Extract the Wavelength Grid <a id="wave_grid"></a></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#msa-metafile">5.2 MSA Metafile <a id="load_msa"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nircam-images">5.3 NIRCam Images <a id="load_nircam"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-slit-sizes">6. Define the Slit Sizes <a id="slit_sizes"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-slits-to-the-sky">7. Mapping Slits to the Sky <a id="mapping"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-the-correction-that-enabled-this">Show the correction that enabled this</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-sky-back-to-slits">8. Mapping Sky back to Slits <a id="mapping_2"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#show-image-alongside-spectrum">9. Show Image Alongside Spectrum <a id="final"></a></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a id='top'></a>
<a class="reference internal" href="https://github.com/STScI-MIRI/MRS-ExampleNB/raw/main/assets/banner1.png"><img alt="stsci_logo" src="https://github.com/STScI-MIRI/MRS-ExampleNB/raw/main/assets/banner1.png" style="width: 1000px;" /></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="nirspec-mos-slits-to-sky">
<h1>NIRSpec MOS Slits to Sky<a class="headerlink" href="#nirspec-mos-slits-to-sky" title="Link to this heading">#</a></h1>
<p><strong>Authors</strong>: Dan Coe (dcoe&#64;stsci.edu) and Kayli Glidic (kglidic&#64;stsci.edu) with contributions from others on the STScI NIRSpec team. <br>
<strong>Created On</strong>: June, 2024 (<a class="reference external" href="https://www.stsci.edu/jwst/science-execution/jwebbinars.html#h3-dc1c3cd6-f1aa-45c4-b73f-e93cc96ff4a7:~:text=33%20%2D%20JWST%20NIRSpec%20MOS%20Data%20Reduction">JWebbinar 33</a>)<br>
<strong>Updated On</strong>: October, 2025. <br></p>
<p><strong>Purpose</strong>:<br> The primary goal of this notebook is to demonstrate how to map Near Infrared Spectrograph (NIRSpec) Multi-Object Spectroscopy (MOS) slits to the sky and back.</p>
<p><strong><a class="reference internal" href="#data"><span class="xref myst">Data</span></a></strong>:<br>
This notebook is set up to use the <a class="reference external" href="https://www.stsci.edu/cgi-bin/get-proposal-info?observatory=JWST&amp;amp;id=2736">ERO 2736</a> G395M observations of <a class="reference external" href="https://webbtelescope.org/contents/news-releases/2022/news-2022-035">SMACS0723</a>, source 6355 (z = 7.665), plus a few others.</p>
<hr class="docutils" />
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#intro"><span class="xref myst">1. Introduction</span></a></p></li>
<li><p><a class="reference internal" href="#imports"><span class="xref myst">2. Import Library</span></a></p></li>
<li><p><a class="reference internal" href="#funcs"><span class="xref myst">3. Helper Functions</span></a></p></li>
<li><p><a class="reference internal" href="#data"><span class="xref myst">4. Download the Data</span></a></p></li>
<li><p><a class="reference internal" href="#load"><span class="xref myst">5. Load in the Data</span></a></p>
<ul>
<li><p><a class="reference internal" href="#load_spectra"><span class="xref myst">5.1 NIRSpec Spectra</span></a></p>
<ul>
<li><p><a class="reference internal" href="#wave_grid"><span class="xref myst">5.1.1 Extract the Wavelength Grid</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#load_msa"><span class="xref myst">5.2 MSA Metafile</span></a></p></li>
<li><p><a class="reference internal" href="#load_nircam"><span class="xref myst">5.3 NIRCam Images</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#'slit_sizes"><span class="xref myst">6. Define the Slit Sizes</span></a></p></li>
<li><p><a class="reference internal" href="#mapping"><span class="xref myst">7. Mapping Slits to the Sky</span></a></p></li>
<li><p><a class="reference internal" href="#mapping_2"><span class="xref myst">8. Mapping Sky back to Slits</span></a></p></li>
<li><p><a class="reference internal" href="#final"><span class="xref myst">9. Show Image Alongside Spectrum</span></a></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="introduction">
<h2>1. Introduction <a id='intro'></a><a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This notebook demonstrates how to map NIRSpec MSA slits to the sky and back.</p>
<p>We also show how to extract the wavelength grid from either the S2D or X1D pipeline products.</p>
<p>Finally we show the 2D and 1D spectra alongside the color image with slits overlaid, rotated to the orientation of the 2D spectrum.</p>
<p>We use the ERO 2736 G395M observations of SMACS0723, source 6355 (z = 7.665).</p>
<section id="inputs">
<h3>Inputs<a class="headerlink" href="#inputs" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>NIRSpec <code class="docutils literal notranslate"><span class="pre">CAL</span></code>, <code class="docutils literal notranslate"><span class="pre">S2D</span></code>, and <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files for this object from <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></p></li>
<li><p>NIRSpec MSA metafile</p></li>
<li><p>NIRCam image from the <a class="reference external" href="https://dawn-cph.github.io/dja/index.html">DJA</a></p>
<ul>
<li><p>https://s3.amazonaws.com/grizli-v2/JwstMosaics/v7/smacs0723-grizli-v7.0-f200w-clear_drc_sci.fits.gz</p></li>
</ul>
</li>
<li><p>NIRCam color image produced using <a class="reference external" href="https://github.com/dancoe/trilogy">Trilogy</a> (optional)</p>
<ul>
<li><p>https://relics.stsci.edu/data/smacs0723-73/JWST/smacs0723_color_sw.png</p></li>
<li><p>alternatively, you could show a single filter image in grayscale</p></li>
</ul>
</li>
</ul>
</section>
<section id="outputs">
<h3>Outputs<a class="headerlink" href="#outputs" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Slits drawn on (color) image.</p></li>
<li><p>Image mapped back to slit frame.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="import-library">
<h2>2. Import Library <a id='imports'></a><a class="headerlink" href="#import-library" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># General imports.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>  <span class="c1"># Decompress .gz files.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>  <span class="c1"># Download large files.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>  <span class="c1"># Shows progress bar while downloading files.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import JWST datamodels.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst</span><span class="w"> </span><span class="kn">import</span> <span class="n">datamodels</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - WARNING -  CRDS_SERVER_URL does not start with https://  :: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Astropy imports.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">wcs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.utils.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">AstropyWarning</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;astropy&#39;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="c1"># Astroquery imports.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astroquery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>  <span class="c1"># MAST</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;astroquery version&#39;</span><span class="p">,</span> <span class="n">astroquery</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>astropy 7.2.0
astroquery version 0.4.11
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To plot and view results.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span> <span class="c1"># as mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>  <span class="c1"># 18</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clip</span>  <span class="c1"># , SigmaClip</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span><span class="p">,</span> <span class="n">LinearStretch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization.mpl_normalize</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageNormalize</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Color image.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">PIL</span>  <span class="c1"># Python Image Library.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="mi">933120000</span>  <span class="c1"># Allow it to load large image.</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="helper-functions">
<h2>3. Helper Functions <a id='funcs'></a><a class="headerlink" href="#helper-functions" title="Link to this heading">#</a></h2>
<p>These functions handle downloading and decompressing data files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">decompress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                    <span class="n">decompressed_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decompress the given file to a new file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the file to be decompressed.</span>
<span class="sd">    decompressed_file : str</span>
<span class="sd">        Name of the file in which to save the decompressed data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">decompressed_file</span> <span class="o">=</span> <span class="n">decompressed_file</span> <span class="ow">or</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Decompressing to:&#39;</span><span class="p">,</span> <span class="n">decompressed_file</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">decompressed_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>

    <span class="c1"># Clean up: remove compressed file, now that you&#39;ve decompressed it.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_large_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">decompress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a large file from a given URL, and decompress.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL of the file to be downloaded.</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the file in which to save the downloaded data.</span>
<span class="sd">    decompress : bool</span>
<span class="sd">        Whether or not to attempt to decompress the file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the file containing the downloaded data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="c1"># else just use the filename as is</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># if left blank, just save the filename as in the URL</span>

    <span class="n">decompressed_file</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="n">decompress</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="n">decompressed_file</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.gz&#39;</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">decompressed_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">decompressed_file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">decompressed_file</span><span class="p">,</span> <span class="s1">&#39;EXISTS&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">decompressed_file</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;to:&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="c1">#print(&#39;(d)&#39;, decompressed_file)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="c1"># tqdm has many interesting parameters. Feel free to experiment!</span>
            <span class="n">tqdm_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1">#&#39;desc&#39;: url,</span>
                <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
                <span class="s1">&#39;miniters&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
                <span class="s1">&#39;unit_scale&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;unit_divisor&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="s1">&#39;bar_format&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{l_bar}{bar:20}{r_bar}{bar:-20b}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># progress bar length 20 pixels</span>
            <span class="p">}</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="o">**</span><span class="n">tqdm_params</span><span class="p">)</span> <span class="k">as</span> <span class="n">pb</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                      
    <span class="k">if</span> <span class="n">decompress</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="n">decompress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">decompressed_file</span><span class="p">)</span>        
            <span class="n">filename</span> <span class="o">=</span> <span class="n">decompressed_file</span>
            
    <span class="k">return</span> <span class="n">filename</span>


<span class="c1"># Helper function to download JWST files from MAST.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">download_jwst_files</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span>
                        <span class="n">download_dir</span><span class="p">,</span>
                        <span class="n">mast_dir</span><span class="o">=</span><span class="s1">&#39;mast:JWST/product&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to download JWST files from MAST.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    filenames: list of str</span>
<span class="sd">        List of filenames to download.</span>
<span class="sd">    download_dir: str</span>
<span class="sd">        Directory where the files will be downloaded.</span>
<span class="sd">    mast_dir: str</span>
<span class="sd">        MAST directory containing JWST products.</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    downloaded_files: list of str</span>
<span class="sd">        List of downloaded file paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Download data.</span>
    <span class="n">downloaded_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">mast_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mast_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;EXISTS&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Can let this command check if local file exists.</span>
            <span class="c1"># However, it will delete it if it&#39;s there</span>
            <span class="c1"># and the wrong size (e.g., reprocessed).</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;downloading...&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mast_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">mast_path</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">local_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">downloaded_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">downloaded_files</span>
</pre></div>
</div>
</div>
</div>
<p>Basic math and logic functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">between</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">hi</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if a given value is between a high and a low value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lo : float</span>
<span class="sd">        Lower boundary value.</span>
<span class="sd">    x : float</span>
<span class="sd">        Value to be checked.</span>
<span class="sd">    hi : float</span>
<span class="sd">        High boundary value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value : bool</span>
<span class="sd">        True if x is between lo and hi, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">roundint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Round the given number to the nearest integer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : float</span>
<span class="sd">        Value to be rounded.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value : int</span>
<span class="sd">        Rounded value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">single_value</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether the input is a single integer or float.</span>
<span class="sd">    True = one number; False = multiple numbers (list / tuple / array / set).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : int, float, list, tup, etc</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value : bool</span>
<span class="sd">        True if x is an integer or float. Otherwise false.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Functions for array slicing and table filtering.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">slices_extent</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate slice objects based on given x, y values and dx, dy lengths.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : int</span>
<span class="sd">        X value of the central coordinate.</span>
<span class="sd">    y : int</span>
<span class="sd">        Y value of the central coordinate.</span>
<span class="sd">    dx : int</span>
<span class="sd">        Half-width in the x direction.</span>
<span class="sd">    dy : int</span>
<span class="sd">        Half-width in the y direction.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slices : tup</span>
<span class="sd">        Tuple of y- and x-slice objects.</span>
<span class="sd">    extent : tup</span>
<span class="sd">        4-tuple of low and high coordinates for both x and y.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="ow">or</span> <span class="n">dx</span>
    <span class="n">xlo</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">xhi</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ylo</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span>
    <span class="n">yhi</span> <span class="o">=</span> <span class="n">roundint</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">xlo</span><span class="p">,</span> <span class="n">xhi</span><span class="p">)</span>
    <span class="n">yslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span><span class="p">)</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="n">yslice</span><span class="p">,</span> <span class="n">xslice</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="n">xlo</span><span class="p">,</span> <span class="n">xhi</span><span class="p">,</span> <span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span>
    <span class="k">return</span> <span class="n">slices</span><span class="p">,</span> <span class="n">extent</span>


<span class="k">def</span><span class="w"> </span><span class="nf">filter_table</span><span class="p">(</span><span class="n">full_table</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters an Astropy Table based an arbitrary number of input column-value pairs.</span>
<span class="sd">    Each value can be either a single value or a list (or tuple, array, or set).</span>
<span class="sd">    Example:</span>
<span class="sd">    select_shutter_table = filter_table(shutter_table, msa_metadata_id=1, dither_point_index=1, source_id=[6355,5144])</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_table : astropy.table.Table</span>
<span class="sd">        Table to be filtered.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filtered_table : astropy.table.Table</span>
<span class="sd">        Table containing only requested columns/values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filtered_table</span> <span class="o">=</span> <span class="n">full_table</span>
    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">single_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">filtered_table</span> <span class="o">=</span> <span class="n">filtered_table</span><span class="p">[</span><span class="n">filtered_table</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># list</span>
            <span class="n">filtered_table</span> <span class="o">=</span> <span class="n">filtered_table</span><span class="p">[[(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">filtered_table</span><span class="p">[</span><span class="n">column</span><span class="p">]]]</span>
    <span class="k">return</span> <span class="n">filtered_table</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="download-the-data">
<h2>4. Download the Data <a id='data'></a><a class="headerlink" href="#download-the-data" title="Link to this heading">#</a></h2>
<p>The script will download these automatically from MAST and the other links below:</p>
<ul class="simple">
<li><p>NIRSpec <code class="docutils literal notranslate"><span class="pre">CAL</span></code>, <code class="docutils literal notranslate"><span class="pre">S2D</span></code>, and <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files for this object from <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code></p></li>
<li><p>NIRSpec MSA metafile</p></li>
<li><p>NIRCam image from the <a class="reference external" href="https://dawn-cph.github.io/dja/index.html">DJA</a></p>
<ul>
<li><p>https://s3.amazonaws.com/grizli-v2/JwstMosaics/v7/smacs0723-grizli-v7.0-f200w-clear_drc_sci.fits.gz</p></li>
</ul>
</li>
<li><p>NIRCam color image produced using <a class="reference external" href="https://github.com/dancoe/trilogy">Trilogy</a> (optional)</p>
<ul>
<li><p>https://relics.stsci.edu/data/smacs0723-73/JWST/smacs0723_color_sw.png</p></li>
<li><p>alternatively, you could show a single filter image in grayscale</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define data directory.</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First, we will download the NIRSpec <code class="docutils literal notranslate"><span class="pre">CAL</span></code>, <code class="docutils literal notranslate"><span class="pre">S2D</span></code>, and <code class="docutils literal notranslate"><span class="pre">X1D</span></code> files for a specific source from MAST. You may also choose to load in files youve reprocessed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select a source_id to download and examine.</span>
<span class="n">source_id</span> <span class="o">=</span> <span class="mi">6355</span>  <span class="c1"># z = 7.665</span>
<span class="c1">#source_id = 4590  # z = 8.498</span>
<span class="c1">#source_id = 10612  # z = 7.663</span>
<span class="c1">#source_id = 9922  # z = 2.743</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the CAL spectrum filename.</span>
<span class="n">cal_file</span> <span class="o">=</span> <span class="s1">&#39;jw02736-o007_s</span><span class="si">%09d</span><span class="s1">_nirspec_f290lp-g395m_cal.fits&#39;</span> <span class="o">%</span> <span class="n">source_id</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The CAL file is:&quot;</span><span class="p">,</span> <span class="n">cal_file</span><span class="p">)</span>

<span class="c1"># Download 2D spectrum.</span>
<span class="n">cal_file</span> <span class="o">=</span> <span class="n">download_jwst_files</span><span class="p">([</span><span class="n">cal_file</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cal_file</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The CAL file is: jw02736-o007_s000006355_nirspec_f290lp-g395m_cal.fits
data/jw02736-o007_s000006355_nirspec_f290lp-g395m_cal.fits EXISTS
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;data/jw02736-o007_s000006355_nirspec_f290lp-g395m_cal.fits&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download S2D rectified spectrum.</span>
<span class="n">s2d_file</span> <span class="o">=</span> <span class="n">cal_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cal&#39;</span><span class="p">,</span> <span class="s1">&#39;s2d&#39;</span><span class="p">)</span>
<span class="n">s2d_file</span> <span class="o">=</span> <span class="n">download_jwst_files</span><span class="p">([</span><span class="n">s2d_file</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">s2d_file</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/jw02736-o007_s000006355_nirspec_f290lp-g395m_s2d.fits EXISTS
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;data/jw02736-o007_s000006355_nirspec_f290lp-g395m_s2d.fits&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download 1D spectrum.</span>
<span class="n">x1d_file</span> <span class="o">=</span> <span class="n">s2d_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s2d&#39;</span><span class="p">,</span> <span class="s1">&#39;x1d&#39;</span><span class="p">)</span>
<span class="n">x1d_file</span> <span class="o">=</span> <span class="n">download_jwst_files</span><span class="p">([</span><span class="n">x1d_file</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x1d_file</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/jw02736-o007_s000006355_nirspec_f290lp-g395m_x1d.fits EXISTS
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;data/jw02736-o007_s000006355_nirspec_f290lp-g395m_x1d.fits&#39;
</pre></div>
</div>
</div>
</div>
<p>Next, we will grab the MSA metadata file name from the header of the <code class="docutils literal notranslate"><span class="pre">S2D</span></code> file and download it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get name of MSA metafile from S2D file header.</span>
<span class="n">msa_metafile</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">s2d_file</span><span class="p">,</span> <span class="s1">&#39;MSAMETFL&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The MSA metadata file name is = </span><span class="si">{</span><span class="n">msa_metafile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Download MSA metafile.</span>
<span class="n">msa_metafile</span> <span class="o">=</span> <span class="n">download_jwst_files</span><span class="p">([</span><span class="n">msa_metafile</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">msa_metafile</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The MSA metadata file name is = jw02736007001_01_msa.fits
data/jw02736007001_01_msa.fits EXISTS
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;data/jw02736007001_01_msa.fits&#39;
</pre></div>
</div>
</div>
</div>
<p>Finally, we will download the NIRCam data.</p>
<p>The NIRCam color image was created with <a class="reference external" href="https://github.com/dancoe/trilogy">Trilogy</a>
using <a class="reference external" href="https://dawn-cph.github.io/dja/imaging/v7/">NIRCam images in the DAWN JWST Archive (DJA)</a>. This is optional.</p>
<p>Alternatively, you can show a single filter image in grayscale.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download a color image if you have one.</span>
<span class="c1"># It should be on the same pixel grid as the FITS image you&#39;ll download next after this.</span>

<span class="n">showing_color_image</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Controls the plotting later.</span>

<span class="c1"># Trilogy NIRCam SW color image (226 MB).</span>
<span class="n">color_image_file</span> <span class="o">=</span> <span class="s1">&#39;https://relics.stsci.edu/data/smacs0723-73/JWST/smacs0723_color_sw.png&#39;</span>
<span class="n">color_image_file</span> <span class="o">=</span> <span class="n">download_large_file</span><span class="p">(</span><span class="n">color_image_file</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="n">color_image_file</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/smacs0723_color_sw.png EXISTS
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;data/smacs0723_color_sw.png&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load single filter FITS image for WCS header to convert RA, Dec -&gt; x, y.</span>
<span class="c1"># NIRCam F200W FITS image from DJA (371 MB).</span>
<span class="n">NIRCam_image_file</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/grizli-v2/JwstMosaics/v7/smacs0723-grizli-v7.0-f200w-clear_drc_sci.fits.gz&#39;</span>
<span class="n">NIRCam_image_file</span> <span class="o">=</span> <span class="n">download_large_file</span><span class="p">(</span><span class="n">NIRCam_image_file</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="n">NIRCam_image_file</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/smacs0723-grizli-v7.0-f200w-clear_drc_sci.fits EXISTS
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;data/smacs0723-grizli-v7.0-f200w-clear_drc_sci.fits&#39;
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="load-in-the-data">
<h2>5. Load in the Data <a id='load'></a><a class="headerlink" href="#load-in-the-data" title="Link to this heading">#</a></h2>
<p>In this section, we will load in the data for the NIRSpec spectra and metadata, as well as the NIRCam images.</p>
<hr class="docutils" />
<section id="nirspec-spectra">
<h3>5.1 NIRSpec Spectra <a id='load_spectra'></a><a class="headerlink" href="#nirspec-spectra" title="Link to this heading">#</a></h3>
<p>Use JWST datamodels to hold the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open the CAL file and extract the data.</span>
<span class="n">cal_model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal_file</span><span class="p">)</span>

<span class="c1"># Locate the data for the object with the requested source_id.</span>
<span class="k">if</span> <span class="s1">&#39;slits&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cal_model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cal_model</span><span class="o">.</span><span class="n">slits</span><span class="p">:</span>  <span class="c1"># Spec2 S2D has all the objects; extract the one with source_id.</span>
    <span class="n">source_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">slit</span><span class="o">.</span><span class="n">source_id</span> <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">cal_model</span><span class="o">.</span><span class="n">slits</span><span class="p">]</span>
    <span class="n">i_slit</span> <span class="o">=</span> <span class="n">source_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>
    <span class="n">slit_model_cal</span> <span class="o">=</span> <span class="n">cal_model</span><span class="o">.</span><span class="n">slits</span><span class="p">[</span><span class="n">i_slit</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># Spec3 S2D only has one object or slits is empty.</span>
    <span class="n">slit_model_cal</span> <span class="o">=</span> <span class="n">cal_model</span><span class="o">.</span><span class="n">exposures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i_slit</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">cal_data</span> <span class="o">=</span> <span class="n">slit_model_cal</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="mi">0</span>  <span class="c1"># Load and make copy.</span>

<span class="c1"># Replace zeros with nan where there is no data.</span>
<span class="n">cal_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">slit_model_cal</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">cal_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open the S2D file and extract the data.</span>
<span class="n">s2d_model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s2d_file</span><span class="p">)</span>
<span class="c1">#s2d_model.info(max_rows=99999)  # Show all contents.</span>
<span class="c1">#s2d_data = s2d_model.data + 0</span>

<span class="c1"># Locate the data for the object with the requested source_id.</span>
<span class="k">if</span> <span class="s1">&#39;slits&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">s2d_model</span><span class="p">):</span>  <span class="c1"># Spec2 s2d has all the objects; extract the one with source_id.</span>
    <span class="n">source_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">slit</span><span class="o">.</span><span class="n">source_id</span> <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">s2d_model</span><span class="o">.</span><span class="n">slits</span><span class="p">]</span>
    <span class="n">i_slit</span> <span class="o">=</span> <span class="n">source_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>
    <span class="n">slit_model_s2d</span> <span class="o">=</span> <span class="n">s2d_model</span><span class="o">.</span><span class="n">slits</span><span class="p">[</span><span class="n">i_slit</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># Spec3 s2d only has one object</span>
    <span class="n">slit_model_s2d</span> <span class="o">=</span> <span class="n">s2d_model</span>
    <span class="n">i_slit</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">s2d_data</span> <span class="o">=</span> <span class="n">slit_model_s2d</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="mi">0</span>  <span class="c1"># Load and make copy.</span>

<span class="c1"># Replace zeros with nan where there is no data</span>
<span class="n">s2d_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">slit_model_s2d</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">s2d_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load 1D extraction.</span>
<span class="n">x1d_model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span>
<span class="c1">#x1d_model.info(max_rows=99999)  # Show all contents.</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="extract-the-wavelength-grid">
<h4>5.1.1 Extract the Wavelength Grid <a id='wave_grid'></a><a class="headerlink" href="#extract-the-wavelength-grid" title="Link to this heading">#</a></h4>
<p>We can extract the wavelength grid directly from the <code class="docutils literal notranslate"><span class="pre">S2D</span></code> datamodel after running the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/_modules/jwst/assign_wcs/nirspec.html"><em><code class="docutils literal notranslate"><span class="pre">assign_wcs</span></code></em></a> step. The <code class="docutils literal notranslate"><span class="pre">S2D</span></code> model includes a World Coordinate System (WCS) transform from detector coordinates to world coordinates  specifically: RA, Dec, and wavelength.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WCS transformations.</span>
<span class="n">slit_wcs</span> <span class="o">=</span> <span class="n">slit_model_s2d</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span>
<span class="n">det_to_sky</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>  <span class="c1"># Coordinate transform from detector pixels to sky.</span>
<span class="n">slit_to_sky</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;slit_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>
<span class="n">sky_to_slit</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;slit_frame&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_s2d</span><span class="p">,</span> <span class="n">x_s2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">s2d_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">s2d_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># Grid of pixel x, y indices.</span>
<span class="n">ra_s2d</span><span class="p">,</span> <span class="n">dec_s2d</span><span class="p">,</span> <span class="n">s2d_waves</span> <span class="o">=</span> <span class="n">det_to_sky</span><span class="p">(</span><span class="n">x_s2d</span><span class="p">,</span> <span class="n">y_s2d</span><span class="p">)</span>  <span class="c1"># RA, Dec, wavelength (microns) for each pixel.</span>
<span class="n">ra_s2d</span> <span class="o">=</span> <span class="n">ra_s2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># RA, Dec only defined in the spatial cross-dispersion direction.</span>
<span class="n">dec_s2d</span> <span class="o">=</span> <span class="n">dec_s2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># RA, Dec only defined in the spatial cross-dispersion direction.</span>
<span class="n">s2d_wave</span> <span class="o">=</span> <span class="n">s2d_waves</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># Wavelength only defined in the dispersion direction.</span>
<span class="c1"># Every row is identical in the rectified spectrum.</span>
<span class="n">s2d_wave</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2.84863722, 2.85043148, 2.85222575, ..., 5.28289045, 5.28467829,
       5.28646621], shape=(1215,))
</pre></div>
</div>
</div>
</div>
<p>Alternatively, we can extract the wavelength grid directly from the <code class="docutils literal notranslate"><span class="pre">X1D</span></code> file as shown below. The <code class="docutils literal notranslate"><span class="pre">S2D</span></code> spectrum is on the same wavelength grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x1d_wave</span> <span class="o">=</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i_slit</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">WAVELENGTH</span>
<span class="n">x1d_wave</span>  <span class="c1"># Identical to s2d_wave below.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2.8486371 , 2.85043144, 2.85222578, ..., 5.28289032, 5.28467846,
       5.28646612], shape=(1215,))
</pre></div>
</div>
</div>
</div>
<p><strong>Note</strong>: Starting with JWST pipeline version 1.16, the WCS in the <code class="docutils literal notranslate"><span class="pre">S2D</span></code> files produces an infinitely thin slit when projected onto the sky, so we will use the <code class="docutils literal notranslate"><span class="pre">CAL</span></code> files instead to project the full width of the shutters. Therefore, all transforms used moving forward in this notebook will be taken from the <code class="docutils literal notranslate"><span class="pre">CAL</span></code> file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WCS transformations.</span>
<span class="n">slit_wcs</span> <span class="o">=</span> <span class="n">slit_model_cal</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span>
<span class="n">det_to_sky</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>  <span class="c1"># Coordinate transform from detector pixels to sky.</span>
<span class="n">slit_to_sky</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;slit_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>
<span class="n">sky_to_slit</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;slit_frame&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="msa-metafile">
<h3>5.2 MSA Metafile <a id='load_msa'></a><a class="headerlink" href="#msa-metafile" title="Link to this heading">#</a></h3>
<p>Load the MSA metadata file to extract information about the observed sources. We list out a few things below, but for a detailed walkthrough on MSA metadata files, see the <a class="reference external" href="https://github.com/spacetelescope/jdat_notebooks/tree/main">JDAT GitHub repository</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load MSA metafile and inspect contents</span>
<span class="n">msa_hdu_list</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msa_metafile</span><span class="p">)</span>
<span class="n">msa_hdu_list</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filename: data/jw02736007001_01_msa.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU      16   ()      
  1  SHUTTER_IMAGE    1 ImageHDU         8   (342, 730)   int16   
  2  SHUTTER_INFO    1 BinTableHDU     35   1318R x 13C   [I, I, I, I, I, J, 1A, 6A, E, E, I, 1A, 7A]   
  3  SOURCE_INFO    1 BinTableHDU     25   119R x 8C   [J, J, 20A, 31A, D, D, 30A, D]   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the shutter and source tables.</span>
<span class="n">shutter_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">msa_hdu_list</span><span class="p">[</span><span class="s1">&#39;SHUTTER_INFO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">source_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">msa_hdu_list</span><span class="p">[</span><span class="s1">&#39;SOURCE_INFO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="c1">#msa_hdu_list[&#39;SHUTTER_IMAGE&#39;].data.shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The MSA metadata file can have multiple MSA configs.</span>
<span class="nb">set</span><span class="p">(</span><span class="n">shutter_table</span><span class="p">[</span><span class="s1">&#39;msa_metadata_id&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{np.int16(1), np.int16(76)}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out the number of dithers.</span>
<span class="n">dithers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">shutter_table</span><span class="p">[</span><span class="s1">&#39;dither_point_index&#39;</span><span class="p">]))</span>
<span class="n">dithers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[np.int16(1), np.int16(2), np.int16(3)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print out all source_ids in the shutter table.</span>
<span class="n">source_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">shutter_table</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">])</span>
<span class="n">source_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">source_ids</span><span class="p">))</span>
<span class="n">source_ids</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([   -62,    -61,    -60,    -59,    -58,    -57,    -56,    -55,
          -54,    -53,    -52,    -51,    -50,    -49,    -48,    -47,
          -46,    -45,    -44,    -43,    -42,    -41,    -40,    -39,
          -38,    -37,    -36,    -35,    -34,    -33,    -32,    -31,
          -30,    -29,    -28,    -27,    -26,    -25,    -24,    -23,
          -22,    -21,    -20,    -19,    -18,    -17,    -16,    -15,
          -14,    -13,    -12,    -11,    -10,     -9,     -8,     -7,
           -6,     -5,     -4,     -3,     -2,     -1,      0,   1370,
         1679,   1917,   2038,   2572,   2653,   3042,   3772,   4580,
         4590,   4592,   4798,   4805,   5144,   5735,   5992,   6113,
         6355,   7570,   7677,   8140,   8277,   8311,   8312,   8498,
         8506,   8717,   8730,   8883,   8886,   8981,   9239,   9483,
         9721,   9922,  10380,  10389,  10390,  10392,  10444,  10511,
        10612, 101449, 102423, 102539, 102673, 102711, 102730, 102738,
       102744, 102750, 102751, 102798, 102933, 102934, 103091, 103157],
      dtype=int32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter the source table for the requested source_id.</span>
<span class="n">select_source_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="n">source_id</span><span class="p">)</span>
<span class="n">select_source_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=1</i>
<table id="table139836419504592" class="table-striped table-bordered table-condensed">
<thead><tr><th>program</th><th>source_id</th><th>source_name</th><th>alias</th><th>ra</th><th>dec</th><th>preimage_id</th><th>stellarity</th></tr></thead>
<thead><tr><th>int32</th><th>int32</th><th>str20</th><th>str31</th><th>float64</th><th>float64</th><th>str30</th><th>float64</th></tr></thead>
<tr><td>2736</td><td>6355</td><td>2736_6355</td><td>6355</td><td>110.84459416965377</td><td>-73.4350589621277</td><td>None</td><td>0.1</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the source RA and Dec.</span>
<span class="n">source_ra</span> <span class="o">=</span> <span class="n">select_source_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">source_dec</span> <span class="o">=</span> <span class="n">select_source_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">source_ra</span><span class="p">,</span> <span class="n">source_dec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(110.84459416965377), np.float64(-73.4350589621277))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter the shutter table for the requested source_id.</span>
<span class="n">source_shutter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">(</span><span class="n">shutter_table</span><span class="p">,</span> <span class="n">dither_point_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">msa_metadata_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="n">source_id</span><span class="p">)</span>
<span class="n">source_shutter_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=5</i>
<table id="table139836419320976" class="table-striped table-bordered table-condensed">
<thead><tr><th>slitlet_id</th><th>msa_metadata_id</th><th>shutter_quadrant</th><th>shutter_row</th><th>shutter_column</th><th>source_id</th><th>background</th><th>shutter_state</th><th>estimated_source_in_shutter_x</th><th>estimated_source_in_shutter_y</th><th>dither_point_index</th><th>primary_source</th><th>fixed_slit</th></tr></thead>
<thead><tr><th>int16</th><th>int16</th><th>int16</th><th>int16</th><th>int16</th><th>int32</th><th>str1</th><th>str6</th><th>float32</th><th>float32</th><th>int16</th><th>str1</th><th>str7</th></tr></thead>
<tr><td>72</td><td>1</td><td>3</td><td>138</td><td>83</td><td>6355</td><td>Y</td><td>OPEN</td><td>nan</td><td>nan</td><td>1</td><td>N</td><td>NONE</td></tr>
<tr><td>72</td><td>1</td><td>3</td><td>138</td><td>84</td><td>6355</td><td>N</td><td>OPEN</td><td>0.46437824</td><td>0.86562544</td><td>1</td><td>Y</td><td>NONE</td></tr>
<tr><td>72</td><td>1</td><td>3</td><td>138</td><td>85</td><td>6355</td><td>Y</td><td>OPEN</td><td>nan</td><td>nan</td><td>1</td><td>N</td><td>NONE</td></tr>
<tr><td>72</td><td>1</td><td>3</td><td>138</td><td>86</td><td>6355</td><td>Y</td><td>OPEN</td><td>nan</td><td>nan</td><td>1</td><td>N</td><td>NONE</td></tr>
<tr><td>72</td><td>1</td><td>3</td><td>138</td><td>87</td><td>6355</td><td>Y</td><td>OPEN</td><td>nan</td><td>nan</td><td>1</td><td>N</td><td>NONE</td></tr>
</table></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the primary index for the source in the slitlet.</span>
<span class="n">i_primary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;primary_source&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">i_primary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="nircam-images">
<h3>5.3 NIRCam Images <a id='load_nircam'></a><a class="headerlink" href="#nircam-images" title="Link to this heading">#</a></h3>
<p>Load in the NIRCam data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load in the NIRCam FITS file.</span>
<span class="n">image_hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">NIRCam_image_file</span><span class="p">)</span>
<span class="n">idata</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Extract the WCS information.</span>
<span class="n">image_wcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">image_hdulist</span><span class="p">[</span><span class="n">idata</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">image_hdulist</span><span class="p">)</span>
<span class="n">image_hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">image_wcs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39;
CUNIT : &#39;deg&#39; &#39;deg&#39;
CRVAL : 110.83403 -73.45429
CRPIX : 9182.5 13030.5
CD1_1 CD1_2  : -5.5555555555555e-06 0.0
CD2_1 CD2_2  : 0.0 5.5555555555555e-06
NAXIS : 24000  24000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load in the NIRCam color image or single filter image.</span>
<span class="k">if</span> <span class="n">showing_color_image</span><span class="p">:</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">color_image_file</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_TOP_BOTTOM</span><span class="p">)</span>
    <span class="n">NIRCam_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="c1"># Takes a few seconds to load a large image.   </span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Just load single image.</span>
    <span class="n">NIRCam_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">NIRCam_image_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="define-the-slit-sizes">
<h2>6. Define the Slit Sizes <a id='slit_sizes'></a><a class="headerlink" href="#define-the-slit-sizes" title="Link to this heading">#</a></h2>
<p>Before mapping the slits to the sky, lets define the physical dimensions of the MSA slits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">open_slit_x_size</span> <span class="o">=</span> <span class="mf">0.20</span>  <span class="c1"># Open slit width in arcseconds (dispersion direction).</span>
<span class="n">open_slit_y_size</span> <span class="o">=</span> <span class="mf">0.46</span>  <span class="c1"># Open slit height in arcseconds (cross-dispersion direction).</span>
<span class="n">slit_bar_width</span> <span class="o">=</span> <span class="mf">0.07</span>  <span class="c1"># The bar width=height in arcseconds (between the slits).</span>
<span class="n">open_slit_aspect</span> <span class="o">=</span> <span class="n">open_slit_y_size</span> <span class="o">/</span> <span class="n">open_slit_x_size</span>  <span class="c1"># Aspect ratio of open slit.</span>

<span class="c1"># Define the full slit size including the bar width.</span>
<span class="n">full_slit_x_size</span> <span class="o">=</span> <span class="n">open_slit_x_size</span> <span class="o">+</span> <span class="n">slit_bar_width</span>
<span class="n">full_slit_y_size</span> <span class="o">=</span> <span class="n">open_slit_y_size</span> <span class="o">+</span> <span class="n">slit_bar_width</span>
<span class="n">full_slit_aspect</span> <span class="o">=</span> <span class="n">full_slit_y_size</span> <span class="o">/</span> <span class="n">full_slit_x_size</span>  <span class="c1"># Aspect ratio of full slit.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Full slit size: width = </span><span class="si">{</span><span class="n">full_slit_x_size</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec, height = </span><span class="si">{</span><span class="n">full_slit_y_size</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> arcsec.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Full slit size: width = 0.27 arcsec, height = 0.53 arcsec.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Scale factors from open slit to full slit size (including bars) in x and y directions.</span>
<span class="n">x_scale_open_to_full</span> <span class="o">=</span> <span class="n">full_slit_x_size</span> <span class="o">/</span> <span class="n">open_slit_x_size</span>
<span class="n">y_scale_open_to_full</span> <span class="o">=</span> <span class="n">full_slit_y_size</span> <span class="o">/</span> <span class="n">open_slit_y_size</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scale factors (open to full slit): x = </span><span class="si">{</span><span class="n">x_scale_open_to_full</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y = </span><span class="si">{</span><span class="n">y_scale_open_to_full</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scale factors (open to full slit): x = 1.35, y = 1.15
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Slit corners in coordinates that range from (0,0) to (1,1).</span>
<span class="c1"># Order of corners: bottom-left, top-left, top-right, bottom-right.</span>
<span class="n">open_slit_x_corners</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> 
<span class="n">open_slit_y_corners</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>

<span class="c1"># Convert coordinates to slit centroid at (0,0).</span>
<span class="n">open_slit_x_corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">open_slit_x_corners</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">open_slit_y_corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">open_slit_y_corners</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>

<span class="c1"># Convert to full slit (not just open area).</span>
<span class="n">full_slit_x_corners</span> <span class="o">=</span> <span class="n">x_scale_open_to_full</span> <span class="o">*</span> <span class="n">open_slit_x_corners</span>
<span class="n">full_slit_y_corners</span> <span class="o">=</span> <span class="n">y_scale_open_to_full</span> <span class="o">*</span> <span class="n">open_slit_y_corners</span>

<span class="c1"># Print the full slit corners as (x, y) pairs relative to the slit centroid</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full slit corners (x, y):&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">full_slit_x_corners</span><span class="p">,</span> <span class="n">full_slit_y_corners</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Full slit corners (x, y): [(np.float64(-0.675), np.float64(-0.5760869565217391)), (np.float64(-0.675), np.float64(0.5760869565217391)), (np.float64(0.675), np.float64(0.5760869565217391)), (np.float64(0.675), np.float64(-0.5760869565217391))]
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="mapping-slits-to-the-sky">
<h2>7. Mapping Slits to the Sky <a id='mapping'></a><a class="headerlink" href="#mapping-slits-to-the-sky" title="Link to this heading">#</a></h2>
<p>In the next few cells, we will map the slits to the sky. First, from the MSA metadata file, extract the estimated source position in the shutter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># MSA metafile estimate of source position within shutter slitlet.</span>
<span class="c1"># Coordinates range from (0,0) to (1,1).</span>
<span class="n">estimated_source_in_shutter_x</span> <span class="o">=</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;estimated_source_in_shutter_x&#39;</span><span class="p">][</span><span class="n">i_primary</span><span class="p">]</span>
<span class="n">estimated_source_in_shutter_y</span> <span class="o">=</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;estimated_source_in_shutter_y&#39;</span><span class="p">][</span><span class="n">i_primary</span><span class="p">]</span>
<span class="c1">#estimated_source_in_shutter_x, estimated_source_in_shutter_y</span>

<span class="c1"># Convert coordinates to slit centroid at (0,0).</span>
<span class="n">estimated_source_in_shutter_x</span> <span class="o">-=</span> <span class="mf">0.5</span>
<span class="n">estimated_source_in_shutter_y</span> <span class="o">-=</span> <span class="mf">0.5</span>

<span class="c1"># Coordinates are actually for full slit (not just open area).</span>
<span class="c1"># Scale to full slit size.</span>
<span class="n">estimated_source_in_shutter_x</span> <span class="o">*=</span> <span class="n">x_scale_open_to_full</span>
<span class="n">estimated_source_in_shutter_y</span> <span class="o">*=</span> <span class="n">y_scale_open_to_full</span>

<span class="c1"># Transform to sky (RA,Dec) using S2D WCS transformation.</span>
<span class="n">estimated_source_ra</span><span class="p">,</span> <span class="n">estimated_source_dec</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span>
    <span class="n">estimated_source_in_shutter_x</span><span class="p">,</span> <span class="n">estimated_source_in_shutter_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Transform to image pixels (x,y) using image WCS.</span>
<span class="n">estimated_source_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">estimated_source_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">estimated_source_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="n">estimated_source_x</span><span class="p">,</span> <span class="n">estimated_source_y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">estimated_source_coordinates</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated source position: RA = </span><span class="si">{</span><span class="n">estimated_source_ra</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> deg, Dec = </span><span class="si">{</span><span class="n">estimated_source_dec</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> deg&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated source pixel location: x = </span><span class="si">{</span><span class="n">estimated_source_x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y = </span><span class="si">{</span><span class="n">estimated_source_y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimated source position: RA = 110.844591 deg, Dec = -73.435049 deg
Estimated source pixel location: x = 8639.52, y = 16492.86
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Indices to iterate along slit with multiple shutters.</span>
<span class="c1"># (e.g., dy_columns = -1,0,1 for 3-shutter slitlet).</span>
<span class="n">dx_rows</span> <span class="o">=</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;shutter_row&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;shutter_row&#39;</span><span class="p">][</span><span class="n">i_primary</span><span class="p">]</span>
<span class="n">dy_columns</span> <span class="o">=</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">][</span><span class="n">i_primary</span><span class="p">]</span>

<span class="c1"># Scale to full slit (not just open area).</span>
<span class="n">dx_slit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dx_rows</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_scale_open_to_full</span>
<span class="n">dy_slit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dy_columns</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_scale_open_to_full</span>
<span class="c1"># Note the cross-dispersion direction is defined as columns in the MSA metafile.</span>
<span class="c1"># even though we normally show them as rows in the MSA.</span>
<span class="n">dy_slit</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-1.15217391,  0.        ,  1.15217391,  2.30434783,  3.45652174])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate offset between S2D WCS transformation and actual coordinates in input catalog.</span>
<span class="c1"># The input catalog coordinates (RA, Dec) are more accurate.</span>
<span class="n">source_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">source_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">source_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">source_coordinates</span><span class="p">)</span>

<span class="c1"># Calculate offset.</span>
<span class="c1"># We&#39;ll correct for this offset below.</span>
<span class="n">dx_obs</span> <span class="o">=</span> <span class="n">estimated_source_x</span> <span class="o">-</span> <span class="n">source_x</span>
<span class="n">dy_obs</span> <span class="o">=</span> <span class="n">estimated_source_y</span> <span class="o">-</span> <span class="n">source_y</span>

<span class="c1"># Print the pixel offset between estimated and catalog positions.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Offset between estimated and catalog source position: x = </span><span class="si">{</span><span class="n">dx_obs</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> px, y = </span><span class="si">{</span><span class="n">dy_obs</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Offset between estimated and catalog source position: x = 0.15 px, y = 1.82 px
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert full slit corner coordinates to sky using S2D WCS transformation (slit_to_sky),</span>
<span class="c1"># then convert those sky positions to image pixel coordinates using the image WCS.</span>
<span class="n">xx</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">yy</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dy_columns</span><span class="p">)):</span>
    <span class="c1"># Apply spatial offset for each shutter in the slitlet.</span>
    <span class="n">slitlet_ra</span><span class="p">,</span> <span class="n">slitlet_dec</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span><span class="n">full_slit_x_corners</span> <span class="o">+</span> <span class="n">dx_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">full_slit_y_corners</span> <span class="o">+</span> <span class="n">dy_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create SkyCoord object from RA/Dec.</span>
    <span class="n">slit_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">slitlet_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">slitlet_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

    <span class="c1"># Convert sky coordinates to image pixel coordinates.</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">slit_coordinates</span><span class="p">)</span>

    <span class="c1"># Save corner positions for each shutter.</span>
    <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Define the image stamp region: a 3&quot;x3&quot; square around the center of the slits.</span>
<span class="n">dx</span> <span class="o">=</span> <span class="mi">75</span>  <span class="c1"># Half-width in pixels (0.02&quot; * 75 pixels = 1.5&quot;, so the image will be 3&quot;x3&quot;).</span>
<span class="n">slices</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">slices_extent</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yy</span><span class="p">),</span> <span class="n">dx</span><span class="p">)</span>
<span class="n">xlo</span><span class="p">,</span> <span class="n">xhi</span><span class="p">,</span> <span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span> <span class="o">=</span> <span class="n">extent</span>

<span class="c1"># Print the center of the slitlet in pixel coordinates.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Center of slitlet region: x = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, y = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Center of slitlet region: x = 8626.04, y = 16482.51
</pre></div>
</div>
</div>
</div>
<p>Plot the MSA slitlet on the sky.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slit_color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>  <span class="c1"># open</span>
<span class="n">full_slit_color</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
<span class="n">source_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># green</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot the NIRCam image.</span>
<span class="k">if</span> <span class="n">showing_color_image</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># grayscale</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="c1"># Plot source position from input catalog.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">source_color</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

<span class="c1"># Plot the slitlet shutters.</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_shutter_table</span><span class="p">)):</span>
    <span class="c1"># Plot open slit area.</span>
    <span class="n">slitlet_ra</span><span class="p">,</span> <span class="n">slitlet_dec</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span><span class="n">open_slit_x_corners</span> <span class="o">+</span> <span class="n">dx_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">open_slit_y_corners</span> <span class="o">+</span> <span class="n">dy_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">slit_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">slitlet_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">slitlet_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">slit_coordinates</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">-</span><span class="n">dx_obs</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">dy_obs</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># correction</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">slit_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

    <span class="c1"># Plot full slit area including half bar.</span>
    <span class="n">full_slitlet_ra</span><span class="p">,</span> <span class="n">full_slitlet_dec</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span>
        <span class="n">x_scale_open_to_full</span> <span class="o">*</span> <span class="n">open_slit_x_corners</span> <span class="o">+</span> <span class="n">dx_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
        <span class="n">y_scale_open_to_full</span> <span class="o">*</span> <span class="n">open_slit_y_corners</span> <span class="o">+</span> <span class="n">dy_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">full_slit_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">full_slitlet_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">full_slitlet_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">full_slit_coordinates</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">-</span><span class="n">dx_obs</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">dy_obs</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># correction</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">full_slit_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Hide the axis coordinates, ticks, and labels.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/6b82fcc081efb368967dcb4985652fc1be073fab37592a8ec6468be6e1ebef6f.png" src="../../../_images/6b82fcc081efb368967dcb4985652fc1be073fab37592a8ec6468be6e1ebef6f.png" />
</div>
</div>
<section id="show-the-correction-that-enabled-this">
<h3>Show the correction that enabled this<a class="headerlink" href="#show-the-correction-that-enabled-this" title="Link to this heading">#</a></h3>
<p>The slits (RA, Dec) derived from the <code class="docutils literal notranslate"><span class="pre">CAL</span></code> WCS transform is a bit off.<br />
Taking it at face value, we estimate the source position (RA, Dec) based on the estimated position within the slit, which is more accurate.<br />
We compare this to actual source position (RA, Dec) from the catalog in the MSA file.<br />
We use the offset to correct the slit positions (RA, Dec).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wcs_slit_color</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
<span class="n">wcs_source_color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">if</span> <span class="n">showing_color_image</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimated_source_x</span><span class="p">,</span> <span class="n">estimated_source_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">wcs_source_color</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">source_color</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_shutter_table</span><span class="p">)):</span>
    <span class="c1"># Slit coordinates from WCS transform.</span>
    <span class="n">slitlet_ra</span><span class="p">,</span> <span class="n">slitlet_dec</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span><span class="n">open_slit_x_corners</span> <span class="o">+</span> <span class="n">dx_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">open_slit_y_corners</span> <span class="o">+</span> <span class="n">dy_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">slit_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">slitlet_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">slitlet_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">wcs_slit_x</span><span class="p">,</span> <span class="n">wcs_slit_y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">slit_coordinates</span><span class="p">)</span>
    <span class="n">wcs_slit_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wcs_slit_x</span><span class="p">,</span> <span class="n">wcs_slit_y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">wcs_slit_xy</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">wcs_slit_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

    <span class="c1"># Correction.</span>
    <span class="n">slit_x</span> <span class="o">=</span> <span class="n">wcs_slit_x</span> <span class="o">-</span> <span class="n">dx_obs</span>
    <span class="n">slit_y</span> <span class="o">=</span> <span class="n">wcs_slit_y</span> <span class="o">-</span> <span class="n">dy_obs</span>
    <span class="n">slit_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">slit_x</span><span class="p">,</span> <span class="n">slit_y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">slit_xy</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">slit_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlo</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">yhi</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;Slits&#39;</span><span class="p">,</span>                 <span class="n">color</span><span class="o">=</span><span class="n">slit_color</span><span class="p">,</span>       <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlo</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">yhi</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39; source&#39;</span><span class="p">,</span>              <span class="n">color</span><span class="o">=</span><span class="n">source_color</span><span class="p">,</span>     <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlo</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">yhi</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;Slits estimated (WCS)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">wcs_slit_color</span><span class="p">,</span>   <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlo</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">yhi</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="s1">&#39; source in shutter&#39;</span><span class="p">,</span>   <span class="n">color</span><span class="o">=</span><span class="n">wcs_source_color</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Hide the axis coordinates, ticks, and labels.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/8b10c8befa38553abc207e5e94fe4b3df8afc155b65cb019b6a521f20026999e.png" src="../../../_images/8b10c8befa38553abc207e5e94fe4b3df8afc155b65cb019b6a521f20026999e.png" />
</div>
</div>
<p>Now show the <code class="docutils literal notranslate"><span class="pre">S2D</span></code> spatial cross-dispersion direction mapped to sky (RA, Dec).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s2d_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra_s2d</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_s2d</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="n">s2d_x</span><span class="p">,</span> <span class="n">s2d_y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">s2d_coordinates</span><span class="p">)</span>
<span class="n">s2d_x</span> <span class="o">-=</span> <span class="n">dx_obs</span>
<span class="n">s2d_y</span> <span class="o">-=</span> <span class="n">dy_obs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">if</span> <span class="n">showing_color_image</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NIRCam_image</span><span class="p">[</span><span class="n">slices</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">source_color</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_shutter_table</span><span class="p">)):</span>
    <span class="n">slitlet_ra</span><span class="p">,</span> <span class="n">slitlet_dec</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span><span class="n">open_slit_x_corners</span> <span class="o">+</span> <span class="n">dx_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">open_slit_y_corners</span> <span class="o">+</span> <span class="n">dy_slit</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">slit_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">slitlet_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">slitlet_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">slit_coordinates</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">-</span><span class="n">dx_obs</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">dy_obs</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">slit_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s2d_x</span><span class="p">,</span> <span class="n">s2d_y</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s2d_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s2d_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s2d_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">s2d_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlo</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">yhi</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;S2D top&#39;</span><span class="p">,</span>    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>  <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlo</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">yhi</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;S2D pixels&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlo</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">yhi</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;S2D bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span>  <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Hide the axis coordinates, ticks, and labels.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/afd07a01e963bc6b5633c54098e9b3bda26b3d1eb9ccd53b038059ccea29af7a.png" src="../../../_images/afd07a01e963bc6b5633c54098e9b3bda26b3d1eb9ccd53b038059ccea29af7a.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="mapping-sky-back-to-slits">
<h2>8. Mapping Sky back to Slits <a id='mapping_2'></a><a class="headerlink" href="#mapping-sky-back-to-slits" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use full extent of S2D in spatial cross-dispersion direction.</span>
<span class="n">slit_x</span><span class="p">,</span> <span class="n">slit_y</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">sky_to_slit</span><span class="p">(</span><span class="n">ra_s2d</span><span class="p">,</span> <span class="n">dec_s2d</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Slit coordinates.</span>
<span class="n">y_slit_lo</span> <span class="o">=</span> <span class="n">slit_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y_slit_hi</span> <span class="o">=</span> <span class="n">slit_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y_slit_lo</span><span class="p">,</span> <span class="n">y_slit_hi</span>

<span class="c1"># Single slit width + some padding in the dispersion direction.</span>
<span class="n">x_slit_hi</span> <span class="o">=</span> <span class="mf">1.2</span>  <span class="c1"># 1.0 is just the open slit + half bar; add extra for padding.</span>
<span class="n">x_slit_lo</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">x_slit_hi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x_slit_lo</span><span class="p">,</span> <span class="n">x_slit_hi</span> <span class="o">=</span> <span class="n">x_slit_hi</span><span class="p">,</span> <span class="n">x_slit_lo</span>  <span class="c1"># Need to transpose?</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;x:&#39;</span><span class="p">,</span> <span class="n">x_slit_lo</span><span class="p">,</span> <span class="n">x_slit_hi</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y:&#39;</span><span class="p">,</span> <span class="n">y_slit_lo</span><span class="p">,</span> <span class="n">y_slit_hi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x: 1.2 -0.19999999999999996
y: 5.863673315268034 -3.335704736917765
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a high-resolution coordinate grid spanning that extent in the slit plane.</span>
<span class="n">nx_slit_image</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ny_slit_image</span> <span class="o">=</span> <span class="n">nx_slit_image</span> <span class="o">*</span> <span class="n">full_slit_aspect</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_slit_hi</span> <span class="o">-</span> <span class="n">y_slit_lo</span><span class="p">)</span>
<span class="n">y_slit</span><span class="p">,</span> <span class="n">x_slit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">y_slit_lo</span><span class="p">:</span><span class="n">y_slit_hi</span><span class="p">:</span><span class="n">ny_slit_image</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="n">x_slit_lo</span><span class="p">:</span><span class="n">x_slit_hi</span><span class="p">:</span><span class="n">nx_slit_image</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">x_slit</span> <span class="o">*=</span> <span class="n">x_scale_open_to_full</span>
<span class="n">y_slit</span> <span class="o">*=</span> <span class="n">y_scale_open_to_full</span>
<span class="n">ny_slit</span><span class="p">,</span> <span class="n">nx_slit</span> <span class="o">=</span> <span class="n">y_slit</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Transform these coordinates to the image plane.</span>
<span class="n">ra_slit</span><span class="p">,</span> <span class="n">dec_slit</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span><span class="n">x_slit</span><span class="p">,</span> <span class="n">y_slit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">coords_slit</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra_slit</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_slit</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
<span class="n">x_image</span><span class="p">,</span> <span class="n">y_image</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">coords_slit</span><span class="p">)</span>

<span class="c1"># Extract the image values (colors) at each coordinate.</span>
<span class="n">slit_stamp</span> <span class="o">=</span> <span class="n">NIRCam_image</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_image</span><span class="o">-</span><span class="n">dy_obs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x_image</span><span class="o">-</span><span class="n">dx_obs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">slit_stamp</span> <span class="o">==</span> <span class="n">slit_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># All the same value probably means no data.</span>
    <span class="n">slit_stamp</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">slit_stamp</span>  <span class="c1"># Make gray for no data.</span>

<span class="n">slit_extent</span> <span class="o">=</span> <span class="n">x_slit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_slit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_slit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_slit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If dithered, then show extra background slitlets on either side.</span>
<span class="n">slit_bkg_color</span> <span class="o">=</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span>  <span class="c1"># light red</span>
<span class="n">extend_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dithers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dithers</span><span class="p">))</span>
<span class="n">dy_columns_extended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dy_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">extend_length</span><span class="p">,</span> <span class="n">dy_columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">extend_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dy_columns_extended</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-2, -1,  0,  1,  2,  3,  4])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Show image;  don&#39;t bother checking if it&#39;s color or grayscale:</span>
<span class="c1"># cmap will be ignored for color image; and automatic linear scaling could be okay in this region</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">slit_stamp</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">open_slit_aspect</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">slit_extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># Draw slits</span>
<span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">dy_columns_extended</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">between</span><span class="p">(</span><span class="n">dy_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dy_columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">slit_color</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># background dithers</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">slit_bkg_color</span>
    <span class="n">xy_corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">open_slit_x_corners</span><span class="p">,</span> <span class="n">open_slit_y_corners</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">y_scale_open_to_full</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">xy_corners</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimated_source_in_shutter_x</span><span class="p">,</span> <span class="n">estimated_source_in_shutter_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">source_color</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># hide the axis coordinates, ticks, and labels</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(0.945),
 np.float64(-0.945),
 np.float64(6.179884471939257),
 np.float64(-4.419398936013947))
</pre></div>
</div>
<img alt="../../../_images/a72da1df7823c5e5d551af6962ea6952d134ebe0749938117165f2a4b288f531.png" src="../../../_images/a72da1df7823c5e5d551af6962ea6952d134ebe0749938117165f2a4b288f531.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="show-image-alongside-spectrum">
<h2>9. Show Image Alongside Spectrum <a id='final'></a><a class="headerlink" href="#show-image-alongside-spectrum" title="Link to this heading">#</a></h2>
<p>The figures below show:</p>
<ul class="simple">
<li><p><strong>Left panel</strong>: Imaging data around the source, with the shutter outline and estimated source position marked. This indicates where the source falls on the sky and within the slit.</p></li>
<li><p><strong>Top-right panel</strong>: The 2D spectrum, with wavelength along the horizontal axis and the spatial direction along the slit on the vertical axis. Since the spectra have been background-subtracted, negative flux regions appear in red.</p></li>
<li><p><strong>Bottom-right panel</strong>: The 1D extracted spectrum. The blue line shows the source flux as a function of wavelength, while the red line represents the flux uncertainty at each wavelength.</p></li>
</ul>
<p>First lets define some helper plotting functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">extract_slit_from_table</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span>
                            <span class="n">slit_to_sky</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate location information for the given source_id using </span>
<span class="sd">    the provided coordinate transform function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_id : int</span>
<span class="sd">        Source ID number</span>

<span class="sd">    slit_to_sky : astropy.modeling.core.CompoundModel</span>
<span class="sd">        WCS transform from the slit frame to sky coordinates</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    i_primary : int</span>
<span class="sd">        Primary source number</span>
<span class="sd">        </span>
<span class="sd">    dy_columns : astropy.table.Column</span>
<span class="sd">        Column of shutter values</span>
<span class="sd">        </span>
<span class="sd">    dx_obs : float</span>
<span class="sd">        Difference in x-direction between estimated source location and actual source location</span>
<span class="sd">        </span>
<span class="sd">    dy_obs : float</span>
<span class="sd">        Difference in y-direction between estimated source location and actual source location</span>
<span class="sd">        </span>
<span class="sd">    estimated_source_in_shutter_x : float</span>
<span class="sd">        Estimated x location of source within the shutter</span>
<span class="sd">    </span>
<span class="sd">    estimated_source_in_shutter_y : float</span>
<span class="sd">        Estimated y location of source within the shutter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_shutter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">(</span><span class="n">shutter_table</span><span class="p">,</span> <span class="n">dither_point_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">msa_metadata_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="n">source_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">source_shutter_table</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="n">i_primary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;primary_source&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>

    <span class="n">select_source_table</span> <span class="o">=</span> <span class="n">source_table</span><span class="p">[</span><span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;source_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">]</span>
    <span class="n">source_ra</span> <span class="o">=</span> <span class="n">select_source_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">source_dec</span> <span class="o">=</span> <span class="n">select_source_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">estimated_source_in_shutter_x</span> <span class="o">=</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;estimated_source_in_shutter_x&#39;</span><span class="p">][</span><span class="n">i_primary</span><span class="p">]</span>
    <span class="n">estimated_source_in_shutter_y</span> <span class="o">=</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;estimated_source_in_shutter_y&#39;</span><span class="p">][</span><span class="n">i_primary</span><span class="p">]</span>

    <span class="c1"># Shift coordinate centroid to (0,0)</span>
    <span class="n">estimated_source_in_shutter_x</span> <span class="o">-=</span> <span class="mf">0.5</span>
    <span class="n">estimated_source_in_shutter_y</span> <span class="o">-=</span> <span class="mf">0.5</span>

    <span class="c1"># Coordinates are actually for full slit (not just open area)</span>
    <span class="n">estimated_source_in_shutter_x</span> <span class="o">*=</span> <span class="n">x_scale_open_to_full</span>
    <span class="n">estimated_source_in_shutter_y</span> <span class="o">*=</span> <span class="n">y_scale_open_to_full</span>

    <span class="c1"># Transform to sky (RA,Dec) using S2D WCS transformation</span>
    <span class="n">estimated_source_ra</span><span class="p">,</span> <span class="n">estimated_source_dec</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span>
        <span class="n">estimated_source_in_shutter_x</span><span class="p">,</span> <span class="n">estimated_source_in_shutter_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Transform to image pixels (x,y) using image WCS</span>
    <span class="n">estimated_source_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">estimated_source_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">estimated_source_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">estimated_source_x</span><span class="p">,</span> <span class="n">estimated_source_y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">estimated_source_coordinates</span><span class="p">)</span>

    <span class="c1"># Calculate offset between S2D WCS transformation and actual coordinates in input catalog</span>
    <span class="c1"># The input catalog coordinates (RA,Dec) are more accurate than the pipeline (RA,Dec)</span>
    <span class="n">source_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">source_ra</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">source_dec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">source_x</span><span class="p">,</span> <span class="n">source_y</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">source_coordinates</span><span class="p">)</span>

    <span class="c1"># We&#39;ll correct for this offset below</span>
    <span class="n">dx_obs</span> <span class="o">=</span> <span class="n">estimated_source_x</span> <span class="o">-</span> <span class="n">source_x</span>
    <span class="n">dy_obs</span> <span class="o">=</span> <span class="n">estimated_source_y</span> <span class="o">-</span> <span class="n">source_y</span>

    <span class="c1"># Indices to iterate along slit with multiple shutters</span>
    <span class="c1"># (e.g., dy_columns = -1,0,1 for 3-shutter slitlet)</span>
    <span class="c1">#dx_rows = source_shutter_table[&#39;shutter_row&#39;] - source_shutter_table[&#39;shutter_row&#39;][i_primary]</span>
    <span class="n">dy_columns</span> <span class="o">=</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">source_shutter_table</span><span class="p">[</span><span class="s1">&#39;shutter_column&#39;</span><span class="p">][</span><span class="n">i_primary</span><span class="p">]</span>

    <span class="c1"># Scale to full slit (not just open area)</span>
    <span class="c1"># No, do this later</span>
    <span class="c1">#dx_rows    = np.array(dx_rows)    * x_scale_open_to_full</span>
    <span class="c1">#dy_columns = np.array(dy_columns) * y_scale_open_to_full</span>

    <span class="c1"># Note the cross-dispersion direction is defined as columns in the MSA metafile</span>
    <span class="c1"># even though we normally show them as rows in the MSA</span>

    <span class="k">return</span> <span class="n">i_primary</span><span class="p">,</span> <span class="n">dy_columns</span><span class="p">,</span> <span class="n">dx_obs</span><span class="p">,</span> <span class="n">dy_obs</span><span class="p">,</span> <span class="n">estimated_source_in_shutter_x</span><span class="p">,</span> <span class="n">estimated_source_in_shutter_y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">show_MOS_spectrum</span><span class="p">(</span><span class="n">s2d_model</span><span class="p">,</span> <span class="n">x1d_model</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">,</span> <span class="n">bad_color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">expand_wavelength_gap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">plot_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="s1">&#39;plots&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">x_slit_hi</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
                      <span class="n">sigma_2d</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="n">maxiters_2d</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 2D spectrum clipping.</span>
                      <span class="n">ymargin_1d_pos</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>  <span class="c1"># margin above max</span>
                      <span class="n">sigma_1d_pos</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">maxiters_1d_pos</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># 1D spectrum clipping</span>
                      <span class="n">sigma_1d_neg</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>   <span class="n">maxiters_1d_neg</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 1D spectrum clipping</span>
                      <span class="n">ymin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wave_tick_interval</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wave_tick_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and show a figure containing an image of the 2D spectrum, alongside a plot of the 1D spectrum,</span>
<span class="sd">    for the given source. Also show the source in the imaging mode data, with shutter locations overplotted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s2d_model : stdatamodels.jwst.datamodels.slit.SlitModel</span>
<span class="sd">        Datamodel containing 2D cutouts of source spectra</span>
<span class="sd">    x1d_model : stdatamodels.jwst.datamodels.multispec.MultiSpecModel</span>
<span class="sd">        Datamodel containing 1D spectra</span>
<span class="sd">    source_id : int</span>
<span class="sd">        Source ID number</span>
<span class="sd">    cmap : str</span>
<span class="sd">        Colormap</span>
<span class="sd">    bad_color : str</span>
<span class="sd">        Color to use for bad pixels</span>
<span class="sd">    expand_wavelength_gap : bool</span>
<span class="sd">        If there is a wavelength gap in the data, expand the data arrays to sample the gap.</span>
<span class="sd">    plot_image : bool</span>
<span class="sd">        Whether or not to create the figure</span>
<span class="sd">    save_plot : bool</span>
<span class="sd">        Whether or not to save the figure to a file</span>
<span class="sd">    save_dir : str</span>
<span class="sd">        Output directory for saved figure</span>
<span class="sd">    figsize : tup</span>
<span class="sd">        2-tuple of the matplotlib figure size</span>
<span class="sd">    x_slit_hi : float</span>
<span class="sd">    sigma_2d : int</span>
<span class="sd">        Sigma value for 2D spectrum clipping</span>
<span class="sd">    maxiters_2d : int</span>
<span class="sd">        Number of iterations for 2D spectrum clipping</span>
<span class="sd">    ymargin_1d_pos : float</span>
<span class="sd">        Fraction of the maximum 1D data point to use for the upper y-limit of the 1D spectrum plot</span>
<span class="sd">    sigma_1d_pos : int</span>
<span class="sd">        Sigma value for 1D spectrum clipping</span>
<span class="sd">    maxiters_1d_pos : int </span>
<span class="sd">        Number of iterations for 1D spectrum clipping</span>
<span class="sd">    sigma_1d_neg : int</span>
<span class="sd">        Sigma value for 1D negative spectrum clipping</span>
<span class="sd">    maxiters_1d_neg : int</span>
<span class="sd">        Number of iterations for 1D negative spectrum clipping</span>
<span class="sd">    ymin : float</span>
<span class="sd">        Lower limit in y-direction for 1D spectrum plot</span>
<span class="sd">    ymax : float</span>
<span class="sd">        Upper limit in y-direction for 1D spectrum plot</span>
<span class="sd">    wave_tick_interval : float</span>
<span class="sd">        Interval for wavelength ticks</span>
<span class="sd">    wave_tick_fmt : str</span>
<span class="sd">        Format for wavelength tick labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 2D spectrum</span>
    <span class="k">if</span> <span class="s1">&#39;slits&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">s2d_model</span><span class="p">):</span>  <span class="c1"># s2d from Spec2 has all the objects; extract the one with source_id</span>
        <span class="n">source_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">slit</span><span class="o">.</span><span class="n">source_id</span> <span class="k">for</span> <span class="n">slit</span> <span class="ow">in</span> <span class="n">s2d_model</span><span class="o">.</span><span class="n">slits</span><span class="p">]</span>
        <span class="n">i_slit</span> <span class="o">=</span> <span class="n">source_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>
        <span class="n">slit_model</span> <span class="o">=</span> <span class="n">s2d_model</span><span class="o">.</span><span class="n">slits</span><span class="p">[</span><span class="n">i_slit</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># s2d from Spec3 has only one object from one detector</span>
        <span class="n">slit_model</span> <span class="o">=</span> <span class="n">s2d_model</span>
        <span class="n">i_slit</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="n">s2d_data</span> <span class="o">=</span> <span class="n">slit_model</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="mi">0</span>  <span class="c1"># load and make copy</span>
    <span class="n">s2d_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">slit_model</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">s2d_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># Replace zeros with nan where there is no data</span>

    <span class="c1"># 1D spectrum</span>
    <span class="n">x1d_wave</span> <span class="o">=</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i_slit</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">WAVELENGTH</span>
    <span class="n">x1d_flux</span> <span class="o">=</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i_slit</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">FLUX</span>
    <span class="n">x1d_fluxerr</span> <span class="o">=</span> <span class="n">x1d_model</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="n">i_slit</span><span class="p">]</span><span class="o">.</span><span class="n">spec_table</span><span class="o">.</span><span class="n">FLUX_ERROR</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x1d_fluxerr</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1d_fluxerr</span><span class="p">):</span>  <span class="c1"># fluxerr all nan?? pipeline bug</span>
        <span class="n">x1d_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x1d_flux</span><span class="p">,</span> <span class="n">x1d_flux</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># Replace zeros with nan where there is no data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x1d_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x1d_fluxerr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">x1d_flux</span><span class="p">)</span>  <span class="c1"># Replace zeros with nan where there is no data</span>

    <span class="c1"># Expand the wavelength array for the gap?</span>
    <span class="k">if</span> <span class="n">expand_wavelength_gap</span><span class="p">:</span>
        <span class="c1"># calculate differences between consecutive wavelengths and</span>
        <span class="c1"># find if there is a gap to fill</span>
        <span class="n">dx1d_wave</span> <span class="o">=</span> <span class="n">x1d_wave</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x1d_wave</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">igap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dx1d_wave</span><span class="p">)</span>
        <span class="n">dx1d_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dx1d_wave</span><span class="p">)</span>
        <span class="n">dx_replace</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx1d_wave</span><span class="p">[</span><span class="n">igap</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx1d_wave</span><span class="p">[</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">num_fill</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dx1d_max</span> <span class="o">/</span> <span class="n">dx_replace</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expanding wavelength gap </span><span class="si">%.2f</span><span class="s2"> -- </span><span class="si">%.2f</span><span class="s2"> microns&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">x1d_wave</span><span class="p">[</span><span class="n">igap</span><span class="p">],</span> <span class="n">x1d_wave</span><span class="p">[</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">num_fill</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># There is a gap to fill</span>
            <span class="n">wave_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">x1d_wave</span><span class="p">[</span><span class="n">igap</span><span class="p">]:</span> <span class="n">x1d_wave</span><span class="p">[</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span> <span class="p">(</span><span class="n">num_fill</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">]</span>
            <span class="n">x1d_wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x1d_wave</span><span class="p">[:</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">wave_fill</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x1d_wave</span><span class="p">[</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>

            <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_waves</span> <span class="o">=</span> <span class="n">s2d_data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">s2d_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_fill</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">s2d_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s2d_data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">s2d_fill</span><span class="p">,</span> <span class="n">s2d_data</span><span class="p">[:,</span> <span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">x1d_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_fill</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">x1d_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x1d_flux</span><span class="p">[:</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">x1d_fill</span><span class="p">,</span> <span class="n">x1d_flux</span><span class="p">[</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
            <span class="n">x1d_fluxerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x1d_fluxerr</span><span class="p">[:</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">x1d_fill</span><span class="p">,</span> <span class="n">x1d_fluxerr</span><span class="p">[</span><span class="n">igap</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>

    <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span> <span class="o">=</span> <span class="n">x1d_wave</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x1d_wave</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-7</span>
    <span class="n">xtick_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">wave_min</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">/</span> <span class="n">wave_tick_interval</span><span class="p">)</span> <span class="o">*</span> <span class="n">wave_tick_interval</span>
    <span class="n">xticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xtick_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_tick_interval</span><span class="p">)</span>
    <span class="n">num_waves</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1d_wave</span><span class="p">)</span>
    <span class="n">xtick_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">x1d_wave</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_waves</span><span class="p">))</span>
    <span class="n">xtick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">wave_tick_fmt</span> <span class="o">%</span> <span class="n">xtick</span> <span class="k">for</span> <span class="n">xtick</span> <span class="ow">in</span> <span class="n">xticks</span><span class="p">]</span>

    <span class="c1"># Remove any tick labels that are too close and would overlap</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xtick_pos</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">xtick_pos</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xtick_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">xtick_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># WCS transformations</span>
    <span class="n">slit_wcs</span> <span class="o">=</span> <span class="n">slit_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span>
    <span class="n">det_to_sky</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span> <span class="c1"># coordinate transform from detector pixels to sky </span>
    <span class="n">slit_to_sky</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;slit_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>
    <span class="n">sky_to_slit</span> <span class="o">=</span> <span class="n">slit_wcs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;slit_frame&#39;</span><span class="p">)</span>

    <span class="c1"># Extract slit from tables</span>
    <span class="n">slit_list</span> <span class="o">=</span> <span class="n">extract_slit_from_table</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">slit_to_sky</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">slit_list</span> <span class="ow">and</span> <span class="n">plot_image</span><span class="p">:</span>
    
        <span class="n">i_primary</span><span class="p">,</span> <span class="n">dy_columns</span><span class="p">,</span> <span class="n">dx_obs</span><span class="p">,</span> <span class="n">dy_obs</span><span class="p">,</span> \
            <span class="n">estimated_source_in_shutter_x</span><span class="p">,</span> <span class="n">estimated_source_in_shutter_y</span> <span class="o">=</span> <span class="n">slit_list</span>        

        <span class="c1"># Make FIGURE</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="o">*</span><span class="mf">1.2</span><span class="o">/</span><span class="n">x_slit_hi</span><span class="p">],</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.12</span><span class="p">)</span>

        <span class="n">ax_image</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">ax_2d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax_1d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_2d</span><span class="p">)</span>

        <span class="c1"># IMAGE</span>
        <span class="n">ax_image</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
        <span class="n">y_s2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s2d_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># grid of pixel y indices: spatial cross-dispersion</span>
        <span class="n">x_s2d</span> <span class="o">=</span> <span class="n">y_s2d</span> <span class="o">*</span> <span class="mi">0</span>  <span class="c1"># dispersion direction irrelevant for RA, Dec</span>
        <span class="n">ra_s2d</span><span class="p">,</span> <span class="n">dec_s2d</span><span class="p">,</span> <span class="n">s2d_waves</span> <span class="o">=</span> <span class="n">det_to_sky</span><span class="p">(</span><span class="n">x_s2d</span><span class="p">,</span> <span class="n">y_s2d</span><span class="p">)</span> <span class="c1"># RA, Dec, wavelength (microns) for each pixel </span>
        <span class="n">slit_x</span><span class="p">,</span> <span class="n">slit_y</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">sky_to_slit</span><span class="p">(</span><span class="n">ra_s2d</span><span class="p">,</span> <span class="n">dec_s2d</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># slit coordinates</span>

        <span class="n">y_slit_lo</span> <span class="o">=</span> <span class="n">slit_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_slit_hi</span> <span class="o">=</span> <span class="n">slit_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># x_slit_hi = 1.2  # 1.0 is just the slit + half bar; add extra for padding</span>
        <span class="n">x_slit_lo</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">x_slit_hi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x_slit_lo</span><span class="p">,</span> <span class="n">x_slit_hi</span> <span class="o">=</span> <span class="n">x_slit_hi</span><span class="p">,</span> <span class="n">x_slit_lo</span>  <span class="c1"># need to transpose?</span>

        <span class="c1"># Create a high-resolution coordinate grid in the slit plane</span>
        <span class="n">nx_slit_image</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">ny_slit_image</span> <span class="o">=</span> <span class="n">nx_slit_image</span> <span class="o">*</span> <span class="n">full_slit_aspect</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_slit_hi</span> <span class="o">-</span> <span class="n">y_slit_lo</span><span class="p">)</span>
        <span class="n">y_slit</span><span class="p">,</span> <span class="n">x_slit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">y_slit_lo</span><span class="p">:</span><span class="n">y_slit_hi</span><span class="p">:</span><span class="n">ny_slit_image</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">,</span> <span class="n">x_slit_lo</span><span class="p">:</span><span class="n">x_slit_hi</span><span class="p">:</span><span class="n">nx_slit_image</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">x_slit</span> <span class="o">*=</span> <span class="n">x_scale_open_to_full</span>
        <span class="n">y_slit</span> <span class="o">*=</span> <span class="n">y_scale_open_to_full</span>
        <span class="n">ny_slit</span><span class="p">,</span> <span class="n">nx_slit</span> <span class="o">=</span> <span class="n">y_slit</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Transform these to the image plane</span>
        <span class="n">ra_slit</span><span class="p">,</span> <span class="n">dec_slit</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">slit_to_sky</span><span class="p">(</span><span class="n">x_slit</span><span class="p">,</span> <span class="n">y_slit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">coords_slit</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra_slit</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_slit</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">x_image</span><span class="p">,</span> <span class="n">y_image</span> <span class="o">=</span> <span class="n">image_wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">coords_slit</span><span class="p">)</span>

        <span class="c1"># Extract the image values (colors) at each coordinate</span>
        <span class="n">slit_stamp</span> <span class="o">=</span> <span class="n">NIRCam_image</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_image</span><span class="o">-</span><span class="n">dy_obs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x_image</span><span class="o">-</span><span class="n">dx_obs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">slit_stamp</span> <span class="o">==</span> <span class="n">slit_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># all the same value probably means no data</span>
            <span class="n">slit_stamp</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">slit_stamp</span>  <span class="c1"># make gray for no data</span>
            
        <span class="n">slit_extent</span> <span class="o">=</span> <span class="n">x_slit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_slit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_slit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_slit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1">#print(&#39;ymin, xmin&#39;, np.min(y_image-dy_obs), np.min(x_image-dx_obs))</span>
        <span class="c1">#print(source_id, i_primary, dy_columns, dx_obs, dy_obs)</span>

        <span class="c1"># Plot image</span>
        <span class="n">ax_image</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">slit_stamp</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">open_slit_aspect</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">slit_extent</span><span class="p">)</span>
    
        <span class="n">dy_columns_extended</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dy_columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">dy_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dy_columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="n">dy_columns_extended</span><span class="p">:</span>
            <span class="c1">#print(&#39;dy&#39;, dy)</span>
            <span class="k">if</span> <span class="n">between</span><span class="p">(</span><span class="n">dy_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dy_columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">slit_color</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">slit_bkg_color</span>
            <span class="n">xy_corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">open_slit_x_corners</span><span class="p">,</span> <span class="n">open_slit_y_corners</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">y_scale_open_to_full</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">xy_corners</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">ax_image</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="n">ax_image</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimated_source_in_shutter_x</span><span class="p">,</span> <span class="n">estimated_source_in_shutter_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">source_color</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> 
        <span class="c1"># Make FIGURE -- no image</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1">#ax_image = fig.add_subplot(grid[:, 0])</span>
        <span class="n">ax_2d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax_1d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_2d</span><span class="p">)</span>

    <span class="c1"># 2D spectrum</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">]</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">bad_color</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">AstropyWarning</span><span class="p">)</span>
        <span class="n">sigma_clipped_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">s2d_data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_2d</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="n">maxiters_2d</span><span class="p">)</span>
    <span class="n">ymin_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span>
    <span class="n">ymax_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2D limits:&#39;</span><span class="p">,</span> <span class="n">ymin_2d</span><span class="p">,</span> <span class="n">ymax_2d</span><span class="p">)</span>

    <span class="c1"># Plot the rectified 2D spectrum</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">ymin_2d</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">ymax_2d</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">LinearStretch</span><span class="p">())</span>
    <span class="c1">#norm = simple_norm(s2d_data, &#39;linear&#39;, vmin=ymin_2d, vmax=ymax_2d)</span>
    <span class="n">ax_2d</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">s2d_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">s2d_data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ax_2d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

    <span class="c1"># Plot the 1D extraction  x1d vs. indices, same as s2d array above</span>
    <span class="n">ax_1d</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.50&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.66</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax_1d</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_waves</span><span class="p">),</span> <span class="n">x1d_fluxerr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.66</span><span class="p">)</span>
    <span class="n">ax_1d</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_waves</span><span class="p">),</span> <span class="n">x1d_flux</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax_1d</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_waves</span><span class="p">)</span>
    <span class="n">ax_1d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sigma_1d_pos</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">AstropyWarning</span><span class="p">)</span>
            <span class="n">sigma_clipped_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">x1d_flux</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_1d_pos</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="n">maxiters_1d_pos</span><span class="p">)</span>
        <span class="n">ymax_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">ymargin_1d_pos</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">AstropyWarning</span><span class="p">)</span>
            <span class="n">sigma_clipped_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">x1d_flux</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_1d_neg</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="n">maxiters_1d_neg</span><span class="p">)</span>
        <span class="n">ymin_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sigma_clipped_data</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1D limits:&#39;</span><span class="p">,</span> <span class="n">ymin_1d</span><span class="p">,</span> <span class="n">ymax_1d</span><span class="p">)</span>
        <span class="n">ax_1d</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin_1d</span><span class="p">,</span> <span class="n">ymax_1d</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ymin</span> <span class="ow">or</span> <span class="n">ymax</span><span class="p">:</span>
        <span class="n">ax_1d</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
        
    <span class="n">s2d_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">s2d_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> 
    <span class="n">title</span> <span class="o">=</span> <span class="n">s2d_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_s2d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;  slit </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">slit_model</span><span class="o">.</span><span class="n">slitlet_id</span>
    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;  source </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">slit_model</span><span class="o">.</span><span class="n">source_id</span>
    <span class="n">ax_2d</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xtick_pos</span><span class="p">,</span> <span class="n">xtick_labels</span><span class="p">)</span>
    <span class="n">ax_2d</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax_2d</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Hide x-axis labels on the 2D plot</span>
    <span class="n">ax_1d</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;wavelength (microns)&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">s2d_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_s2d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SAVING&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Plot the source of interest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_MOS_spectrum</span><span class="p">(</span><span class="n">s2d_model</span><span class="p">,</span> <span class="n">x1d_model</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>  <span class="c1"># , save_plot=True)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding wavelength gap 4.70 -- 4.96 microns
2D limits: -0.5817210674285889 0.5726847052574158
1D limits: -1.2086293250955275e-06 2.3085450899029464e-06
</pre></div>
</div>
<img alt="../../../_images/d4dbc4d923633af12fc1704bee3f4a7a08ca6cc645638c6fcb70fcee57b75483.png" src="../../../_images/d4dbc4d923633af12fc1704bee3f4a7a08ca6cc645638c6fcb70fcee57b75483.png" />
</div>
</div>
<p>Now, load and display different sources.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_and_show_MOS_spectrum</span><span class="p">(</span><span class="n">source_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function to download an S2D and X1D file for a particular source_id,</span>
<span class="sd">    get the data, and display the 1D and 2D spectra along with the imaging data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_id : int</span>
<span class="sd">        Source ID number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s2d_file</span> <span class="o">=</span> <span class="s1">&#39;jw02736-o007_s</span><span class="si">%09d</span><span class="s1">_nirspec_f290lp-g395m_s2d.fits&#39;</span> <span class="o">%</span> <span class="n">source_id</span>
    <span class="n">s2d_file</span> <span class="o">=</span> <span class="n">download_jwst_files</span><span class="p">([</span><span class="n">s2d_file</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2d_model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s2d_file</span><span class="p">)</span>
    
    <span class="n">x1d_file</span> <span class="o">=</span> <span class="n">s2d_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s2d&#39;</span><span class="p">,</span> <span class="s1">&#39;x1d&#39;</span><span class="p">)</span>
    <span class="n">x1d_file</span> <span class="o">=</span> <span class="n">download_jwst_files</span><span class="p">([</span><span class="n">x1d_file</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x1d_model</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span>
    
    <span class="n">show_MOS_spectrum</span><span class="p">(</span><span class="n">s2d_model</span><span class="p">,</span> <span class="n">x1d_model</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>  <span class="c1"># , save_plot=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source_id</span> <span class="o">=</span> <span class="mi">6355</span>  <span class="c1"># z = 7.665</span>
<span class="n">load_and_show_MOS_spectrum</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>  <span class="c1"># z = 7.665</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/jw02736-o007_s000006355_nirspec_f290lp-g395m_s2d.fits EXISTS
data/jw02736-o007_s000006355_nirspec_f290lp-g395m_x1d.fits EXISTS
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding wavelength gap 4.70 -- 4.96 microns
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2D limits: -0.5817210674285889 0.5726847052574158
1D limits: -1.2086293250955275e-06 2.3085450899029464e-06
</pre></div>
</div>
<img alt="../../../_images/d4dbc4d923633af12fc1704bee3f4a7a08ca6cc645638c6fcb70fcee57b75483.png" src="../../../_images/d4dbc4d923633af12fc1704bee3f4a7a08ca6cc645638c6fcb70fcee57b75483.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">load_and_show_MOS_spectrum</span><span class="p">(</span><span class="mi">10612</span><span class="p">)</span>  <span class="c1"># z = 7.663</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/jw02736-o007_s000010612_nirspec_f290lp-g395m_s2d.fits EXISTS
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/jw02736-o007_s000010612_nirspec_f290lp-g395m_x1d.fits EXISTS
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding wavelength gap 4.60 -- 4.86 microns
2D limits: -0.6765593886375427 0.6589563488960266
1D limits: -1.0199087874105232e-06 1.3177434057217243e-05
</pre></div>
</div>
<img alt="../../../_images/d5c4176eb8bc5138dcd3fa8671ff5aaa1f6762d8ae535b1edf2fa574f43e30be.png" src="../../../_images/d5c4176eb8bc5138dcd3fa8671ff5aaa1f6762d8ae535b1edf2fa574f43e30be.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">load_and_show_MOS_spectrum</span><span class="p">(</span><span class="mi">9922</span><span class="p">)</span>  <span class="c1"># z = 2.743</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>data/jw02736-o007_s000009922_nirspec_f290lp-g395m_s2d.fits EXISTS
data/jw02736-o007_s000009922_nirspec_f290lp-g395m_x1d.fits EXISTS
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding wavelength gap 4.45 -- 4.72 microns
2D limits: -0.8712674379348755 0.7973505854606628
1D limits: -4.445973360002076e-07 2.779875066291981e-06
</pre></div>
</div>
<img alt="../../../_images/9aaf45130d9a46ea30a85446a2de3aa0091d2ae58b62b7c28eda6fdf81b368e2.png" src="../../../_images/9aaf45130d9a46ea30a85446a2de3aa0091d2ae58b62b7c28eda6fdf81b368e2.png" />
</div>
</div>
<hr class="docutils" />
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" />
</a>
<p><a class="reference internal" href="#top"><span class="xref myst">Top of Page</span></a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSpec/mos_slits_to_sky"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../msa_metafile/NIRSpec_MOS_MSA_metafile.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">NIRSpec MOS MSA Metafile</p>
      </div>
    </a>
    <a class="right-next"
       href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">BOTS Time Series Observations</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">1. Introduction <a id="intro"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inputs">Inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outputs">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-library">2. Import Library <a id="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">3. Helper Functions <a id="funcs"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">4. Download the Data <a id="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-in-the-data">5. Load in the Data <a id="load"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nirspec-spectra">5.1 NIRSpec Spectra <a id="load_spectra"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-the-wavelength-grid">5.1.1 Extract the Wavelength Grid <a id="wave_grid"></a></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#msa-metafile">5.2 MSA Metafile <a id="load_msa"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nircam-images">5.3 NIRCam Images <a id="load_nircam"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-slit-sizes">6. Define the Slit Sizes <a id="slit_sizes"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-slits-to-the-sky">7. Mapping Slits to the Sky <a id="mapping"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#show-the-correction-that-enabled-this">Show the correction that enabled this</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-sky-back-to-slits">8. Mapping Sky back to Slits <a id="mapping_2"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#show-image-alongside-spectrum">9. Show Image Alongside Spectrum <a id="final"></a></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>