
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Cleaning Residual 1/f Noise in NIRSpec MOS Products with NSClean &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSpec/NIRSpec_NSClean/MOS_NSClean_example';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Cleaning Residual 1/f Noise in NIRSpec BOTS Products with NSClean" href="BOTS_NSClean_example.html" />
    <link rel="prev" title="Cleaning Residual 1/f Noise in NIRSpec IFU Products with NSClean" href="IFU_NSClean_example.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">JDAViz Demo Notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/Cubeviz.html">Cubeviz with NIRSpec data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/Imviz.html">Jdaviz Imviz Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/Specviz_Specviz2d.html">Specviz and Specviz2D Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jdaviz_demo/notebooks/specreduce_extraction.html">Specreduce Demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/photometry_extragalactic/imviz.html">Photometry with JWST - Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/photometry_extragalactic/photutils_example.html">Photometry of a JWST/NIRCam extragalactic field with Photutils</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples.html">JWST PSFs Using Wavefronts Measured On Orbit</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_1028.html">MIRI PSF Photometry With Space_Phot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_1028_photutils.html">MIRI PSF Photometry with Photutils</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_photutils.html">MIRI PSF Photometry with Photutils</a></li>





<li class="toctree-l1"><a class="reference internal" href="../../MIRI/psf_photometry/miri_spacephot.html">MIRI PSF Photometry With Space_Phot</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_claw_detection/nircam_claw_detection.html">NIRCam Claw Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_WFSS_Box_extraction/BoxExtraction_using_Grismconf_CRDS.html">WFSS Box Extraction Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_WFSS_simulating_spectra/Simulating_WFSS_spectra_CRDS.html">WFSS Spectra Simulation for Contamination Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry_basics/psf_photometry_basics.html">PSF Photometry Basics with Photutils</a></li>









<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry_with_space_phot/nircam_spacephot.html">NIRCam PSF Photometry With Space_Phot</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/extra_niriss_individual_steps.html">Running Individual Pipline Steps</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../mos_master_background/Master_Background_MOS_Demo.html">Master Background Subtraction for Multi-Object Spectroscopy (MOS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../msa_metafile/NIRSpec_MOS_MSA_metafile.html">NIRSpec MOS MSA Metafile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_slits_to_sky/NIRSpec_MOS_slits_to_sky.html">NIRSpec MOS Slits to Sky</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cleaning Residual 1/f Noise in NIRSpec MOS Products with NSClean</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-goal">Notebook Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">1. Introduction <a name="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-library">2. Import Library <a name="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">3. Download the Data <a name="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-spec2pipeline-without-nsclean-original-data">4. Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data) <a name="nsclean_skipped"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-default-pipeline-mask">5. Clean up 1/f Noise with NSClean (Default Pipeline Mask) <a name="nsclean_default"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-default-pipeline-mask">5.1 Verify the Mask (Default Pipeline Mask) <a name="verify_default_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-default-pipeline-mask">5.2 Comparing Original vs. Cleaned Data (Default Pipeline Mask) <a name="nsclean_default_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-alternate-mask">6. Clean up 1/f Noise with NSClean (Alternate Mask) <a name="nsclean_alternate"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-alternate-mask">6.1 Verify the Mask (Alternate Mask) <a name="verify_alternate_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-alternate-mask">6.2 Comparing Original vs. Cleaned Data (Alternate Mask) <a name="nsclean_alternate_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-hand-modified-mask">7. Clean up 1/f Noise with NSClean (Hand-Modified Mask) <a name="nsclean_modified"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-hand-modified-mask">7.1 Verify the Mask (Hand-Modified Mask) <a name="verify_modified_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-hand-modified-mask">7.2 Comparing Original vs. Cleaned Data (Hand-Modified Mask) <a name="nsclean_modified_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">8. Conclusion <a name="conclusion"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-the-notebook">About the Notebook <a name="about"></a></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a name="top"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="cleaning-residual-1-f-noise-in-nirspec-mos-products-with-nsclean">
<h1>Cleaning Residual 1/f Noise in NIRSpec MOS Products with NSClean<a class="headerlink" href="#cleaning-residual-1-f-noise-in-nirspec-mos-products-with-nsclean" title="Link to this heading">#</a></h1>
<hr style="border:1px solid black">
<section id="notebook-goal">
<h2>Notebook Goal<a class="headerlink" href="#notebook-goal" title="Link to this heading">#</a></h2>
<p>The goal of this notebook is to generate cleaned MOS (<em>_rate.fits</em>) files by removing residual 1/f noise. These cleaned files will be used as input for the level 3 (<code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code>) pipeline.</p>
</section>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">#</a></h2>
<ul>
<li><ol class="arabic simple">
<li><p><a class="reference internal" href="#introduction"><span class="xref myst">Introduction</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p><a class="reference internal" href="#imports"><span class="xref myst">Import Library</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p><a class="reference internal" href="#data"><span class="xref myst">Download the Data</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="4">
<li><p><a class="reference internal" href="#nsclean_skipped"><span class="xref myst">Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data)</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="5">
<li><p><a class="reference internal" href="#nsclean_default"><span class="xref myst">Clean up 1/f Noise with NSClean (Default Pipeline Mask)</span></a></p></li>
</ol>
<ul class="simple">
<li><p>5.1 <a class="reference internal" href="#verify_default_mask"><span class="xref myst">Verify the Mask (Default Pipeline Mask)</span></a></p></li>
<li><p>5.2 <a class="reference internal" href="#nsclean_default_compare"><span class="xref myst">Comparing Original vs. Cleaned Data (Default Pipeline Mask)</span></a></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="6">
<li><p><a class="reference internal" href="#nsclean_alternate"><span class="xref myst">Clean up 1/f Noise with NSClean (Alternate Mask)</span></a></p></li>
</ol>
<ul class="simple">
<li><p>6.1 <a class="reference internal" href="#verify_alternate_mask"><span class="xref myst">Verify the Mask (Alternate Mask)</span></a></p></li>
<li><p>6.2 <a class="reference internal" href="#nsclean_alternate_compare"><span class="xref myst">Comparing Original vs. Cleaned Data (Alternate Mask)</span></a></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="7">
<li><p><a class="reference internal" href="#nsclean_modified"><span class="xref myst">Clean up 1/f Noise with NSClean (Hand-Modified Mask)</span></a></p></li>
</ol>
<ul class="simple">
<li><p>7.1 <a class="reference internal" href="#verify_modified_mask"><span class="xref myst">Verify the Mask (Hand-Modified Mask)</span></a></p></li>
<li><p>7.2 <a class="reference internal" href="#nsclean_modified_compare"><span class="xref myst">Comparing Original vs. Cleaned Data (Hand-Modified Mask)</span></a></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="8">
<li><p><a class="reference internal" href="#conclusion"><span class="xref myst">Conclusion</span></a></p></li>
</ol>
</li>
<li><p><a class="reference internal" href="#about"><span class="xref myst">About the Notebook</span></a></p></li>
</ul>
</section>
<section id="introduction">
<h2>1. Introduction <a name="introduction"></a><a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The JWST NIRSpec instrument has a number of features and characteristics that observers should be aware of when planning observations and interpreting data. One notable feature seen in NIRSpec pipeline products is negative and/or surplus flux in the extracted 1-D spectrum, typically with an irregular wavelength-dependent undulation. The cause of this artifact is correlated noise, known as <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-spectrograph/nirspec-instrument-features-and-caveats#NIRSpecInstrumentFeaturesandCaveats-1/fnoise">1/f noise</a>, from low-level detector thermal instabilities, seen as vertical banding in 2-D count rate images, particularly in exposures of the NRS2 detector. While the IRS2 readout mode reduces this effect, it is not completely eliminated.</p>
<p>To address this issue, the JWST Science Calibration Pipeline has integrated an external package developed by Bernard Rauscher, known as <a class="reference external" href="https://webb.nasa.gov/content/forScientists/publications.html#NSClean">NSClean</a>, within the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> under <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/main.html">NSCleanStep</a>. This algorithm uses dark areas of the detector to fit a background model to the data in Fourier space. It requires an input mask to identify all dark areas of the detector. The more thorough and complete this mask is, the better the background fit.</p>
<p>In this notebook, we will use the NSClean algorithm integrated into the pipeline, utilizing a mask generated on-the-fly with default parameters to remove 1/f noise. In some cases, this mask may not be complete enough/too restrictive for the best possible noise removal. To address this, we demonstrate how one can manually modify the default mask, as well as how to create an alternative mask by adjusting the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/arguments.html">NSCleanStep parameters</a>. If needed, see the <a class="reference external" href="https://iopscience.iop.org/article/10.1088/1538-3873/ad1b36/pdf">NSClean documentation</a> for some suggestions on manually creating a custom mask.</p>
<p>This notebook utilizes a MOS observation from the CEERS program with grating/filter G395M/F290LP, which is part of the <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/approved-programs/dd-ers/program-1345">JWST Early Release Science program ERS-1345</a> observation 61, as an example.</p>
</section>
<section id="import-library">
<h2>2. Import Library <a name="imports"></a><a class="headerlink" href="#import-library" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---------- Set CRDS environment variables ----------</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwst</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CONTEXT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;jwst_1210.pmap&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CRDS cache location: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;JWST Calibration Pipeline Version=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="c1"># print(&quot;Current Operational CRDS Context = {}&quot;.format(crds.get_default_context()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS cache location: /home/runner/crds_cache
JWST Calibration Pipeline Version=1.14.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------ General Imports ------</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="c1"># ------ JWST Calibration Pipeline Imports ------</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline.calwebb_spec2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spec2Pipeline</span>

<span class="c1"># ------ Plotting/Stats Imports ------</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_jwst_file</span><span class="p">,</span> <span class="n">plot_dark_data</span><span class="p">,</span> <span class="n">plot_cleaned_data</span><span class="p">,</span> <span class="n">plot_spectra</span>

<span class="c1"># Hide all log and warning messages.</span>
<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-data">
<h2>3. Download the Data <a name="data"></a><a class="headerlink" href="#download-the-data" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The input data for this notebook features a MOS observation from the CEERS program with grating/filter G395H/F290LP. The dataset is part of the <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/approved-programs/dd-ers/program-1345">JWST Early Release Science program ERS-1345</a>, specifically observation 61. It consists of 3 integrations (3 dither points; 3-SHUTTER-SLITLET) with 9 groups each. This notebook focuses on the third dithered exposure (00003) as an example. However, itâ€™s important to note that before proceeding to the <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code>, all exposures must first be processed through the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a downloads directory.</span>
<span class="n">mast_products_dir</span> <span class="o">=</span> <span class="s2">&quot;./mast_products/&quot;</span>
<span class="c1"># Check if the directory exists.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mast_products_dir</span><span class="p">):</span>
    <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mast_products_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This notebook focuses on the third dithered exposure.</span>
<span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;jw01345061001_07101_00003&quot;</span><span class="p">]</span>
<span class="n">detectors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Both Detectors NRS1 and NRS2.</span>

<span class="c1"># Specify countrate products</span>
<span class="n">rate_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="n">obs_ids</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>
        <span class="n">rate_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">_nrs</span><span class="si">{</span><span class="n">detector</span><span class="si">}</span><span class="s2">_rate.fits&quot;</span><span class="p">)</span>

<span class="c1"># Download all the FITS files and associated MSA files.</span>
<span class="n">msa_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rate_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">get_jwst_file</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">mast_api_token</span><span class="o">=</span><span class="s2">&quot;75f915f251544013bb127b7f6f6edc80&quot;</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="o">=</span><span class="n">mast_products_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Retrieve the MSA file from the header in the downloaded file.</span>
    <span class="n">msa_name</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;MSAMETFL&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">msa_name</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">msa_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">get_jwst_file</span><span class="p">(</span>
            <span class="n">msa_name</span><span class="p">,</span>
            <span class="n">mast_api_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="n">mast_products_dir</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">msa_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msa_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading jw01345061001_07101_00003_nrs1_rate.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading jw01345061001_01_msa.fits
Downloading jw01345061001_07101_00003_nrs2_rate.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading jw01345061001_01_msa.fits
The file jw01345061001_01_msa.fits already exists in the directory. Skipping download.
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-spec2pipeline-without-nsclean-original-data">
<h2>4. Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data) <a name="nsclean_skipped"></a><a class="headerlink" href="#running-spec2pipeline-without-nsclean-original-data" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The cell below executes the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>, explicitly skipping the NSClean step during processing. The level 2 products generated will serve as a reference point to illustrate how the countrate images and final extracted spectra appear without the removal of 1/f noise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running the pipeline without NSClean.</span>
<span class="n">stage2_nsclean_skipped_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_skipped/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">)</span>  <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Original data (no NSClean Applied).</span>
<span class="c1"># Estimated run-time: 1-2 minutes.</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rate_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">}},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01345061001_07101_00003_nrs1_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs1_cal.fits
Saved jw01345061001_07101_00003_nrs1_x1d.fits
Processing jw01345061001_07101_00003_nrs2_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs2_cal.fits
Saved jw01345061001_07101_00003_nrs2_x1d.fits
Run time:  2.2916666666666665  min
</pre></div>
</div>
</div>
</div>
</section>
<section id="clean-up-1-f-noise-with-nsclean-default-pipeline-mask">
<h2>5. Clean up 1/f Noise with NSClean (Default Pipeline Mask) <a name="nsclean_default"></a><a class="headerlink" href="#clean-up-1-f-noise-with-nsclean-default-pipeline-mask" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>If a user-supplied mask file is not provided to the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/index.html">NSClean step</a> in the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>, the pipeline will generate a mask based on default parameters. This mask will identify any pixel that is unilluminated. That is, the mask must contain True and False values, where True indicates that the pixel is dark, and False indicates that the pixel is illuminated (not dark).</p>
<p>By default, the pipeline marks the following detector areas as illuminated, non-dark areas (False):</p>
<ul class="simple">
<li><p>Pixels designated as open slits for this MOS observation.</p></li>
<li><p>Traces from failed-open MSA shutters.</p></li>
<li><p>5-sigma outliers (default value).</p></li>
<li><p>Any pixel set to NaN in the rate data.</p></li>
</ul>
<p>To tune the outlier detection in the mask, try modifying the <code class="docutils literal notranslate"><span class="pre">n_sigma</span></code> parameter (explored in the next section). A higher value will identify fewer outliers. A lower value will identify more.</p>
<p>The default generated mask is saved and analyzed below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running NSClean with default parameters.</span>
<span class="n">stage2_nsclean_default_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_default/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_default_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_default_dir</span><span class="p">)</span>  <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f noise cleaned data (default NSClean pipeline mask).</span>
<span class="c1"># Estimated run time: 6 minutes.</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rate_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_default_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01345061001_07101_00003_nrs1_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs1_mask.fits
Saved jw01345061001_07101_00003_nrs1_nsclean.fits
Saved jw01345061001_07101_00003_nrs1_cal.fits
Saved jw01345061001_07101_00003_nrs1_x1d.fits
Processing jw01345061001_07101_00003_nrs2_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs2_mask.fits
Saved jw01345061001_07101_00003_nrs2_nsclean.fits
Saved jw01345061001_07101_00003_nrs2_cal.fits
Saved jw01345061001_07101_00003_nrs2_x1d.fits
Run time:  4.196666666666667  min
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
<b>Warning:</b> 
<p>In some situations, the NSClean step may fail to find a fit to the background noise. This failure may occur if the mask does not contain enough dark data (marked True). In particular, every column in the mask except for the first and last 4 columns must contain some pixels marked True. The background fitting procedure considers each column, one at a time, so it will crash if there is no data in a column to fit. If failure occurs, check that your mask in the image below has at least some True values in every column.</p>
</div>
<section id="verify-the-mask-default-pipeline-mask">
<h3>5.1 Verify the Mask (Default Pipeline Mask) <a name="verify_default_mask"></a><a class="headerlink" href="#verify-the-mask-default-pipeline-mask" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>Check the mask against the rate data to make sure it keeps only dark areas of the detector.</p>
<p>Note that there are still some remaining illuminated areas, primarily due to transient artifacts like cosmic rays and snowballs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the rate data with masked areas blocked.</span>

<span class="c1"># List of on-the-fly built masks from the pipeline.</span>
<span class="n">nsclean_default_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_mask.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_mask.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and mask file.</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">nsclean_default_masks</span><span class="p">):</span>
    <span class="n">plot_dark_data</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/eb4d48653946a90f689df79ed3ec5aa490ba257cdd499a0ab1ec288b2633231f.png" src="../../../_images/eb4d48653946a90f689df79ed3ec5aa490ba257cdd499a0ab1ec288b2633231f.png" />
<img alt="../../../_images/26187930ff0e63aff689118f1366fded962657e6f3bad63b1f6bc1e06b930039.png" src="../../../_images/26187930ff0e63aff689118f1366fded962657e6f3bad63b1f6bc1e06b930039.png" />
</div>
</div>
</section>
<section id="comparing-original-vs-cleaned-data-default-pipeline-mask">
<h3>5.2 Comparing Original vs. Cleaned Data (Default Pipeline Mask) <a name="nsclean_default_compare"></a><a class="headerlink" href="#comparing-original-vs-cleaned-data-default-pipeline-mask" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>We can now compare the cleaned data (with the default pipeline mask) to the original rate file and verify that the 1/f noise has been reduced.</p>
<p>In many cases, the cleaning process introduces new artifacts to the rate file. These should be carefully examined and weighed against the benefits of noise reduction. If transient artifacts, like snowballs, are interfering with the cleaning process, it may be beneficial to manually edit the mask to remove these areas from consideration in the background fit. To do so, try varying the outlier detection threshold or editing specific pixels in the mask array directly (explored in the next few sections). Otherwise, refer to the <a class="reference external" href="https://iopscience.iop.org/article/10.1088/1538-3873/ad1b36/pdf">NSClean documentation</a> for additional suggestions on manual editing.</p>
<p>Note that in the images below, there are scattered values with large relative differences from the original rate file (shown in the relative difference image below). These are artifacts of the cleaning process.</p>
<p>There are also broader low-level residual background effects (shown in the relative difference image on the right, below, with scattered outliers, identified with sigma clipping, hidden by masking). These include the background patterns we are trying to remove: the 1/f noise variations in the dispersion direction and the picture frame effect at the top and bottom of the frame (for full-frame data). However, there may also be low-level artifacts introduced by over-fitting the dark data in the cleaning process.</p>
<p>Check both residual images carefully to understand the impact of the cleaning process on your data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the original and cleaned data, as well as a residual map.</span>

<span class="n">cleaned_default_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_nsclean.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_nsclean.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and cleaned file.</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">cleaned_default_masks</span><span class="p">):</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/da41f0f68f72d28cf2c4e27e3571141f67af1bfb92e4fcef5ebe1a2139f741b2.png" src="../../../_images/da41f0f68f72d28cf2c4e27e3571141f67af1bfb92e4fcef5ebe1a2139f741b2.png" />
<img alt="../../../_images/7eb2766e376794400ca4ba99f80cc8354ce2a342c3812a279361ecf7d7119483.png" src="../../../_images/7eb2766e376794400ca4ba99f80cc8354ce2a342c3812a279361ecf7d7119483.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot heavily masked region around x=1000, y=600 NRS2</span>
<span class="c1"># Masking can introduce some high frequency noise in the cleaning process that</span>
<span class="c1"># appears as vertical striping over the spectral traces</span>

<span class="n">rate_file</span> <span class="o">=</span> <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># NRS2</span>
<span class="n">original_rate_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rate_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">651</span><span class="p">,</span> <span class="mi">800</span><span class="p">:</span><span class="mi">1401</span><span class="p">]</span>
<span class="n">cleaned_rate_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_default_masks</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">651</span><span class="p">,</span> <span class="mi">800</span><span class="p">:</span><span class="mi">1401</span><span class="p">]</span>

<span class="c1"># For plotting vizualization</span>
<span class="n">original_rate_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">original_rate_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cleaned_rate_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cleaned_rate_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">cleaned_rate_data</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">cleaned_rate_data</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Original vs. cleaned data (with default mask)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">original_rate_data</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">aspect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
        <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN/s&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">cleaned_rate_data</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">aspect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
        <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN/s&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Set titles, tick values, xlabel, and ylabel for subplots</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Original Rate Data (NRS2)&quot;</span><span class="p">,</span> <span class="s2">&quot;Cleaned Rate Data (NRS2)&quot;</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Pixel Column&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Pixel Row&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="mi">700</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1300</span><span class="p">,</span> <span class="mi">1400</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="mi">475</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">575</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/0125668b69e4cf85c09166c4abb1f815d9a437dbe1939b6129eece285b5186cd.png" src="../../../_images/0125668b69e4cf85c09166c4abb1f815d9a437dbe1939b6129eece285b5186cd.png" />
</div>
</div>
<p>Compare the extracted spectrum from the cleaned data to the spectrum extracted from the original rate file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1D extracted spectra.</span>
<span class="n">x1d_nsclean_skipped</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">x1d_nsclean_default</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Wavelength region of interest.</span>
<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_default</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/dd621afedf5a4e55bf20b117532f57c010a96075b7cdca023a7fbdbef27812b5.png" src="../../../_images/dd621afedf5a4e55bf20b117532f57c010a96075b7cdca023a7fbdbef27812b5.png" />
<img alt="../../../_images/080337d704691fecdd5c27525af6c55a7707b026e1684081875dd75f5f2b7cf7.png" src="../../../_images/080337d704691fecdd5c27525af6c55a7707b026e1684081875dd75f5f2b7cf7.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Notes:</b></p>
<ul class="simple">
<li><p>In slit 80 on NRS1 and in slit 11 on NRS2, the overall continuum level has been slightly altered by the cleaning process.</p></li>
<li><p>In slit 11 on NRS2, some of the negative flux in the original spectrum has been corrected. However, excessive masking in the default mask has introduced high-frequency noise, particularly affecting slit 11 between 4.5 - 5.0 um. This results in a noticeable dip in the spectrum extracted from the cleaned data compared to the original raw data (above).</p></li>
</ul>
</div>
</section>
</section>
<section id="clean-up-1-f-noise-with-nsclean-alternate-mask">
<h2>6. Clean up 1/f Noise with NSClean (Alternate Mask) <a name="nsclean_alternate"></a><a class="headerlink" href="#clean-up-1-f-noise-with-nsclean-alternate-mask" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>For this data set, note that some regions of the detector are heavily masked, due to overlapping slit regions.  For example, see the cleaned rate data for NRS2 above, around x=1000, y=600.</p>
<p>In this region, the cleaning process introduces some high frequency noise that appears as vertical striping over the spectral traces.  Slit 11 is extracted from this region, and shows a noticeable dip in the spectrum extracted from the cleaned data, compared to the original rate data (above).</p>
<p>Also note that for MOS data, there may be several illuminated regions of the detector that are not masked by the slitlet bounding boxes.  For the M gratings, zeroth-order spectra may appear on the detector, and are not easily located. For the long-pass filters, there is still some light past the red cutoff of the slitlet bounding box.</p>
<p>In this case, it may be beneficial to build the mask with an alternate algorithm.  Here, we do not use slitlet bounding boxes and instead iteratively mask any data more than 1 sigma above the background.  This leaves more dark data between the spectral traces and improves the background fit in the problematic area.</p>
<p>Note, however, that excessive cleaning may impact the continuum level for the spectra, if too much or too little illuminated data is included in the mask. Again, the generated mask and output spectra should be carefully examined to weigh the benefits of cleaning against the impact on the spectra.</p>
<p>To tune the illumination detection in this mask, try modifying the <code class="docutils literal notranslate"><span class="pre">n_sigma</span></code> parameter below. A higher value will identify less illumination. A lower value will identify more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running NSClean with alternate parameters.</span>
<span class="n">stage2_nsclean_alternate_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_alternate/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_alternate_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span>
        <span class="n">stage2_nsclean_alternate_dir</span>
    <span class="p">)</span>  <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f noise cleaned data (alternate NSClean pipeline mask).</span>
<span class="c1"># Estimated run time: 7 minutes.</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rate_names</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;n_sigma&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;mask_spectral_regions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_alternate_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01345061001_07101_00003_nrs1_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs1_mask.fits
Saved jw01345061001_07101_00003_nrs1_nsclean.fits
Saved jw01345061001_07101_00003_nrs1_cal.fits
Saved jw01345061001_07101_00003_nrs1_x1d.fits
Processing jw01345061001_07101_00003_nrs2_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs2_mask.fits
Saved jw01345061001_07101_00003_nrs2_nsclean.fits
Saved jw01345061001_07101_00003_nrs2_cal.fits
Saved jw01345061001_07101_00003_nrs2_x1d.fits
Run time:  2.8133333333333335  min
</pre></div>
</div>
</div>
</div>
<section id="verify-the-mask-alternate-mask">
<h3>6.1 Verify the Mask (Alternate Mask) <a name="verify_alternate_mask"></a><a class="headerlink" href="#verify-the-mask-alternate-mask" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>Check the mask against the rate data to make sure it keeps only dark areas of the detector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the rate data with masked areas blocked.</span>

<span class="c1"># List of on-the-fly built masks from the pipeline.</span>
<span class="n">nsclean_alternate_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_mask.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_mask.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and mask file.</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">nsclean_alternate_masks</span><span class="p">):</span>
    <span class="n">plot_dark_data</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/29f236d4e6b70705b8503b00967a682f29788e6127d4de625c2e9dce71bda268.png" src="../../../_images/29f236d4e6b70705b8503b00967a682f29788e6127d4de625c2e9dce71bda268.png" />
<img alt="../../../_images/afdf65d0b1382233e141c8ad85e59886ed359b95450803dc30c077df2eb5523e.png" src="../../../_images/afdf65d0b1382233e141c8ad85e59886ed359b95450803dc30c077df2eb5523e.png" />
</div>
</div>
</section>
<section id="comparing-original-vs-cleaned-data-alternate-mask">
<h3>6.2 Comparing Original vs. Cleaned Data (Alternate Mask) <a name="nsclean_alternate_compare"></a><a class="headerlink" href="#comparing-original-vs-cleaned-data-alternate-mask" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the original and cleaned data, as well as a residual map.</span>

<span class="n">cleaned_alternate_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_nsclean.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_nsclean.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and cleaned file.</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">cleaned_alternate_masks</span><span class="p">):</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/7ff305ac8656cfff234dc461d4c0e2a246c875f005018d3e2fe6b735f7310881.png" src="../../../_images/7ff305ac8656cfff234dc461d4c0e2a246c875f005018d3e2fe6b735f7310881.png" />
<img alt="../../../_images/89cc20d91015b6e0fb4e5200e14034f9414c3aa21b7392d13fe388093dfb1278.png" src="../../../_images/89cc20d91015b6e0fb4e5200e14034f9414c3aa21b7392d13fe388093dfb1278.png" />
</div>
</div>
<p>Compare the extracted spectrum from the cleaned data to the spectrum extracted from the original rate file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x1d_nsclean_alternate</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_alternate</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/f59237dfb2df84f6fc563e430824d3305b3399a129f1c1d142212fae00722740.png" src="../../../_images/f59237dfb2df84f6fc563e430824d3305b3399a129f1c1d142212fae00722740.png" />
<img alt="../../../_images/a35f4543f16d099dcca386001d1df2adb79de637bc56744809ea39f21fa7d066.png" src="../../../_images/a35f4543f16d099dcca386001d1df2adb79de637bc56744809ea39f21fa7d066.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Notes:</b></p>
<ul class="simple">
<li><p>In slit 80 on NRS1 and in slit 11 on NRS2, the overall continuum level has been slightly altered by the cleaning process (similar to the default masking).</p></li>
<li><p>In slit 11 on NRS2, some of the negative flux in the original spectrum has been corrected. The high-frequency noise introduced by the default masking, which affected slit 11 between 4.5 - 5.0 um (resulting in a negative dip in the spectrum), is improved with the alternate masking.</p></li>
</ul>
</div>
</section>
</section>
<section id="clean-up-1-f-noise-with-nsclean-hand-modified-mask">
<h2>7. Clean up 1/f Noise with NSClean (Hand-Modified Mask) <a name="nsclean_modified"></a><a class="headerlink" href="#clean-up-1-f-noise-with-nsclean-hand-modified-mask" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
In certain scenarios, manual generation of a mask may be required. Here, we present **one** approach to manually modify the mask (editing an overly masked region in NRS2 around x=1000, y=600 to include more background; excluding some large snowballs in NRS1), starting with the default mask output from the pipeline. It is worth noting that the mask modified using this method may not necessarily outperform the two previous options.
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running NSClean with user-supplied mask.</span>
<span class="n">stage2_nsclean_modified_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_modified/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">):</span>
    <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hand-modify certain mask regions.</span>
<span class="c1"># Specifically modifying the region in NRS2 around x=1000, y=600.</span>

<span class="c1"># Define the list to store paths of modified masks.</span>
<span class="n">nsclean_modified_masks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate through the list of original masks.</span>
<span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">nsclean_default_masks</span><span class="p">:</span>
    <span class="c1"># New mask file name.</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_modified.fits&quot;</span>

    <span class="c1"># Open the FITS file.</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="c1"># Extract the mask data from the science extension.</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy.</span>

        <span class="k">if</span> <span class="s2">&quot;nrs2&quot;</span> <span class="ow">in</span> <span class="n">mask</span><span class="p">:</span>
            <span class="c1"># Step 1: Set the default masked regions back to True.</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">651</span><span class="p">,</span> <span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Step 2: Re-define masked regions by hand.</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">575</span><span class="p">,</span> <span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Crowded region NRS2.</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">590</span><span class="p">:</span><span class="mi">615</span><span class="p">,</span> <span class="mi">150</span><span class="p">:</span><span class="mi">1720</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">622</span><span class="p">:</span><span class="mi">647</span><span class="p">,</span> <span class="mi">100</span><span class="p">:</span><span class="mi">1620</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">50</span><span class="p">:</span><span class="mi">130</span><span class="p">,</span> <span class="mi">780</span><span class="p">:</span><span class="mi">850</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Snowballs</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">110</span><span class="p">:</span><span class="mi">140</span><span class="p">,</span> <span class="mi">920</span><span class="p">:</span><span class="mi">945</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">820</span><span class="p">:</span><span class="mi">940</span><span class="p">,</span> <span class="mi">2000</span><span class="p">:</span><span class="mi">2040</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">1650</span><span class="p">:</span><span class="mi">1700</span><span class="p">,</span> <span class="mi">1900</span><span class="p">:</span><span class="mi">1960</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[</span><span class="mi">1800</span><span class="p">:</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">330</span><span class="p">:</span><span class="mi">410</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Update the data within the science extension.</span>
        <span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mask_data</span>
        <span class="c1"># Save the modified FITS file</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
        <span class="n">hdul_modified</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy.</span>
        <span class="n">hdul_modified</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nsclean_modified_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved modified mask as: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved modified mask as: ./stage2_nsclean_modified/jw01345061001_07101_00003_nrs1_mask_modified.fits
Saved modified mask as: ./stage2_nsclean_modified/jw01345061001_07101_00003_nrs2_mask_modified.fits
</pre></div>
</div>
</div>
</div>
<section id="verify-the-mask-hand-modified-mask">
<h3>7.1 Verify the Mask (Hand-Modified Mask) <a name="verify_modified_mask"></a><a class="headerlink" href="#verify-the-mask-hand-modified-mask" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>Check the mask against the rate data to make sure it keeps only dark areas of the detector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the rate data with masked areas blocked.</span>

<span class="c1"># List of modified masks for the pipeline.</span>
<span class="n">nsclean_modified_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_mask_modified.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_mask_modified.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and mask file.</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">nsclean_modified_masks</span><span class="p">):</span>
    <span class="n">plot_dark_data</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/b167d7cc72c8415ee5d4ba371337dea47c806eed46880d5f6818b8c57131c85f.png" src="../../../_images/b167d7cc72c8415ee5d4ba371337dea47c806eed46880d5f6818b8c57131c85f.png" />
<img alt="../../../_images/c6c1b8ab0eabd3f2914f755c8b06c24fb12f50492c93f61ea8ce128c445b87be.png" src="../../../_images/c6c1b8ab0eabd3f2914f755c8b06c24fb12f50492c93f61ea8ce128c445b87be.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<b>Note:</b> When modifying the default mask for NRS2, we selected a region to unmask and then re-masked differently. However, this process inadvertently led to the unmasking of some previously masked NaN values (white pixels seen in the dark data plot for NRS2). Therefore, caution should be exercised when modifying the mask. Additionally, even though we masked various snowballs, we may not observe a difference in the 1D extracted spectra depending on the slit we extract.
</div><hr style="border:1px solid black">
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f noise cleaned data (user-supplied mask).</span>
<span class="c1"># Estimated run time: 5 minutes.</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rate_names</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;user_mask&quot;</span><span class="p">:</span> <span class="n">nsclean_modified_masks</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01345061001_07101_00003_nrs1_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs1_mask.fits
Saved jw01345061001_07101_00003_nrs1_nsclean.fits
Saved jw01345061001_07101_00003_nrs1_cal.fits
Saved jw01345061001_07101_00003_nrs1_x1d.fits
Processing jw01345061001_07101_00003_nrs2_rate.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01345061001_07101_00003_nrs2_mask.fits
Saved jw01345061001_07101_00003_nrs2_nsclean.fits
Saved jw01345061001_07101_00003_nrs2_cal.fits
Saved jw01345061001_07101_00003_nrs2_x1d.fits
Run time:  2.191666666666667  min
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparing-original-vs-cleaned-data-hand-modified-mask">
<h3>7.2 Comparing Original vs. Cleaned Data (Hand-Modified Mask) <a name="nsclean_modified_compare"></a><a class="headerlink" href="#comparing-original-vs-cleaned-data-hand-modified-mask" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the original and cleaned data, as well as a residual map.</span>

<span class="n">cleaned_modified_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_nsclean.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_nsclean.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and cleaned file.</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">cleaned_modified_masks</span><span class="p">):</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/76c4ddf2aa84759b30c6f997fd69646fca729c3783166ad04afc765455598fa5.png" src="../../../_images/76c4ddf2aa84759b30c6f997fd69646fca729c3783166ad04afc765455598fa5.png" />
<img alt="../../../_images/6e531d9b836459e687f049b80d67831c7c7606dd8e256b74b82bbd4c86e6b95c.png" src="../../../_images/6e531d9b836459e687f049b80d67831c7c7606dd8e256b74b82bbd4c86e6b95c.png" />
</div>
</div>
<p>Compare the extracted spectrum from the cleaned data to the spectrum extracted from the original rate file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x1d_nsclean_modified</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Wavelength Region of interest.</span>
<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_modified</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/a46567147886aa54195ef9a5177e7d973e03cbfa81c006cd0d9c45020182baab.png" src="../../../_images/a46567147886aa54195ef9a5177e7d973e03cbfa81c006cd0d9c45020182baab.png" />
<img alt="../../../_images/2d914f7a7daf49cfe8bbda878de4504573a76e2a2b49f8c1e2b7655623d35226.png" src="../../../_images/2d914f7a7daf49cfe8bbda878de4504573a76e2a2b49f8c1e2b7655623d35226.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Notes:</b></p>
<ul class="simple">
<li><p>In slit 80 on NRS1, the overall continuum level has been slightly altered by the cleaning process (similar to the default masking and alternate masking).</p></li>
<li><p>In slit 11 on NRS2, the flux between 4-4.55 um has decreased due to the cleaning process with the hand-modified mask. Some of the negative flux in the original spectrum (at shorter and longer wavelengths) has been corrected.</p></li>
</ul>
</div></section>
</section>
<section id="conclusion">
<h2>8. Conclusion <a name="conclusion"></a><a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The final plots below show the countrate images and the resulting 1D extracted spectra side-by-side to compare the different cleaning methods: the original (no NSClean applied), the cleaned countrate image (with the default pipeline mask), the cleaned countrate image (with an alternate pipeline mask), and finally, the cleaned countrate image (with the hand-modified mask).</p>
<p>Please note that the results presented in this notebook may vary for different datasets (e.g., targets of different brightness, spatial extent, etc.). Users are encouraged to explore NSClean using different masking methods to determine the optimal results.</p>
<p>The output from the cleaning algorithm is now ready for further processing.  The (<em>_cal.fits</em>) files produced by the above <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> run may be used as input to the <code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code>, for generating final combined spectra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not cleaned vs. cleaned (default mask) vs. cleaned (alternate mask) rate data</span>
<span class="n">original_rate_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">rate_name</span> <span class="ow">in</span> <span class="n">rate_names</span>
<span class="p">]</span>
<span class="n">cleaned_rate_default_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_default_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">for</span> <span class="n">cleaned_default_mask</span> <span class="ow">in</span> <span class="n">cleaned_default_masks</span>
<span class="p">]</span>
<span class="n">cleaned_rate_alternate_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_alternate_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">for</span> <span class="n">cleaned_alternate_mask</span> <span class="ow">in</span> <span class="n">cleaned_alternate_masks</span>
<span class="p">]</span>
<span class="n">cleaned_rate_modified_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_modified_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">for</span> <span class="n">cleaned_modified_mask</span> <span class="ow">in</span> <span class="n">cleaned_modified_masks</span>
<span class="p">]</span>

<span class="c1"># For plotting visualization</span>
<span class="k">for</span> <span class="n">data_list</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="n">original_rate_data</span><span class="p">,</span>
    <span class="n">cleaned_rate_default_data</span><span class="p">,</span>
    <span class="n">cleaned_rate_alternate_data</span><span class="p">,</span>
    <span class="n">cleaned_rate_modified_data</span><span class="p">,</span>
<span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Original vs. cleaned data (with default mask)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Set y-axis titles and plot the data</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Original Rate Data&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cleaned Rate Data (Default Mask)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cleaned Rate Data (Alternate Mask)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cleaned Rate Data (Hand-Modified Mask)&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">original_rate_data</span><span class="p">,</span>
            <span class="n">cleaned_rate_default_data</span><span class="p">,</span>
            <span class="n">cleaned_rate_alternate_data</span><span class="p">,</span>
            <span class="n">cleaned_rate_modified_data</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">titles</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;NRS1&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;NRS2&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN/s&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Column&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pixel Row&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/c0a8162647e737cab15a78e77e299168947107a74980b7e45f786839e823c822.png" src="../../../_images/c0a8162647e737cab15a78e77e299168947107a74980b7e45f786839e823c822.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Final Comparison</span>
<span class="n">plot_spectra</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">x1d_nsclean_skipped</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">x1d_nsclean_default</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">x1d_nsclean_alternate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">x1d_nsclean_modified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="n">scale_percent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_spectra</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">x1d_nsclean_skipped</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">x1d_nsclean_default</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">x1d_nsclean_alternate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">x1d_nsclean_modified</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="n">scale_percent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/da8f65e528fed95688937d0b35c92fbc5e01b766ecd1806e1a2c5eaa99f1f99f.png" src="../../../_images/da8f65e528fed95688937d0b35c92fbc5e01b766ecd1806e1a2c5eaa99f1f99f.png" />
<img alt="../../../_images/b7790b330b5e9d3c0edb4f0932a89a76d83952a4e2e0d4225ba6a0919a3b6324.png" src="../../../_images/b7790b330b5e9d3c0edb4f0932a89a76d83952a4e2e0d4225ba6a0919a3b6324.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Final Notes:</b></p>
<ul class="simple">
<li><p>The high-frequency noise in NRS2 introduced by the default masking, which was affecting the 1D extracted spectrum for slit 11 around 4.55um, no longer appears when using the alternate mask (slight improvement with the hand-modified mask), significantly improving the spectrum for slit 11.</p></li>
<li><p>Negative flux in slit 11 (at shorter and longer wavelengths) has been corrected with either of the masks. However, the hand-modified mask appears to decrease the continuum level for the spectrum of slit 11 between 4-4.55um. In this case, the alternate masking (clip-based) algorithm is preferable to blocking the entire science region for each MSA shutter.</p></li>
</ul>
</div></section>
<section id="about-the-notebook">
<h2>About the Notebook <a name="about"></a><a class="headerlink" href="#about-the-notebook" title="Link to this heading">#</a></h2>
<p><strong>Authors:</strong> Melanie Clarke, Kayli Glidic; NIRSpec Instrument Team</p>
<p><strong>Updated On</strong>: Feburary 29, 2024.</p>
<hr style="border:0.5px solid black">
<p><a class="reference internal" href="#top"><span class="xref myst">Top of Page</span></a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSpec/NIRSpec_NSClean"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="IFU_NSClean_example.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Cleaning Residual 1/f Noise in NIRSpec IFU Products with NSClean</p>
      </div>
    </a>
    <a class="right-next"
       href="BOTS_NSClean_example.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Cleaning Residual 1/f Noise in NIRSpec BOTS Products with NSClean</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-goal">Notebook Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">1. Introduction <a name="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-library">2. Import Library <a name="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">3. Download the Data <a name="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-spec2pipeline-without-nsclean-original-data">4. Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data) <a name="nsclean_skipped"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-default-pipeline-mask">5. Clean up 1/f Noise with NSClean (Default Pipeline Mask) <a name="nsclean_default"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-default-pipeline-mask">5.1 Verify the Mask (Default Pipeline Mask) <a name="verify_default_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-default-pipeline-mask">5.2 Comparing Original vs. Cleaned Data (Default Pipeline Mask) <a name="nsclean_default_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-alternate-mask">6. Clean up 1/f Noise with NSClean (Alternate Mask) <a name="nsclean_alternate"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-alternate-mask">6.1 Verify the Mask (Alternate Mask) <a name="verify_alternate_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-alternate-mask">6.2 Comparing Original vs. Cleaned Data (Alternate Mask) <a name="nsclean_alternate_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-hand-modified-mask">7. Clean up 1/f Noise with NSClean (Hand-Modified Mask) <a name="nsclean_modified"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-hand-modified-mask">7.1 Verify the Mask (Hand-Modified Mask) <a name="verify_modified_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-hand-modified-mask">7.2 Comparing Original vs. Cleaned Data (Hand-Modified Mask) <a name="nsclean_modified_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">8. Conclusion <a name="conclusion"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-the-notebook">About the Notebook <a name="about"></a></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>