

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Cleaning Residual 1/f Noise in NIRSpec BOTS Products with NSClean &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="prev" title="Cleaning Residual 1/f Noise in NIRSpec MOS Products with NSClean" href="MOS_NSClean_example.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/niriss_imaging/niriss-imaging-tutorial.html">NIRISS Imaging Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cleaning Residual 1/f Noise in NIRSpec BOTS Products with NSClean</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-goal">Notebook Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-name-introduction-a">1. Introduction <a name="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-library-a-name-imports-a">2. Import Library <a name="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data-a-name-data-a">3. Download the Data <a name="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-spec2pipeline-without-nsclean-original-data-a-name-nsclean-skipped-a">4. Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data) <a name="nsclean_skipped"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-the-extract1d-reference-file-a-name-extract1d-mod-a">4.1 Modifying the EXTRACT1D Reference File <a name="extract1d_mod"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-default-pipeline-mask-a-name-nsclean-default-a">5. Clean up 1/f Noise with NSClean (Default Pipeline Mask) <a name="nsclean_default"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-default-pipeline-mask-a-name-verify-default-mask-a">5.1 Verify the Mask (Default Pipeline Mask) <a name="verify_default_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-default-pipeline-mask-a-name-nsclean-default-compare-a">5.2 Comparing Original vs. Cleaned Data (Default Pipeline Mask) <a name="nsclean_default_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-alternate-mask-a-name-nsclean-alternate-a">6. Clean up 1/f Noise with NSClean (Alternate Mask) <a name="nsclean_alternate"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-alternate-mask-a-name-verify-alternate-mask-a">6.1 Verify the Mask (Alternate Mask) <a name="verify_alternate_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-alternate-mask-a-name-nsclean-alternate-compare-a">6.2 Comparing Original vs. Cleaned Data (Alternate Mask) <a name="nsclean_alternate_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-hand-modified-mask-a-name-nsclean-modified-a">7. Clean up 1/f Noise with NSClean (Hand-Modified Mask) <a name="nsclean_modified"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-hand-modified-mask-a-name-verify-modified-mask-a">7.1 Verify the Mask (Hand-Modified Mask) <a name="verify_modified_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-hand-modified-mask-a-name-nsclean-modified-compare-a">7.2 Comparing Original vs. Cleaned Data (Hand-Modified Mask) <a name="nsclean_modified_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-a-name-conclusion-a">8. Conclusion <a name="conclusion"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-the-notebook-a-name-about-a">About the Notebook <a name="about"></a></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a id="top"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="cleaning-residual-1-f-noise-in-nirspec-bots-products-with-nsclean">
<h1>Cleaning Residual 1/f Noise in NIRSpec BOTS Products with NSClean<a class="headerlink" href="#cleaning-residual-1-f-noise-in-nirspec-bots-products-with-nsclean" title="Permalink to this heading">#</a></h1>
<hr style="border:1px solid black">
<section id="notebook-goal">
<h2>Notebook Goal<a class="headerlink" href="#notebook-goal" title="Permalink to this heading">#</a></h2>
<p>The goal of this notebook is to generate cleaned BOTS (<em>_rateint.fits</em>) files by removing residual 1/f noise. These cleaned files will be used as input for the 3 (<code class="docutils literal notranslate"><span class="pre">TSO3Pipeline</span></code>) pipeline.</p>
</section>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h2>
<ul>
<li><ol class="arabic simple">
<li><p><span class="xref myst">Introduction</span></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p><span class="xref myst">Import Library</span></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p><span class="xref myst">Download the Data</span></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="4">
<li><p><span class="xref myst">Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data)</span></p></li>
</ol>
<ul class="simple">
<li><p>4.1 <span class="xref myst">Modifying the EXTRACT1D Reference File</span></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="5">
<li><p><span class="xref myst">Clean up 1/f Noise with NSClean (Default Pipeline Mask)</span></p></li>
</ol>
<ul class="simple">
<li><p>5.1 <span class="xref myst">Verify the Mask (Default Pipeline Mask)</span></p></li>
<li><p>5.2 <span class="xref myst">Comparing Original vs. Cleaned Data (Default Pipeline Mask)</span></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="6">
<li><p><span class="xref myst">Clean up 1/f Noise with NSClean (Alternate Mask)</span></p></li>
</ol>
<ul class="simple">
<li><p>6.1 <span class="xref myst">Verify the Mask (Alternate Mask)</span></p></li>
<li><p>6.2 <span class="xref myst">Comparing Original vs. Cleaned Data (Alternate Mask)</span></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="7">
<li><p><span class="xref myst">Clean up 1/f Noise with NSClean (Hand-Modified Mask)</span></p></li>
</ol>
<ul class="simple">
<li><p>7.1 <span class="xref myst">Verify the Mask (Hand-Modified Mask)</span></p></li>
<li><p>7.2 <span class="xref myst">Comparing Original vs. Cleaned Data (Hand-Modified Mask)</span></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="8">
<li><p><span class="xref myst">Conclusion</span></p></li>
</ol>
</li>
<li><p><span class="xref myst">About the Notebook</span></p></li>
</ul>
</section>
<section id="introduction-a-name-introduction-a">
<h2>1. Introduction <a name="introduction"></a><a class="headerlink" href="#introduction-a-name-introduction-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The JWST NIRSpec instrument has a number of features and characteristics that observers should be aware of when planning observations and interpreting data. One notable feature seen in NIRSpec pipeline products is negative and/or surplus flux in the extracted 1-D spectrum, typically with an irregular wavelength-dependent undulation. The cause of this artifact is correlated noise, known as <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-spectrograph/nirspec-instrument-features-and-caveats#NIRSpecInstrumentFeaturesandCaveats-1/fnoise">1/f noise</a>, from low-level detector thermal instabilities, seen as vertical banding in 2-D count rate images, particularly in exposures of the NRS2 detector. While the IRS2 readout mode reduces this effect, it is not completely eliminated.</p>
<p>To address this issue, the JWST Science Calibration Pipeline has integrated an external package developed by Bernard Rauscher, known as <a class="reference external" href="https://webb.nasa.gov/content/forScientists/publications.html#NSClean">NSClean</a>, within the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> under <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/main.html">NSCleanStep</a>. This algorithm uses dark areas of the detector to fit a background model to the data in Fourier space. It requires an input mask to identify all dark areas of the detector. The more thorough and complete this mask is, the better the background fit.</p>
<p>In this notebook, we will use the NSClean algorithm integrated into the pipeline, utilizing a mask generated on-the-fly with default parameters to remove 1/f noise. In some cases, this mask may not be complete enough/too restrictive for the best possible noise removal. To address this, we demonstrate how one can manually modify the default mask, as well as how to create an alternative mask by adjusting the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/arguments.html">NSCleanStep parameters</a>. If needed, see the <a class="reference external" href="https://iopscience.iop.org/article/10.1088/1538-3873/ad1b36/pdf">NSClean documentation</a> for some suggestions on manually creating a custom mask.</p>
<p>This notebook utilizes transit data of WASP-39b observed in the BOTS G395H grism as part of the <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/approved-programs/dd-ers/program-1366">JWST Early Release Science program ERS-1366</a> observation 3, as an example.</p>
</section>
<section id="import-library-a-name-imports-a">
<h2>2. Import Library <a name="imports"></a><a class="headerlink" href="#import-library-a-name-imports-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---------- Set CRDS environment variables ----------</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">jwst</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CONTEXT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;jwst_1215.pmap&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/crds_cache&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CRDS cache location: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;JWST Calibration Pipeline Version=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="c1"># print(&quot;Current Operational CRDS Context = {}&quot;.format(crds.get_default_context()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS cache location: /home/runner/crds_cache
JWST Calibration Pipeline Version=1.14.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------ General Imports ------</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">tt</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># ------ JWST Calibration Pipeline Imports ------</span>
<span class="kn">from</span> <span class="nn">crds.client</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">stpipe</span> <span class="kn">import</span> <span class="n">crds_client</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline.calwebb_spec2</span> <span class="kn">import</span> <span class="n">Spec2Pipeline</span>

<span class="c1"># ------ Plotting/Stats Imports ------</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_jwst_file</span><span class="p">,</span> <span class="n">plot_dark_data</span><span class="p">,</span> <span class="n">plot_cleaned_data</span><span class="p">,</span> <span class="n">plot_spectra</span>

<span class="c1"># Hide all log and warning messages.</span>
<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-data-a-name-data-a">
<h2>3. Download the Data <a name="data"></a><a class="headerlink" href="#download-the-data-a-name-data-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The input data for this notebook features a transit of WASP-39b observed through the NIRSpec BOTS mode with the G395H grism. The dataset is part of the <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/approved-programs/dd-ers/program-1366">JWST Early Release Science program ERS-1366</a>, specifically observation 3. It consists of 456 integrations with 70 groups each, using the SUB2048 subarray (array size of 2048 by 32 pixels per integration, per group). The entire observation spans 10.56 hours and is divided into three segments. This notebook focuses on the second segment (seg002) as an example. However, itâ€™s important to note that before proceeding to the <code class="docutils literal notranslate"><span class="pre">TSO3Pipeline</span></code>, all segments must first be processed through the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>.</p>
<p>For a comprehensive overview of current and planned JWST Time-Series Observation (TSO) programs, particularly those involving transiting exoplanets with the NIRSpec BOTS mode, refer to <a class="reference external" href="https://www.stsci.edu/~nnikolov/TrExoLiSTS/JWST/trexolists.html">TrExoLiSTS</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a downloads directory.</span>
<span class="n">mast_products_dir</span> <span class="o">=</span> <span class="s2">&quot;./mast_products/&quot;</span>
<span class="c1"># Check if the directory exists.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mast_products_dir</span><span class="p">):</span>
    <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mast_products_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This notebook focuses on the second segment.</span>
<span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;jw01366003001_04101_00001-seg002&quot;</span><span class="p">]</span>
<span class="n">detectors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Both Detectors NRS1 and NRS2.</span>


<span class="c1"># Specify the countrate products.</span>
<span class="n">rateints_names</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="n">obs_ids</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>
        <span class="n">rateints_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">_nrs</span><span class="si">{</span><span class="n">detector</span><span class="si">}</span><span class="s2">_rateints.fits&quot;</span><span class="p">)</span>

<span class="c1"># Download all the FITS files.</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rateints_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">get_jwst_file</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">mast_api_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="o">=</span><span class="n">mast_products_dir</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading jw01366003001_04101_00001-seg002_nrs1_rateints.fits
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading jw01366003001_04101_00001-seg002_nrs2_rateints.fits
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-spec2pipeline-without-nsclean-original-data-a-name-nsclean-skipped-a">
<h2>4. Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data) <a name="nsclean_skipped"></a><a class="headerlink" href="#running-spec2pipeline-without-nsclean-original-data-a-name-nsclean-skipped-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The cell below executes the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>, explicitly skipping the NSClean step during processing. The level 2 products generated will serve as a reference point to illustrate how the countrate images and final extracted spectra appear without the removal of 1/f noise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running the pipeline without NSClean.</span>
<span class="n">stage2_nsclean_skipped_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_skipped/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">)</span>  <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
</pre></div>
</div>
</div>
</div>
<section id="modifying-the-extract1d-reference-file-a-name-extract1d-mod-a">
<h3>4.1 Modifying the EXTRACT1D Reference File <a name="extract1d_mod"></a><a class="headerlink" href="#modifying-the-extract1d-reference-file-a-name-extract1d-mod-a" title="Permalink to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>We adjust the default parameter reference file for the <code class="docutils literal notranslate"><span class="pre">extract_1d</span></code> step, specifically modifying the extraction width aperture. This modification is necessary because the pipeline currently does not resample the 2D spectra to rectify the spectra (remove the curvature). Consequently, we rely on a broad extraction aperture, especially for NRS2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXTRACT1D reference file for BOTS data NRS1.</span>
<span class="n">refs</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">dump_references</span><span class="p">(</span><span class="n">crds_client</span><span class="o">.</span><span class="n">get_context_used</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">),</span>
                           <span class="p">[</span><span class="s1">&#39;jwst_nirspec_extract1d_0006.json&#39;</span><span class="p">])</span>
<span class="n">extract_1d_ref</span> <span class="o">=</span> <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;jwst_nirspec_extract1d_0006.json&#39;</span><span class="p">]</span>

<span class="c1"># Open EXTRACT1D reference file in read-mode.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_file</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span>
        <span class="s2">&quot;extract_width&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">27</span>  <span class="c1"># Extraction aperture radius in pixels, can be modified.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;xstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod2_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod3_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod5_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>

    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span>
        <span class="s2">&quot;extract_width&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">27</span>  <span class="c1"># Extraction aperture radius in pixels, can be modified.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;xstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod2_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod3_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod5_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>

<span class="c1"># Write changes to a new file.</span>
<span class="n">newData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># Add the suffix &#39;_bots&#39; to distinguish the file from the default version.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs1_bots.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newData</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXTRACT1D reference file for BOTS data NRS2.</span>
<span class="n">refs</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">dump_references</span><span class="p">(</span><span class="n">crds_client</span><span class="o">.</span><span class="n">get_context_used</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">),</span>
                           <span class="p">[</span><span class="s1">&#39;jwst_nirspec_extract1d_0006.json&#39;</span><span class="p">])</span>
<span class="n">extract_1d_ref</span> <span class="o">=</span> <span class="n">refs</span><span class="p">[</span><span class="s1">&#39;jwst_nirspec_extract1d_0006.json&#39;</span><span class="p">]</span>

<span class="c1"># Open EXTRACT1D reference file in read-mode.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_file</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span>
        <span class="s2">&quot;extract_width&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">27</span>  <span class="c1"># Extraction aperture radius in pixels, can be modified.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod2_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod3_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod5_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>

    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span>
        <span class="s2">&quot;extract_width&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">27</span>  <span class="c1"># Extraction aperture radius in pixels, can be modified.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod2_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod3_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;apertures&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nod5_offset&quot;</span><span class="p">)</span>  <span class="c1"># Remove.</span>

<span class="c1"># Write changes to a new file.</span>
<span class="n">newData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># Add the suffix &#39;_bots&#39; to distinguish the file from the default version.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs2_bots.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newData</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid black">
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Original data (no NSClean Applied).</span>
<span class="c1"># Estimated run time: 10 minutes (may vary).</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rateints_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs1_bots.json&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs2_bots.json&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
            <span class="c1"># Assigns wavelength solution for spectroscopic data.</span>
            <span class="s2">&quot;assign_wcs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="c1"># Removes correlated read noise (1/f noise) from NIRSpec images.</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Obtains 2D cutouts.</span>
            <span class="s2">&quot;srctype&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Assigns source type: &#39;point&#39; or &#39;extended&#39;.</span>
            <span class="c1"># We opt to skip this step, because it can introduce spurious pixels</span>
            <span class="c1"># that can affect the light curve scatter.</span>
            <span class="s2">&quot;flat_field&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># We also skip this step, because BOTS exoplanet observations are relative.</span>
            <span class="s2">&quot;photom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># Estimates the flux values of pixels flagged as DO_NOT_USE in 2-D spectra.</span>
            <span class="s2">&quot;pixel_replace&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;n_adjacent_cols&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;fit_profile&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_1d&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;override_extract1d&quot;</span><span class="p">:</span> <span class="n">extract1dref</span><span class="p">,</span>
                <span class="s2">&quot;apply_apcorr&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;subtract_background&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1"># &#39;dispaxis&#39;: 1, &#39;xstart&#39;: 100, &#39;xstop&#39;: 150, &#39;extract_width&#39;: 10},</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;calints.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1dints.fits&quot;</span><span class="p">)</span>


<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01366003001_04101_00001-seg002_nrs1_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs1_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs1_x1dints.fits
Processing jw01366003001_04101_00001-seg002_nrs2_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs2_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs2_x1dints.fits
Run time:  4.013333333333334  min
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="clean-up-1-f-noise-with-nsclean-default-pipeline-mask-a-name-nsclean-default-a">
<h2>5. Clean up 1/f Noise with NSClean (Default Pipeline Mask) <a name="nsclean_default"></a><a class="headerlink" href="#clean-up-1-f-noise-with-nsclean-default-pipeline-mask-a-name-nsclean-default-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>If a user-supplied mask file is not provided to the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/index.html">NSClean step</a> in the <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>, the pipeline will generate a mask based on default parameters. This mask will identify any pixel that is unilluminated. That is, the mask must contain True and False values, where True indicates that the pixel is dark, and False indicates that the pixel is illuminated (not dark).</p>
<p>By default, the pipeline marks the following detector areas as illuminated, non-dark areas (False):</p>
<ul class="simple">
<li><p>Pixels designated as science areas for FS data.</p></li>
<li><p>5-sigma outliers (default value)</p></li>
<li><p>Any pixel set to NaN in the rate data.</p></li>
</ul>
<p>To tune the outlier detection in the mask, try modifying the <code class="docutils literal notranslate"><span class="pre">n_sigma</span></code> parameter (explored in the next section). A higher value will identify fewer outliers. A lower value will identify more.</p>
<p>The default generated mask is saved and analyzed below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running NSClean with default parameters.</span>
<span class="n">stage2_nsclean_default_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_default/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_default_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_default_dir</span><span class="p">)</span> <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f noise cleaned data (default NSClean pipeline mask).</span>
<span class="c1"># Estimated run time: 36 minutes (may vary).</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rateints_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs1_bots.json&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs2_bots.json&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
            <span class="c1"># Assigns wavelength solution for spectroscopic data.</span>
            <span class="s2">&quot;assign_wcs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># Removes correlated read noise (1/f noise) from NIRSpec images.</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Obtains 2D cutouts.</span>
            <span class="s2">&quot;srctype&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Assigns source type: &#39;point&#39; or &#39;extended&#39;.</span>
            <span class="c1"># We opt to skip this step, because it can introduce spurious pixels</span>
            <span class="c1"># that can affect the light curve scatter.</span>
            <span class="s2">&quot;flat_field&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># We also skip this step, because BOTS exoplanet observations are relative.</span>
            <span class="s2">&quot;photom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># Estimates the flux values of pixels flagged as DO_NOT_USE in 2-D spectra.</span>
            <span class="s2">&quot;pixel_replace&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;n_adjacent_cols&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;fit_profile&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_1d&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;override_extract1d&quot;</span><span class="p">:</span> <span class="n">extract1dref</span><span class="p">,</span>
                <span class="s2">&quot;apply_apcorr&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;subtract_background&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1"># &#39;dispaxis&#39;: 1, &#39;xstart&#39;: 100, &#39;xstop&#39;: 150, &#39;extract_width&#39;: 10},</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_default_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;assign_wcs.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;calints.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1dints.fits&quot;</span><span class="p">)</span>


<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01366003001_04101_00001-seg002_nrs1_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs1_assign_wcs.fits
Saved jw01366003001_04101_00001-seg002_nrs1_mask.fits
Saved jw01366003001_04101_00001-seg002_nrs1_nsclean.fits
Saved jw01366003001_04101_00001-seg002_nrs1_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs1_x1dints.fits
Processing jw01366003001_04101_00001-seg002_nrs2_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs2_assign_wcs.fits
Saved jw01366003001_04101_00001-seg002_nrs2_mask.fits
Saved jw01366003001_04101_00001-seg002_nrs2_nsclean.fits
Saved jw01366003001_04101_00001-seg002_nrs2_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs2_x1dints.fits
Run time:  22.90666666666667  min
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
<b>Warning:</b> 
<p>In some situations, the NSClean step may fail to find a fit to the background noise. This failure may occur if the mask does not contain enough dark data (marked True). In particular, every column in the mask except for the first and last 4 columns must contain some pixels marked True. The background fitting procedure considers each column, one at a time, so it will crash if there is no data in a column to fit. If failure occurs, check that your mask in the image below has at least some True values in every column.</p>
</div>
<section id="verify-the-mask-default-pipeline-mask-a-name-verify-default-mask-a">
<h3>5.1 Verify the Mask (Default Pipeline Mask) <a name="verify_default_mask"></a><a class="headerlink" href="#verify-the-mask-default-pipeline-mask-a-name-verify-default-mask-a" title="Permalink to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>Check the mask against the rate data to make sure it keeps only dark areas of the detector.</p>
<p>Note that there are still some remaining illuminated areas, primarily due to transient artifacts like cosmic rays and snowballs.</p>
<p>Also, for some data sets, there may be several illuminated regions of the detector that are not masked by the WCS bounding boxes.  In this data, note that the mask does not cover the bluest end of the spectral trace.  This region is illuminated, but is not calibrated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the rate data with masked areas blocked.</span>

<span class="c1"># List of on-the-fly built masks from the pipeline.</span>
<span class="n">nsclean_default_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_mask.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_mask.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and mask file.</span>
<span class="k">for</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">,</span> <span class="n">nsclean_default_masks</span><span class="p">):</span>
    <span class="n">plot_dark_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rateint_file</span><span class="p">,</span>
        <span class="n">mask_file</span><span class="p">,</span>
        <span class="n">slice_index</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/a90d4f67b6f23945dc041d9b0391258f676f6476d4d292df622d2c0da00c3e57.png" src="../../../_images/a90d4f67b6f23945dc041d9b0391258f676f6476d4d292df622d2c0da00c3e57.png" />
<img alt="../../../_images/53a066e0fb1608493708e40cb3611f3ec6449f49b976515496f78909f9a9d198.png" src="../../../_images/53a066e0fb1608493708e40cb3611f3ec6449f49b976515496f78909f9a9d198.png" />
</div>
</div>
<p>The default pipeline mask for NRS2 masks the entire countrate image.</p>
</section>
<section id="comparing-original-vs-cleaned-data-default-pipeline-mask-a-name-nsclean-default-compare-a">
<h3>5.2 Comparing Original vs. Cleaned Data (Default Pipeline Mask) <a name="nsclean_default_compare"></a><a class="headerlink" href="#comparing-original-vs-cleaned-data-default-pipeline-mask-a-name-nsclean-default-compare-a" title="Permalink to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>We can now compare the cleaned data (with the default pipeline mask) to the original rate file and verify that the 1/f noise has been reduced.</p>
<p>In many cases, the cleaning process introduces new artifacts to the rate file. These should be carefully examined and weighed against the benefits of noise reduction. If transient artifacts, like snowballs, are interfering with the cleaning process, it may be beneficial to manually edit the mask to remove these areas from consideration in the background fit. To do so, try varying the outlier detection threshold or editing specific pixels in the mask array directly (explored in the next few sections). Otherwise, refer to the <a class="reference external" href="https://iopscience.iop.org/article/10.1088/1538-3873/ad1b36/pdf">NSClean documentation</a> for additional suggestions on manual editing.</p>
<p>Note that in the images below, there are scattered values with large relative differences from the original rate file (shown in the relative difference image below). These are artifacts of the cleaning process.</p>
<p>There are also broader low-level residual background effects (shown in the relative difference image on the right, below, with scattered outliers, identified with sigma clipping, hidden by masking). These include the background patterns we are trying to remove: the 1/f noise variations in the dispersion direction and the picture frame effect at the top and bottom of the frame (for full-frame data). However, there may also be low-level artifacts introduced by over-fitting the dark data in the cleaning process.</p>
<p>Check both residual images carefully to understand the impact of the cleaning process on your data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the original and cleaned data, as well as a residual map.</span>

<span class="n">cleaned_default_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_nsclean.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_nsclean.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and cleaned file.</span>
<span class="k">for</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">,</span> <span class="n">cleaned_default_masks</span><span class="p">):</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">cleaned_file</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/25101636d4c6fa9777e678a664ad66135334e9bc869a25295296fb4361cc0292.png" src="../../../_images/25101636d4c6fa9777e678a664ad66135334e9bc869a25295296fb4361cc0292.png" />
<img alt="../../../_images/e1d28b9f651a6205a7b3efc952a2930c47908bc22424ed72b4a1a69851f3ada8.png" src="../../../_images/e1d28b9f651a6205a7b3efc952a2930c47908bc22424ed72b4a1a69851f3ada8.png" />
</div>
</div>
<p>The default pipeline mask for NRS2 masks the entire countrate image so there is no difference when NSClean is applied.</p>
<p>Compare the extracted spectrum from the cleaned data to the spectrum extracted from the original rate file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the entire spectra.</span>

<span class="c1"># 1D extracted spectra.</span>
<span class="n">x1d_nsclean_skipped</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_x1dints.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_x1dints.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">x1d_nsclean_default</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_x1dints.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_x1dints.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_default</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Wavelength/flux region of interest</span>
<span class="n">wavelength_range</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nrs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.45</span><span class="p">],</span> <span class="s2">&quot;nrs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.25</span><span class="p">,</span> <span class="mf">4.275</span><span class="p">]}</span>

<span class="n">flux_range</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nrs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">1300</span><span class="p">],</span> <span class="s2">&quot;nrs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">550</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_default</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">(</span>
        <span class="p">[</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span>
        <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">scale_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">wavelength_range</span><span class="o">=</span><span class="n">wavelength_range</span><span class="p">,</span>
        <span class="n">flux_range</span><span class="o">=</span><span class="n">flux_range</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/d16246ad115963b9528d67d0c3629817e426c670dce56ac52cbd19d31a7bb0ee.png" src="../../../_images/d16246ad115963b9528d67d0c3629817e426c670dce56ac52cbd19d31a7bb0ee.png" />
<img alt="../../../_images/f5f27467fa994e40bfe3254767d49660df99643bddbf902d8231177ee231cfcc.png" src="../../../_images/f5f27467fa994e40bfe3254767d49660df99643bddbf902d8231177ee231cfcc.png" />
<img alt="../../../_images/254d925f025473f785f5fa1db39088cae5d9eaaea108719d1042e055ea08e466.png" src="../../../_images/254d925f025473f785f5fa1db39088cae5d9eaaea108719d1042e055ea08e466.png" />
<img alt="../../../_images/b4d3cfe55c8f0934d9a6c46bcb71f3e808f1140ca86b8025ee580ca7d88f7a60.png" src="../../../_images/b4d3cfe55c8f0934d9a6c46bcb71f3e808f1140ca86b8025ee580ca7d88f7a60.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<b>Notes:</b> 
<ul class="simple">
<li><p>The bright spectrum in NRS1 shows little difference after cleaning.</p></li>
<li><p>The default mask generated on-the-fly by the pipeline in NRS2 masks the entire science region, potentially over-masking dark areas that could enhance the background fit. This results in no discernible differences between the original and cleaned data for NRS2. In the following section, we explore the process of generating an alternative mask with the pipeline to address this issue.</p></li>
</ul>
</div></section>
</section>
<section id="clean-up-1-f-noise-with-nsclean-alternate-mask-a-name-nsclean-alternate-a">
<h2>6. Clean up 1/f Noise with NSClean (Alternate Mask) <a name="nsclean_alternate"></a><a class="headerlink" href="#clean-up-1-f-noise-with-nsclean-alternate-mask-a-name-nsclean-alternate-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>For some data sets, masking the entire science region may excessively mask dark areas of the detector that could be used to improve the background fit.  Excessive masking can introduce some high frequency noise in the cleaning process that appears as vertical striping over the spectral traces.</p>
<p>Also, for some data sets, there may be several illuminated regions of the detector that are not masked by the WCS bounding boxes.  In the subarray data, note that the mask does not cover the bluest end of the spectral trace.  This region is illuminated, but is not calibrated.</p>
<p>In some cases, it may be beneficial to build the mask with an alternate algorithm.  Here, we do not use the bounding boxes and instead iteratively mask any data more than 0.1 sigma above the background.  For bright sources, this leaves more dark data near the spectral trace and may improve the background fit.</p>
<p>Note, however, that excessive cleaning may impact the continuum level for the spectrum, if too much or too little illuminated data is included in the mask. Again, the generated mask and output spectra should be carefully examined to weigh the benefits of cleaning against the impact on the spectra.</p>
<p>To tune the illumination detection in this mask, try modifying the <code class="docutils literal notranslate"><span class="pre">n_sigma</span></code> parameter below. A higher value will identify less illumination. A lower value will identify more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running NSClean with alternate parameters.</span>
<span class="n">stage2_nsclean_alternate_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_alternate/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_alternate_dir</span><span class="p">):</span>
    <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_alternate_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f noise cleaned data (alternate NSClean pipeline mask).</span>
<span class="c1"># Estimated run time: 66 minutes (may vary).</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs1_bots.json&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs2_bots.json&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
            <span class="c1"># Assigns wavelength solution for spectroscopic data.</span>
            <span class="s2">&quot;assign_wcs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># Removes correlated read noise (1/f noise) from NIRSpec images.</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;n_sigma&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s2">&quot;mask_spectral_regions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Obtains 2D cutouts.</span>
            <span class="s2">&quot;srctype&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Assigns source type: &#39;point&#39; or &#39;extended&#39;.</span>
            <span class="c1"># We opt to skip this step, because it can introduce spurious pixels</span>
            <span class="c1"># that can affect the light curve scatter.</span>
            <span class="s2">&quot;flat_field&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># We also skip this step, because BOTS exoplanet observations are relative.</span>
            <span class="s2">&quot;photom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># Estimates the flux values of pixels flagged as DO_NOT_USE in 2-D spectra.</span>
            <span class="s2">&quot;pixel_replace&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;n_adjacent_cols&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;fit_profile&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_1d&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;override_extract1d&quot;</span><span class="p">:</span> <span class="n">extract1dref</span><span class="p">,</span>
                <span class="s2">&quot;apply_apcorr&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;subtract_background&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1"># &#39;dispaxis&#39;: 1, &#39;xstart&#39;: 100, &#39;xstop&#39;: 150, &#39;extract_width&#39;: 10},</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_alternate_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;assign_wcs.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;calints.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1dints.fits&quot;</span><span class="p">)</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01366003001_04101_00001-seg002_nrs1_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs1_assign_wcs.fits
Saved jw01366003001_04101_00001-seg002_nrs1_mask.fits
Saved jw01366003001_04101_00001-seg002_nrs1_nsclean.fits
Saved jw01366003001_04101_00001-seg002_nrs1_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs1_x1dints.fits
Processing jw01366003001_04101_00001-seg002_nrs2_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs2_assign_wcs.fits
Saved jw01366003001_04101_00001-seg002_nrs2_mask.fits
Saved jw01366003001_04101_00001-seg002_nrs2_nsclean.fits
Saved jw01366003001_04101_00001-seg002_nrs2_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs2_x1dints.fits
Run time:  55.11333333333334  min
</pre></div>
</div>
</div>
</div>
<section id="verify-the-mask-alternate-mask-a-name-verify-alternate-mask-a">
<h3>6.1 Verify the Mask (Alternate Mask) <a name="verify_alternate_mask"></a><a class="headerlink" href="#verify-the-mask-alternate-mask-a-name-verify-alternate-mask-a" title="Permalink to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>Check the mask against the rate data to make sure it keeps only dark areas of the detector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the rate data with masked areas blocked.</span>

<span class="c1"># List of on-the-fly built masks from the pipeline.</span>
<span class="n">nsclean_alternate_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_mask.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_mask.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and mask file.</span>
<span class="k">for</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">,</span> <span class="n">nsclean_alternate_masks</span><span class="p">):</span>
    <span class="n">plot_dark_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/b894aac0ac6ba72a7533d96d1a1058ece8a26d1489ebb8914cef660cb141b0e5.png" src="../../../_images/b894aac0ac6ba72a7533d96d1a1058ece8a26d1489ebb8914cef660cb141b0e5.png" />
<img alt="../../../_images/033b299501136adb74dfb6d9586658394983370fc9503db61814ec2e6151a1cd.png" src="../../../_images/033b299501136adb74dfb6d9586658394983370fc9503db61814ec2e6151a1cd.png" />
</div>
</div>
</section>
<section id="comparing-original-vs-cleaned-data-alternate-mask-a-name-nsclean-alternate-compare-a">
<h3>6.2 Comparing Original vs. Cleaned Data (Alternate Mask) <a name="nsclean_alternate_compare"></a><a class="headerlink" href="#comparing-original-vs-cleaned-data-alternate-mask-a-name-nsclean-alternate-compare-a" title="Permalink to this heading">#</a></h3>
<hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the original and cleaned data, as well as a residual map.</span>

<span class="n">cleaned_alternate_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_nsclean.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_nsclean.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and cleaned file.</span>
<span class="k">for</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">,</span> <span class="n">cleaned_alternate_masks</span><span class="p">):</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">cleaned_file</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/338301bd49c1f1e0b48137612acdbe365e3f0f8d5c2bcfb26d7579ed87d9945e.png" src="../../../_images/338301bd49c1f1e0b48137612acdbe365e3f0f8d5c2bcfb26d7579ed87d9945e.png" />
<img alt="../../../_images/acafea40dcbfca925c69a425cd17fb6724bf8d4131a8b30ca56163be8225fb3a.png" src="../../../_images/acafea40dcbfca925c69a425cd17fb6724bf8d4131a8b30ca56163be8225fb3a.png" />
</div>
</div>
<p>Compare the extracted spectrum from the cleaned data to the spectrum extracted from the original rate file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1D extracted spectra</span>
<span class="n">x1d_nsclean_skipped</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_x1dints.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_x1dints.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">x1d_nsclean_alternate</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_x1dints.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_x1dints.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_alternate</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/59b9d579991b6365763f9abc1c65270c2fef0bcf8fb665b83cf9c25cf0fcc895.png" src="../../../_images/59b9d579991b6365763f9abc1c65270c2fef0bcf8fb665b83cf9c25cf0fcc895.png" />
<img alt="../../../_images/f66225be68666989ad690375f1a3f5dff314e2b7243ddc83c9bf9541e04bea18.png" src="../../../_images/f66225be68666989ad690375f1a3f5dff314e2b7243ddc83c9bf9541e04bea18.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Wavelength region of interest.</span>
<span class="n">wavelength_range</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nrs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.45</span><span class="p">],</span> <span class="s2">&quot;nrs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.25</span><span class="p">,</span> <span class="mf">4.275</span><span class="p">]}</span>
<span class="n">flux_range</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nrs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">1300</span><span class="p">],</span> <span class="s2">&quot;nrs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">550</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_alternate</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">(</span>
        <span class="p">[</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span>
        <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">scale_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">wavelength_range</span><span class="o">=</span><span class="n">wavelength_range</span><span class="p">,</span>
        <span class="n">flux_range</span><span class="o">=</span><span class="n">flux_range</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/98b7ed262bc4b9164905fb574810d47065c573f67add4e49f844c6c6149cc553.png" src="../../../_images/98b7ed262bc4b9164905fb574810d47065c573f67add4e49f844c6c6149cc553.png" />
<img alt="../../../_images/7ffb06b845eecfc8fc3b4c3f2bfcaec46070fd3e9d7cef2413dc2ee851076e69.png" src="../../../_images/7ffb06b845eecfc8fc3b4c3f2bfcaec46070fd3e9d7cef2413dc2ee851076e69.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<b>Note:</b> The bright spectrum in NRS1/NRS2 shows little difference after cleaning. However, according to the ratio, the spectrum in NRS1 indicates that the cleaned data may have a slightly higher flux, whereas in NRS2, the cleaned data exhibits a slightly lower flux compared to the original data.
</div></section>
</section>
<section id="clean-up-1-f-noise-with-nsclean-hand-modified-mask-a-name-nsclean-modified-a">
<h2>7. Clean up 1/f Noise with NSClean (Hand-Modified Mask) <a name="nsclean_modified"></a><a class="headerlink" href="#clean-up-1-f-noise-with-nsclean-hand-modified-mask-a-name-nsclean-modified-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>In certain scenarios, manual generation of a mask may be required. Here, we present <strong>one</strong> approach to manually modify the mask starting with the default mask output from the pipeline. It is worth noting that the mask modified using this method may not necessarily outperform the two previous options.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up directory for running NSClean with user-supplied mask.</span>
<span class="n">stage2_nsclean_modified_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_modified/&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">):</span>
    <span class="c1"># Create the directory if it doesn&#39;t exist.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hand-modify certain mask regions.</span>

<span class="c1"># Define the list to store paths of modified masks.</span>
<span class="n">nsclean_modified_masks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate through the list of original masks.</span>
<span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">nsclean_default_masks</span><span class="p">:</span>
    <span class="c1"># New mask file name.</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_modified.fits&quot;</span>

    <span class="c1"># Open the FITS file.</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="c1"># Extract the mask data from the science extension.</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy.</span>

        <span class="c1"># Step 1: Set the default masked regions back to True.</span>
        <span class="n">mask_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Step 2: Re-define masked regions by hand.</span>
        <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span> <span class="mi">400</span><span class="p">:</span><span class="mi">700</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span> <span class="mi">700</span><span class="p">:</span><span class="mi">800</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span> <span class="mi">800</span><span class="p">:</span><span class="mi">1000</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span> <span class="mi">1000</span><span class="p">:</span><span class="mi">1200</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">23</span><span class="p">,</span> <span class="mi">1200</span><span class="p">:</span><span class="mi">1400</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span> <span class="mi">1400</span><span class="p">:</span><span class="mi">1600</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span> <span class="mi">1600</span><span class="p">:</span><span class="mi">2043</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="p">:</span><span class="mi">290</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">18</span><span class="p">,</span> <span class="mi">290</span><span class="p">:</span><span class="mi">740</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span> <span class="mi">740</span><span class="p">:</span><span class="mi">1290</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span> <span class="mi">1290</span><span class="p">:</span><span class="mi">1840</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">mask_data</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">:,</span> <span class="mi">1840</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Update the data within the science extension.</span>
        <span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mask_data</span>
        <span class="c1"># Save the modified FITS file.</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
        <span class="n">hdul_modified</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy.</span>
        <span class="n">hdul_modified</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nsclean_modified_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved modified mask as: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved modified mask as: ./stage2_nsclean_modified/jw01366003001_04101_00001-seg002_nrs1_mask_modified.fits
Saved modified mask as: ./stage2_nsclean_modified/jw01366003001_04101_00001-seg002_nrs2_mask_modified.fits
</pre></div>
</div>
</div>
</div>
<section id="verify-the-mask-hand-modified-mask-a-name-verify-modified-mask-a">
<h3>7.1 Verify the Mask (Hand-Modified Mask) <a name="verify_modified_mask"></a><a class="headerlink" href="#verify-the-mask-hand-modified-mask-a-name-verify-modified-mask-a" title="Permalink to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>Check the mask against the rate data to make sure it keeps only dark areas of the detector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the rate data with masked areas blocked.</span>

<span class="c1"># List of modified masks for the pipeline.</span>
<span class="n">nsclean_modified_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span>
    <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_mask_modified.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_modified_dir</span>
    <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_mask_modified.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and mask file.</span>
<span class="k">for</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">,</span> <span class="n">nsclean_modified_masks</span><span class="p">):</span>
    <span class="n">plot_dark_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/bdf7ea8fa5256692495c059461122a5348a14370c524b1ecc5f6f28fea22ae51.png" src="../../../_images/bdf7ea8fa5256692495c059461122a5348a14370c524b1ecc5f6f28fea22ae51.png" />
<img alt="../../../_images/20552c498682f111c95e18fa14ca5e34711c53ca1ed9bc7fa48505459a556fc5.png" src="../../../_images/20552c498682f111c95e18fa14ca5e34711c53ca1ed9bc7fa48505459a556fc5.png" />
</div>
</div>
<hr style="border:1px solid black">
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f noise cleaned data (user-supplied mask).</span>
<span class="c1"># Estimated run time: 57 minutes (may vary).</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs1_bots.json&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extract1dref</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">extract_1d_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_nrs2_bots.json&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
            <span class="c1"># Assigns wavelength solution for spectroscopic data.</span>
            <span class="s2">&quot;assign_wcs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># Removes correlated read noise (1/f noise) from NIRSpec images.</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;user_mask&quot;</span><span class="p">:</span> <span class="n">nsclean_modified_masks</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Obtains 2D cutouts.</span>
            <span class="s2">&quot;srctype&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>  <span class="c1"># Assigns source type: &#39;point&#39; or &#39;extended&#39;.</span>
            <span class="c1"># We opt to skip this step, because it can introduce spurious pixels</span>
            <span class="c1"># that can affect the light curve scatter.</span>
            <span class="s2">&quot;flat_field&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># We also skip this step, because BOTS exoplanet observations are relative.</span>
            <span class="s2">&quot;photom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># Estimates the flux values of pixels flagged as DO_NOT_USE in 2-D spectra.</span>
            <span class="s2">&quot;pixel_replace&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;n_adjacent_cols&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;fit_profile&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_1d&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;override_extract1d&quot;</span><span class="p">:</span> <span class="n">extract1dref</span><span class="p">,</span>
                <span class="s2">&quot;apply_apcorr&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;subtract_background&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1"># &#39;dispaxis&#39;: 1, &#39;xstart&#39;: 100, &#39;xstop&#39;: 150, &#39;extract_width&#39;: 10},</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;assign_wcs.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;calints.fits&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1dints.fits&quot;</span><span class="p">)</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Processing jw01366003001_04101_00001-seg002_nrs1_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs1_assign_wcs.fits
Saved jw01366003001_04101_00001-seg002_nrs1_mask.fits
Saved jw01366003001_04101_00001-seg002_nrs1_nsclean.fits
Saved jw01366003001_04101_00001-seg002_nrs1_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs1_x1dints.fits
Processing jw01366003001_04101_00001-seg002_nrs2_rateints.fits...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved jw01366003001_04101_00001-seg002_nrs2_assign_wcs.fits
Saved jw01366003001_04101_00001-seg002_nrs2_mask.fits
Saved jw01366003001_04101_00001-seg002_nrs2_nsclean.fits
Saved jw01366003001_04101_00001-seg002_nrs2_calints.fits
Saved jw01366003001_04101_00001-seg002_nrs2_x1dints.fits
Run time:  46.69833333333334  min
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparing-original-vs-cleaned-data-hand-modified-mask-a-name-nsclean-modified-compare-a">
<h3>7.2 Comparing Original vs. Cleaned Data (Hand-Modified Mask) <a name="nsclean_modified_compare"></a><a class="headerlink" href="#comparing-original-vs-cleaned-data-hand-modified-mask-a-name-nsclean-modified-compare-a" title="Permalink to this heading">#</a></h3>
<hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the original and cleaned data, as well as a residual map.</span>

<span class="n">cleaned_modified_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_nsclean.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_nsclean.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Plot each associated set of rateint data and cleaned file</span>
<span class="k">for</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rateints_names</span><span class="p">,</span> <span class="n">cleaned_modified_masks</span><span class="p">):</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rateint_file</span><span class="p">,</span> <span class="n">cleaned_file</span><span class="p">,</span> <span class="n">slice_index</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/24496cc27c504daa3a5e112e00629720dcb326fa14abf9a0b3a7b8c5cc226dcd.png" src="../../../_images/24496cc27c504daa3a5e112e00629720dcb326fa14abf9a0b3a7b8c5cc226dcd.png" />
<img alt="../../../_images/35ba0c255e7fa63671bbc697ef33b3d2e7e9aa7c4d9312f3653ae0633f33c1c7.png" src="../../../_images/35ba0c255e7fa63671bbc697ef33b3d2e7e9aa7c4d9312f3653ae0633f33c1c7.png" />
</div>
</div>
<p>Compare the extracted spectrum from the cleaned data to the spectrum extracted from the original rate file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1D extracted spectra.</span>
<span class="n">x1d_nsclean_skipped</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_x1dints.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_x1dints.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">x1d_nsclean_modified</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs1_x1dints.fits&quot;</span><span class="p">,</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01366003001_04101_00001-seg002_nrs2_x1dints.fits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_modified</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/80aaa28e4a337fca5b04079e2c478763ec25a861a9077607de781274de5cc185.png" src="../../../_images/80aaa28e4a337fca5b04079e2c478763ec25a861a9077607de781274de5cc185.png" />
<img alt="../../../_images/f4caa18eeee780921a89e8f25f145d7e55784f3ab41bc275ef27db6253bdfb4b.png" src="../../../_images/f4caa18eeee780921a89e8f25f145d7e55784f3ab41bc275ef27db6253bdfb4b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Wavelength Region of interest.</span>
<span class="n">wavelength_range</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nrs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.45</span><span class="p">],</span> <span class="s2">&quot;nrs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.25</span><span class="p">,</span> <span class="mf">4.275</span><span class="p">]}</span>
<span class="n">flux_range</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nrs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">1300</span><span class="p">],</span> <span class="s2">&quot;nrs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">550</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_modified</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">(</span>
        <span class="p">[</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span>
        <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">scale_percent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">wavelength_range</span><span class="o">=</span><span class="n">wavelength_range</span><span class="p">,</span>
        <span class="n">flux_range</span><span class="o">=</span><span class="n">flux_range</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/edeefa82f4a286b6afc0698dee5e7b02d5620fb84ce10a74c54457aef5812a63.png" src="../../../_images/edeefa82f4a286b6afc0698dee5e7b02d5620fb84ce10a74c54457aef5812a63.png" />
<img alt="../../../_images/e806a62c9b9c572c789a8f166b700a6836b980722e840ce08144c4608d9e494a.png" src="../../../_images/e806a62c9b9c572c789a8f166b700a6836b980722e840ce08144c4608d9e494a.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<b>Note:</b> Once more, the bright spectrum in NRS1/NRS2 shows little difference after cleaning. However, according to the ratio, the spectrum in NRS1 indicates that the cleaned data may have a slightly higher flux, whereas in NRS2, the cleaned data exhibits a slightly lower flux compared to the original data.
</div></section>
</section>
<section id="conclusion-a-name-conclusion-a">
<h2>8. Conclusion <a name="conclusion"></a><a class="headerlink" href="#conclusion-a-name-conclusion-a" title="Permalink to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>The final plots below show the countrate images and the resulting 1D extracted spectra side-by-side to compare the different cleaning methods: the original (no NSClean applied), the cleaned countrate image (with the default pipeline mask), the cleaned countrate image (with an alternate pipeline mask), and finally, the cleaned countrate image (with the hand-modified mask).</p>
<p>Please note that the results presented in this notebook may vary for different datasets (e.g., targets of different brightness, spatial extent, etc.). Users are encouraged to explore NSClean using different masking methods to determine the optimal results.</p>
<p>The output from the cleaning algorithm is now ready for further processing.  The (<em>_calint.fits</em>) files produced by the above <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> run may be used as input to the <code class="docutils literal notranslate"><span class="pre">TSO3Pipeline</span></code>, for generating final combined spectra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not cleaned vs. cleaned (default mask) vs. cleaned (alternate mask) rate data</span>
<span class="n">original_rate_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">rate_name</span> <span class="ow">in</span> <span class="n">rateints_names</span>
<span class="p">]</span>
<span class="n">cleaned_rate_default_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_default_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">cleaned_default_mask</span> <span class="ow">in</span> <span class="n">cleaned_default_masks</span>
<span class="p">]</span>
<span class="n">cleaned_rate_alternate_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_alternate_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">cleaned_alternate_mask</span> <span class="ow">in</span> <span class="n">cleaned_alternate_masks</span>
<span class="p">]</span>
<span class="n">cleaned_rate_modified_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_modified_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">cleaned_modified_mask</span> <span class="ow">in</span> <span class="n">cleaned_modified_masks</span>
<span class="p">]</span>

<span class="c1"># For plotting visualization</span>
<span class="k">for</span> <span class="n">data_list</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="n">original_rate_data</span><span class="p">,</span>
    <span class="n">cleaned_rate_default_data</span><span class="p">,</span>
    <span class="n">cleaned_rate_alternate_data</span><span class="p">,</span>
    <span class="n">cleaned_rate_modified_data</span><span class="p">,</span>
<span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Original vs. cleaned data (with default mask)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Set y-axis titles and plot the data</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Original Rate Data&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cleaned Rate Data (Default Mask)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cleaned Rate Data (Alternate Mask)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cleaned Rate Data (Hand-Modified Mask)&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">original_rate_data</span><span class="p">,</span>
            <span class="n">cleaned_rate_default_data</span><span class="p">,</span>
            <span class="n">cleaned_rate_alternate_data</span><span class="p">,</span>
            <span class="n">cleaned_rate_modified_data</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">titles</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Integration[100,:,:] | NRS1&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Integration[100,:,:] | NRS2&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-1</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN/s&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Column&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pixel Row&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/d8962446f01764c7887d7ecdcc7486f76dcb80eff7881d1addaccee08332a7a9.png" src="../../../_images/d8962446f01764c7887d7ecdcc7486f76dcb80eff7881d1addaccee08332a7a9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Final Comparison</span>
<span class="n">plot_spectra</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">x1d_nsclean_skipped</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">x1d_nsclean_default</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">x1d_nsclean_alternate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">x1d_nsclean_modified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">wavelength_range</span><span class="o">=</span><span class="n">wavelength_range</span><span class="p">,</span>
    <span class="n">flux_range</span><span class="o">=</span><span class="n">flux_range</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plot_spectra</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">x1d_nsclean_skipped</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">x1d_nsclean_default</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">x1d_nsclean_alternate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">x1d_nsclean_modified</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="n">ext_num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">wavelength_range</span><span class="o">=</span><span class="n">wavelength_range</span><span class="p">,</span>
    <span class="n">flux_range</span><span class="o">=</span><span class="n">flux_range</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/356e8a3caa9e415571570968319db449a4e3040caa7deb644269b0078e87d6ce.png" src="../../../_images/356e8a3caa9e415571570968319db449a4e3040caa7deb644269b0078e87d6ce.png" />
<img alt="../../../_images/fe4225374d73a1ff65db5fc91799b0522c1bf00ddc838d28334ed12773598b37.png" src="../../../_images/fe4225374d73a1ff65db5fc91799b0522c1bf00ddc838d28334ed12773598b37.png" />
</div>
</div>
<div class="alert alert-block alert-info">
<b>Final Note:</b> Both the alternate (clip-based) and hand-modified masks produced similar results. However, the hand-modified mask appears to introduce less high-frequency noise.
</div></section>
<section id="about-the-notebook-a-name-about-a">
<h2>About the Notebook <a name="about"></a><a class="headerlink" href="#about-the-notebook-a-name-about-a" title="Permalink to this heading">#</a></h2>
<p><strong>Authors:</strong> Melanie Clarke, Kayli Glidic; NIRSpec Instrument Team</p>
<p><strong>Updated On</strong>: Feburary 29, 2024.</p>
<hr style="border:0.5px solid black">
<p><span class="xref myst">Top of Page</span></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSpec/NIRSpec_NSClean"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="MOS_NSClean_example.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Cleaning Residual 1/f Noise in NIRSpec MOS Products with NSClean</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-goal">Notebook Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-name-introduction-a">1. Introduction <a name="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-library-a-name-imports-a">2. Import Library <a name="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data-a-name-data-a">3. Download the Data <a name="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-spec2pipeline-without-nsclean-original-data-a-name-nsclean-skipped-a">4. Running <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> without NSClean (Original Data) <a name="nsclean_skipped"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-the-extract1d-reference-file-a-name-extract1d-mod-a">4.1 Modifying the EXTRACT1D Reference File <a name="extract1d_mod"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-default-pipeline-mask-a-name-nsclean-default-a">5. Clean up 1/f Noise with NSClean (Default Pipeline Mask) <a name="nsclean_default"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-default-pipeline-mask-a-name-verify-default-mask-a">5.1 Verify the Mask (Default Pipeline Mask) <a name="verify_default_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-default-pipeline-mask-a-name-nsclean-default-compare-a">5.2 Comparing Original vs. Cleaned Data (Default Pipeline Mask) <a name="nsclean_default_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-alternate-mask-a-name-nsclean-alternate-a">6. Clean up 1/f Noise with NSClean (Alternate Mask) <a name="nsclean_alternate"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-alternate-mask-a-name-verify-alternate-mask-a">6.1 Verify the Mask (Alternate Mask) <a name="verify_alternate_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-alternate-mask-a-name-nsclean-alternate-compare-a">6.2 Comparing Original vs. Cleaned Data (Alternate Mask) <a name="nsclean_alternate_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-up-1-f-noise-with-nsclean-hand-modified-mask-a-name-nsclean-modified-a">7. Clean up 1/f Noise with NSClean (Hand-Modified Mask) <a name="nsclean_modified"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-the-mask-hand-modified-mask-a-name-verify-modified-mask-a">7.1 Verify the Mask (Hand-Modified Mask) <a name="verify_modified_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-vs-cleaned-data-hand-modified-mask-a-name-nsclean-modified-compare-a">7.2 Comparing Original vs. Cleaned Data (Hand-Modified Mask) <a name="nsclean_modified_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-a-name-conclusion-a">8. Conclusion <a name="conclusion"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-the-notebook-a-name-about-a">About the Notebook <a name="about"></a></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>