

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>NIRCam Preimaging: MIRAGE Simulations &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/preimaging/preimaging_01_mirage';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross_instrument/stpsf_examples/stpsf_examples.html">JWST Using Wavefronts Measured On Orbit</a></li>




</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/preimaging/preimaging_01_mirage.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/preimaging/preimaging_01_mirage.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>NIRCam Preimaging: MIRAGE Simulations</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">NIRCam Preimaging: MIRAGE Simulations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mirage-tutorials">MIRAGE Tutorials</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-things-up">Setting things up</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-reference-files-this-will-take-a-long-time-you-will-need-around-100-gb-of-space">Download reference files. This will take a long time. You will need around ~100 GB of space.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">Download Data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-input-yaml-files">Generating input yaml files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-yaml-generator">Running the yaml_generator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organizing-files-according-to-filter">Organizing files according to filter</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#execute-mirage-and-create-simulated-data">Execute MIRAGE and create simulated data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#this-step-will-take-a-long-time-to-run-to-decrease-the-run-time-we-will-only-process-exposure-0004-you-can-change-the-filter-to-process-all-files-if-desired">This step will take a long time to run. To decrease the run-time, we will only process Exposure 0004. You can change the filter to process all files if desired.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-the-output">Examine the output</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seed-image">Seed image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-file-example">Linear file example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-uncalibrated-file-example">Raw uncalibrated file example</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="nircam-preimaging-mirage-simulations">
<h1>NIRCam Preimaging: MIRAGE Simulations<a class="headerlink" href="#nircam-preimaging-mirage-simulations" title="Permalink to this heading">#</a></h1>
<p><strong>Use case:</strong> Simulation of NIRCam pre-imaging for NIRSpec.<br>
<strong>Data:</strong> JWST simulated NIRCam data from MIRAGE; LMC.<br>
<strong>Tools:</strong>  mirage, jwst, astropy, grismconf, nircam_gsim.<br>
<strong>Cross-intrument:</strong> NIRCam. <br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This notebook shows step-by-step instructions to simulate images of the JWST LMC astrometric calibration field. The NIRCam images are simulated using the software <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">MIRAGE</a>. The observation is designed in APT. The APT output is used as input of MIRAGE.</p>
<p>This Notebook must be executed from an environment that has MIRAGE installed. Follow the instructions in the <a class="reference external" href="https://mirage-data-simulator.readthedocs.io/en/latest/install.html">Installing MIRAGE webpage</a> before executing this Jupyter Notebook.</p>
<section id="mirage-tutorials">
<h3>MIRAGE Tutorials<a class="headerlink" href="#mirage-tutorials" title="Permalink to this heading">#</a></h3>
<p>This notebook provides an example of running MIRAGE in a specific science use case. For a broader tutorial on running MIRAGE, it is suggested you review the <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/jwebbinars">Jwebbinar Number 10</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYSYN_CDBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./grp/redcat/trds/&quot;</span>
<span class="n">synphot_folder</span> <span class="o">=</span> <span class="s1">&#39;./grp&#39;</span>

<span class="n">synExist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">synExist</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">)</span>
    
<span class="c1"># mirage imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mirage.imaging_simulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImgSim</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mirage.seed_image</span><span class="w"> </span><span class="kn">import</span> <span class="n">catalog_seed_image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mirage.dark</span><span class="w"> </span><span class="kn">import</span> <span class="n">dark_prep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mirage.ramp_generator</span><span class="w"> </span><span class="kn">import</span> <span class="n">obs_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mirage.yaml</span><span class="w"> </span><span class="kn">import</span> <span class="n">yaml_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mirage.reference_files</span><span class="w"> </span><span class="kn">import</span> <span class="n">downloader</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="setting-things-up">
<h2>Setting things up<a class="headerlink" href="#setting-things-up" title="Permalink to this heading">#</a></h2>
<p>After activating the environment with MIRAGE and beginning a Jupyter Notebook session, we begin by defining the working directory</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span>  <span class="c1"># write here your working directory</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pwd</span>
</pre></div>
</div>
</div>
</div>
<p><em>Developer Note:</em>
Find out a way to install the mirage data for the testing CI. Right now the data size is too</p>
<p>Mirage is accompanied by a set of reference files that are used to construct the simulated data. Here we define the location of the MIRAGE data. This is the directory that contains the reference files associated with MIRAGE.
For users at STScI, this is the location of MIRAGE data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MIRAGE_DATA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./mirage_data/&#39;</span>
</pre></div>
</div>
</div>
</div>
<section id="download-reference-files-this-will-take-a-long-time-you-will-need-around-100-gb-of-space">
<h3>Download reference files. This will take a long time. You will need around ~100 GB of space.<a class="headerlink" href="#download-reference-files-this-will-take-a-long-time-you-will-need-around-100-gb-of-space" title="Permalink to this heading">#</a></h3>
<p>If the user is outside of STScI then the reference files must be downloaded using the “downloader” module. Please follow the instructions in https://mirage-data-simulator.readthedocs.io/en/latest/reference_files.html and create an appropriate MIRAGE_DATA location.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download_path</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">downloader</span><span class="o">.</span><span class="n">download_reffiles</span><span class="p">(</span><span class="n">download_path</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="s1">&#39;FGS&#39;</span><span class="p">,</span> <span class="n">dark_type</span><span class="o">=</span><span class="s1">&#39;linearized&#39;</span><span class="p">,</span> <span class="n">skip_darks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">single_dark</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_cosmic_rays</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_psfs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">downloader</span><span class="o">.</span><span class="n">download_reffiles</span><span class="p">(</span><span class="n">download_path</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="s1">&#39;NIRCam&#39;</span><span class="p">,</span> <span class="n">dark_type</span><span class="o">=</span><span class="s1">&#39;linearized&#39;</span><span class="p">,</span> <span class="n">skip_darks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">single_dark</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_cosmic_rays</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_psfs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="download-data">
<h1>Download Data<a class="headerlink" href="#download-data" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">boxlink</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/preimaging_notebooks/preimaging.zip&#39;</span>
<span class="n">boxfile</span> <span class="o">=</span> <span class="s1">&#39;./preimaging.zip&#39;</span>

<span class="c1"># Download zip file</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">boxfile</span><span class="p">):</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>
    
    <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="generating-input-yaml-files">
<h2>Generating input yaml files<a class="headerlink" href="#generating-input-yaml-files" title="Permalink to this heading">#</a></h2>
<p>We begin the simulation using the programme’s APT file. The xml and pointings files must be exported from APT, and are then used as input to the yaml_generator, which will generate a series of yaml input files.</p>
<p>From APT we export two files: the xml and pointing files. These should be in the working directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the xml and pointing files exported from APT</span>
<span class="n">xml_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;preimaging&#39;</span><span class="p">,</span> <span class="s1">&#39;NRC21_pid1069_2018_rev2.xml&#39;</span><span class="p">)</span>
<span class="n">pointing_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;preimaging&#39;</span><span class="p">,</span> <span class="s1">&#39;NRC21_pid1069_2018_rev2.pointing&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Additional optional data to be included.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optionally set the telescope roll angle (PAV3) for the observations</span>
<span class="n">pav3</span><span class="o">=</span><span class="mf">0.0</span>

<span class="c1"># Define the output directory</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="n">path</span>
</pre></div>
</div>
</div>
</div>
<p>In this example we create NIRCam images based on a catalogue (all_filters_lmc.cat) of point sources. This catalogue contains the AB magnitude of each source in the following six filters: F070W, F150W, F200W, F277W, F356W, and F444W.</p>
<p>The dictionary of catalogs must use the APT target names as keys, for example <code class="docutils literal notranslate"><span class="pre">LMC-ASTROMETRIC-FIELD</span></code>. Full details on yaml_generator input options are given here: https://mirage-data-simulator.readthedocs.io/en/latest/yaml_generator.html</p>
<p>This is what the input catalogue looks like. Space separated values with an uncommented header line.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># position_RA_Dec</span>
<span class="c1"># abmag</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="n">index</span> <span class="n">x_or_RA</span> <span class="n">y_or_Dec</span> <span class="n">nircam_f070w_magnitude</span> <span class="n">nircam_f150w_magnitude</span> <span class="n">nircam_f200w_magnitude</span> <span class="n">nircam_f277w_magnitude</span> <span class="n">nircam_f356w_magnitude</span> <span class="n">nircam_f444w_magnitude</span>
<span class="mi">1</span> <span class="mf">80.386396453731</span> <span class="o">-</span><span class="mf">69.468909240644</span> <span class="mf">21.63889</span> <span class="mf">21.59946</span> <span class="mf">21.93288</span> <span class="mf">22.51786</span> <span class="mf">22.99632</span> <span class="mf">23.4255</span>
<span class="mi">2</span> <span class="mf">80.385587687224</span> <span class="o">-</span><span class="mf">69.469200540277</span> <span class="mf">20.42033</span> <span class="mf">20.05396</span> <span class="mf">20.32926</span> <span class="mf">20.92191</span> <span class="mf">21.37946</span> <span class="mf">21.83321</span>
<span class="mi">3</span> <span class="mf">80.38036547567</span> <span class="o">-</span><span class="mf">69.470930464875</span> <span class="mf">21.8158</span> <span class="mf">21.86888</span> <span class="mf">22.2175</span> <span class="mf">22.8008</span> <span class="mf">23.28381</span> <span class="mf">23.7064</span>
<span class="mi">4</span> <span class="mf">80.388130492656</span> <span class="o">-</span><span class="mf">69.468453170293</span> <span class="mf">21.11582</span> <span class="mf">20.8028</span> <span class="mf">21.08802</span> <span class="mf">21.67932</span> <span class="mf">22.14077</span> <span class="mf">22.59048</span>
<span class="mi">5</span> <span class="mf">80.388935773363</span> <span class="o">-</span><span class="mf">69.468195831029</span> <span class="mf">21.76617</span> <span class="mf">21.80178</span> <span class="mf">22.14757</span> <span class="mf">22.73117</span> <span class="mf">23.21336</span> <span class="mf">23.63717</span>
</pre></div>
</div>
<p>For more information look at the following link</p>
<p>https://github.com/spacetelescope/mirage/blob/master/examples/Catalog_Generation_Tools.ipynb</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source catalogs to be used</span>
<span class="n">cat_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;LMC-ASTROMETRIC-FIELD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nircam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;point_source&#39;</span><span class="p">:</span> <span class="s1">&#39;preimaging/all_filters_lmc.cat&#39;</span><span class="p">}</span> <span class="p">,</span>
                                          <span class="s1">&#39;fgs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;point_source&#39;</span><span class="p">:</span> <span class="s1">&#39;dummy.cat&#39;</span><span class="p">}</span> <span class="p">}</span> <span class="p">,</span>
             <span class="s1">&#39;2 LMC-ASTROMETRIC-FIELD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nircam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;point_source&#39;</span><span class="p">:</span> <span class="s1">&#39;preimaging/all_filters_lmc.cat&#39;</span><span class="p">}</span> <span class="p">,</span>
                                          <span class="s1">&#39;fgs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;point_source&#39;</span><span class="p">:</span> <span class="s1">&#39;dummy.cat&#39;</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-the-yaml-generator">
<h2>Running the yaml_generator<a class="headerlink" href="#running-the-yaml-generator" title="Permalink to this heading">#</a></h2>
<p>This will create a collection of yaml files that will be used as input when creating the simulated data. There will be one yaml file for each detector and exposure, so there can be quite a few files created if your programme has lots of exposures or dithers. This LMC  programme will generate 528 files using six NIRCam filters and the JWST FGS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the yaml generator</span>

<span class="n">yam</span> <span class="o">=</span> <span class="n">yaml_generator</span><span class="o">.</span><span class="n">SimInput</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span> <span class="n">pointing_file</span><span class="p">,</span> 
                              <span class="n">catalogs</span><span class="o">=</span><span class="n">cat_dict</span><span class="p">,</span> 
                              <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">simdata_output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                              <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                              <span class="n">roll_angle</span><span class="o">=</span><span class="n">pav3</span><span class="p">,</span> 
                              <span class="c1"># to do : explain linear vs raw</span>
                              <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;linear,raw&#39;</span><span class="p">)</span> 

<span class="n">yam</span><span class="o">.</span><span class="n">use_linearized_darks</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">yam</span><span class="o">.</span><span class="n">create_inputs</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="organizing-files-according-to-filter">
<h2>Organizing files according to filter<a class="headerlink" href="#organizing-files-according-to-filter" title="Permalink to this heading">#</a></h2>
<p>These notebooks will generate a large amount of data and it is useful to keep it organized in sub directories.</p>
<p>yaml: all the yaml files organized according to filter
mirage_output: linear and uncal files
pipeline_level1: rate files
pipeline_level2: cal files</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;jw*yaml&#39;</span><span class="p">)</span>
<span class="n">allfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;jw*&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;mirage_output&#39;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;mirage_output&#39;</span><span class="p">))</span>
             
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;pipeline_level1&#39;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;pipeline_level1&#39;</span><span class="p">))</span>
             
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;pipeline_level2&#39;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;pipeline_level2&#39;</span><span class="p">))</span>
             
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;yaml&#39;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;yaml&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here we store the yaml files in the yaml directory organized according to filter. The cell below will fail if the files have already been relocated before. If you want to intentionally re-do this step, please manually remove the previous files from the output directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we organize files according to filter</span>
<span class="k">for</span> <span class="n">yamlfile</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span> <span class="c1">#open the yaml file in read mode</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        
        <span class="n">filtname</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="c1">#read the filter keyword</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;yaml&#39;</span><span class="p">,</span><span class="n">filtname</span><span class="o">.</span><span class="n">lower</span><span class="p">())):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;yaml&#39;</span><span class="p">,</span><span class="n">filtname</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
    
    <span class="n">filetomove</span> <span class="o">=</span> <span class="n">yamlfile</span>  
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">filetomove</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;yaml&#39;</span><span class="p">,</span><span class="n">filtname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> 
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;input  = &#39;</span><span class="p">,</span><span class="n">input_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output = &#39;</span><span class="p">,</span><span class="n">output_file</span><span class="p">)</span>
    
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span> <span class="c1">#move the file to the corresponding sub directory</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="execute-mirage-and-create-simulated-data">
<h1>Execute MIRAGE and create simulated data<a class="headerlink" href="#execute-mirage-and-create-simulated-data" title="Permalink to this heading">#</a></h1>
<p>Now that the yaml files have been generated, we can execute MIRAGE using them as input parameters and generate the NIRCam images.</p>
<p>As an example, let us choose filter F150W. We are going to simulate all of the images that were observed using filter F150W. The variable “listname” contains the names of the yaml files that we want to process through MIRAGE. There are 128 F150W yaml files.</p>
<section id="this-step-will-take-a-long-time-to-run-to-decrease-the-run-time-we-will-only-process-exposure-0004-you-can-change-the-filter-to-process-all-files-if-desired">
<h2>This step will take a long time to run. To decrease the run-time, we will only process Exposure 0004. You can change the filter to process all files if desired.<a class="headerlink" href="#this-step-will-take-a-long-time-to-run-to-decrease-the-run-time-we-will-only-process-exposure-0004-you-can-change-the-filter-to-process-all-files-if-desired" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># input parameters</span>

<span class="n">filtname</span> <span class="o">=</span> <span class="s1">&#39;f150w&#39;</span>

<span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">filter_pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span><span class="s1">&#39;yaml&#39;</span><span class="p">,</span><span class="n">filtname</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="s1">&#39;jw01069001001*0004*yaml&#39;</span><span class="p">)</span> 
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">filter_pattern</span><span class="p">)[:]</span>
<span class="n">listname</span> <span class="o">=</span> <span class="n">files</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># copy the F150W yaml files back in the working directory</span>
<span class="k">for</span> <span class="n">yamlfile</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">yamlfile</span>         
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">cwd</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;input  = &#39;</span><span class="p">,</span><span class="n">input_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output = &#39;</span><span class="p">,</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span> <span class="c1">#this copies over filter files</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read the list of yaml files to process</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">listname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.fast_no_header&#39;</span><span class="p">)</span>
<span class="n">input_yaml</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">]</span>

<span class="n">yaml_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_yaml</span><span class="p">)):</span>
    <span class="n">yaml_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_yaml</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">yaml_list</span><span class="p">)</span>

<span class="n">files</span> <span class="o">=</span> <span class="n">yaml_list</span>
<span class="n">paramlist</span> <span class="o">=</span> <span class="n">yaml_list</span>
<span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>From each yaml file, Mirage will produce a noiseless seed image, a “raw” <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/data_products/science_products.html?highlight=uncal#uncalibrated-raw-data-uncal">(level 1b) file</a>, and a linearized ramp (equivalent to the output of the linearity correction step of the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/pipeline/calwebb_detector1.html">calwebb_detector1 pipeline</a>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">yamlfile</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------PROCESSING: &#39;</span><span class="p">,</span><span class="n">yamlfile</span><span class="p">,</span><span class="s1">&#39;  -------------------------------&#39;</span><span class="p">)</span>
    
    <span class="c1"># run Mirage</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">ImgSim</span><span class="p">()</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">paramfile</span> <span class="o">=</span> <span class="n">yamlfile</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="examine-the-output">
<h2>Examine the output<a class="headerlink" href="#examine-the-output" title="Permalink to this heading">#</a></h2>
<p>Here we display the output files generated by MIRAGE. The UNCAL file is the raw uncalibrated file.</p>
<section id="seed-image">
<h3>Seed image<a class="headerlink" href="#seed-image" title="Permalink to this heading">#</a></h3>
<p>The seed image contains only the signal from the astronomical sources and background. There are no detector effects, nor cosmic rays added to this count rate image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span><span class="nb">max</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;DN$^{-}$/s&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed_file</span> <span class="o">=</span> <span class="s1">&#39;jw01069001001_01101_00004_nrcb4_uncal_F150W_CLEAR_final_seed_image.fits&#39;</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">seed_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="n">seed_data</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="nb">print</span><span class="p">(</span><span class="n">seed_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">seed_data</span><span class="p">,</span><span class="s1">&#39;Seed Image&#39;</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="linear-file-example">
<h3>Linear file example<a class="headerlink" href="#linear-file-example" title="Permalink to this heading">#</a></h3>
<p>MIRAGE generates the linear and uncalibrated files. Here we display an example linear file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linear_file</span> <span class="o">=</span> <span class="s1">&#39;jw01069001001_01101_00004_nrcb4_linear.fits&#39;</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">linear_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="n">linear_data</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="nb">print</span><span class="p">(</span><span class="n">linear_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this image has five groups</span>
<span class="c1"># we display the last group</span>
<span class="n">show</span><span class="p">(</span><span class="n">linear_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s2">&quot;Final Group linear file&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="raw-uncalibrated-file-example">
<h3>Raw uncalibrated file example<a class="headerlink" href="#raw-uncalibrated-file-example" title="Permalink to this heading">#</a></h3>
<p>First let us display a single group, which is dominated by noise and detector artifacts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_file</span> <span class="o">=</span> <span class="s1">&#39;jw01069001001_01101_00004_nrcb4_uncal.fits&#39;</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raw_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="nb">print</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the image has five groups. Here we display the last group</span>
<span class="n">show</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s2">&quot;Final Group uncal file&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Many of the instrumental artifacts can be removed by looking at the difference between two groups. Raw data values are integers, so first make the data floats before doing the subtraction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show</span><span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s2">&quot;Last Minus First Group uncal file&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/preimaging"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">NIRCam Preimaging: MIRAGE Simulations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mirage-tutorials">MIRAGE Tutorials</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-things-up">Setting things up</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-reference-files-this-will-take-a-long-time-you-will-need-around-100-gb-of-space">Download reference files. This will take a long time. You will need around ~100 GB of space.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">Download Data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-input-yaml-files">Generating input yaml files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-yaml-generator">Running the yaml_generator</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organizing-files-according-to-filter">Organizing files according to filter</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#execute-mirage-and-create-simulated-data">Execute MIRAGE and create simulated data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#this-step-will-take-a-long-time-to-run-to-decrease-the-run-time-we-will-only-process-exposure-0004-you-can-change-the-filter-to-process-all-files-if-desired">This step will take a long time to run. To decrease the run-time, we will only process Exposure 0004. You can change the filter to process all files if desired.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examine-the-output">Examine the output</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seed-image">Seed image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-file-example">Linear file example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-uncalibrated-file-example">Raw uncalibrated file example</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>