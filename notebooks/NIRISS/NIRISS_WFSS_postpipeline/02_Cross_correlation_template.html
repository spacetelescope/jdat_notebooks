

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>WFSS Spectra - Part 2: Cross Correlation to Determine Redshift &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="WFSS Spectra Part 3: Emission Line Map" href="03_Spatially_resolved_emission_line_map.html" />
    <link rel="prev" title="WFSS Spectra Part 1: Combine and Normalize 1D Spectra" href="01_Combine_and_normalize_1D_spectra.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples.html">STPSF Examples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>WFSS Spectra - Part 2: Cross Correlation to Determine Redshift</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-notebook-01-products">0. Download notebook 01 products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#open-optimally-extracted-1d-spectrum-text-file">1.Open optimally extracted 1D spectrum text file;</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#continuum-is-visible-we-need-to-subtract-it-before-template-correlation">Continuum is visible. We need to subtract it before template correlation.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#do-cross-correlation-with-an-input-template">Do cross-correlation with an input template;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-synthetic-template">Load synthetic template;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below">Binning the template into a course array, if you have too many elements and cause an issue below;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-this-example-this-is-not-necessary">-&gt; In this example this is not necessary.</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly">CAUTION: Two inputs spectra above have to overlap, if only a small part, to make Specutils works properly.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-correlation-using-specutils-functionarity">Cross Correlation using specutils functionarity;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-it-look">How does it look?</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="wfss-spectra-part-2-cross-correlation-to-determine-redshift">
<h1>WFSS Spectra - Part 2: Cross Correlation to Determine Redshift<a class="headerlink" href="#wfss-spectra-part-2-cross-correlation-to-determine-redshift" title="Permalink to this heading">#</a></h1>
<p><strong>Use case:</strong> optimal extraction of grism spectra; redshift measurement; emission-line maps.  Simplified version of <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-imager-and-slitless-spectrograph/niriss-example-science-programs/niriss-wfss-with-nircam-parallel-imaging-of-galaxies-in-lensing-clusters">JDox Science Use Case # 33</a>.<br>
<strong>Data:</strong> JWST simulated NIRISS images from <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">MIRAGE</a>, run through the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/">JWST calibration pipeline</a>; galaxy cluster.<br>
<strong>Tools:</strong>  specutils, astropy, pandas, emcee, lmfit, corner, h5py.<br>
<strong>Cross-intrument:</strong> NIRSpec <br>
<strong>Documentation:</strong> This notebook is part of a STScIâ€™s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This notebook is 3 of 4 in a set focusing on NIRISS WFSS data:
1. 1D optimal extraction since the JWST pipeline only provides a box extraction.  Optimal extraction improves S/N of spectra for faint sources.
2. Combine and normalize 1D spectra.
3. Cross correlate galaxy with template to get redshift.
4. Spatially resolved emission line map.</p>
<p>This notebook derives the redshift of a galaxy with multiple emission lines by using specutils template correlation.  The notebook begins with optimally extracted 1D spectra from notebook #2.</p>
<p><strong>Note:</strong> Spectra without emission lines (e.g., ID 00003 in the previous notebook) may fail with the function here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.polynomial</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chebyshev1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;astropy&#39;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>astropy 7.0.2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">specutils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">specutils.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">continuum</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">specutils.spectra.spectrum1d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spectrum1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">specutils.analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">correlation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">specutils.spectra.spectral_region</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpectralRegion</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Specutils: &quot;</span><span class="p">,</span> <span class="n">specutils</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Specutils:  1.20.1
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-notebook-01-products">
<h2>0. Download notebook 01 products<a class="headerlink" href="#download-notebook-01-products" title="Permalink to this heading">#</a></h2>
<p>These can be also obtained by running the notebooks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;./output&#39;</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
    <span class="n">boxlink</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/NIRISS_lensing_cluster/output.zip&#39;</span>
    <span class="n">boxfile</span> <span class="o">=</span> <span class="s1">&#39;./output.zip&#39;</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>
    <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">list_names</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list_names</span><span class="p">:</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="n">item</span><span class="p">)</span> <span class="c1"># Using extract instead of extractall because it is safer when files have absolute (/) or relative (..) paths</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Already exists&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="open-optimally-extracted-1d-spectrum-text-file">
<h2>1.Open optimally extracted 1D spectrum text file;<a class="headerlink" href="#open-optimally-extracted-1d-spectrum-text-file" title="Permalink to this heading">#</a></h2>
<p>These are optimally extracted, normalized spectra from notebooks 01a &amp; 01b.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DIR_OUT</span> <span class="o">=</span> <span class="s1">&#39;./output/&#39;</span>
<span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;f200w&#39;</span>

<span class="n">grism</span> <span class="o">=</span> <span class="s1">&#39;G150C&#39;</span>
<span class="c1"># grism = &#39;G150R&#39;</span>

<span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;00004&#39;</span>
<span class="n">file_1d</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DIR_OUT</span><span class="si">}</span><span class="s1">l3_nis_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grism</span><span class="si">}</span><span class="s1">_s</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s1">_combine_1d_opt.fits&#39;</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_1d</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">hd</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_1d</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">fd</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FITS_rec([(1.71986127, 42.38365482, 1.51015508),
          (1.72453201, 38.56917716, 0.97178267),
          (1.72920275, 35.93947653, 0.62354777),
          (1.73387337, 23.77350774, 0.31776521),
          (1.73854411, 22.91664629, 0.21997059),
          (1.74321485, 18.82889931, 0.14420642),
          (1.74788558, 16.24401145, 0.10209115),
          (1.7525562 , 12.60893081, 0.0719594 ),
          (1.75722694, 10.30048011, 0.05026028),
          (1.76189768, 10.56057566, 0.04827347),
          (1.76656842, 10.80664315, 0.04615251),
          (1.77123904, 10.96807816, 0.04635962),
          (1.77590978, 10.84610055, 0.04520876),
          (1.78058052, 11.14885447, 0.04861023),
          (1.78525114, 11.40215898, 0.05138483),
          (1.78992188, 11.48868052, 0.04729241),
          (1.79459262, 11.58795191, 0.04634937),
          (1.79926336, 11.73206527, 0.04663301),
          (1.80393398, 11.97186637, 0.04839924),
          (1.80860472, 11.9611019 , 0.04914871),
          (1.81327546, 11.77717771, 0.04949575),
          (1.81794608, 11.6472086 , 0.04936947),
          (1.82261682, 11.56556774, 0.04957357),
          (1.82728755, 11.71344915, 0.04822698),
          (1.83195829, 11.65288706, 0.04838117),
          (1.83662891, 11.73176765, 0.04977119),
          (1.84129965, 11.98642048, 0.04941678),
          (1.84597039, 12.14407666, 0.04846335),
          (1.85064113, 12.2294789 , 0.04976337),
          (1.85531175, 12.58098372, 0.05318308),
          (1.85998249, 12.62738604, 0.05218814),
          (1.86465323, 12.40292156, 0.05172025),
          (1.86932385, 12.20461574, 0.05425321),
          (1.87399459, 12.41531018, 0.05062367),
          (1.87866533, 12.49310545, 0.0504054 ),
          (1.88333607, 12.47879134, 0.05008047),
          (1.88800669, 12.48052731, 0.05093631),
          (1.89267743, 12.44949336, 0.0523712 ),
          (1.89734817, 12.46076927, 0.0512366 ),
          (1.90201879, 12.50730277, 0.05058337),
          (1.90668952, 12.43958853, 0.05015841),
          (1.91136026, 12.42111697, 0.05012851),
          (1.916031  , 12.46504231, 0.05106978),
          (1.92070162, 12.43572865, 0.05177651),
          (1.92537236, 12.50323568, 0.0518209 ),
          (1.9300431 , 12.56200541, 0.05140919),
          (1.93471372, 12.524999  , 0.05147548),
          (1.93938446, 12.59353438, 0.0513625 ),
          (1.9440552 , 12.66183485, 0.05211391),
          (1.94872594, 12.62118241, 0.05276501),
          (1.95339656, 12.35676077, 0.05585218),
          (1.9580673 , 12.31514282, 0.05852116),
          (1.96273804, 12.6059867 , 0.0581315 ),
          (1.96740878, 12.7973866 , 0.05491294),
          (1.9720794 , 13.13971683, 0.05460986),
          (1.97675014, 13.4866589 , 0.05613727),
          (1.98142087, 13.52707449, 0.0561673 ),
          (1.98609149, 13.5420637 , 0.05623735),
          (1.99076223, 13.79659428, 0.05655741),
          (1.99543297, 14.08201932, 0.05897219),
          (2.00010371, 14.67188355, 0.05941912),
          (2.00477433, 15.88794186, 0.06221541),
          (2.00944495, 17.92468302, 0.06824417),
          (2.01411581, 21.49804726, 0.0774888 ),
          (2.01878643, 28.19607868, 0.08944139),
          (2.02345729, 39.44270001, 0.111863  ),
          (2.02812791, 54.27856681, 0.14055919),
          (2.03279853, 65.73083879, 0.16328814),
          (2.03746939, 65.81027175, 0.16305239),
          (2.04214001, 54.96117411, 0.14097168),
          (2.04681063, 40.50272461, 0.11793418),
          (2.05148149, 29.101485  , 0.09050252),
          (2.05615211, 22.31114997, 0.07628278),
          (2.06082273, 18.71178258, 0.06872121),
          (2.06549358, 16.61084154, 0.0639475 ),
          (2.0701642 , 15.69277454, 0.06156768),
          (2.07483506, 15.01033761, 0.06108708),
          (2.07950568, 14.67329672, 0.06055912),
          (2.0841763 , 14.5614213 , 0.05847086),
          (2.08884716, 14.3771121 , 0.05891275),
          (2.09351778, 14.25279852, 0.05998107),
          (2.0981884 , 14.25994032, 0.05832638),
          (2.10285926, 14.23462592, 0.05942212),
          (2.10752988, 14.20510948, 0.05972571),
          (2.1122005 , 14.09332883, 0.0590418 ),
          (2.11687136, 14.10938846, 0.05772431),
          (2.12154198, 14.21478398, 0.05830313),
          (2.1262126 , 14.28427848, 0.0584818 ),
          (2.13088346, 14.32668972, 0.05868324),
          (2.13555408, 14.35109908, 0.06058188),
          (2.14022493, 14.41141221, 0.0654428 ),
          (2.14489555, 14.48783474, 0.06164804),
          (2.14956617, 14.43695253, 0.05853947),
          (2.15423703, 14.53766106, 0.05931266),
          (2.15890765, 14.54226979, 0.05933905),
          (2.16357827, 14.63735923, 0.06272671),
          (2.16824913, 14.59274168, 0.06241335),
          (2.17291975, 14.62996471, 0.06227284),
          (2.17759037, 14.78774487, 0.06166981),
          (2.18226123, 14.87656607, 0.06212647),
          (2.18693185, 14.904289  , 0.06553384),
          (2.19160271, 14.78106993, 0.06598214),
          (2.19627333, 14.35750049, 0.06232894),
          (2.20094395, 14.01928977, 0.06014454),
          (2.20561481, 13.6717337 , 0.06316704),
          (2.21028543, 13.27033976, 0.06272573),
          (2.21495605, 13.45858388, 0.06378313),
          (2.2196269 , 14.4814341 , 0.07466454),
          (2.22429752, 15.33204144, 0.08537209),
          (2.22896814, 18.84246093, 0.12252199),
          (2.233639  , 20.87433452, 0.17291249),
          (2.23830962, 28.3669051 , 0.28658091),
          (2.24298024, 31.28393199, 0.3807091 ),
          (2.2476511 , 39.62514071, 0.76141747),
          (2.25232172, 51.17825988, 1.22953228),
          (2.25699258, 63.41328878, 2.06786936)],
         dtype=(numpy.record, [(&#39;wavelength&#39;, &#39;&gt;f8&#39;), (&#39;flux&#39;, &#39;&gt;f8&#39;), (&#39;uncertainty&#39;, &#39;&gt;f8&#39;)]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Normalization of observed spectra; Just for visual purpose;</span>
<span class="n">flux_normalize</span> <span class="o">=</span> <span class="mf">500.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wave_200</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
<span class="n">flux_200</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">flux_normalize</span>
<span class="n">flux_err_200</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">flux_normalize</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open files for other filters.</span>
<span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;f150w&#39;</span>
<span class="n">file_1d</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DIR_OUT</span><span class="si">}</span><span class="s1">l3_nis_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grism</span><span class="si">}</span><span class="s1">_s</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s1">_combine_1d_opt.fits&#39;</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_1d</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">wave_150</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
<span class="n">flux_150</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">flux_normalize</span>
<span class="n">flux_err_150</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">flux_normalize</span>

<span class="c1"># </span>
<span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;f115w&#39;</span>
<span class="n">file_1d</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DIR_OUT</span><span class="si">}</span><span class="s1">l3_nis_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grism</span><span class="si">}</span><span class="s1">_s</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s1">_combine_1d_opt.fits&#39;</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_1d</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">wave_115</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
<span class="n">flux_115</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">flux_normalize</span>
<span class="n">flux_err_115</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">flux_normalize</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot all</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_115</span><span class="p">,</span> <span class="n">flux_115</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F115W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_150</span><span class="p">,</span> <span class="n">flux_150</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F150W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_200</span><span class="p">,</span> <span class="n">flux_200</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F200W&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wave_115</span><span class="p">,</span> <span class="o">-</span><span class="n">flux_err_115</span><span class="p">,</span> <span class="n">flux_err_115</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wave_150</span><span class="p">,</span> <span class="o">-</span><span class="n">flux_err_150</span><span class="p">,</span> <span class="n">flux_err_150</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wave_200</span><span class="p">,</span> <span class="o">-</span><span class="n">flux_err_200</span><span class="p">,</span> <span class="n">flux_err_200</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength / um&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f652a0c3910&gt;
</pre></div>
</div>
<img alt="../../../_images/5681a309806093e04447b9e313b9baa874cac61c00ed9cab65a8af65c9f75d33.png" src="../../../_images/5681a309806093e04447b9e313b9baa874cac61c00ed9cab65a8af65c9f75d33.png" />
</div>
</div>
<section id="continuum-is-visible-we-need-to-subtract-it-before-template-correlation">
<h3>Continuum is visible. We need to subtract it before template correlation.<a class="headerlink" href="#continuum-is-visible-we-need-to-subtract-it-before-template-correlation" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Strong emission lines are seen. (Hb+Oiii doublet at ~1.55um, and blended Ha+Nii at ~2.1um)</p></li>
<li><p>Note that flux excess at the edges of each filter are not real, and should be masked out.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># F200W</span>

<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span>

<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">wave_200</span> <span class="o">&gt;</span> <span class="mf">1.75</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_200</span> <span class="o">&lt;</span> <span class="mf">1.97</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">wave_200</span> <span class="o">&gt;</span> <span class="mf">2.08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_200</span> <span class="o">&lt;</span> <span class="mf">2.23</span><span class="p">))</span>

<span class="n">obs_200</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave_200</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">flux_200</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">)</span>
<span class="n">continuum_200</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">obs_200</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_200</span><span class="p">,</span> <span class="n">flux_200</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F200W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave_200</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">continuum_200</span><span class="p">(</span><span class="n">obs_200</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted continuum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">flux_200_sub</span> <span class="o">=</span> <span class="n">flux_200</span> <span class="o">*</span> <span class="n">spec_unit</span> <span class="o">-</span> <span class="n">continuum_200</span><span class="p">(</span><span class="n">wave_200</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>

<span class="n">mask_200</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave_200</span> <span class="o">&gt;</span> <span class="mf">1.75</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_200</span> <span class="o">&lt;</span> <span class="mf">2.23</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre></div>
</div>
<img alt="../../../_images/4e0df10ec89790b96586f10978f374f7fb1687ec4b04fb14ec8e88846fb285a9.png" src="../../../_images/4e0df10ec89790b96586f10978f374f7fb1687ec4b04fb14ec8e88846fb285a9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># F150W</span>

<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span>

<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">wave_150</span> <span class="o">&gt;</span> <span class="mf">1.35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_150</span> <span class="o">&lt;</span> <span class="mf">1.48</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">wave_150</span> <span class="o">&gt;</span> <span class="mf">1.6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_150</span> <span class="o">&lt;</span> <span class="mf">1.65</span><span class="p">))</span>

<span class="n">obs_150</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave_150</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">flux_150</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">)</span>
<span class="n">continuum_150</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">obs_150</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>

<span class="n">flux_150_sub</span> <span class="o">=</span> <span class="n">flux_150</span> <span class="o">*</span> <span class="n">spec_unit</span> <span class="o">-</span> <span class="n">continuum_150</span><span class="p">(</span><span class="n">wave_150</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_150</span><span class="p">,</span> <span class="n">flux_150</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F150W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave_150</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">continuum_150</span><span class="p">(</span><span class="n">obs_150</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted continuum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">mask_150</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave_150</span> <span class="o">&gt;</span> <span class="mf">1.35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_150</span> <span class="o">&lt;</span> <span class="mf">1.65</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/ac52ae42bcf6052665298671c1ae4dc1db6ac3770c403815fc12eaac725db6b3.png" src="../../../_images/ac52ae42bcf6052665298671c1ae4dc1db6ac3770c403815fc12eaac725db6b3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># F150W</span>

<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span>

<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">wave_115</span> <span class="o">&gt;</span> <span class="mf">1.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_115</span> <span class="o">&lt;</span> <span class="mf">1.13</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">wave_115</span> <span class="o">&gt;</span> <span class="mf">1.17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_115</span> <span class="o">&lt;</span> <span class="mf">1.25</span><span class="p">))</span>

<span class="n">obs_115</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave_115</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">flux_115</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">)</span>
<span class="n">continuum_115</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">obs_115</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_115</span><span class="p">,</span> <span class="n">flux_115</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F115W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave_115</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">continuum_115</span><span class="p">(</span><span class="n">obs_115</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted continuum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">flux_115_sub</span> <span class="o">=</span> <span class="n">flux_115</span> <span class="o">*</span> <span class="n">spec_unit</span> <span class="o">-</span> <span class="n">continuum_115</span><span class="p">(</span><span class="n">wave_115</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>
<span class="n">mask_115</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave_115</span> <span class="o">&gt;</span> <span class="mf">1.02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_115</span> <span class="o">&lt;</span> <span class="mf">1.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/f6ff3983e5397d65631ca00bfbd57675c3516cb1190b3558efbbd095eac7dad7.png" src="../../../_images/f6ff3983e5397d65631ca00bfbd57675c3516cb1190b3558efbbd095eac7dad7.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot all</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_115</span><span class="p">[</span><span class="n">mask_115</span><span class="p">],</span> <span class="n">flux_115_sub</span><span class="p">[</span><span class="n">mask_115</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F115W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_150</span><span class="p">[</span><span class="n">mask_150</span><span class="p">],</span> <span class="n">flux_150_sub</span><span class="p">[</span><span class="n">mask_150</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F150W&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wave_200</span><span class="p">[</span><span class="n">mask_200</span><span class="p">],</span> <span class="n">flux_200_sub</span><span class="p">[</span><span class="n">mask_200</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F200W&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wave_115</span><span class="p">,</span> <span class="o">-</span><span class="n">flux_err_115</span><span class="p">,</span> <span class="n">flux_err_115</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wave_150</span><span class="p">,</span> <span class="o">-</span><span class="n">flux_err_150</span><span class="p">,</span> <span class="n">flux_err_150</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wave_200</span><span class="p">,</span> <span class="o">-</span><span class="n">flux_err_200</span><span class="p">,</span> <span class="n">flux_err_200</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength / um&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f6527d9b1d0&gt;
</pre></div>
</div>
<img alt="../../../_images/1c2f14a3ccc98867b024fec3187ab5fa328606a80729ee3be39b68590275440b.png" src="../../../_images/1c2f14a3ccc98867b024fec3187ab5fa328606a80729ee3be39b68590275440b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Concatenate arrays</span>
<span class="n">wave_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wave_115</span><span class="p">[</span><span class="n">mask_115</span><span class="p">],</span> <span class="n">wave_150</span><span class="p">[</span><span class="n">mask_150</span><span class="p">],</span> <span class="n">wave_200</span><span class="p">[</span><span class="n">mask_200</span><span class="p">]])</span>
<span class="n">flux_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">flux_115_sub</span><span class="p">[</span><span class="n">mask_115</span><span class="p">],</span> <span class="n">flux_150_sub</span><span class="p">[</span><span class="n">mask_150</span><span class="p">],</span> <span class="n">flux_200_sub</span><span class="p">[</span><span class="n">mask_200</span><span class="p">]])</span>
<span class="n">flux_err_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">flux_err_115</span><span class="p">[</span><span class="n">mask_115</span><span class="p">],</span> <span class="n">flux_err_150</span><span class="p">[</span><span class="n">mask_150</span><span class="p">],</span> <span class="n">flux_err_200</span><span class="p">[</span><span class="n">mask_200</span><span class="p">]])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave_obs</span><span class="p">,</span> <span class="n">flux_obs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wave_obs</span><span class="p">,</span> <span class="o">-</span><span class="n">flux_err_obs</span><span class="p">,</span> <span class="n">flux_err_obs</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.FillBetweenPolyCollection at 0x7f6529f3d7d0&gt;
</pre></div>
</div>
<img alt="../../../_images/2416ceb9659afac97d1576dc5f9af0c6b83f7f20a5f9fafd0de86693433046bc.png" src="../../../_images/2416ceb9659afac97d1576dc5f9af0c6b83f7f20a5f9fafd0de86693433046bc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wht_obs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">flux_err_obs</span><span class="o">**</span><span class="mi">2</span>
<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span>

<span class="n">dataspec</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">([</span><span class="n">wave_obs</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux_obs</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">,</span> <span class="n">wht_obs</span><span class="p">,</span> <span class="n">flux_err_obs</span><span class="p">],</span>
                  <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;uncertainty&#39;</span><span class="p">))</span>
<span class="n">dataspec_sub</span> <span class="o">=</span> <span class="n">dataspec</span><span class="p">[</span><span class="n">dataspec</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>

<span class="c1"># Now make it into a Spectrum1D instance.</span>
<span class="n">p_obs</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span>
                   <span class="n">flux</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span>
                   <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MJy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="do-cross-correlation-with-an-input-template">
<h3>Do cross-correlation with an input template;<a class="headerlink" href="#do-cross-correlation-with-an-input-template" title="Permalink to this heading">#</a></h3>
<p>(*Another notebook on Specutils cross correlation by Ivo Busko: https://spacetelescope.github.io/jdat_notebooks/pages/redshift_crosscorr/redshift_crosscorr.html)</p>
</section>
<section id="load-synthetic-template">
<h3>Load synthetic template;<a class="headerlink" href="#load-synthetic-template" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Just to test the functionality, for now we are using the input spectral template used for simulation.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">read_hdf5</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_obj</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">file_obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wave_units_string</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;wavelength_units&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">wave_units_string</span> <span class="o">=</span> <span class="s1">&#39;micron&#39;</span>
                
            <span class="c1"># Catch common errors</span>
            <span class="k">if</span> <span class="n">wave_units_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;microns&#39;</span><span class="p">,</span> <span class="s1">&#39;angstroms&#39;</span><span class="p">,</span> <span class="s1">&#39;nanometers&#39;</span><span class="p">]:</span>
                <span class="n">wave_units_string</span> <span class="o">=</span> <span class="n">wave_units_string</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Get the data</span>
            <span class="n">waves</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fluxes</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">contents</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">:</span> <span class="n">waves</span><span class="p">,</span> <span class="s1">&#39;fluxes&#39;</span><span class="p">:</span> <span class="n">fluxes</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">contents</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download files, if not exists yet.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;./pipeline_products&#39;</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
    <span class="n">boxlink</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/NIRISS_lensing_cluster/pipeline_products.zip&#39;</span>
    <span class="n">boxfile</span> <span class="o">=</span> <span class="s1">&#39;./pipeline_products.zip&#39;</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>
    <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">list_names</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list_names</span><span class="p">:</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="n">item</span><span class="p">)</span> <span class="c1"># Using extract instead of extractall because it is safer when files have absolute (/) or relative (..) paths</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Template file;</span>
<span class="n">file_temp</span> <span class="o">=</span> <span class="s1">&#39;./pipeline_products/source_sed_file_from_sources_extend_01_and_sed_file.hdf5&#39;</span>

<span class="n">content</span> <span class="o">=</span> <span class="n">read_hdf5</span><span class="p">(</span><span class="n">file_temp</span><span class="p">)</span>
<span class="n">content</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{10177: {&#39;wavelengths&#39;: array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], shape=(471877,), dtype=float32),
  &#39;fluxes&#39;: array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.4608030e-25,
         8.3700207e-26, 2.1320117e-26], shape=(471877,), dtype=float32)},
 10265: {&#39;wavelengths&#39;: array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], shape=(471877,), dtype=float32),
  &#39;fluxes&#39;: array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.7282180e-25,
         9.9022388e-26, 2.5222983e-26], shape=(471877,), dtype=float32)},
 10455: {&#39;wavelengths&#39;: array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], shape=(471877,), dtype=float32),
  &#39;fluxes&#39;: array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.4816426e-26,
         8.4894260e-27, 2.1624266e-27], shape=(471877,), dtype=float32)},
 10709: {&#39;wavelengths&#39;: array([3.0999999e-02, 3.1072199e-02, 3.1144397e-02, ..., 3.4099831e+01,
         3.4099903e+01, 3.4099976e+01], shape=(471877,), dtype=float32),
  &#39;fluxes&#39;: array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 3.6238049e-24,
         2.0763458e-24, 5.2888681e-25], shape=(471877,), dtype=float32)},
 11151: {&#39;wavelengths&#39;: array([3.5000000e-02, 3.5081513e-02, 3.5163030e-02, ..., 3.8499809e+01,
         3.8499889e+01, 3.8499973e+01], shape=(471877,), dtype=float32),
  &#39;fluxes&#39;: array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.0507161e-24,
         6.0203300e-25, 1.5334984e-25], shape=(471877,), dtype=float32)},
 11420: {&#39;wavelengths&#39;: array([3.5000000e-02, 3.5081513e-02, 3.5163030e-02, ..., 3.8499809e+01,
         3.8499889e+01, 3.8499973e+01], shape=(471877,), dtype=float32),
  &#39;fluxes&#39;: array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.0168714e-24,
         5.8264083e-25, 1.4841028e-25], shape=(471877,), dtype=float32)},
 11423: {&#39;wavelengths&#39;: array([3.5000000e-02, 3.5081513e-02, 3.5163030e-02, ..., 3.8499809e+01,
         3.8499889e+01, 3.8499973e+01], shape=(471877,), dtype=float32),
  &#39;fluxes&#39;: array([0.0000000e+00, 0.0000000e+00, 0.0000000e+00, ..., 1.0033151e-24,
         5.7487341e-25, 1.4643175e-25], shape=(471877,), dtype=float32)}}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The template is already redshifted for simulation. </span>
<span class="c1"># Now, blueshift it to z=0;</span>
<span class="n">z_input</span> <span class="o">=</span> <span class="mf">2.1</span> 
<span class="n">iix</span> <span class="o">=</span> <span class="mi">10709</span> <span class="c1"># Index for the particular template.</span>

<span class="n">flux_all</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">iix</span><span class="p">][</span><span class="s1">&#39;fluxes&#39;</span><span class="p">]</span>
<span class="n">wave_all</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">iix</span><span class="p">][</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">z_input</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e4</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave_all</span><span class="p">,</span> <span class="n">flux_all</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2000.0, 8000.0)
</pre></div>
</div>
<img alt="../../../_images/431914885634b375158eae4bc8cc47c9a07eb704b2d5ca9770a907409e04584c.png" src="../../../_images/431914885634b375158eae4bc8cc47c9a07eb704b2d5ca9770a907409e04584c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cut templates for better fit.</span>
<span class="n">con_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave_all</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave_all</span> <span class="o">&lt;</span> <span class="mi">13000</span><span class="p">)</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">flux_all</span><span class="p">[</span><span class="n">con_tmp</span><span class="p">]</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">wave_all</span><span class="p">[</span><span class="n">con_tmp</span><span class="p">]</span>
<span class="n">flux</span> <span class="o">/=</span> <span class="n">flux</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">wave</span> <span class="o">*=</span> <span class="mf">1.e-4</span> <span class="c1"># force wavelengths in um. (with_spectral_unit doesn&#39;t convert)</span>

<span class="n">factor</span> <span class="o">=</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># normalize template to a sensible range</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">flux</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;um&#39;)
</pre></div>
</div>
<img alt="../../../_images/8c676da7f99332971ba838a2c1f42544b06a63aab008edad1ceb93fc0a298988.png" src="../../../_images/8c676da7f99332971ba838a2c1f42544b06a63aab008edad1ceb93fc0a298988.png" />
</div>
</div>
</section>
<section id="binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below">
<h3>Binning the template into a course array, if you have too many elements and cause an issue below;<a class="headerlink" href="#binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below" title="Permalink to this heading">#</a></h3>
</section>
<section id="in-this-example-this-is-not-necessary">
<h3>-&gt; In this example this is not necessary.<a class="headerlink" href="#in-this-example-this-is-not-necessary" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make this true, if you want to bin;</span>
<span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
    <span class="n">wave_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">wave</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">wave</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">20.0</span><span class="p">)</span>
    <span class="n">flux_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wave_bin</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">wave_bin</span> <span class="o">=</span> <span class="n">wave</span>
    <span class="n">flux_bin</span> <span class="o">=</span> <span class="n">flux</span>

<span class="n">factor</span> <span class="o">=</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># normalize template to a sensible range</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave_bin</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">flux_bin</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>    
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;um&#39;)
</pre></div>
</div>
<img alt="../../../_images/8c676da7f99332971ba838a2c1f42544b06a63aab008edad1ceb93fc0a298988.png" src="../../../_images/8c676da7f99332971ba838a2c1f42544b06a63aab008edad1ceb93fc0a298988.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Continuum fit to the fitting temp;</span>
<span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">0.37</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">0.452</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">),</span> 
           <span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">0.476</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">0.53</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">),</span>
           <span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">0.645</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">0.67</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)]</span>

<span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">exclude_regions</span><span class="o">=</span><span class="n">regions</span><span class="p">)</span>

<span class="n">p_template</span> <span class="o">=</span> <span class="n">template</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Continuum subtracted template&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Continuum subtracted template&#39;)
</pre></div>
</div>
<img alt="../../../_images/0d76f8fd60dc2b7d261d07584e630d667d00e643208f4fbc2afee16cf72c51fd.png" src="../../../_images/0d76f8fd60dc2b7d261d07584e630d667d00e643208f4fbc2afee16cf72c51fd.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Put data array into Specutils format;</span>
<span class="n">sflux</span> <span class="o">=</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span> 
<span class="n">p_smooth_template</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">p_template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                               <span class="n">flux</span><span class="o">=</span><span class="n">sflux</span><span class="o">/</span><span class="n">sflux</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_smooth_template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">p_smooth_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Smoothed template&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">p_smooth_template</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f6527b231d0&gt;
</pre></div>
</div>
<img alt="../../../_images/fae022887b5474932fc2d8393fbeef6e8f4466d39f89457f9415eeb54cc5751c.png" src="../../../_images/fae022887b5474932fc2d8393fbeef6e8f4466d39f89457f9415eeb54cc5751c.png" />
</div>
</div>
<section id="caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly">
<h4>CAUTION: Two inputs spectra above have to overlap, if only a small part, to make Specutils works properly.<a class="headerlink" href="#caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly" title="Permalink to this heading">#</a></h4>
</section>
</section>
<section id="cross-correlation-using-specutils-functionarity">
<h3>Cross Correlation using specutils functionarity;<a class="headerlink" href="#cross-correlation-using-specutils-functionarity" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># With no additional specifications, both the entire template and entire spectrum </span>
<span class="c1"># will be included in the correlation computation. This in general will incur in </span>
<span class="c1"># a significant increase in execution time. It is advised that the template is cut</span>
<span class="c1"># to work only on the useful region.</span>

<span class="n">corr</span><span class="p">,</span> <span class="n">lag</span> <span class="o">=</span> <span class="n">correlation</span><span class="o">.</span><span class="n">template_correlate</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">p_smooth_template</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.11.12/x64/lib/python3.11/site-packages/astropy/units/quantity.py:658: RuntimeWarning: invalid value encountered in divide
  result = super().__array_ufunc__(function, method, *arrays, **kwargs)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;km / s&#39;)
</pre></div>
</div>
<img alt="../../../_images/731adce6f3e4427fe55ebbca94b367d565fc35dbdfe703ead3d03c26c257911a.png" src="../../../_images/731adce6f3e4427fe55ebbca94b367d565fc35dbdfe703ead3d03c26c257911a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redshift based on maximum</span>
<span class="n">index_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="p">]</span>

<span class="n">z</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Peak maximum at: &quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redshift from peak maximum: &quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Peak maximum at:  628833.1938062641 km / s
Redshift from peak maximum:  2.0975617532255066
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redshift based on parabolic fit to maximum</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># points to the left or right of correlation maximum</span>
<span class="n">peak_lags</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">peak_vals</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">peak_vals</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">v_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="c1"># maximum lies at mid point between roots</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v_fit</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parabolic fit with maximum at: &quot;</span><span class="p">,</span> <span class="n">v_fit</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redshift from parabolic fit: &quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Parabolic fit with maximum at:  629197.8938752951 km / s
Redshift from parabolic fit:  2.098778261710957
</pre></div>
</div>
</div>
</div>
</section>
<section id="how-does-it-look">
<h3>How does it look?<a class="headerlink" href="#how-does-it-look" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;z =&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">template</span><span class="o">.</span><span class="n">spectral_axis</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> 
    <span class="n">p_smooth_template</span><span class="o">.</span><span class="n">flux</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">p_smooth_template</span><span class="o">.</span><span class="n">flux</span><span class="p">),</span> 
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Template&#39;</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>z = 2.098778261710957
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;um&#39;)
</pre></div>
</div>
<img alt="../../../_images/9054c9f1a1f7492a3cebde7f2f5edb838542618a56664d672ddb937d82ae2b92.png" src="../../../_images/9054c9f1a1f7492a3cebde7f2f5edb838542618a56664d672ddb937d82ae2b92.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRISS/NIRISS_WFSS_postpipeline"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="01_Combine_and_normalize_1D_spectra.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">WFSS Spectra Part 1: Combine and Normalize 1D Spectra</p>
      </div>
    </a>
    <a class="right-next"
       href="03_Spatially_resolved_emission_line_map.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">WFSS Spectra Part 3: Emission Line Map</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-notebook-01-products">0. Download notebook 01 products</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#open-optimally-extracted-1d-spectrum-text-file">1.Open optimally extracted 1D spectrum text file;</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#continuum-is-visible-we-need-to-subtract-it-before-template-correlation">Continuum is visible. We need to subtract it before template correlation.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#do-cross-correlation-with-an-input-template">Do cross-correlation with an input template;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-synthetic-template">Load synthetic template;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#binning-the-template-into-a-course-array-if-you-have-too-many-elements-and-cause-an-issue-below">Binning the template into a course array, if you have too many elements and cause an issue below;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-this-example-this-is-not-necessary">-&gt; In this example this is not necessary.</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#caution-two-inputs-spectra-above-have-to-overlap-if-only-a-small-part-to-make-specutils-works-properly">CAUTION: Two inputs spectra above have to overlap, if only a small part, to make Specutils works properly.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-correlation-using-specutils-functionarity">Cross Correlation using specutils functionarity;</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-it-look">How does it look?</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>