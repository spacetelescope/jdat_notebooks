

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Run spec2 pipeline &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="IFU Cube Fitting" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html" />
    <link rel="prev" title="Run Image Pipeline and Create Source Catalog" href="01_niriss_wfss_image2_image3.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS.html">Improving Accuracy of WCS of Pure Parallel Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction.html">NIRCam Wisp Removal</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../niriss_imaging/niriss-imaging-tutorial.html">NIRISS Imaging Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="00_niriss_mast_query_data_setup.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_niriss_wfss_image2_image3.html">Direct imaging for WFSS</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Spec2 pipeline for WFSS</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting.html">IFU Cube Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting.html">Redshift and Template Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example.html">FS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example.html">IFU Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example.html">MOS Products with NSClean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example.html">BOTS Products with NSClean</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Run spec2 pipeline</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-data-setup">Imports &amp; Data Setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-setup">Data Setup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-spec2-pipeline-run">Custom Spec2 Pipeline Run</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spec2-association-files">Spec2 Association Files</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#looking-in-a-spec2-association-file">Looking in a Spec2 Association File</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#modify-the-association-file-to-use-custom-source-catalog">Modify the Association File to use Custom Source Catalog</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-spec2">Run spec2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-the-outputs-of-spec2">Examining the Outputs of Spec2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-spec2-data-further">Explore Spec2 Data Further</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-a-source-in-the-spec2-data">Find a Source in the Spec2 Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-the-number-of-extracted-sources">Limit the Number of Extracted Sources</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-extraction-using-parameter-inputs">Limit Extraction Using Parameter Inputs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-extraction-using-the-source-catalog">Limit Extraction Using the Source Catalog</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-visualization">Final Visualization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#look-at-all-of-the-files-for-a-single-source">Look at all of the Files for a Single Source</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#look-at-all-of-the-sources-for-a-single-file">Look at all of the sources for a single file</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-where-the-extracted-sources-are-on-the-dispersed-image-and-how-that-compares-to-the-direct-image">Visualize where the extracted sources are on the dispersed image, and how that compares to the direct image</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="run-spec2-pipeline">
<h1>Run spec2 pipeline<a class="headerlink" href="#run-spec2-pipeline" title="Permalink to this heading">#</a></h1>
<p>The dispersed images for WFSS will be run through the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec2.html">spec2 pipeline</a> after the image2 and image3 pipelines have been run on the corresponding direct images. As mentioned in the previous notebook, it is extremely helpful for this step if you have a source catalog that only includes the sources that you would like to look at. Any additional sources will take extra time to calibrate.</p>
<p><strong>Use case</strong>: After creating a custom source catalog, spec2 should be run on the dispersed WFSS images.<br>
<strong>Data</strong>: JWST/NIRISS images and spectra from program 2079 obs 004. This should be stored in a single directory <code class="docutils literal notranslate"><span class="pre">data</span></code>, and can be downloaded from the notebook 00_niriss_mast_query_data_setup.ipynb.<br>
<strong>Tools</strong>: astropy, crds, glob, jdaviz, json, jwst, matplotlib, numpy, os, pandas, shutil, urllib, zipfile<br>
<strong>Cross-instrument</strong>: NIRISS<br></p>
<p><strong>Content</strong></p>
<ul class="simple">
<li><p><span class="xref myst">Imports &amp; Data Setup</span></p></li>
<li><p><span class="xref myst">Custom Spec2 Pipeline Run</span></p>
<ul>
<li><p><span class="xref myst">Spec2 Association Files</span></p></li>
<li><p><span class="xref myst">Run Spec2</span></p></li>
<li><p><span class="xref myst">Examine the Outputs of Spec2</span></p></li>
</ul>
</li>
<li><p><span class="xref myst">Explore Data Further</span></p>
<ul>
<li><p><span class="xref myst">Find a Source</span></p></li>
<li><p><span class="xref myst">Limit the Number of Extracted Sources</span></p></li>
<li><p><span class="xref myst">Final Visualization</span></p></li>
</ul>
</li>
</ul>
<p><strong>Author</strong>: Rachel Plesha (rplesha&#64;stsci.edu), Camilla Pacifici (cpacifici&#64;stsci.edu), JWebbinar notebooks.<br>
<strong>First Published</strong>: May 2024<br>
<strong>Last edited</strong>: August 2024<br>
<strong>Last tested</strong>: This notebook was last tested with JWST pipeline version 1.12.5 and the CRDS context jwst_1225.pmap.</p>
<p><a id='imports'></a></p>
<section id="imports-data-setup">
<h2>Imports &amp; Data Setup<a class="headerlink" href="#imports-data-setup" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/user_documentation/reference_files_crds.html#crds">CRDS Documentation</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update the CRDS path to your local directory</span>
<span class="o">%</span><span class="k">env</span> CRDS_PATH=crds_cache
<span class="o">%</span><span class="k">env</span> CRDS_SERVER_URL=https://jwst-crds.stsci.edu
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">patches</span>
<span class="o">%</span><span class="k">matplotlib</span> widget
<span class="c1"># %matplotlib inline</span>

<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Spec2Pipeline</span>
</pre></div>
</div>
</div>
</div>
<p>Check what version of the JWST pipeline you are using. To see what the latest version of the pipeline is available or install a previous version, check <a class="reference external" href="https://github.com/spacetelescope/jwst#software-vs-dms-build-version-map%22">GitHub</a>. Also verify what <a class="reference external" href="https://jwst-crds.stsci.edu/">CRDS version</a> you are using. <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/user_documentation/reference_files_crds.html">CRDS documentation</a> explains how to set a specific context to use in the JWST pipeline. If either of these values are different from the last tested note above there may be differences in this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jwst</span>
<span class="kn">import</span> <span class="nn">crds</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;JWST Pipeliene Version:&#39;</span><span class="p">,</span> <span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRDS Context:&#39;</span><span class="p">,</span> <span class="n">crds</span><span class="o">.</span><span class="n">get_context_name</span><span class="p">(</span><span class="s1">&#39;jwst&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<section id="data-setup">
<h3>Data Setup<a class="headerlink" href="#data-setup" title="Permalink to this heading">#</a></h3>
<p>The data directory, <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> should contain all of the association and rate files in a single, flat directory. <code class="docutils literal notranslate"><span class="pre">custom_run_image3</span></code> should match the output directory for the custom image3 calibration in the notebook 01_niriss_wfss_image2_image3.ipynb.</p>
<p>For spec2, we need the rate files that we downloaded as well as the segmentation maps and source catalogs from image3. Because of that, we will create a new directory (defined by <code class="docutils literal notranslate"><span class="pre">custom_run_spec2</span></code>), change into it, and copy the relevant data over.</p>
<p><em>For a regular workflow, it is likely easier to leave all files in a single directory compared to the multiple directories we make here.</em></p>
<p>Open up our data information file which will make parsing the rate files to copy over easier as we only need the dispersed images, i.e. those observed with GR150R or GR150C.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    
<span class="n">custom_run_spec2</span> <span class="o">=</span> <span class="s1">&#39;custom_spec2&#39;</span> <span class="c1"># saving files here in this notebook</span>
<span class="n">custom_run_image3</span> <span class="o">=</span> <span class="s1">&#39;custom_image3_calibrated&#39;</span> <span class="c1"># results of custom image3 calibration</span>

<span class="c1"># if the directories dont&#39;t exist yet, make it</span>
<span class="k">for</span> <span class="n">custom_dir</span> <span class="ow">in</span> <span class="p">[</span><span class="n">custom_run_spec2</span><span class="p">,</span> <span class="n">custom_run_image3</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_dir</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_dir</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># if you have not downloaded the data from notebook 00 or have not run notebook 01, run this cell. Otherwise, feel free to skip it.</span>

<span class="c1"># Download uncalibrated data from Box into the data directory:</span>
<span class="n">boxlink</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/niriss_wfss_advanced/niriss_wfss_advanced_02_input.zip&#39;</span>
<span class="n">boxfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">boxlink</span><span class="p">)</span>
<span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>

<span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>

<span class="c1"># move the files downloaded from the box file into the top level data directory</span>
<span class="n">box_download_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">boxfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">box_download_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="c1"># move to the current directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">elif</span> <span class="s1">&#39;_segm.fits&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s1">&#39;_cat.ecsv&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="c1"># move the image2 products to the appropriate directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_spec2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="s1">&#39;_i2d.fits&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="c1"># move image3 products to their directory, too</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_image3</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># move to the data directory </span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
        
<span class="c1"># remove unnecessary files now</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">boxfile</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">box_download_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># From the csv file we created earlier, find a list of all of the grism observations we will want to calibrate with spec2</span>
<span class="n">listrate_file</span> <span class="o">=</span> <span class="s1">&#39;list_ngdeep_rate.csv&#39;</span>
<span class="n">rate_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">listrate_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># copy all of the grism rate files</span>
<span class="n">gr150r_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GR150R&#39;</span><span class="p">][</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">])</span>
<span class="n">gr150c_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GR150C&#39;</span><span class="p">][</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">grism_rate</span> <span class="ow">in</span> <span class="n">gr150r_files</span> <span class="o">+</span> <span class="n">gr150c_files</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">grism_rate</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">grism_rate</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_spec2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">grism_rate</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grism_rate</span><span class="si">}</span><span class="s1"> does not exist. Not able to copy file.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># copy all of the spec2 asn files</span>
<span class="k">for</span> <span class="n">asn</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;*spec2*asn*.json&#39;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">asn</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_spec2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asn</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">asn</span><span class="si">}</span><span class="s1"> does not exist. Not able to copy file.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># copy all of the necessary image3 output files</span>
<span class="n">cats</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_image3</span><span class="p">,</span> <span class="s1">&#39;*source*_cat.ecsv&#39;</span><span class="p">))</span> <span class="c1"># copy both the source-match and source118 catalogs</span>
<span class="n">segm</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_image3</span><span class="p">,</span> <span class="s1">&#39;*_segm.fits&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">image3_file</span> <span class="ow">in</span> <span class="n">cats</span> <span class="o">+</span> <span class="n">segm</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image3_file</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image3_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_spec2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image3_file</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">image3_file</span><span class="si">}</span><span class="s1"> does not exist. Not able to copy file.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="c1"># get the current working directory </span>
<span class="k">if</span> <span class="n">cwd</span> <span class="o">!=</span> <span class="n">data_dir</span><span class="p">:</span> <span class="c1"># if you are not already in the location of the data, change into it</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not able to change into: </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Remaining in: </span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">custom_run_spec2</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">custom_run_spec2</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">custom_run_spec2</span><span class="p">)</span>

<span class="n">new_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Now in:&#39;</span><span class="p">,</span> <span class="n">new_cwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># directories for calibrating later</span>
<span class="n">source_outdir</span> <span class="o">=</span> <span class="s1">&#39;new_catalog_calibrated&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source_outdir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">source_outdir</span><span class="p">)</span>


<span class="n">param_outdir</span> <span class="o">=</span> <span class="s1">&#39;parameter_input_calibrated&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">param_outdir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">param_outdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="custom_spec2"></a></p>
</section>
</section>
<section id="custom-spec2-pipeline-run">
<h2>Custom Spec2 Pipeline Run<a class="headerlink" href="#custom-spec2-pipeline-run" title="Permalink to this heading">#</a></h2>
<p>Because this is a custom spec2 pipeline run, the first step is to make sure the correct source catalog is being used. This will define the spectral trace cutouts, and therefore inform the pipeline on where to extract the spectrum.</p>
<p><a id="spec2_asn"></a></p>
<section id="spec2-association-files">
<h3>Spec2 Association Files<a class="headerlink" href="#spec2-association-files" title="Permalink to this heading">#</a></h3>
<p>As with the imaging part of the pipeline, there are association files for spec2. These are a bit more complex in that they need to have the science (WFSS) data, direct image, source catalog, and segmentation map included as members. For the science data, the rate files are used as inputs, similarly to image2. Also like image2, there should be one asn file for each dispersed image dither position in an observing sequence. In this case, that should match the number of rate files where <code class="docutils literal notranslate"><span class="pre">FILTER=GR150R</span></code> or <code class="docutils literal notranslate"><span class="pre">FILTER=GR150C</span></code>. For this program and observation, there are three dithers per grism, and both GR150R and GR150C are used, totaling six exposures per observing sequence with five observing sequences in the observation using the blocking filters F115W -&gt; F115W -&gt; F150W -&gt; F150W -&gt; F200W.</p>
<section id="looking-in-a-spec2-association-file">
<h4>Looking in a Spec2 Association File<a class="headerlink" href="#looking-in-a-spec2-association-file" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec2_asns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*spec2*asn*.json&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec2_asns</span><span class="p">),</span> <span class="s1">&#39;Spec2 ASN files&#39;</span><span class="p">)</span>
<span class="c1"># number of asn files should match the number of dispersed images -- 30 for obs 004</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rate_df</span><span class="p">[(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GR150R&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rate_df</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GR150C&#39;</span><span class="p">)]),</span> <span class="s1">&#39;Dispersed image rate files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># look at one of the association files</span>
<span class="n">asn_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">spec2_asns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">asn_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># in particular, take a closer look at the product filenames with the association file:</span>
<span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">product</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;members&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;exptype&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="modify-the-association-file-to-use-custom-source-catalog">
<h4>Modify the Association File to use Custom Source Catalog<a class="headerlink" href="#modify-the-association-file-to-use-custom-source-catalog" title="Permalink to this heading">#</a></h4>
<p>What is currently in the association files uses the pipeline source catalog. In the previous notebook, we created a custom source catalog that we want to use with the extension <code class="docutils literal notranslate"><span class="pre">source-match_cat.ecsv</span></code>, so we need to point to that catalog instead in the association files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_source_ext</span> <span class="o">=</span> <span class="s1">&#39;source-match_cat.ecsv&#39;</span>

<span class="c1"># loop through all of the spec2 association files in the current directory</span>
<span class="k">for</span> <span class="n">asn</span> <span class="ow">in</span> <span class="n">spec2_asns</span><span class="p">:</span>
    <span class="n">asn_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">asn</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]:</span> <span class="c1"># for every product, check the members        </span>
        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span> <span class="c1"># there are multiple members per product</span>
            <span class="k">if</span> <span class="n">member</span><span class="p">[</span><span class="s1">&#39;exptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sourcecat&#39;</span><span class="p">:</span>
                <span class="n">cat_in_asn</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span>
                <span class="c1"># check that we haven&#39;t already updated the source catalog name</span>
                <span class="k">if</span> <span class="n">new_source_ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cat_in_asn</span><span class="p">:</span>
                    <span class="n">new_cat</span> <span class="o">=</span> <span class="n">cat_in_asn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cat.ecsv&#39;</span><span class="p">,</span> <span class="n">new_source_ext</span><span class="p">)</span>
                    <span class="c1"># actually update the association file member</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_cat</span><span class="p">):</span>
                        <span class="n">member</span><span class="p">[</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cat</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_cat</span><span class="si">}</span><span class="s2"> does not exist in the currenty working directory&quot;</span><span class="p">)</span>

    <span class="c1"># write out the new association file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">asn_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># double check that things still look ok:</span>
<span class="n">asn_check</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">spec2_asns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">asn_check</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">product</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;members&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;exptype&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Alternatively, open the .json file in your favorite text editor and manually edit each of the catalog names</p>
<p><a id="spec2_run"></a></p>
</section>
</section>
<section id="run-spec2">
<h3>Run spec2<a class="headerlink" href="#run-spec2" title="Permalink to this heading">#</a></h3>
<p>Like the image pipeline, we can supply custom parameters for steps in the pipeline.</p>
<p>More information about everything that is run during the spec2 stage of the pipeline can be found <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec2.html">here</a>.</p>
<p>To start, we are only going to run spec2 on one association file because spec2 can take a while to run if there are many sources. We are saving the outputs to the directory we are currently in, which should be the <code class="docutils literal notranslate"><span class="pre">custom_spec2</span></code> directory made above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_asn</span> <span class="o">=</span> <span class="n">spec2_asns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calibrating: </span><span class="si">{</span><span class="n">test_asn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if the calibrated file already exists</span>
<span class="n">asn_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">test_asn</span><span class="p">))</span>
<span class="n">x1d_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_x1d.fits&quot;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">,</span> <span class="s1">&#39;: x1d file already exists.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">spec2</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">test_asn</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="spec2_examine"></a></p>
</section>
<section id="examining-the-outputs-of-spec2">
<h3>Examining the Outputs of Spec2<a class="headerlink" href="#examining-the-outputs-of-spec2" title="Permalink to this heading">#</a></h3>
<p>The outputs of spec2 are <code class="docutils literal notranslate"><span class="pre">cal.fits</span></code> and <code class="docutils literal notranslate"><span class="pre">x1d.fits</span></code> files. Here we do a quick look into some important parts of these files.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html#calibrated-data-cal-and-calints">cal further reading</a></p></li>
<li><p><a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html#extracted-1-d-spectroscopic-data-x1d-and-x1dints">x1d further reading</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asn_example</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">spec2_asns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">rate_file</span> <span class="o">=</span> <span class="n">asn_example</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span>
<span class="n">source_cat</span> <span class="o">=</span> <span class="n">asn_example</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span>
<span class="n">cal_file</span> <span class="o">=</span> <span class="n">rate_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;cal&#39;</span><span class="p">)</span>
<span class="n">x1d_file</span> <span class="o">=</span> <span class="n">rate_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;x1d&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># open all of the files to look at</span>
<span class="n">rate_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rate_file</span><span class="p">)</span>
<span class="n">cal_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal_file</span><span class="p">)</span>
<span class="n">x1d_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">source_cat</span><span class="p">)</span>

<span class="c1"># first look at how many sources we expect from the catalog</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span><span class="si">}</span><span class="s1"> sources identified in the current catalog.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># then look at how long the cal and x1d files are for comparison</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The x1d file has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">)</span><span class="si">}</span><span class="s1"> extensions &amp; the cal file has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cal_hdu</span><span class="p">)</span><span class="si">}</span><span class="s1"> extensions&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the 0th and final extension in each file do not contain science data, but the remaining extensions correspond to each source. The <code class="docutils literal notranslate"><span class="pre">x1d</span></code> file contains the extracted spectrum for each source, while the <code class="docutils literal notranslate"><span class="pre">cal</span></code> file contains the 2D cutout information in seven extensions for each source (SCI, DQ, ERR, WAVELENGTH, VAR_POISSON, VAR_RNOISE, VAR_FLAT).</p>
<p>This in part is why it is so important to have a refined source catalog. If there are sources that are not useful for your research, there is no reason to create a cutout and extract them.</p>
<p>Notice that there are more sources than there are extensions in the files. This is because the pipeline defaults to only extracting the 100 brightest sources. To change this behavior, supply the pipeline with the paramter <code class="docutils literal notranslate"><span class="pre">wfss_nbright</span></code>, which we do <span class="xref myst">below</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cal_hdu</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">x1d</span></code> file is a BinTable, so there are additional columns contained inside each of the data extensions. <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/science_products.html#extracted-1-d-spectroscopic-data-x1d-and-x1dints">x1d further reading</a> goes through what is contained in each column, but we can also take a quick look by looking at one of the data columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># a quick look at the columns also available in the x1d file</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="explore"></a></p>
</section>
</section>
<section id="explore-spec2-data-further">
<h2>Explore Spec2 Data Further<a class="headerlink" href="#explore-spec2-data-further" title="Permalink to this heading">#</a></h2>
<p><a id="source"></a></p>
<section id="find-a-source-in-the-spec2-data">
<h3>Find a Source in the Spec2 Data<a class="headerlink" href="#find-a-source-in-the-spec2-data" title="Permalink to this heading">#</a></h3>
<p>Each extension of the cal and x1d files has a source ID in the header. These values should match with the values in the source catalog.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_source_ext</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">cal_hdu</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># x1d extension first</span>
    <span class="n">x1d_source_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1d_hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SOURCEID&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="c1"># cut off the 0th and last data extensions</span>
    <span class="n">wh_x1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x1d_source_ids</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># need to add 1 for the primary header</span>
    
    <span class="c1"># look for cal extension, too, but only in the SCI extension; </span>
    <span class="c1"># fill in with a source ID of -999 for all other extensions to get the right extension value</span>
    <span class="n">cal_source_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cal_hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SOURCEID&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cal_hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXTNAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SCI&#39;</span>
                               <span class="k">else</span> <span class="o">-</span><span class="mi">999</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cal_hdu</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> 
    <span class="n">wh_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cal_source_ids</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># need to add 1 for the primary header</span>

    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All source IDs in x1d file:</span><span class="se">\n</span><span class="si">{</span><span class="n">x1d_source_ids</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extension </span><span class="si">{</span><span class="n">wh_x1d</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">x1d_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> contains the data for source </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s2"> from our catalog&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extension </span><span class="si">{</span><span class="n">wh_cal</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">cal_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> contains the data for source </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s2"> from our catalog&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wh_x1d</span><span class="p">,</span> <span class="n">wh_cal</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s look for source 118 that we identified in the previous notebook.</span>
<span class="n">source_id</span> <span class="o">=</span> <span class="mi">118</span>
<span class="n">wh_x1d_118</span><span class="p">,</span> <span class="n">wh_cal_118</span> <span class="o">=</span> <span class="n">find_source_ext</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">cal_hdu</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>

<span class="n">x1d_data_118</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="n">wh_x1d_118</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
<span class="n">cal_data_118</span> <span class="o">=</span> <span class="n">cal_hdu</span><span class="p">[</span><span class="n">wh_cal_118</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<p>First, let’s look at the extraction box as it appears on the rate image. This will help us get a global feel for how much we can trust the pipeline’s extraction.</p>
<p><em>Note: In this example, the extraction box isn’t fully cenetered around the spectrum. There is an ongoing calibration effort to better account for difference in the spectral trace shape across the NIRISS detector. Updates about the status of this calibration can be found on the <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-calibration-pipeline-caveats/jwst-wide-field-slitless-spectroscopy-pipeline-caveats#JWSTWideFieldSlitlessSpectroscopyPipelineCaveats-NIRISSWFSS">NIRISS jdox</a></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fill in the nan values from the bad pixels with zero to make it easier to look at</span>
<span class="n">rate_data</span> <span class="o">=</span> <span class="n">rate_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">rate_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rate_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># extraction box parameters from the header of the cal data:</span>
<span class="n">cal_header</span> <span class="o">=</span> <span class="n">cal_hdu</span><span class="p">[</span><span class="n">wh_cal_118</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">sx_left</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT1&#39;</span><span class="p">]</span>
<span class="n">swidth</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSIZE1&#39;</span><span class="p">]</span>
<span class="n">sx_right</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">swidth</span>
<span class="n">sy_bottom</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT2&#39;</span><span class="p">]</span>
<span class="n">sheight</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSIZE2&#39;</span><span class="p">]</span>
<span class="n">sy_top</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sheight</span>

<span class="c1"># plot the rate file and the extraction box</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rate_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="c1"># the scaling may need some adjustment</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rate_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="c1"># the scaling may need some adjustment</span>

<span class="n">rectangle</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">sx_left</span><span class="p">,</span> <span class="n">sy_bottom</span><span class="p">),</span> <span class="n">swidth</span><span class="p">,</span> <span class="n">sheight</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rectangle</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">rate_file</span><span class="p">)</span>

<span class="n">rectangle2</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">sx_left</span><span class="p">,</span> <span class="n">sy_bottom</span><span class="p">),</span> <span class="n">swidth</span><span class="p">,</span> <span class="n">sheight</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rectangle2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">sx_left</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="n">sx_right</span><span class="o">+</span><span class="mi">30</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">sy_bottom</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="n">sy_top</span><span class="o">+</span><span class="mi">30</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Source </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s1"> Zoom in&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cal_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cal_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PUPIL&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can then take a look at the extracted spectrum in this box both in the cal file and the x1d file. In the extracted spectrum below you can see the [OII] and H<span class="math notranslate nohighlight">\(\beta\)</span> emission lines from the galaxy.</p>
<p><em>Note: The upturned edge effects seen in the 1-D spectrum are due to interpolation at the edges of the extraction box for the current flux calibration. This is also part of an ongoing calibration effort.</em></p>
<p><em>Additional note: The default units of flux from the pipeline are in Jansky. However, in these extracted spectra we show units of erg/s/cm^2/Angstrom. To turn this off, set <code class="docutils literal notranslate"><span class="pre">convert=False</span></code> in <code class="docutils literal notranslate"><span class="pre">plot_cutout_and_spectrum</span></code></em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Fnu_to_Flam</span><span class="p">(</span><span class="n">wave_micron</span><span class="p">,</span> <span class="n">flux_jansky</span><span class="p">):</span>
    <span class="c1"># convert Jansky flux units to erg/s/cm^2/Angstrom with an input wavelength in microns</span>
    <span class="n">f_lambda</span> <span class="o">=</span> <span class="mf">1E-21</span> <span class="o">*</span> <span class="n">flux_jansky</span> <span class="o">*</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wave_micron</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># erg/s/cm^2/Angstom</span>
    <span class="k">return</span> <span class="n">f_lambda</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_cutout_and_spectrum</span><span class="p">(</span><span class="n">cal_data</span><span class="p">,</span> <span class="n">x1d_data</span><span class="p">,</span> <span class="n">cal_file</span><span class="p">,</span> <span class="n">x1d_file</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># plot the cal image</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cal_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">cal_data</span><span class="p">)</span><span class="o">*</span><span class="mf">.01</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cal_file</span><span class="p">))</span>
    
    <span class="c1"># plot the spectrum</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">x1d_data</span><span class="p">[</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">x1d_data</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">Fnu_to_Flam</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
        <span class="n">fluxunit</span> <span class="o">=</span> <span class="s1">&#39;egs/s/cm^2/Angstrom&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fluxunit</span> <span class="o">=</span> <span class="s1">&#39;Jy&#39;</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">))</span>

    <span class="n">edge_buffer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">*</span> <span class="mf">.25</span><span class="p">)</span>
    <span class="n">max_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">edge_buffer</span><span class="p">:</span><span class="n">edge_buffer</span><span class="o">*-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">max_flux</span><span class="o">+</span><span class="p">(</span><span class="n">max_flux</span><span class="o">*</span><span class="mf">0.1</span><span class="p">))</span> <span class="c1"># cutting the flux of the edges &amp; adding 10% buffer to the limits</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Microns)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flux (</span><span class="si">{</span><span class="n">fluxunit</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">cal_file</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;GR150C&#39;</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X Pixels (&lt;--- dispersion direction)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y Pixels&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X Pixels&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y Pixels (&lt;--- dispersion direction)&#39;</span><span class="p">)</span>        
    
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">cal_file</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;FILTER&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">cal_file</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PUPIL&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> Source </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_cutout_and_spectrum</span><span class="p">(</span><span class="n">cal_data_118</span><span class="p">,</span> <span class="n">x1d_data_118</span><span class="p">,</span> <span class="n">cal_file</span><span class="p">,</span> <span class="n">x1d_file</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="limit_source"></a></p>
</section>
<section id="limit-the-number-of-extracted-sources">
<h3>Limit the Number of Extracted Sources<a class="headerlink" href="#limit-the-number-of-extracted-sources" title="Permalink to this heading">#</a></h3>
<p>Because it takes so long to extract so many sources, let’s see if we can pair down the number of sources being extracted. We’ll do this with parameter inputs (for bright point sources) and with a further refined source catalog.</p>
<section id="limit-extraction-using-parameter-inputs">
<h4>Limit Extraction Using Parameter Inputs<a class="headerlink" href="#limit-extraction-using-parameter-inputs" title="Permalink to this heading">#</a></h4>
<p>For this calibration, we are explicitly calling out parameters the following step:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">extract_2d</span></code> where we are setting <code class="docutils literal notranslate"><span class="pre">wfss_nbright</span></code> which limits the number of bright sources that are extracted and <code class="docutils literal notranslate"><span class="pre">wfss_mmag_extract</span></code> which sets a limit on the faintest magnitude we want extracted. <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/extract_2d/main.html#nircam-and-niriss-wfss">Further Reading</a></p></li>
</ul>
<p>In this case, we’ll limit the extractions to only the 10 brightest objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if the calibrated file already exists</span>
<span class="n">asn_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">spec2_asns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">x1d_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_x1d.fits&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">,</span> <span class="s1">&#39;: x1d file already exists.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">spec2</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">spec2_asns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">steps</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;extract_2d&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;wfss_nbright&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="p">},</span>
                               <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">output_dir</span><span class="o">=</span><span class="n">param_outdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># open the x1d to examine how many sources were extracted</span>
<span class="n">x1ds</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_outdir</span><span class="p">,</span> <span class="s1">&#39;*x1d.fits*&#39;</span><span class="p">))</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1ds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">temp_x1d</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The x1d file has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_x1d</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s1"> extracted sources&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="limit-extraction-using-the-source-catalog">
<h4>Limit Extraction Using the Source Catalog<a class="headerlink" href="#limit-extraction-using-the-source-catalog" title="Permalink to this heading">#</a></h4>
<p>In the last notebook we limited the catalog a couple of different ways. Here, let’s limit the catalog to a specific magnitude range, and then use that new catalog to extract the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source_match_cats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*source-match_cat.ecsv&#39;</span><span class="p">))</span>
<span class="n">source_match_cat</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">source_cat</span><span class="p">)</span>

<span class="c1"># look at the possible magnitude ranges to look at</span>
<span class="n">mags</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;isophotal_vegamag&#39;</span><span class="p">]</span>
<span class="n">min_vegmag</span> <span class="o">=</span> <span class="n">mags</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_vegmag</span> <span class="o">=</span> <span class="n">mags</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Magnitude range: </span><span class="si">{</span><span class="n">min_vegmag</span><span class="si">}</span><span class="s2"> -  </span><span class="si">{</span><span class="n">max_vegmag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># source 118 should have a Vega mag of ~21.68</span>
<span class="n">source_id</span> <span class="o">=</span> <span class="mi">118</span>
<span class="n">source_mag</span> <span class="o">=</span> <span class="n">source_match_cat</span><span class="p">[</span><span class="n">source_match_cat</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">source_id</span><span class="p">][</span><span class="s1">&#39;isophotal_vegamag&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Magnitude for source in previous notebook (source </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s2">) : </span><span class="si">{</span><span class="n">source_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find the catalog for how many sources are between a specific magnitude (21.18 to make sure to include our example source)</span>
<span class="n">min_mag</span> <span class="o">=</span> <span class="mf">21.1</span>
<span class="n">max_mag</span> <span class="o">=</span> <span class="mf">21.2</span>
<span class="n">mag_cat</span> <span class="o">=</span> <span class="n">source_match_cat</span><span class="p">[(</span><span class="n">source_match_cat</span><span class="p">[</span><span class="s1">&#39;isophotal_vegamag&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_mag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">source_match_cat</span><span class="p">[</span><span class="s1">&#39;isophotal_vegamag&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_mag</span><span class="p">)]</span>

<span class="n">mag_cat</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;is_extended&#39;</span><span class="p">,</span> <span class="s1">&#39;isophotal_abmag&#39;</span><span class="p">,</span> <span class="s1">&#39;isophotal_vegamag&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mag_source_ext</span> <span class="o">=</span> <span class="s1">&#39;mag-limit_cat.ecsv&#39;</span>

<span class="n">new_cat</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">mag_cat</span><span class="p">)</span> <span class="c1"># turn the row instance into a dataframe again</span>

<span class="c1"># save the new catalog with a unique name</span>
<span class="n">new_cat_name</span> <span class="o">=</span> <span class="n">source_cat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cat.ecsv&#39;</span><span class="p">,</span> <span class="n">mag_source_ext</span><span class="p">)</span>
<span class="n">new_cat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_cat_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved:&#39;</span><span class="p">,</span> <span class="n">new_cat_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have a source catalog that we’ve limited to specific sources, let’s match the remaining catalogs to those sources</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">cat_name</span> <span class="ow">in</span> <span class="n">source_match_cats</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">cat_name</span> <span class="o">==</span> <span class="n">source_cat</span><span class="p">:</span>
        <span class="c1"># the base one has already been saved</span>
        <span class="k">continue</span>

    <span class="c1"># match the source IDs between the current catalog and the base catalog above</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cat_name</span><span class="p">)</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
    <span class="n">new_cat</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">mag_cat</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])]</span>

    <span class="c1"># check to ensure the sources are all there</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">new_cat</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;is_extended&#39;</span><span class="p">,</span> <span class="s1">&#39;isophotal_abmag&#39;</span><span class="p">,</span> <span class="s1">&#39;isophotal_vegamag&#39;</span><span class="p">]))</span>
    
    <span class="c1"># save the new catalog with a unique name</span>
    <span class="n">new_cat_name</span> <span class="o">=</span> <span class="n">cat_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cat.ecsv&#39;</span><span class="p">,</span> <span class="n">mag_source_ext</span><span class="p">)</span>
    <span class="n">new_cat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_cat_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved:&#39;</span><span class="p">,</span> <span class="n">new_cat_name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Once the new catalogs have been made, we have to update the association files to use the new catalogs. <strong>Note: the association files will need to be updated again if you want to calibrate again with the previous source catalogs</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_source_ext</span> <span class="o">=</span> <span class="n">mag_source_ext</span>

<span class="c1"># loop through all of the spec2 association files in the current directory</span>
<span class="k">for</span> <span class="n">asn</span> <span class="ow">in</span> <span class="n">spec2_asns</span><span class="p">:</span>
    <span class="n">asn_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">asn</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]:</span> <span class="c1"># for every product, check the members        </span>
        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span> <span class="c1"># there are multiple members per product</span>
            <span class="k">if</span> <span class="n">member</span><span class="p">[</span><span class="s1">&#39;exptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sourcecat&#39;</span><span class="p">:</span>
                <span class="n">cat_in_asn</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span>
                <span class="c1"># check that we haven&#39;t already updated the source catalog name</span>
                <span class="k">if</span> <span class="n">new_source_ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cat_in_asn</span><span class="p">:</span>
                    <span class="n">new_cat</span> <span class="o">=</span> <span class="n">cat_in_asn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cat.ecsv&#39;</span><span class="p">,</span> <span class="n">new_source_ext</span><span class="p">)</span>
                    <span class="c1"># actually update the association file member</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_cat</span><span class="p">):</span>
                        <span class="n">member</span><span class="p">[</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cat</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_cat</span><span class="si">}</span><span class="s2"> does not exist in the currenty working directory&quot;</span><span class="p">)</span>

    <span class="c1"># write out the new association file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">asn_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># double check that the source catalog has been changed</span>
<span class="k">for</span> <span class="n">spec2_asn</span> <span class="ow">in</span> <span class="n">spec2_asns</span><span class="p">:</span>
    <span class="n">asn_check</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">spec2_asn</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">asn_check</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">product</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;members&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">member</span><span class="p">[</span><span class="s1">&#39;exptype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sourcecat&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;exptype&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now when we calibrate everything, for a single file it should take a lot less time because there are a limited number of sources. However, we will calibrate all of the files in this visit, so this cell might take a bit of time to run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calibrate with the new source catalog</span>
<span class="k">for</span> <span class="n">spec2_asn</span> <span class="ow">in</span> <span class="n">spec2_asns</span><span class="p">:</span>
    <span class="c1"># check if the calibrated file already exists</span>
    <span class="n">asn_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">spec2_asn</span><span class="p">))</span>
    <span class="n">x1d_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_x1d.fits&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">,</span> <span class="s1">&#39;: x1d file already exists.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec2</span> <span class="o">=</span> <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">spec2_asn</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">source_outdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id="final_visualize"></a></p>
</section>
</section>
<section id="final-visualization">
<h3>Final Visualization<a class="headerlink" href="#final-visualization" title="Permalink to this heading">#</a></h3>
<p>Now that everything has been calibrated, it’s useful to look at all of the extracted files. The cal and x1d files from spec2 are extracted at each dither step, which is shown below. Spec3 then turns the individual dither x1d files into a single combined spectrum per grism and filter for each source.</p>
<p>Note that for GR150R data, the dispersion direction is in the -Y direction, and for GR150C data, the dispersion direction is in the -X direction.</p>
<section id="look-at-all-of-the-files-for-a-single-source">
<h4>Look at all of the Files for a Single Source<a class="headerlink" href="#look-at-all-of-the-files-for-a-single-source" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Explore the new Data</span>
<span class="n">x1ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_outdir</span><span class="p">,</span> <span class="s2">&quot;*x1d.fits&quot;</span><span class="p">)))</span>

<span class="c1"># get a list of all of the source IDs from the first file to look at for this example</span>
<span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1ds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOURCEID&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1ds</span><span class="p">[</span><span class="mi">0</span><span class="p">])))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">source_id</span> <span class="o">=</span> <span class="mi">118</span>

<span class="c1"># plot each x1d/cal file</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x1d_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x1ds</span><span class="p">):</span>
    <span class="n">cal_file</span> <span class="o">=</span> <span class="n">x1d_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;x1d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;cal.fits&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">cal_hdu</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wh_x1d</span><span class="p">,</span> <span class="n">wh_cal</span> <span class="o">=</span> <span class="n">find_source_ext</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">cal_hdu</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># this means the source isn&#39;t in this observation</span>
            <span class="k">continue</span>

        <span class="n">x1d_data</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="n">wh_x1d</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
        <span class="n">cal_data</span> <span class="o">=</span> <span class="n">cal_hdu</span><span class="p">[</span><span class="n">wh_cal</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="n">plot_cutout_and_spectrum</span><span class="p">(</span><span class="n">cal_data</span><span class="p">,</span> <span class="n">x1d_data</span><span class="p">,</span> <span class="n">cal_file</span><span class="p">,</span> <span class="n">x1d_file</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Overplot these files on top of each other to compare. The two grisms will be different line styles to draw attention to any differences that could be due to the calibration, including contamination, and each blocking filter will be a different color.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Overplot the different grisms on top of each other for the same source</span>
<span class="n">x1ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_outdir</span><span class="p">,</span> <span class="s2">&quot;*x1d.fits&quot;</span><span class="p">)))</span>

<span class="c1"># get a list of all of the source IDs from the first file to look at for this example</span>
<span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1ds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOURCEID&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1ds</span><span class="p">[</span><span class="mi">0</span><span class="p">])))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">source_id</span> <span class="o">=</span> <span class="mi">118</span>

<span class="c1"># create a figure with three panels</span>
<span class="n">src118_fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ls_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GR150R&#39;</span><span class="p">:</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
           <span class="s1">&#39;GR150C&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
           <span class="p">}</span>

<span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F115W&#39;</span><span class="p">:</span> <span class="s1">&#39;#e1cb00&#39;</span><span class="p">,</span>
              <span class="s1">&#39;F150W&#39;</span><span class="p">:</span> <span class="s1">&#39;#32b45c&#39;</span><span class="p">,</span>
              <span class="s1">&#39;F200W&#39;</span><span class="p">:</span> <span class="s1">&#39;#099ab4&#39;</span><span class="p">,</span>
              <span class="p">}</span>

<span class="n">max_fluxes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_waves</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># plot each x1d file</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x1d_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x1ds</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">x1d_hdu</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wh_x1d</span><span class="p">,</span> <span class="n">wh_cal</span> <span class="o">=</span> <span class="n">find_source_ext</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">cal_hdu</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># this means the source isn&#39;t in this observation</span>
            <span class="k">continue</span>

        <span class="n">x1d_data</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="n">wh_x1d</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
        <span class="n">grism</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PUPIL&#39;</span><span class="p">]</span>

    <span class="n">wave</span> <span class="o">=</span> <span class="n">x1d_data</span><span class="p">[</span><span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">x1d_data</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">flux</span> <span class="o">=</span> <span class="n">Fnu_to_Flam</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
    <span class="n">fluxunits</span> <span class="o">=</span> <span class="s1">&#39;erg/s/cm^2/Angstrom&#39;</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_dict</span><span class="p">[</span><span class="nb">filter</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls_dict</span><span class="p">[</span><span class="n">grism</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grism</span> <span class="o">==</span> <span class="s1">&#39;GR150C&#39;</span><span class="p">:</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_dict</span><span class="p">[</span><span class="nb">filter</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls_dict</span><span class="p">[</span><span class="n">grism</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_dict</span><span class="p">[</span><span class="nb">filter</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls_dict</span><span class="p">[</span><span class="n">grism</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="c1"># save the maximum fluxes for plotting, removing any edge effects</span>
    <span class="n">edge_buffer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">*</span> <span class="mf">.25</span><span class="p">)</span>
    <span class="n">max_fluxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">edge_buffer</span><span class="p">:</span><span class="n">edge_buffer</span><span class="o">*-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">all_waves</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>

<span class="c1"># plot limits &amp; labels</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_fluxes</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_waves</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_waves</span><span class="p">))</span>

<span class="n">src118_fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Source </span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;GR150R &amp; GR150C&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;GR150C&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;GR150R&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Microns)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flux (</span><span class="si">{</span><span class="n">fluxunits</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># label for each of the filters</span>
<span class="k">for</span> <span class="n">filt</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
<span class="n">src118_fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="look-at-all-of-the-sources-for-a-single-file">
<h4>Look at all of the sources for a single file<a class="headerlink" href="#look-at-all-of-the-sources-for-a-single-file" title="Permalink to this heading">#</a></h4>
<p>Note that some sources might not actually be extracting anything interesting. If this is the case, go back to your source catalog and images to ensure that you have the correct source identified and the target is centered in the cutout. This notebook uses simple examples to create and limit the source catalog, so it might not always show the most scientifically interesting sources.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x1d_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_outdir</span><span class="p">,</span> <span class="s1">&#39;jw02079004002_11101_00002_nis_x1d.fits&#39;</span><span class="p">)</span> <span class="c1"># this is a nice spectrum of 118 above</span>
<span class="n">cal_file</span> <span class="o">=</span> <span class="n">x1d_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;x1d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;cal.fits&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">cal_hdu</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

        <span class="n">source_id</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SOURCEID&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wh_x1d</span><span class="p">,</span> <span class="n">wh_cal</span> <span class="o">=</span> <span class="n">find_source_ext</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">cal_hdu</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># this means the source isn&#39;t in this observation</span>
            <span class="k">continue</span>
    
        <span class="n">x1d_data</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="n">wh_x1d</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
        <span class="n">cal_data</span> <span class="o">=</span> <span class="n">cal_hdu</span><span class="p">[</span><span class="n">wh_cal</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    
        <span class="n">plot_cutout_and_spectrum</span><span class="p">(</span><span class="n">cal_data</span><span class="p">,</span> <span class="n">x1d_data</span><span class="p">,</span> <span class="n">cal_file</span><span class="p">,</span> <span class="n">x1d_file</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-where-the-extracted-sources-are-on-the-dispersed-image-and-how-that-compares-to-the-direct-image">
<h4>Visualize where the extracted sources are on the dispersed image, and how that compares to the direct image<a class="headerlink" href="#visualize-where-the-extracted-sources-are-on-the-dispersed-image-and-how-that-compares-to-the-direct-image" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setting up the figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># **grism data</span>

<span class="c1"># for the dispersed image plot</span>
<span class="c1"># x1d_file and cal_file use the same root as we are looking at for a single source</span>
<span class="n">rate_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x1d_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;x1d.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;rate.fits&#39;</span><span class="p">))</span>

<span class="c1"># fill in the nan values from the bad pixels with zero to make it easier to look at</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rate_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">rate_hdu</span><span class="p">:</span>
    <span class="n">rate_data</span> <span class="o">=</span> <span class="n">rate_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">rate_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rate_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># plot the rate file and the extraction box</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rate_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">rate_data</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">cal_hdu</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>

        <span class="n">source_id</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SOURCEID&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wh_x1d</span><span class="p">,</span> <span class="n">wh_cal</span> <span class="o">=</span> <span class="n">find_source_ext</span><span class="p">(</span><span class="n">x1d_hdu</span><span class="p">,</span> <span class="n">cal_hdu</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># this means the source isn&#39;t in this observation</span>
            <span class="k">continue</span>
    
        <span class="n">x1d_data</span> <span class="o">=</span> <span class="n">x1d_hdu</span><span class="p">[</span><span class="n">wh_x1d</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
        <span class="n">cal_data</span> <span class="o">=</span> <span class="n">cal_hdu</span><span class="p">[</span><span class="n">wh_cal</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    
        <span class="c1"># extraction box parameters from the header of the cal data:</span>
        <span class="n">cal_header</span> <span class="o">=</span> <span class="n">cal_hdu</span><span class="p">[</span><span class="n">wh_cal</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">sx_left</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT1&#39;</span><span class="p">]</span>
        <span class="n">swidth</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSIZE1&#39;</span><span class="p">]</span>
        <span class="n">sx_right</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">swidth</span>
        <span class="n">sy_bottom</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT2&#39;</span><span class="p">]</span>
        <span class="n">sheight</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSIZE2&#39;</span><span class="p">]</span>
        <span class="n">sy_top</span> <span class="o">=</span> <span class="n">cal_header</span><span class="p">[</span><span class="s1">&#39;SLTSTRT2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sheight</span>
        
        <span class="n">rectangle</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">sx_left</span><span class="p">,</span> <span class="n">sy_bottom</span><span class="p">),</span> <span class="n">swidth</span><span class="p">,</span> <span class="n">sheight</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rectangle</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">sx_left</span><span class="p">,</span> <span class="n">sy_top</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">)</span>
        
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_nis&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cal_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cal_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PUPIL&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># **imaging data</span>
<span class="n">asn_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">x1d_file</span><span class="p">,</span> <span class="s1">&#39;ASNTABLE&#39;</span><span class="p">)))</span>
<span class="n">i2d_name</span> <span class="o">=</span> <span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span>
<span class="n">cat_name</span> <span class="o">=</span> <span class="n">asn_data</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;expname&#39;</span><span class="p">]</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">custom_run_image3</span><span class="p">,</span> <span class="n">i2d_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">i2d</span><span class="p">:</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">i2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">i2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i2d_name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_i2d&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># also plot the associated catalog</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cat_name</span><span class="p">)</span>
<span class="n">extended_sources</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;is_extended&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># 1 is True; i.e. is extended</span>
<span class="n">point_sources</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;is_extended&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># 0 is False; i.e. is a point source</span>

<span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">sources</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">extended_sources</span><span class="p">,</span> <span class="n">point_sources</span><span class="p">]):</span>
    <span class="c1"># plotting the sources</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># adding source labels </span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]):</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">source_num</span><span class="p">,</span> 
                     <span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">),</span> 
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Continue to explore further, including using the <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_spec3.html">spec3 stage</a> of the pipeline!</p>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRISS/NIRISS_WFSS_advanced"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="01_niriss_wfss_image2_image3.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Run Image Pipeline and Create Source Catalog</p>
      </div>
    </a>
    <a class="right-next"
       href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">IFU Cube Fitting</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-data-setup">Imports &amp; Data Setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-setup">Data Setup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-spec2-pipeline-run">Custom Spec2 Pipeline Run</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spec2-association-files">Spec2 Association Files</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#looking-in-a-spec2-association-file">Looking in a Spec2 Association File</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#modify-the-association-file-to-use-custom-source-catalog">Modify the Association File to use Custom Source Catalog</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-spec2">Run spec2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-the-outputs-of-spec2">Examining the Outputs of Spec2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-spec2-data-further">Explore Spec2 Data Further</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#find-a-source-in-the-spec2-data">Find a Source in the Spec2 Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-the-number-of-extracted-sources">Limit the Number of Extracted Sources</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-extraction-using-parameter-inputs">Limit Extraction Using Parameter Inputs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-extraction-using-the-source-catalog">Limit Extraction Using the Source Catalog</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-visualization">Final Visualization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#look-at-all-of-the-files-for-a-single-source">Look at all of the Files for a Single Source</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#look-at-all-of-the-sources-for-a-single-file">Look at all of the sources for a single file</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-where-the-extracted-sources-are-on-the-dispersed-image-and-how-that-compares-to-the-direct-image">Visualize where the extracted sources are on the dispersed image, and how that compares to the direct image</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>